<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Build, Bin, Boost: The R&D Portfolio Simulation | ShieldTech India</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
        :root {
            /* P&G-inspired professional blue color scheme */
            --primary: #003da5;
            /* Safe area insets for notched devices */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            --primary-light: #0056d6;
            --primary-lighter: #e8f1fc;
            --primary-pale: #d0e3f8;
            --primary-dark: #002d7a;
            --accent: #00a3e0;
            --accent-light: #b3e5f7;
            --gold: #F1BE48;
            --gold-dark: #D69A2D;
            --gold-light: #fdf6e3;
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --info: #0284c7;
            --info-light: #e0f2fe;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--primary-lighter) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* Landing Page */
        .landing-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px 20px;
        }
        
        .landing-hero { text-align: center; margin-bottom: 50px; }
        
        .landing-badge {
            display: inline-block;
            background: var(--primary);
            color: var(--gold);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 25px;
        }
        
        .landing-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 3.5em;
            color: var(--primary);
            margin-bottom: 15px;
            line-height: 1.1;
        }
        
        .landing-subtitle {
            font-size: 1.4em;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto 40px;
        }
        
        .landing-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            max-width: 900px;
            margin: 0 auto 50px;
        }
        
        .feature-card {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            text-align: left;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary);
        }
        
        .feature-icon { font-size: 2em; margin-bottom: 15px; }
        .feature-card h3 { color: var(--primary); margin-bottom: 10px; font-size: 1.15em; }
        .feature-card p { color: var(--gray-600); font-size: 0.95em; }
        
        .landing-cta { text-align: center; }
        
        .landing-meta {
            text-align: center;
            margin-top: 40px;
            color: var(--gray-500);
            font-size: 0.9em;
        }
        
        .landing-meta span { margin: 0 15px; }
        
        .landing-credits {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-500);
            font-size: 0.85em;
        }
        
        .landing-credits p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .landing-credits a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .landing-credits a:hover {
            text-decoration: underline;
        }
        
        .license-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .credits-btn {
            margin-top: 15px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            color: var(--gray-600);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .credits-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }
        
        /* Credits Modal */
        .credits-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }
        
        .credits-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
        }
        
        .credits-modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .credits-modal-header h2 {
            margin: 0 0 5px;
        }
        
        .credits-modal-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .credits-modal-body {
            padding: 25px 30px;
        }
        
        .credits-section {
            margin-bottom: 25px;
        }
        
        .credits-section:last-child {
            margin-bottom: 0;
        }
        
        .credits-section h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin: 0 0 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .credits-person {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
        }
        
        .credits-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-lighter);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1em;
        }
        
        .credits-person-info {
            flex: 1;
        }
        
        .credits-person-name {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .credits-person-role {
            font-size: 0.85em;
            color: var(--gray-500);
        }
        
        .license-box {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .license-box h4 {
            margin: 0 0 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .license-terms {
            font-size: 0.9em;
            color: var(--gray-600);
            line-height: 1.6;
        }
        
        .license-terms strong {
            color: var(--gray-700);
        }
        
        .license-terms ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .license-terms li {
            margin-bottom: 6px;
        }
        
        .warranty-notice {
            margin-top: 15px;
            padding: 12px;
            background: var(--warning-light);
            border-radius: 8px;
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .credits-modal-footer {
            padding: 15px 30px;
            background: var(--gray-50);
            border-radius: 0 0 16px 16px;
            text-align: center;
        }
        
        .credits-close-btn {
            padding: 10px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        /* ========== SELECTION APPROACH MODAL ========== */
        .approach-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            padding: 20px;
        }
        
        .approach-modal-overlay.hidden {
            display: none;
        }
        
        .approach-modal {
            background: white;
            border-radius: 20px;
            max-width: 750px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .approach-modal-header {
            padding: 30px 35px 25px;
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .approach-modal-header h2 {
            margin: 0 0 8px;
            font-size: 1.5em;
            font-family: 'Playfair Display', Georgia, serif;
        }
        
        .approach-modal-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .approach-modal-body {
            padding: 30px 35px;
        }
        
        .approach-choice-section {
            margin-bottom: 30px;
        }
        
        .approach-choice-section:last-of-type {
            margin-bottom: 20px;
        }
        
        .approach-choice-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 18px;
        }
        
        .choice-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1em;
            flex-shrink: 0;
        }
        
        .approach-choice-header h3 {
            margin: 0 0 4px;
            font-size: 1.1em;
            color: var(--gray-800);
        }
        
        .approach-choice-header p {
            margin: 0;
            font-size: 0.9em;
            color: var(--gray-500);
        }
        
        .approach-options-vertical {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .approach-options-horizontal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .approach-options-horizontal {
                grid-template-columns: 1fr;
            }
        }
        
        .approach-option {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 18px;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .approach-option:hover {
            border-color: var(--primary-light);
            background: var(--gray-50);
        }
        
        .approach-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
            box-shadow: 0 0 0 3px var(--primary-pale);
        }
        
        .approach-option.compact {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 15px;
        }
        
        .approach-option.compact .approach-option-content {
            align-items: center;
        }
        
        .approach-option-radio {
            width: 22px;
            height: 22px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            transition: all 0.2s;
        }
        
        .approach-option.selected .approach-option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }
        
        .approach-option.selected .approach-option-radio::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 700;
        }
        
        .approach-option.compact .approach-option-radio {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        
        .approach-option.compact {
            position: relative;
        }
        
        .approach-option-icon {
            font-size: 1.8em;
            flex-shrink: 0;
        }
        
        .approach-option.compact .approach-option-icon {
            font-size: 2.2em;
            margin-bottom: 5px;
        }
        
        .approach-option-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        
        .approach-option-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1em;
        }
        
        .approach-option-desc {
            font-size: 0.85em;
            color: var(--gray-600);
            line-height: 1.5;
        }
        
        .approach-option-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }
        
        .approach-option.compact .approach-option-effects {
            justify-content: center;
        }
        
        .approach-effect {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 500;
        }
        
        .approach-effect.pro {
            background: var(--success-light);
            color: var(--success);
        }
        
        .approach-effect.con {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .approach-effect.neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .approach-research-note {
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            border: 1px solid #fcd34d;
            border-radius: 12px;
            padding: 16px 18px;
            margin-top: 5px;
        }
        
        .approach-research-note h4 {
            margin: 0 0 6px;
            font-size: 0.85em;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .approach-research-note p {
            margin: 0;
            font-size: 0.8em;
            color: var(--gray-600);
            line-height: 1.5;
        }
        
        .approach-modal-footer {
            padding: 20px 35px 30px;
            text-align: center;
        }
        
        .approach-confirm-btn {
            padding: 14px 40px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .approach-confirm-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,61,165,0.3);
        }
        
        .approach-confirm-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }
        
        /* ========== RAPID MODE & BLINDING STYLES ========== */
        .rapid-mode-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
            border: 1px solid #fcd34d;
        }
        
        .rapid-facts {
            grid-template-columns: repeat(4, 1fr) !important;
        }
        
        @media (max-width: 600px) {
            .rapid-facts {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        .rapid-team-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid var(--gray-200);
        }
        
        .rapid-team-hint .team-icon {
            font-size: 1.3em;
        }
        
        .rapid-team-hint .team-text {
            font-size: 0.9em;
            color: var(--gray-600);
        }
        
        .rapid-team-hint.blinded {
            background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);
            border-color: #a5b4fc;
        }
        
        .rapid-team-hint.blinded .team-text {
            color: #4338ca;
        }
        
        .rapid-details-link {
            margin-top: 15px;
            text-align: center;
        }
        
        .rapid-details-link .btn {
            font-size: 0.85em;
        }
        
        .rapid-summary {
            background: var(--gray-50);
            padding: 15px 18px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .project-rapid-desc {
            color: var(--gray-700);
            line-height: 1.7;
            font-size: 0.95em;
            margin: 0;
        }
        
        .track-record-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .track-record-badge.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .track-record-badge.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .track-record-badge.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .blinded-section {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);
            border-radius: 12px;
            border: 2px dashed #a5b4fc;
            margin: 15px 0;
        }
        
        .blinded-icon {
            font-size: 2.5em;
            flex-shrink: 0;
        }
        
        .blinded-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .blinded-text strong {
            color: #4338ca;
            font-size: 1em;
        }
        
        .blinded-text span {
            color: #6366f1;
            font-size: 0.9em;
        }
        
        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85em;
        }
        
        /* ========== MANAGEMENT DILEMMA MODALS ========== */
        .dilemma-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }
        
        .dilemma-modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            animation: dilemmaSlideIn 0.4s ease-out;
        }
        
        @keyframes dilemmaSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .dilemma-modal-header {
            padding: 30px 30px 25px;
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            color: white;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .dilemma-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .dilemma-category {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .dilemma-title {
            font-size: 1.5em;
            font-weight: 700;
            font-family: 'Playfair Display', Georgia, serif;
            margin: 0;
        }
        
        .dilemma-modal-body {
            padding: 25px 30px 30px;
        }
        
        .dilemma-description {
            font-size: 1.05em;
            color: var(--gray-700);
            line-height: 1.7;
            margin-bottom: 25px;
        }
        
        .dilemma-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .dilemma-choice {
            display: block;
            width: 100%;
            padding: 18px 20px;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dilemma-choice:hover {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.15);
            transform: translateX(5px);
        }
        
        .choice-label {
            font-weight: 700;
            color: var(--gray-800);
            font-size: 1.05em;
            margin-bottom: 5px;
        }
        
        .choice-description {
            font-size: 0.9em;
            color: var(--gray-600);
        }
        
        .dilemma-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border-radius: 10px;
            border: 1px solid #fcd34d;
        }
        
        .hint-icon {
            font-size: 1.3em;
        }
        
        .hint-text {
            font-size: 0.9em;
            color: #92400e;
            font-style: italic;
        }
        
        /* Dilemma Outcome Modal */
        .dilemma-outcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }
        
        .dilemma-outcome-modal {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            animation: dilemmaSlideIn 0.3s ease-out;
            overflow: hidden;
        }
        
        .outcome-header {
            padding: 30px 25px;
        }
        
        .outcome-header.positive {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
        
        .outcome-header.mixed {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
        }
        
        .outcome-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .outcome-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .outcome-body {
            padding: 25px 30px;
        }
        
        .outcome-choice {
            font-size: 1em;
            color: var(--gray-600);
            margin-bottom: 15px;
        }
        
        .outcome-narrative {
            font-size: 1.1em;
            color: var(--gray-800);
            line-height: 1.6;
        }
        
        .outcome-continue-btn {
            display: block;
            width: calc(100% - 60px);
            margin: 0 30px 30px;
            padding: 15px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .outcome-continue-btn:hover {
            background: var(--primary-dark);
        }
        
        .credits-close-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Briefing Page */
        .briefing-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 50px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .briefing-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(241,190,72,0.15) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .briefing-header .company-logo {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 30px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .briefing-header h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .briefing-header .tagline { font-size: 1.1em; opacity: 0.9; }
        
        .briefing-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 30px;
            position: relative;
        }
        
        .briefing-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        
        .briefing-stat .value { font-size: 1.8em; font-weight: 700; color: var(--gold); }
        .briefing-stat .label { font-size: 0.85em; opacity: 0.8; }
        
        .briefing-section {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .briefing-section h2 {
            color: var(--primary);
            font-size: 1.4em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .briefing-section h2 .icon {
            width: 35px;
            height: 35px;
            background: var(--primary-lighter);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Timeline */
        .timeline { position: relative; padding-left: 30px; }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            bottom: 5px;
            width: 3px;
            background: var(--gray-200);
            border-radius: 2px;
        }
        
        .timeline-item { position: relative; margin-bottom: 25px; }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 6px;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid var(--white);
            box-shadow: 0 0 0 2px var(--primary-lighter);
        }
        
        .timeline-item.highlight::before {
            background: var(--gold);
            box-shadow: 0 0 0 2px var(--gold-light);
        }
        
        .timeline-year { font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .timeline-text { color: var(--gray-600); }
        
        /* Capability Grid */
        .capability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .capability-item {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }
        
        .capability-item h4 { color: var(--primary); margin-bottom: 8px; font-size: 1em; }
        .capability-item p { color: var(--gray-600); font-size: 0.9em; margin: 0; }
        
        /* Strategy Priorities */
        .strategy-priorities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .priority-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: var(--gold-light);
            border-radius: 12px;
            border: 1px solid var(--gold);
        }
        
        .priority-number {
            width: 30px;
            height: 30px;
            background: var(--gold);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .priority-text h4 { color: var(--gold-dark); margin-bottom: 5px; font-size: 1em; }
        .priority-text p { color: var(--gray-600); font-size: 0.9em; margin: 0; }
        
        /* Appointment Page */
        .appointment-header {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-top: 5px solid var(--danger);
        }
        
        .urgent-badge {
            display: inline-block;
            background: var(--danger-light);
            color: var(--danger);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .appointment-header h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2.2em;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .appointment-header .lead {
            font-size: 1.15em;
            color: var(--gray-600);
            max-width: 700px;
            margin: 0 auto;
        }
        
        .problem-section {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .problem-section h2 {
            color: var(--danger);
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .failure-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .failure-item {
            background: var(--danger-light);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--danger);
        }
        
        .failure-item .stat { font-size: 2em; font-weight: 700; color: var(--danger); }
        .failure-item .label { color: var(--gray-700); font-size: 0.9em; }
        
        .diagnosis-box {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid var(--primary);
        }
        
        .diagnosis-box h3 { color: var(--primary); margin-bottom: 15px; }
        .diagnosis-list { list-style: none; padding: 0; margin: 0; }
        
        .diagnosis-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .diagnosis-list li:last-child { border-bottom: none; }
        .diagnosis-list .bullet { color: var(--primary); font-weight: bold; }
        
        .mandate-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 16px;
            padding: 35px;
            color: var(--white);
            margin-bottom: 20px;
        }
        
        .mandate-section h2 { color: var(--gold); margin-bottom: 20px; font-size: 1.4em; }
        .mandate-section p { font-size: 1.1em; margin-bottom: 25px; opacity: 0.95; }
        
        .mandate-goals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .mandate-goal {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .mandate-goal .icon { font-size: 1.8em; margin-bottom: 10px; }
        .mandate-goal h4 { color: var(--gold); margin-bottom: 5px; }
        .mandate-goal p { font-size: 0.9em; margin: 0; opacity: 0.85; }
        
        /* Process Design Pages */
        .design-header {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary);
        }
        
        .design-header h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2em;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .design-header p { color: var(--gray-600); max-width: 600px; margin: 0 auto; }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .step-badge {
            background: var(--primary);
            color: var(--white);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .step-label { color: var(--gray-500); font-size: 0.9em; }
        
        /* Decision Model Cards */
        .decision-model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .model-card {
            background: var(--white);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            border: 3px solid var(--gray-200);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .model-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(60, 16, 83, 0.15);
        }
        
        .model-card.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .model-card .icon { font-size: 3em; margin-bottom: 15px; }
        .model-card h3 { color: var(--primary); margin-bottom: 10px; font-size: 1.15em; }
        .model-card p { color: var(--gray-600); font-size: 0.9em; margin-bottom: 15px; }
        
        .model-card .traits { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        
        .trait-tag {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .model-card.selected .trait-tag { background: var(--primary); color: var(--white); }
        
        /* Committee Selection */
        .committee-section {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .committee-section h2 { color: var(--primary); margin-bottom: 10px; }
        .committee-section > p { color: var(--gray-600); margin-bottom: 25px; }
        
        /* Committee display area */
        .committee-display {
            background: var(--primary-lighter);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 100px;
        }
        
        .committee-display h3 {
            color: var(--primary);
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .committee-members {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .committee-member-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            padding: 6px 12px 6px 6px;
            border-radius: 25px;
            border: 2px solid var(--primary);
            font-size: 0.9em;
        }
        
        .committee-member-chip img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .committee-member-chip .remove-btn {
            background: var(--danger-light);
            color: var(--danger);
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }
        
        .committee-member-chip .remove-btn:hover { background: var(--danger); color: white; }
        
        .committee-member-chip.locked {
            background: var(--gold-light);
            border-color: var(--gold);
        }
        
        .committee-member-chip .locked-badge {
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .empty-committee {
            color: var(--gray-400);
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        
        /* Staff Grid */
        .staff-category { margin-bottom: 35px; }
        
        .staff-category h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.15em;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-lighter);
        }
        
        .staff-category h3 .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--primary-lighter);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
        }
        
        .staff-category h3 .category-count {
            margin-left: auto;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .staff-card, .criteria-tile {
            background: white;
            border-radius: 16px;
            padding: 0;
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }
        
        .staff-card:hover, .criteria-tile:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(89, 49, 95, 0.15);
            transform: translateY(-4px);
        }
        
        .staff-card.selected, .criteria-tile.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
            box-shadow: 0 4px 20px rgba(89, 49, 95, 0.2);
        }
        
        .staff-card.selected::after, .criteria-tile.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
        }
        
        /* Tile Header with illustration */
        .tile-header {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .tile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .tile-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }
        
        .tile-body {
            padding: 20px;
        }
        
        .tile-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        
        .tile-subtitle {
            font-size: 0.85em;
            color: var(--gray-500);
            margin-bottom: 12px;
        }
        
        .tile-description {
            font-size: 0.9em;
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .tile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .tile-tag {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .tile-tag.pro { background: #dcfce7; color: #166534; }
        .tile-tag.con { background: #fef3c7; color: #92400e; }
        
        /* Staff Avatar with gradient ring */
        .staff-avatar-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            padding: 4px;
            position: relative;
            z-index: 2;
        }
        
        .staff-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--gray-700);
            overflow: hidden;
        }
        
        .staff-avatar-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Legacy support */
        .staff-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }
        
        .staff-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .staff-avatar-placeholder {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            flex-shrink: 0;
            color: white;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .staff-info h4 { color: var(--gray-800); font-size: 1em; margin-bottom: 2px; }
        .staff-info .role { color: var(--gray-500); font-size: 0.85em; }
        .staff-info .location { color: var(--gray-400); font-size: 0.8em; }
        
        .staff-bio {
            color: var(--gray-600);
            font-size: 0.9em;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .staff-traits { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        
        .staff-trait {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .staff-trait.strength { background: var(--success-light); color: var(--success); }
        .staff-trait.bias { background: var(--warning-light); color: var(--warning); }
        
        /* Criteria Tiles Grid */
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }
        
        .criteria-tile .tile-header {
            height: 80px;
        }
        
        .criteria-tile .tile-icon {
            width: 60px;
            height: 60px;
            font-size: 1.6em;
        }
        
        .criteria-tile .tile-body {
            padding: 16px;
        }
        
        /* Weight tiles */
        .weight-tile {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 0;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .weight-tile:hover {
            border-color: var(--primary-light);
        }
        
        .weight-tile.has-value {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
        }
        
        .weight-tile-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
        }
        
        .weight-tile-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .weight-tile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .weight-tile-title {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95em;
        }
        
        .weight-tile-value {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .weight-tile-input {
            width: 50px;
            padding: 6px 8px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            text-align: center;
            color: var(--primary);
        }
        
        .weight-tile-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .weight-tile-pct {
            color: var(--gray-400);
            font-weight: 600;
        }
        
        .weight-tile-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--gray-200);
            -webkit-appearance: none;
            cursor: pointer;
        }
        
        .weight-tile-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        /* Criteria Category Styling */
        .criteria-category {
            margin-bottom: 30px;
        }
        
        .criteria-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .category-icon {
            font-size: 1.3em;
        }
        
        /* Enhanced Criteria Tile */
        .criteria-tile {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .criteria-tile:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(89, 49, 95, 0.15);
        }
        
        .criteria-tile.selected {
            border-color: var(--primary);
            background: linear-gradient(180deg, var(--primary-lighter) 0%, white 100%);
        }
        
        .criteria-tile.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }
        
        .criteria-tile-header {
            padding: 20px 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .criteria-tile-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6em;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .criteria-tile-info {
            flex: 1;
            padding-right: 30px;
        }
        
        .criteria-tile-title {
            font-size: 1.05em;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        
        .criteria-tile-question {
            font-size: 0.85em;
            color: var(--primary);
            font-style: italic;
        }
        
        .criteria-tile-body {
            padding: 12px 20px 16px;
        }
        
        .criteria-tile-desc {
            font-size: 0.9em;
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .criteria-tile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .criteria-tag {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .criteria-tag.pro {
            background: #dcfce7;
            color: #166534;
        }
        
        .criteria-tag.con {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Selection checkmark */
        .criteria-tile .selection-check {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }
        
        .criteria-tile.selected .selection-check {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            opacity: 1;
        }
        
        .criteria-tile .selection-check::after {
            content: '✓';
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
        }
        
        .criteria-tile.selected .selection-check::after {
            opacity: 1;
        }
        
        /* Staff Tile Design */
        .staff-tile {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--gray-200);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .staff-tile:hover {
            border-color: var(--primary-light);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 61, 165, 0.15);
        }
        
        .staff-tile.selected {
            border-color: var(--primary);
            background: linear-gradient(180deg, var(--primary-lighter) 0%, white 30%);
            box-shadow: 0 8px 25px rgba(0, 61, 165, 0.2);
        }
        
        .staff-tile.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            z-index: 5;
        }
        
        .staff-tile .selection-check {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
            opacity: 0;
        }
        
        .staff-tile.selected .selection-check {
            background: var(--primary);
            border-color: var(--primary);
            opacity: 1;
        }
        
        .staff-tile .selection-check::after {
            content: '✓';
            font-size: 16px;
            font-weight: bold;
            color: white;
            opacity: 0;
        }
        
        .staff-tile.selected .selection-check::after {
            opacity: 1;
        }
        
        .staff-tile-header {
            padding: 24px 20px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border-bottom: 1px solid var(--gray-100);
        }
        
        .staff-tile-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            padding: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            flex-shrink: 0;
        }
        
        .staff-tile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: white;
        }
        
        .staff-tile-initials {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--gray-600);
        }
        
        .staff-tile-header-info {
            flex: 1;
            min-width: 0;
        }
        
        .staff-tile-name {
            font-size: 1.15em;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .staff-tile-role {
            font-size: 0.9em;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .staff-tile-location {
            font-size: 0.8em;
            color: var(--gray-500);
        }
        
        .staff-tile-body {
            padding: 16px 20px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .staff-tile-bio {
            font-size: 0.88em;
            color: var(--gray-600);
            line-height: 1.55;
            margin-bottom: 16px;
            flex: 1;
        }
        
        .staff-tile-traits {
            margin-bottom: 16px;
        }
        
        .staff-tile-traits-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-400);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .staff-tile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .staff-tag {
            font-size: 0.75em;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .staff-tag.pro { background: #dcfce7; color: #166534; }
        .staff-tag.con { background: #fef3c7; color: #92400e; }
        
        .staff-tile-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--gray-100);
        }
        
        .staff-btn-details, .staff-btn-select {
            flex: 1;
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 0.88em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .staff-btn-details {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .staff-btn-details:hover {
            background: var(--gray-200);
        }
        
        .staff-btn-select {
            background: var(--primary);
            color: white;
        }
        
        .staff-btn-select:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }
        
        .staff-btn-select.selected {
            background: var(--success);
        }
        
        .staff-btn-select.selected:hover {
            background: #dc2626;
        }
        
        .staff-btn-select.locked {
            background: var(--gold);
            cursor: default;
        }
        
        .staff-btn-select.locked:hover {
            background: var(--gold);
        }
        
        .staff-tile.locked {
            border-color: var(--gold);
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
        }
        
        .staff-tile.locked .selection-check {
            background: var(--gold);
            border-color: var(--gold);
            color: white;
            font-size: 0.8em;
            opacity: 1;
        }
        
        /* Staff Category Header */
        .staff-category {
            margin-bottom: 30px;
        }
        
        .staff-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
            padding: 14px 18px;
            background: linear-gradient(135deg, var(--primary-lighter) 0%, white 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }
        
        .staff-category-header .category-icon {
            font-size: 1.3em;
        }
        
        .staff-category-header .category-hint {
            margin-left: auto;
            font-size: 0.75em;
            font-weight: 400;
            color: var(--gray-500);
        }
        
        @media (max-width: 600px) {
            .staff-category-header .category-hint {
                display: none;
            }
        }
        
        /* Criteria Selection Header */
        .criteria-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .criteria-selection-header h2 {
            margin: 0;
        }
        
        .criteria-warning {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .criteria-warning.error {
            background: #fef2f2;
            color: #991b1b;
        }
        
        .criteria-warning.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .criteria-warning.success {
            background: #dcfce7;
            color: #166534;
        }
        
        .learn-more-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .learn-more-btn:hover { background: var(--primary); color: var(--white); }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.hidden { display: none; }
        
        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }
        
        .modal-close:hover { background: var(--gray-200); }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .modal-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-lighter);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .modal-avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.8em;
            color: white;
            border: 4px solid var(--primary-lighter);
        }
        
        .modal-title h2 { color: var(--primary); margin-bottom: 5px; }
        .modal-title .role { color: var(--gray-500); }
        
        .modal-section { margin-bottom: 20px; }
        .modal-section h3 { color: var(--primary); font-size: 1em; margin-bottom: 10px; }
        .modal-section p, .modal-section ul { color: var(--gray-600); font-size: 0.95em; }
        .modal-section ul { padding-left: 20px; }
        .modal-section li { margin-bottom: 5px; }
        
        .cv-item {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .cv-year {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9em;
            width: 70px;
            flex-shrink: 0;
        }
        
        .cv-detail { color: var(--gray-700); font-size: 0.9em; }
        
        .modal-traits { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .add-to-committee-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1em;
        }
        
        .add-to-committee-btn:hover { background: var(--primary-light); }
        .add-to-committee-btn.remove { background: var(--danger); }
        .add-to-committee-btn.remove:hover { background: #b91c1c; }
        
        /* Common Styles */
        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        
        .card h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.6em; }
        .card p { color: var(--gray-600); margin-bottom: 15px; }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(60, 16, 83, 0.25);
        }
        
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); }
        .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }
        
        .btn-secondary:hover { background: var(--gray-50); }
        
        .btn-gold {
            background: var(--gold);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(241, 190, 72, 0.4);
        }
        
        .btn-gold:hover { background: var(--gold-dark); transform: translateY(-2px); }
        
        .btn-large { padding: 18px 40px; font-size: 1.1em; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        
        .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .wbs-badge {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-400);
            font-size: 0.85em;
        }
        
        .hidden { display: none !important; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .landing-title { font-size: 2.5em; }
            .briefing-stats { grid-template-columns: repeat(2, 1fr); }
            .decision-model-grid { grid-template-columns: 1fr 1fr; }
            .staff-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 480px) {
            .landing-title { font-size: 2em; }
            .briefing-header h1 { font-size: 1.8em; }
            .decision-model-grid { grid-template-columns: 1fr; }
        }

        /* Game UI styles */
        .phase-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: var(--white);
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .phase-dot {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--gray-400);
            transition: all 0.3s;
        }
        
        .phase-dot.active {
            background: var(--primary);
            color: var(--white);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(60, 16, 83, 0.3);
        }
        
        .phase-dot.completed { background: var(--success); color: var(--white); }
        .phase-connector { width: 25px; height: 3px; background: var(--gray-200); border-radius: 2px; }
        .phase-connector.completed { background: var(--success); }

        /* Budget bar & project cards */
        .budget-bar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 15px;
            padding: 20px 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            color: var(--white);
        }
        
        .budget-display { font-size: 1.2em; }
        .budget-display .amount { color: var(--gold); font-weight: 700; font-size: 1.2em; }
        .budget-display .total { color: rgba(255,255,255,0.7); }
        .projects-count { background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 20px; font-weight: 600; }
        
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        .project-card {
            background: var(--white);
            border-radius: 12px;
            padding: 18px;
            border: 2px solid var(--gray-200);
            transition: all 0.2s;
            position: relative;
        }
        
        .project-card:hover { border-color: var(--primary-light); box-shadow: 0 4px 12px rgba(60, 16, 83, 0.1); }
        .project-card.selected { border-color: var(--primary); background: var(--primary-lighter); }
        .project-card.locked { opacity: 0.5; }
        
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .project-name { font-weight: 600; color: var(--gray-800); font-size: 1em; }
        .project-budget { background: var(--gold-light); color: var(--gold-dark); padding: 3px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 700; white-space: nowrap; }
        .project-tagline { font-size: 0.85em; color: var(--gray-500); font-style: italic; margin-bottom: 10px; }
        .project-desc { font-size: 0.9em; color: var(--gray-600); margin-bottom: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .project-card-actions { display: flex; gap: 8px; }
        .project-learn-more { flex: 1; background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
        .project-learn-more:hover { background: var(--primary); color: white; }
        .project-select-btn { flex: 1; background: var(--primary); border: none; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
        .project-select-btn:hover { background: var(--primary-light); }
        .project-select-btn.selected { background: var(--success); }
        .project-select-btn:disabled { background: var(--gray-300); cursor: not-allowed; }
        
        /* Legacy Project Card Styles */
        .legacy-project-card {
            background: var(--white);
            border-radius: 14px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 5px solid var(--gray-300);
        }
        
        .legacy-project-card.status-green { border-left-color: var(--success); }
        .legacy-project-card.status-amber { border-left-color: var(--warning); }
        .legacy-project-card.status-red { border-left-color: var(--danger); }
        
        .legacy-card-header {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            cursor: pointer;
            background: var(--gray-50);
            transition: background 0.2s;
        }
        
        .legacy-card-header:hover { background: var(--gray-100); }
        
        .legacy-card-header h3 {
            margin: 0 0 6px 0;
            color: var(--gray-800);
            font-size: 1.15em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Legacy Quick Decision Buttons */
        .legacy-quick-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .legacy-quick-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray-600);
        }
        
        .legacy-quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .legacy-quick-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .legacy-quick-btn.selected.decision-kill {
            border-color: var(--danger);
            background: var(--danger);
        }
        
        .legacy-quick-btn.selected.decision-pause {
            border-color: var(--warning);
            background: var(--warning);
            color: var(--gray-800);
        }
        
        .legacy-quick-btn.selected.decision-reduce_scope {
            border-color: var(--info);
            background: var(--info);
        }
        
        .legacy-quick-btn.selected.decision-accelerate {
            border-color: var(--success);
            background: var(--success);
        }
        
        .legacy-card-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            min-width: 140px;
        }
        
        .legacy-budget-impact {
            text-align: right;
            padding: 8px 12px;
            background: var(--gray-100);
            border-radius: 8px;
        }
        
        .legacy-budget-impact .amount {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .legacy-budget-impact .label {
            font-size: 0.7em;
            color: var(--gray-500);
            text-transform: uppercase;
        }
        
        .legacy-details-link {
            font-size: 0.8em;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .legacy-details-link:hover {
            text-decoration: underline;
        }
        
        .legacy-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .legacy-badge.inherited { background: var(--primary-lighter); color: var(--primary); }
        
        .legacy-status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .legacy-status-badge.green { background: var(--success-light); color: var(--success); }
        .legacy-status-badge.amber { background: var(--warning-light); color: var(--warning); }
        .legacy-status-badge.red { background: var(--danger-light); color: var(--danger); }
        
        .legacy-card-summary {
            font-size: 0.9em;
            color: var(--gray-600);
            margin: 0;
        }
        
        .legacy-card-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .legacy-metric {
            font-size: 0.8em;
            color: var(--gray-500);
        }
        
        .legacy-metric strong { color: var(--gray-700); }
        
        .legacy-expand-icon {
            font-size: 1.2em;
            color: var(--gray-400);
            transition: transform 0.3s;
        }
        
        .legacy-project-card.expanded .legacy-expand-icon { transform: rotate(180deg); }
        
        .legacy-card-body {
            padding: 0 25px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .legacy-project-card.expanded .legacy-card-body {
            padding: 20px 25px;
            max-height: 2000px;
        }
        
        .legacy-section {
            margin-bottom: 18px;
        }
        
        .legacy-section h4 {
            font-size: 0.9em;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legacy-section p {
            font-size: 0.9em;
            color: var(--gray-600);
            margin: 0;
            line-height: 1.5;
        }
        
        .legacy-timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-left: 15px;
            border-left: 3px solid var(--gray-200);
        }
        
        .legacy-timeline-item {
            position: relative;
            padding-left: 15px;
        }
        
        .legacy-timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray-300);
        }
        
        .legacy-timeline-item.status-green::before { background: var(--success); }
        .legacy-timeline-item.status-amber::before { background: var(--warning); }
        .legacy-timeline-item.status-red::before { background: var(--danger); }
        
        .legacy-timeline-quarter {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--gray-500);
        }
        
        .legacy-timeline-narrative {
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        .legacy-decision-section {
            background: var(--gray-50);
            padding: 18px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .legacy-decision-section h4 {
            margin: 0 0 15px 0;
            font-size: 0.95em;
            color: var(--gray-800);
        }
        
        .legacy-decision-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .legacy-decision-btn {
            flex: 1;
            min-width: 130px;
            padding: 12px 15px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .legacy-decision-btn:hover {
            border-color: var(--primary-light);
            background: var(--primary-lighter);
        }
        
        .legacy-decision-btn.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .legacy-decision-btn.selected.decision-kill {
            border-color: var(--danger);
            background: var(--danger-light);
        }
        
        .legacy-decision-btn.selected.decision-pause {
            border-color: var(--warning);
            background: var(--warning-light);
        }
        
        .legacy-decision-btn .decision-icon {
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        .legacy-decision-btn .decision-label {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--gray-800);
            display: block;
        }
        
        .legacy-decision-btn .decision-desc {
            font-size: 0.75em;
            color: var(--gray-500);
            margin-top: 4px;
        }
        
        .legacy-risk-box {
            background: var(--warning-light);
            border-left: 4px solid var(--warning);
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 10px;
        }
        
        .legacy-risk-box.risk-kill {
            background: var(--danger-light);
            border-left-color: var(--danger);
        }
        
        .legacy-risk-box h5 {
            margin: 0 0 5px 0;
            font-size: 0.8em;
            color: var(--gray-700);
        }
        
        .legacy-risk-box p {
            margin: 0;
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        /* Project Modal Styles */
        .project-modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid var(--gray-100); }
        .project-modal-budget { text-align: right; }
        
        .project-financials { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .financial-item { background: var(--gray-50); padding: 12px; border-radius: 8px; text-align: center; }
        .financial-item .value { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .financial-item .label { font-size: 0.75em; color: var(--gray-500); margin-top: 4px; }
        
        .synergy-item { display: inline-block; background: var(--info-light); color: var(--info); padding: 6px 12px; border-radius: 15px; font-size: 0.85em; margin: 4px 4px 4px 0; }
        
        /* Assessment Phase Styles */
        .assessment-header { text-align: center; margin-bottom: 25px; }
        .assessment-progress-bar { height: 8px; background: var(--gray-200); border-radius: 4px; margin: 15px 0 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%); border-radius: 4px; transition: width 0.3s ease; }
        .assessment-progress-text { font-size: 0.9em; color: var(--gray-500); }
        
        /* Project Progress Dots */
        .project-progress-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .progress-dot {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }
        
        .progress-dot:hover {
            transform: scale(1.1);
        }
        
        .progress-dot.unvisited {
            background: var(--gray-200);
            color: var(--gray-500);
        }
        
        .progress-dot.current {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(89, 49, 95, 0.4);
            transform: scale(1.15);
        }
        
        .progress-dot.partial {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }
        
        .progress-dot.complete {
            background: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }
        
        .progress-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }
        
        .legend-dot.unvisited { background: var(--gray-200); }
        .legend-dot.partial { background: #fef3c7; border: 1px solid #f59e0b; }
        .legend-dot.complete { background: #dcfce7; border: 1px solid #22c55e; }
        
        .progress-dots-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .assessment-project-view { background: var(--gray-50); border-radius: 12px; padding: 25px; margin-bottom: 25px; }
        .assessment-project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .assessment-project-title { font-size: 1.4em; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .assessment-project-tagline { color: var(--gray-500); font-style: italic; }
        .assessment-project-budget { font-size: 1.3em; font-weight: 700; color: var(--gold-dark); background: var(--gold-light); padding: 8px 15px; border-radius: 8px; }
        
        .strategic-buckets { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .strategic-bucket { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; }
        
        .assessment-section { margin-bottom: 20px; }
        .assessment-section h4 { color: var(--primary); margin-bottom: 8px; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; }
        .assessment-section p { color: var(--gray-600); line-height: 1.6; }
        
        .team-leads-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 10px; }
        .team-lead-card { display: flex; align-items: center; gap: 10px; background: var(--white); padding: 12px; border-radius: 8px; border: 1px solid var(--gray-200); }
        .team-lead-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary-lighter); display: flex; align-items: center; justify-content: center; font-size: 1.2em; flex-shrink: 0; }
        .team-lead-info { flex: 1; min-width: 0; }
        .team-lead-name { font-weight: 600; color: var(--gray-800); font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-lead-role { font-size: 0.8em; color: var(--gray-500); }
        .team-lead-vacancy { background: var(--warning-light); border-color: var(--warning); }
        .team-lead-vacancy .team-lead-avatar { background: var(--warning-light); color: var(--warning); }
        
        .assessment-scoring { background: var(--white); border: 2px solid var(--primary-light); border-radius: 12px; padding: 25px; }
        .scoring-title { font-size: 1.1em; font-weight: 600; color: var(--primary); margin-bottom: 20px; text-align: center; }
        
        .scoring-criteria-list { display: flex; flex-direction: column; gap: 18px; }
        .scoring-criterion { display: flex; align-items: center; gap: 20px; padding: 15px; background: var(--gray-50); border-radius: 10px; }
        .criterion-info { flex: 1; }
        .criterion-name { font-weight: 600; color: var(--gray-800); margin-bottom: 3px; }
        .criterion-question { font-size: 0.85em; color: var(--gray-500); }
        
        .criterion-scale { display: flex; gap: 8px; }
        .criterion-scale.three-point { gap: 12px; }
        
        /* Legacy 5-point scale */
        .scale-option { width: 50px; height: 45px; border: 2px solid var(--gray-300); background: var(--white); border-radius: 8px; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .scale-option:hover { border-color: var(--primary-light); background: var(--primary-lighter); }
        .scale-option.selected { border-color: var(--primary); background: var(--primary); color: white; }
        .scale-option .scale-num { font-weight: 700; font-size: 1.1em; }
        .scale-option .scale-label { font-size: 0.6em; text-transform: uppercase; }
        
        /* 3-point scale buttons */
        .scale-btn {
            flex: 1;
            min-width: 80px;
            padding: 12px 16px;
            border: 2px solid var(--gray-300);
            background: var(--white);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .scale-btn:hover {
            border-color: var(--btn-color, var(--gray-400));
            background: color-mix(in srgb, var(--btn-color, var(--gray-400)) 10%, white);
            transform: scale(1.05);
        }
        
        .scale-btn.selected {
            border-color: var(--btn-color, var(--primary));
            background: var(--btn-color, var(--primary));
            color: white;
            box-shadow: 0 4px 12px color-mix(in srgb, var(--btn-color) 40%, transparent);
        }
        
        .scale-btn .scale-icon {
            font-size: 1.5em;
        }
        
        .scale-btn .scale-text {
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scale-btn.selected .scale-icon {
            transform: scale(1.1);
        }
        
        @media (max-width: 500px) {
            .scale-btn {
                min-width: 60px;
                padding: 10px 12px;
            }
            .scale-btn .scale-icon { font-size: 1.3em; }
            .scale-btn .scale-text { font-size: 0.75em; }
        }
        
        .scoring-complete { text-align: center; padding: 15px; background: var(--success-light); border-radius: 8px; margin-top: 15px; color: var(--success); font-weight: 500; }
        
        /* Portfolio Builder Layout */
        .portfolio-builder-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (max-width: 900px) {
            .portfolio-builder-layout {
                grid-template-columns: 1fr;
            }
            .portfolio-sidebar {
                order: 2;
            }
            .portfolio-main {
                order: 1;
            }
        }
        
        .portfolio-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .portfolio-budget-card, .portfolio-buckets-card, .portfolio-projects-list {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .portfolio-budget-card h3, .portfolio-buckets-card h3, .portfolio-projects-list h3 {
            margin: 0 0 12px;
            font-size: 0.95em;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .budget-meter {
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .budget-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%);
            border-radius: 6px;
            transition: width 0.3s;
            width: 0%;
        }
        
        .budget-stats {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .budget-stats .budget-total {
            font-weight: 400;
            color: var(--gray-400);
            font-size: 0.7em;
        }
        
        .projects-count-mini {
            font-size: 0.85em;
            color: var(--gray-500);
            margin-top: 4px;
        }
        
        /* Extra Budget Request Feature */
        .extra-budget-prompt {
            margin-top: 12px;
            padding: 10px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            font-size: 0.85em;
        }
        
        .extra-budget-prompt.hidden {
            display: none;
        }
        
        .extra-budget-prompt p {
            margin: 0 0 8px;
            color: #92400e;
        }
        
        .extra-budget-btn {
            width: 100%;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .extra-budget-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .extra-budget-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .extra-budget-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .extra-budget-modal {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .extra-budget-modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .extra-budget-modal-header h2 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .extra-budget-modal-body {
            padding: 24px;
        }
        
        .extra-budget-scenario {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .extra-budget-scenario p {
            margin: 0;
            line-height: 1.6;
            color: var(--gray-700);
        }
        
        .extra-budget-terms {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .extra-budget-terms h4 {
            margin: 0 0 12px;
            color: #92400e;
        }
        
        .extra-budget-terms ul {
            margin: 0;
            padding-left: 20px;
            color: #78350f;
        }
        
        .extra-budget-terms li {
            margin-bottom: 6px;
        }
        
        .extra-budget-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .extra-budget-actions button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .extra-budget-decline {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }
        
        .extra-budget-decline:hover {
            background: var(--gray-200);
        }
        
        .extra-budget-accept {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
        }
        
        .extra-budget-accept:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .extra-budget-granted {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            text-align: center;
            color: #065f46;
            font-weight: 500;
        }
        
        .extra-budget-granted.hidden {
            display: none;
        }
        
        /* Bootleg Project Feature */
        .bootleg-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .bootleg-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .bootleg-modal {
            background: white;
            border-radius: 16px;
            max-width: 550px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .bootleg-modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .bootleg-modal-header h2 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .bootleg-modal-header p {
            margin: 8px 0 0;
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .bootleg-modal-body {
            padding: 24px;
        }
        
        .bootleg-pitch {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        
        .bootleg-pitcher {
            flex-shrink: 0;
            text-align: center;
        }
        
        .bootleg-pitcher-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            margin-bottom: 6px;
        }
        
        .bootleg-pitcher-name {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--gray-700);
        }
        
        .bootleg-pitcher-role {
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .bootleg-speech {
            flex: 1;
        }
        
        .bootleg-speech p {
            margin: 0;
            color: var(--gray-700);
            line-height: 1.6;
            font-style: italic;
        }
        
        .bootleg-project-card {
            background: white;
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .bootleg-project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .bootleg-project-name {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .bootleg-project-budget {
            background: var(--primary-lighter);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .bootleg-project-desc {
            color: var(--gray-600);
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .bootleg-project-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .bootleg-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        .bootleg-stat-icon {
            font-size: 1.1em;
        }
        
        .bootleg-context {
            background: #f3e8ff;
            border: 1px solid #c084fc;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #6b21a8;
        }
        
        .bootleg-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .bootleg-actions button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bootleg-decline {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }
        
        .bootleg-decline:hover {
            background: var(--gray-200);
        }
        
        .bootleg-accept {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            border: none;
            color: white;
        }
        
        .bootleg-accept:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
        }
        
        /* Case Study Modal */
        .case-study-modal {
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .case-study-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px 30px;
            border-radius: 16px 16px 0 0;
        }
        
        .case-study-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .case-study-header .subtitle {
            opacity: 0.9;
            margin-top: 6px;
            font-size: 0.95em;
        }
        
        .case-study-tabs {
            display: flex;
            background: var(--gray-100);
            border-bottom: 2px solid var(--gray-200);
            overflow-x: auto;
            flex-shrink: 0;
        }
        
        .case-tab {
            padding: 14px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--gray-600);
            white-space: nowrap;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .case-tab:hover {
            color: var(--primary);
            background: var(--gray-50);
        }
        
        .case-tab.active {
            color: var(--primary);
            background: white;
            border-bottom-color: var(--primary);
        }
        
        .case-study-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .case-section {
            display: none;
            padding: 30px;
            line-height: 1.8;
            color: var(--gray-700);
        }
        
        .case-section.active {
            display: block;
        }
        
        .case-section h3 {
            color: var(--primary);
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }
        
        .case-section h4 {
            color: var(--gray-800);
            margin: 25px 0 12px 0;
            font-size: 1.05em;
        }
        
        .case-section p {
            margin: 0 0 15px 0;
        }
        
        .case-quote {
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            margin: 20px 0;
            font-style: italic;
            color: var(--gray-600);
        }
        
        .case-quote .attribution {
            margin-top: 10px;
            font-style: normal;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .case-highlight {
            background: var(--primary-lighter);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
        }
        
        .case-data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
        }
        
        .case-data-table th {
            background: var(--gray-100);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--gray-300);
        }
        
        .case-data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .case-data-table tr:hover {
            background: var(--gray-50);
        }
        
        .leader-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
        }
        
        .leader-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .leader-info h5 {
            margin: 0 0 4px 0;
            color: var(--gray-800);
        }
        
        .leader-info .role {
            font-size: 0.85em;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .leader-info p {
            margin: 0;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .case-study-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .case-progress {
            font-size: 0.85em;
            color: var(--gray-500);
        }
        
        .case-nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .portfolio-bucket-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .portfolio-bucket-item:last-child {
            border-bottom: none;
        }
        
        .bucket-icon {
            font-size: 1.2em;
        }
        
        .bucket-name {
            flex: 1;
            font-size: 0.85em;
            color: var(--gray-700);
        }
        
        .bucket-count {
            font-weight: 700;
            font-size: 0.9em;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .bucket-count.filled {
            background: var(--success-light);
            color: var(--success);
        }
        
        /* Portfolio Scores Panel */
        .portfolio-scores-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-height: 350px;
            display: flex;
            flex-direction: column;
        }
        
        .portfolio-scores-card h3 {
            margin: 0 0 12px;
            font-size: 0.95em;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scores-scroll {
            overflow-y: auto;
            flex: 1;
        }
        
        .score-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
        }
        
        .score-row:hover {
            background: var(--gray-50);
        }
        
        .score-row.in-portfolio {
            background: var(--primary-lighter);
            border-color: var(--primary-light);
        }
        
        .score-row.is-funded {
            background: #dcfce7;
            border-color: #22c55e;
        }
        
        .score-row.is-stopped {
            opacity: 0.4;
        }
        
        .score-row-rank {
            width: 24px;
            height: 24px;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 700;
            color: var(--gray-600);
            flex-shrink: 0;
        }
        
        .score-row.in-portfolio .score-row-rank,
        .score-row.is-funded .score-row-rank {
            background: var(--primary);
            color: white;
        }
        
        .score-row-info {
            flex: 1;
            min-width: 0;
        }
        
        .score-row-name {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--gray-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .score-row-meta {
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .score-row-scores {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .score-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .score-badge.avg {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .score-badge.you {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .score-row-status {
            font-size: 0.85em;
            flex-shrink: 0;
        }
        
        .portfolio-selected-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--primary-lighter);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .portfolio-selected-item .project-name {
            flex: 1;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--gray-800);
        }
        
        .portfolio-selected-item .project-budget {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.85em;
        }
        
        .portfolio-selected-item .remove-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: var(--gray-300);
            color: white;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        
        .portfolio-selected-item .remove-btn:hover {
            background: var(--danger);
        }
        
        .empty-portfolio {
            text-align: center;
            padding: 20px;
            color: var(--gray-400);
            font-style: italic;
            font-size: 0.9em;
        }
        
        /* Matrix Main Area */
        .portfolio-main {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .matrix-header h2 {
            margin: 0 0 5px;
            color: var(--primary);
        }
        
        .matrix-header p {
            margin: 0 0 12px;
            color: var(--gray-500);
            font-size: 0.95em;
        }
        
        .interaction-hint {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(90deg, var(--primary-lighter) 0%, #fef3c720 100%);
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px dashed var(--primary-light);
        }
        
        .interaction-hint .hint-icon {
            font-size: 1.4em;
        }
        
        .interaction-hint span {
            color: var(--primary);
            font-weight: 500;
            font-size: 0.95em;
        }
        
        .clickable-hint {
            background: var(--primary-lighter);
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .matrix-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            row-gap: 8px;
        }
        
        .matrix-tab {
            padding: 10px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
        }
        
        .matrix-tab:hover {
            border-color: var(--primary-light);
            background: var(--primary-lighter);
        }
        
        .matrix-tab.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        /* 2x2 Matrix */
        .matrix-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            max-height: 500px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .matrix-quadrant {
            position: absolute;
            width: 50%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .matrix-quadrant.q1 { top: 0; right: 0; background: #dcfce720; }
        .matrix-quadrant.q2 { top: 0; left: 0; background: #fef3c720; }
        .matrix-quadrant.q3 { bottom: 0; left: 0; background: #fee2e220; }
        .matrix-quadrant.q4 { bottom: 0; right: 0; background: #dbeafe20; }
        
        .quadrant-label {
            position: absolute;
            font-size: 0.75em;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            padding: 8px;
            pointer-events: none;
        }
        
        .q1 .quadrant-label { top: 8px; right: 8px; color: #166534; }
        .q2 .quadrant-label { top: 8px; left: 8px; color: #92400e; }
        .q3 .quadrant-label { bottom: 8px; left: 8px; color: #991b1b; }
        .q4 .quadrant-label { bottom: 8px; right: 8px; color: #1e40af; }
        
        .matrix-axis {
            position: absolute;
            background: var(--gray-300);
            pointer-events: none;
        }
        
        .matrix-axis.horizontal {
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
        }
        
        .matrix-axis.vertical {
            width: 2px;
            height: 100%;
            top: 0;
            left: 50%;
        }
        
        .axis-label {
            position: absolute;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--gray-600);
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
        }
        
        .axis-label.x-min { bottom: 50%; left: 8px; transform: translateY(50%); }
        .axis-label.x-max { bottom: 50%; right: 8px; transform: translateY(50%); }
        .axis-label.y-min { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .axis-label.y-max { top: 8px; left: 50%; transform: translateX(-50%); }
        
        /* Project Bubbles */
        .project-bubble {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75em;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .project-bubble:hover {
            transform: scale(1.15);
            z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .project-bubble.available {
            background: var(--gray-400);
            border: 3px solid var(--gray-500);
        }
        
        .project-bubble.selected {
            background: var(--primary);
            border: 3px solid var(--gold);
            box-shadow: 0 0 0 3px var(--primary-lighter), 0 4px 12px rgba(89, 49, 95, 0.4);
        }
        
        .project-bubble.unaffordable {
            background: var(--gray-300);
            border: 3px dashed var(--gray-400);
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Triage-based bubble states */
        .project-bubble.funded {
            background: #22c55e;
            border: 3px solid #166534;
            cursor: default;
        }
        
        .project-bubble.funded:hover {
            transform: scale(1.1);
        }
        
        .project-bubble.marginal-in {
            background: var(--primary);
            border: 3px solid var(--gold);
            box-shadow: 0 0 0 3px var(--primary-lighter), 0 4px 12px rgba(89, 49, 95, 0.4);
            cursor: pointer;
        }
        
        .project-bubble.marginal-in:hover {
            background: #dc2626;
            border-color: #991b1b;
            box-shadow: 0 0 0 3px #fee2e2, 0 4px 12px rgba(220, 38, 38, 0.4);
        }
        
        .project-bubble.marginal-in:hover::after {
            content: '−';
            position: absolute;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .project-bubble.marginal-out {
            background: white;
            border: 3px dashed var(--primary);
            color: var(--primary);
            cursor: pointer;
            animation: pulse-border 2s infinite;
        }
        
        .project-bubble.marginal-out:hover {
            background: var(--primary-lighter);
            border-style: solid;
            border-color: var(--primary);
            animation: none;
            box-shadow: 0 0 0 4px var(--primary-lighter), 0 4px 12px rgba(89, 49, 95, 0.3);
        }
        
        .project-bubble.marginal-out:hover::after {
            content: '+';
            position: absolute;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
        }
        
        @keyframes pulse-border {
            0%, 100% { border-color: var(--primary); opacity: 1; }
            50% { border-color: var(--primary-light); opacity: 0.7; }
        }
        
        .project-bubble.stopped {
            background: var(--gray-300);
            border: 3px solid var(--gray-400);
            opacity: 0.35;
            cursor: not-allowed;
        }
        
        .project-bubble.stopped:hover {
            transform: scale(1.05);
        }
        
        /* Year 1 Review bubble states */
        .project-bubble.review-success {
            background: #22c55e;
            border: 3px solid #166534;
            cursor: default;
        }
        
        .project-bubble.review-failed {
            background: #ef4444;
            border: 3px solid #b91c1c;
            cursor: default;
        }
        
        .project-bubble.review-killed {
            background: #6b7280;
            border: 3px solid #374151;
            cursor: default;
        }
        
        .project-bubble.review-active {
            background: #3b82f6;
            border: 3px solid #1d4ed8;
            cursor: default;
        }
        
        .project-bubble .bubble-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-800);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 8px;
            z-index: 100;
        }
        
        .project-bubble:hover .bubble-tooltip {
            opacity: 1;
        }
        
        .bubble-tooltip .tooltip-name {
            font-weight: 700;
        }
        
        .bubble-tooltip .tooltip-budget {
            color: var(--gold);
        }
        
        /* Matrix Legend */
        .matrix-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
        }
        
        .matrix-legend .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        .legend-bubble {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .legend-bubble.available {
            background: var(--gray-400);
            border: 2px solid var(--gray-500);
        }
        
        .legend-bubble.selected {
            background: var(--primary);
            border: 2px solid var(--gold);
        }
        
        .legend-bubble.unaffordable {
            background: var(--gray-300);
            border: 2px dashed var(--gray-400);
            opacity: 0.5;
        }
        
        .legend-bubble.funded {
            background: #22c55e;
            border: 2px solid #166534;
        }
        
        .legend-bubble.marginal-in {
            background: var(--primary);
            border: 2px solid var(--gold);
        }
        
        .legend-bubble.marginal-out {
            background: white;
            border: 2px dashed var(--primary);
        }
        
        .legend-bubble.stopped {
            background: var(--gray-300);
            border: 2px solid var(--gray-400);
            opacity: 0.4;
        }
        
        .legend-size {
            font-size: 0.8em;
            color: var(--gray-400);
            font-style: italic;
        }
        
        /* Triage Phase Styles */
        .triage-layout {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .triage-header {
            background: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .triage-header h2 {
            margin: 0 0 8px;
            color: var(--primary);
        }
        
        .triage-header p {
            margin: 0 0 20px;
            color: var(--gray-600);
        }
        
        .triage-budget-summary {
            background: var(--gray-50);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .triage-budget-bar {
            height: 10px;
            background: var(--gray-200);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .triage-budget-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, var(--primary) 100%);
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        .triage-budget-text {
            font-size: 0.9em;
            color: var(--gray-600);
        }
        
        .triage-budget-text .funded-amount {
            color: #166534;
            font-weight: 700;
        }
        
        .triage-budget-text .marginal-amount {
            color: var(--primary);
            font-weight: 600;
        }
        
        .triage-budget-text .separator {
            color: var(--gray-300);
            margin: 0 10px;
        }
        
        .triage-counts {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .triage-count {
            text-align: center;
            padding: 12px 25px;
            border-radius: 10px;
        }
        
        .triage-count.fund {
            background: #dcfce7;
        }
        
        .triage-count.marginal {
            background: var(--primary-lighter);
        }
        
        .triage-count.stop {
            background: var(--gray-100);
        }
        
        .triage-count .count-num {
            display: block;
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .triage-count.fund .count-num { color: #166534; }
        .triage-count.marginal .count-num { color: var(--primary); }
        .triage-count.stop .count-num { color: var(--gray-500); }
        
        .triage-count .count-label {
            font-size: 0.85em;
            color: var(--gray-600);
        }
        
        /* Triage Cards */
        .triage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .triage-card {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s;
            border: 2px solid var(--gray-200);
        }
        
        .triage-card.status-fund {
            border-color: #22c55e;
            background: linear-gradient(180deg, #dcfce7 0%, white 30%);
        }
        
        .triage-card.status-marginal {
            border-color: var(--primary);
            background: linear-gradient(180deg, var(--primary-lighter) 0%, white 30%);
        }
        
        .triage-card.status-stop {
            border-color: var(--gray-300);
            opacity: 0.6;
        }
        
        .triage-card-header {
            padding: 15px 18px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .triage-card-rank {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        
        .triage-card-title {
            flex: 1;
        }
        
        .triage-card-title h4 {
            margin: 0 0 4px;
            font-size: 1.05em;
            color: var(--gray-800);
        }
        
        .triage-card-title .tagline {
            font-size: 0.85em;
            color: var(--gray-500);
            font-style: italic;
        }
        
        .triage-card-budget {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--gold-dark);
            background: var(--gold-light);
            padding: 6px 12px;
            border-radius: 8px;
            white-space: nowrap;
        }
        
        .triage-card-scores {
            padding: 0 18px 15px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .score-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }
        
        .score-pill.your-score {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .score-pill.avg-score {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .score-pill.consensus {
            background: #fef3c7;
            color: #92400e;
        }
        
        .score-pill strong {
            font-weight: 700;
        }
        
        .triage-card-lead {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: var(--gray-50);
            cursor: pointer;
            transition: background 0.2s;
            border-top: 1px solid var(--gray-100);
        }
        
        .triage-card-lead:hover {
            background: var(--primary-lighter);
        }
        
        .triage-lead-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75em;
            flex-shrink: 0;
        }
        
        .triage-lead-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .triage-lead-name {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--gray-800);
        }
        
        .triage-lead-role {
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .triage-lead-track {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 700;
        }
        
        .triage-lead-track.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .triage-lead-track.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .triage-lead-track.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .triage-card-actions {
            padding: 12px 18px;
            background: var(--gray-50);
            display: flex;
            gap: 8px;
        }
        
        .triage-btn {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .triage-btn.fund-btn {
            background: white;
            border-color: #22c55e;
            color: #166534;
        }
        
        .triage-btn.fund-btn:hover, .triage-btn.fund-btn.active {
            background: #22c55e;
            color: white;
        }
        
        .triage-btn.marginal-btn {
            background: white;
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .triage-btn.marginal-btn:hover, .triage-btn.marginal-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .triage-btn.stop-btn {
            background: white;
            border-color: var(--gray-400);
            color: var(--gray-600);
        }
        
        .triage-btn.stop-btn:hover, .triage-btn.stop-btn.active {
            background: var(--gray-500);
            color: white;
        }
        
        .triage-btn.info-btn {
            flex: 0;
            padding: 10px 14px;
            background: white;
            border-color: var(--gray-300);
            color: var(--gray-600);
        }
        
        .triage-btn.info-btn:hover {
            background: var(--gray-100);
        }
        
        /* Modal triage actions */
        .modal-triage-actions {
            margin: 25px 0;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 12px;
            border: 2px solid var(--gray-200);
        }
        
        .modal-triage-actions h3 {
            margin: 0 0 15px 0;
            font-size: 1em;
            color: var(--gray-700);
        }
        
        .modal-triage-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-triage-buttons .triage-btn {
            flex: 1;
            padding: 14px 16px;
            font-size: 1em;
        }
        
        /* Year 2 Assessment Styles */
        .feedback-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .feedback-tab {
            padding: 10px 20px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
        }
        
        .feedback-tab:hover {
            border-color: var(--primary-light);
        }
        
        .feedback-tab.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .feedback-tab-content.hidden {
            display: none;
        }
        
        .rankings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .ranking-item:hover {
            border-color: var(--primary-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .ranking-item.ongoing {
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
        }
        
        .ranking-rank {
            font-size: 1.3em;
            font-weight: 700;
            min-width: 45px;
            text-align: center;
        }
        
        .ranking-info {
            flex: 1;
        }
        
        .ranking-name {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .ranking-tagline {
            font-size: 0.85em;
            color: var(--gray-500);
            margin-top: 2px;
        }
        
        .ranking-scores {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .score-pill.you {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .score-pill.committee {
            background: var(--gold-light);
            color: var(--gold);
        }
        
        .score-pill.overall {
            background: var(--success-light);
            color: var(--success);
            font-weight: 600;
        }
        
        .ranking-budget {
            font-weight: 600;
            color: var(--gray-600);
            min-width: 80px;
            text-align: right;
        }
        
        /* Comparison View */
        .comparison-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .comparison-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
        }
        
        .comparison-item.new {
            border-left: 4px solid var(--success);
        }
        
        .comparison-item.ongoing {
            border-left: 4px solid var(--primary);
            background: var(--gray-50);
        }
        
        .comparison-rank {
            font-weight: 700;
            min-width: 35px;
            color: var(--gray-500);
        }
        
        .comparison-badge {
            font-size: 1.2em;
        }
        
        .comparison-info {
            flex: 1;
        }
        
        .comparison-name {
            font-weight: 500;
        }
        
        .comparison-score {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary);
        }
        
        .comparison-budget {
            color: var(--gray-500);
            font-size: 0.9em;
        }
        
        .comparison-insight {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .comparison-insight.success {
            background: var(--success-light);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .comparison-insight.info {
            background: var(--info-light);
            border: 1px solid var(--info);
            color: var(--info);
        }
        
        /* Year 2 Triage Grid */
        .triage-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .triage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .triage-project-info {
            flex: 1;
            min-width: 200px;
        }
        
        .triage-project-name {
            font-weight: 600;
            display: block;
        }
        
        .triage-project-score {
            font-size: 0.85em;
            color: var(--gray-500);
        }
        
        .triage-buttons {
            display: flex;
            gap: 8px;
        }
        
        .triage-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .triage-btn.fund {
            border-color: var(--success);
            color: var(--success);
        }
        
        .triage-btn.fund.selected, .triage-btn.fund:hover {
            background: var(--success);
            color: white;
        }
        
        .triage-btn.marginal {
            border-color: var(--warning);
            color: var(--warning);
        }
        
        .triage-btn.marginal.selected, .triage-btn.marginal:hover {
            background: var(--warning);
            color: white;
        }
        
        .triage-btn.stop {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .triage-btn.stop.selected, .triage-btn.stop:hover {
            background: var(--danger);
            color: white;
        }
        
        .project-badge.year2 {
            background: var(--success);
            color: white;
        }
        
        /* Portfolio View Tabs */
        .portfolio-view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .view-tab {
            padding: 10px 20px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
        }
        
        .view-tab:hover {
            border-color: var(--primary-light);
        }
        
        .view-tab.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        /* Portfolio List View */
        .portfolio-list-sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .portfolio-list-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 18px;
        }
        
        .portfolio-list-section h3 {
            margin: 0 0 15px;
            font-size: 1em;
            color: var(--gray-700);
        }
        
        .portfolio-list-section .section-hint {
            font-weight: 400;
            color: var(--gray-400);
            font-size: 0.9em;
        }
        
        .portfolio-list-section.funded-section {
            background: #dcfce710;
            border: 1px solid #dcfce7;
        }
        
        .portfolio-list-section.marginal-section {
            background: var(--primary-lighter);
            border: 1px solid var(--primary-light);
        }
        
        .portfolio-list-section.stopped-section {
            opacity: 0.6;
        }
        
        .portfolio-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .portfolio-list-item:last-child {
            margin-bottom: 0;
        }
        
        .portfolio-list-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .portfolio-list-item.in-portfolio {
            border-left: 4px solid var(--primary);
        }
        
        .portfolio-list-item .item-rank {
            width: 28px;
            height: 28px;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .portfolio-list-item .item-info {
            flex: 1;
        }
        
        .portfolio-list-item .item-name {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95em;
            display: block;
        }
        
        .portfolio-list-item .item-detail {
            font-size: 0.8em;
            color: var(--gray-500);
            display: block;
            margin-top: 2px;
        }
        
        .portfolio-list-item .item-status {
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .portfolio-list-item .item-scores {
            font-size: 0.8em;
            color: var(--gray-500);
        }
        
        .portfolio-list-item .item-budget {
            font-weight: 700;
            color: var(--primary);
        }
        
        .portfolio-list-item .item-toggle {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
        }
        
        .portfolio-list-item .item-toggle.add {
            background: var(--primary-lighter);
            color: var(--primary);
        }
        
        .portfolio-list-item .item-toggle.remove {
            background: var(--gray-200);
            color: var(--gray-600);
        }
        
        .portfolio-list-item .item-details {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            color: var(--gray-500);
            font-size: 0.8em;
        }
        
        .portfolio-list-item .item-lead {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .portfolio-list-item .item-lead:hover {
            background: var(--primary-lighter);
        }
        
        .item-lead-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.65em;
        }
        
        .item-lead-name {
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .item-lead-score {
            font-size: 0.7em;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 4px;
        }
        
        .item-lead-score.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .item-lead-score.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .item-lead-score.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        /* TRL Display Styles */
        .trl-display { margin-top: 10px; }
        .trl-bar { display: flex; gap: 4px; margin-bottom: 10px; }
        .trl-level { 
            flex: 1; height: 35px; display: flex; align-items: center; justify-content: center;
            background: var(--gray-200); border-radius: 4px; font-weight: 600; font-size: 0.85em; color: var(--gray-400);
            transition: all 0.2s;
        }
        .trl-level.target { background: var(--info-light); color: var(--info); }
        .trl-level.current { background: var(--primary); color: white; }
        .trl-legend { display: flex; gap: 20px; font-size: 0.85em; color: var(--gray-600); }
        .trl-dot { display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 6px; vertical-align: middle; }
        .trl-dot.current { background: var(--primary); }
        .trl-dot.target { background: var(--info-light); border: 2px solid var(--info); }
        
        .trl-explainer { margin-top: 15px; font-size: 0.85em; }
        .trl-explainer summary { cursor: pointer; color: var(--primary); font-weight: 500; }
        .trl-definitions { margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px; }
        .trl-def { background: var(--white); padding: 8px 12px; border-radius: 6px; font-size: 0.9em; }
        
        /* IP Position Styles */
        .ip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .ip-box { background: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--gray-200); }
        .ip-box-header { font-weight: 600; margin-bottom: 8px; color: var(--gray-700); }
        .ip-box p { font-size: 0.9em; color: var(--gray-600); margin: 0; }
        
        .fto-assessment { 
            margin-top: 15px; padding: 12px 15px; border-radius: 8px; font-size: 0.9em;
            display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
        }
        .fto-assessment.low-risk { background: var(--success-light); color: var(--success); }
        .fto-assessment.medium-risk { background: var(--warning-light); color: var(--warning); }
        .fto-assessment.high-risk { background: var(--danger-light); color: var(--danger); }
        .fto-risk-badge { 
            padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 0.85em;
            background: rgba(255,255,255,0.5);
        }
        
        /* Competitors Styles */
        .competitors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 10px; }
        .competitor-card { 
            background: var(--white); padding: 15px; border-radius: 8px; 
            border-left: 4px solid var(--gray-300);
        }
        .competitor-card.threat-very-high { border-left-color: var(--danger); }
        .competitor-card.threat-high { border-left-color: #f97316; }
        .competitor-card.threat-medium { border-left-color: var(--warning); }
        .competitor-card.threat-medium-high { border-left-color: #f97316; }
        .competitor-card.threat-low { border-left-color: var(--success); }
        .competitor-name { font-weight: 600; color: var(--gray-800); margin-bottom: 6px; }
        .competitor-position { font-size: 0.85em; color: var(--gray-600); margin-bottom: 8px; }
        .competitor-threat { font-size: 0.8em; color: var(--gray-500); }
        
        @media (max-width: 600px) {
            .ip-grid { grid-template-columns: 1fr; }
            .trl-bar { flex-wrap: wrap; }
            .trl-level { min-width: 30px; }
        }
        
        /* Development Costs Styles */
        .dev-costs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 12px; }
        .dev-cost-item { 
            background: var(--white); padding: 12px; border-radius: 8px; text-align: center;
            border: 1px solid var(--gray-200);
        }
        .dev-cost-item.total { background: var(--primary); color: white; border: none; }
        .dev-cost-amount { font-size: 1.2em; font-weight: 700; color: var(--primary); }
        .dev-cost-item.total .dev-cost-amount { color: white; }
        .dev-cost-label { font-size: 0.75em; color: var(--gray-500); margin-top: 2px; }
        .dev-cost-item.total .dev-cost-label { color: rgba(255,255,255,0.8); }
        .dev-cost-pct { font-size: 0.7em; color: var(--gray-400); }
        .dev-cost-item.total .dev-cost-pct { color: rgba(255,255,255,0.6); }
        
        /* Milestones Styles */
        .milestones-timeline { margin-top: 15px; }
        .milestone-item { 
            background: var(--white); border-radius: 10px; padding: 18px; margin-bottom: 15px;
            border-left: 4px solid var(--primary); position: relative;
        }
        .milestone-item::before {
            content: ''; position: absolute; left: -10px; top: 24px;
            width: 16px; height: 16px; background: var(--primary); border-radius: 50%;
            border: 3px solid var(--white);
        }
        .milestone-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .milestone-phase { font-weight: 700; color: var(--primary); font-size: 1.05em; }
        .milestone-meta { display: flex; gap: 15px; font-size: 0.85em; color: var(--gray-500); }
        .milestone-meta span { display: flex; align-items: center; gap: 4px; }
        
        .milestone-deliverables { margin-bottom: 12px; }
        .milestone-deliverables-title { font-size: 0.8em; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; text-transform: uppercase; }
        .deliverable-tag { 
            display: inline-block; background: var(--gray-100); padding: 4px 10px; 
            border-radius: 12px; font-size: 0.8em; margin: 2px 4px 2px 0; color: var(--gray-700);
        }
        
        .milestone-metrics { background: var(--gray-50); border-radius: 8px; padding: 12px; }
        .milestone-metrics-title { font-size: 0.8em; font-weight: 600; color: var(--gray-600); margin-bottom: 8px; text-transform: uppercase; }
        .metric-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--gray-200); font-size: 0.85em; }
        .metric-row:last-child { border-bottom: none; }
        .metric-name { color: var(--gray-600); }
        .metric-target { color: var(--primary); font-weight: 500; text-align: right; max-width: 60%; }
        
        .milestone-gate { 
            margin-top: 12px; padding: 10px 12px; background: var(--warning-light); 
            border-radius: 6px; font-size: 0.85em; color: var(--warning);
            display: flex; align-items: center; gap: 8px;
        }
        .milestone-gate::before { content: '🚦'; }
        
        .milestones-summary { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            margin-bottom: 15px; background: var(--gray-50); padding: 15px; border-radius: 10px;
        }
        .milestone-summary-item { text-align: center; }
        .milestone-summary-phase { font-size: 0.8em; color: var(--primary); font-weight: 600; margin-bottom: 4px; }
        .milestone-summary-duration { font-weight: 600; color: var(--gray-700); font-size: 0.85em; }
        .milestone-summary-cost { font-size: 0.8em; color: var(--gray-500); }
        
        @media (max-width: 600px) {
            .milestones-summary { grid-template-columns: repeat(2, 1fr); }
            .milestone-header { flex-direction: column; }
        }
        
        /* Collapsible Details Styles */
        .info-details { margin-top: 12px; }
        .info-details summary { 
            cursor: pointer; color: var(--primary); font-weight: 500; font-size: 0.9em;
            padding: 8px 12px; background: var(--primary-lighter); border-radius: 6px;
            list-style: none;
        }
        .info-details summary::-webkit-details-marker { display: none; }
        .info-details summary::before { content: '▶ '; font-size: 0.8em; }
        .info-details[open] summary::before { content: '▼ '; }
        .info-details > *:not(summary) { margin-top: 12px; }
        
        /* Key Facts Grid */
        .key-facts-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
            margin-bottom: 20px; padding: 15px; background: var(--primary); border-radius: 12px;
        }
        .key-fact { text-align: center; color: white; }
        .key-fact-value { font-size: 1.1em; font-weight: 700; }
        .key-fact-label { font-size: 0.7em; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; }
        .key-fact-value.fto-low, .key-fact-value.fto-lowmedium { color: #86efac; }
        .key-fact-value.fto-medium { color: #fde047; }
        .key-fact-value.fto-high, .key-fact-value.fto-mediumhigh { color: #fca5a5; }
        @media (max-width: 700px) { .key-facts-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 400px) { .key-facts-grid { grid-template-columns: repeat(2, 1fr); } }
        
        /* Section Details (major collapsible sections) */
        .section-details { 
            margin-bottom: 12px; border: 1px solid var(--gray-200); border-radius: 10px; 
            background: white; overflow: hidden;
        }
        .section-summary {
            cursor: pointer; padding: 14px 16px; display: flex; align-items: center; gap: 12px;
            background: var(--gray-50); list-style: none; transition: background 0.2s;
        }
        .section-summary:hover { background: var(--gray-100); }
        .section-summary::-webkit-details-marker { display: none; }
        .section-icon { font-size: 1.2em; }
        .section-title { font-weight: 600; color: var(--gray-800); flex: 1; }
        .section-hint { font-size: 0.85em; color: var(--gray-500); }
        .section-summary::after { content: '▶'; font-size: 0.7em; color: var(--gray-400); transition: transform 0.2s; }
        .section-details[open] .section-summary::after { transform: rotate(90deg); }
        .section-content { padding: 16px; border-top: 1px solid var(--gray-200); }
        
        /* Assessment Subsections */
        .assessment-subsection { margin-bottom: 16px; }
        .assessment-subsection:last-child { margin-bottom: 0; }
        .assessment-subsection h5 { 
            font-size: 0.85em; font-weight: 600; color: var(--primary); 
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .assessment-subsection p { color: var(--gray-600); line-height: 1.6; font-size: 0.95em; }
        
        /* Financial Box */
        .financial-box {
            background: var(--gray-50); padding: 12px; border-radius: 8px; text-align: center;
        }
        .financial-value { font-weight: 700; color: var(--primary); font-size: 0.95em; }
        .financial-label { font-size: 0.75em; color: var(--gray-500); margin-top: 2px; }
        
        /* Cost Breakdown Bar */
        .cost-breakdown-bar {
            display: flex; height: 24px; border-radius: 6px; overflow: hidden; margin-top: 10px;
        }
        .cost-segment { height: 100%; transition: width 0.3s; }
        .cost-legend {
            display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px; font-size: 0.8em; color: var(--gray-600);
        }
        .legend-dot { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; }
        
        /* Project Short Description */
        .project-short-desc { color: var(--gray-700); line-height: 1.6; margin-bottom: 8px; }
        .full-description { padding: 15px; background: var(--gray-50); border-radius: 8px; }
        .full-description p { color: var(--gray-700); line-height: 1.7; white-space: pre-line; }
        
        /* Criteria Weighting Styles */
        .weights-container {
            background: white; border-radius: 12px; padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;
        }
        .weights-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--gray-100);
        }
        .weights-total-display {
            display: flex; align-items: baseline; gap: 5px;
        }
        .weights-label { font-size: 1em; color: var(--gray-500); }
        .weights-value { 
            font-size: 2.5em; font-weight: 800; 
            transition: color 0.3s;
        }
        .weights-value.under { color: var(--warning); }
        .weights-value.exact { color: var(--success); }
        .weights-value.over { color: var(--danger); }
        .weights-target { font-size: 1.2em; color: var(--gray-400); }
        .weights-status {
            padding: 8px 16px; border-radius: 20px; font-size: 0.9em; font-weight: 500;
            background: var(--gray-100); color: var(--gray-600);
        }
        .weights-status.valid { background: #dcfce7; color: #166534; }
        .weights-status.invalid { background: #fef2f2; color: #991b1b; }
        
        .weights-grid {
            display: flex; flex-direction: column; gap: 12px;
        }
        .weight-item {
            display: grid; grid-template-columns: 50px 1fr 120px 80px; gap: 15px;
            align-items: center; padding: 15px 20px;
            background: var(--gray-50); border-radius: 10px;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .weight-item:hover { border-color: var(--primary-light); }
        .weight-item.has-value { background: var(--primary-lighter); }
        .weight-icon {
            width: 44px; height: 44px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3em; color: white;
        }
        .weight-info h4 { margin: 0 0 4px; color: var(--gray-800); font-size: 1em; }
        .weight-info p { margin: 0; color: var(--gray-500); font-size: 0.85em; }
        .weight-slider-container { display: flex; flex-direction: column; gap: 6px; }
        .weight-slider {
            width: 100%; height: 8px; border-radius: 4px; background: var(--gray-200);
            -webkit-appearance: none; appearance: none; cursor: pointer;
        }
        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); cursor: pointer; border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .weight-slider::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); cursor: pointer; border: 3px solid white;
        }
        .weight-input-group {
            display: flex; align-items: center; gap: 5px;
        }
        .weight-input {
            width: 60px; padding: 8px 10px; border: 2px solid var(--gray-200);
            border-radius: 8px; font-size: 1.1em; font-weight: 700; text-align: center;
            color: var(--primary);
        }
        .weight-input:focus { border-color: var(--primary); outline: none; }
        .weight-pct { color: var(--gray-400); font-weight: 600; }
        
        .weights-actions {
            display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200);
        }
        .btn-text {
            background: none; border: none; color: var(--primary); cursor: pointer;
            font-size: 0.9em; padding: 8px 15px; border-radius: 6px;
        }
        .btn-text:hover { background: var(--primary-lighter); }
        
        .weights-preview {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .weights-preview h3 { margin: 0 0 15px; color: var(--gray-700); font-size: 1em; }
        .weights-formula {
            display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
            padding: 15px; background: var(--gray-50); border-radius: 8px;
            font-family: 'Courier New', monospace; font-size: 0.9em;
        }
        .formula-term {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 6px 10px; background: white; border-radius: 6px;
            border: 1px solid var(--gray-200);
        }
        .formula-weight { font-weight: 700; color: var(--primary); }
        .formula-criteria { color: var(--gray-600); }
        .formula-operator { color: var(--gray-400); font-weight: 700; padding: 0 5px; }
        
        @media (max-width: 700px) {
            .weight-item { grid-template-columns: 40px 1fr; gap: 10px; }
            .weight-slider-container { grid-column: span 2; }
            .weight-input-group { grid-column: span 2; justify-content: flex-end; }
        }
        
        .milestone-metrics-details { margin-top: 10px; }
        .milestone-metrics-details summary { 
            cursor: pointer; color: var(--gray-600); font-size: 0.85em; font-weight: 500;
            padding: 6px 10px; background: var(--gray-100); border-radius: 4px;
        }
        .milestone-metrics-details summary::-webkit-details-marker { display: none; }
        .milestone-metrics-details summary::before { content: '▶ '; font-size: 0.75em; }
        .milestone-metrics-details[open] summary::before { content: '▼ '; }
        .milestone-metrics-details .milestone-metrics { margin-top: 10px; }
        .milestone-metrics-details .milestone-gate { margin-top: 10px; }
        
        /* Cost Summary Styles */
        .cost-summary { 
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
            padding: 12px 15px; background: var(--primary); border-radius: 8px; color: white;
        }
        .cost-total { font-size: 1.1em; }
        .cost-breakdown-hint { font-size: 0.85em; opacity: 0.8; }
        
        /* Competitors Summary Styles */
        .competitors-summary { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .competitor-pill { 
            padding: 6px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500;
            background: var(--gray-100); color: var(--gray-700);
        }
        .competitor-pill.threat-very-high { background: #fee2e2; color: #991b1b; }
        .competitor-pill.threat-high { background: #ffedd5; color: #9a3412; }
        .competitor-pill.threat-medium { background: #fef3c7; color: #92400e; }
        .competitor-pill.threat-low { background: #d1fae5; color: #065f46; }
        .competitor-more { font-size: 0.85em; color: var(--gray-500); padding: 6px 0; }
        
        /* Milestones Header */
        .milestones-header { margin-bottom: 12px; }
        .total-duration { 
            display: inline-block; padding: 8px 15px; background: var(--primary); 
            color: white; border-radius: 20px; font-size: 0.9em;
        }
        
        /* Committee Feedback Styles */
        .committee-legend { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background: var(--gray-50); border-radius: 10px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
        .legend-avatar { width: 28px; height: 28px; border-radius: 50%; }
        
        .feedback-grid { display: flex; flex-direction: column; gap: 15px; }
        
        .feedback-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--gray-200);
        }
        .feedback-card.high-consensus { border-left: 4px solid var(--success); }
        .feedback-card.low-consensus { border-left: 4px solid var(--warning); }
        
        .feedback-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .feedback-rank { font-size: 1.5em; font-weight: 700; color: var(--primary); width: 40px; }
        .feedback-project { flex: 1; }
        .feedback-project .project-name { font-weight: 600; font-size: 1.1em; }
        .feedback-avg-score { text-align: right; }
        .feedback-avg-score .score { font-size: 2em; font-weight: 700; color: var(--primary); }
        .feedback-avg-score .label { font-size: 0.75em; color: var(--gray-500); }
        
        .feedback-scores { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .member-score { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--gray-50); border-radius: 20px; font-size: 0.85em; }
        .member-score img { width: 24px; height: 24px; border-radius: 50%; }
        .member-score .score-val { font-weight: 600; }
        .member-score.your-score { background: var(--primary-lighter); border: 1px solid var(--primary-light); }
        .member-score.high { color: var(--success); }
        .member-score.low { color: var(--danger); }
        
        .consensus-note { margin-top: 12px; padding: 10px 15px; border-radius: 8px; font-size: 0.85em; }
        .consensus-note.aligned { background: var(--success-light); color: var(--success); }
        .consensus-note.divergent { background: var(--warning-light); color: var(--warning); }
        
        .score-badge { font-size: 0.75em; padding: 4px 10px; border-radius: 6px; font-weight: 500; }
        .score-badge.high { background: var(--success-light); color: var(--success); }
        .score-badge.medium { background: var(--warning-light); color: var(--warning); }
        .score-badge.low { background: var(--danger-light); color: var(--danger); }
        
        /* Quarterly review */
        .quarter-header {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 15px;
            margin-bottom: 25px;
            color: var(--white);
        }
        
        .quarter-header h2 { color: var(--white); margin-bottom: 5px; }
        .quarter-header p { color: rgba(255,255,255,0.8); margin: 0; }
        
        .portfolio-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; width: 100%; }
        .portfolio-stat { text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; }
        .portfolio-stat .num { font-size: 1.4em; font-weight: 700; color: var(--gold); }
        .portfolio-stat .lbl { font-size: 0.8em; color: rgba(255,255,255,0.7); }
        
        .review-card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--gray-300);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .review-card.status-green { border-left-color: var(--success); }
        .review-card.status-yellow { border-left-color: var(--warning); }
        .review-card.status-red { border-left-color: var(--danger); }
        
        .review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .review-title-section { flex: 1; }
        .review-title { font-weight: 700; font-size: 1.25em; color: var(--gray-800); display: block; }
        .review-tagline { font-size: 0.9em; color: var(--gray-500); font-style: italic; }
        
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .status-badge.green { background: var(--success-light); color: var(--success); }
        .status-badge.yellow { background: var(--warning-light); color: var(--warning); }
        .status-badge.red { background: var(--danger-light); color: var(--danger); }
        
        /* Key facts grid */
        .review-key-facts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .review-key-facts .fact-item {
            text-align: center;
        }
        
        .review-key-facts .fact-label {
            display: block;
            font-size: 0.75em;
            color: var(--gray-500);
            margin-bottom: 4px;
        }
        
        .review-key-facts .fact-value {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.95em;
        }
        
        /* Progress section */
        .review-progress-section,
        .review-milestone-section,
        .review-narrative-section,
        .review-recommendation {
            margin-bottom: 20px;
        }
        
        .review-progress-section h4,
        .review-milestone-section h4,
        .review-narrative-section h4,
        .review-recommendation h4 {
            font-size: 0.95em;
            color: var(--gray-700);
            margin: 0 0 12px;
            font-weight: 600;
        }
        
        .review-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px; }
        .metric { text-align: center; padding: 12px; background: var(--gray-50); border-radius: 10px; }
        .metric .value { font-size: 1.2em; font-weight: 700; color: var(--primary); }
        .metric .label { font-size: 0.7em; color: var(--gray-500); margin-top: 4px; }
        .metric.warning { background: var(--warning-light); }
        .metric.warning .value { color: var(--warning); }
        
        /* Milestone track */
        .milestone-track {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 10px;
            background: var(--gray-50);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .milestone-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        
        .milestone-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gray-300);
            border: 3px solid var(--gray-400);
            margin-bottom: 8px;
        }
        
        .milestone-item.complete .milestone-dot {
            background: var(--success);
            border-color: #166534;
        }
        
        .milestone-item.current .milestone-dot {
            background: var(--primary);
            border-color: var(--gold);
            box-shadow: 0 0 0 4px var(--primary-lighter);
        }
        
        .milestone-item.upcoming .milestone-dot {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }
        
        .milestone-name {
            font-size: 0.75em;
            color: var(--gray-600);
            text-align: center;
        }
        
        .milestone-connector {
            flex: 0.5;
            height: 3px;
            background: var(--gray-300);
            margin-bottom: 20px;
        }
        
        .milestone-narrative {
            font-size: 0.9em;
            color: var(--gray-600);
            font-style: italic;
            margin: 0;
        }
        
        .review-narrative { 
            padding: 15px 20px; 
            background: var(--gray-50); 
            border-radius: 12px; 
            font-size: 0.95em; 
            font-style: italic; 
            color: var(--gray-600); 
            border-left: 3px solid var(--gold); 
            margin: 0;
        }
        
        /* Intel grid */
        .review-intel-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .intel-card {
            padding: 15px;
            border-radius: 10px;
            background: var(--gray-50);
        }
        
        .intel-card h5 {
            font-size: 0.85em;
            color: var(--gray-700);
            margin: 0 0 8px;
            font-weight: 600;
        }
        
        .intel-card p {
            font-size: 0.85em;
            color: var(--gray-600);
            margin: 0;
            line-height: 1.5;
        }
        
        .intel-card.competitor { border-left: 3px solid #6366f1; }
        .intel-card.ip { border-left: 3px solid #f59e0b; }
        .intel-card.team { border-left: 3px solid #10b981; }
        .intel-card.risk { border-left: 3px solid #ef4444; }
        
        /* Recommendation */
        .review-recommendation {
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary-lighter) 0%, #fef3c720 100%);
            border-radius: 12px;
            border: 1px solid var(--primary-light);
        }
        
        .review-recommendation h4 {
            color: var(--primary);
        }
        
        .review-recommendation p {
            margin: 0;
            font-size: 0.95em;
            color: var(--gray-700);
            line-height: 1.5;
        }
        
        /* Enhanced action buttons */
        .review-actions { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }
        
        .action-btn { 
            padding: 15px 12px; 
            border: 2px solid transparent; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85em; 
            transition: all 0.2s; 
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn .action-icon { font-size: 1.4em; }
        .action-btn .action-label { font-weight: 700; }
        .action-btn .action-desc { font-size: 0.75em; font-weight: 400; opacity: 0.8; }
        
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn.continue { background: var(--success-light); color: var(--success); border-color: #a7f3d0; }
        .action-btn.accelerate { background: var(--info-light); color: var(--info); border-color: #93c5fd; }
        .action-btn.reduce { background: var(--warning-light); color: var(--warning); border-color: #fcd34d; }
        .action-btn.kill { background: var(--danger-light); color: var(--danger); border-color: #fca5a5; }
        .action-btn.selected { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .action-btn.continue.selected { background: var(--success); color: white; }
        .action-btn.accelerate.selected { background: var(--info); color: white; }
        .action-btn.reduce.selected { background: var(--warning); color: white; }
        .action-btn.kill.selected { background: var(--danger); color: white; }
        
        @media (max-width: 768px) {
            .review-key-facts { grid-template-columns: repeat(2, 1fr); }
            .review-metrics { grid-template-columns: repeat(2, 1fr); }
            .review-intel-grid { grid-template-columns: 1fr; }
            .review-actions { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Review Tiles Grid */
        .review-tiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .review-tile {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid var(--gray-300);
            transition: all 0.2s;
        }
        
        .review-tile:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .review-tile.green { border-left-color: var(--success); }
        .review-tile.yellow { border-left-color: var(--warning); }
        .review-tile.red { border-left-color: var(--danger); }
        
        .tile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tile-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .tile-status-dot.green { background: var(--success); }
        .tile-status-dot.yellow { background: var(--warning); }
        .tile-status-dot.red { background: var(--danger); }
        
        .tile-name {
            font-weight: 700;
            font-size: 1.05em;
            color: var(--gray-800);
        }
        
        .tile-metrics {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }
        
        .tile-metric {
            text-align: center;
            flex: 1;
        }
        
        .tile-metric .metric-value {
            display: block;
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .tile-metric .metric-value.warning {
            color: var(--danger);
        }
        
        .tile-metric .metric-label {
            font-size: 0.7em;
            color: var(--gray-500);
            text-transform: uppercase;
        }
        
        .tile-phase {
            font-size: 0.8em;
            color: var(--gray-600);
            margin-bottom: 12px;
            padding: 6px 10px;
            background: linear-gradient(135deg, #EDE9FE, #DDD6FE);
            border-radius: 6px;
            font-weight: 600;
        }
        
        .tile-objectives {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 12px;
            padding: 8px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        
        .tile-obj {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 4px;
            color: var(--gray-700);
        }
        
        .tile-obj.complete { background: #D1FAE5; color: #065F46; }
        .tile-obj.on-track { background: #DBEAFE; color: #1E40AF; }
        .tile-obj.in-progress { background: #FEF3C7; color: #92400E; }
        .tile-obj.at-risk, .tile-obj.behind { background: #FEE2E2; color: #991B1B; }
        
        .tile-narrative {
            font-size: 0.85em;
            font-style: italic;
            color: var(--gray-500);
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .tile-details-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary-lighter);
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .tile-details-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .tile-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .tile-action {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .tile-action:hover {
            transform: scale(1.1);
        }
        
        .tile-action.continue:hover, .tile-action.continue.selected {
            background: var(--success);
            border-color: var(--success);
        }
        
        .tile-action.accelerate:hover, .tile-action.accelerate.selected {
            background: var(--info);
            border-color: var(--info);
        }
        
        .tile-action.reduce:hover, .tile-action.reduce.selected {
            background: var(--warning);
            border-color: var(--warning);
        }
        
        .tile-action.kill:hover, .tile-action.kill.selected {
            background: var(--danger);
            border-color: var(--danger);
        }
        
        .tile-decision-label {
            text-align: center;
        }
        
        .decision-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .decision-tag.continue { background: var(--success-light); color: var(--success); }
        .decision-tag.accelerate { background: var(--info-light); color: var(--info); }
        .decision-tag.reduce { background: var(--warning-light); color: var(--warning); }
        .decision-tag.kill { background: var(--danger-light); color: var(--danger); }
        
        /* Review Modal */
        .review-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .review-modal {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .review-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 10;
            color: var(--gray-600);
        }
        
        .review-modal-close:hover {
            background: var(--gray-100);
        }
        
        .review-modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
        .review-modal-header.green {
            background: linear-gradient(135deg, #166534 0%, #22c55e 100%);
        }
        
        .review-modal-header.yellow {
            background: linear-gradient(135deg, #92400e 0%, #f59e0b 100%);
        }
        
        .review-modal-header.red {
            background: linear-gradient(135deg, #991b1b 0%, #ef4444 100%);
        }
        
        .review-modal-header h2 {
            margin: 0 0 5px;
            color: white;
        }
        
        .review-modal-header p {
            margin: 0 0 10px;
            opacity: 0.9;
        }
        
        .review-modal-header .status-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .review-modal-body {
            padding: 25px 30px;
        }
        
        .review-modal-section {
            margin-bottom: 25px;
        }
        
        .review-modal-section h3 {
            font-size: 1em;
            color: var(--gray-700);
            margin: 0 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-100);
        }
        
        .modal-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .modal-metric {
            text-align: center;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
        }
        
        .modal-metric .value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .modal-metric.warning .value {
            color: var(--danger);
        }
        
        .modal-metric .label {
            font-size: 0.75em;
            color: var(--gray-500);
            margin-top: 4px;
        }
        
        .modal-facts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .modal-facts-grid div {
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .modal-intel-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .review-modal-section.recommendation {
            background: linear-gradient(135deg, var(--primary-lighter) 0%, #fef3c720 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--primary-light);
            margin-bottom: 0;
        }
        
        .review-modal-section.recommendation h3 {
            color: var(--primary);
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 10px;
        }
        
        .review-modal-section.recommendation p {
            margin: 0;
            color: var(--gray-700);
            line-height: 1.6;
        }
        
        .review-modal-footer {
            padding: 20px 30px 25px;
            background: var(--gray-50);
            border-radius: 0 0 20px 20px;
            border-top: 1px solid var(--gray-200);
        }
        
        .review-modal-footer h4 {
            margin: 0 0 15px;
            color: var(--gray-700);
            font-size: 1em;
        }
        
        .modal-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .review-tiles-grid { grid-template-columns: 1fr; }
            .modal-metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .modal-facts-grid { grid-template-columns: 1fr; }
            .modal-intel-grid { grid-template-columns: 1fr; }
            .modal-actions { grid-template-columns: repeat(2, 1fr); }
        }
        
        .event-card { background: linear-gradient(135deg, var(--gold-light) 0%, var(--white) 100%); border: 2px solid var(--gold); border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .event-card h4 { color: var(--gold-dark); margin-bottom: 15px; font-size: 1.1em; }
        .outcome-success { color: var(--success); font-weight: 600; }
        .outcome-failure { color: var(--danger); font-weight: 600; }
        
        /* Results */
        .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 25px 0; }
        .result-quadrant { padding: 25px; border-radius: 15px; text-align: center; }
        .result-quadrant.tp { background: linear-gradient(135deg, var(--success-light) 0%, #fff 100%); border: 2px solid #6ee7b7; }
        .result-quadrant.fp { background: linear-gradient(135deg, var(--danger-light) 0%, #fff 100%); border: 2px solid #fca5a5; }
        .result-quadrant.fn { background: linear-gradient(135deg, var(--warning-light) 0%, #fff 100%); border: 2px solid #fcd34d; }
        .result-quadrant.tn { background: linear-gradient(135deg, var(--info-light) 0%, #fff 100%); border: 2px solid #93c5fd; }
        .quadrant-count { font-size: 3em; font-weight: 700; margin-bottom: 5px; }
        .tp .quadrant-count { color: var(--success); }
        .fp .quadrant-count { color: var(--danger); }
        .fn .quadrant-count { color: var(--warning); }
        .tn .quadrant-count { color: var(--info); }
        .quadrant-label { font-weight: 700; margin-bottom: 5px; color: var(--gray-700); }
        .quadrant-desc { font-size: 0.85em; color: var(--gray-500); }
        
        .intro-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 25px 0; }
        .stat-box { background: linear-gradient(135deg, var(--primary-lighter) 0%, var(--white) 100%); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--primary-pale); }
        .stat-box .value { font-size: 1.6em; font-weight: 700; color: var(--primary); }
        .stat-box .label { font-size: 0.85em; color: var(--gray-500); margin-top: 5px; }
        
        .insight-box { background: var(--white); border-radius: 15px; padding: 25px; margin: 25px 0; border: 1px solid var(--gray-200); }
        .insight-box h3 { color: var(--primary); margin-bottom: 20px; }
        .insight-item { padding: 15px; margin: 12px 0; background: var(--gray-50); border-radius: 10px; border-left: 4px solid var(--primary); color: var(--gray-700); }
        
        .killed-reveal { margin-top: 25px; padding: 25px; background: var(--warning-light); border-radius: 15px; border: 2px solid var(--warning); }
        .killed-reveal h4 { color: var(--warning); margin-bottom: 15px; }
        
        @media (max-width: 600px) { .results-grid { grid-template-columns: 1fr; } .project-grid { grid-template-columns: 1fr; } }
        
        /* ========== MOBILE OPTIMIZATIONS ========== */
        @media (max-width: 600px) {
            /* Larger touch targets for buttons */
            .btn { padding: 16px 24px; min-height: 48px; }
            .btn-sm { padding: 12px 18px; min-height: 44px; }
            
            /* Matrix improvements for mobile */
            .matrix-container { 
                max-height: 350px; 
                touch-action: manipulation;
            }
            .project-bubble {
                min-width: 44px !important;
                min-height: 44px !important;
            }
            .quadrant-label { font-size: 0.65em; padding: 4px; }
            .axis-label { font-size: 0.7em; }
            
            /* Scoring buttons - larger touch targets */
            .scale-btn {
                min-height: 56px;
                padding: 14px 10px;
            }
            
            /* Modal improvements */
            .modal-content { 
                max-height: 90vh; 
                margin: 10px;
                border-radius: 16px;
            }
            .modal-close {
                width: 44px;
                height: 44px;
                font-size: 1.5em;
            }
            
            /* Cockpit cards - stack better */
            .cockpit-card {
                padding: 15px;
            }
            .cockpit-project-name { font-size: 0.95em; }
            
            /* Phase indicator - wrap on mobile */
            .phase-indicator {
                padding: 10px 15px;
                gap: 6px;
            }
            .phase-step { 
                padding: 6px 10px; 
                font-size: 0.8em;
            }
            
            /* Event/Dilemma modals */
            .event-modal, .dilemma-modal {
                padding: 20px;
                margin: 15px;
            }
            
            /* Choice buttons in dilemmas */
            .dilemma-choice {
                padding: 16px;
                min-height: 60px;
            }
            
            /* Portfolio sidebar - full width on mobile */
            .portfolio-sidebar {
                padding: 10px;
            }
            .portfolio-budget-card, .portfolio-buckets-card {
                padding: 12px;
            }
            
            /* Project cards in grid */
            .project-card {
                padding: 15px;
            }
            
            /* Navigation buttons - larger */
            .nav-btn, [class*="nav-"] button {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Side panel full width on mobile */
            .cockpit-detail-panel {
                width: 100%;
                max-width: 100%;
            }
            
            /* Triage action buttons */
            .triage-action {
                padding: 14px 20px;
                min-height: 48px;
            }
            
            /* Font size adjustments for readability */
            .container { padding: 12px; }
            body { font-size: 15px; }
            
            /* Budget bar touch-friendly */
            .budget-bar, .triage-budget-bar {
                height: 14px;
            }
            
            /* Tab buttons */
            .matrix-tab {
                padding: 10px 16px;
                min-height: 44px;
            }
            
            /* Prevent horizontal scroll */
            .container, .screen {
                overflow-x: hidden;
            }
        }
        
        /* Very small screens */
        @media (max-width: 380px) {
            .scale-btn .scale-text { display: none; }
            .scale-btn .scale-icon { font-size: 1.8em; }
            .scale-btn { min-width: 50px; }
            
            .btn { padding: 14px 16px; font-size: 0.9em; }
            .landing-title { font-size: 1.6em; }
            
            .matrix-container { max-height: 280px; }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Remove hover effects that don't work well on touch */
            .project-bubble:hover { transform: none; }
            .btn:hover { transform: none; }
            
            /* Add active states instead */
            .project-bubble:active { transform: scale(1.1); }
            .btn:active { transform: scale(0.98); opacity: 0.9; }
            .scale-btn:active { transform: scale(1.02); }
            
            /* Ensure tooltips work on tap */
            .bubble-tooltip {
                pointer-events: auto;
            }
        }
        
        /* ========== ENHANCED MOBILE SUPPORT ========== */
        
        /* Body scroll lock for modals */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* Safe area support for notched devices */
        @supports (padding: env(safe-area-inset-top)) {
            body {
                padding-top: var(--safe-area-top);
                padding-bottom: var(--safe-area-bottom);
                padding-left: var(--safe-area-left);
                padding-right: var(--safe-area-right);
            }
            
            .container {
                padding-left: max(20px, var(--safe-area-left));
                padding-right: max(20px, var(--safe-area-right));
            }
            
            /* Fixed elements need safe area adjustments */
            .sound-toggle {
                bottom: calc(15px + var(--safe-area-bottom));
                right: calc(15px + var(--safe-area-right));
            }
            
            .cockpit-detail-panel {
                padding-right: var(--safe-area-right);
            }
            
            .modal-content {
                margin-bottom: var(--safe-area-bottom);
            }
        }
        
        /* Improved mobile modal handling */
        @media (max-width: 600px) {
            /* Modal improvements - prevent scroll issues */
            .modal-overlay,
            .dilemma-modal-overlay,
            .event-modal-overlay,
            .approach-modal-overlay,
            .credits-modal-overlay {
                padding: 10px;
                padding-bottom: calc(10px + var(--safe-area-bottom, 0px));
                -webkit-overflow-scrolling: touch;
            }
            
            .modal-content,
            .dilemma-modal,
            .event-modal,
            .approach-modal,
            .credits-modal {
                max-height: calc(100vh - 20px - var(--safe-area-top, 0px) - var(--safe-area-bottom, 0px));
                max-height: calc(100dvh - 20px - var(--safe-area-top, 0px) - var(--safe-area-bottom, 0px));
                margin: auto;
            }
            
            /* Cockpit panel full-screen on mobile */
            .cockpit-detail-panel {
                width: 100%;
                max-width: 100%;
                right: -100%;
            }
            
            .cockpit-detail-panel.active {
                right: 0;
            }
            
            /* Panel close button - larger touch target */
            .panel-close {
                width: 44px;
                height: 44px;
                top: 10px;
                right: 10px;
            }
            
            /* Landing page adjustments */
            .landing-title {
                font-size: 2.2em;
            }
            
            .landing-subtitle {
                font-size: 1.1em;
                padding: 0 10px;
            }
            
            .landing-cta {
                display: flex;
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }
            
            .landing-cta button {
                margin: 0 !important;
                width: 100%;
                max-width: 300px;
            }
            
            /* Better grid handling for small screens */
            .landing-features {
                gap: 15px;
            }
            
            .feature-card {
                padding: 20px;
            }
            
            /* Approach modal improvements */
            .approach-modal-body {
                padding: 20px;
            }
            
            .approach-option {
                padding: 14px;
            }
            
            /* Cockpit grid - 2 columns on mobile */
            .cockpit-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .cockpit-tile {
                padding: 12px;
            }
            
            .cockpit-tile-name {
                font-size: 0.8em;
            }
            
            .cockpit-metric {
                padding: 6px 8px;
            }
            
            .cockpit-metric .value {
                font-size: 0.9em;
            }
            
            .cockpit-metric .label {
                font-size: 0.65em;
            }
            
            /* Action buttons in cockpit panel */
            .cockpit-action-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .cockpit-action-btn {
                padding: 12px 8px;
                min-height: 56px;
            }
            
            .cockpit-action-btn .action-icon {
                font-size: 1.3em;
            }
            
            .cockpit-action-btn .action-label {
                font-size: 0.75em;
            }
            
            /* Header stats wrap better */
            .cockpit-header {
                padding: 16px;
            }
            
            .cockpit-stats {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .cockpit-stat {
                padding: 8px 12px;
                min-width: 80px;
            }
            
            /* Weights grid for criteria */
            .weights-grid {
                gap: 12px;
            }
            
            /* Committee feedback tabs */
            .feedback-tabs {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .feedback-tab {
                flex: 1 1 auto;
                min-width: 100px;
                padding: 10px 12px;
                font-size: 0.85em;
            }
        }
        
        /* Very small screens - single column cockpit */
        @media (max-width: 400px) {
            .cockpit-grid {
                grid-template-columns: 1fr;
            }
            
            .cockpit-action-grid {
                grid-template-columns: 1fr;
            }
            
            .landing-title {
                font-size: 1.8em;
            }
        }
        
        /* Prevent pull-to-refresh interfering with scrolling */
        @media (max-width: 768px) {
            .modal-overlay,
            .panel-body,
            .cockpit-detail-panel {
                overscroll-behavior: contain;
            }
        }
        
        /* ========== COMMITTEE CHAOS MINI-GAME (EMBEDDED) ========== */
        .cc-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 10000;
            background: #F0EBE3;
        }
        .cc-overlay.active { display: block; }
        .cc-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ========== RESOURCE RUN MINI-GAME (EMBEDDED) ========== */
        .rr-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 10001; /* above committee chaos */
            background: #0b1220;
        }
        .rr-overlay.active { display: block; }
        .rr-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* ========================================
           PROJECT COCKPIT STYLES
           ======================================== */
        
        /* Cockpit Header */
        .cockpit-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 24px 30px;
            border-radius: 14px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,61,165,0.2);
        }
        
        .cockpit-title-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .cockpit-title-section h2 {
            font-size: 1.4em;
            font-weight: 700;
            margin: 0;
        }
        
        .cockpit-quarter-badge {
            background: var(--gold);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 700;
        }
        
        .cockpit-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .cockpit-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .cockpit-stat .value {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--gold);
        }
        
        .cockpit-stat .label {
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
        }
        
        .cockpit-stat.alert {
            background: var(--danger);
        }
        
        .cockpit-stat.alert .value {
            color: white;
        }
        
        .rag-summary {
            display: flex;
            gap: 4px;
        }
        
        .rag-pill {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .rag-pill.green { background: var(--success); }
        .rag-pill.amber { background: var(--warning); }
        .rag-pill.red { background: var(--danger); }
        
        /* Cockpit Grid */
        .cockpit-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .cockpit-section-header h3 {
            font-size: 1em;
            color: var(--primary);
        }
        
        .cockpit-legend {
            display: flex;
            gap: 15px;
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .cockpit-legend span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .legend-dot.green { background: var(--success); }
        .legend-dot.amber { background: var(--warning); }
        .legend-dot.red { background: var(--danger); }
        
        .cockpit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Cockpit Project Tiles */
        .cockpit-tile {
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .cockpit-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .cockpit-tile.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-lighter);
        }
        
        .cockpit-tile.green {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #a7f3d0;
        }
        .cockpit-tile.green:hover { border-color: var(--success); }
        
        .cockpit-tile.amber {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fde68a;
        }
        .cockpit-tile.amber:hover { border-color: var(--warning); }
        
        .cockpit-tile.red {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fecaca;
        }
        .cockpit-tile.red:hover { border-color: var(--danger); }
        
        .cockpit-tile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .cockpit-tile-name {
            font-weight: 600;
            font-size: 1em;
            color: var(--gray-800);
        }
        
        .cockpit-tile-quarter {
            font-size: 0.75em;
            padding: 3px 8px;
            background: rgba(0,0,0,0.08);
            border-radius: 4px;
            color: var(--gray-600);
        }
        
        .cockpit-tile-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .cockpit-metric {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.6);
            border-radius: 6px;
        }
        
        .cockpit-metric .value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--gray-800);
        }
        
        .cockpit-metric .label {
            font-size: 0.65em;
            color: var(--gray-500);
            text-transform: uppercase;
        }
        
        .cockpit-tile-progress {
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .cockpit-tile-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .cockpit-tile.green .cockpit-tile-progress-fill { background: var(--success); }
        .cockpit-tile.amber .cockpit-tile-progress-fill { background: var(--warning); }
        .cockpit-tile.red .cockpit-tile-progress-fill { background: var(--danger); }
        
        .cockpit-tile-status {
            font-size: 0.8em;
            color: var(--gray-600);
        }
        
        .cockpit-tile-btn {
            margin-top: 10px;
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .cockpit-tile-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .cockpit-tile.amber .cockpit-tile-btn {
            background: var(--warning);
        }
        
        .cockpit-tile.amber .cockpit-tile-btn:hover {
            background: #b45309;
        }
        
        .cockpit-tile.red .cockpit-tile-btn {
            background: var(--danger);
        }
        
        .cockpit-tile.red .cockpit-tile-btn:hover {
            background: #b91c1c;
        }
        
        /* Cockpit Detail Panel */
        .cockpit-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .cockpit-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .cockpit-detail-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 480px;
            max-width: 95%;
            height: 100vh;
            background: var(--white);
            box-shadow: -10px 0 40px rgba(0,0,0,0.15);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }
        
        .cockpit-detail-panel.active {
            right: 0;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .panel-header-content h3 {
            font-size: 1.2em;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .panel-header-content .tagline {
            font-size: 0.85em;
            color: var(--gray-500);
            font-style: italic;
        }
        
        .panel-rag-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .panel-rag-badge.green { background: var(--success); color: white; }
        .panel-rag-badge.amber { background: var(--warning); color: white; }
        .panel-rag-badge.red { background: var(--danger); color: white; }
        
        .panel-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }
        
        .panel-close:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }
        
        .panel-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
        }
        
        .panel-section {
            margin-bottom: 20px;
        }
        
        .panel-section h4 {
            font-size: 0.85em;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Project Link */
        .project-link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            background: var(--primary-lighter);
            border: 1px dashed var(--primary-light);
            border-radius: 8px;
            color: var(--primary);
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .project-link-btn:hover {
            background: var(--primary-pale);
            border-style: solid;
        }
        
        /* Metrics Grid */
        .panel-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .panel-metric-box {
            text-align: center;
            padding: 12px 8px;
            background: var(--gray-50);
            border-radius: 8px;
        }
        
        .panel-metric-box .value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .panel-metric-box .label {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .panel-metric-box.warning .value { color: var(--warning); }
        .panel-metric-box.danger .value { color: var(--danger); }
        
        /* Snapshot Grid */
        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .snapshot-item {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 8px;
        }
        
        .snapshot-item .label {
            font-size: 0.7em;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }
        
        .snapshot-item .value {
            font-size: 0.85em;
            color: var(--gray-800);
            font-weight: 500;
        }
        
        /* Milestone Track */
        .milestone-track {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .milestone-step {
            flex: 1;
            text-align: center;
        }
        
        .milestone-step-bar {
            height: 8px;
            background: var(--gray-200);
            margin: 0 2px 8px;
            border-radius: 4px;
        }
        
        .milestone-step-bar.complete { background: var(--success); }
        .milestone-step-bar.current { background: var(--primary); animation: pulse 2s infinite; }
        .milestone-step-bar.pending { background: var(--gray-200); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .milestone-step-label {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .milestone-narrative {
            font-size: 0.85em;
            color: var(--gray-600);
            line-height: 1.5;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
        }
        
        /* Intel Grid */
        .intel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .intel-card {
            padding: 12px;
            border-radius: 8px;
            background: var(--gray-50);
        }
        
        .intel-card h5 {
            font-size: 0.75em;
            color: var(--gray-700);
            margin-bottom: 6px;
        }
        
        .intel-card p {
            font-size: 0.8em;
            color: var(--gray-600);
            line-height: 1.4;
        }
        
        /* Team Summary */
        .team-summary {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .team-lead {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .lead-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .lead-info .name {
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .lead-info .role {
            font-size: 0.75em;
            color: var(--gray-500);
        }
        
        .team-size {
            margin-left: auto;
            text-align: center;
        }
        
        .team-size .count {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary);
        }
        
        .team-size .label {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        /* Advice Section */
        .advice-section {
            background: var(--primary-lighter);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .advice-section h4 {
            color: var(--primary);
            font-size: 0.85em;
            margin-bottom: 12px;
        }
        
        .advice-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .advice-card {
            background: var(--white);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid var(--primary);
        }
        
        .advice-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .advisor-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75em;
            color: white;
        }
        
        .advisor-info .name {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--gray-800);
        }
        
        .advisor-info .role {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .advice-stance {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .advice-stance.supportive { background: var(--success-light); color: var(--success); }
        .advice-stance.cautious { background: var(--warning-light); color: var(--warning); }
        .advice-stance.concerned { background: var(--danger-light); color: var(--danger); }
        .advice-stance.neutral { background: var(--gray-100); color: var(--gray-600); }
        
        .advice-quote {
            font-size: 0.85em;
            color: var(--gray-600);
            font-style: italic;
            line-height: 1.5;
        }
        
        /* Cockpit Actions Section */
        .cockpit-actions-section {
            background: var(--white);
            padding: 15px 20px;
            border-top: 1px solid var(--gray-200);
            position: sticky;
            bottom: 0;
        }
        
        .cockpit-actions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .cockpit-actions-header h4 {
            color: var(--primary);
            font-size: 0.85em;
            margin: 0;
            font-weight: 600;
        }
        
        .cockpit-actions-hint {
            font-size: 0.7em;
            color: var(--gray-500);
        }
        
        .cockpit-action-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .cockpit-action-btn {
            padding: 14px 10px;
            border-radius: 8px;
            border: 2px solid var(--gray-200);
            background: var(--white);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
        }
        
        .cockpit-action-btn:hover {
            border-color: var(--gray-400);
            background: var(--gray-50);
        }
        
        .cockpit-action-btn.selected {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }
        
        .cockpit-action-btn .action-icon {
            font-size: 1.3em;
        }
        
        .cockpit-action-btn .action-label {
            font-weight: 600;
            font-size: 0.8em;
            color: var(--gray-700);
            line-height: 1.3;
        }
        
        .cockpit-action-btn.selected .action-label {
            color: var(--primary);
        }
        
        /* Action button colors on hover/select */
        .cockpit-action-btn.continue:hover,
        .cockpit-action-btn.continue.selected { border-color: var(--success); }
        .cockpit-action-btn.continue.selected { background: var(--success-light); }
        .cockpit-action-btn.continue.selected .action-label { color: var(--success); }
        
        .cockpit-action-btn.accelerate:hover,
        .cockpit-action-btn.accelerate.selected { border-color: var(--info); }
        .cockpit-action-btn.accelerate.selected { background: var(--info-light); }
        .cockpit-action-btn.accelerate.selected .action-label { color: var(--info); }
        
        .cockpit-action-btn.reduce:hover,
        .cockpit-action-btn.reduce.selected { border-color: var(--warning); }
        .cockpit-action-btn.reduce.selected { background: var(--warning-light); }
        .cockpit-action-btn.reduce.selected .action-label { color: var(--warning); }
        
        .cockpit-action-btn.champion:hover,
        .cockpit-action-btn.champion.selected { border-color: #db2777; }
        .cockpit-action-btn.champion.selected { background: #fce7f3; }
        .cockpit-action-btn.champion.selected .action-label { color: #db2777; }
        
        .cockpit-action-btn.kill:hover,
        .cockpit-action-btn.kill.selected { border-color: var(--danger); }
        .cockpit-action-btn.kill.selected { background: var(--danger-light); }
        .cockpit-action-btn.kill.selected .action-label { color: var(--danger); }
        
        /* Action implications */
        .cockpit-implications {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 12px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        .implications-placeholder {
            color: var(--gray-400);
            font-size: 0.8em;
            font-style: italic;
        }
        
        .implications-content {
            display: none;
            gap: 20px;
            width: 100%;
        }
        
        .implications-content.visible {
            display: flex;
        }
        
        .implication-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .implication-item.positive { color: var(--success); }
        .implication-item.negative { color: var(--danger); }
        .implication-item.neutral { color: var(--gray-600); }
        
        .cockpit-confirm-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cockpit-confirm-btn:hover {
            background: var(--primary-light);
        }
        
        .cockpit-confirm-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }
        
        /* Template Modal */
        .template-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(60, 16, 83, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .template-modal {
            background: var(--white);
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        .template-header {
            background: var(--primary);
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .template-header h3 {
            font-size: 1.2em;
            margin: 0 0 5px;
        }
        
        .template-header .tagline {
            font-size: 0.85em;
            opacity: 0.85;
            font-style: italic;
            margin: 0;
        }
        
        .template-budget-badge {
            background: var(--gold);
            color: var(--gray-800);
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .template-budget-badge .amount {
            font-size: 1.2em;
            font-weight: 700;
        }
        
        .template-budget-badge .label {
            font-size: 0.7em;
        }
        
        .template-body {
            padding: 20px 25px;
        }
        
        .template-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .template-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .template-section h4 {
            font-size: 0.9em;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .template-section p {
            font-size: 0.9em;
            color: var(--gray-700);
            line-height: 1.6;
            margin: 0;
        }
        
        .template-close {
            display: block;
            width: 100%;
            padding: 14px;
            background: var(--gray-100);
            border: none;
            border-radius: 0 0 12px 12px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .template-close:hover {
            background: var(--gray-200);
        }
        
        /* Cockpit view toggle button */
        .cockpit-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cockpit-toggle-btn:hover {
            background: var(--primary-light);
        }
        
        /* Back button in cockpit */
        .cockpit-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--white);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cockpit-back-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Corporate Event Modal Styles */
        .event-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            animation: eventFadeIn 0.3s ease-out;
        }
        
        @keyframes eventFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes eventSlideIn {
            from { transform: translateY(-30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .event-modal {
            background: white;
            border-radius: 24px;
            max-width: 550px;
            width: 100%;
            position: relative;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: eventSlideIn 0.4s ease-out;
            overflow: hidden;
        }
        
        .event-modal-header {
            padding: 30px 30px 25px;
            text-align: center;
            position: relative;
        }
        
        .event-modal-header.positive {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        
        .event-modal-header.negative {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }
        
        .event-modal-header.neutral {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
        }
        
        .event-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        
        .event-category {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .event-title {
            color: white;
            font-size: 1.6em;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .event-modal-body {
            padding: 25px 30px 30px;
        }
        
        .event-description {
            font-size: 1.05em;
            color: var(--gray-700);
            line-height: 1.7;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .event-effect-box {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .event-effect-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .event-effect-text {
            font-size: 1.1em;
            font-weight: 600;
            line-height: 1.5;
        }
        
        .event-effect-text.positive {
            color: var(--success);
        }
        
        .event-effect-text.negative {
            color: var(--danger);
        }
        
        .event-effect-text.neutral {
            color: var(--warning);
        }
        
        .event-duration {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--gray-500);
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        
        .event-duration-icon {
            font-size: 1.1em;
        }
        
        .event-acknowledge-btn {
            width: 100%;
            padding: 16px 24px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .event-acknowledge-btn.positive {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
        
        .event-acknowledge-btn.negative {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }
        
        .event-acknowledge-btn.neutral {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
        }
        
        .event-acknowledge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        /* Event notification badge in quarter header */
        .event-active-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--warning-light);
            color: var(--warning);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .event-active-badge.positive {
            background: var(--success-light);
            color: var(--success);
        }
        
        .event-active-badge.negative {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        /* Project Lead Card Styles */
        .project-lead-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .lead-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .lead-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            flex-shrink: 0;
        }
        
        .lead-info {
            flex: 1;
            min-width: 0;
        }
        
        .lead-name {
            font-weight: 700;
            color: var(--gray-800);
            font-size: 1.05em;
        }
        
        .lead-role {
            color: var(--gray-600);
            font-size: 0.85em;
        }
        
        .lead-tenure {
            color: var(--gray-500);
            font-size: 0.8em;
            margin-top: 2px;
        }
        
        .lead-track-record {
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .lead-track-record.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .lead-track-record.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .lead-track-record.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .track-score {
            font-size: 1.3em;
            font-weight: 700;
        }
        
        .track-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .lead-section-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin: 16px 0 8px;
            font-weight: 600;
        }
        
        .lead-background p {
            color: var(--gray-700);
            font-size: 0.9em;
            line-height: 1.5;
            margin: 0;
        }
        
        .cv-timeline {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .cv-item {
            display: grid;
            grid-template-columns: 90px 1fr auto;
            gap: 10px;
            font-size: 0.85em;
            padding: 6px 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .cv-item:last-child {
            border-bottom: none;
        }
        
        .cv-year {
            color: var(--gray-500);
            font-size: 0.85em;
        }
        
        .cv-role {
            color: var(--gray-800);
            font-weight: 500;
        }
        
        .cv-detail {
            color: var(--gray-500);
            text-align: right;
        }
        
        .past-projects-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .past-project {
            display: grid;
            grid-template-columns: 24px 1fr auto auto;
            gap: 8px;
            align-items: center;
            padding: 8px 10px;
            background: white;
            border-radius: 8px;
            font-size: 0.85em;
        }
        
        .past-project.success {
            border-left: 3px solid var(--success);
        }
        
        .past-project.failure {
            border-left: 3px solid var(--danger);
        }
        
        .past-project.partial {
            border-left: 3px solid var(--warning);
        }
        
        .past-project-icon {
            font-size: 1.1em;
        }
        
        .past-project.success .past-project-icon { color: var(--success); }
        .past-project.failure .past-project-icon { color: var(--danger); }
        .past-project.partial .past-project-icon { color: var(--warning); }
        
        .past-project-name {
            font-weight: 500;
            color: var(--gray-800);
        }
        
        .past-project-year {
            color: var(--gray-400);
            font-size: 0.9em;
        }
        
        .past-project-note {
            color: var(--gray-500);
            font-size: 0.85em;
            text-align: right;
        }
        
        .lead-style {
            color: var(--gray-700);
            font-size: 0.9em;
            font-style: italic;
            margin: 0 0 12px;
            line-height: 1.5;
        }
        
        .lead-traits {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .traits-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .traits-label {
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--gray-500);
            margin-bottom: 4px;
        }
        
        .traits-column.strengths .trait {
            color: var(--success);
        }
        
        .traits-column.weaknesses .trait {
            color: var(--warning);
        }
        
        .trait {
            font-size: 0.85em;
        }
        
        .lead-disclaimer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-200);
            font-size: 0.75em;
            color: var(--gray-400);
        }
        
        /* Lead toggle button */
        .lead-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--primary-lighter);
            color: var(--primary);
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .lead-toggle-btn:hover {
            background: var(--primary-pale);
        }
        
        /* Lead CV Modal Styles */
        .lead-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            padding: 20px;
            animation: eventFadeIn 0.3s ease-out;
        }
        
        .lead-modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: eventSlideIn 0.4s ease-out;
        }
        
        .lead-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 10;
            color: var(--gray-600);
        }
        
        .lead-modal-close:hover {
            background: var(--gray-100);
        }
        
        .lead-modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 20px 20px 0 0;
        }
        
        .lead-modal-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5em;
            color: white;
            flex-shrink: 0;
        }
        
        .lead-modal-title {
            flex: 1;
        }
        
        .lead-modal-title h2 {
            color: white;
            margin: 0 0 5px;
            font-size: 1.4em;
        }
        
        .lead-modal-title p {
            color: rgba(255,255,255,0.8);
            margin: 0;
            font-size: 0.95em;
        }
        
        .lead-modal-score {
            text-align: center;
            padding: 10px 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
        }
        
        .lead-modal-score .score-value {
            font-size: 1.8em;
            font-weight: 700;
            color: white;
        }
        
        .lead-modal-score .score-label {
            font-size: 0.7em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.8);
            letter-spacing: 0.5px;
        }
        
        .lead-modal-body {
            padding: 25px;
        }
        
        .lead-modal-section {
            margin-bottom: 20px;
        }
        
        .lead-modal-section:last-child {
            margin-bottom: 0;
        }
        
        .lead-modal-section-title {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Compact lead card for inline display */
        /* Lead Link - Minimal clickable row */
        .lead-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
        }
        
        .lead-link:hover {
            background: var(--primary-lighter);
            border-color: var(--primary-light);
        }
        
        .lead-link-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.7em;
        }
        
        .lead-link-name {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .lead-link-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .lead-link-badge.success {
            background: var(--success-light);
            color: var(--success);
        }
        
        .lead-link-badge.warning {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .lead-link-badge.danger {
            background: var(--danger-light);
            color: var(--danger);
        }
        
        .lead-link-cta {
            color: var(--primary);
            font-weight: 500;
        }
        
        .lead-link:hover .lead-link-cta {
            text-decoration: underline;
        }
        /* Sound Toggle Button */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .sound-toggle:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .sound-toggle {
                width: 44px;
                height: 44px;
                font-size: 1.3em;
                bottom: 15px;
                right: 15px;
            }
        }
    
    /* --- Innovation cue badges (Tech Novelty / Market Newness) --- */
    .cue-row { display:flex; gap:8px; flex-wrap:wrap; margin: 8px 0 4px; }
    .cue-badge {
        display:inline-flex; align-items:center; gap:6px;
        padding: 4px 10px; border-radius: 999px;
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        font-size: 0.78em; font-weight: 650;
        color: var(--gray-700);
        cursor: help;
        white-space: nowrap;
    }
    .cue-badge strong { font-weight: 750; }
    .cue-badge.tech { background: rgba(79, 70, 229, 0.10); border-color: rgba(79, 70, 229, 0.22); color: #312E81; }
    .cue-badge.market { background: rgba(16, 185, 129, 0.10); border-color: rgba(16, 185, 129, 0.22); color: #064E3B; }
    
    .cue-help-btn{
        width: 22px; height: 22px;
        border-radius: 999px;
        border: 1px solid var(--gray-300);
        background: var(--white);
        color: var(--gray-600);
        font-weight: 800;
        font-size: 0.85em;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-left: 4px;
    }
    .cue-help-btn:hover{ background: var(--gray-100); color: var(--gray-700); }

    .cue-detail {
        font-size: 0.9em;
        color: var(--gray-700);
        line-height: 1.35;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 12px;
        padding: 10px 12px;
        margin-top: 8px;
    }
    .cue-detail ul { margin: 6px 0 0 18px; }
    .cue-detail li { margin: 4px 0; }


        /* Year 2 quick triage controls */
        .triage-controls{display:flex;flex-direction:column;gap:10px;margin:12px 0;}
        .triage-btn{display:flex;align-items:center;gap:10px;justify-content:flex-start;padding:10px 12px;border-radius:12px;border:1px solid var(--gray-200);background:#fff;cursor:pointer;text-align:left;transition:all .15s ease;}
        .triage-btn:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.06);}
        .triage-btn.active{border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,.18);}
        .triage-icon{font-size:18px;width:22px;text-align:center;}
        .triage-label{font-weight:700;}
        .triage-help{font-size:.85em;color:var(--gray-600);}
        .triage-status{font-size:.9em;color:var(--gray-700);margin-top:6px;}
</style>
</head>
<body>
    <!-- Sound Toggle Button -->
    <button id="sound-toggle-btn" class="sound-toggle" onclick="SoundManager.toggle()" title="Mute sounds">🔊</button>
    
    <div class="container">
        
        <!-- PHASE: LANDING -->
        <div id="phase-landing" class="phase-content landing-page">
            <div class="landing-hero">
                <div class="landing-badge">INTERACTIVE BUSINESS SIMULATION</div>
                <h1 class="landing-title">Build, Bin, Boost</h1>
                <p style="font-size: 1.5em; color: var(--primary); margin-bottom: 20px; font-weight: 500;">The R&D Portfolio Simulation</p>
                <p class="landing-subtitle">
                    You've just been promoted to Head of R&D at a fast-growing Indian tech company. 
                    Your mission: build an innovation portfolio that will shape the company's future. 
                    But with limited budget and competing priorities, every decision matters.
                </p>
            </div>
            
            <div class="landing-features">
                <div class="feature-card">
                    <div class="feature-icon">🎭</div>
                    <h3>Step Into the Role</h3>
                    <p>Take charge of an R&D portfolio with ongoing projects and fresh opportunities. Shape the future with the hand you're dealt.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚖️</div>
                    <h3>Assess & Select</h3>
                    <p>Design your evaluation process. Choose your criteria. Assemble a committee. Review proposals and decide which projects deserve funding—and which don't.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3>Live with the Consequences</h3>
                    <p>Projects succeed, fail, or surprise you. Navigate corporate events, manage your team, and adapt your strategy.</p>
                </div>
            </div>
            
            <div class="landing-cta">
                <button class="btn btn-gold btn-large" onclick="showPhase('briefing')">Take the Assignment →</button>
                <button class="btn btn-secondary" onclick="showTutorialModal()" style="margin-left: 15px;">📖 How to Play</button>
            </div>
            
            <div class="landing-meta">
                <span>⏱️ 20-30 minutes</span>
                <span>📱 Works on any device</span>
            </div>
            
            <div class="landing-credits">
                <p>Created by Ammon Salter, Warwick Business School</p>
                <p style="font-size: 0.8em; color: var(--gray-400);">Developed with assistance from Claude (Anthropic), GPT-5 (OpenAI) &amp; Gemini (Google)</p>
                <p class="license-text">
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">
                        <img src="https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png" alt="CC BY-NC-SA 4.0" style="height: 20px; vertical-align: middle;">
                    </a>
                    Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a>
                </p>
                <button class="credits-btn" onclick="openCreditsModal()">📄 Full Credits & License</button>
            </div>
        </div>
        
        <!-- PHASE: BRIEFING -->
        <div id="phase-briefing" class="phase-content hidden">
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="company-logo">🛡️ ShieldTech India</div>
                <h1 style="margin-bottom: 10px;">You've Been Promoted</h1>
                <p style="color: var(--gray-600); font-size: 1.1em;">Head of R&D, effective immediately</p>
            </div>
            
            <!-- Company History box (simple in-game version) -->
            <div onclick="document.getElementById('history-modal').classList.remove('hidden'); MobileScrollLock.lock();" 
                 style="background: var(--primary-lighter); border: 2px solid var(--primary); border-radius: 12px; padding: 15px 20px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s;"
                 onmouseover="this.style.background='var(--primary)'; this.style.color='white';"
                 onmouseout="this.style.background='var(--primary-lighter)'; this.style.color='inherit';">
                <div style="font-size: 2em;">📖</div>
                <div>
                    <strong style="font-size: 1.05em;">ShieldTech's History</strong>
                    <p style="margin: 3px 0 0; opacity: 0.8; font-size: 0.95em;">From Bangalore startup to India's #3 security company</p>
                </div>
                <div style="margin-left: auto; font-size: 1.2em;">→</div>
            </div>
            
            <!-- Full Case Study PDF Download -->
            <a href="data:application/pdf;base64,JVBERi0xLjQKJZOMi54gUmVwb3J0TGFiIEdlbmVyYXRlZCBQREYgZG9jdW1lbnQgaHR0cDovL3d3dy5yZXBvcnRsYWIuY29tCjEgMCBvYmoKPDwKL0YxIDIgMCBSIC9GMiAzIDAgUiAvRjMgNCAwIFIgL0Y0IDUgMCBSIC9GNSA2IDAgUiAvRjYgNyAwIFIKPj4KZW5kb2JqCjIgMCBvYmoKPDwKL0Jhc2VGb250IC9IZWx2ZXRpY2EgL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcgL05hbWUgL0YxIC9TdWJ0eXBlIC9UeXBlMSAvVHlwZSAvRm9udAo+PgplbmRvYmoKMyAwIG9iago8PAovQmFzZUZvbnQgL0hlbHZldGljYS1Cb2xkIC9FbmNvZGluZyAvV2luQW5zaUVuY29kaW5nIC9OYW1lIC9GMiAvU3VidHlwZSAvVHlwZTEgL1R5cGUgL0ZvbnQKPj4KZW5kb2JqCjQgMCBvYmoKPDwKL0Jhc2VGb250IC9UaW1lcy1JdGFsaWMgL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcgL05hbWUgL0YzIC9TdWJ0eXBlIC9UeXBlMSAvVHlwZSAvRm9udAo+PgplbmRvYmoKNSAwIG9iago8PAovQmFzZUZvbnQgL1RpbWVzLUJvbGQgL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcgL05hbWUgL0Y0IC9TdWJ0eXBlIC9UeXBlMSAvVHlwZSAvRm9udAo+PgplbmRvYmoKNiAwIG9iago8PAovQmFzZUZvbnQgL1phcGZEaW5nYmF0cyAvTmFtZSAvRjUgL1N1YnR5cGUgL1R5cGUxIC9UeXBlIC9Gb250Cj4+CmVuZG9iago3IDAgb2JqCjw8Ci9CYXNlRm9udCAvSGVsdmV0aWNhLU9ibGlxdWUgL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcgL05hbWUgL0Y2IC9TdWJ0eXBlIC9UeXBlMSAvVHlwZSAvRm9udAo+PgplbmRvYmoKOCAwIG9iago8PAovQ29udGVudHMgMTcgMCBSIC9NZWRpYUJveCBbIDAgMCA2MTIgNzkyIF0gL1BhcmVudCAxNiAwIFIgL1Jlc291cmNlcyA8PAovRm9udCAxIDAgUiAvUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PiAvUm90YXRlIDAgL1RyYW5zIDw8Cgo+PiAKICAvVHlwZSAvUGFnZQo+PgplbmRvYmoKOSAwIG9iago8PAovQ29udGVudHMgMTggMCBSIC9NZWRpYUJveCBbIDAgMCA2MTIgNzkyIF0gL1BhcmVudCAxNiAwIFIgL1Jlc291cmNlcyA8PAovRm9udCAxIDAgUiAvUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PiAvUm90YXRlIDAgL1RyYW5zIDw8Cgo+PiAKICAvVHlwZSAvUGFnZQo+PgplbmRvYmoKMTAgMCBvYmoKPDwKL0NvbnRlbnRzIDE5IDAgUiAvTWVkaWFCb3ggWyAwIDAgNjEyIDc5MiBdIC9QYXJlbnQgMTYgMCBSIC9SZXNvdXJjZXMgPDwKL0ZvbnQgMSAwIFIgL1Byb2NTZXQgWyAvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJIF0KPj4gL1JvdGF0ZSAwIC9UcmFucyA8PAoKPj4gCiAgL1R5cGUgL1BhZ2UKPj4KZW5kb2JqCjExIDAgb2JqCjw8Ci9Db250ZW50cyAyMCAwIFIgL01lZGlhQm94IFsgMCAwIDYxMiA3OTIgXSAvUGFyZW50IDE2IDAgUiAvUmVzb3VyY2VzIDw8Ci9Gb250IDEgMCBSIC9Qcm9jU2V0IFsgL1BERiAvVGV4dCAvSW1hZ2VCIC9JbWFnZUMgL0ltYWdlSSBdCj4+IC9Sb3RhdGUgMCAvVHJhbnMgPDwKCj4+IAogIC9UeXBlIC9QYWdlCj4+CmVuZG9iagoxMiAwIG9iago8PAovQ29udGVudHMgMjEgMCBSIC9NZWRpYUJveCBbIDAgMCA2MTIgNzkyIF0gL1BhcmVudCAxNiAwIFIgL1Jlc291cmNlcyA8PAovRm9udCAxIDAgUiAvUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PiAvUm90YXRlIDAgL1RyYW5zIDw8Cgo+PiAKICAvVHlwZSAvUGFnZQo+PgplbmRvYmoKMTMgMCBvYmoKPDwKL0NvbnRlbnRzIDIyIDAgUiAvTWVkaWFCb3ggWyAwIDAgNjEyIDc5MiBdIC9QYXJlbnQgMTYgMCBSIC9SZXNvdXJjZXMgPDwKL0ZvbnQgMSAwIFIgL1Byb2NTZXQgWyAvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJIF0KPj4gL1JvdGF0ZSAwIC9UcmFucyA8PAoKPj4gCiAgL1R5cGUgL1BhZ2UKPj4KZW5kb2JqCjE0IDAgb2JqCjw8Ci9QYWdlTW9kZSAvVXNlTm9uZSAvUGFnZXMgMTYgMCBSIC9UeXBlIC9DYXRhbG9nCj4+CmVuZG9iagoxNSAwIG9iago8PAovQXV0aG9yIChcKGFub255bW91c1wpKSAvQ3JlYXRpb25EYXRlIChEOjIwMjUxMjI2MDkwMTE5KzAwJzAwJykgL0NyZWF0b3IgKFwodW5zcGVjaWZpZWRcKSkgL0tleXdvcmRzICgpIC9Nb2REYXRlIChEOjIwMjUxMjI2MDkwMTE5KzAwJzAwJykgL1Byb2R1Y2VyIChSZXBvcnRMYWIgUERGIExpYnJhcnkgLSB3d3cucmVwb3J0bGFiLmNvbSkgCiAgL1N1YmplY3QgKFwodW5zcGVjaWZpZWRcKSkgL1RpdGxlIChcKGFub255bW91c1wpKSAvVHJhcHBlZCAvRmFsc2UKPj4KZW5kb2JqCjE2IDAgb2JqCjw8Ci9Db3VudCA2IC9LaWRzIFsgOCAwIFIgOSAwIFIgMTAgMCBSIDExIDAgUiAxMiAwIFIgMTMgMCBSIF0gL1R5cGUgL1BhZ2VzCj4+CmVuZG9iagoxNyAwIG9iago8PAovRmlsdGVyIFsgL0FTQ0lJODVEZWNvZGUgL0ZsYXRlRGVjb2RlIF0gL0xlbmd0aCAyNTI0Cj4+CnN0cmVhbQpHYXRtPD8kImMxJ24rRTNcRHU3IzhrMm9ROHNcUTEuRVRUQVNpNT5IVU0yJjJIJUFPYEtGSXU8IShwZ1BJRXInZzhXRk9uZ0dZV3BATCs3SWEjVzwoLiZAJjJDJkMmck07R0F1b2hBJW03XVZeI2ZqbVJRNUxZRDxNb1FXSl5ONiFuLDNAJ09fc1ZYSCFeJ0BaUTp0b2diR3EzZGooRGBWQTZAcCUsckVgQGYzKC80YWFDTmZZLSxtS0MlU0ImO0FVak89Ki8zYi0vUiJLUDRcJmo+MkBaa3BIU1k+cmI+XmVYXUNiRT0kZ1w6ZWhWXWFxPygiRVNWQSFdTDddaTVjRUZQZkVAKVo8Zyc5UjQzbHIvXGZlZlBJMiNcWjIyZE9ZMkBZakpAcmlnUlMwYTBRZCQ+JWQmLzhecDQjVWNVWU5gdDBzRWBQZ0dTcG5bI1pLNHBuNmJGZFZdTlRKNUlRckdFbjU3PUdhOGMhSjhubF4yTSktI1RJJFFGcFA0IywmWydtQ2MmWj9IVSo6MVx1VTwvJVtjbkJRNDQlVm9hSmw+ZHBZaHRwT2VwPzJkV3Rdazc0TiNxQylFRz5mUyZEQjU2a1wrQ0txKjkvY1xATmtuT0hybUNkQi8+RkZzS0VjJT87PU0tPzkkXiZSU2cwbXNGZ0Y2P245MDhLLmtBKmRxKFFYKSJCWEJYQTFGTXNSRFVkPztYWktDTEZkbzI/c2MyIksuYVd0IyRvRCp1PV09b2ovP3A0QHViMF1BJ2NxISZWPGdJOiZrQlhmNiUnP1k7YnBiJUFKUjVHZnFCc0UuKj07O1FFU0ledTpnUnJyPGdnYDJmXCNFR1xdQ0liRV9pLVdVRHFiQyprNFkqbWozMDwoRkdJaz0jJFNWWlhjRUxTWW5laGRHaCs6UURAXGNKWyYzWicuUTNuIUIoMzVbOTM7dUQ8VUA9LkFNSl0hSi8qYTBxdGM+OWVEOl5pN0JuaDpFZUktcUc8bzhHbVEjXmxQUmZWcENGMW5mSS5WWjk+NlI4LnVRdWBNKiE0bTYtPThTNXRfYEVoalEuckRcNS1yO3R1QFI+U0pJU2ZcZVEtKGElVmYtNEgjclBWST4jSF1MZDhgMT49K1prSWJEKi01PiZBNU4uXlhwK0M3Lm0kJWFTQVdNOUhAPm9HQmdnblJpO3JHPys5YmJBKDMlY3UiXS0vOEFIND0oRD81PjZHXTZsPSc/NmVoMi0mVDMmXGUpdS0tR2whMkZsR3FnRkFrZUk3KyI/NSVWJ287LXVnWDlHPUZrTC5bcj1ZN1FBJEtWbEFZSkFNOjknVnFaRlRnOnJZXEloWVgiVmwnKSs8ZV0qT1tWLlAuZmticz9lWDI0ZFNALi9kVXBmdHFoOFUtNT1PRlZQTGJRSDIrZikxRidSKTpJZilUMWhbLlAsIVRLPm5McDkjWilAK1kmKVNHXkw7a1tZcSwrNWpdXyhdRnQ+OiRtVHBHRTJgNVNXQWRSYD1OVGlFR1g4QUxpSSVvOjVaVDI2ZzQ5W0dJc21RUHVBV0UtSjRhZFoxa2tAYTNcbDIyUmlLYUsqQDpaQi5GImIjNz1cJ0QwUzg1SGsxMiVyaCZMNlg3Yj1pcU9XX19mQ2JoZzNPOylTOEN0VXFxbmRVNFcjUD85MFhyaEVJNyxUbChVQ1hfUiI5a1RMaDE/MExrbSFGTG1pJzQpcU1pMG9cXzFgWTM5WGIiUVI8azZLcmcxTEpLMCVxJyRBUl9gVTNvPDVAQyMqTlRVKytWN1ZHZkhCaTIhNS8kXSkwTG9UPjFMMUwjcHQ2cGE3bUYlXWI2OURrXGRiV2w3PT8jczA0VjhKOS5mcjo/ckZrbCRHVzYrYVRVQjBnbzQmaWFSOmZqcSNxVFFwcS9HajJYVypfUnE+R3U3MkImWEJLW1IjREpyaFosdEMsN0tAU1RqZyVMSUxoPUZuNCNaJ0RucUFLLklFMVYjTE8kJUxaRyIuZjo/QyNfRUddOydYaCUzS1JQP0pAaj91ckpWMzEmO2xvaUgjP2dxazxGWyJOLUxQOWJbKjlhYmI0cmQ1RzxWJUpySy4uITEzTkg+cWEiVSVzKS9SaGJAckxcTzUoYlEuNC8sMz1jXFwlTiRDQGcjb21RaVhKSyxXayVbbTFMYlJHdFQtbVl0NUBtIUxDPlNRJUppbzxuO0U1Zyc7cURocFtQOlFPJ0cmVVk3bEdObiw7MC5WKmxJKmxMQ3BJZU4sSVw5ayUsWlIyXGRhQEVjL283QyosdGU3ZEE5bj9QcTY2R3NISz0mTE9fK1dAaV84TEBbXVo3MSY/N1w2SWtVbnE5Mk5pcVVgTiowSHRJO3Q6XnBJP2NMamQ8cnEkW0RKOzs9LDBPPDcwQT1iXFRPUiRDP2ViLkZFYXNnaSRpaDNsPC9UOE5TJWgqR3NCUEtudClzVmEobz9eL0lLVFU3bjI7UDFxRHFtYzhOYkJPPG9ZQ14obyFhaTkvLWZoUy5zRkcvJmxeQEBXciVAWmM+IV1GMXROb0dSJ2UzY2ZCZD1KOkBIOTY6QF8sPWI7UDNxPnAlRnBEWVdDQCg3azEhNUtdSF0tT1YjK3UtOmEmSVRNajIzPUNALW0nWjVySCZmcSVqSVQ+WGplVTVbMVpza05cSGZaaT5mUnM1YE1WcHVRRC1hLlFKSE90V0toPWBSaWplKjY1NmtpY2xKajk2KUQqdWJVZGw7VUhgOlQjOkg9K2BOTWs3MWdLaEdMWUBBKG5kWF8iX20hJXEla1JDQz5wRVI5Vl5MIl4uUyohRTlUST5jY09CQjJoK1orTVxyOFJSKHVhJCI9ZCRDNFA9UEcyV1cqN2olcDIyMW5KWWBvSW0rZW1kRVklSVcoT0ZLLUNtW1FiMjMoalpRVydlVWRFLmRbLkIjNz9cPkpZJF9jRCdhUFA/U085LyIwOmM2bVFvJVdHSm5zbVAtJkpAMkozVyszLTE7XW1OPmY/N0VHXVskRygyOThPRiIyIypUNCJMLVUwbmZrO1pQIXRuJj9XYE06dSkhSCVaIztMSSRyRV4vYktFZW1tSUw8YTtkIkZkXm10PnQqYnBNTFpKWDBhYV5EL15eWmxAPFxpZTdDXSskPzBoRSZUTjxCanIqVkcwR0dyK1xSaGBDWFV1O1M0P1MhWEptJCshK20lIVQzVGA7ZTg3QlkmNEdCKkJfXVBvLnVWLVI7cllLOD88NkVFJGRpR1wsQWFxQGdMdSFsOTEtQSsqUDEqbyU2S1x1J1VbcUwnLkQhO1duQDNtQkg0LV9rMG0/Y2htIzFzNj1BPFRwZTplaVZLJStOL3NhNSxHPzsiZTBMN0FrIlgyYFhVJn4+ZW5kc3RyZWFtCmVuZG9iagoxOCAwIG9iago8PAovRmlsdGVyIFsgL0FTQ0lJODVEZWNvZGUgL0ZsYXRlRGVjb2RlIF0gL0xlbmd0aCAyMjU5Cj4+CnN0cmVhbQpHYXRtO21yUjVBJyllRTpAXSspMmpHcUhHZTUqT3FERCc1MmwqWydUQStfVSRqIkNyTU0vWV8xIltGTkpeXSopQVUrRyZWMUA8I09uXTJFIz8wbzwicCokMUZeS0xKPWUza3Irb1x0IV89XGFraUFgSTtwTWtCNVVNZUJkaGJQIUhhLkYjLlkoPzhPOVQ9T1ZOXVRzUl1fRTJuTDlBOGRNSE9QO2YySk9KWytZQUQzSEMlbWBpZjRmM28nWDlQcEhhSnNGUDkvQ2csTWxCUGszSl5MK2Nrb3AmVT4oMkJSdTg4ay8/K1AmWmY0VkEmI1pLPE8tKWRTYCVMOSskcGlbISRVMy5iXm4hZmYicVU/PjFdWytcP3NqQ09NamVYKXQ+YlJLUDRtSDdeLkdWM2JebzwhWlMlS2A4W21HYWJQYGVXQDUmUUVoKDBtI05zLDkvIiEhOytXPCFLUSE+TG4jMzE8MTAhOERvNGsqLyZYNS9qckwtKnRBXDIsUzYzI15WZEtsYSUyLUxpTCJVVmxcajJyOylLQVFRZGhCMF9VY0JqNi06KTYtXSQsNSwrN19yOShoQkhATmZwZEM9XGpxSl4tXyFCRCJBQTRDRE0sXjo5InNhWEk8RHRraiJpWVtdQ0hGO2l1U0pPIk4jI0ljZmMvb1NZMUkqbzBFTjw2blFYOTVYIiQ8bWQsMGY4Tic7akZMNkxdTkZucTUmPWRtKkYzOmQqR29lMWAuUzRSK0VHNUtmJmoqWkZqQ3BmbF1mNmdTMS8jciVJP14/LHFvXXVcRlFiYWoodCktVFViM0loVyg+TCFbUUMtOistK2c3KUpMLSJVX00rIzpMUGRITDYyW2Y4PDkoYE8vPmwjK2pSYSlGWCwrai5Wc2VDOSk8alVrXj9zU01TOEBgcTVYYGtkIUBAJ2V1Pm1LPi4+KHVKOitZIyE1SyxSRlJmblYmR004UztNP3VETlZBcUtvKElZPDxhTlA7XCU7NjddITtLYTptKyE2Llshc2IlPC1uYU4mPCFcbTZzQTFqQDVTPTtDK3EzOUdBNEpNX0RiZzRhQy1ZWltfbk9KQ3VWSEZcaWYjJmMlbzRQI0A5ITM5Jz5FMFhAJF1fZUNsP0U0My8wU2YrIVljZClzQSxeaC1uOm9yb2RZNFNeYypVZU4iVFo2YDVDLyopMWE0PExuTThNVjBnMlxiSWtPPTY6UlpFTWkzQkIySU1KbFtsb29BaGxSYD0kQVdeXjI6VzFKJk1mK2lSVWtYTUUiJ2VPVjA1bVxdVTQ3V0YqWiI+LkBmIi4tJDJLNlZQNSJnZlBKLmpJQFoxVzdBNkkiOzkmMUQmVC07KWRhYGc8NjItTS9BdC0qdS48aGFeK3JRVm5gdHJmTT9kP2BVXGI1IkF1Slg8VjgpTFRoMiI/bzVsNFdKWlRQUzpPWkhzIztIQSNMWW03WE1IJ2RhWUErJSY2RkIjSWIhX05aI2tbND41XitPSEZFRypsKnIpcjw5I0lTVk5hPjxkYEwjUTtVNW09MSQyNm1xKkAuZltnXypiWFNPNktsPjUrI0g7Nl0xcSs6UEszQHFeTGM1S1xGQWhuNFdWaUIlVEsua1M9SjonLkotNV4mJDhMdDE9JD82YT4+Uk10SkFOIyRlSkNwUTdLLFw0QCNuOV9AW0tuSTc+X3NZLGtHYFBjZG1BYUtmdGxYWkY2PVRNVjVHWWJHTVorT201Q0hZSDMzNCpEWzVgcU8jMHBMJCo+YmNuR14kaUNgNl1fJlM+TFI1WTdhQ15uY0QpVFNFVTVwTDRoLEg9YGVHYXFRQ2spQCtsY1tadHQvLFA9bFNeW2piQlNkLV91KDk8XkNWLSVKJVlkLkIqVWQnZE9kOkU2cWI0MXMqJEY+TmNkbFItSkJtQ0ZOW1Y8LzU3WUMwL2FCbHIyVipKcW1RITFLI04zWmwuMi03R1QvOHAzWipfSVVwaUIhN15EcTUwWEJNR1NXXjBwLD5PZTRJU0ojWDo5OjJyTSxZYHVAWy1YXnEoPVdqWi9XKEtgRCsoKGM8TmY7Yj4uWCROM0hZP0BrbmVpXTdgUFstVVpSP189OiJVSVk6aUsqWFdfLS43Om4sZEY7MTpEJUY5TztHLGVaaDUwWD9XKCsiYk1CYCQkc1ImKWYndSUuNGNPSC1aUzdHIUFzSmhuS0crWVImLFJRanRXQj1FKUtbcmc1LUk0L2JIaWJJcC9YUF5pbWIlTGkuaXMnZkMyZEIpN2pwPCFQKz9fX2BfYV5CTyNKVGsibTg3OzQhTTxkSWsldWQrPlckJSFnMUlYLl4rTm0qVmosWDF0KyVLOXVkYmJSQikiamBmZVYxR0tIKz1YZzYwVFk0NUsuOCcsK2g5SkkvR2ZzXlApRXJMNCw5ZThZXkpvaXVHY0VOQkVQJTJFPzkxUyI/LVRdaTQ7Y2tyb2ZKPCxTZHRQXTxFcC0wPlxDX2k7TnBBI1BmXSM3Xk9sND9GVU0pLSZyNmZMPFBQKyNdSmVeYVhGZzw7YCNbPi89dSEqWUYlXjdhOUs7YCFbPjtDKEVhPyQtJVVTU2crXz4xaD1rSDhFXjpxUU9qRi1ZXV46SD4oKU0pIyFDUFNNc0NXPHJiM25DT2krUmFSKXAwXFxASmoqZ0RjUGFbNUNORic0c1FuJyQhYW5jZDNKXjgjWy82L1NYPF9icWs4dGosWkBLWW1ZNCloM21wWi9UPWRDMGEmSkMvKUZvZTQ0cjxbK29QSWMmajVzQmYmZz8jNTR0LHBuYGAqPFxVXC5UcmBtcWRVQSgmPXElS0s4JCwobWNBTzVJMmhzPlhcUGdKI1FLNThJaicvcysyUTMjP3AqdWc8MU4iK1YxP04vZl0tSSs5UWAmNFYyM2VGMXFwOWZsOz80SiY2XWJXLjFMK2JMcDI7VT5TQlpKPj9oNUJcREEiMUtMXmlMJ3UmOWVyRUEnQmhVXWdVJHE+VD1GSixNa1VBLTBYJV4hRzgjTWUsfj5lbmRzdHJlYW0KZW5kb2JqCjE5IDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDI0ODIKPj4Kc3RyZWFtCkdhdUhMZ1FMPSImcSdGVDlWbWFfcTM0bnFXUz1UU2pLLmIobHI5IklhKmlNMExkW08zQk51ZjU/XzhCKWVBWTpMOHViV1k8RWdzW191TVNWNGwrN29OKXBlcCgrbXFDOTckUnFVRmA+KVJeMjBrOSQ7R05CKTFOOlBBSiFTNSxRO0RNVCw/IVgwXVxKZmUiZFs0TXNyV0oiJ0BwanVwYFNBTGVcWyw/aVpdP04hLDJqTWokbS8jLUg2VVpKWy5AVSknaHBTK1VPUUlKSDZbRixkPTgpPVU/ZiNHL3JJXFRNTGE5QjI8V2JJLD0sZCIxX1c+IVJWTj9nIl5AblUubSU+aHNeWlBbNks/US9ebjkmWmI2PzU9TjA4PzpcPWAyQjkwRlAoXXNdWzB1QUwtRVAyIyUsLG84UDNvc288JE42S0ooQikjNjBfWzlwKHRHaUg6SFpxPkJxLixcU3MtP1EubmA3PVB1O2RyUVYkMm0nSElbUSNacT1Ua2YnTm5ocCpmY2pFUm1cZEZZUG5kV1I8ciYxYmVxZDQtRWlsUjtDLTU4NGRKZiFdK1pZP19FN3RaSkchW18/IXNwTW5BIjk/W29OTmIlRmsxWTg4TUJGajcjLHViKClDcG85U2Anc0lBTzBFXTpQVUFUJGZFbDsqTVA2WlQ0JC1lJj9RVExITSppLz5hc0ZDV1p0KUYmKFRNVVpeQjNXaDxfIzEuVkQ7cDBqJkRvQj9fYGJURUVeJFU7OSVsZnIjMVc2V0ZlYWVpPWNVQWkwW2IyQUZeJFhETTY8PFNPXFFGJk9OPVsmQFg0LlpubDc7NCJmOi5RQ3UpdERgVS8xWTRLK09TNUIlWCJgUCYuYWpgbGpnN1hWRDFNLSNMST1JRilnNT5bLCIqQDA5ZSlYJjAnT19MLmJZdExXP1VNQksiVG1CcDwwOidTZjAySShadFtFbEc/K0BlLDpIL0luJmcsJ1ZoPjcqYSo3JiUoMVxxTCUrTFo0WGQ5Q0MpLHNRZWlZTUo6M1pSaEZXSSlYJlhCMllnXjJkVE1pPkdPI0VRLFpoNmFdN0Q5WSNgZiJaJWhwSEk7Sy0pcWAmKyl1ZitqU0tiTUxOOz4wVmlXQFkhY2QkKjdCNmVbSD1ZMW0sLjhOLl45V0pPSC1pLEdaWS4iR1FyXmIhRVBMJjFGI24nVjM6KUteVzhDUy9KWmo6PEZlSkZCSlgtPz8mc151LTM1NT4kNTY1c0w9J2kyUGZ0JjhEUFJhdCclZ0BmKFluWjpXVipGX0BIaDhtT0ddPSokPmdsT24iJj8xLUJmOGczOD82WiNgRVk2X1tpKUdYKUNvIlFhQD42VTBMZThdJF1jdVs/UDY1TiYiQzFpUmpdQGwuNGN1Jzw6cCxrJFg2KidbMFYzQ2RiIi0tZ2FDXjE3cy8zNVxoaCUuPnBcIT9jRERTNTYiXShiPlYsZD5rQCtsXG48QD1vLDNQL3JIN2R0cjwzKTJKQSdja1s4WzJhVXVjNk02JUdwPjZsXWYpLjlmUiIoPzpPLlliLXRhcy8qVXVNb1tNKGtYVj5YQCMrQSwnVF5zYUxcLWVIakNPa0FAOSFWPCVnZDYrclIjb0hjQ25CXm9NVmdDZFBBP0lbQkxMWmkldFtGRk5kNixbVTxEbGpHZFombmpLQExUNDo1Xkg+bzc6Tj1yOkhARCcjTS9IS0FiWywkOTpPITBiLVBlbEdMcXJuKkxyPl1JK1wtcHNFaiI0IStiMXE2SiNQbEllNCwvcW88Qj4vSEE4XUYlTVtvWE5FRk5lM2lNdTo2KlVZRV0objxMbyQ/SVs1VTVdOmZwcTE6KWxTTFwrOWBIYmJyPWNQKUBYTVJOZkpqckcnXzdlUD5AMWAjLTFwLVFMP21jRWJmRlgzJHQxWWMvW0Btbi80RFVZMUlzSlhHNm9QSWg5P14mL2RdSGs1ZFBeJEdjN3NzJkpfN2o+J1tBTmJSLm01RyEyYnFlVFdZVls7LTVtZiMwKUVVKzw+MShiNyI+ZD9qcEhpKEhwdWRUWztUMU1USWAvZ0QxNV0jOXJCTC91NTFjYGkpImo3RUBdTE4jRVNLX043bjdHUy1wUmJeLz1vUFolZUUkWkkwTkg5RCxeNnN0USZyVSIqKzVGOzdWJlE9VGVYLikpa0ZRRVlGUGhVND1pVCVGWFYtQmkzJnAtUFBzTTluKUZgaVIuYSJFOz8lLyRTSFtcKHBOZV84KDxXZmVuaEo1aDdSaEheUyRKPjg3cyMwcz8qUGpHYl1OKk8uYmN1OT1mPnEzLF0oVnAqKEpkKisuTE5FPiZua1c8Y2BMM2AoNGE2SzFvY150TyJZQGtKU2NYQl9IJygmXzc1SjBfSmA3O044YF1fKmhxWWc2S2wsWWk2PytIQmxiXWc5ITRSMkpXXyY+I1BFbF4/PjBNcWhBbVYwZ11GU1pQSHMmPVI9WWcqKSYtLlUtcCUzbStjQi1oL3VudTZhJUtNTSNWSjxwTVQ7SjRsOmhCQSJgVS1FZDtYUE9vRjdQRj1yI1s8XC1VKjQuUyQ7Ll9Ocko/ZDcsXyloc1M6WmdxWmEnLGBfVWRPcmpNJzc4XklLKTtGMTFvbVk/PkNpKkZvSUMoKyptKz1zTTFCb1NsN1hYS1tLQ0MxXy0+O2BMOGl0YGleNGc4cFtDWmUxQ2pzTE83UVpfMGBtSzlAMStbRGhTbmArOTplWSZfcS5lOjUiOSE5U0VZP2dRJEM4cjVSQCghK15pak9OaUJyUVhXR0llYm9lZUZjPl8kUiJnUFFnOktBNVVTUEhCQio8aXB0QTNGU0NmNEJ1ZWA5WkooVlNYYEQyUy9fMFM4ZVwqJGl0MEg4JHByMGBgTFcvS2dzSGomZk4lYyRBX11EX09JXDRAcl1FOEkjSXBkUURWbk5oWDhrZCJqdXBjL2M5JmI8U2hHbUJUOGozbzdSb1dOclxHRWokVFdxLUppbTc7ZUlWXldqTm5LOjktRHJiP1A8KFQ5L0trWEYhTnNkLzNKc1soLTUhQCZRQksiQE9uKllVSzdSZGZJO3RsKEY2XzhCaVpwOy5nNGNvcTM/ZWgvXCNlcEVWbEBrcDgiJ0pDSlhqaiYuIWBHJydrTUVcVDJdUmA1WzhEMVRUQ2hGdFlAaTsvUlFyZ2UzZ0M1YTNRamxqLCxLRU8yIV1WajpkTVI0WV1tJjw/aC1BTnUmYzhBPGVMcEQpXXNnaGg3S21JXFIzNyRMOWVGJ1BdaFFPQzhMMXE4JnVLL2pHIyFmNEdjNkQqXG42ci83OjFKa3FSfj5lbmRzdHJlYW0KZW5kb2JqCjIwIDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDE0MTYKPj4Kc3RyZWFtCkdhdG06PyNTSVUnUmU8MlwxXyghK2EjQldaJlNIaz44c1lXWiI4YyEjNSFWOFhzR3Q/V0tOSmRwWGYuRWIjWnMvbj89I0g/bXVNMDVMKTpgPz1sJTJQR1IwTC1NaS1WWTpoXVNgakFpRjJBbzgnblZRKlU6OzM8MV06SUNfYypCPmZAaCQmVmg+ayI4MyRKVGpNMzQvQlY4bm9aPUIldCQ+N09MbDkwMUVRWy5vNjRlKHIkW1ZVQmF0Pk1QaGw6dWdASmM9PE8yVytnWm5xPUFobjttckBBRC5LblA8Zz9AYGlnUUNeUjlFaCFobCxvcmZpbjsnZEpual5MQ0MnTz5tQTF0Um5ZN2QpSjdJR0NkK1FPcGNMWDFTS20sOVBGRy1hWTptcVxBSTRkOFVjSjNLTFpsQ3JRKF1dQyxDOkFpSENbNSVcKTQ4QmdBbyVFTUphb2dWSEBlRFNIY1ojWHAuLCpIVjRoRlExS00tcTBRR1MxNF1NYCplPzJcXnRwJmpsaTxnQCZZNHVEYTdfTl9jMVhQY3BSSFpdYF9hTF4lVV89b1klZjtZLC84Q2ltVCEmI1YnPDtvbDVLUURRPCRUcy9oImQ5W2A0Ki5VYS1saiUyPlpVNUtPOnRDSlRwZWVvSiNrRFFtcjhPcztPckoyIUpxJmQuUy5BT3U5VDJqdW5jNSlSXnAjJ3RrKz4nWWlhY2JbIlFrPExeZlsyPUsqQ01eSWtuJlJBR288R1xhQyg8YlFGdGpyTihxPFo6XFQxLyQ9dDVhMmhQXkchQ0UociFRSEQ+Lz1cPm1LRzY0NUFcYFhsOFRvPSsyO1k4K2RVbi1yQ0lESz9ZMC06MishV2s+ZmtkPCRIb2FqP2s1X1UhZS9RUmo7SnVRZypVOmVZOU8/UWJSJVAkLDpvJjM4dVVTY0ApaWZEQTJaSXVEbmEtdG9aP0Y7KCxmJltgLFdIbmxgPzJHXm9PL0ZXOHBlQCovYzpKbVo+KEo7WyRtNi05bDVwQzAmXGpITTw8RnIsY3I2IT5WJGIoaigoIU9HKDVpSmJvV1x0ZGpyV3A6XTU+Mk1NYiwrZi5qLFUrXTFMOVUhRW9uJjpZXG5pUT9mPWwjKWdpQ0xOTV9XTilHOylBSUI1bzg9RSw8NEZoYkYlKU5gaDY1UVg2KCNbZlVAOWxvKWokImdNbjleWixeXkxQa1hcUyNCUVk8dVFHdFNPUlNiaT4ubTQkM1IwPUJAV19FL09fakMzNCUoTG0mZWxmKSonZ0pnSmoqKls/UjkmUlU+OSdaWVJjcThtblRqIWIhYDljM0BGWU9XVTNgUV9pbC5tW2VsI1oqUjBDVmQwcCM5PElLPmxsNj8jbl5aMG0nUWoyLyslPlYvRE9SJEQkQmk/b2ovXjpwbSUzXjtWKyhFSDY6VDQ6QUJfJDc1XVpVU3BxbEk8KWJpSWlXRS4/MSZZQ0B1OyMtK2pgXiEkTjRAal5hWDBWLnFwQTpydGhmVF1gLidbPVtHJFMpbjUpZScwTCJHLDNgOGwmJ1NLPjFocyFhV1tzJW0oLi9FUCNuLHQhWFoiLXFBQnM/Qz5LbF0jbDBJV19qa3JWZHE3R240ZVQoSSNUS2hNM0EqJnEjSVFzclJaLSdbZVs7UXBTQF5XZXIoZ1xjOFgjdFFXa2IwXl5LK0ZVZmhfZCRaY0Yoa3NJISo6VVMzO2tBNztSUDxsOFUrLFA4RC10U0lXMkokc0hZX2ozbUZmOjJDciRqJyVlcE1sOmkyTDkkQyIzaWgkbGRIYjx1Ll5OMzIvO2JLMHA6JW10K0RgJWNQa19WdUgtZDAjMS09ZVMlPD0wOGJrRDloN1dLNFFYTTtscicqKUpSI1RnWXVkKWdNJ0NMN2h+PmVuZHN0cmVhbQplbmRvYmoKMjEgMCBvYmoKPDwKL0ZpbHRlciBbIC9BU0NJSTg1RGVjb2RlIC9GbGF0ZURlY29kZSBdIC9MZW5ndGggMjgzNwo+PgpzdHJlYW0KR2F0bTxnUSgjWCZxMExVJ0ZfcCIhWSVrJSdJZ2ovTWkkaFhda2JOUGQ6VFlBXVg0VydlMiZAU2twQF9CbitUZlEtQCg+TlhQalRJVHQ6aUlsWjI4aWQvaig8JC9ELmU6QSE7KD9KR1l0S1hCTjImOiJqPmhwXChWUEo8W2wlNVJXKyNvSlVZVD1mLVMjX1NNVzMoaiwlSyQ8b3BOWDMzcGtIckhRQFloQWNgJV45RFNoRztOaEZrLD5gcFY/SlE7WmVZZC4zM19eW2JbJm5UL1xXNElhc3M+b1ohOnE8WW4ia1xUdGcjMmZCSC9OcGtXb0cyWTRoVSEnX3FYXEAnP2UsYCQzcEdxbS8+SnN1cFFUOkRiM1ZNZDxVVCdvVmUhNUJiJm1CYS0yQ1E8PE4tSWs4c25oaSlqMFA6UWhhNWw9ckM9Vi9aazlpPEtXVExyUWs0V0MraU03Yj4pYElLXVYqYz1PWitURCxkTDFwI3IiTzQndUc3VmJqcGY8bXBoRExnNmRCJ1ExP1soOFZXXVEnciYiOmc2ZFQ4Q0QqIyQ+JEs4TXNhY1pnIWxAIy1aOmktZSZQcCNMR0dxdSkqUz5mIzpZWSo1QGVhZThtdCs/JE1sT2UnNzA/Niw8X2YncVdeT09tKk90OElSPiMsOV1qX1orRS1RRSw7MENVLGJAL2wlYUs6UiQjJjs9PUIiQiRuUD1BdTU9S0MhWXVRTT1BPVRTVDY1OklhJVEuXi5qUElzRTxjMWhORmQ9QFJdPFxHOTxoQUNrRUFiPl1tYDxIWG1xKWhpVjNOV1RObCpkb08nU0ZTR2A8dVxuP1dSMjtqbFVAPC1nTiNkUkczdUFMdCw9TzpQR1JUajN0Mz1eRSs6VlVoSytDUkEmYUswK1ZVIUIyXUBXXz42Qzk2Wio4b18oWyc9YjgsIURnMiRgWTwqLFoiLmFHUFNIYSgial0pSUNiR1MlKio/L2tWP1BRZ3M3aVJKSTgoVCVVYWIyNSUyRFc7Y2E9SEA5ajYuSilHJlZXQENxWyIiJm1NP0AwW1BpY0JwUXRJLSllQkYjZCZEPjIoPzBNInBxKk9RJyFLcEwuTzxHOCsyPDRhJm5oJGUkZTVXMFlOaTlzNFJjWCw0JEQjXTY5bDhqOlMvSGc2PkpORkhRXW42UEwoREMhMyVAPGhkKjo+LTZqVCliRzdiQW0qSE4jck4yTU1RZnMzLXJNWydCTEFmbikoPTUlOjZWPk1rQmcnVlo5KHEzJUtaXTchKVxpNzxbJylYWXIyQGA2I20pbzxdNnJsLyFbKylqP19CV2JyMWk2YTA4M25BKzFNR150KypcJkROJ3U/PC43SiNDQU86MTxrRUZFbGYpS0JRIlhfXjwlaU8xVG0nNyZyO0hjVShkQz5KbDJcRzVnPjxOIjpLdCUnM2pILDwxRDEjR00rJGw0KzkoP2c8KERObD5bRj9oYSshR19QIlVoTUFTWToyJ2NAY09zbGUhKzlnYzFsMEImWkYmW2BPI0dpci8xaExkYUJwNGFWJm08USJTT1AuUjBGLy9eM248KCEvL1MnLzlXMyI8QEdNPTdbME5mVlotbFkwPlplST9hJEFcLWVsUVBpP3U6Ylw1cTtSYzdwTSlVOUQwK0MqTCtMXUI5X082TFk/LG5rQ2FkXzk3clsnNFxrNTtoMjtnNC1dTnEqKnFdQEZYSCw1PzhtL0JgMjllLEYtdDlYYSNYLGkzMEQpTW9haWhnTD9uOyQzLlAnaT5JTF46JWBNP2EkMEdeSmdGV0JMODIjQGNjZ2t0KWRTLkxiSz11SyhNMzZtY1hMRzdoSlshTzQiPiVRLVkhLkQzLSNTJl1ITChbUjc8YVRyKTxSX1c8WWJxJ0siZFJaK05pOEA0bmQkREkzVkk6VyFZLXFoZGgySW1HOWpBN1I7ckpzWSMkUCpcb0pmPWA7Ni0qUU9eSSdkPGYpVTszUWpuOnUkbm5XNUwvSV8taSsvOjc5aytOQ2pwRWIjPC9lIm9HT0w5SzhxIylOaSQpSy0nX2lGOEYoK2h1WEFFJ2wyJzkucytALGtbaEUiTiR1VkZSKGtlPFApdXBCbi9wSVpVNWMpPG0nQEZSRE1xImNsV2NjImgiPTxgMGEoVDhnYEsyV0ZSXkBjSEIiKChwWT1bN0lCIz0iYSFeYDUiRTNxRHBrUTQvKmd0RGBlbSRpJ0lqWHQyIksyWTMhblZbQT4iLnAhVUczVyQyS0tiPi1QOFtGWUlQUUVoPVorOShEUSE1LGg0ZyVXblpgWEgqL2FsV3RtXSNlbmNsMjxuaXBETmknNC01b1cra04+MFNgXnFoTVBsSUxdZlNVRyhiSWlhJ25IJVhLNENoO0Y8ckgtZGImXnNcb3BaLE09Yz4iQTc/JT5lO0VeTFFXRT5NRjBFXWtULixbLGw/XUVDPCxgcEAxMWRNZjxiW0VmLElXYHRxKCEtQjFDZC5eNV1zMiFwQyRyWmdvXk01dS9ZMjxaRklaO2FERFJsY0YzSTpAWlJBN088ZTAlcENnNVNCWyZsK2gpYiRZV2UjSklyUVM7R2RMU0NuMEFmNl0sNk9gR2deK1o2WW9uYTlzIWllYi9ZU0dqSixsWWRvX19yYyg+bV0qNEBpRCxxRStIZjorV0JiKylkYWdlKjpAUj5oSW1rJWovNkUkKj1yM1FqYG1rL3JrakdwakUiZDphRlspKVVRWW5HPFdDOGpaS1Y1LUNFQj9ROGA8VDAmbD0qY1ByYzQ1REBHZGxwbiwpbCVvJlRSIkg6Y2FvaWMzXElLWS9IJF8kSWIxUW1VOGU9IWNbJkpgRlNaKmxiZytvc1chZCVoUTU1bWIvSTlaVitpVi86Vl5AXWVXRlQ1Q1hRWEZjZ25sLSJATjkoYCxVVCJjNCZFPD5abS1bLnRGYW40c0VXOk1wMTEzMCozX24uc0VxTFohTjstOSlCbjxWT1dbKmtzTjxzNStLYnE9b2cqTG4hZlM/YylDaTc1MyYuKGg3Xik9aTpQak0sL2w0T0lyNHUjZmZIQSVYW2c5ZCFtI1FxRDBlOzZqPGI3Mzp1QCJhUkYzMTIiXEtGJmlnc3QtOFd1L1ZBSVZDYm8tNWY1Q1huYiYpdVRwZ18hb1M1byxfKiNnQ05layk2Lz9hN0ktV2JlPDNLMyQvUToqLi5aJkUldUlvMWcjOGU1bUlmRnJaRiRoXVwqSEZvRVYkRGJsYGFzaC5WMEBIdV48Y2oxW0gqS1tdYixsUmQhLyl1JSJdOiNob21MSm9rb0VSQmp1ZHM5bCpCPUs/LkVkPHUjUj09anVoTCo7b11EV2kpRFhgM0E1aE9aSigsbTZiSl9LLSJRYy5vKjJgVD0+XEFwMFIpR0RvNDQhUXI/VCo4bkdtZzpuTzYrPGNLRk9AYzklSFRWPl1nV0hpTE9wMmNdaWJsOCYiTTVJZ3FXdUAjaFNrLGllRmVQa2BSSkpyQyNbZypBLTQ/Q3Q/NjViXkxKUUY6PWRnPldkW3QsPDROPmpvYCwtKGphIjlERD9mOygxLEdMNk44JUdJSWNrJXM2Yl8mX1xaTzlIMSUwWj9bZyQyKlAzcWwyW3RHNGRDJWZBTyZjM3JWKzE2NGZRUCM4ajQ7bWxfZ1dXKkRqVSJIWStkR1RYKkFHXmRKO0tyNExWOyFEZkZAXyE1V1RUWC5PXyhKaU8+TERUPXA1NCgvaEtGMTUoNG9mSCk6b0hMYkM1RnEyW1tDPyhHPzJhLD1rZko7VFcuRD09fj5lbmRzdHJlYW0KZW5kb2JqCjIyIDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDEyOTUKPj4Kc3RyZWFtCkdhdCUiOTY4aUklKTJVP2kzOyRXM1hTU1ptaUtxcFBCUThbW2RjJ2dlUmdBMFFLND1sQUEsYSxfMXMoTzltSmRrZkVnc1kwKjI3bjsjRSRHXWUwOyY8ajtBP0o4bltTIVhoTyFYIldzTjI+XyUrLzJFMWtMUjlDb2YzSiFKXCRIXiQ0Rmh0JCxfQmctQyZzQjYwP1U5Rk1LM0psZVRTTDJNVGpAXlVkUEMxNTg9ISNGVkxSXEslMU85aE9fTWImLyxnNSRZRV4xbCQ0REwhSnM9Xi4hLEo3OkFiXFhGVEhvVlAtYkk3TzFTKl9FRDQ0XW4/bjwsVms8TUpCZ3RHM2RZUGEobitVJCNfMkQmO0t1LCpZI1BaOm5rdUNERW9gQDBgZFtsNlI/XV41RTxlWzRPNikmNyckVC1CQUdTI3MpJE9rUG5JKi9eRVBlXitKKz5XcXA/ZCZBRTU9Omo0LFlFSmJBPmU1KDJsMCJdTWtfQyFfQkttRyE+K1pUNVBBcUtGWEpUVS5hPG00KiNSL0RRKU5dMklrIUI0LylhZzkmJS01N1lmdUMpVTtkL0FLZGJccUZoUktBUVtkKERpcmA6XjtwSFIwa1IlZEpZMS9sY3FjYDFHSEBbZykhPklQUmtaKSNBS2V1TVNVYy5AN1Y0XiY5LGgjNVhrXVxsZ182Y1pxJlowR1slWi5mbykpRkVgWmdNTEBgWC5dWCFBKzZhbjFhbFBxL0dGVCY/MzguaTQhayVkY1FTSGBZVTh0cTRLZDhAXmZLc0ZVbi5rPFhac0lGRSRBXEVKNCdkWW5zTllYKlMjL1ZfP2RtKUgnazhvQyZFOSliYm4uRyZSbWBkRk9SNSw6TnB0aE9TMEVWaFcvNiwnc11WXk4ib0A6dVtPVE0kbyo0PktncmxXUHQmKzlCajolX1toTycmXUVYcmkpV2IqXl9hYCZDWCxNb1BPPCspLjY8Q0ltY1pXZUdjdSEvMkBGZzEndScpR048YGdqMj5YckJBT2ZUWi07Rl07RGkvMVEhdC8qO0tyRVQ/azRJS182ZDAmLFU/ZG45Xls5aiIzK2ohXDUpWnQ4NUcpTDNYM3VYOFpNXWYwP21CaUtrVkcjQmI/IS1pPXVNRGRrVXQvdGRuP0I7KiIvVnNjR0g8NF5iIlFMLmBMcEhsdWpGdFk0QWtxJmAtTDNnPG9yVjtLNEFUQj1TY2VyIUNRSDwxUFNgbTwiMEhAIUpzSDlQJnQtIT8uMVkkYGBIbVQvYHNrPnVfLkBHLEArXmw1QkthPEg4I3AjLCpBRFtmZSsqQzByW0xgZGcqVTJvYiUycSEuWmtkIishUUBqQlpIRUFEWkEsV2ZsdGxtS1dSYW1kLFRoViNlIVo5Kmw5IyNBP2dmSG5JNEs3cV5MZ0tRS2xPc0g/YyUsPFdIOSQkNGEiWFN1a0RaIjVXNXFSPjY5XmdHVik1MWRkRkAzblJQIyNYNltzQGpHaGthWXMyLyFKcFxXZ185MWNRQXEvTXEzMUpMbUtrVUI3QF5uQTVyZVJxXmckVGBzLGJUdTdTU1FNQ0VeZlZmSSNoS1NKZTBsKyJvWUk/Sj1WOicqO1RRZz5aJTtYV2hDbFNibl9TVEAiZHRdSHBhcGlxc2oiLSklRCVuTkA/aidMakhFYl8hMWZGJDpBYmZIWTdBQ2kiaUZLKENhdSo1KzZsakRlM0VhLipwLTViWGshJn4+ZW5kc3RyZWFtCmVuZG9iagp4cmVmCjAgMjMKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDczIDAwMDAwIG4gCjAwMDAwMDAxNTQgMDAwMDAgbiAKMDAwMDAwMDI2MSAwMDAwMCBuIAowMDAwMDAwMzczIDAwMDAwIG4gCjAwMDAwMDA0ODMgMDAwMDAgbiAKMDAwMDAwMDU5MSAwMDAwMCBuIAowMDAwMDAwNjc0IDAwMDAwIG4gCjAwMDAwMDA3ODkgMDAwMDAgbiAKMDAwMDAwMDk4NCAwMDAwMCBuIAowMDAwMDAxMTc5IDAwMDAwIG4gCjAwMDAwMDEzNzUgMDAwMDAgbiAKMDAwMDAwMTU3MSAwMDAwMCBuIAowMDAwMDAxNzY3IDAwMDAwIG4gCjAwMDAwMDE5NjMgMDAwMDAgbiAKMDAwMDAwMjAzMyAwMDAwMCBuIAowMDAwMDAyMzE3IDAwMDAwIG4gCjAwMDAwMDI0MTEgMDAwMDAgbiAKMDAwMDAwNTAyNyAwMDAwMCBuIAowMDAwMDA3Mzc4IDAwMDAwIG4gCjAwMDAwMDk5NTIgMDAwMDAgbiAKMDAwMDAxMTQ2MCAwMDAwMCBuIAowMDAwMDE0Mzg5IDAwMDAwIG4gCnRyYWlsZXIKPDwKL0lEIApbPDAwMDNlZDE0MTJmMGM4MjMyZDQ1NDg1OGMwYzZhYTMzPjwwMDAzZWQxNDEyZjBjODIzMmQ0NTQ4NThjMGM2YWEzMz5dCiUgUmVwb3J0TGFiIGdlbmVyYXRlZCBQREYgZG9jdW1lbnQgLS0gZGlnZXN0IChodHRwOi8vd3d3LnJlcG9ydGxhYi5jb20pCgovSW5mbyAxNSAwIFIKL1Jvb3QgMTQgMCBSCi9TaXplIDIzCj4+CnN0YXJ0eHJlZgoxNTc3NgolJUVPRgo=" download 
               style="background: linear-gradient(135deg, var(--gold-light) 0%, #fef3c7 100%); border: 2px solid var(--gold); border-radius: 12px; padding: 15px 20px; margin-bottom: 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s; text-decoration: none; color: inherit;"
               onmouseover="this.style.background='var(--gold)'; this.style.color='white';"
               onmouseout="this.style.background='linear-gradient(135deg, var(--gold-light) 0%, #fef3c7 100%)'; this.style.color='inherit';">
                <div style="font-size: 2em;">📄</div>
                <div style="flex: 1;">
                    <strong style="font-size: 1.05em;">Download Full Case Study (PDF)</strong>
                    <p style="margin: 3px 0 0; opacity: 0.8; font-size: 0.95em;">Detailed background: market analysis, strategic priorities, leadership team, financial data</p>
                </div>
                <div style="background: var(--gold-dark); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600;">Pre-Reading</div>
                <div style="font-size: 1.2em;">⬇</div>
            </a>
            
            <!-- Email from CEO -->
            <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 2px solid var(--gray-200);">
                <div style="display: flex; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--gray-200);">
                    <img id="ceo-email-headshot" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" alt="Meera Venkataraman">
                    <div>
                        <strong>Meera Venkataraman</strong> <span style="color: var(--gray-500);">CEO</span>
                        <div style="font-size: 0.85em; color: var(--gray-500);">To: You</div>
                    </div>
                </div>
                
                <div style="line-height: 1.8; color: var(--gray-700);">
                    <p>You've heard the rumours—they're true. Vikram is out, and I want you to take over R&D.</p>
                    
                    <p style="margin-top: 15px;">The last three years haven't worked. We funded 15 projects and only 4 made it. Pet projects got protected, bad news got buried, and we kept failing projects alive for years instead of cutting losses.</p>
                    
                    <p style="margin-top: 15px;"><strong>I'm giving you $40M and full authority to redesign how we select projects.</strong></p>
                </div>
            </div>
            
            <!-- Strategic Priorities -->
            <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 16px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: white; margin: 0 0 10px 0;">🎯 What the Board Expects</h2>
                <p style="opacity: 0.9; margin-bottom: 20px;">Your R&D portfolio needs to address these priorities:</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">🛡️ Defend Metro Leadership</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">We're #3 in India but competitors are catching up. Protect our position in Mumbai, Delhi, Bangalore and other major cities.</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">🗺️ Expand to Tier 2/3 Cities</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">The next wave of growth is in smaller cities—Jaipur, Lucknow, Coimbatore. We need affordable products that work there.</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">💳 Build Recurring Revenue</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">Hardware sales are lumpy. The board wants subscription services—monitoring, cloud storage, premium features.</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 18px; border-radius: 12px;">
                        <div style="font-size: 1.3em; margin-bottom: 8px;">🤖 Lead on AI & Smart Home</div>
                        <p style="opacity: 0.9; font-size: 0.95em; margin: 0;">We acquired CloudWatch for their AI talent. Now we need products that use it—before Google and Amazon eat our lunch.</p>
                    </div>
                </div>
            </div>
            
            <!-- What you have to work with -->
            <div style="background: var(--gray-50); border-radius: 16px; padding: 25px; margin-bottom: 25px;">
                <h2 style="color: var(--primary); margin: 0 0 15px 0;">💡 What You Have to Work With</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--success);">
                        <strong>Hardware expertise</strong> — sensors, cameras, fast prototyping
                    </div>
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                        <strong>2M app users</strong> — built-in distribution
                    </div>
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--gold);">
                        <strong>40 AI engineers</strong> — from CloudWatch acquisition
                    </div>
                    <div style="background: white; padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--danger);">
                        <strong>15,000 retailers</strong> — nationwide reach
                    </div>
                </div>
            </div>
            
            <!-- Challenge summary -->
            <div style="background: var(--warning-light); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 4px solid var(--warning);">
                <strong>Your challenge:</strong> Build and manage a portfolio that delivers results. You'll need to decide what mix of safe and ambitious projects to fund, how to tend the portfolio over time, and when to persist versus when to cut your losses. The board will judge not just your results, but how you achieved them.
            </div>
            
            <div class="button-row" style="padding-bottom: 80px;">
                <button class="btn btn-secondary" onclick="showPhase('landing')">← Back</button>
                <button class="btn btn-gold btn-large" onclick="startCommitteeSelection()">Design Your Selection Process →</button>
            </div>
            

        </div>
        
        <!-- PHASE: APPOINTMENT - Now just redirects to briefing -->
        <div id="phase-appointment" class="phase-content hidden">
        </div>
        
        <!-- COMPANY HISTORY MODAL - EXPANDED CASE STUDY -->
        <!-- COMPANY HISTORY MODAL -->
        <div class="modal-overlay hidden" id="history-modal" onclick="if(event.target === this) { this.classList.add('hidden'); MobileScrollLock.unlock(); }">
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close" onclick="document.getElementById('history-modal').classList.add('hidden'); MobileScrollLock.unlock();">×</button>
                <h2 style="color: var(--primary); margin-bottom: 20px;">📖 The ShieldTech Story</h2>
                
                <div style="line-height: 1.8; color: var(--gray-700);">
                    <p><strong>2012 — The Beginning</strong><br>
                    Meera Venkataraman and Arjun Khanna started ShieldTech in a cramped Bangalore apartment with $36,000 and a simple idea: every Indian family deserves to feel safe at home, not just the wealthy ones. Their first product was a motion sensor that cost a tenth of the competition.</p>
                    
                    <p style="margin-top: 15px;"><strong>2017 — Series B & Growth</strong><br>
                    Sequoia India invested $45M. The "SmartGuard" product line launched. ShieldTech expanded to 8 states and hired its 100th employee.</p>
                    
                    <p style="margin-top: 15px;"><strong>2019 — The Crucible</strong><br>
                    A key supplier went bankrupt, nearly taking ShieldTech with it. Three months of 18-hour days saved the company. Meera still calls it "the crucible."</p>
                    
                    <p style="margin-top: 15px;"><strong>2021 — IPO & Acquisition</strong><br>
                    Listed on BSE. Used the capital to acquire CloudWatch, an AI analytics startup with 40 ML engineers. Entered the commercial security market.</p>
                    
                    <p style="margin-top: 15px;"><strong>2024 — The Challenge</strong><br>
                    Revenue hit $145 million but growth is slowing. Chinese competitors are undercutting on price. The CloudWatch integration brought culture clashes. The previous Head of R&D was let go after too many failed projects.</p>
                    
                    <p style="margin-top: 15px;"><strong>Today</strong><br>
                    2,400 employees. #3 in India's home security market. A $40M R&D budget. And a new Head of R&D—you—tasked with picking the projects that will secure ShieldTech's future.</p>
                </div>
                
                <div class="button-row" style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="document.getElementById('history-modal').classList.add('hidden'); MobileScrollLock.unlock();">Got it</button>
                </div>
            </div>
        </div>
        
        
        <!-- PHASE: DESIGN - DECISION MODEL -->
        <div id="phase-design-decision" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 1 of 3</span>
                    <span class="step-label">Process Design</span>
                </div>
                <h1>Who Should Make Selection Decisions?</h1>
                <p>Your first major choice: how will project funding decisions be made?</p>
            </div>
            
            <div class="decision-model-grid">
                <div class="model-card" onclick="selectDecisionModel('solo')" data-model="solo">
                    <div class="icon">👤</div>
                    <h3>You Decide Alone</h3>
                    <p>Fast decisions with clear accountability. You review all proposals and make the calls.</p>
                    <div class="traits">
                        <span class="trait-tag">Fast</span>
                        <span class="trait-tag">Consistent</span>
                        <span class="trait-tag">Risky</span>
                    </div>
                </div>
                
                <div class="model-card" onclick="selectDecisionModel('committee')" data-model="committee">
                    <div class="icon">👥</div>
                    <h3>Selection Committee</h3>
                    <p>Assemble a team of colleagues to evaluate and vote on proposals together.</p>
                    <div class="traits">
                        <span class="trait-tag">Diverse views</span>
                        <span class="trait-tag">Shared ownership</span>
                        <span class="trait-tag">Slower</span>
                    </div>
                </div>
                
                <div class="model-card" onclick="selectDecisionModel('jury')" data-model="jury">
                    <div class="icon">🗳️</div>
                    <h3>Staff Jury</h3>
                    <p>Random selection of employees from across the company vote on each proposal.</p>
                    <div class="traits">
                        <span class="trait-tag">Democratic</span>
                        <span class="trait-tag">Fresh eyes</span>
                        <span class="trait-tag">Unpredictable</span>
                    </div>
                </div>
                
                <div class="model-card" onclick="selectDecisionModel('random')" data-model="random">
                    <div class="icon">🎲</div>
                    <h3>Leave It to Chance</h3>
                    <p>Projects meeting basic criteria are randomly selected. No human bias.</p>
                    <div class="traits">
                        <span class="trait-tag">Unbiased</span>
                        <span class="trait-tag">Equal chance</span>
                        <span class="trait-tag">No expertise</span>
                    </div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="showPhase('briefing')">← Back</button>
                <button class="btn btn-primary" id="decision-model-next" onclick="proceedFromDecisionModel()" disabled>Continue →</button>
            </div>
        </div>
        
        <!-- PHASE: DESIGN - COMMITTEE SELECTION -->
        <div id="phase-design-committee" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 1 of 2</span>
                    <span class="step-label">Build Your Committee</span>
                </div>
                <h1>Select Your Committee Members</h1>
                <p>Choose colleagues to join your selection committee. Each brings different perspectives, expertise, and biases. Add as many as you think you need.</p>
            </div>
            
            <div class="committee-section">
                <div class="committee-display">
                    <h3>Your Committee (<span id="committee-count">0</span> members)</h3>
                    <div class="committee-members" id="committee-members">
                        <div class="empty-committee">Click on staff members below to add them to your committee</div>
                    </div>
                </div>
            </div>
            
            <div class="committee-section">
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">👔</span>
                        Senior Leadership
                        <span class="category-hint">Strategic vision & organisational authority</span>
                    </h3>
                    <div class="staff-grid" id="staff-senior"></div>
                </div>
                
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">🏢</span>
                        Business Unit Heads
                        <span class="category-hint">P&L owners with market & customer insight</span>
                    </h3>
                    <div class="staff-grid" id="staff-heads"></div>
                </div>
                
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">🔬</span>
                        Technical Leaders
                        <span class="category-hint">Deep expertise in engineering & innovation</span>
                    </h3>
                    <div class="staff-grid" id="staff-tech"></div>
                </div>
                
                <div class="staff-category">
                    <h3 class="staff-category-header">
                        <span class="category-icon">💡</span>
                        Other Voices
                        <span class="category-hint">Fresh perspectives & diverse viewpoints</span>
                    </h3>
                    <div class="staff-grid" id="staff-junior"></div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="showPhase('briefing')">← Back</button>
                <button class="btn btn-primary" id="committee-next" onclick="showPhase('design-criteria')" disabled>Continue to Criteria →</button>
            </div>
        </div>
        
        <!-- PHASE: DESIGN - CRITERIA -->
        <div id="phase-design-criteria" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 2 of 2</span>
                    <span class="step-label">Set Your Criteria</span>
                </div>
                <h1>Define Your Evaluation Criteria</h1>
                <p>What factors will you prioritise when evaluating projects? We recommend 4-6 criteria for balanced evaluation, but you can select as many as you need.</p>
            </div>
            
            <div class="committee-section">
                <div class="criteria-selection-header">
                    <h2>Primary Criteria</h2>
                    <div id="criteria-warning" class="criteria-warning">Select at least one criterion to continue</div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">⚙️</span>
                        Technical & Feasibility
                    </h3>
                    <div class="criteria-grid" id="criteria-technical"></div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">🎯</span>
                        Strategic Alignment
                    </h3>
                    <div class="criteria-grid" id="criteria-strategic"></div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">📈</span>
                        Market & Commercial
                    </h3>
                    <div class="criteria-grid" id="criteria-market"></div>
                </div>
                
                <div class="criteria-category">
                    <h3 class="criteria-category-header">
                        <span class="category-icon">💼</span>
                        Financial & Execution
                    </h3>
                    <div class="criteria-grid" id="criteria-financial"></div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="goBackFromCriteria()">← Back</button>
                <button class="btn btn-primary" id="criteria-next" onclick="showCriteriaWeights()" disabled>Weight Your Criteria →</button>
            </div>
        </div>
        
        <!-- PHASE: CRITERIA WEIGHTING -->
        <div id="phase-criteria-weights" class="phase-content hidden">
            <div class="design-header">
                <div class="step-indicator">
                    <span class="step-badge">Step 2 of 2</span>
                    <span class="step-label">Weight Your Criteria</span>
                </div>
                <h1>Assign Importance Weights</h1>
                <p>How important is each criterion relative to the others? Distribute 100 points across your selected criteria to reflect their relative importance in your evaluation.</p>
            </div>
            
            <div class="committee-section">
                <div class="weights-container">
                    <div class="weights-header">
                        <div class="weights-total-display">
                            <span class="weights-label">Total:</span>
                            <span id="weights-total" class="weights-value">0</span>
                            <span class="weights-target">/ 100</span>
                        </div>
                        <div id="weights-status" class="weights-status">Assign exactly 100 points</div>
                    </div>
                    
                    <div id="weights-grid" class="weights-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                    
                    <div class="weights-actions">
                        <button class="btn btn-text" onclick="distributeWeightsEvenly()">Distribute Evenly</button>
                        <button class="btn btn-text" onclick="resetWeights()">Reset All</button>
                    </div>
                </div>
                
                <div class="weights-preview">
                    <h3>Preview: Your Evaluation Formula</h3>
                    <div id="weights-formula" class="weights-formula">
                        <!-- Shows formula preview -->
                    </div>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="showPhase('design-criteria')">← Back to Criteria</button>
                <button class="btn btn-primary" id="weights-next" onclick="confirmWeightsAndShowLegacy()" disabled>Review Current Portfolio →</button>
            </div>
        </div>
        
        <!-- PHASE: LEGACY PORTFOLIO -->
        <div id="phase-legacy-portfolio" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">2</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="briefing-header" style="margin-bottom: 25px;">
                <div class="company-logo">🏢 ShieldTech India</div>
                <h1>Current R&D Portfolio</h1>
                <p class="subtitle">Before selecting new projects, you must decide what to do with the initiatives you've inherited.</p>
            </div>
            
            <div class="legacy-summary-bar" style="background: var(--white); padding: 20px 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--primary);" id="legacy-count">7</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Active Projects</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--warning);" id="legacy-committed-budget">$8.1M</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Remaining Budget</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--gray-600);" id="legacy-sunk-cost">$15.1M</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Already Spent</div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--success);"></span>
                        <span style="font-size: 0.85em; color: var(--gray-600);" id="legacy-green-count">2 On Track</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning);"></span>
                        <span style="font-size: 0.85em; color: var(--gray-600);" id="legacy-amber-count">3 At Risk</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger);"></span>
                        <span style="font-size: 0.85em; color: var(--gray-600);" id="legacy-red-count">2 Troubled</span>
                    </div>
                </div>
            </div>
            
            <div id="legacy-projects-container" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Legacy projects rendered here by JavaScript -->
            </div>
            
            <div class="budget-impact-summary" style="background: var(--primary-lighter); padding: 20px 25px; border-radius: 12px; margin-top: 25px; border: 2px solid var(--primary-pale);">
                <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1.1em;">📊 Your Decisions Impact</h3>
                <div style="display: flex; gap: 40px; flex-wrap: wrap;">
                    <div>
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--primary);" id="legacy-new-budget">$8.1M</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Budget Committed to Legacy</div>
                    </div>
                    <div>
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--success);" id="legacy-freed-budget">$0.0M</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Budget Freed Up</div>
                    </div>
                    <div>
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--accent);" id="legacy-available-new">$<span id="available-for-new">0.0</span>M</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Available for New Projects</div>
                    </div>
                </div>
            </div>
            
            <div class="button-row" style="margin-top: 25px;">
                <button class="btn btn-secondary" onclick="showPhase('criteria-weights')">← Back to Criteria</button>
                <button class="btn btn-primary" id="legacy-confirm-btn" onclick="confirmLegacyDecisions()">Confirm Decisions & See New Projects →</button>
            </div>
        </div>
        
        <!-- SELECTION APPROACH MODAL -->
        <div class="approach-modal-overlay hidden" id="approach-modal">
            <div class="approach-modal">
                <div class="approach-modal-header">
                    <h2>🎯 Configure Your Selection Process</h2>
                    <p>Make two decisions that will shape how you evaluate project proposals</p>
                </div>
                
                <div class="approach-modal-body">
                    <!-- CHOICE 1: SCORING APPROACH -->
                    <div class="approach-choice-section">
                        <div class="approach-choice-header">
                            <span class="choice-number">1</span>
                            <div>
                                <h3>How will you score projects?</h3>
                                <p>Choose how much time and detail you'll invest in evaluating each proposal</p>
                            </div>
                        </div>
                        
                        <div class="approach-options-vertical">
                            <div class="approach-option" data-choice="scoring" data-value="careful" onclick="selectApproachOption('scoring', 'careful')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">🔍</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Careful Evaluation</div>
                                    <div class="approach-option-desc">Review full project details, financials, risks, and milestones. Score each criterion thoughtfully.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Full information</span>
                                        <span class="approach-effect pro">Thorough analysis</span>
                                        <span class="approach-effect neutral">~3 min per project</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option" data-choice="scoring" data-value="rapid" onclick="selectApproachOption('scoring', 'rapid')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">⚡</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Rapid Screening</div>
                                    <div class="approach-option-desc">See only a brief summary and key metrics. Make quick judgments based on first impressions.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Fast decisions</span>
                                        <span class="approach-effect con">Limited detail</span>
                                        <span class="approach-effect neutral">~30 sec per project</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option" data-choice="scoring" data-value="delegate" onclick="selectApproachOption('scoring', 'delegate')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">👥</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Delegate to Committee</div>
                                    <div class="approach-option-desc">Let your committee members score the projects. You'll review their recommendations and make final decisions.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Leverage expertise</span>
                                        <span class="approach-effect con">Less personal insight</span>
                                        <span class="approach-effect neutral">Skip to triage</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CHOICE 2: TEAM INFORMATION BLINDING -->
                    <div class="approach-choice-section">
                        <div class="approach-choice-header">
                            <span class="choice-number">2</span>
                            <div>
                                <h3>Should team information be visible?</h3>
                                <p>Decide whether to see who is leading and working on each project</p>
                            </div>
                        </div>
                        
                        <div class="approach-options-horizontal">
                            <div class="approach-option compact" data-choice="blinding" data-value="visible" onclick="selectApproachOption('blinding', 'visible')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">👤</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Show Team Info</div>
                                    <div class="approach-option-desc">See project leads, team composition, and track records. People matter in project success.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Full context</span>
                                        <span class="approach-effect con">Potential bias</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option compact" data-choice="blinding" data-value="blind" onclick="selectApproachOption('blinding', 'blind')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">🎭</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Blind Review</div>
                                    <div class="approach-option-desc">Hide all team information. Judge projects purely on their merits, not personalities.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Reduces bias</span>
                                        <span class="approach-effect con">Missing context</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="approach-research-note">
                        <h4>📚 Research Insight</h4>
                        <p>Studies show that evaluator attention and information presentation significantly affect project selection. Time pressure leads to reliance on heuristics, while knowing team identities can introduce both valuable context and unconscious biases (Criscuolo et al., 2021; Boudreau et al., 2016).</p>
                    </div>
                </div>
                
                <div class="approach-modal-footer">
                    <button class="approach-confirm-btn" id="approach-confirm-btn" disabled onclick="confirmApproach()">
                        Make Both Selections to Continue
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Extra Budget Request Modal -->
        <div class="extra-budget-modal-overlay" id="extra-budget-modal">
            <div class="extra-budget-modal">
                <div class="extra-budget-modal-header">
                    <h2>💬 Request Additional Funding from Meera</h2>
                </div>
                <div class="extra-budget-modal-body">
                    <div class="extra-budget-scenario">
                        <p>You've identified a promising project that doesn't quite fit in the current budget. You could make a personal case to <strong>Meera</strong> for additional funding — she's known to back R&D leaders who show conviction in their portfolio choices.</p>
                    </div>
                    
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; gap: 16px; align-items: flex-start;">
                        <img id="extra-budget-meera-headshot" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; flex-shrink: 0;" alt="Meera Venkataraman">
                        <div>
                            <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">Meera Venkataraman, CEO</div>
                            <p style="margin: 0; color: var(--gray-600); font-style: italic; line-height: 1.5;">"I can find an extra $5M if you're confident in the portfolio. But I'll be watching the results closely — I'm backing <em>you</em>, not just the projects."</p>
                        </div>
                    </div>
                    
                    <div class="extra-budget-terms">
                        <h4>📋 What This Means</h4>
                        <ul>
                            <li><strong>+$5M</strong> added to your Year 1 budget</li>
                            <li>Meera will expect <strong>stronger portfolio performance</strong></li>
                            <li>Your end-of-game evaluation will reflect this higher bar</li>
                            <li>This is a one-time request — choose wisely</li>
                        </ul>
                    </div>
                    
                    <p style="color: var(--gray-600); font-size: 0.9em; margin-bottom: 20px;">
                        <em>Are you confident enough in your project selection to ask for more?</em>
                    </p>
                    
                    <div class="extra-budget-actions">
                        <button class="extra-budget-decline" onclick="closeExtraBudgetModal()">
                            Work Within Budget
                        </button>
                        <button class="extra-budget-accept" onclick="acceptExtraBudget()">
                            Make the Ask →
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bootleg Project Modal -->
        <div class="bootleg-modal-overlay" id="bootleg-modal">
            <div class="bootleg-modal">
                <div class="bootleg-modal-header">
                    <h2>🔧 Skunkworks Opportunity</h2>
                    <p>A team member has been working on something in their spare time...</p>
                </div>
                <div class="bootleg-modal-body">
                    <div class="bootleg-pitch" id="bootleg-pitch">
                        <!-- Pitcher info populated by JS -->
                    </div>
                    
                    <div class="bootleg-project-card" id="bootleg-project-card">
                        <!-- Project details populated by JS -->
                    </div>
                    
                    <div class="bootleg-context">
                        💡 <strong>Why now?</strong> You've freed up resources by cutting underperforming projects. This grassroots innovation could use that capacity.
                    </div>
                    
                    <div class="bootleg-actions">
                        <button class="bootleg-decline" onclick="declineBootlegProject()">
                            Not Now
                        </button>
                        <button class="bootleg-accept" onclick="acceptBootlegProject()">
                            Add to Portfolio →
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHASE: PLAYER ASSESSMENT -->
        <div id="phase-assessment" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">2</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card">
                <div class="assessment-header">
                    <h2>Assess Project Proposals</h2>
                    <div class="assessment-progress-bar">
                        <div class="progress-fill" id="assessment-progress-fill"></div>
                    </div>
                    <div class="assessment-progress-text">
                        Project <strong id="current-project-num">1</strong> of <span id="total-projects">12</span>
                    </div>
                    <div class="project-progress-dots" id="project-progress-dots">
                        <!-- Project dots will be rendered here -->
                    </div>
                </div>
                
                <div class="assessment-project-view" id="assessment-project-view">
                    <!-- Current project details will be rendered here -->
                </div>
                
                <div class="assessment-scoring" id="assessment-scoring">
                    <!-- Scoring interface will be rendered here -->
                </div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" id="prev-project-btn" onclick="prevProject()" disabled>← Previous</button>
                    <button class="btn btn-primary" id="next-project-btn" onclick="nextProject()">Next Project →</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: COMMITTEE FEEDBACK -->
        <div id="phase-committee-feedback" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="triage-layout">
                <div class="triage-header">
                    <h2>Triage Your Projects</h2>
                    <p>Review committee feedback and make initial funding decisions. Categorise each project, then fine-tune the marginal cases in the portfolio view.</p>
                    
                    <div class="triage-budget-summary">
                        <div class="triage-budget-bar">
                            <div class="triage-budget-fill" id="triage-budget-fill"></div>
                        </div>
                        <div class="triage-budget-text">
                            <span class="funded-amount" id="triage-funded-amount">$0M</span> committed
                            <span class="separator">|</span>
                            <span class="remaining-amount" id="triage-remaining-amount">$40M</span> remaining
                            <span class="separator">|</span>
                            <span class="marginal-amount" id="triage-marginal-amount">$0M</span> in marginal projects
                        </div>
                    </div>
                    
                    <div class="triage-counts">
                        <div class="triage-count fund">
                            <span class="count-num" id="count-fund">0</span>
                            <span class="count-label">Funded</span>
                        </div>
                        <div class="triage-count marginal">
                            <span class="count-num" id="count-marginal">0</span>
                            <span class="count-label">Marginal</span>
                        </div>
                        <div class="triage-count stop">
                            <span class="count-num" id="count-stop">0</span>
                            <span class="count-label">Stopped</span>
                        </div>
                    </div>
                </div>
                
                <div class="triage-grid" id="triage-grid">
                    <!-- Triage cards will be rendered here -->
                </div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="showPhase('assessment')">← Revise Assessment</button>
                    <button class="btn btn-primary" id="triage-continue-btn" onclick="showBudgetMeeting()">Proceed to Budget Approval →</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: BUDGET MEETING CHOICE -->
        <div id="phase-budget-meeting" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card" style="text-align: center; padding: 40px;">
                <h2 style="color: var(--primary); margin-bottom: 20px;">🪑 Budget Approval Meeting</h2>
                <p style="max-width: 600px; margin: 0 auto 25px; color: var(--gray-600); line-height: 1.6;">
                    Before finalizing your portfolio, chair the R&D Budget Committee meeting. 
                    Your facilitation skills determine your final budget allocation.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 450px; margin: 0 auto 25px;">
                    <div style="background: var(--success-light); border: 2px solid var(--success); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">🏆</div>
                        <div style="font-weight: 700; color: var(--success);">Great Meeting</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Up to $44M (+10%)</div>
                    </div>
                    <div style="background: var(--danger-light); border: 2px solid var(--danger); border-radius: 12px; padding: 15px;">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">💥</div>
                        <div style="font-weight: 700; color: var(--danger);">Failed Meeting</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Down to $34M (-15%)</div>
                    </div>
                </div>
                
                <div class="button-row" style="justify-content: center; gap: 20px;">
                    <button class="btn btn-gold btn-large" onclick="startCommitteeChaos()">🪑 Start the Meeting</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: BUDGET RESULTS -->
        <div id="phase-budget-results" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card" style="text-align: center; padding: 40px;">
                <h2 id="budget-result-title" style="color: var(--primary); margin-bottom: 15px;">Meeting Complete</h2>
                <p id="budget-result-message" style="max-width: 500px; margin: 0 auto 20px; color: var(--gray-600);"></p>
                
                <div style="background: var(--gold-light); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; max-width: 300px; margin: 0 auto 25px;">
                    <div style="font-size: 0.85em; color: var(--gray-600); margin-bottom: 5px;">Your R&D Budget</div>
                    <div id="budget-result-amount" style="font-size: 2.2em; font-weight: 700; color: var(--primary);">$40M</div>
                    <div id="budget-result-change" style="font-size: 0.95em; margin-top: 5px;"></div>
                </div>
                
                <button class="btn btn-primary btn-large" onclick="showPortfolioBuilder()">Build Your Portfolio →</button>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 BUDGET MEETING -->
        <!-- PHASE: YEAR 1 END SELECTION (Mid-Year Portfolio Refresh) -->
        <div id="phase-year1-end-selection" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 2em;">🔄</span>
                    <div>
                        <h2 style="margin: 0; color: var(--primary);">Year 1 Portfolio Review</h2>
                        <p style="margin: 5px 0 0; color: var(--gray-500);">Q4 Complete — Time to refresh your portfolio for Year 2</p>
                    </div>
                </div>
                
                <p style="margin-bottom: 20px; color: var(--gray-600); line-height: 1.6;">
                    After a year of development, new opportunities have emerged from market shifts and technological advances. 
                    Some projects have freed up resources, and your team has identified promising new initiatives.
                    <strong>Consider how new projects might complement or rebalance your portfolio for Year 2.</strong>
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--success-light); border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;">📊</div>
                        <div style="font-weight: 600; color: var(--success);">Year 1 Learning</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Market feedback informs new bets</div>
                    </div>
                    <div style="background: var(--info-light); border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;">🆕</div>
                        <div style="font-weight: 600; color: var(--info);">Fresh Opportunities</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">New projects from the pipeline</div>
                    </div>
                    <div style="background: var(--gold-light); border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 5px;">💰</div>
                        <div style="font-weight: 600; color: var(--gold-dark);">Available Budget</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">Freed from completed/killed projects</div>
                    </div>
                </div>
                
                <div class="budget-bar">
                    <div class="budget-display">
                        Available Budget: <span class="amount" id="year1end-budget-remaining">$0M</span> <span class="total" id="year1end-budget-total">/ $40M total</span>
                    </div>
                    <div class="projects-count"><span id="year1end-projects-selected">0</span> new projects selected</div>
                </div>
                
                <div style="background: var(--warning-light); border: 1px solid var(--warning); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 1.2em;">⚡</span>
                        <div style="font-size: 0.9em; color: var(--gray-700);">
                            <strong>Strategic Timing:</strong> Projects selected now will begin Q5 and can capitalise on Year 1 learnings. 
                            Choose initiatives that complement your existing portfolio or address gaps you've discovered.
                        </div>
                    </div>
                </div>
                
                <!-- Strategic Balance Display for Year 1 End -->
                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px; color: var(--gray-700); font-size: 1em;">Portfolio Balance (Current + Selected)</h3>
                    <div id="year1end-strategic-balance" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="project-grid" id="year1end-project-grid"></div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="skipYear1EndSelection()">Skip (no new projects) →</button>
                    <button class="btn btn-primary" id="confirm-year1end-selection-btn" onclick="finalConfirmYear1EndSelection()" disabled>Add Selected Projects →</button>
                </div>
            </div>
        </div>
        
        <!-- Year 1 End Portfolio Review Modal -->
        <div class="modal-overlay hidden" id="year1end-review-modal">
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close" onclick="closeYear1EndReview()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 15px;">📊 Year 2 Portfolio Review</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Review your updated portfolio balance before proceeding. Make sure your strategic buckets align with your Year 2 goals.
                </p>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 1em; color: var(--gray-700); margin-bottom: 12px;">Strategic Balance After Adding New Projects</h3>
                    <div id="year1end-review-balance" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 1em; color: var(--gray-700); margin-bottom: 12px;">New Projects Being Added</h3>
                    <div id="year1end-review-projects" style="display: grid; gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 1em; color: var(--gray-700); margin-bottom: 12px;">Current Active Portfolio</h3>
                    <div id="year1end-review-existing" style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; text-align: center;">
                    <div style="background: var(--info-light); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--info);" id="year1end-review-total-projects">0</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Total Projects</div>
                    </div>
                    <div style="background: var(--gold-light); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--gold-dark);" id="year1end-review-budget-used">$0</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Budget Allocated</div>
                    </div>
                    <div style="background: var(--success-light); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--success);" id="year1end-review-budget-remaining">$0</div>
                        <div style="font-size: 0.85em; color: var(--gray-500);">Budget Remaining</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="closeYear1EndReview()">← Adjust Selection</button>
                    <button class="btn btn-primary" onclick="finalConfirmYear1EndSelection()">Confirm & Continue to Year 2 →</button>
                </div>
            </div>
        </div>
        
        <!-- YEAR 1 PORTFOLIO REVIEW MODAL (2x2 Matrix) -->
        <div class="modal-overlay hidden" id="year1-portfolio-review-modal">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <button class="modal-close" onclick="closeYear1PortfolioReviewAndContinue()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 10px;">📊 Portfolio Balance</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Review your updated portfolio balance after adding new projects. Use the matrix views to assess strategic alignment before continuing to Year 2.
                </p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="matrix-toggle-btn active" onclick="switchYear1Matrix('risk-speed')" data-matrix="risk-speed">Speed vs Risk</button>
                    <button class="matrix-toggle-btn" onclick="switchYear1Matrix('market-tech')" data-matrix="market-tech">Market vs Tech</button>
                    <button class="matrix-toggle-btn" onclick="switchYear1Matrix('capability-strategic')" data-matrix="capability-strategic">Capability vs Strategy</button>
                    <button class="matrix-toggle-btn" onclick="switchYear1Matrix('roi-cost')" data-matrix="roi-cost">Return on Investment vs Cost</button>
                </div>
                
                <div class="matrix-container" id="year1-matrix-container" style="max-height: 400px;">
                    <!-- Matrix will be rendered here -->
                </div>
                
                <div class="matrix-legend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #22c55e; border: 2px solid #166534;"></div>
                        <span>Completed (Success)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #ef4444; border: 2px solid #b91c1c;"></div>
                        <span>Completed (Failed)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #6b7280; border: 2px solid #374151;"></div>
                        <span>Killed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #3b82f6; border: 2px solid #1d4ed8;"></div>
                        <span>Active (Year 2)</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0; text-align: center;">
                    <div style="background: #dcfce7; padding: 12px; border-radius: 10px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #166534;" id="y1-review-success">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Successes</div>
                    </div>
                    <div style="background: #fee2e2; padding: 12px; border-radius: 10px; border-left: 4px solid #ef4444;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #b91c1c;" id="y1-review-failed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Failures</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 10px; border-left: 4px solid #6b7280;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #374151;" id="y1-review-killed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Killed</div>
                    </div>
                    <div style="background: #dbeafe; padding: 12px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #1d4ed8;" id="y1-review-active">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Active</div>
                    </div>
                </div>
                
                <div id="y1-review-insights" style="background: var(--gray-50); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <!-- Insights will be populated -->
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="closeYear1PortfolioReviewAndContinue()">Evaluate Year 2 Opportunities →</button>
                </div>
            </div>
        </div>

        <!-- Year 2 Budget Meeting phases removed - Committee Chaos mini-game no longer used at Year 2 -->
        
        <!-- YEAR 2 APPROACH MODAL -->
        <div class="approach-modal-overlay hidden" id="year2-approach-modal">
            <div class="approach-modal">
                <div class="approach-modal-header">
                    <h2>🎯 Year 2 Evaluation Approach</h2>
                    <p>New project opportunities have emerged. How will you evaluate them?</p>
                </div>
                
                <div class="approach-modal-body">
                    <!-- YEAR 1 APPROACH REMINDER -->
                    <div class="approach-choice-section" style="background: var(--primary-lighter); border: 2px solid var(--primary); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <span style="font-size: 1.5em;">📋</span>
                            <div>
                                <h4 style="margin: 0; color: var(--primary);">Your Year 1 Approach</h4>
                                <p style="margin: 5px 0 0; font-size: 0.9em; color: var(--gray-600);" id="year1-approach-summary">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CHOICE: KEEP OR CHANGE -->
                    <div class="approach-choice-section">
                        <div class="approach-choice-header">
                            <span class="choice-number">?</span>
                            <div>
                                <h3>Use the same approach for Year 2?</h3>
                                <p>You can continue with your established process or try a different method</p>
                            </div>
                        </div>
                        
                        <div class="approach-options-horizontal">
                            <div class="approach-option compact" data-choice="year2approach" data-value="same" onclick="selectYear2ApproachOption('same')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">✅</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Keep Same Approach</div>
                                    <div class="approach-option-desc">Continue with your Year 1 evaluation method for consistency.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Consistent process</span>
                                        <span class="approach-effect pro">Comparable scores</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="approach-option compact" data-choice="year2approach" data-value="change" onclick="selectYear2ApproachOption('change')">
                                <div class="approach-option-radio"></div>
                                <div class="approach-option-icon">🔄</div>
                                <div class="approach-option-content">
                                    <div class="approach-option-title">Change Approach</div>
                                    <div class="approach-option-desc">Try a different evaluation method based on your Year 1 experience.</div>
                                    <div class="approach-option-effects">
                                        <span class="approach-effect pro">Adapt & learn</span>
                                        <span class="approach-effect con">Different baseline</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CHANGE OPTIONS (hidden initially) -->
                    <div id="year2-change-options" class="hidden">
                        <div class="approach-choice-section">
                            <div class="approach-choice-header">
                                <span class="choice-number">1</span>
                                <div>
                                    <h3>New scoring approach</h3>
                                    <p>How will you score Year 2 projects?</p>
                                </div>
                            </div>
                            
                            <div class="approach-options-vertical">
                                <div class="approach-option" data-choice="y2scoring" data-value="careful" onclick="selectYear2ScoringOption('careful')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">🔍</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Careful Evaluation</div>
                                        <div class="approach-option-desc">Review full project details. Score each criterion thoughtfully.</div>
                                    </div>
                                </div>
                                
                                <div class="approach-option" data-choice="y2scoring" data-value="rapid" onclick="selectYear2ScoringOption('rapid')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">⚡</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Rapid Screening</div>
                                        <div class="approach-option-desc">Quick judgments based on summary information.</div>
                                    </div>
                                </div>
                                
                                <div class="approach-option" data-choice="y2scoring" data-value="delegate" onclick="selectYear2ScoringOption('delegate')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">👥</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Delegate to Committee</div>
                                        <div class="approach-option-desc">Let committee members score. You review recommendations.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="approach-choice-section">
                            <div class="approach-choice-header">
                                <span class="choice-number">2</span>
                                <div>
                                    <h3>Team information visibility</h3>
                                </div>
                            </div>
                            
                            <div class="approach-options-horizontal">
                                <div class="approach-option compact" data-choice="y2blinding" data-value="visible" onclick="selectYear2BlindingOption('visible')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">👤</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Show Team Info</div>
                                    </div>
                                </div>
                                
                                <div class="approach-option compact" data-choice="y2blinding" data-value="blind" onclick="selectYear2BlindingOption('blind')">
                                    <div class="approach-option-radio"></div>
                                    <div class="approach-option-icon">🎭</div>
                                    <div class="approach-option-content">
                                        <div class="approach-option-title">Blind Review</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="approach-research-note">
                        <h4>📚 Learning Opportunity</h4>
                        <p>Year 2 evaluation lets you compare new opportunities against your ongoing investments. Consider: Are the new projects stronger or weaker than what you're already funding? Should you reallocate resources?</p>
                    </div>
                </div>
                
                <div class="approach-modal-footer">
                    <button class="approach-confirm-btn" id="year2-approach-confirm-btn" disabled onclick="confirmYear2Approach()">
                        Select an Option to Continue
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 ASSESSMENT -->
        <div id="phase-year2-assessment" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="assessment-header">
                <div class="project-counter">
                    <span class="current" id="year2-project-counter-current">1</span>
                    <span class="total">/ <span id="year2-project-counter-total">6</span></span>
                </div>
                <div class="assessment-progress-bar">
                    <div class="assessment-progress-fill" id="year2-assessment-progress"></div>
                </div>
            </div>
            
            <div class="assessment-container">
                <div class="card project-card" id="year2-project-card">
                    <!-- Project details populated by JavaScript -->
                </div>
                
                <div class="card scoring-card">
                    <h3>🧭 Quick Triage</h3>
                    <p class="scoring-instructions">Year 2 does <strong>not</strong> repeat Year 1 criteria scoring. Mark each project as a priority, maybe, or pass.</p>

                    <div id="year2-triage-controls">
                        <!-- Triage buttons populated by JavaScript -->
                    </div>
                    </div>
                    
                    <div class="button-row">
                        <button class="btn btn-secondary" id="year2-prev-project-btn" onclick="year2PrevProject()" disabled>← Previous</button>
                        <button class="btn btn-primary" id="year2-next-project-btn" onclick="year2NextProject()">Next Project →</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 COMMITTEE FEEDBACK -->
        <div id="phase-year2-committee-feedback" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card">
                <div class="feedback-header">
                    <h2>📊 Year 2 Project Rankings</h2>
                    <p>Compare the new opportunities against your ongoing portfolio</p>
                </div>
                
                <div class="feedback-tabs" style="margin-bottom: 20px;">
                    <button class="feedback-tab active" onclick="switchYear2FeedbackTab('new')" data-tab="new">🆕 New Projects</button>
                    <button class="feedback-tab" onclick="switchYear2FeedbackTab('ongoing')" data-tab="ongoing">📂 Ongoing Projects</button>
                    <button class="feedback-tab" onclick="switchYear2FeedbackTab('comparison')" data-tab="comparison">⚖️ Comparison</button>
                </div>
                
                <div id="year2-feedback-new" class="feedback-tab-content">
                    <h3 style="margin-bottom: 15px;">New Year 2 Opportunities (Ranked)</h3>
                    <div class="rankings-list" id="year2-new-rankings">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div id="year2-feedback-ongoing" class="feedback-tab-content hidden">
                    <h3 style="margin-bottom: 15px;">Your Ongoing Projects (Original Scores)</h3>
                    <div class="rankings-list" id="year2-ongoing-rankings">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div id="year2-feedback-comparison" class="feedback-tab-content hidden">
                    <h3 style="margin-bottom: 15px;">Side-by-Side Comparison</h3>
                    <p style="color: var(--gray-600); margin-bottom: 15px;">How do your new opportunities stack up against existing investments?</p>
                    <div id="year2-comparison-view">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="strategic-summary" style="margin-top: 25px; background: var(--gray-50); padding: 20px; border-radius: 12px;">
                    <h3 style="margin-bottom: 15px;">🎯 Strategic Balance Check</h3>
                    <p style="color: var(--gray-600); margin-bottom: 15px;">Consider how new projects fill gaps in your current portfolio's strategic coverage:</p>
                    <div id="year2-strategic-balance-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="triage-summary" style="margin-top: 25px;">
                    <h3>🏷️ Triage Your New Projects</h3>
                    <p style="color: var(--gray-600); margin-bottom: 15px;">Categorize the Year 2 opportunities based on your evaluation</p>
                    <div class="triage-grid" id="year2-triage-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="button-row" style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="maybeStartResourceRunY2()">Build Year 2 Portfolio →</button>
                </div>
            </div>
        </div>
        
        <!-- YEAR 2 PORTFOLIO REVIEW MODAL (2x2 Matrix) -->
        <div class="modal-overlay hidden" id="year2-portfolio-review-modal">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <button class="modal-close" onclick="closeYear2PortfolioReview()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 10px;">📊 Year 2 Portfolio Balance</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Review your updated portfolio balance after adding new projects. Use the matrix views to assess strategic alignment before continuing.
                </p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="matrix-toggle-btn active" onclick="switchYear2Matrix('risk-speed')" data-matrix="risk-speed">Speed vs Risk</button>
                    <button class="matrix-toggle-btn" onclick="switchYear2Matrix('market-tech')" data-matrix="market-tech">Market vs Tech</button>
                    <button class="matrix-toggle-btn" onclick="switchYear2Matrix('capability-strategic')" data-matrix="capability-strategic">Capability vs Strategy</button>
                    <button class="matrix-toggle-btn" onclick="switchYear2Matrix('roi-cost')" data-matrix="roi-cost">Return on Investment vs Cost</button>
                </div>
                
                <div class="matrix-container" id="year2-matrix-container" style="max-height: 400px;">
                    <!-- Matrix will be rendered here -->
                </div>
                
                <div class="matrix-legend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #22c55e; border: 2px solid #166534;"></div>
                        <span>Completed (Success)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #ef4444; border: 2px solid #b91c1c;"></div>
                        <span>Completed (Failed)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #6b7280; border: 2px solid #374151;"></div>
                        <span>Killed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble" style="background: #3b82f6; border: 2px solid #1d4ed8;"></div>
                        <span>Active</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0; text-align: center;">
                    <div style="background: #dcfce7; padding: 12px; border-radius: 10px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #166534;" id="y2-review-success">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Successes</div>
                    </div>
                    <div style="background: #fee2e2; padding: 12px; border-radius: 10px; border-left: 4px solid #ef4444;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #b91c1c;" id="y2-review-failed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Failures</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 10px; border-left: 4px solid #6b7280;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #374151;" id="y2-review-killed">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Killed</div>
                    </div>
                    <div style="background: #dbeafe; padding: 12px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #1d4ed8;" id="y2-review-active">0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Active</div>
                    </div>
                </div>
                
                <div id="y2-review-insights" style="background: var(--gray-50); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <!-- Insights will be populated -->
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="closeYear2PortfolioReviewAndContinue()">Continue to Budget Review →</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: YEAR 2 PROJECT SELECTION -->
        <div id="phase-year2-selection" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="portfolio-builder-layout">
                <div class="portfolio-sidebar">
                    <div class="portfolio-budget-card">
                        <h3>Year 2 Budget</h3>
                        <div id="year2-budget-breakdown" style="font-size: 0.85em; margin-bottom: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div class="budget-meter">
                            <div class="budget-meter-fill" id="year2-budget-fill"></div>
                        </div>
                        <div class="budget-stats">
                            <span class="budget-spent" id="year2-budget-remaining">$0M</span>
                            <span class="budget-total" id="year2-budget-available">available for new</span>
                        </div>
                    </div>
                    
                    <div class="portfolio-buckets-card">
                        <h3>Portfolio Summary</h3>
                        <div id="year2-portfolio-summary" style="font-size: 0.9em;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="portfolio-buckets-card">
                        <h3>Strategic Balance</h3>
                        <div id="year2-strategic-buckets" style="font-size: 0.9em;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="portfolio-scores-card">
                        <h3>New Project Rankings</h3>
                        <div class="scores-scroll" id="year2-new-project-list" style="max-height: 200px; overflow-y: auto;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="button-row" style="flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" id="confirm-year2-portfolio-btn" onclick="confirmYear2Portfolio()">Confirm Year 2 Portfolio →</button>
                        <button class="btn btn-secondary" onclick="showPhase('year2-committee-feedback')">← Back to Rankings</button>
                    </div>
                </div>
                
                <div class="portfolio-main">
                    <div class="matrix-header">
                        <h2>Year 2 Portfolio Builder</h2>
                        <p>Your <strong>ongoing projects</strong> (blue) continue from Year 1. <strong>Click on new project bubbles</strong> (green outline) to add them to your portfolio.</p>
                    </div>
                    
                    <div class="portfolio-view-tabs">
                        <button class="view-tab active" onclick="switchYear2PortfolioView('matrix')" data-view="matrix">
                            📊 Matrix View
                        </button>
                        <button class="view-tab" onclick="switchYear2PortfolioView('list')" data-view="list">
                            📋 List View
                        </button>
                    </div>
                    
                    <div id="year2-portfolio-matrix-view">
                        <div class="matrix-tabs">
<button class="matrix-tab active" onclick="switchYear2PortfolioMatrix('risk-speed')" data-matrix="risk-speed">
    ⚡ Speed vs Risk
</button>
<button class="matrix-tab" onclick="switchYear2PortfolioMatrix('market-tech')" data-matrix="market-tech">
    🚀 Market vs Technology
</button>
<button class="matrix-tab" onclick="switchYear2PortfolioMatrix('capability-strategic')" data-matrix="capability-strategic">
    🎯 Capability vs Strategy
</button>
<button class="matrix-tab" onclick="switchYear2PortfolioMatrix('roi-cost')" data-matrix="roi-cost">
    💰 ROI vs Cost
</button>
                        </div>
                        
                        <div class="matrix-container" id="year2-portfolio-matrix">
                            <!-- Matrix rendered by JavaScript -->
                        </div>
                        
                        <div class="matrix-legend">
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: #3b82f6; border: 2px solid #1d4ed8;"></div>
                                <span>Ongoing (Year 1)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: #22c55e; border: 2px solid #166534;"></div>
                                <span>New (Selected)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: white; border: 2px dashed #22c55e;"></div>
                                <span>New (Available)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble" style="background: #e5e7eb; border: 2px solid #9ca3af;"></div>
                                <span>Skipped</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="year2-portfolio-list-view" class="hidden">
                        <div class="portfolio-list-sections" id="year2-portfolio-list">
                            <!-- List rendered by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- COMMITTEE CHAOS OVERLAY (EMBEDDED) -->
        <div id="cc-overlay" class="cc-overlay">
            <iframe id="cc-iframe" class="cc-iframe"></iframe>
        </div>

        <!-- RESOURCE RUN OVERLAY (EMBEDDED) -->
        <div id="rr-overlay" class="rr-overlay">
            <iframe id="rr-iframe" class="rr-iframe"></iframe>
        </div>

        <!-- RESOURCE RUN PROMPT BEFORE YEAR 2 ALLOCATION -->
        <div id="rr-y2-prompt" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div style="font-size: 2.2em;">🚚</div>
                    <div>
                        <h2 style="margin: 0 0 5px 0;">Resource Run</h2>
                        <p style="margin: 0; color: var(--gray-600);">Play a quick mini‑game to earn a Year 2 funding bonus.</p>
                    </div>
                </div>

                <p style="color: var(--gray-700); line-height: 1.5;">
                    Before you allocate Year 2 projects, run a fast "resource convoy" to earn extra budget.
                </p>

                <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 14px; padding: 15px; margin: 15px 0;">
                    <div style="font-weight: 700; margin-bottom: 8px;">Potential bonus (based on performance)</div>
                    <ul style="margin: 0; padding-left: 18px; color: var(--gray-700);">
                        <li><strong>Victory</strong>: +$1.5M</li>
                        <li><strong>Strong run</strong>: +$1.0M</li>
                        <li><strong>Decent run</strong>: +$0.5M</li>
                    </ul>
                </div>

                <div class="button-row" style="justify-content: flex-end; gap: 12px;">
                    <button class="btn btn-primary" onclick="playResourceRunY2()">Play Resource Run →</button>
                </div>
            </div>
        </div>
        <!-- PHASE: PORTFOLIO BUILDER -->
        <div id="phase-portfolio-builder" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="portfolio-builder-layout">
                <div class="portfolio-sidebar">
                    <div class="portfolio-budget-card">
                        <h3>Portfolio Budget</h3>
                        <div class="budget-breakdown" id="budget-breakdown" style="font-size: 0.85em; margin-bottom: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div class="budget-meter">
                            <div class="budget-meter-fill" id="portfolio-budget-fill"></div>
                        </div>
                        <div class="budget-stats">
                            <span class="budget-spent" id="portfolio-budget-spent">$0M</span>
                            <span class="budget-total" id="portfolio-budget-total">/ $40M available</span>
                        </div>
                        <div class="projects-count-mini"><span id="portfolio-project-count">0</span> projects selected</div>
                        
                        <!-- Extra Budget Request Prompt -->
                        <div class="extra-budget-prompt hidden" id="extra-budget-prompt">
                            <p>💡 <strong>Need a bit more?</strong> You could request emergency funding from the board...</p>
                            <button class="extra-budget-btn" onclick="openExtraBudgetModal()">
                                Request Extra Budget
                            </button>
                        </div>
                        
                        <!-- Extra Budget Granted Message -->
                        <div class="extra-budget-granted hidden" id="extra-budget-granted" style="display: flex; align-items: center; gap: 10px;">
                            <img id="extra-budget-granted-headshot" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover;" alt="Meera">
                            <span>✅ Meera approved +$5M — she's counting on strong results</span>
                        </div>
                    </div>
                    
                    <div class="portfolio-buckets-card">
                        <h3>Strategic Balance</h3>
                        <div id="portfolio-buckets-summary"></div>
                    </div>
                    
                    <div class="portfolio-scores-card">
                        <h3>Project Rankings</h3>
                        <div class="scores-scroll" id="portfolio-scores-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="button-row" style="flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" id="confirm-portfolio-btn" onclick="confirmPortfolio()" disabled>Confirm Portfolio →</button>
                        <button class="btn btn-secondary" onclick="showPhase('committee-feedback')">← Back to Triage</button>
                    </div>
                </div>
                
                <div class="portfolio-main">
                    <div class="matrix-header">
                        <h2>Fine-Tune Your Portfolio</h2>
                        <p>Your <strong>funded</strong> projects (green) are locked in. <strong>Click on marginal project bubbles</strong> (purple outline) to add or remove them from your portfolio. Stopped projects are greyed out.</p>
                        <div class="interaction-hint">
                            <span class="hint-icon">👆</span>
                            <span>Click any dashed-outline bubble to toggle it in/out of your portfolio</span>
                        </div>
                    </div>
                    
                    <div class="portfolio-view-tabs">
                        <button class="view-tab active" onclick="switchPortfolioView('matrix')" data-view="matrix">
                            📊 Matrix View
                        </button>
                        <button class="view-tab" onclick="switchPortfolioView('list')" data-view="list">
                            📋 List View
                        </button>
                    </div>
                    
                    <div id="portfolio-matrix-view">
                        <div class="matrix-tabs">
                            <button class="matrix-tab active" onclick="switchMatrix('risk-speed')" data-matrix="risk-speed">
                                ⚡ Speed vs Risk
                            </button>
                            <button class="matrix-tab" onclick="switchMatrix('market-tech')" data-matrix="market-tech">
                                🚀 Market vs Technology
                            </button>
                            <button class="matrix-tab" onclick="switchMatrix('capability-strategic')" data-matrix="capability-strategic">
                                🎯 Capability vs Strategy
                            </button>
                            <button class="matrix-tab" onclick="switchMatrix('roi-cost')" data-matrix="roi-cost">
                                💰 ROI vs Cost
                            </button>
                        </div>
                        
                        <div class="matrix-container" id="matrix-container">
                            <!-- Matrix will be rendered here -->
                        </div>
                        
                        <div class="matrix-legend">
                            <div class="legend-item">
                                <div class="legend-bubble funded"></div>
                                <span>Funded (locked)</span>
                            </div>
                            <div class="legend-item clickable-hint">
                                <div class="legend-bubble marginal-in"></div>
                                <span>Marginal (in portfolio) — click to remove</span>
                            </div>
                            <div class="legend-item clickable-hint">
                                <div class="legend-bubble marginal-out"></div>
                                <span>Marginal (available) — click to add</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bubble stopped"></div>
                                <span>Stopped</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="portfolio-list-view" class="hidden">
                        <div class="portfolio-list-sections">
                            <div class="portfolio-list-section funded-section">
                                <h3>✅ Funded Projects</h3>
                                <div id="portfolio-funded-list"></div>
                            </div>
                            <div class="portfolio-list-section marginal-section">
                                <h3>⚖️ Marginal Projects <span class="section-hint">— click to toggle</span></h3>
                                <div id="portfolio-marginal-list"></div>
                            </div>
                            <div class="portfolio-list-section stopped-section">
                                <h3>🚫 Stopped Projects</h3>
                                <div id="portfolio-stopped-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHASE: SELECTION -->
        <div id="phase-selection" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">2</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="card">
                <h2>Select Your R&D Portfolio</h2>
                <p>Projects are ranked by committee score. With limited budget, you'll need to make choices. Some projects are safer bets with predictable returns; others are more ambitious with higher uncertainty but greater potential. Consider both strategic priority coverage and your overall risk profile as you select.</p>
                
                <div class="budget-bar">
                    <div class="budget-display">
                        Budget: <span class="amount" id="budget-remaining">$40M</span> <span class="total">/ $40M available</span>
                    </div>
                    <div class="projects-count"><span id="projects-selected">0</span> projects selected</div>
                </div>
                
                <div class="strategic-balance" id="strategic-balance" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                    <!-- Strategic bucket balance will be rendered here -->
                </div>

                <div class="portfolio-view-tabs" style="margin: 10px 0 15px;">
                    <button class="view-tab active" onclick="switchY1SelectionView('cards')" data-view="cards">🗂️ Card View</button>
                    <button class="view-tab" onclick="switchY1SelectionView('matrix')" data-view="matrix">📊 Landscape View</button>
                </div>

                <div id="y1-selection-cards-view">
                    <div class="project-grid" id="project-grid"></div>
                </div>

                <div id="y1-selection-matrix-view" class="hidden">
                    <div class="matrix-tabs">
                        <button class="matrix-tab active" onclick="switchY1SelectionMatrix('risk-speed')" data-matrix="risk-speed">⚡ Speed vs Risk</button>
                        <button class="matrix-tab" onclick="switchY1SelectionMatrix('market-tech')" data-matrix="market-tech">🚀 Market vs Technology</button>
                        <button class="matrix-tab" onclick="switchY1SelectionMatrix('capability-strategic')" data-matrix="capability-strategic">🎯 Capability vs Strategy</button>
                        <button class="matrix-tab" onclick="switchY1SelectionMatrix('roi-cost')" data-matrix="roi-cost">💰 ROI vs Cost</button>
                    </div>

                    <div class="matrix-container" id="y1-selection-matrix" style="min-height: 420px;">
                        <!-- Matrix rendered by JavaScript -->
                    </div>

                    <div class="matrix-legend" style="margin-top: 10px;">
                        <div class="legend-item">
                            <div class="legend-bubble marginal-in"></div>
                            <span>Selected</span>
                        </div>
                        <div class="legend-item clickable-hint">
                            <div class="legend-bubble marginal-out"></div>
                            <span>Available — click to select</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-bubble unaffordable"></div>
                            <span>Over budget</span>
                        </div>
                    </div>
                </div>
                
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="showPhase('design-criteria')">← Redesign Process</button>
                    <button class="btn btn-primary" id="start-reviews-btn" onclick="startQuarterlyReviews()" disabled>Start Year with Selected Projects →</button>
                </div>
            </div>
        </div>
        
        <!-- PROJECT DETAIL MODAL -->
        <div class="modal-overlay hidden" id="project-modal">
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close" onclick="closeProjectModal()">×</button>
                
                <div class="project-modal-header">
                    <div>
                        <h2 id="project-modal-name" style="color: var(--primary); margin-bottom: 5px;"></h2>
                        <p id="project-modal-tagline" style="color: var(--gray-500); font-style: italic; margin: 0;"></p>
                        <div id="project-modal-buckets" style="margin-top: 10px;"></div>
                    </div>
                    <div class="project-modal-budget">
                        <span id="project-modal-budget" style="font-size: 1.5em; font-weight: 700; color: var(--gold-dark);"></span>
                        <span style="color: var(--gray-500); font-size: 0.85em;">Development Cost</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3>Project Overview</h3>
                    <p id="project-modal-desc"></p>
                </div>

                <div class="modal-section">
                    <h3>Innovation Signals</h3>
                    <div id="project-modal-cues"></div>
                </div>

                <div class="modal-section">
                    <h3>Market Context</h3>
                    <p id="project-modal-market"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Capability Fit</h3>
                    <p id="project-modal-capability"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Financial Projections</h3>
                    <div class="project-financials" id="project-modal-financials"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Development Cost Breakdown</h3>
                    <div id="project-modal-dev-costs"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Development Milestones & Success Metrics</h3>
                    <div id="project-modal-milestones"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Technology Readiness Level (TRL)</h3>
                    <div id="project-modal-trl"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Intellectual Property Position</h3>
                    <div id="project-modal-ip"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Key Competitors</h3>
                    <div id="project-modal-competitors"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Portfolio Synergies</h3>
                    <div id="project-modal-synergies"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Team Assessment</h3>
                    <p id="project-modal-team" style="font-style: italic; color: var(--gray-600);"></p>
                    <div id="project-modal-team-details" style="margin-top: 15px;"></div>
                </div>
                
                <div class="modal-triage-actions hidden" id="modal-triage-actions">
                    <h3>Your Decision</h3>
                    <div class="modal-triage-buttons">
                        <button class="triage-btn fund-btn" id="modal-fund-btn" onclick="setTriageFromModal('fund')">✅ Fund</button>
                        <button class="triage-btn marginal-btn" id="modal-marginal-btn" onclick="setTriageFromModal('marginal')">⚖️ Marginal</button>
                        <button class="triage-btn stop-btn" id="modal-stop-btn" onclick="setTriageFromModal('stop')">🚫 Stop</button>
                    </div>
                </div>
                
                <button class="add-to-committee-btn" id="project-modal-btn" onclick="toggleProjectFromModal()">Add to Portfolio</button>
            </div>
        </div>
        
        <!-- LEGACY PROJECT MODAL -->
        <div class="modal-overlay hidden" id="legacy-project-modal">
            <div class="modal-content" style="max-width: 750px;">
                <button class="modal-close" onclick="closeLegacyModal()">×</button>
                
                <div class="project-modal-header">
                    <div>
                        <h2 id="legacy-modal-name" style="color: var(--primary); margin-bottom: 5px;"></h2>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                            <span class="legacy-badge inherited">Inherited Project</span>
                            <span id="legacy-modal-status" class="legacy-status-badge"></span>
                        </div>
                    </div>
                    <div class="project-modal-budget" style="text-align: right;">
                        <div style="font-size: 1.4em; font-weight: 700; color: var(--primary);" id="legacy-modal-progress"></div>
                        <span style="color: var(--gray-500); font-size: 0.85em;">Complete</span>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3>📋 Project Overview</h3>
                    <p id="legacy-modal-desc"></p>
                </div>
                
                <div class="modal-section">
                    <h3>🎯 Strategic Alignment</h3>
                    <div id="legacy-modal-alignment"></div>
                </div>
                
                <div class="modal-section">
                    <h3>💰 Budget Status</h3>
                    <div id="legacy-modal-budget"></div>
                </div>
                
                <div class="modal-section">
                    <h3>🤝 External Commitments</h3>
                    <p id="legacy-modal-commitments" style="color: var(--gray-600);"></p>
                </div>
                
                <div class="modal-section">
                    <h3>🏢 Political Context</h3>
                    <p id="legacy-modal-politics" style="color: var(--gray-600);"></p>
                </div>
                
                <div class="modal-section">
                    <h3>👤 Project Lead</h3>
                    <div id="legacy-modal-lead"></div>
                </div>
                
                <div class="modal-section">
                    <h3>📊 Project History</h3>
                    <div id="legacy-modal-history"></div>
                </div>
                
                <div class="modal-section">
                    <h3>⚠️ Risk Assessment</h3>
                    <div id="legacy-modal-risks"></div>
                </div>
                
                <div class="modal-section" style="background: var(--gray-50); padding: 20px; border-radius: 12px; margin-top: 20px;">
                    <h3 style="margin-top: 0;">🎮 Your Decision</h3>
                    <div class="legacy-decision-options" id="legacy-modal-decisions"></div>
                    <div id="legacy-modal-impact" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>
        
        <!-- CORPORATE EVENT MODAL -->
        <div class="event-modal-overlay hidden" id="corporate-event-modal">
            <div class="event-modal">
                <div class="event-modal-header" id="event-modal-header">
                    <span class="event-icon" id="event-icon">📰</span>
                    <span class="event-category" id="event-category">Market News</span>
                    <h2 class="event-title" id="event-title">Event Title</h2>
                </div>
                <div class="event-modal-body">
                    <p class="event-description" id="event-description">
                        Event description goes here...
                    </p>
                    <div class="event-effect-box">
                        <div class="event-effect-label">Impact on Your Portfolio</div>
                        <div class="event-effect-text" id="event-effect">
                            Effect description
                        </div>
                    </div>
                    <div class="event-duration" id="event-duration">
                        <span class="event-duration-icon">⏱️</span>
                        <span>Effect lasts this quarter</span>
                    </div>
                    <button class="event-acknowledge-btn" id="event-acknowledge-btn" onclick="acknowledgeEvent()">
                        Understood, Continue →
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PROJECT LEAD CV MODAL -->
        <div class="lead-modal-overlay hidden" id="lead-cv-modal" onclick="closeLeadModal()">
            <div class="lead-modal" onclick="event.stopPropagation()">
                <button class="lead-modal-close" onclick="closeLeadModal()">×</button>
                <div class="lead-modal-header" id="lead-modal-header">
                    <div class="lead-modal-avatar" id="lead-modal-avatar">VS</div>
                    <div class="lead-modal-title">
                        <h2 id="lead-modal-name">Lead Name</h2>
                        <p id="lead-modal-role">Role · Team</p>
                    </div>
                    <div class="lead-modal-score" id="lead-modal-score">
                        <div class="score-value">85%</div>
                        <div class="score-label">Track Record</div>
                    </div>
                </div>
                <div class="lead-modal-body" id="lead-modal-body">
                    <!-- Lead CV content will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- CREDITS MODAL -->
        <div class="credits-modal-overlay hidden" id="credits-modal" onclick="closeCreditsModal()">
            <div class="credits-modal" onclick="event.stopPropagation()">
                <div class="credits-modal-header">
                    <h2>Build, Bin, Boost</h2>
                    <p>The R&D Portfolio Simulation — An interactive business simulation for innovation management education</p>
                </div>
                
                <div class="credits-modal-body">
                    <div class="credits-section">
                        <h3>👨‍💻 Created By</h3>
                        <div class="credits-person">
                            <div class="credits-avatar">AS</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Ammon Salter</div>
                                <div class="credits-person-role">Warwick Business School</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🤝 Contributors</h3>
                        <div class="credits-person">
                            <div class="credits-avatar" style="background: #7c3aed20; color: #7c3aed;">FB</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Federico Bignone</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #2563eb20; color: #2563eb;">PC</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Paola Criscuolo</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #0891b220; color: #0891b2;">CK</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Christos Kolympiris</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #05966920; color: #059669;">OM</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Orietta Marsili</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #dc262620; color: #dc2626;">RS</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Rossella Salandra</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #0284c720; color: #0284c7;">LD</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Linus Dahlander</div>
                                <div class="credits-person-role">Contributor</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🤖 Development Assistance</h3>
                        <div class="credits-person">
                            <div class="credits-avatar" style="background: #d4a27420; color: #d4a274;">AI</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Claude</div>
                                <div class="credits-person-role">AI Assistant by Anthropic</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #10a37f20; color: #10a37f;">AI</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">GPT-5</div>
                                <div class="credits-person-role">Coding assistance by OpenAI</div>
                            </div>
                        </div>
                        <div class="credits-person" style="margin-top: 12px;">
                            <div class="credits-avatar" style="background: #4285f420; color: #4285f4;">AI</div>
                            <div class="credits-person-info">
                                <div class="credits-person-name">Gemini</div>
                                <div class="credits-person-role">Image generation by Google</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📄 License</h3>
                        <div class="license-box">
                            <h4>
                                <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">
                                    <img src="https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png" alt="CC BY-NC-SA 4.0" style="height: 31px;">
                                </a>
                                CC BY-NC-SA 4.0
                            </h4>
                            <div class="license-terms">
                                <p>This work is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>
                                
                                <p><strong>You are free to:</strong></p>
                                <ul>
                                    <li><strong>Share</strong> — copy and redistribute the material in any medium or format</li>
                                    <li><strong>Adapt</strong> — remix, transform, and build upon the material</li>
                                </ul>
                                
                                <p><strong>Under the following terms:</strong></p>
                                <ul>
                                    <li><strong>Attribution</strong> — You must give appropriate credit, provide a link to the license, and indicate if changes were made</li>
                                    <li><strong>NonCommercial</strong> — You may not use the material for commercial purposes</li>
                                    <li><strong>ShareAlike</strong> — If you remix, transform, or build upon the material, you must distribute your contributions under the same license</li>
                                </ul>
                            </div>
                            
                            <div class="warranty-notice">
                                <strong>⚠️ Disclaimer:</strong> This simulation is provided "as is" without warranty of any kind, express or implied. The creators are not liable for any outcomes resulting from its use. This is an educational tool and should not be used as the sole basis for real business decisions.
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📚 Citation</h3>
                        <div class="license-box" style="background: var(--primary-lighter);">
                            <p style="font-size: 0.9em; color: var(--gray-700); margin: 0; font-family: monospace;">
                                Salter, A. (2025). Build, Bin, Boost: The R&D Portfolio Simulation. Warwick Business School.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="credits-modal-footer">
                    <p style="font-size: 0.8em; color: var(--gray-500); margin: 0 0 12px;">© 2025 Ammon Salter. All rights reserved under the terms of CC BY-NC-SA 4.0.</p>
                    <button class="credits-close-btn" onclick="closeCreditsModal()">Close</button>
                </div>
            </div>
        </div>
        
        <!-- TUTORIAL MODAL -->
        <div class="credits-modal-overlay hidden" id="tutorial-modal" onclick="closeTutorialModal()">
            <div class="credits-modal" onclick="event.stopPropagation()" style="max-width: 750px;">
                <div class="credits-modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, #3d1f42 100%);">
                    <h2>📖 How to Play</h2>
                    <p>A guide to Build, Bin, Boost</p>
                </div>
                
                <div class="credits-modal-body" style="max-height: 65vh; overflow-y: auto;">
                    <div class="credits-section">
                        <h3>🎯 Your Mission</h3>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            You've been appointed Head of R&D at ShieldTech India, a home security company. Your predecessor was fired after years of poor results. The board wants you to transform how the company selects and manages innovation projects—and deliver on four strategic priorities.
                        </p>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🎯 Strategic Priorities</h3>
                        <p style="color: var(--gray-600); line-height: 1.6; margin-bottom: 12px;">
                            The board has set four priorities for the next 3-5 years. Your portfolio should align with these goals:
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #2563eb15; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #2563eb;">
                                <strong style="color: #2563eb;">🛡️ Defend Metro Leadership</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Retain #1 position in top 8 cities</p>
                            </div>
                            <div style="background: #05966915; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #059669;">
                                <strong style="color: #059669;">🗺️ Tier 2/3 Rollout</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Profitable entry into 50 emerging cities</p>
                            </div>
                            <div style="background: #7c3aed15; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #7c3aed;">
                                <strong style="color: #7c3aed;">💳 Recurring Revenue</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Shift to services and subscriptions</p>
                            </div>
                            <div style="background: #dc262615; padding: 10px 12px; border-radius: 8px; border-left: 3px solid #dc2626;">
                                <strong style="color: #dc2626;">🤖 AI-First Products</strong>
                                <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--gray-600);">Lead the transition to intelligent security</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📋 Game Flow</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Design Your Process</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Assemble a selection committee from ShieldTech's leadership. Each person brings different expertise and biases. Choose evaluation criteria to guide decisions.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Handle Legacy Projects</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Your predecessor left behind ongoing projects of varying types. Review each and decide: continue, pause, or kill? Past spending is sunk—but consider each project's nature when deciding how to proceed.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Secure Your Budget</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Chair a budget committee meeting (mini-game). Your facilitation skills determine whether you get $34-44M for new projects.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Build Your Portfolio</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Evaluate 10-12 proposals with your committee. Projects vary in risk profile—some are safer bets, others are more ambitious. Consider your mix across strategic priorities and risk levels.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">5</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Manage Through Time</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Run the portfolio for 8 quarters (2 years). Each quarter you'll review progress, respond to dilemmas, and decide whether to continue, accelerate, reduce, or kill each project. Active management matters.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">6</div>
                                <div>
                                    <strong style="color: var(--gray-800);">Add New Projects</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">At the end of Year 1, new opportunities emerge. Evaluate fresh proposals and add to your portfolio for Year 2—or stay focused on existing commitments.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">7</div>
                                <div>
                                    <strong style="color: var(--gray-800);">See the Results</strong>
                                    <p style="margin: 4px 0 0; color: var(--gray-600); font-size: 0.9em;">Discover which projects truly succeeded. The board evaluates not just your hit rate and ROI, but how you built and managed the portfolio. Were your decisions well-timed? Was your approach too cautious—or too reckless?</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credits-section">
                        <h3>💡 Things to Consider</h3>
                        <ul style="color: var(--gray-600); line-height: 1.8; padding-left: 20px;">
                            <li><strong>Read the details:</strong> Click on projects and staff to see full profiles. The information matters.</li>
                            <li><strong>Think about risk balance:</strong> Some projects are safer bets with predictable returns; others are ambitious with higher uncertainty. What's the right mix for your portfolio?</li>
                            <li><strong>Committee composition matters:</strong> Different people spot different things. Consider what perspectives you need.</li>
                            <li><strong>Portfolio tending:</strong> Projects need ongoing attention. When should you persist with a struggling project? When should you cut your losses? Does project type matter?</li>
                            <li><strong>Watch for signals:</strong> Project updates contain information about how things are really going. What do the signals tell you?</li>
                            <li><strong>Strategic coverage:</strong> The board set four strategic priorities. How much does alignment matter? Is concentration a risk?</li>
                            <li><strong>Make active decisions:</strong> R&D dilemmas and quarterly reviews give you choices. Passive management is a choice too—but is it the right one?</li>
                            <li><strong>Timing matters:</strong> The right decision at the wrong time can still be costly. Consider whether different project types need different amounts of patience.</li>
                        </ul>
                    </div>
                    
                    <div class="credits-section">
                        <h3>📊 How You're Evaluated</h3>
                        <p style="color: var(--gray-600); line-height: 1.6; margin-bottom: 12px;">
                            The board evaluates you across multiple dimensions:
                        </p>
                        <ul style="color: var(--gray-600); line-height: 1.8; padding-left: 20px; margin-bottom: 12px;">
                            <li><strong>Selection accuracy:</strong> Did you fund winners and reject losers?</li>
                            <li><strong>Portfolio returns:</strong> What ROI did your investments generate?</li>
                            <li><strong>Risk balance:</strong> How did you balance safe bets against ambitious projects?</li>
                            <li><strong>Strategic alignment:</strong> Did you cover the board's priorities? Was your portfolio too concentrated?</li>
                            <li><strong>Portfolio management:</strong> How well did you tend the portfolio over time? Were your kill decisions well-timed?</li>
                            <li><strong>Active leadership:</strong> Did you make decisions, or let the portfolio run itself?</li>
                        </ul>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            The board delivers their verdict—ranging from promotion to CTO down to being asked to leave. Different paths can lead to success: there's more than one way to impress the board.
                        </p>
                    </div>
                    
                    <div class="credits-section">
                        <h3>🎓 Learning Objectives</h3>
                        <p style="color: var(--gray-600); line-height: 1.6;">
                            This simulation teaches R&D portfolio management: balancing risk and reward across different project types, strategic portfolio composition, active portfolio tending (knowing when to persist vs. cut), stage-gate decisions, and the challenge of predicting innovation outcomes under uncertainty.
                        </p>
                    </div>
                </div>
                
                <div class="credits-modal-footer">
                    <button class="credits-close-btn" onclick="closeTutorialModal()">Got It — Let's Play</button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: REVIEWS -->
        <div id="phase-reviews" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <div class="quarter-header">
                <h2 id="quarter-title">Q1 Review</h2>
                <p id="quarter-subtitle">Review progress and decide how to manage each project</p>
            </div>
            
            <div class="budget-bar" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div class="portfolio-summary" id="portfolio-summary"></div>
                <button class="cockpit-toggle-btn" onclick="showCockpitView()">
                    🎛️ Back to Cockpit
                </button>
            </div>
            
            <div id="commercialisation-events"></div>
            <div id="review-cards"></div>
            
            <div class="button-row">
                <button class="btn btn-primary" id="next-quarter-btn" onclick="nextQuarter()">Submit Decisions & Continue →</button>
            </div>
        </div>
        
        <!-- PHASE: PROJECT COCKPIT -->
        <div id="phase-cockpit" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">3</div>
                <div class="phase-connector"></div>
                <div class="phase-dot">4</div>
            </div>
            
            <!-- Cockpit Header -->
            <div class="cockpit-header" id="cockpit-header">
                <!-- Rendered by JavaScript -->
            </div>
            
            <!-- Portfolio Grid Section -->
            <div class="card" style="padding: 20px;">
                <div class="cockpit-section-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button class="cockpit-back-btn" onclick="showPhase('reviews')">
                            📊 Tile View
                        </button>
                        <h3 style="margin: 0;">Active Projects</h3>
                    </div>
                    <div class="cockpit-legend">
                        <span><span class="legend-dot green"></span> On Track</span>
                        <span><span class="legend-dot amber"></span> At Risk</span>
                        <span><span class="legend-dot red"></span> Critical</span>
                    </div>
                </div>
                
                <div class="cockpit-grid" id="cockpit-grid">
                    <!-- Project tiles rendered by JavaScript -->
                </div>
                
                <div class="button-row" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showPhase('reviews')">📊 Tile View</button>
                    <button class="btn btn-primary" id="cockpit-next-btn" onclick="nextQuarter()">Submit Decisions & Continue →</button>
                </div>
            </div>
            
            <!-- Cockpit Detail Panel -->
            <div class="cockpit-panel-overlay" id="cockpit-overlay" onclick="closeCockpitPanel()"></div>
            <div class="cockpit-detail-panel" id="cockpit-panel">
                <div class="panel-header">
                    <div class="panel-header-content">
                        <h3 id="cockpit-panel-name"></h3>
                        <p class="tagline" id="cockpit-panel-tagline"></p>
                    </div>
                    <span class="panel-rag-badge" id="cockpit-panel-badge"></span>
                    <button class="panel-close" onclick="closeCockpitPanel()">×</button>
                </div>
                
                <div class="panel-body" id="cockpit-panel-body">
                    <!-- Content rendered by JavaScript -->
                </div>
                
                <div class="cockpit-actions-section">
                    <div class="cockpit-actions-header">
                        <h4>Your Decision</h4>
                        <span class="cockpit-actions-hint">Select to see implications</span>
                    </div>
                    <div class="cockpit-action-grid">
                        <button class="cockpit-action-btn continue" onclick="selectCockpitAction('continue')">
                            <span class="action-icon">▶️</span>
                            <span class="action-label">Continue</span>
                        </button>
                        <button class="cockpit-action-btn accelerate" onclick="selectCockpitAction('accelerate')">
                            <span class="action-icon">⚡</span>
                            <span class="action-label">Accelerate</span>
                        </button>
                        <button class="cockpit-action-btn reduce" onclick="selectCockpitAction('reduce')">
                            <span class="action-icon">🔻</span>
                            <span class="action-label">Reduce</span>
                        </button>
                        <button class="cockpit-action-btn champion" onclick="selectCockpitAction('champion')">
                            <span class="action-icon">📢</span>
                            <span class="action-label">Champion</span>
                        </button>
                        <button class="cockpit-action-btn kill" onclick="selectCockpitAction('kill')">
                            <span class="action-icon">🛑</span>
                            <span class="action-label">Stop</span>
                        </button>
                    </div>
                    <div class="cockpit-implications" id="cockpit-implications">
                        <span class="implications-placeholder" id="cockpit-implications-placeholder">↑ Select an action to see trade-offs</span>
                        <div class="implications-content" id="cockpit-implications-content"></div>
                    </div>
                    <button class="cockpit-confirm-btn" id="cockpit-confirm-btn" disabled onclick="confirmCockpitDecision()">
                        Select an action to continue
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PHASE: RESULTS -->
        <div id="phase-results" class="phase-content hidden">
            <div class="phase-indicator">
                <div class="phase-dot completed">1</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">2</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot completed">3</div>
                <div class="phase-connector completed"></div>
                <div class="phase-dot active">4</div>
            </div>
            
            <div class="card">
                <!-- CAREER OUTCOME BANNER -->
                <div id="career-outcome-banner" style="text-align: center; padding: 30px 20px; margin: -20px -20px 25px; border-radius: 12px 12px 0 0; background: linear-gradient(135deg, var(--primary) 0%, var(--gold-dark) 100%);">
                    <div id="career-outcome-icon" style="font-size: 4em; margin-bottom: 10px;">🏆</div>
                    <h2 id="career-outcome-title" style="color: white; margin: 0 0 10px; font-size: 1.8em;">Your Career Outcome</h2>
                    <p id="career-outcome-subtitle" style="color: rgba(255,255,255,0.9); margin: 0; font-size: 1.1em; max-width: 600px; margin: 0 auto;">Loading...</p>
                </div>
                
                <!-- NARRATIVE SUMMARY -->
                <div id="career-narrative" style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 4px solid var(--primary);">
                    <p id="career-narrative-text" style="line-height: 1.7; margin: 0; color: var(--gray-700); font-size: 1.05em;"></p>
                </div>
                
                <!-- KEY PERFORMANCE INDICATORS -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1em;">📊 Your R&D Leadership Scorecard</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #166534;" id="tp-count">0</div>
                            <div style="font-size: 0.85em; color: #166534; font-weight: 600;">Successful Projects</div>
                            <div style="font-size: 0.75em; color: #15803d; margin-top: 4px;">Funded & Delivered Value</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #b91c1c;" id="fp-count">0</div>
                            <div style="font-size: 0.85em; color: #b91c1c; font-weight: 600;">Failed Bets</div>
                            <div style="font-size: 0.75em; color: #dc2626; margin-top: 4px;">Funded but Disappointed</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #92400e;" id="fn-count">0</div>
                            <div style="font-size: 0.85em; color: #92400e; font-weight: 600;">Missed Opportunities</div>
                            <div style="font-size: 0.75em; color: #a16207; margin-top: 4px;">Would Have Succeeded</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2em; font-weight: 800; color: #1e40af;" id="tn-count">0</div>
                            <div style="font-size: 0.85em; color: #1e40af; font-weight: 600;">Good Rejections</div>
                            <div style="font-size: 0.75em; color: #2563eb; margin-top: 4px;">Correctly Avoided</div>
                        </div>
                    </div>
                </div>
                
                <!-- PORTFOLIO METRICS -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px;">
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--primary);" id="hit-rate">0%</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Hit Rate</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--success);" id="roi-value">0%</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Portfolio ROI</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--danger);" id="waste-value">$0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Wasted R&D</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--gray-50); border-radius: 10px;">
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--warning);" id="missed-value">$0</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Missed Value</div>
                    </div>
                </div>
                
                <!-- PROCESS FEEDBACK -->
                <div style="background: white; border: 2px solid var(--gray-200); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin: 0 0 15px; font-size: 1.1em;">💡 What Your Leadership Style Revealed</h3>
                    <div id="process-insights"></div>
                </div>
                
                <!-- COUNTERFACTUALS -->
                <div id="killed-reveal" style="background: #fffbeb; border: 2px solid #fcd34d; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h4 style="color: #92400e; margin: 0 0 15px;">🔮 The Road Not Taken</h4>
                    <div id="counterfactuals"></div>
                </div>
                
                <!-- BOARD FEEDBACK -->
                <div id="board-feedback-section" style="background: linear-gradient(135deg, var(--primary) 0%, #3d1f42 100%); border-radius: 12px; padding: 25px; margin-bottom: 25px; color: white;">
                    <h3 style="margin: 0 0 15px; color: var(--gold);">📋 Board of Directors Feedback</h3>
                    <div id="board-feedback" style="line-height: 1.7;"></div>
                </div>
                
                <div class="button-row" style="flex-wrap: wrap; gap: 15px;">
                    <button class="btn btn-gold" onclick="downloadPerformanceReport()">📥 Download Your Case Study (PDF)</button>
                    <button class="btn btn-primary" onclick="restartGame()">🔄 Play Again with Different Process</button>
                    <button class="btn btn-secondary" onclick="showReferencesModal()">📚 Additional References</button>
                </div>
                
                <div style="margin-top: 30px; padding-top: 25px; border-top: 1px solid var(--gray-200); text-align: center;">
                    <p style="margin: 0 0 12px; color: var(--gray-600);">Created by Ammon Salter, Warwick Business School</p>
                    <button class="credits-btn" onclick="openCreditsModal()">📄 Full Credits & License</button>
                </div>
            </div>
        </div>
        
        <!-- STAFF PROFILE MODAL -->
        <div class="modal-overlay hidden" id="staff-modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal()">×</button>
                <div class="modal-header">
                    <img class="modal-avatar" id="modal-avatar" src="" alt="">
                    <div class="modal-title">
                        <h2 id="modal-name"></h2>
                        <div class="role" id="modal-role"></div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3>Background</h3>
                    <p id="modal-bio"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Career History</h3>
                    <div id="modal-cv"></div>
                </div>
                
                <div class="modal-section">
                    <h3>Decision-Making Style</h3>
                    <p id="modal-style"></p>
                </div>
                
                <div class="modal-section">
                    <h3>Known For</h3>
                    <div class="modal-traits" id="modal-traits"></div>
                </div>
                
                <button class="add-to-committee-btn" id="modal-add-btn" onclick="addFromModal()">Add to Committee</button>
            </div>
        </div>
        
        <!-- REFERENCES MODAL -->
        <div class="modal-overlay hidden" id="references-modal">
            <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
                <button class="modal-close" onclick="closeReferencesModal()">×</button>
                <h2 style="color: var(--primary); margin-bottom: 10px;">📚 Additional References</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">
                    Academic research on R&D portfolio management, project selection, and innovation decision-making.
                </p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Brasil, V.C. and Eggers, J.P., 2019. Product and innovation portfolio management. In <em>Oxford Research Encyclopedia of Business and Management</em>. <a href="https://doi.org/10.1093/acrefore/9780190224851.013.28" target="_blank" style="color: var(--primary);">DOI: 10.1093/acrefore/9780190224851.013.28</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Brasil, V.C., Salerno, M.S., Eggers, J.P. and Gomes, L.A.V., 2021. Boosting radical innovation using ambidextrous portfolio management. <em>Research-Technology Management</em>, 64(5), pp.39-49. <a href="https://doi.org/10.1080/08956308.2021.1947605" target="_blank" style="color: var(--primary);">DOI: 10.1080/08956308.2021.1947605</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Boudreau, K.J., Guinan, E.C., Lakhani, K.R. and Riedl, C., 2016. Looking across and looking beyond the knowledge frontier: Intellectual distance, novelty, and resource allocation in science. <em>Management Science</em>, 62(10), pp.2765-2783. <a href="https://doi.org/10.1287/mnsc.2015.2285" target="_blank" style="color: var(--primary);">DOI: 10.1287/mnsc.2015.2285</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Cooper, R.G. and Sommer, A.F., 2023. Dynamic portfolio management for new product development. <em>Research-Technology Management</em>, 66(3), pp.19-31. <a href="https://doi.org/10.1080/08956308.2023.2178092" target="_blank" style="color: var(--primary);">DOI: 10.1080/08956308.2023.2178092</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Criscuolo, P., Dahlander, L., Grohsjean, T. and Salter, A., 2017. Evaluating novelty: The role of panels in the selection of R&D projects. <em>Academy of Management Journal</em>, 60(2), pp.433-460. <a href="https://doi.org/10.5465/amj.2014.0861" target="_blank" style="color: var(--primary);">DOI: 10.5465/amj.2014.0861</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Criscuolo, P., Dahlander, L., Grohsjean, T. and Salter, A., 2017. The biases that keep good R&D projects from getting funded. <em>Harvard Business Review</em>, March 17, digital article. <a href="https://hbr.org/2017/03/the-biases-that-keep-good-rd-projects-from-getting-funded" target="_blank" style="color: var(--primary);">Read article</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Criscuolo, P., Dahlander, L., Grohsjean, T. and Salter, A., 2021. The sequence effect on the selection of R&D projects. <em>Organization Science</em>, 32(4), pp.1046-1067. <a href="https://doi.org/10.1287/orsc.2020.1427" target="_blank" style="color: var(--primary);">DOI: 10.1287/orsc.2020.1427</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Dahlander, L., Beretta, M., Thomas, A., Kazemi, S., Fenger, M.H. and Frederiksen, L., 2023. Weeding out or picking winners in open innovation? Factors driving multi-stage crowd selection on LEGO ideas. <em>Research Policy</em>, 52(10), p.104875. <a href="https://doi.org/10.1016/j.respol.2023.104875" target="_blank" style="color: var(--primary);">DOI: 10.1016/j.respol.2023.104875</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Dahlander, L., Thomas, A., Wallin, M.W. and Ångström, R.C., 2023. Blinded by the person? Experimental evidence from idea evaluation. <em>Strategic Management Journal</em>, 44(10), pp.2443-2459. <a href="https://doi.org/10.1002/smj.3501" target="_blank" style="color: var(--primary);">DOI: 10.1002/smj.3501</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Kumar, A. and Operti, E., 2023. Missed chances and unfulfilled hopes: Why do firms make errors in evaluating technological opportunities? <em>Strategic Management Journal</em>, 44(13), pp.3067-3097. <a href="https://doi.org/10.1002/smj.3527" target="_blank" style="color: var(--primary);">DOI: 10.1002/smj.3527</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Masucci, M., Parker, S.C., Brusoni, S. and Camerani, R., 2021. How are corporate ventures evaluated and selected? <em>Technovation</em>, 99, 102126. <a href="https://doi.org/10.1016/j.technovation.2020.102126" target="_blank" style="color: var(--primary);">DOI: 10.1016/j.technovation.2020.102126</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Mount, M.P., Baer, M. and Lupoli, M.J., 2021. Quantum leaps or baby steps? Expertise distance, construal level, and the propensity to invest in novel technological ideas. <em>Strategic Management Journal</em>, 42(8), pp.1490-1515. <a href="https://doi.org/10.1002/smj.3269" target="_blank" style="color: var(--primary);">DOI: 10.1002/smj.3269</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Sharapov, D. and Dahlander, L., 2025. Selection regimes and selection errors. <em>Organization Science</em>. <a href="https://doi.org/10.1287/orsc.2023.17482" target="_blank" style="color: var(--primary);">DOI: 10.1287/orsc.2023.17482</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Si, H., Kavadias, S. and Loch, C., 2022. Managing innovation portfolios: From project selection to portfolio design. <em>Production and Operations Management</em>, 31(12), pp.4572-4588. <a href="https://doi.org/10.1111/poms.13849" target="_blank" style="color: var(--primary);">DOI: 10.1111/poms.13849</a></p>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 10px; border-left: 3px solid var(--primary);">
                        <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">Wilden, R., Lin, N., Hohberger, J. and Randhawa, K., 2023. Selecting innovation projects: Do middle and senior managers differ when it comes to radical innovation? <em>Journal of Management Studies</em>, 60(7), pp.1720-1751. <a href="https://doi.org/10.1111/joms.12874" target="_blank" style="color: var(--primary);">DOI: 10.1111/joms.12874</a></p>
                    </div>
                </div>
                
                <div style="margin-top: 25px; text-align: center;">
                    <button class="btn btn-primary" onclick="closeReferencesModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // ============================================
    // MOBILE SCROLL LOCK UTILITY
    // Prevents background scrolling when modals are open
    // ============================================
    
    const MobileScrollLock = {
        scrollPosition: 0,
        
        lock() {
            this.scrollPosition = window.pageYOffset;
            document.body.style.top = `-${this.scrollPosition}px`;
            document.body.classList.add('modal-open');
        },
        
        unlock() {
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, this.scrollPosition);
        },
        
        // Auto-detect modal state changes
        init() {
            // Watch for modal visibility changes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        this.checkModals();
                    }
                });
            });
            
            // Observe all modal overlays
            document.querySelectorAll('.modal-overlay, .dilemma-modal-overlay, .event-modal-overlay, .approach-modal-overlay, .credits-modal-overlay, [class*="-modal-overlay"]').forEach(modal => {
                observer.observe(modal, { attributes: true });

                // Some modals fade out via CSS transitions (opacity/visibility).
                // MutationObserver fires on the class change, but not when the transition finishes.
                // Hook transition end so we can re-check and release scroll lock once the fade completes.
                modal.addEventListener('transitionend', (e) => {
                    // Only react to relevant properties (opacity/visibility), but be tolerant.
                    if (!e || !e.propertyName || e.propertyName === 'opacity' || e.propertyName === 'visibility') {
                        this.checkModals();
                    }
                });
            });
            
            // Also observe cockpit panel
            const cockpitOverlay = document.getElementById('cockpit-overlay');
            if (cockpitOverlay) {
                observer.observe(cockpitOverlay, { attributes: true });
            }
        },
        
        checkModals() {
            // Some overlays are "hidden" without using the .hidden class (e.g., via opacity/visibility).
            // The old selector `[class*="-modal-overlay"]:not(.hidden)` incorrectly treated those as open,
            // causing scroll-lock to re-engage after closing a real modal (felt like the game froze).
            const candidates = document.querySelectorAll([
                '.modal-overlay',
                '.dilemma-modal-overlay',
                '.event-modal-overlay',
                '.approach-modal-overlay',
                '.credits-modal-overlay',
                '.lead-modal-overlay',
                '.review-modal-overlay',
                '.bootleg-modal-overlay',
                '[class*="-modal-overlay"]',
                '.cockpit-panel-overlay'
            ].join(','));

            const isOpen = (el) => {
                if (!el) return false;

                // Common explicit close state
                if (el.classList.contains('hidden')) return false;

                // Special-case: cockpit uses `.active` instead of `.hidden`
                if (el.classList.contains('cockpit-panel-overlay')) {
                    return el.classList.contains('active');
                }

                // For everything else, rely on computed visibility
                const style = window.getComputedStyle(el);
                if (style.display === 'none') return false;
                if (style.visibility === 'hidden') return false;

                // Many overlays fade via opacity; treat fully transparent as closed
                const opacity = parseFloat(style.opacity);
                if (!Number.isNaN(opacity) && opacity === 0) return false;

                return true;
            };

            const anyModalOpen = Array.from(candidates).some(isOpen);

            if (anyModalOpen) {
                if (!document.body.classList.contains('modal-open')) {
                    this.lock();
                }
            } else {
                if (document.body.classList.contains('modal-open')) {
                    this.unlock();
                }
            }
        }
    };
    
    // Initialize scroll lock after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        MobileScrollLock.init();
        
        // Initialize Meera's headshot in various places throughout the game
        const meeraHeadshot = staffHeadshots['meera'];
        if (meeraHeadshot) {
            const ceoEmailImg = document.getElementById('ceo-email-headshot');
            if (ceoEmailImg) ceoEmailImg.src = meeraHeadshot;
            
            const extraBudgetImg = document.getElementById('extra-budget-meera-headshot');
            if (extraBudgetImg) extraBudgetImg.src = meeraHeadshot;
            
            const extraBudgetGrantedImg = document.getElementById('extra-budget-granted-headshot');
            if (extraBudgetGrantedImg) extraBudgetGrantedImg.src = meeraHeadshot;
        }
    });
    
    // ============================================
    // SOUND SYSTEM - Fun audio feedback
    // ============================================
    
    const SoundManager = {
        audioContext: null,
        enabled: true,
        volume: 0.3,
        
        init() {
            // Create audio context on first user interaction
            if (!this.audioContext) {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }
        },
        
        toggle() {
            this.enabled = !this.enabled;
            const btn = document.getElementById('sound-toggle-btn');
            if (btn) {
                btn.innerHTML = this.enabled ? '🔊' : '🔇';
                btn.title = this.enabled ? 'Mute sounds' : 'Unmute sounds';
            }
            if (this.enabled) this.play('click');
        },
        
        play(type) {
            if (!this.enabled) return;
            this.init();
            
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            switch(type) {
                case 'click':
                    this.playTone([800], [0.1], 'sine', 0.15);
                    break;
                case 'hover':
                    this.playTone([600], [0.05], 'sine', 0.08);
                    break;
                case 'select':
                    this.playTone([400, 600], [0.08, 0.12], 'sine', 0.2);
                    break;
                case 'deselect':
                    this.playTone([500, 350], [0.08, 0.1], 'sine', 0.15);
                    break;
                case 'success':
                    this.playTone([523, 659, 784], [0.1, 0.1, 0.15], 'sine', 0.25);
                    break;
                case 'confirm':
                    this.playTone([440, 554, 659, 880], [0.08, 0.08, 0.08, 0.2], 'sine', 0.3);
                    break;
                case 'back':
                    this.playTone([500, 400], [0.08, 0.1], 'triangle', 0.15);
                    break;
                case 'forward':
                    this.playTone([400, 550], [0.08, 0.12], 'triangle', 0.18);
                    break;
                case 'error':
                    this.playTone([300, 200], [0.15, 0.2], 'sawtooth', 0.2);
                    break;
                case 'warning':
                    this.playTone([440, 440, 440], [0.1, 0.1, 0.15], 'square', 0.1);
                    break;
                case 'whoosh':
                    this.playWhoosh();
                    break;
                case 'pop':
                    this.playTone([1200, 800], [0.03, 0.08], 'sine', 0.2);
                    break;
                case 'ding':
                    this.playTone([880], [0.4], 'sine', 0.25, true);
                    break;
                case 'coin':
                    this.playTone([988, 1319], [0.1, 0.2], 'square', 0.15);
                    break;
                case 'levelup':
                    this.playTone([523, 659, 784, 1047], [0.12, 0.12, 0.12, 0.3], 'sine', 0.25);
                    break;
                case 'dramatic':
                    this.playDramatic();
                    break;
                case 'chaos':
                    this.playChaos();
                    break;
                case 'meeting':
                    this.playMeetingStart();
                    break;
                case 'reveal':
                    this.playReveal();
                    break;
                case 'typing':
                    this.playTone([800 + Math.random() * 400], [0.03], 'square', 0.05);
                    break;
                case 'slide':
                    this.playSlide(400, 800, 0.15);
                    break;
                case 'slidedown':
                    this.playSlide(800, 400, 0.15);
                    break;
                case 'boost':
                    this.playTone([300, 450, 600, 900], [0.08, 0.08, 0.08, 0.15], 'sawtooth', 0.2);
                    break;
                case 'bin':
                    this.playTone([600, 400, 250], [0.1, 0.1, 0.2], 'triangle', 0.2);
                    break;
                case 'build':
                    this.playTone([350, 440, 523, 659], [0.1, 0.1, 0.1, 0.2], 'sine', 0.22);
                    break;
            }
        },
        
        playTone(frequencies, durations, waveType = 'sine', maxVol = 0.2, vibrato = false) {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            let time = now;
            
            frequencies.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = waveType;
                osc.frequency.setValueAtTime(freq, time);
                
                if (vibrato) {
                    const vibOsc = ctx.createOscillator();
                    const vibGain = ctx.createGain();
                    vibOsc.frequency.value = 6;
                    vibGain.gain.value = 10;
                    vibOsc.connect(vibGain);
                    vibGain.connect(osc.frequency);
                    vibOsc.start(time);
                    vibOsc.stop(time + durations[i]);
                }
                
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(maxVol * this.volume, time + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, time + durations[i]);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start(time);
                osc.stop(time + durations[i] + 0.01);
                
                time += durations[i] * 0.7;
            });
        },
        
        playWhoosh() {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            const noise = ctx.createBufferSource();
            const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < data.length; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            noise.buffer = buffer;
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.setValueAtTime(1000, now);
            filter.frequency.exponentialRampToValueAtTime(3000, now + 0.15);
            filter.frequency.exponentialRampToValueAtTime(500, now + 0.3);
            filter.Q.value = 1;
            
            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.15 * this.volume, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            
            noise.start(now);
            noise.stop(now + 0.3);
        },
        
        playSlide(startFreq, endFreq, duration) {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(startFreq, now);
            osc.frequency.exponentialRampToValueAtTime(endFreq, now + duration);
            
            gain.gain.setValueAtTime(0.15 * this.volume, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start(now);
            osc.stop(now + duration);
        },
        
        playDramatic() {
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Deep dramatic chord
            [130.81, 164.81, 196, 261.63].forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.value = freq;
                
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.08 * this.volume, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start(now);
                osc.stop(now + 1.5);
            });
        },
        
        playChaos() {
            // Fun chaotic office meeting sounds
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Rapid succession of tones
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const freq = 300 + Math.random() * 600;
                    this.playTone([freq], [0.08], ['sine', 'triangle', 'square'][Math.floor(Math.random() * 3)], 0.1);
                }, i * 80);
            }
        },
        
        playMeetingStart() {
            // Boardroom meeting start sound
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Gavel sound (thunk)
            const noise = ctx.createBufferSource();
            const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.2, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < data.length; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.02));
            }
            noise.buffer = buffer;
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 400;
            
            const gain = ctx.createGain();
            gain.gain.value = 0.4 * this.volume;
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            
            noise.start(now);
            
            // Followed by attention tone
            setTimeout(() => {
                this.playTone([523, 784], [0.15, 0.25], 'sine', 0.2);
            }, 200);
        },
        
        playReveal() {
            // Mystery reveal sound
            const ctx = this.audioContext;
            const now = ctx.currentTime;
            
            // Ascending arpeggio
            [262, 330, 392, 523, 659].forEach((freq, i) => {
                setTimeout(() => {
                    this.playTone([freq], [0.15], 'sine', 0.2);
                }, i * 100);
            });
        }
    };
    
    // Auto-init on first click anywhere
    document.addEventListener('click', () => SoundManager.init(), { once: true });
    
    // Global click handler for automatic sound effects
    document.addEventListener('click', (e) => {
        const target = e.target;
        const classList = target.classList;
        const tagName = target.tagName.toLowerCase();
        const onclick = target.getAttribute('onclick') || '';
        const text = target.textContent || '';
        
        // Skip the sound toggle itself
        if (target.id === 'sound-toggle-btn') return;
        
        // Determine sound based on element type and context
        let soundType = null;
        
        // Navigation buttons
        if (onclick.includes('showPhase') || onclick.includes('Continue') || text.includes('Continue') || text.includes('Next') || text.includes('→')) {
            if (text.includes('←') || text.includes('Back')) {
                soundType = 'back';
            } else {
                soundType = 'forward';
            }
        }
        // Back buttons
        else if (text.includes('←') || text.includes('Back') || onclick.includes('Back') || onclick.includes('prev')) {
            soundType = 'back';
        }
        // Confirm/submit buttons
        else if (onclick.includes('confirm') || onclick.includes('Confirm') || text.includes('Confirm') || classList.contains('btn-gold')) {
            soundType = 'confirm';
        }
        // Meeting start buttons
        else if (onclick.includes('startCommitteeChaos') || onclick.includes('startYear2CommitteeChaos') || text.includes('Start the Meeting')) {
            soundType = 'meeting';
        }
        // Selection cards/tiles
        else if (classList.contains('model-card') || classList.contains('staff-tile') || classList.contains('criteria-option') || classList.contains('approach-option')) {
            soundType = target.classList.contains('selected') ? 'deselect' : 'select';
        }
        // Project cards
        else if (classList.contains('project-card') || classList.contains('portfolio-item') || classList.contains('legacy-card')) {
            soundType = 'pop';
        }
        // Bin/reject buttons
        else if (text.includes('Bin') || text.includes('Reject') || onclick.includes('reject') || classList.contains('bin-btn')) {
            soundType = 'bin';
        }
        // Build/accept buttons
        else if (text.includes('Build') || text.includes('Accept') || onclick.includes('accept') || classList.contains('build-btn')) {
            soundType = 'build';
        }
        // Boost buttons
        else if (text.includes('Boost') || onclick.includes('boost') || classList.contains('boost-btn')) {
            soundType = 'boost';
        }
        // Modal close buttons
        else if (classList.contains('modal-close') || text === '×' || onclick.includes('close') || onclick.includes('Close')) {
            soundType = 'whoosh';
        }
        // Tab/toggle buttons
        else if (classList.contains('view-tab') || classList.contains('matrix-toggle-btn') || classList.contains('tab-btn')) {
            soundType = 'click';
        }
        // Slider handles
        else if (classList.contains('slider') || tagName === 'input' && target.type === 'range') {
            soundType = 'slide';
        }
        // Generic buttons
        else if (tagName === 'button' || classList.contains('btn') || classList.contains('btn-primary') || classList.contains('btn-secondary')) {
            soundType = 'click';
        }
        // Clickable cards/divs with onclick
        else if (onclick && (tagName === 'div' || tagName === 'span')) {
            soundType = 'pop';
        }
        // Details/summary elements
        else if (tagName === 'summary') {
            soundType = 'click';
        }
        
        if (soundType) {
            SoundManager.play(soundType);
        }
    });
    
    // ============================================
    // STAFF HEADSHOTS - Base64 encoded images
    // ============================================
    
    const staffHeadshots = {
        'meera': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCABDAGQDASIAAhEBAxEB/8QAHAAAAQUBAQEAAAAAAAAAAAAACAADBAUHBgEC/8QANxAAAQMCBAMGBAUDBQAAAAAAAQIDBAARBQYSIQcxQRMiUWFxgQgUMpEVFkKhsTNSwURiY3KS/8QAGgEAAgMBAQAAAAAAAAAAAAAAAgUBAwQABv/EACQRAAICAQQCAgMBAAAAAAAAAAABAgMRBBIxQQVxM8ETITKB/9oADAMBAAIRAxEAPwChitmrWKxextTEZre45VaRE8h0rQAPMMgAbb1aRI9xyr4iNarbVbRWgnapIKfMmK4XlrBHsWxeQGIzQ52upauiUjqo+FYZjPGfMeKTVIwRETCYeqyFuAOPKHqdr+g96pePGclZkzW9GZcKsMw9RZipSe6tQ+tz1JFh5CneGXDTH80QxLjvNQozn0uKRdShWW2+NazJ4RfVRKx4issnNcWs3YdJCH5iJh0nU29HRYefdsf3rR+GvE6HmTEhgeLMNYfiqxdjQolqSOfdJ3Cv9p9qpcW4CKwzApMiNNW/PU0U6nORvztWIY0h/D8QZWlTkWZFKbEXCkqSdlA0FOpjY3t6Du0s6ktyDMdjgpO29U8+KU32pzhXmRnOGSYeMEpErT2UtCf0vJ+r2OxHrVtPjhV9q3ReTIzkHGrK5V8dmat3opCjtTLjIANqMErFI35UqecbIWQQftSriTxhg7CxN6nwm9KvOvthhPPep0dpKr6U9L8qEImQkBKeQuaquJ2MKy9w+xfFEnS6hgttG/6l90fzVzGRuAazT4qpDzfDiJGaBCH8QQly3XSlRA+/8UEnhHLkGrBWvncWjsOXWlSxqHO4G5+/+aLbhjmbLsAsYOe0bf0gDSpC0A+BKFHSfIihm4TxmnM4xhKQFI5KB5WII/m1E4xlbKmX4DKowjIkSVNpBcULpAO2/lvakmtlFy2seeOrnsco/wCnU5yzvgOEPpwyaHA6sbrcWhppPqpZG/oDQ1cf8FZeWnM2GJShkqDb4SoKBv8ASoFOxFEbjGAZXzDiL34oqM84lwAOAhQCuYBI5eVcXn/K+Evx4uUsNioREcdSFJaF9tQJPrWaq2MJKXffo13USshKL469mX/C9mV3BM5v5bnlTTOKIGhK9tLyRdP/AKTcfaiXl20mwoMs3ynG89TMewRQQzBlpTHKRp09mbC46XKb+how8uz28cyvh+MMiyZkZD2n+0kbj2NxXoKJNx/Z5u6KjJpEJ4aiRblTCmAQVGrZyMfCoshvuG1aCoo3kguHpSp58EOEab+1KpIJMYNadO/KpjK0NghJ57VUJfKQNjTjT+vZR3ocBl1HcGrp61xXxAYDOx3h4r5BkvvQZCZRbTzUgBSVW8SAq9vI11MRW3Ooue3cabyfiBwBpL8/sSG0EjvAixtfa9j1quXBK5BEw3FXsDxCNKaJLC0tpkosCVpBvYE8jt0ohYKRmPDYUjApRdbcSO2aVpdS4PEat0ny9aGjEEOgrjugIKDbSo7i1aBwal4zh1ncOkLb0u2SDulQPW3relWsrzHeuUNNBc4S2dMImLg+KMxinFJhjYalu3yzbKG9Z8yBcD0N6yDjTm2XAlQE5ZlyICm5BvMZdIVqSNwlXl1Nd83EzNmh1DOM4otuEjdaGUlAUPAnnWWfEIlqNjMLBo7KI0aOwFoXcAAKuOXTkedYtIlO5djDW2P8LfBnKA2y0hanVFMoXXfck77+tGnw8ZixslYaiGtC4qmEKaUk3BSQKBglT7jbDaipCNgRytfc0V/ACXh0TKDeGs5lj4ksEqQx2lnGb76dBsRby2p9Wnk87Lg0mWUb2qpkLIBFTJbg0kfqP3qolLIJ3v61piVER1Y17nelUZ0XWSaVERkbQtRNjY+9fba7KFrVEDgKSQn3r0OEJ7u5t0oAyn4iZ9TlKIw2xGblT5JPZoWohCEjmo2357AViua885ozIFtYhijwjK/07B7Nv3A5+96l8XZy5mfZTSlgpitIaQAfp7oJ/dRrlAAACfC9RglEWFh/byEoTq76gAjxJPKiYyxkpMP8vJYaCUrw1kSFW7uoBVzf/vesi4MZYnZnzglmEwXhDbMtxI8EkWHqSRRK5cdlISMNMQyUBR7NohSXG1HmARva++kjnflSbydu3EEN/GU5zM8waO40uSFuNpQ2SO1OwCUi6lHwA6mhdznjCsbzLiWKOOdol99RbP8Axg2QAPDSBRDcfcRxDL3D9THyf4erFXflm0k2WpP1LUb94gJsOgurzoZCALnkB+1W+J0+2LsfYPk797UFwiG6UuKSW0aegFrXp5ptSFBaVFK0/SUmxB8jXjAJcW6r9IsB4V78wgcye7z23uelNxUdjlziJmjA1MoXiT0+IgjWxJOu6eoSo94fet2jz0TYLM2OoKYfbS6gnqlQuKFglakFShpvyT1963nhJJVJ4fQQVlRYU4yT4BKjYfYiuBZ1CnWSokqNKmF6dXUUqIgiN3KDuabKikqsSOdKlVSCYPueFqVnrGiTc/MK/wAVWu87eQpUqhcBBN/AtGYUrMslTSS8BHQF9dJ1m33Arbsjx2PzZijnZp1tqcKD/aSux/alSpTrPmh7+hlpfhn6+we/jSlSHOJOGw1uqMdjC0Lab6JUtxeo+p0p+wrB3+QHQnelSptT8aF0/wCmNo/oepN/vTEYAuuKIuQdqVKrAR9RO+/Ktl4GLV+T5idR0icqw9UJpUqkh8HYPkhw0qVKuBP/2Q==',
        'farhan': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCADIAMgDASIAAhEBAxEB/8QAHAAAAQQDAQAAAAAAAAAAAAAAAwAEBgcCBQgB/8QAQBAAAgEDAgQEBAMGAwcFAQAAAQIDAAQRBSEGEjFBBxNRYSJxgZEUocEIIzJCsdEVUoIWJDNicuHxJUNTY/CS/8QAGgEAAgMBAQAAAAAAAAAAAAAAAQIAAwQFBv/EACYRAAICAgICAQQDAQAAAAAAAAABAgMRIQQxEkFRBRMiMkJxkRT/2gAMAwEAAhEDEQA/AMEUZo4AA7VhGM0YIcCtmCo8GO9ZKNyBSKPnYbURFIO9EgWIDlwcUZQAMg1hGNvajIm1Ah6g2O1EVNs16i4o6JkbVAAlUA0TJ26VpOLeJtL4ZsvxOoSjJOEjB+Nvp6VS3GXiprmqc8Omg6fanIBJw7D3PX6CllJIKi2X7eajp9ivNe31tbn/AOyVVP5mtDP4gcGxSNG2vWvOvXly39BXLj3t9c3JaSUzHOSAu/3/AL0eJLgkFXYMT0Iwwqr7r9D+J09Bx/whKMDiCx32GX3+1ba01fS7sBra/t5s/wCWQGuV42tokKXQ7Zy6f3FFtpvw2JbR/MQDmxGxVh7rv/Q0VYyeB1azI2Mbj2r0RnFc76Dx9qWmXUTvfySwOByiU8wIz09Qauvgriu0162jOySseXY5BI3+m1WxmmI4tG/WPsaTx5HpThFDbjBNIjuKYA1MQxkihFM5wNqfFc59KD5e5qENfKuQdqCRhcVsJUPXrTWRD1ooAxlXrvigONsbU8kU8xzvtTZ060SDcjr3pUbl9B86VEhnH13xRY/TrQ4lLGnMSb5FIMj1QMYIrKNQTRI4/U1msBJ2O3pUIKOPHypwij6V7DEeXlYfnRo0GDtQIJUHLmtJxzxLZcL6JJe3DjzWHLDHnd2+VbyRlhiaVzhUBYn0FcteKHG11xPxHcTIUOn25MVtFjblB3f3JpJywhorJo+I+IdR1jV5dQvJXd2c8vNuQM9B2Fam6vOeXmaP48dM00ku5SzYIGeg64o1hay3ClijkZ6jbNZs/JYlnoewvflOdm5Iz/l/808tL2MRur3jcw/kAK/+aLpdneA8sEUyjHb++5p9b8Iarqdx+7hYrzfzHJH60jtjHtlsaZy6Rq21eFTlQ8xGxUsdx7H1ps06yq0trzo67lCME+4I6/XerJsvCiZrdZWB5sfEM9PpRo/Due3PI0BbJyMEbD3qj/rr+TQuDb8FU3DT3Nqo5SHBJz6981I+A9e1XTpOWyuOViwOSOh3G33qcLwaLdyJYgoCnA69fU1X2p2N1pWqsscMjIGOy7Eew9RVlV8ZPRVbxpVrLRbOg+Kt3ZTCPWlEsZOPMjP6f96t7SL+11XT4r2ylSWCUZRh/Q+hrkfUxzxpPuFcdcYz9T/Q1O/BLjKbQ9UTRruZXsbpwUJbaNjsCPQHpWyFm8MyOPwdEBRk5rxgMdKJGAwDA5VhkV4Y8DptV4g1dAcmm0iqafFdz2FBZNqKFGEiDfam5iHU9a2Lrt0zQHXaiiDB4/TvSpzKu2O9KiQbxL2xTqMfDTaLIOM04RSBknr70mBg8a7bdaPBGOp+1Ci+HpvmnMO3WhgIUR7ZHbtiskQ4zRIsYrMDuNqBCIeLOof4bwFqUgJDyx+UoUbkttj2rkjUQTcMGUoCB7bV0z+0bK6cDxQocLLcqHI64GTtVAcP6Umo3yg5MYcZB3BHWs9zwyyuOdGHC/Ck2p3AmZCkIwTnvVvcMcC2ZMSvECuOmKx0WxjgCxouMYNWNwvEhCZ2YYG9cPk3ybPQcPjwitmGn8I6fBEI44VX12rc2XD1tbgGOJPotSK0giKq2M1so4VP8q8oFZVFy9m/yUfRHDpw8sYjG23SsJtPAjJMQGepFSxEjJI5FpnqUaCPYDf1qOvCyFWZIDqemxMGONqg/GHDltqVjPHIi+cFJRgParM1NOvXPoBUc1BFEHmsc8p3x3FSubi9C2VxlFpnOepedHpkkDR+aIn5HVk374IPcbVprR5Yr4zQK6xEYdTtsasDjuxjhuJWt5DGJCWTPTI7VDdRnjuGXkw0hTcp1HY59a9FXLyimeUsj4SaOsPDe/bUuBtJvZZPMke1UM3qRt+lb8DmzuNqhHgK7SeGensyqMc67ddmPX3qclfQ1tj0Z2N3BGdqCQ3cbdqdyJjHf1oTjHanQo1KkHpQnQb07IyetBmUAEfnUIMmXOfUUqJgqdqVEhr+VgcDJpwgPKAQaziQHtRljJHSlGweRIScU7jQ4zmhwKQck06iwdqBDKHOOlGI2GK8SNhuOlEUdsZPrQIVl+0RBI/AwkSNpBHOrsANh1GT96pLg0GG6SPGWx2P3rpPxZsVvPD/AFWNk5zHD5ij3XcVzhwdHJLrphXlIjTzGI6AE7CsnJ6Zo4/7ItDRcElzsRU54ajLSAhSRUG0IJnmlZUUnGSepqeaTq2l2kKI93Chz3kFcGytuWj0dNkYx2TazDcoPLtTxnZY+uRWtsNXs5ov3U0Tnp8LA1s4Zre4J5eg7UFFrRd5J7FEJH/hXamt8kgBXv64rHUeI9K020ke5ukjWMHmOcmoVqHjBwjlooLkzFTjIQ9frTqmU1oqlyIQezaajkSnnxUY1RCUmUElTvQpeP8ATrmUFoZDE/VgucV6mo2F15htZlkXoR0Kn0Iqt0zg9odXwsWIsqTjIJOz2vMwkWT6r7/I71FlsIrQZZwXwHjPr1BH5VZfiFo0Z/8AUoByshCyY7jsfvULntC5iXzkOckowyMbg/YiuxxZKUDgcutwseS+vBCNx4dWLMMc7OQMYwOY1N0QdBUc8J4RF4d6QuVJ8nOVOR/EelSmNcAmupHo5z7Asg603dAMmnrrkGm8iHB7mmQBjIMnagyEdCacypjfFBkQMvpRQBtjAyaVE8r0O1KiQbxjlGKOqHGSTXiIMnbIrIggfDSDHsA23p3GR7U2U4ODThUBxy7YoBTHCHbc0ZRisIlBGDmjCPfA3pQmv4ghjm0S8iuHVI5IHQsxAAyCO9cocN372HEl7pNpY+fecojZnlCRoE6knBJG46Cuh/G83K8GxrbyGMm4XmIHUAE4qhNF0+FeI5Lx4QGdfJP/AFOhZD9GjA+tY7rFKfgzXVTKNatXyeXE+r3uptHJqQhEfwjykwiD2JNBvdL0aLDPxM0t0f5cDOfnTzWdHu508q2PIJPiZhvTtuGVlFi8DyWMkERieW3bDyg5z7gkE565zWdSS94LvCT9ZGvDevSaCwe2urmXBDDmlBB+R3BH1qzeFfFbWb6wnurHgXWr2ONTzTRMpjGOp6ZI+QqDcU6NHacPJNBaxxG1txHH8HKZANhzY6n+9XP4M6b/AIbwTaoAOdYsH5/+az8iUFiWMmziQsk3FPGiptd1e81u2TUbuQQQ3i+atvbg4VT0yepP2qM2V5ZaddRStpbtFNL5ayGTkBbvlug6jqdqsPTuG7iLiTV9HZx+H5fMt4CMZjdyQQfQHKED0GetEuuDri5C2Wo2v4m0STnWIfwqemw2x8qeE4r3orlXOS62RmPjbSZ4h5NvLbZygZ8sCe+/9s1pdbOqYt20y/njnuJxHzrM3KVKscnr0x2qfzcBWs0EVqunGKGNsohGy75yKxs+FoouJrKyEZKQxS3UiknYYEa/cs3/APJqPkJdMC4rb2v8I1Z6TxLfaP5dxrs8yJDiRmBw5G/femXC3CS6vxArS6rLBDCgedsZyBkYG+2e3zq0Gto7eGaGNcDBwPSo94eS2Frrhku7eSVGkUsETmGQDgE+maSu+X25Mtlxo/dgnsm/DWpXunajZ6TbWEo0mMLDGzyfEB68varD5CFOKjTRrcXSzpHyZUFR6EEfpUoVT5QznOBWz6dbKSabKPq1MIOLisZAMPSgyL6mnaKCDkVi6LjNdNHGwayfm9KAQTvT+VQcjGxpuYsDC5pkAaOoAyKVHeEAZzvSokGYZexrMEc2MUNE+LBFHVckdKUY9RAx32o8KjcZrBOXGMb04hUc21AiCohB9RThVI6GsY8Y3owHw7UoSN+ImmSarwheW8QzJGvmp/p6/lmqEWIi9lVfhYwwurY/hZWJB+hrp8x88LxtvzKR965veBotSkEgICOYjn2Jrn8uOJqSOlxJeVUov0brR4pXUM2lFxnCmK5TG/s+Dit4FljGE0SYkes8QH5EmicIRW7Dm2JB61PYhCbLPwgYrkSm8naqoj4p5Kh4ns9R1HULSO9gjt7RWVhDGxdpGByOZiBsDg4A643q6ODrOK30FUA+FVHWqn8QeJItO1EyG2eRUChCgHruKl3DviLpEmhKYriIK8R5wx3U+h9DTYbiskg4wk0nsy4ysEnu0vLV5bW6tGJiuYwCVDfxKwOzKcDIPoD1FOLKw4wlt0Y3thMpGQ34JSSO38w/pWjTjC5nuvIHD948M+0c2V5T81zkD3NTawmFrZwFH5ggCuAaV5itjpQntDGLh3ia5B/EakYMb5ghjQ/chiKapoy6Sk8o5pZpiPPnkYvI+Mhck9QM7DoMmpc2qRhPhcZYdM1H9Wv05WHNl32+VJKWdBUVHZC9ePJdjlOAy7etOfDGysLSDUIZ4+aJ5CzFjkj4dvz/AK021dRLebH+EfethwJbJLfXE7IHETALkkANjv67VYtRM6adibJXp0aefaRKpHMGbf0JAH61I+XvjatRo1qI7s7cxXLs+c8xOQB9N63g9q6306DjVl+zlfVbFO5JekB5B6UGRc52p4FAyD0ocijJ9K6CZzDXMu+D0oTkDbtTx4859KbMg6ZplsUayYJPWlWUwwNt6VMQ16cx3xTiOPagxkjAztR4pCNiMgUowSKEY604ijXbNDz8Pw0WFvhwetKHAdI1652oqLynA6UJMhetEiySc1CBVjyc1RHH1jJacR3kcqCL98zoBsGB3BHrV9xE436GtfxPpcWraFe2bQxtNJbusTMgJVsHGD23xWe+r7i/ovot+03rspnh29eGZU3wwBqQSa1MkXlQZywJx8qhNhcFLdQ6kSI2D7diK3V1bSSWqXNtKOdgFORnHvXDcPy2dyFr8Hg1uswLrIkEvKhO2M7ZrzTOCxDCl7BbKZSNix2Yg9Me9adtP1xNRMLamio5yQkOHP1JxUu0fS7yKFRbcSy24YfEjrjPqR8VX58VhC10uzbZKLa1aAI88QRwo2B746VlNqEEUgQytEvb55rT3XDdsbVXj1y4uZCclkmCfmKZW/B1vdlhNeX1zvsHun5E/uaVteyyVTitMkiXj+cVSQPGdxtmgSrPLOkit8AxsT2oGiaZHYySQs/MqbKGOf60d7kICQRgfw1nkll4JGb8cM1upyIlyzfzMOn3p/4df4jPd6hDaJC8XKruXfHxdvyqMa7qKNORkhh1qc+CcbNZalekbSyooPyB/vWvjUqcsSMt98q15R9E20eyktYHa4kWSZzluUYVQOgH96e4GM5rwsCp2rAA4IzXZhFRWF0cayyVknKXbMufI2oLE5xmibcuNqBI+BTIQxZgNu/zpvKBXsrH+IGmjSNzZ9KZIBk2BnpSoMkgxvSpkA16zEDlwKLHLt8NNQFJO5rJDgE9aAxsEkwPWnETgjc1ro5MDGD86MJNwNxQwQ2iSduop0jDl3xWqiZsZ39qdwuw9TS4Ch7Gx9c0dCS2TnamsRJ3zTmN8DlPelCUp4u6F/gnEL6hEvLp2okupHSObqy/X+IfM+laDSb88q25csuc/Kr94g0iz1vSZ9M1CPzLeYb42ZT2ZT2IO9c28a6fqHBfE/4C7kWZMB4p1XAkjOcEjsdtxXPvoxLyRuov14slctomolebmB2ww2INOLXQ5Byq8RmYHYsM7Vp+Fda82XzGcFDgddxU40y4Vud4WBwuwJ6VieYvB0IeMlkx0Ph0Rx80isEB+FOfY1sZf3KeXAVHrg17DqtuLXEw5WQ71pNb1m3trVnEgGMn3zSvLY2ooHrVzHAx5ZAWKkk5qJ6lrBgh5i+Sdzk1pdQ19ppn5ccudhWsjFxqdwyEERj+Ik/lVypxuRmd3lqI/wBMa71W/wAopYu3Kq+tW1xZa6xwZwNbahodyIrrT2WW6ibeO4VtnVh7bYPUYpx4LcD+TCvEF/Fyxgf7ojDd/wDn+Xp60v2htUj0/gmazJAmvpBEgzuVB5mP2H511+FRiLnJdnO5VuWoIk3A3E9jxXw3Bq9lhS3wzRZyYZB1U/p6jFbpnxXIfhpxrf8ABvEJuoeaWymYC6ts7SL6j0Ydj9K6o0XWdP1vS4dT02dZ7Wdcqw6j1BHYjuKtawZzYlxjNNpT8ZINeOzDfqKbu5JJ7VEQ9eQZ9KaXD8uRkb1lLnds00kBJILbU6FPVbPfNKgrsdiaVEg2RgW67UUAKPX5UwTOdzR0nCggmlCh2rDG24pwhyBsDimEUuBkDNHjkOPShgOR/H8XU0+iYJjfatbC2R+tOYmwNzSsKNjG69jRVkA3PrWsnvLazgM11PHBEoyzyMAB96rfjPxw4c0cPb6RG+r3QOMoeWIH/q7/AEpQlwiVSvWuffG7VbXXtUjurMiS3tXksxINw7Ifix9c/aoHxP4q8W69DN5+ofg7cg4gtfgG/YnqalnAWkDVPCbTrYtyzSh5o5DvyuXYg0k4ecWkNCXjJNkLtJruxk8y2kK77qelbmw4y1O0UxtEWz3U02e1ljnlt54jHPG3JJGeoP8AbvRLfR/PblVWDZ7VzHKP8kdKMJfxY6bifVrhmIRl5um/am8899eOPxMhEYH8OckVs7bQJgV+In51INI4SmvLmOC3hkuJ3Pwoo/8A2B7mjG2C/VbC6pv9nohdjp8t3OFjTAB3bFXh4W+FTP5WqcQQeVZphorQjDTHsX9F9up9qmfh34a2GiLHfakkd1frgogGY4fl/mb3P0qwnUBScV0KeM3+Vn+GG29JeNf+msmAAAVQqgAKoGAB2ArkXx74qXiHje4it3DWNgDbQEHZiD8bfVtvkBXQXjtxb/srwVObeTl1G+zbWuDupIPM/wDpH5kVx5OCx3J+tdD0Yhoi5kNS3gfjPW+EGlbTXjltpfikt5gSjEdx6H3FRqKLDe1OJwFtpCP5UP8ASlxoYvnhPxj4d1VUi1VX0i5Ox8w80JPsw6fUVPYrq3uYlntpo5oWHwvG4ZT9RXFkVw2BvkVuuH+I9W0S487S9QntT3CN8LfNehqvCGOtZPiJx2oMoXBHNtVN8OeMVyFWHW7JJges8B5G+qnY/TFT3SOMuHtWQfhNTjWQ9IpjyP8AY9fpRSFN8zFScNSptI/MM9z0pU2AZG3NvgV5GFLHNeYPN7Vmqg5INKMEizjrt2p2h5hvsKhPEHHeh6HK1vNM01wvVIt8fM1W3FfinrOoqYLFvwNv/wAh+M/WlbIkXlrPFGiaFAX1K/hix/JzZY/Sq04q8cAvPFoFgMjYTTn+i1S15ez3UjSTzPKzdWZsk00Yg0jGN1xNxbr/ABFcmTVNRnnHaPmwg+SjatRHGWYrnJoMgYLkHcUaOXKfCME9aATC/bEflodh1I710z4S2QTw/wBFjK/ELVCfrv8ArXN+l2bX1/FaqCTIwX+9dT8BwNb6NZ22CCkKrg/KrK17EkzLiXgtNbi/E2ipFqMS/Cx2Eg/yt/ftUBgSfTb14by1kjlQ4dGGGU/29633iD4w2+gzXWjcNLDd6rD8MlxKvNDA/wDlAB+Nh37DpvUGsPFjXBGx1NI9XvHz/vF5FG3lg9QqqoAX2JNVcjhxu2uzRx+Y6dPaLS4S0LUeIrhfwsXkW4/juHXIUe3qfYVdPCvDdjolp5VpGec48yV93kPqT+nSqw8DfFCxvrS20biRbbTr1m8u2uEASCfJIVSOkb7dP4T2wdqvSKLHUfSpRw48fvsF/Llf/QoECr7UG8LKhwPpTvG1Qvxf4mThbgXUtVDYnWPyrYdzK+y/br9K0rbM76OZf2g+Kv8AaDj2eCJw1lpmbWEg7Fgfjb6tt/pqt3327USR2kZmkYuzEszHue9AVgjbgsvt2pwBkGMZFK7YfhpV7lD/AEpNLEimQuoUDqTsK1NzqjTFo7ZOYHYyN0+nrQbSIMoSSgHtRBmvFTy19cCvCTnFVDjiNz2NHjnb1FM1BXvvRI/c0UAlGh8Ya9pGBaajL5Q/9uT40+x/SlUfUZXrSopAOoTMpGB96iXidxKeHuH38hsXU+Ui9vU1JEfCnv6VQfjLrJ1LiaaJX/c22IV9M96UKIn+IllZppWLO5yxJyTWBbmzvSjG2AOle8o37UgwLG9evyqBkURV+KsJ+ijNQgFmzkdBSjyCQK8VRSU7mkGJn4W2f4jiWAlc8qs/T2wP61fOvT3llor2mlBhqFxGVjZR/wAFOhf59h7/ACqq/AvSp7vVbm4SIyJbwpnHck5A+uPtXR1lo6RaZ51wFkuZRzSOB9gPYdBWuCSislD22cj8V6HPo97EkwP7wEZPUkev3o2i2MEFs2o3hIRdxzd+v9vzqaeP8CxX1hFBGXmzJKwB3WNQMt/+9KgXE1wLltP0u0b4CqnBVl8xmAx1x3q+rCyyufwEml1Tiq4XRdIt2EUnwnAzkDG5PYbCumfBbxEv+H2teC+OLqa4jjRY7XVpdyh6BJj6dg56dD60vCDw6teFtAjaeFZtSmAadyOh7KPYVYZ4W0uXTJYrm1icyKTIxUHNV2SUnsaCaRN3Ixtv71zB+1vxOLrX7Hha3kzHZR/iLgA9ZX2UfRd/9VXBpmoT8F6BPJfzyXuiWsbMjtvLaqBsv/NH29V9x0474m1m41/X7/WrskzXkzStnflydh9BgfSq0sD9mrJIU4INYhAclSQf6V7nAOdwTQROvNyOOVj0J2BokB3lsk6hZFDYORv3ps8DRDIGR6injtucflTO7nZQIYyOdup9BSsKAseYfOsApJ70VEwO1Zqu5FAJgi74Io8KZO4zttWKAnfpvTyAZjXBHp0ooBiqDfalWVzI0MfwgF2PKo96VTIDoW/lFtYTzk48uNn+wNcwavK89750hy0khcn3JJroTj25a34Q1OVTg+SV++1c7XZ/eQn1aq2OgqD716B126V78q87YoIJnGu3vTe5P73HoKdR+oNM5/8Ajt7AVH0BA+tKLLSgD1pL0NZWYzcqB60ox0f+znZy2/C17eqoImuioOOyqB/erlW6R9PJzuBjFQj9n+wRfCyxcjBmeWU++XP9qaeMvEp4Z8Pb2eCTy7y7b8NbEdQzZyw+Sgn7VpfRSilfEDWV1/iXiDUoZAbaE/g4WG48pAc4/wCpv61o9WE1vFoc8gYSR2y5RumQcj51q+FpZ1PIiq8bMCwceh61KeKbczeTKBkqO3b6CtdUcwyUSezsThu+TVdGsb+33iuYo5Fx6MoP61vr1+SJYgcs+wqtP2b7s3Xhtp0LklrKWaA57ANlR9mFWKhE1+0hPwQrgfOsc1h4NEXlFVftRa+NM4Ig0KFsTanKEYA4Plr8TfoPrXMI2GB9RmrA/aC4hOveJV3FHJzW+nAW0eD/ADDdz9zj6VXjsAMZ39cUSCJGMihSojxlSuQfU1kWODtt60IsetAgN2EETOc8qDffemNshldpZM87nJ9vaj3zc8qwDcL8T+57D9ftRo05V+Ejal7YRLH8JB7UuVVyQfnWRGO43oUrhRUIeoPj6fnT2IBV2O4O1MrXc5P3o9zKIoGYnopoogEN514zc3wx7D596VeaYpW23/ibc5pVEQtXxfvDHwi8QJ/fTKp+W5qlLkhrm2HuaVKqRkOZNs4rD2pUqYgRemB0ppNkzPjHSlSoMiB5ITejaZg3Q/WlSoLsPo7P8IEFn4XaEp2LWSt8yxJ/WqK/am1dpuLrHh+Nsx2EHmSAf/JJv+SgfelSrSykgfCynzVHf37VN7yES2w5gRtsTn9cClSroVL8DPLsuz9my4S24R1lCRiO8Vh07xj0+VTzi/WU4X8P9R1mcjzI4GkAJ6uf4R9yBSpVht/dl9f6nE7ySTzSXE7lpZGLu56lick/c0F2PcZpUqqLEDLdsnNClmCRtIwyoG3uaVKpnQUN7VGYlm3YnJPvT7BQdPnSpUEADI2D/wB6A5BbftSpVCB7fIUtjO1MdSmMkywrvzEZ+VKlQfQUO2l8qP4uw9aVKlUbAf/Z',
        'sanjay': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCADIAMgDASIAAhEBAxEB/8QAHAAAAQQDAQAAAAAAAAAAAAAAAwIEBgcAAQgF/8QAQRAAAgEDAgQEAwYDBgQHAQAAAQIDAAQRBSEGEjFBBxMiUWFxgQgUMpGhsTNCwRUWI1KS0UNicuEXNFNjgoSy8f/EABoBAAIDAQEAAAAAAAAAAAAAAAABAgQFAwb/xAAoEQACAgEEAAYDAAMAAAAAAAAAAQIDEQQSITETFCJBUWEFIzKR0fH/2gAMAwEAAhEDEQA/AHPKvaloAMg71kQBPxoiIec5FXcHMUiDFZyjoKUikNjNGjjAJ33NAAowp2IxRFRc5FLCdf8AathCq5GaeAybRECn40pI0zW1QlcnNGjjBz1zSwAlEXeiJHilIpXbfFHYpFEzs2ABk0wBqhH+9AmvbC3bFxdRRMRkB2Az8qhHEvH0Fy0+m6YkiGNX8y5bZU5VyWGDvjb6mqs0DiW8l1Vo7y2u7uJGykjoWGMkg/CuUrEhqOTow6hp6xGU3kIjHViwxTWTiPQEYKdYsd//AHl/3qkNX1I3ltJbQKsoOcJKoLD5N3+RxUBuA4uORLeOMnYMq5AP/MCdqj4v0PadZQ6rpszcsN9bS5GRyyA0cSxO5RZIyw7AjNcr6Lf3ttOYHkeCWM5PI2R88fSpfZ8T6pDDLPYXTi+tgGmRMYlQ/wA2O/YHH9N2rfoNpfLIehAoboKrzgDxGj1OUQXzonmHCNno4/Ev5birCgvLW5nMSSrz4DAe6noa6xafRHoSyKB0rXlhsgU7kjxQvLxuDUhDOSNR1pHlrjNO3TLcxANAdCDuMijADbyxnfpQ3VRTplJ6CgyJlelGAyNcDm3IrKIUw3Q1lGAyLQDHTel85bAxjalqm3SlqgJ2P60DNRLnNKUHOeuKWByjGcmlxrg5z1oA0oycnpS1QnJXGBSwBykE0qMHHpJxQI1Cu3q3osUeWJ6UqIADFOIk9W4pADRfTuKhvijr1raaZcaOtw0d3NDzYXc8pzmp3sEJxuK5l8V9an/vtcOZJudNoJWbIIH8pHYVCyWEOKIu2pSaTqPlkrMgG4xs4IGfYEHGfere4bMGtWSNaIjDA5oSvK6fUdR8apeWaLVCPNgEdwgx6TkMvy+FSPgvV7zhm4ju4ZbhYkOcAc30Knt8qqo6Fh8ZcH2ljapeTxu/Nv5kI5ZVH7N8R3+FV/rosF09LleVZ2lkgmI7HHpkH15T8s+1T684pi1myZmMKJJgvG5IUn/MD/8Aw1EbjQ/7YnljhR5gVxkD+vf5/KozsjFcnWFUpcIg2t6nH97tLyHIkayUzAf+oV3H+oA/U044UvlXV7mWWTEAMiLnqVKtt8ht+lS9PDaZxi4wp2xjfYdjRV8OXti5dgxbOMHC79q4+ah8nbydnwQaxaO1083MV+qT+aZm3I5TsMD3Jwf1NSLw/wCLJ9K1sXV3c3Ekb8oYRy56EHJB67Z6e9R3iDQrjS73yJAyxOQCxHpz/tS7C11G1lFvOqsp3RWGAd9wD1B9jViueeUVpQcXhnWOhaxYa9ZLd6dN5sRHUqQR9DT7yyPkaofwT16407iiLT1EktrcuYnDMSUbqD+4roSVMgirkJZRxawee64BXH1pvIhHxr0GUgFSKEIxvmpCGGMb4pLRcx26GnckY7YzSDGAvppiPPeMcxFZTiSMZJ3zWUADiHMmD2pQQfCtRlhnGcUZWBUjG9AzEQddqWmF+NbQHBB6UuBRznIyKQCcijQnYLjGa2qqzEYpaKOcAAUAKVADsc0ZNm2pMSKGOacRKocqRSARhmQ4HauS/E9W/vZqStmQ/emVMbAgbDHwHSuvVQAfCuVfEnS5IPEbVIpnLO10WXfOAd/p1rjd0SgQ/RdOvL2TyIyUTmwxxVmcOcJJ5IR2Zu5zvQdAsIYYkCADbJNT7h+NDggZIrG1Fr9ja0lEfcaaZwfYSFRLEGAOQMVKrLRooEMcMKooG2BXoafGoLYA5exr0kZY2yNyOtVFz2aCSj0jyYtIlKE8oB759q82/slQksMY/WpeLjmjYAHcV4mqqHyvQMabSQJt9ldcVaVDqFpLCyAM6nkPxqq7z71b2sMMymVbdWTn+oI/Lp8qvHVIQsTxrgspypqvdS0lpr2eTmDJzGXkJ6MRg/tV/Rt8mVr0uGRrhi6ktdZsrqRjHKJ0L8jb7MMHb3rrIb8r9c/CuWrawVr43CqyxlgpVUGQc9cfMV1PboDBEARy8i/tWrV7mVIQ6h8kU3ZME5pzJGQ2FNCdSASTXZERq6jc03ZQoyCDT3ywVJ96A8YU0xDFsknaso0gIYkVlMQCIgpilIMtgCtIqhCBiiRgAAr1pEgkQ9RBooQ9AN6HGd8nGaOpy2c0AaRSpNEBPatHO+wxW405jsKBBlHp5qcKT1A3oSxgKBnNERShyDURh05iBtVIeP2mR23EiaiseGuYB6uwI2P9KvKNsr2qtvtC6ebrhO2uo8B4rlUZsb8jdRXOxZiyUOyutBRzbRKBklRVicOWgSJeZt2qq73U7yDUhpOmIol7uxwFFEu7viWxxI3E1k8hO0cb4K/Id6xLKVJ8vBtU37Fwsl92lqoyA4BG+PenMFunn5mYCPqN+tVBwdxpcS3kdldzmWV8Dm6eqrB4rMx0SO480xeWC2Q2Ob4YqvtSeGXFZlZRIdS1vh3T4Sl5qNrAV/laQZ/KoXqHF2g3NzyWtx5ik45lFVFqps77UnZdLk1CdVaR1DEekZJJxv0+Qotpxbw+llFGNAswrReYzQ4ZoxzY3wTyn4HB6GrKpi10VHqJxljKLLunhn5oxIsoPdTkVX/EtrLot9JecztDJsjDsfY/0NepolxbyMl3p8pkhmXJBY5H07GjcZRLfcP3HMMgKDgdRg9RSq/XPgLv21vPZE49QEd891KvllweVl7Z9+x+VdN6awk0u1cMr/4KZKnvgVzV4c6U+t6vGk0TTRRS4Eaj+IybjPw6k1dvA8FzZ6zcrNdcyTZHkcoCow6Y+nvWhHUqFih8metJKdTsz0S1kJQnFB6qRinEm2RyigsmNwK0EUhvIcZGKDIVJAwaPKOvpFAIU5AG9MQA4HMD0rK06jJyN/nWUxAFUg57H4UQBaQmQN6Xn270iRsFQcijxjm9VCU77ilAspytAhznmGD1+VOFUKBv1pohcjJpxDluppDDhQvqzS0BcnehDYjoRTmPBPp60gCQKwGKqj7RE11BHYRmY/dHjd2jH+dTsfyq3EXHeq/8d9IF5w7aXx3FtK0b/wDS4Iz+YFcL87G0dtOk5pMozV9KvrqeWW2kdPPYBpjuUX4U+seFbUSRSxT3CyeQYJfIBDTK2Q3MSDjOd8VNODrZZI4wyhl5VBP0qYy6faWkHmBUTO5OMVjSvcXwbVWkU45ZWtpo8cXENkyx+UTKp5dvT22A6VaGsxm5tY7Q5I5TgHofhUa0mCK51w3QXmTrGfffrViXlvH92QR8rMyhgwrjPMuSzVFQWCt7vgxbuR5baVElO7oVxzfHI61uz4au0jWxSO05R2SLJA+BqYXc1zYvhIo7gkc3KB6gKf8ADmuaXesX8tUmQkSL0K/ShTn1kl4UO8EPi4Ti0+NpeRE+S43+Oa8PUomCzW5ABYHl296tfiG5tpom5OXyyvvVb62mLsOvQ96aeZHOcUkNPDTQNQ00tfWsyK0bPzqozlTsce22KsPQkEusRuB1XzD8eo/pUY4T+8NLNaQsiq6+tjksM7bVLuFoXF5JNIioVjChR/KOgHz6n612pTneivY1Xp3g9u4HXagsAQAdqPKOZSM0PyiEOa30YA2nz0Apu8Z/FuKePkoRgU3fm5SOlSAaOME5Gaytvvse3esoEM1JYUQDmGB1oatgf9qNbuCxz1oGhXIQAGNbRfTj40vmDNjO9bK7YWlkMC0GBilx82DkYpEQIXLD60RN8gnagBSEh8Ak05jbGT3oKKF6EGjQopBJ60gHUMnMOleVx7aDUOCtTticHyS4PsVOf6V6iIAMA0u4ghurOW0uBmOVCjj3B2qElmLRKEtskzn/AEPU0sLjyCxwAADTzini+2ktTZyTcg5fWQf0oHHnD3929fNp5rTRPGssMhXBKEkEH4gioFxZwrrc95LdWt3E1rKuYick9B6T7fOsTwl4jUzb8xJVejkz++uraTqcQ0qYTwoMCKQbMPbPUVJR4najqtoLLyZLMuWEZSTYt7Fh/SopwZoS3F28HEJ+5eSw5ZViMqsPc9/0q7NC4W4UeK2W+4kimhK58u1sQrKSBtnlOO/aujjBPo5wdrT5f+CGcLa9eRaY7RxSM3MXzksGw2MZJJ75rz9S43WK6+9pKtvcqfWrZHOPY1ZWoaPwdap91sNCvLl+RQpnmZMkE5PKOx614H/hxo8Nhc3k9sj3Ux/mJZY/YLn96i3D3RPbalwx7o2qz6tpNvcjmTzVHpJzija0AgTn/ENiPei2VtDZQwW0JQRxKBsMV5fEN8JZ1iHboaqxWZcFicnjkf8ACeoW0OqiwdZWurr1W4Rckleo/I1Z+lWssMLNckCSQg8oOeUDoM+9Vj4aWq3PGcE7dbeGRh8cgD+tW1IDn4VraOmK/Z7mVq75NeH7A2jPbcUli26tSg7KOlDeXmJrQKA3dW332pvLndSc0d3YqQcY96avnB3GaaAA3pBWsrTE75waypCGQY0pdskE5rSlT33pZHKu3eojNqxB3JzRkZsEg0JR7kUVFZR1oAOjtyAEbUpSVO9BBbGM0VCSN87UAHUEbg/SixPynJFATJOc0ZDkEGkA4SQ5yBREdielN4gxGacW4Pc0ARvxQ4ak4g0AS2UfPqFnl4V7yKfxJ9cZHxHxqltK1HHLayBiOY+luorphCeXrVQeM3Bht3l4s0SLHK3PfQIvfvKB/wDofX3qjqaN3riW9Pdt9LIq1mUu1uIUDIxB2OCvyr3tMmuUlJSNSwIKlydvevO0DUIrixSUuuG+uD7VMtF8k24kljUDOzHvWZuaeDWrztymPbRJJ1WSdUjOPUUG7fWl6pMkVm5dgBj0j3p3cTxSII1O3y2AqCca8QQRv9zjcFlOTy9qSTkwm8Ia31+ImkckgtsBmvBhmlurl7hycZ9NMfMuNSvAoJVO59hVweGPhq9/HDqerxvDpwAaOIjDXH+yfHv2rtVU3LauyvOxJbn0OfCbh26g0661yZeRriPyrYMOozkv8sgD6GnXAPGVtxPBeQMi2+o2MpiurcNkDBIDqe6nH0qTeKnEFtwhwPeamFRXSPybSIDAaQjCgD2HX5CuO+GeKNU4e4nTXLGTnmDHzkb8Myk+pW+f6da2a61XFJGVZNzk2dgufjTYsQxA3rzeDeJtL4s0OPU9NkGPwzQsfXC/dWH7HvXpk4yAKmcwTk4INAkwQRg0ab8O4oLuC+O1NCGzqFye9ZSZ9mbG9ZUkAyGD3pRbtmhRYKHfeloMn1UhhIiS4yacI+CQTTVRvuaLETggkUsBkcKNzilITuCd6RHICMECsBAbJoAcW4IYkmnABPyoNvhmo8QIOM7UgDKCo2IxRVJ5Bymg8uAR2paghRy0AOY3IXGKDqM0UNlM85QRlCpDHY52x9elNtR1Sw0mza61O8gtIV6vK4UfT3qmuJvEGLjHxQ4c4c0GaRtLt7hri5cqV850ViBj/KP3NRbwhohc0k2kapcwW7csayMvIeh3r0LPi6+iUxcudsD1bCpH4m8LSwMdato2eBiBcgD+Gez/ACPf2qHWmlec3Qism1KL9SNOlykvSz034o1R4DH94WIY653ptptreardLBYwy3NxM2OblJLE+w7mpLwV4fXWvXoito8qpHmSv+GMfH4/CuiuA+B9I4Wth90h826ZcSXEgHO3wH+UfAVOit2fysIV1ir/AKeWRDwp8J7bSYo9R4gRLi62ZLU+pEPu/Zj8Og+NWrcBQuSQAB79KLgKDjaqe+0px63DXDg0TTpiuqaopUsp3hh6M3wJ/CPr7VpVVxrWEZ87JTeWUx9ofjocVcVHT9Pn59K01mjhKn0yydHk+PsPgPjVVonMSe9FlGS3alKoAA6+9dSB6nC3EOqcMX/9o6XdGFwMSId0lUfysO4q2OGPHHSrwrDr1g9i5/41uTJH9R+IfrVGak/l2Mp6dAPqa8hHOxFQbwx4O09I1nStYs/vGl39veREdYnyR8x1H1ozEDO1cb6Vqd7p90LmyuZraZekkblT+YqzOFvGDXLXli1iOPU4e7YCSgf9Q2P1FSTFgvOQEqSKyoroniDwxq8aqmoCzmb/AIV0OQ5+f4T+dZUkRPbXHKQOuaNEMdqAilQSaIrHqKiTHKKpHSthcGhwkhc0ZCpXfOaAM5TnZdqUg96UuQvc1vI223oyLAWI4z2oqsPem8ssUMLSzSLHGoyzM2ABVd8Y+LGj6SHg0hf7RuhtzA4iU/E9/pSAs+S7gt4HmuZo4YlGWd2AA+pqreP/ABr03SxJZcNRLf3QyDcP/CT5d2/aqd4p4v13iKcvqV9I6E5WFTyxr8lqMSkEnfJqLYz29b1zVtavX1TW7+W7nO6B29KfBV6AVIfs+6fLdeIy37L/AIVvbyer3dsDH5VBiWkIXdi3auiPCDhh9Es4JJQFmkiDMPYtuc1FrKGi1bu40fStIl1DW7i3trNFxI034WB/lx/MT7DrVDTa5wFNrYuNKu9Z07TnuAr2gtQ7qmd3Q5wq9+U5I7e1eH4t8YXPE2vzQI7DTrOQw2i9mxsz/U/pio5Y2aRW/wB7u2wnZfetHTfja9TD1kPMTqfpO5+CrLRU4es5dAeCXTnQNDJCch/ck9S3vnfPWpDy4XbpXG3gn4l8RcM8Y+TBbvd8Nzrm+tydosdJUPZ+2P5h1967B0jULLV9Ng1HT7hLi1nXmjkQ7H/Y+4qvfT4E3BdIIy3LIDiDU7PRtHu9Vv5RFa2sLSyueygZ/OuFOPeJb3i7iu9169ypuXxHHnIijGyL9B+uau/7W/GpJt+CbCc8u0+ocp6jrGh//RHyrnUHAJXHyqCARkK3Kd196xzHHEWaRVUDOSdqQ3UnOPhTO6tzcMob+XcAnYUmNAb++S5QwQKWXIJc7Db296bDATHejyRCIY5Tg9KCxGdh2qAzE5vhR0YgbGhKh5c9jR4o9u/woQC45m3GdqytxxA96ypCOrlc9+lLX3ztQVO+/SjgAjrtTGbVz2IpzE+VwcUBFVfw0QEcvXGKAHCnA/EK2T3yKBkAZJrzeLdR/s3hfUb8EBobdiu/fGBSApbxb41u9Z16fSLOdk020blIU/xX7k/D4VAWYkkGtROXM0znLO5JPua2Om1IAExAXPQ0FBlqJdkEgDoBvSY/w7DcCkMlnhho39tcZWVsyc0av5j+3Km/74rp86VLdWr28H+GGUK7jqoxv9cbfWqn+zVojSSXmplQMhYEY/6mx+lXxf3dnpOk3d9dSiG0tYjJM57ADJ+tSS4Ec4eM2k2Ol8Q6dZ2kQUchaUIOgLALn54NeDw5pN1xpxPHo+kL5gXrkEBFHVmz0FA4n1y44k43j1adDGt1P5iR/wCSJBiNPng5PxJqd/ZyvDD4ns05CJNbzoAPcAEftXoqa5U6V/K/6VHLdMuzhLw10DhzRPJaNZ5CAZJXH4mx7Vq8kXw54Z1XiSK4K2iqZXsXOEkPRQv+VySBnv3qaQj70+//AJeM7/Fq58+1Zxel7qVpwjZv/hWwFzeEHq5/hqfkMt9RWBKTk8sspYRTOtane61rN5q2oSc91eTNNK2dsk9PkOg+Apixz6OlbycEA5NDJJUgYPvSADI7IMMAd9jSvTyFmbkAGST0rFAzhlyKZX8nPJ92Q+lTmTH6ClnAwEsrTSGRiQOiDHQVqOMkk9aXy9h23p1bxHl5qikMTBDv0FOPL6YXOKLHHjOO1FRTjoMVJIAEcQBHWsot6WjtfKQYklPKCPbuaykB00HUnGMUoEgnfagKQW3oig574pgOI5Mb/wBKKCpGc0DAx1rQO2AcUgHB3GRUK8abk2/Adyqt/FkjT9c/0qYI3oxzVXfj9P5fB0Mef4lyv6AmgCkLU5t1B6nf9aMu2fnQrZOVVDdgKXIcITvsKQDOf1zN6tqNbKC6gjYbn6UEAE5617PCtgdS121sl6TTJGflnJ/QGkgOm/BzSW0/hPTrWNMTSR+bKcdGbeoz9pbiQRiy4MspcGUrPfcp3K59Cn5nLfQVaulC14f4Wn1S9IiiggMrk/yoozj8hXG/E2vXevcTX2tXLnzrqZpMZ/CD0X6DA+lXtJXus3PpHOx4WD1LEJc8QJ5Y/wAK3TA+dWF4KadLJ4p2UcXpULK7t7KEOf3FV3wueVix6nrV1fZ9hX+9t7fkbQWZQH4uw/opr0F726Sbff8AvgrRWZIunjHXbHhfhe81Gf8Ag2kJkIzu57L82OB9a4m1fULrVdRutTv5Oe7upWllJOxZjnA+A6fIVc32nuKDPd2nCttKcR8t3e8v+Yg+Wh+Qyx+YqjpCBs24+AryqLggnAHatYJUn9a0xyc/y+1aHLgljhQMk5oAHczmKDCjMjbID7+9edDFy57sTufc0f1TSGYj4KD2FGiiz2qPYxMUXqyR+lPEjHJtWJG2KMo9IFSSEJC/Pc0qMEkY6VodfxCiyOlvCznGwz19qAG6ky3kkgb0p6E7796yh2astoM/iPqPzNZSQHSquAwyKMJAFzTVH3xtSiVzvSGOA4I670RXVl36+9Myy9jilo4wcmgB0CPcVV/2hpT/AGTpcXZpmJ/KrH5h2NVB4733navp2nggiJDIfmT/ANqTArxMFsdMUm6bCYHU1qPPMaRdHO2dxvSAHB+L/tVrfZy0JNT4xW4kTMdpEZTn3J5R/WqriA5TXSH2YtPW34bv9SwOe4uRCn/Si7/qxpw7A9P7UuvtpvAcGj28gR9SnCOB18pPU30J5RXLsR5nx1NWd9pzWzqPiJ/ZqPmLTLdYsZ/4jetv3UfSqytMFx0ra0cMQX2V5vLJLpR8mEN3xvV8eDMttoPAWscV6ieWBMsB05hGvQfNm5R8aoO0PpVB/MRVj+KGrtpPA+g8FW74keBbu+APuSVU/NiT/wDEV3/J27aVD5FSssrvXtTutY1i81S9bNzdzNNLv0J7D4AbD5V5ucfE9qxmJBAyKQDgYx8qwSybA/IU1uphJIbdNgv4/n7U4K3L/wCFZ28tzO55USNCzM3bYU/03g7iqRBycOaw5JyzfcZdz/pqDYHlxxkgkYp5CgGRg7179r4f8bOSF4U1pv8A6TjP6V6Vt4ZeIEufL4S1fH/NDy/uRUkBEipAGM0oggZqW6h4Z8e2djNeXPDF9DbwRtLLI/IAqKMkn1e1RBXAGC2KYhSqM55t6Z6k5YJECSWYA49uppw8gA3IxXn+aJL/AGAPlr+ppPoB6HAGO2OlZQvNQplgMisoyM6LaUAYwaSj57msrKiAvzQRvtQxLv1rKymAcTDFUZ4wT8/HkgzkJHGo/I1lZUWCIwhGN8UCc5c1lZSATAMuq+5ArrPwMhi03w2srqf0xlJblifYsTn8hWVlTgDOWeJtUl1niC/1WUkveXDzEn2ZiR+mKbWxxuKysr0NSw8FRko4NWK74gtIJ3KwKwadj/LGvqc/6QaTxTrEuu6/e6tIOU3MpKJn8CDZF+igVlZVD8lJuxL6OtK4PKPq6bVoEAEt0x37VlZWadiz/APj/QeDbLUZ9YhvZJridWgW2gBJRVxksSMbk7VYGofaP09WK6fw1fynsbi6VB+Sg1lZSSAjupfaL4mbIs9D0y332MjySH9xUevfHLxCucmPUrS1yOkFmn7tmsrKYEc1jxF421iJ4dQ4l1CWFwVeISBEYHqCFABFRVZuZ3bPQ4rKygQiabYkY2GaYaaxZ5pPdv2rKyk+xjrkZubORWVlZTSA/9k=',
        'nandini': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QMfaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDY6NDU6NTYrMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS90cmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgSXB0YzR4bXBFeHQ6RGlnaXRhbFNvdXJjZVR5cGU9Imh0dHA6Ly9jdi5pcHRjLm9yZy9uZXdzY29kZXMvZGlnaXRhbHNvdXJjZXR5cGUvdHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIHBob3Rvc2hvcDpDcmVkaXQ9Ik1hZGUgd2l0aCBHb29nbGUgQUkiIHBob3Rvc2hvcDpEYXRlQ3JlYXRlZD0iMjAyNS0xMi0yNlQwNjo0NTo1NiswMDowMCIvPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiAgIDw/eHBhY2tldCBlbmQ9InciPz7/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCADIAMgDASIAAhEBAxEB/8QAHQAAAQQDAQEAAAAAAAAAAAAABAADBwgCBQYBCf/EAD8QAAEDAwMBBQQIBAUEAwAAAAEAAgMEBREGITESBxNBUWEIInGBFCMyQpGhscEVM1LRFmJygqIkQ1OyY5Lw/8QAGgEAAgMBAQAAAAAAAAAAAAAAAAECAwQFBv/EACQRAAICAQQDAQEAAwAAAAAAAAABAhEDBBIhMQUiQRMyFGGh/9oADAMBAAIRAxEAPwDkY2p9jF5G1PxtWoznsbU+xiUbE8xiBHjGJxjFmxidYxAjBrFm1idaxOMjQAy2NZiNPtjWbY0ADCNeiNE93yfJam4aisVAS2pudM1w5a13W78BlFjoO6AvO7Wuo9S2aqd0wVD3bE/yyP1Xp1NYGu6JbjHCc4+ta5gz5ZIwi0FMP7tYmNEQuinibNDIySN27XsOQfgQvSxMQGWLAs9EYY1g5iABCxNuYjCxNOYgAJzEy9iOcxMuYgAB7EO9i2EjEO9iBoAcxJPvYkgdhEbURG1YxNREbUCPY2p9jV5GxExsQIxY1PMYs2M9E8yNAGDGJ1jE4yNOtjQA02Nc5rzWNp0hQtkrSZ6uUHuKSMjrk9T/AEt9T8so3XupKTSWmKi7VID5B7lPCTjvZT9lvw2yfQFVZrrrXXi8TXO5zuqaqd2XuP5AeQHAHgq5y29E4Rvlnc3LVOo9Wzl1TVup6TOW0lOS1gHr4uPqU2XQ0cW2CRz1O2BQllwyAdJ55A4TF7c57CI9yOcBVly4D6Ovp7hVxUNSWuhfIMlvIycbFB3WjfRTyxucR3byx2d9xt4rSWHqjvET38B4OMLstctDL5LM4PEU7RI0jgZH91Q8lT2ssULjaOfs2o7zY6oVFquT4mg+9E7eN/xbx+6mrs517QaqYaSZjaO6MGXQF2WyDxcw+PqOQq/V7T3h6ZA4eTtihIaqopKmOopZnwTwuD45GHDmOHiCr4zoqlFMt+WLAsXPdluqmat0yyqk6W19ORFVsbx142cB5OG/4+S6ksV6dqzO+ANzE05iNcxNliYADmJl7Ue9iYexAAD2IeRnKPkZsh3sQAA9iSfkakgY7E1ExsXkTETExAhRRoqNiUTEVExArMY40+yNZxsREcaAGWRp1kaeZGnOlrGlz9mtGT8BykBWX2lb+6u1pHZI3/8AT2uIBzQdjM8dTj8h0j8VGFNJ0u6sorVNyfeNS3K6SuLnVVVJL8i44H4YQVOx8srIo2lz3nDQPErNJ27NUVSo6yx1FRUPjpqSGSeaQ9LY2DJKl3TfY3frhTsqrnUwUwcM90MucPj4IrsN0MLdBHcalgM7wDkjhWJtMTBShuPBcrNrJSk443SOxg0UYRUsitshKn7GrbSuEriXyDk4R1boagEHRLGZMDGXbqW6yJoBWkr2NIIwufknNvlnSwqCVKKK4647OY2RSS0TSCNwAoduME1HO6CYEOacK4uoKZhhfhqgDtR02SZquCPJG5wt+i1Mv5kzD5DSRcd8EazsE1A6z9oFPSySYpbkPo0gJ26juw/jt81Z8xqkVLPLR1sVRGS2WCRsjT5FpyP0V4KCVtZQU9W3BbPEyQY/zAH9128T4o89lXNjDo025iOcxNOjVpUAOYmJGLYPYmJGIA1sjELI1bKVnKEkbygACRuySekakgYRCxFxMTcLUVE1AhyJiKjYsYWIuNmyAs8jYiI2JRtT7GpCPGsQWo3dxpu6TjYx0UzvwjctoxqFv9KauwXGkHM1JLGPiWOH7pDRQn+ykbsQ02bven1kzPqYMAOPmo8dG5jul4IcNiPVWV7Jba22aRpWxxgzPj7xwJx1OO/K5WtyuGOl9O147CsmW30iYNKW7pijjbsAAB6ru6SkEEOHuHCr1fqt0UDIrtqmf6a8fU09DGA1npuePUriY9RaqhuDm0Opq09J+yKhj8D1DXFc3Bh9bs6efJLdVFr68NwcEFamop2EHJAUfdmepL9XzGkuswqcgdL8YcjO1LUtTY6N8cJ6J37MJ8FRK3Ki+Cpcm2u9GySNwDgPVRdrCiiYJWiRjzg5aHAlR/eb1qS4PfNWXaoFPnHU6URsz5Ak7/JK3C1zxlrq6tZVgbStmDhn0I2PwWuGn2K7M71UpetEc6xom0d4kEYwx46grgdn7u+0HYZfF1ugP/AKqfaBE4yUufflJczLR9oq3Gi6J1DpCz0TwQ+ChhjcD4EMAP5rt6V3Gzz2rSU2Gliae1GOamntWkxgT2IeRqOe1DyDlMDXyt5QUzOVspRyg5hygaAJG8pJ2RvKSYBMIRcIQ8QRcISAKgai42oaAIyIIEZsan42rGMJ+MJAesagdU1FTQ6crqykhM00UXU1jTgnffHyytnG1OOibIxzHt6muBDgfEFQnFyi0izHJRmpNXRTztc0w+jqLde6Wyfw6lrmuMjWP62d6HZOPLIOceinXQFtbXado4wS0iBm4+C2usNE/wCIIhRuk6aalbI9sYJy5zWkjA+YQHZTUdy1tG/7UH1Z+W37LzWoySlj2y7iz1umxxjNzg+JKzmtYdnNQbwKqqb9Po5GObJCXFjQSCAc+JGc77ZWl0zo+ooamqbWxtutRPFHDC9rBG6AM4I6PEAfrnOVaOipoauAZa0nHBGUv4dBET1tjaPJrQFLHqMijXwhPDjlPc1yR5oXTbrcKeola9s4yX58s7LS9vdudX3ShwCGOccgeKk6WVn0oxxgEZxsuT7ZKd5hp6mJv8khzlmjJubkaEr4ZDWr9JVM1kpIqctp6ljHMmqAw9NRGXBwYQc9IaWjAGPHOcrRT2Cerr6IwUrKZtLA2J72DJlI8XbAEqfdOinuVpjf7pJbuPVM3u301JTPk7tucc4Wha2dbSn/AAsblu+lbNcWqSCst5jBc6KoD3fAb5/JWU7PKOvpNF22K5yOkqzF3j85Jb1EuDd/IEBRHBSm69pdpomw99FJPmUYyAwEFxPpgFWBLQM44XY0NuO5nE8lUJbV95BnNTL2otwTEgW9HLA5ByhZByjJRyhZRymIClCElHKOkHKDlHKYIDlHKSzkHKSYwqFqLhah4QjIRskIIhaiompmEIqIJAOxBExtTcTUTG1IDJjU81i9janQPdKQyOLhq2kn7YH6MjeGSsoBJI8ydLC/clrvIhrgQRxutIR/BdQS907rY7D85zs7cfFQd25VVfZ+3G/VNLUyw1TKpskcsZw4BzGkfkcLoeyPUtZd7rWsu9a6pmmax7C87jp2I/Qria3TNylkXR6HxuqSUcbLMac1RCKdrjIBsnJb7Lea8UVG7YfzHj7o/uo/oKNr39IcWh24x4o+mvQ0s497bK+pi5fJTQ950nxLsceS5MLfqdqaivZdm01Rf9QWO5impNOvrIGnq+kiTAI9Bjn44XJdoXaRJcaA0lLRGSpkADw7bpXR1PaVR1FOeix3EtxjqlYWj8gVwF71PZJ3dVJZpnPBy5w3OfLYLTDE18K9sq54D9EXuupeqWePu2OILmg/mtnrDVET6B4Y4ZIXCU2qIqyuFHTW+qjcPtFzPdb8SmNSjpxGXb8uHkj8vbkX6pR4Ou7CIhVanuFdK0PeymIYf6OpwGT8RnHwKmNzFzvZLamW7Qlud3DI56qPv5nBuHO6iS3J8cNIXUvavRaeGzGkeR1WT9MsmBPbyh3t5RkjeUxIFoM4DK3lByt3K2Eo5QUw5TQgGXhCSjlGyhBypggSQcpLKQJIGGQhGQhCwBGwhREEwjZFwhMQNRcTUAPwtRUTU1C1ExhIByNqda1YxhOsGUgK2e1z2f1D6iPXlsgfJH0NgubWjPRjZkvwx7p8sDzUE6OuM9uv9HPC7p6ZAHDzB2K+hU0EU8D4Jo2SRSNLHse3LXNOxBB2IKqV29dltr0zqqCbS9xhDq9/ess4a50sIzkuZgEd3sftYxjxwqcuO0zRhyU0d9py9snYISemVmxB5BXf2yTvqQsc0P6xuomZaJpbbBcKF3TVtYM/5vQrb6U1m6jnFLcmmKTg54XmJY75iexUuKkdRWx3qxumfZmT9Mv22xu2/wDqcrk7zX6luDHU7qKohGMFxaG/oFKFBqq2up/dljJI5ytJqDUdvdA5zpmfipQzSSolcvvBFzIXW1jw9oEp3cVlpCx1Or9VR29ocacHvayUcMiB3+Z4Hx9EJerkbxeYLdRkCWqnZCwncAucGj9VYjQ+lLfpKzC3UWZZHHqqKh49+Z/GT5DyHgPmV0tJp3ke6Rxtdqlijtj2zbMhZFG2ONoYxjQ1rRwANgFg9vKJcEy8LsnnQSRqGkbyjXhDSjlNAATNQUreVsJRygpRymADMOUFK3lbCYcoGbxUhAUg5SWUvikgYbAjYAgadHQKIB0CNhCDpwjIggAqLCJjCGiCKjCQDzAnmBNxjCzc5kcbpJHtYxoy5zjgAeZJ4CAB7zcqKzWmqulxmENJSxmSV58APAeZOwA8yqkVesX3LtAr9RXJpbFX9UMjRuYYTjpA/wBPS3I8QHDxXW9vuv3aguLrFa5g60UcmTIx2RVSj72R90cD5nyURk4dkKz8k4tS+k4Nxe5FidK0b4qMxSgEtAxg5BBGQQfEEEEHxBCA1LYaesDn90A7zwm/Z0vEepmf4JrKhkV1p4nPs8shw2eMZLqZx827uYfAdQ4Ax2N2o5KWrlo6qF8M8bul7HDBafIryWs089Lk56+M9dpNVDUw/wB/UQ5WW+tpCWxVEoHxWsnjrt++qHub5YUm3iijY4kjlcteoIo4XHZGPK2TniXZreymjFX2nWKJ2T01gkP+wF/7K14G26pxRySUlzp6qCqlpKhso+jzxuwYpScRu9R1YyPEZCsv2Q63h1zpRle+NlPc6c9zcaUcxSjkgc9J5HluPBdzQtbGeb8hFqaOucEy8cp526aetpzwd6FkHKLehZfFCADmHKClHKOl4KBm8UwApvFAy+KOn4K18vJUhAsviklLwUkAG06PgWupythAVEZsIEbCEDTlGwoALhRLFp7vebZZKF1bda2KlgHDnndx8mjkn0CifWPbNVTCSl0zTmlZx9LnaDIfVreG/PJ+CcYOXQEuaq1VZNL0JqbvWNjcRmOBvvSy/wClv7nA9VXntK7Srtq0upBmhtQPu0rH5L/IyH7x9OB+a4+5XCqrqqSqramWpnkOXySvLnO+JK10j1fHGo8jSGpZMSFhOztx8UwSsK1xIDhyDkLwOyAfAjKLJUG2i41lquVNc7dUPpqyllbNBKw7se05BH4K8ulauw9snZ5RagaWUd3EfczvjGXQTt+0xw+8w8j0IwqHAqU/Zm1+7RXaJBDW1Bjs11LaasDj7sbifq5fkTgnycfJZ9RhjljUlZbiySxy3RdMkfX9nu2n5X013pHQuGTHKN45h5sd4/DkeIUd3KZs8OG75V4bvbrfebVLQXOkgrKOUYfFK3qaf7H1G6gjWHYlDT1TqjTFQ6SDOfoVQ/L2+jHnkejt/Urz+TQvHzDlHeweSjk9cnD/AOFbdQUxktlQxuzm4wfXOQie0dj6SXTOtrO6e3fx+idJM6CQxkVMTuh7wRx1bE+ZBPipV0h2RXi9agq477S1Fts8MvTNJI3pkk2+xGD4n+rgepTXta2VsWjrDFbqNsUFtqzHHFG3aKDuiB8tgtnjlJO30YvIyxuox5ZxGlO3rVVmdHSX2KG90o2Er/q5sf6xsT8R81MOlu17Rd+axhrzbKh3/arB0jPo8e6fyVSWdMkZikGSmGmSml6ckt8D5rsuCZyKL5CRksQkje18bhlr2kEH4EcpiXxVOtL6xv8AYXh9putTStzkxh2Y3fFh2P4KUtNduk3XHDqK2xPiOA6opMhzfUsJwfkQl+bXREmeY8oKbxWdFXUlyoIq+hqI6imnaHxyMOQ4JqbxUAA5t8oGbxRs55QEx5TECy+KSxldykgYZTlH05Wrp3LYU7kgNpTlcN2pdp0Ok5Ra7bDFWXRzQ5/Wfq4AeOrHLjzjy5XUXa5wWiy1l0qT9VSQOlcPPA2HzOB81Uy411Vc7jU3CtkMlRUyullcf6icn+ycVY0rNzetTXO+3B1ddal9TM7xcdmjyaOGj0CEFR1A4PyWtanGkhXJkqQW6TPimHOymy/Bx5rwuQ2NGFRuwoYTOYwN7qR482jOEU73gUMw9DnA+ag2MyiqYnu6GuIf4NcCCnMbEc55XhGMn73mvQQmIuv7KnaU7VejjYrrOJLtaGNjcXH35oeGSep26T6geamPu4T77R7x4yF86ezbVldorWNDqGhLj3D8Txg/zYj9tn4bj1AX0F01eKO82eju1tmbNSVcTZ4Hg8tIzhZMsNr4JxY/LTNld7zuPs/FcdqOw0t6oqyC4Qtk9x0bmEZ90gg/kcqRXxNcOtoGDutBV0TqW6vq8kxzOGc+BxghVxGfOrVlkqNP6ir7NU/zqOd0ZP8AUAfdPzGD81pntfJIXOdsBgBTz7X+mDatbUt5hjxBXw9BIG3Uzj/icf7VBJGHELfB7o2VPhmERLThOF5aNisJB04d8ivJD7mVNEeyVPZ51fLQ6gOmauUmjriTThx2jmxkY9HAEfEBT1O4YVMLbXyW27UtxhcRJTytlaR5tcHfsrjNqGVEDKhh9yVgkb8CMj9VTLsGhmZ3KAndyiah3KBmdykRB5XcpJqV3KSBhdO5bCnetVA5HQOQM5Dt+uTqXQbaNjsGuqmRu9Wty8/mGqAmKU/aNrS6qslCHbNjlmI+JDR+hUWRKcehodakSvMrwpkhOOWkfgvGP62B34rDq81jA7Er2efvBAx2NybqWgPDvA7FeRH6wt9U9IA5hafFIBuN2B3buPun9l604KwjHUwtdyF7nIIP2hz/AHQmA8DsrJ+xzr8tkn0FcZ+eqptbnHx5kiH/ALD/AHKtDCjbNcq20XakutunMFZSTNmhkH3XNOR8vP0KUo7lQJ0fTegmEkGB4cJVcTZ6d8R+8NvQ+C4zsm1lRav0rb9QUhDWVbMTxZ3hmGz2H4H8sFdu7krE1TJkIe0vp/8AxL2TV07I+qttJ+lM236WnDx+GVSSXZ2V9JbtSxG4VFLUMD6asjIe08EEYcP/AN5r579odhl01rG7WGUEGiqnxtP9TM5afm0grVgl8ISNC8dURHpsmwQ6P4hOxHITTB0uc3yK0FYA/PSQfunCtnoC4tuWg7JVtdnroo2n4tHSfzaqm1g6ZXeTgrBezzX/AEjs6FMXZdR1csY+DsPH/sVTLsnL+bJAndygZncoid/KBmdzukVoZldykmJX8pIGF070dC9amB6NhekBDXbxOZdbwx52ioYx+LnFcRFwun7Y5u+7QKwf+OKFn4MB/dcxHsFYuiSM/BYkpErFxTGYvGQcIZ7yyeNx8+k/NPueQha05hc5vI3UWSQQT01HxROdkGT19Eg4IBRTTlqaEYkYf1DxXkgOz28jw8ws14gZgCD7w4KcaU0R0En7p59D5rJpxsUCJr9lLXh07q92mq6bptt5e0RFx2iqhsw+gcPdPr0q69DOJ6Vr/vDZ3xXzAY9zHh7HuY5pBa5pwWkcEeqvf7Omvm600TTVVRI03GHFNXt/+Zo2f8Htw74k+SozR+koskS/Ql1M2dv2oXdXy4KqP7Z+nhSattuo4WYjudN3UpA27yPj8WkfgrjPAfG5jtwRghQZ7U1gNz7Iq2QM6qizTsqGnG/QD0u/4uz8lDFKpBLopVEcOIXkp6Zgf6gk73ZSFjUn3Gu8ittlQNW9Lju7GPxUv+zTUj+DXqmLvebURSY9C0jP5KHJ8chdv2A3I0ms5KMuwytpnsx/mb7w/QqmT5J16k/TP5QUz+VnK/ldNY7TZKjTVbPPcGl5aO8k6en6PjcbHnP58BJuitKziZX8pJusMbZXsjl71gOGv6S3qHng7hJFgPwv9UZA9JJCAgftPcXdoN2J8JGj/g1aJnCSSsXRJHp4WBKSSYzB243QNZlrTg7JJKEuiSCKI5pIs/0hFMOySScegZllIJJJiPCMjBTYyPdPhx6hJJAz1pyFJvs4a3dpDtCgjqZ+i23QtpanJ2Y7P1cnyccH0cUkkmrQF8qScTQNlH3huPIrQa5tkd0s1wt0oBjr6SSncPUtIH6/kkksa4Yz5u18T6eqfBKCHxuLHA+YOD+YTM5zAfTCSS3IrBZt2o3QtabfrK1VecBlWwO+Dj0n8ikkq59lkemWUkfjI8kO+okZHJGyRwZJjraDs7ByM/NJJIpQDLJykkkkM//Z',
        'rajiv': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MDg6MzArMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MDg6MzArMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EABwAAAEFAQEBAAAAAAAAAAAAAAUAAwQGBwgBAv/EADsQAAEDAwIDBQcCBQIHAAAAAAECAwQABREGIQcSMRMiQVFhCBQjcYGRoTJSM0JDYrGCwURyktHh8PH/xAAaAQACAwEBAAAAAAAAAAAAAAABAgADBAUG/8QAJBEAAgICAwACAQUAAAAAAAAAAAECAxEhBBIxMkEFEzRhccH/2gAMAwEAAhEDEQA/AM2ZbqU03t0r1lG1Smm60GbI2hunkNU8216U+ho0cAyRg16UPm3i0Qlckm4R21eXNk/igmpZ9zvN0VZLCy+602eWQ8yDgq/bnwFQ08NL8pguyi1GJ6JHeIrLbyq6nhs10cK25Zig83qOwuqKRc2EkfvJSD9TRBpTL7YcYcbdQeikKCgfqKy+56KukJalLkpWkdKBW9686cuyX4z/AGac5UnJ5FjyUKlfKhPxkt4dla2jbFN00pv0qNo+/RNSW9TzI7N9ohLzJOeUnoR5g0XWzWpbRk80wUtuo7iOtFHG6iOt9amApgxaO8aVPrR3jSoBDLKKmsN+lfDCKnR26ZIRsTTVR9ROuQtPzZLP8VDRDf8AzHYfk0WZa2qJqtgHTM0kbBCT9lChLSZI7kkWPhLpeJCtbcfAwBzLUeriz+pR+Zq3agt0UQ1YaAwOuKpmn9f6Ys7KE3N2W1zq5UqDB5evXPlVouuqdPJs6pvvaXWFbJV64ryzg/ZLbPawshjrB6Rj+u2QhZQ2Nqyu+sJXGfC+o/TV81XrWy3SW6iBGlvFBIJQjYevyqiTJCZiXByLbPilXUVrohKPpg5NsZ6TyRuDUpbGuWWEqPJJbcaUPPbmH5Fbk4z6Vi3BWGh7iPHUSAGmnlgE435cD/Nb68xjwruVfE85bqQAeZ9KgPo61YH2djtQuW1jNPgrTAriO8aVPuI7xpUBg5GRmicZraocNNGIiAcUyFY4wzXt2hJk2aUwvISps9PHG+PxU2O3SvgLOn57oPLyR1Kz5YGaE1mLQa3iaf8AICvPDe4zYT0dp6RyyHUOtKD4SG0Abox5E79M0xr3TcezcJzb2++oyclzrg4wSD5UeuXEeLFgwmH5SYMbGXneQqWoD+VIHiay7iFxbcu9mZtrFsbWWnFLCghSULGeuCc+W2a83CFtmNaPXznRVnL2zyNo9Vx0pDagMJ5u07VT3alJVtjlOBukdcf5qq3rT6rGyW330uug7lJyB6UV0NxHVb+2RLc7ND68lkN4QgnbI8qCa+vC3pD5UcE7AetXwVvfrLwyWSo/T7Q9BGlEtomtdg2r3tbyVNKHiQ5tj64rpqQwcnI3zvWK8CNJzbjeIN4kR3RAjZeDq0kJWoEhKUk7HvbnHlW9vtddq6/Gg12bOHy5p9Yr6RXJLWM7UImt7GrHNa67UDnJwDWhmRAF1HfNKnHh8Q0qUcNQ/CjcEUChHpR63+FMhWFoqPSprkNmZCeiSEczL7am3B5pUCD+DTENO1FYiNqOBTmDUSVQ71G09qMuqctEkocUlRT2rBGUnPqADmjN+1JaI1rTb29G8yiAUSA8shYPRQxt961Ti5w+i6uZhqhqbY1CCW4JP/E4CldkrxIwDg+BPrXNNwvF1hK90daeYSk/w1bYP/vjXOsoUXhHVo5UmssjXgRDzPORSy5kKSgLJwM7/WhkyY7PmFZypSiAkV8Svepa1HBIO5UelXXhhoOZfJKZC0LagJPxJBGOf+1Hn8/CjGH0vRZTzt6RvXBSTblaAtVnYkJM2HESuQwdlJ51qIVjxSTncVbZLYAO1c43/Wbmn+KDNwsSUFi1siEprPcfQM86D6Z2B8CM10Bp3UFr1PZW7panw60sd9BI52leKVjwI+x6it1ctYOfZHeSHPQMGq7cE4Jq0XFOxqsXLYqpmKgE8PiGlSePxDSpRwhCVvR+3L6VWYi8EVVdS3+4TpT0KFIWxDbPIotnCnT4knrj0qZwRRyapcNX2CzHs5twQXh/RaHaOfYdPriqnfOJt0mFUawsC3s+Mh0BTpHmB+lP5NZ6zGQynugZ6n1p9DK0ZcLh3H6R0xS9mOoJGpezn7xc+M9oky335TrfbuqcdWVq7rSt8n1Iqy+0JwvtD+pXXLLNtqpMkl1y2+8NpeZV/MoJJB5Sd8eGfKoHso2+VL1JeTAcMaUi18jcso5hH7RwcygPFWEjHh1J6b5vxlso0Pqy9WWRJduS0SgYzzxy46lxAcBWfE94gn0qi2CksG/gwUptN4NH0L7OsONGbu+rAl5xSQtqClQLaR4KcUNlH+0HHmT0pcYZ0fR+lVt21pDUmRliKEpwEjG6gPID8kVI9kdviLOjP++PBzSRT8NuVnCV5/oHqE+Y/T5YO9Z1xs1GjVGu5TkVWbdDJjRB4FKScr/1KyflirK0oRwjNyE3Y8vJixYUp0k5JJ6mjumXJ1ueM63S34klCykONKKTgeB8x6HanpNvcEkFpLaULH61k4B8sCiFvh+7sBsq5zkqKsYySaCQmS8WLiY6pKY2o42/T3qOnr6qR/un7Uedmw5zHbwpLUho7hTas/8Az61ljzCSOlQwp2K52zDq2VjopBwasU39lbgn4aM8fiGlVHRq+a2kIfitPLH85c5CfpSqdkToy6PyCzCedB3Sg4+fhVQhj4RV5qUfyaOXd/ltyhn9akj85/2oFEOIo+v+TQGj4OlOaefHw8D5V4gdynXBzLQPNQoBOlPY5tKmdPahvRwPeZqIjefBLSAVH/qX+K589om7taj4jT7vFWH4rk5aWHP3NIAQnf8AaeUkehrYbZqF3SfsmR1QnC1cL9MkMsqScKSHHVhah8m0H7isOukEPtRY6EZUpaGUJHiVKCQPzVcmdX8fVmMps6v4t6jiaK4IMNWoNxXrjFREgobGORKkZWofJGfqRXH7SCsE9M9K1H2mNUJvWuRZIbgMCxNCC0EnulxOA4of6gE/JFZe+4I0bISVrJCUIHVSj0FOcsiTe0kOiAyrlJTzPLH9NHp6nw+poglISgAdAMU3Dj+7MnnUFvLPO6v9yv8AsOg9BXi3d8ZqEPtzFCLm+lttTm2EnCR5q/8AFS5b5Q33d1KICR5k9KhRLTLv9yct0F6MgsMLcKnnQgHlBJ69cn7dTsKhCpSX1uPKUpRJNKmneZLiknlJBwcEEfcUqQY1S9rV2DQztzE/ih7BPYilSq0rXhOa/hmnCfjN/OlSqELtqWU85wx4dwlK+AiHKeCf7y/y5+3+arLr7kWfbZLWO0ZmtOIyMjmSSoflIpUqpl8j0HG/ZP8Ap/6BCtb81x55RW4tRUpRO5J3JNNIHaXVzm3DDaSgeRVnJ+eBj70qVWHBHJSiEnFQEqJWcmlSqEIchxRuSEk7IQtY+YG1V91auZSgohRyMg+B2NKlQCgev9RpUqVKE//Z',
        'padmini': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MDc6NDErMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MDc6NDErMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EABwAAAEFAQEBAAAAAAAAAAAAAAUAAwQGBwgCAf/EADoQAAEDAwIDBgMFBgcAAAAAAAECAwQABREGIRIxQQcTIlFhcTKBkRQjQqGxFRZSwdHwJDNDcoKy4f/EABoBAAEFAQAAAAAAAAAAAAAAAAMBAgQFBgD/xAAtEQACAgIBAwMCBAcAAAAAAAAAAQIDBBEhEjFBBRNRIvBhgcHRFDM0QnGRof/aAAwDAQACEQMRAD8Aq7LWamMNUmG/Sp0dn0qWRjy0z6VJbZ9KfZZqU0xXCEVDGelQ5NytMV4sv3GKh0HBR3gKh7gcqzPtb7QXk31zTFnkKYZYVwTX21YUtfVtJ6Adcbk7dN6lcVviGhFuBKyPhQMlXyFDlZoLGvZv0eVAkLCGJcdxSvhSlwEn2HWnlMelYLeLXcU2SHcG7dLZUWR3xS0QQsE7nG42wc1cuxfXki6zf3avb/fSuAqiSF/E4E80K81Abg8zg5ptV8bOw6yiVfc0NbHpTDjHpRlbPpTDjNGAAN1nntUN9rntRx5nntUB9rGdq4VAZbXipVMW3vSrjthWO1RCOzTcZuiUZulG7PrDO1ep7qYNrlzlDIjMLeP/ABSVfyqaw0KZ1JFQ9pi6srXwJchPIKsE8OUKGdt+tI3pbOinJ6RxfaItw1DqJuOwC7MmPFRPqo5UT+Zrtnsj0LbLBphLIhoekKSFOyFIypavfy9K5/7AtKyYOsb0zMYBuMFCGm9v4t+JOQOYxjI5VeZkvXy9SiO0b1bWkqwlKJalB7BABIA4QSN+QGPXaqDItdljgnwv+mjxKfar62uW/wDRqd/tiFtOJSxkb7AVy32j29zSeuoOoYbRYDctDikAYAIVk/IjIrdO1MakTbLZDhXCY29KZUuUttfCoKQMYSemawnUtsucy1FqaxK2eZ43FKWtSipQBGFc1DONtjQsJOEutMPnfXBwa2dJd2laQpI8Khkexplxn0osiOEMoQAQEpAweYwOvrTLrXOtIZQBvM89qGymudWB9sb0MlNjelFQDWjxGlUl1HjNKu0KFoyaJRUVCiporESKUaSo7dFLTHadnx2n1IS0txIWVgFOM9c9KixkbcqFdpMaa92e3wW9oOykxC602RkOFBCykjrkJIx1zTJdmLHuCr5HgWLW7c6G2ht1a3EPJC8reCVHCyDvsNvTGKukbUsO4ymYtsY45RRxOqIwEp/rVL7S47N5i2TWloiLVIdS3JMvhw26062ONvmeDxKSQg+p6GounZFpvyVRZCg0+kYCSstuNq68iDWTsh0SNhiW+9VtrlEnXGopSJdtQvT89iVFeUVKdWko4Dz3GxzttQ1Vygam1lZoMRtSUMuGU9hGccAyAfTOBmhnaBpl1ptx+XIgJjoIUS065xYHTc4HrijXYpannHpt+fYUyhxpMeMCnAKM5JHpsPpUnEpjO2OvAPPu9qmS+S+ON1Eeb50Xdb2O1Q3kbGtIZICyEc6FSk86Oyk86DzE86VHIDuDxGlTjg8ZpUooUipotDSPKhkQUZhJzjauECEZNT0cDbZcWpKEpGSpRwBWa6g7VtP2mU7BgJVdZTWUrLSgGkKHQq6/IH3qDpntRiX26otl4iJiqdXwsOJc+64uiVA8ieh338qHerK6nZGO9BaIQssUJS0FbpFQHk2+yPLFmQctRw1wIZUXFOLCCMcSVKOfENsYBxtULVel40w/bWQpmSkZ7xtRST9KvhajNo4i2pKevh5VAmxhIbJZdQApJBBrG2ZE7ZubNjRVCmChHsYHqKM9GuEdq4XCQ6wXU8feOFQCMjJx7V1FaWram1MizqZVACfuS0riRw9MGuc9e24xLc3dbk6hKS6Wu6T8aiM7AdelVONra9WSGlEG7Sosp3Ztph0hDDfIlX8Sz+W9aD0qMp9lx8lL6vGO+/Pwdcuo51CfTsaxHR3bndDGQ3eoLM8DA7xB7t0jHM/hJ2PQVrGmtU2TU8Uu2qUFuJGXGF+F1v3HUeoyKu5484Lb7FApp8HuWnnQWaNzR6YNjQKdzNCQ4EODxmlSc+I0qUUKQTyqtdr+p02mwfsaJIKLhcUlPgOFNs8lK9M/CPn5VYITnlWDa9lOSu0a8vOvd5wyO5R5JQgBISPofmTRKI9U+Rk3pDUeMwzFwEDIG5xQuQ8tqQRjiTzBFSpE0NOpRxgJcBT6pPQ+1DE3DuYqEBtLzq3CgpVvy3zVrbKOtLjQKCb78nSfYjr5GorSbHcXQbrFR4CvnIbHX/cOvnz86d7QNYwdPOmI02JlzcHgioPwg/iWfwp/M1gujrdfTcUXKDIERUUhZkMpIDJ9CeZ9P5U/qG4otxePereluqKnnnFcS3VHqT5/pWVv9KqeT9Pn+39/hffBoMf1CyNGpePP35GNbXiSZa5NykCXPKeFHDshpJ5JQOnvzqjuyHvs7jSlA945k7DdeMHB8gDj5mnpTzjzoeO7q/C2nyPn/fvUZsAvgp3bYTkHzI6/M1d00xrioorLbHOTbLBpyMZP2oNyWUOMpAQ24rhLgA3weVe4d4m2xhFxgSXI8pCvA42rCk5PShNt4ksOZ58JNeHV8VpCM7lYH51MUnGLbfgidKbOkuzvXi7xp9gX1YTMCRxyeAJbXn4eLGyT9AasU8kZ26ZrNuylltf2iI4hKmFxe7Uk8iKj6Xmyz2iSLK3MddhWyM6SgrJSlRUlIA+f6VmcXLlfdKPhclpfjRrrUl3Ly4rxmlUZ1z7w0qsCDonw3gCMnbNc/CLc7reZs1iI8+XZDizwDJOVE8ufUVtf2nu4zq8/C2o/QGqr2JQFrchzVjLbi3MEjywKZPJ/h11aD1Y6uemZrcG1pbXFlNqZeTu3xpKSCOm9CdKwhcdQf4k8KG1AKUrpk7863LtkkxHHHWnGWltst8RykHJrDLat5KH3mfuw8s4IO+BtRacp5bXTHTFnSsffU+DbNQasslt0w3Y9PRQ88lOAEjws+qz+JR54+vlWS3FlxS1SZi8kncD9BTtrmtxGVd6vKfIcyahzJRfe714eAH4Aenl7nzqfVjVY0OOZPuAd07pc8JEBwK3cOO8cHCgD8Kev9PrSQ0EICB+M5PsP7NOKUlbylABHESQAchI/8FIKySvGM8h5DpTdi6CEhEJDRXDcWQpvxIWN0H360LioLzsaOn8ToJ9hvTyl4aIHWndLsLeurjoGUsNlXzNByrfbob/AdVX1WGk6fvyLBZLhcSpIW21wtgnmtXw/Tn8qj9hYW+q/Xh1RUp5xpkKPM4BWr81CqDrmagpi29t3CVJCnSOQJ6fT9a1vsLsjzuio7LC2kOyO9mKLqwnI5Dn6JHtnNVGFWq4fi+X+n7/mSsqbm9fBYXXfGd6VD3nsOEEjbbY5pVNIR6mLULZKwf8AQX/1NUHS+pb3p+1N/s+cru2x4WnG0KRvuemfzpUqY4qU0pLaJND1GTRF1bepl1s0uXJ7sOOEcXACB+tUVp9xq0RQg4LigknG4yelKlRcH6ZT199hMrlR2MOzZKh3Jc+7ZUrgSBjGeZ9TtXpbrhc4SokJxSpVNQLwPJJ7lR6lYR8sE/yqxLix16NRM7lCX23uALSMFQ4iN/OlSoFzacdfK/UfX5/wA1/5ZPkCat/ZxHbUw/xDPeocCvkkYpUqi+rf07/ILifzCk6pYQgCQCorXIcBydgBkD9K3W1JEWyQWGMpQ3FbSnHlwClSoWO9xY3IWmhta1cXOlSpUcjH/9k=',
        'deepak': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MDY6NDUrMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MDY6NDUrMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EABwAAAEFAQEBAAAAAAAAAAAAAAMABAYHCAIFAf/EADsQAAIBAwIDBQUGBQMFAAAAAAECAwAEBQYRBxIhEzFBUWEIIjJxgRQVI0KRoVJicoKxJMHRM2OSosL/xAAaAQACAwEBAAAAAAAAAAAAAAAAAQIDBAUG/8QAKxEAAgIBAgMFCQAAAAAAAAAAAAECAxEEEiExQQUTInGxFCMyM2GRodHh/9oADAMBAAIRAxEAPwCWolFSOiInSiolMiCVK7CUZUroJQAEJTHM5fD4W3M+XydnYRgb7zzBCfkD1P0qBcaeIkunpV09hZY1ycsXaXE++5tYz8Ow/jbw8h18qzzf3Nze3j3c8X2iVm3MkrGR38dyT160sjSNHT8auHcUpj+9bmQBiOeOykKn1B27qk+mNXaX1L7uDzVpeS7bmFW5ZQPVG2P7Vj64hEiCSWz5Iwd2PIenpXnx9vZ3Md9jLySOeFg0bxsVdCPEEd1JNMbi0buKVwY6r32f+IU2tsFPaZZo/vrH8olKjbt4z0Em3nvuDt032PjVllKkIZlPShtHT4p6UNkoEMinWlTkp1pUAGRKKiUSNKMkdMASx12I6Osdddn0pAYv4hR32U4y6igbYzNkniPkFBCr+wFX5w04W6bjt7aS+tlu5QBzF/hB+VVVr7ETpx9y0duvLJcX6SRjfv5o1Yt/k1dmB1hhsCGt7xMjOsC++1tbmQA+RI8a5HaE5ucYRZ2+zK4KuVkl5E0yuhdLy2PYSYm05VG4CxgA1TnFHhnpr7G0ljYpa3BHR4em30q5NN630vqW3aTGXdx7qktHPEUcDx6Gqy4m8QNKw3suLtkvb68QHcW0fMF+Z7qxtWKXg5nQg63H3i4FI8EDd6Y43420Y/hXjyWbkdzK6nb/ANlU1rvk3FZR4fBMrxv0vMiyJGb4uVcbMrIrNsf2rW/Z9K79MnKCbPNXxUbGo8hkUobJT5koTJVpSMinWlTkpSoAPGlGRK6jSnEaUgBpH0oix+lFRK7VKYFC65wUtpxOs8/fXCzSzySIWWPlVFUERg/zcp29dqkV7w0uMtF9pschd28Ui+9HBN2WzH82+x7+u/Txpxx/gubbTqXsQLRRXcU42TojDdW3b13Hf415UfFWTDaQNzCU5S6w9qeoQnxI8wB3eNcG6E1bx8v0em01lcqntwur9H6Ew0Loe203fGWTlkup0KMA5ZQpG23X/NVjFwyTJ2t2LDZbqO9l7XnmZDuCdt9u8dx2o97xtu7K7tJsFYvlrcBTK1yv4sjHxVlOwHpttUBsuL+Zs9RZDJXsEdmJpGeO2RunU9Qx/Men0ojTbzRJ6ijlN8D18Jo+70/xX0rYrdO14l4skksZ6sux5voV3B9K00U6VRPCLJy6s41i/nCyJZYyWdCp+AvyKu//AJGr+Za6mkUu78RxNe4981EZslCZKfMlBdK1GIYlOtKnJTrSoAPGlHRaUa0aNaQHxEoipXaLRUTc929AEZ4kYpMtoLM2D/ntWZf6l95f3FY2u8rDDO+Hu0U2xmjZu06dQw2b57bg1oLWHFOyHFXDQQSdrgcXcMLqVDussjAoZB5qgJ28/ePlTfj9wPiylu+o9LwLKrL2jRQjcqD13UD4kPf5j5VC2rdHdjJfRZtbjnDf2f0PEstcS4nGtcaa0vbSWFwu7hdlWNvH3R5+dVlrnMHJPfZPLY2CCaWPki93cg7779fAf715dzmc5i8O+M7Moyr2ZIHeB06/pTHT+RTLanw6Z6E3OPW9h+0xeMkfOAy/Lb9qx10rhx4G+3VSaaxh+SNG+yXpG9xulrzVeVhMV3nOT7OjDYi2Xcq23hzE7j0A86ulkp0scaRhIQgjUAIE+EL4bem221cMtbksLCOU3l5Y0ZaCy08ZaC60xDQr1pUUr1pUAGjWnCLXjao1BitMYWXLZecxW6EKAq8zyMe5VHiT/wAk1nvXHF7VefmkgxLyYPG9wWB95nHm8nePkuw+dCWQL71prvTGj4CcvkF+07bpZw+/O/8Ab+UerbCqB1/xa1JqrtLSyZsPim6dhC/4kg/7j95+Q2HzqAi2eSVppnaR2O7Mx3LHzJPfR+zAHKKkkM4jYOPIitJ+zFrv7xxraMyku9zZoXx7seskI+KP5p3j+U/y1mgwlJeftTynoQR/vXq4DK3uFzFplcdL2N3ZyrLC3huPA+h7j6E1OEtrISjuWDSvF3hFjtTCXI4yOOzyhG/Oo2SY+Tjz/mHXz3rPujeHN2+fvry+jSKHFOyvGZFLPN1UdAfhXqSe7fYedaL1ZqvUer+HVrNw3SCC8yUW097PJyrZN3PCviZSegPco69+1ZLfH5PFa2s1cvgs5Bfx29yXG3/UO27D8yknr3gg71fHSVyn3vVfkj7VYq3U3/D1tIcYtfaGuDinu1yeNtJDAtnfrz9mikhQjjZ1G223Uj0q99F8fNFZyFEyzTYC7bYFbgGSEn0kUdB/UBVMcbNKTYyTH5WW1WBrtXimQHcCSM9+/iCrDr6VWwhEUe6HoDsfSs9le2TRKEt0cm/bK7s8haLd2F1Bd2z/AAywSB0P1HSvrrWF9KaszekspFkcJfS27o4Z4gx7KYeKuvcwPd5+VbY0rmrXUmmMfnbMFYb2BZQpO5Q9zKfUMCPpVeCQ5I60q7I6mlQBnf2m8893q+1wMb/gY6ASOoPfLJ13PyUKPqaraxbpXo8Srz704nahvSd1a/kRf6U9wfstefFsF6dKkgOnflflHce6krbmmd7LyLzfwHf/AJokcg7welABpU3G4+o86bdtyMNz3U55xtTG+ToXX9KALy9mLVHY5e50ncyjsr3/AFVgCeguEHvL/co3/tNQ32j2+18UprxJDGGltYlfwQiE7H57naoLgMvd4zIWuTsJeS8s5kngbyZTuPoe75GpfxqyVjnM+2QswBa5Oyt72Jf4SRsR81ZSPpW/RyTbTM10cPJMdV5GPXPAZ8qVAvsXdKLpR+WRT2ch+TBlf61RHJzWzjb3gpH6VZ/AOc3uO1rpaZiwvse1xGp/jClT+4Sq2jH4kq+Z3/WqdRHEiyl8DwbpvcI8xWsfZPypvuGU9i53bH37oOv5ZFWQfuzVka7fatFexHeNdXeqMQrqNoLW6UM23whkP/zWVlxoZu+lXL/ERSpCMP28jzXDyyMWd2LsT4kncn9TTzc8hpUqkB51+x5GG/hXOMkd7ZCx68opUqAHgY+dJuoIPdSpU0B5iMUuSB3UW4uZXNvEzbrAXWMeSseYj5bkn6mlSq/S/MK7fhJvwEkeLi5YIh2We3uIpB5r2Zb/ACoqG3oCZi5jXoocgfqaVKrdXzRXR1Idesevzq3PY1uJY+KV1CjbJNiJucefK8ZFKlWBmnoa3J60qVKgR//Z',
        'harpreet': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MDU6MTgrMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MDU6MTgrMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EAB0AAAEEAwEBAAAAAAAAAAAAAAcAAwQIAgUGAQn/xAA7EAACAQMDAgMFBAkDBQAAAAABAgMABBEFBiEHEjFBUQgTYXGBFDKRoRUiQlJicoKSsaLB0RYXJDOy/8QAGgEAAgMBAQAAAAAAAAAAAAAAAAECAwQFBv/EACoRAAICAgEDAgQHAAAAAAAAAAABAgMEETEFEkETISIyUXE0QmGBkcHw/9oADAMBAAIRAxEAPwDr0SnFjp1EpxUpkRpUrIJT6pXlw8Fray3NzKkMEKGSSRzhUUDJJPoAKAGwgAJOAAMk+grlNZ6h7S0uR4n1A3cicMtpGZQD6d33fzoM9SepV7uzUZLHT5ZLXQkbCRA9rXOP25PgfJfAeeTXMG6jSLHjgeArVXjprciDn9A03PWzbcUyouk6vIp8WCxjH0Lc1udtdUdm67fLYxX8lldOe1I7yP3Qc+gbJXPwyKrPcXTPOyRouQMsWJAGfAZA8fOtXeB1yXiIB8wcg05Ux8ApMvEY8Z4rApQf9m7qBcasrbR1q4aa6giMlhO5y0ka/ejJ8yo5B9Mjyo1MlZXHtZIhGOsDH8KmFKwKUgIZSlUkpz4UqYEhEp1ErNE4p5EpDGlSg77U+5JNM2zZbdtpeyXVHLz4PPuYyOPkWI/tNGtI6rB7XSyr1A04tn3f6LXs9P8A2yZqytbkJgrsnOcZoi9Jdh3m+tyx6bHIbayjxJeXfuywiTPoPEnwA8z8AaHOhQXF7fwWdpE01xPII4o1GSzE8CrddFNX21tjT02k6Xmm6uSHujcwYE8nhnuHGPID0+tPLy/Qh8PLL8XG9aXvwcT1p6MaRtW3k1vZVzeT2H3ru2nDNNEfOQHGHQ+JHivxHgA9R7ct29ob4eBq7vUzcugbd0xrrUr5iHGFjjXuZj6YqmvUK2T7fJrGnaXc2OlXUh9ysuOG8SBjwB5wKz4WfKzcLF9maMvCjWu6t/dGn2jrUu3N26ZrkBINncpIw9Vzhh9VJH1q9KhJEDxnKMAyn1B5FfPuVgQ2fAg5q+2xlnbZGhNdZ9+dMtjJnx7vdLmtFnJgJhjpsx1OMdNslVAQSnNKpJTmlTAkInFPRpWUafCpEcdIY2kdAj2xNAafb+j7iijJNnO1rOwHgkgyuf6lI/qqwKpWm35tuHdezNV29MyoL23ZEdhkRyDlG+jAGpRensNFTvZ52dc7j1281GG6a2+wRFYWTxaZ1IHyAGSfmKNNn061KKf7XeXjiGHBjPu0VkI8Rkctk45PkPrQv6Fave9P91alo2u2r2kyzFZ1k47HXj6gjBB8wQaIOr9boLmK5nt4TO/f2Q2rjtj7P3mI5yfLyHx5rkZissulo9Dgyrroi29c/wAm035thNwdQ4EndjHHp6PHDx2lucnnjPgeaG+++mOsJoGoXOoXj9iKGgDdoLyDPJC8AeVSdzdY7nU9y2V9pmjnTYI4ESW4mcGTAOT2eWD6nxrDf3Vhde2k8EOA3d2ScjkePcMVRCF0GtF8rcecWm/H6gT2Loc+5d56ToMKMzXl5HG2P2Uzlz8goY/SvoAIURQkShUUBVAHgBwB+FCT2ZumFnt7Q4d435W41fVYPeQccWsD8hR/Gwx3H04HnkylK7rezzDIZSmmSpzJTTJQR0QinNKnyvNKgCTEnFPotKNeKeRaQzxVrNVrNVpxFoArv7XugTH9E7hgg70CtaTkDgnPcmf9Qod9Pdw6TodnHd2ujJPfpOWZ18ShA/Vzg+nhVheq3bvMXfTvRZI5tRNrJd3BHPujGA0cWf32bHyHzqpUUl9t3ULiK4t5IZVZh2uhBQ+efT/ms91an7GvGulV8S4CVvzqIN02S2c2hw2dsHHvFOP1ueeAoz9aG1po67s39a7e0S3WEXdyI07Vx2oxyxb4KuTWrl3NcTQyLPg4YsuOSSTXT9E7jV9B1q53vb2gli0mHvlSQcSqxAZAfJivcQfLAqNdXa9krr3YtLhF3LKzhsrGCytk7YLeJYox6KowPyFZMtRtra/o+6NDh1nQ7xbqymHDDhkbzRx+yw8wa2DJWpGIhstNstS2SmWXxoAileaVOsvNKmIkxinRhULsQqr4sTgD5muJ6t7vutn7dhudPt4Z766lMUImyUXCksxAwT5cfGq965qu5tyTGXXdZu7tTyIu/tiX5IMKPwoSGWJ3d1P2nt0NF9tGqXo8LWyYSEH+J/ur+OfhQo3B1T3brzSpbypotj5RWpPvG+DSHn+3FcLDYpBHhFA+lZ2lvIGaQTOEPiueD/x9KaQBC9ni7Fp1UsveMWa7EkLsTkkspIyfXIFGfrB0h0zdcU2r6bbQxaoy90y4AW4wPE+jfHz8/Wq67Ivf0TvPSb/OFgu4pD8gwz+WasR7Q+gb63FtKf8A6W1L3Ftaj3r6ZECJNQTHIZvLA8EHB8+cYhbBTjpl+NLVi99FbdG6Ga7ru63tLbSZrKyVgZrmWIrHGuTkgn7x9APH5c0TOqWzdM2d0nutH0uEpF2pGXblnd2ALMfMkf8AFDLpnNvPUd+aPY7J1C6sbuSNZriUMWjiizgq6HgrxyCPhR29pgy2ux9Ps7oxG5uLtTIYwQrdiMSRnkDJHFV40dLb5NXUq1XZ2xa0VS2tqmv7U1czaRqV5YSE5YQyELIPiPBvqDR22l1p1FIo03Dp8V/EQP8AybTEcmPUof1T9MUKbmzhuYgj5BHIZeCPlT1nHDCggiUIEH3R6Vfo52yzWjb62lq7LHaa3bJM/hDcZifPphsDPyNb914z6+HxqpUsasDkVutob61ra2oWyLqMkulm4jSe2mPegRmwxXPKkA549KNAWUI5pVm4AYgHI9aVIQGPaCvxPuXTNMDAra2xlcejSNj/AAo/Gh1BjtA444/Ctz1N1FdS6g6xco2Y45/cIfhGAv8AkGubtZx9rkjJ/iH1qS4GT3AIrC3AAZPQ8fI173V5nDBvXg0xCfuW4RlODzg/Hyq32tbxttE6TJvGRgR+jY5Yhn70rqAg/vIqoEx5VvQ0R99a0+o+zZtrSkfLLqb20w/hgLOv5MlQm9RbNGLV6tsYfVnN+zluA7a6t6cNQChdfeSxnY+UjMHjbP8APlf6qI/ta3udV0jT8/chknI/mIUf/JoCakz217p2oRMVks7hJlbzBVg3+1FD2ltUXUep1ysbZS3t4Ih9U7z+b1VQ/bR0es0qFqkvP9A8VQyDI59ajW7Dvmlzw74X+UcD8807O5jtW7fvEdq/M8CohcIgRfBRgVejjEieXEZOfCuc3BcFtPTDYMpZvp4D/FSdYvfcadK4PIXj503b6Jd63fjTLWW3R7azLsZpQg/VXJHPx/DxPFA0W36dayNf2HoesZy1zZRmT+cDtb/UppVxfsq6pB/2q+yXM0fdaahPCoLg4GQ+Pl+uaVQACQmkm95PI2ZJGZ2PqSSTUGKV/wBKxc/eVgaVKrAN4hJHjWZ5Q/KlSoEeScoamJdzvo6aez5t0ummVfRmjVT+SilSqq35GdDpf4qH+8M0uvDu0+UH90j8q2m5LyfUNdmu7pu6WUgsf6QP8AUqVV0eTp9e/J+5rr4n3kS+QVm+vh/ua1k8rKGxilSq886c3eTyTTW8LnKNcpkf1CndSdjcTSdxDMWBIPr40qVNAQtN3Bq+kxyW+n30tvE8hdlU8FsAZ/AClSpVWSP/2Q==',
        'anjali': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MDk6MjErMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MDk6MjErMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EABwAAAEFAQEBAAAAAAAAAAAAAAUABAYHCAMCAf/EADcQAAEDAgQDBQYFBAMAAAAAAAECAwQAEQUGITEHEkETIlFhgQgUFXGRoSMyUrHBQnKy8KLC0f/EABoBAAIDAQEAAAAAAAAAAAAAAAMEAAIFAQb/xAAlEQACAgIBAwQDAQAAAAAAAAAAAQIDBBFBEiExBRMyUSIzcWH/2gAMAwEAAhEDEQA/AIm03fpT1hrSvjDVP47PlTYts8Ms+VOW2PKnDLPlTlpnyqHBohjyr0ttttBW4pKEjdSjYUNz1mWLlfCu2cCXJTtww0TobbqPkPvtVMYzmPEsT5pkyW46o6hN7BI8Ep2FUlNIvGGy92eweF2XW3OncUDXoseVZ3wediksqkgvojNixWFEa/MVOuFnEZ2Riicv5ge7RTiuSJLXuVdELPW/RXoarC1S7FpVNLZZKmPKuLjHlRlTPlXB1k66UUEAnWN9KZPs76UeeZ30pg+1qdKh0CKasdqVPVt940qmiBKM1eiMZmucVuiUZuocPrLOlOUtBKSpRASBck9K7x2qAcUsUTg2RcTkBfK4phTbeutyLfzUb0Rd3ozjxRzW7mDM8l1lSiwHOzYSP0JNk/XU+tXbwK4SYdIwhOI5pjrlSnUhaI5UQlodAQNz43qhuF+E/FM+YMmQkLYckFVvEoHMAftWh8UxXiDCxtuBhnxSCyFAdojkU29pewTym3hvr1IrGyrZOahF65NvCoioOyS3wib4xlTB48ByNGwxltmxBQlsWrJ/FXLqsv48p+IlTcV1ZKBsW1f7tWl+IkzNnwfCYcGW5Hly21qluNpAUkp3t4Xv0qgM+xsblZclPYozMKmSk9q+4VFZv59R5aUrhtxl1b7MczUpw6Wu65Li4R5gOZ8lxpb6+aWx+BIPUqT/AFeosalLjOh0qkvZXxAoxHFsIWoFLiEOo+aSQbehFX241XoYPcTzU1pgR9jehslq16kL7Y1oXLbGtWKoAuN940qduN980qhAnFRRSKimUVNFIqK6cHLCNKozjpikifmaVgrqi1BgMNqKTp2il9R4gfxV+R29KzL7QOKzxxElwMSjtstNtoEVaBZS2Trcn583ytQrPASryNeCc2BFlYjCmOMNOtBMyG+4q3KoLCCgeagRb1rUmGZsYlNxYLUQolq0U47ohAG9z1PhWGH0BM5KorpSN7pJ0HzrSPDbNMPE8vwhmNtoMy2+UOuIu2tQ0N77K0rCzaWpe4uT0Xp16lB1Pgl+dswzWZ2HJVg4bdiOrUXjLQttSD5jf5dKrbjxmmPieAFiM0WrI5zfS53FvHapNnzCsAREVIVjOHvsoAIbQwgKNtgSNxWfuI2YvjM8Q2AQwwbE7cxAtb5AUPGqU5rXAxmXKqtr7HnCDFfgebYE4E8hc7NweKVaGtdJKHmEutkFC0hQPiDWHYby2HmxH5ioKBTbe/Sto5ELr+SsLkP83aOx0rVcWNz5dK36nweXtXJ2kI3oVLTvRuSnehMwb0YCB3E940q9uDvmlViBSINqLRE0MhDQUahJqpB9GRptVB+1vhTxn4LinuS1RgwtlT6RcdpzXCFeFxcj1qys+cRIOWJfwmMz73iikBVifw2b/l5rak9bDy1qic+ZixvHZi3MYnPyFJSQ02e62i/6UDQfPfzpe22K/Hk0cXAssXuPtEgCGX5TYQpKUJaTyAgWJ8qu7gU3HmZOmYFODbimHiQhVieVXW3zquWMMZVdKVWddSl9pd9drKA9f3p5hThgICmlLSsOaupWQvmO2v2rOyF70Ok2cbD9mfUSvOeBRMObdWwgAg8ug2qkZbavfZBV+btVb/Or7y82czwcTjTHXFSOzAbfUPyKIsCR123qsIeA/Gc2Q8HWS0p6b7s4tNiQSdSP3oeJJwcoy4KeoUOa2g37OOALxfidBfLK3I8FKn3iG+ZKe6QkK6C5OnyrW7zYSmwFgBYCoLwTyEcow1Oxn1OKkpSp8kfn00v6GrVcw1qS3+GvsnLbK1Sf/Kfoyq/Bh3UT2Q+Wm16CzRvUkxSK6wOZaQUK/KtJuk+tRyduaei01tCjTXZghz8xpUnT3zSqxArBO1O8cxhnAMtYhjT6OdEKOp7k/WRsn1Nh60Pw9e1BeNM1mNwvxRDouZJbYbF/6isH9kk1ST0my1ceqSRR7U+XiOJycVmr7SRIeK3Cf1KOvpXnE5SJTzjDm3acnNbVJOgP1t9aWDothhV1OtMJhbTInKUo8p5XE/I6H71leWeyinCpLhjmCXXYPu6TyyoaypvzHUV896JUtxKAUuCzjZrq41zO+8R1EOnU28aZvhYdUVJ5VHVVqiOS3FaJPw+x1GFZljmUu8F9QYeKuiVHRR+R/mnPDKIH+MCAAC3EkS5JI27qV2+9qhKVKCwrU2+lWn7NeGmXmvFJdr9lCS0P7nXUpP2SqhzioqUl9C9s9x7mlsvMhtlbP6EJT9EgU6U7Zhs33Sa54WA2l5YASlXMoepNMsRkJYjNrUFWS2o7a70CC0jMk9s84c/2mEIV3VEDlIULgi50NQ/MZY94BjtdkCgFSbki5J/i1GcoyQ/gyitQ5E8ylHyuai+LSS8+46dOY3A8B0H0p/Abcn9JCuVpL/QS6r8Q0q4Or75pVqCISgO7a1AvaKmkZfwqGFaOSVuKH9qQB/lUvhOVWftASC5OwmMOjSlfVVv+tBuf4MZxI7tRFmyWcLSnryBVAMYfUtxlTQBU8lTZ8PGir79n3GlHupbA+1RjtimSpsm/IokG/jpWdBHpcmzUelfwl2ETZw7Nl4R3UqH5kI5Sn5+NOMUa5khwixtQTApnKu17ijGIyULikE2vXGtMPVLrq7sEu+F7VoL2UoQRgWM4mU3LkpDaT5Ntk/5OCs5uvAq0Nat9nyD8O4ZYWlYKXJzipK7/AKSbj/iEVS746M66WkWi0lKWyhJBskJqM57liLDcN7WbI/ejaJIDSVgW51FXpVecUpizCcSV68gUfkTQYiI0y9iKmcpNMc1lzF8lr/0C6lH7AetNpr2+tRDKeOe/5lm4alQ7LCYjTaf716r+lgPSpVDhv4rJXHYcZQpLanCXFhIsBfr/AKNzWngQ6Kup89xPLluzX0DHXe+daVMHnCHCCRppob0qeFtBOIo6VWXGlRXm3CkK1Ajj/NVKlQL/AIDmB+5EKxdRExdtLp1oS5FatHfPMVPIcKgTp3V2FvSlSpKBr5fzX9ObLq0r5UnlA6Ci/OpSOUkkBNKlVWHo8M54awiVisSK7fs3n2212NjZSgD9jW0cOaRFhRmmB2bbcUJQkbAE2/YAelKlS93lCuQF1nlCANggW+tV1xPWfdMUVYXAZSNOlKlVUKIorgm647mnFpDi1Fa45UrXclwGrNlOLFyCQbWpUq2qPgI5P7GDHFq5jrSpUqMAP//Z',
        'zara': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MTg6MzUrMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MTg6MzUrMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EABwAAAEFAQEBAAAAAAAAAAAAAAUAAwQGBwIIAf/EAD4QAAIBAwIDBgQEAwQLAAAAAAECAwAEBREhBhIxBxMiQVFhcYGhsRQycpEjM1IVJEJiFjRDU4KSosLR4fD/xAAaAQACAwEBAAAAAAAAAAAAAAAEBQABAgMG/8QAIhEAAgICAQQDAQAAAAAAAAAAAAIBBAMREiExMkEFIlFx/9oADAMBAAIRAxEAPwC9RrT8aUo0qRGldzns5RKdSOnY46eSOpooYWOulioljMe97ciJNh1ZvQUJ7Zu0DFdlfDcD2ePTI52/YxY+2b/Gw/NI5G4RdR03JIA06jDPCmlWWHmgkUatG4HqVNccm1YDccV9vHF+QW4GYy2JRCHSK0iFpF8xoSw/UTV+7P8AtGydxxLbcF8e2Mdpl7kctlk4l5I7uT+h0Gysd9GXYnbQaiuK2UZuOzu1XIq8pjoXxo/amnSiU0DRuyOujDrUd46JBwc6UxItT5EqPIlQshFN6VPlaVUQmxJUqGOuYUqbBHWjIoovapEcPtT0MNSoodulQhLwnLb2kr6eJnAHyrLr2zTNdsOSzV4iTJYImPstRryBRzSEehMjNv8A5RWkvMlviZLtjottI7N8k1H2rAcnxdc4m9lge4zEV3I5cJj7VX5OY/mdmB11J+X1pNddn+i+xx8akLM5G9G4tbRGH+WTtWSdt/D39oYY3FkphyVkwubOYDxJIh5l0PuQKsPBfFGanwuRkyV093JaRGRXkhEbNprt4dj06is0y/GmTknkOXv85pJoUWK2UQxgnQA6r4t6W40bntfQ3do4abtJvtlcjLYe1yYBHfxRyEHy50D6fLUimpYtjtULszuZLzg2171QkiQxqyjoCpZP+2jksWxr01duSRJ5XKvF5gCyx9aiSpReeLrUCaPrXU5EArvSp4pvSqECNsmtEbeOoVoKLWqairIPQRa1Njir5bx7VKdkt7dpnGyjXT19qm9EKhx7NNY8F5gRoWJaFj7IZArN+xFAMKuDvsV+LyIi/hr101J9quFxbrksNNb3K/wLmN45P8qv1H/C2jD2rK4MT3Mj2jTvbXcE2mhHMoYHqV8/UfKvN3Y+0Mel+LaODLP9DEmcwFteXFncPHjozA6iKSMqQNNt9NN/QGo2Dk4cy+OW5e3jaeJfC7IQrjyYa/tQ/Jf6SmFkvp7W75d0IxYcex3bb60G0vI7OWXOXyNLoe5jgh7rT47nWheERHSRnPTrJqPZYVlw166kFGvHRCPNV3+7GrPNFtQrs2xT4vh6ysJF5ZViMso9Gc66farDPF1r0tONYog8fbaGzNMAO4j60OuE60buo+tC7petEg4MYbmlXbjxGlUIT7PyozZjpQOybpRiKeG3hM08qRRqN2c6AVZNhm1WnJ4DdKyL0XYfGqbk+NYEikgxcDzSFSomfwqvuB1P0oXw5xJk8bMCzCeHXxRkAE/A+vxq3q5XXpBzWzjVusmm2eO7u3EbKNdAGHkaqPHHAQyqtdWExtr5VAR/JgOisPMehG49xV24fykGVxdvkIAe7mXUEjTQ+YPoR6feiEsaOtJ3x72rQMsWWUnksnnbKZrirh61NnkcROSo5RIiFlb5qDVa4QxOf4k4qGaylhcR4uFwUiZCGuHB10AO4Qabk6ak7dK9O3Vo56Irj3odcWxVG5oWT1KuRQq14Wega913XUgvhy7hW/ks7yQDISr3mmuxHp7fD0FF7lOtZpx3HlbKa2z3D6zxf2fI34pwoYlGGzaEbqDrr5b13iO0m6KBctZRzL/vbfwt/wAp2P7in1TE7YuUCTPlRX1Jc7tdjQe7HWiFnkrPK2C3llL3kTbHUaFT5gjyNQLzzrcxoqJ32Bkn5jSr5I3iNKqLHLCTcb1R8nmrjI5aWYuTbrIUhTyCjbXT1PWrHNddxjrmYNoUhYg++hqj2S6WCMBqykt+xo2msTMyBW21EQWGJ15Qw6H6U+swReb0oWsoVQQf4Ug1B9K6W4EkRGviVgGFMdC+JLrwdx6OHcS+Ilwd3fRpM8qTwzRgBG0IXlbckHXp7VasBxzBkrn8JJatZztqURm5lcezev8AlO/xrH5p/wANIkzDWNW5JD/SD0b5H6Gp6v77igctDHk3PsMx3HTUejcTdLKOXlk18uTrQvJxLIQtzd3MkasG7lfBzaHUBiN9PbbWq7wDmbvISyYu6uhJIF54DMvMSB+Zdeuum/71c7nBTuFb8QI0J8fIu5HxPSkGeo+N5WRzgsLkTlBnHG3F2RxmTigxb2ry90TdJNCJEbm/Kp3Gm2vTyNZuJJi0sk0EEDO3P3UAPdpr1C66nQe5q7dpXD1vhMzMbRCsdye/OpJ1c7MdT66CqlKAYQ/oRr8Ohp/SxKmKJgS28jNkmJDPZ3kmtc9Lj2Y91dJqB5cwBIP0Iq6Xr9ax83k2NyVrdwn+LbzqNfVddfsCPnWp3VwrrzKfCw1HwNcrS6bZ3qttNEaR/Gd6VQ5JfGaVChQC4kuSmAnUHeQpH+7ChOMP91T3GtLiicnFxLr1nT6amuMaf7sn6RR9PxkAt+UE2AoqNbsdFJ1XXyqErmLKvAT/ADIucfFWA+xFSnQON6HScy5q25zrrFIoPr+U0cBBx9GkZDoVdehr5ZsYT+GckgDWNj5r6fEfbSmpH0aJvbSn2RZotOblYHmRv6T61CQT7C8msb2G8t25ZYXDofcf/aV6B4fyMGWw8F5CdY5owwHp6j5HavNsUpZSHHK6nRl9D/4rR+xjPGO7mwkz+GTWWDU+f+JfsfkaBv4eSc47wGUsvFuM+wv2xY03GCjvlXV7Z+V/0tt99KxhBzRSRn0Ir0pxFZrf4i9snH8+BgP1abfXSvNZ1S4dTsdd6xQfaSv4aurp9/oEzTaRJN6qNfiKvWGyH4zA2dwSOZoVDAeTDY/UVRMxvjZB/Trp8jRrs072+gusfHJGpjJnXncDwkb/AFH1rVuNxslSdToPyS+I70qHyTaORr096VAbDyt8SsfwEG/+3H2apWM/1ZP0ilSphT8Rfb8iZQzIEjKWRB85B/00qVGgcE+RiY1qTau3LSpVZUHNySJI3HUtyH3GhNSsPeT2eWtLu3fllimRlPz0+1KlVN4yaXvB6Uc6xIT11FeZM+oiz19GmyrcSAfAMaVKlXx/dhje7QVrKsTZTD9X3NQuD5pEysfKxHPGVb3Gn/qlSovP4yD1/KC1u7cx3pUqVKxof//Z',
        'priyanka': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MTM6MTgrMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MTM6MTgrMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EAB0AAAEEAwEBAAAAAAAAAAAAAAQABQcIAgMGCQH/xAA1EAABAwMCBAMHBAICAwAAAAABAgMEAAURBiEHEjFBE1FhCBQiI0JxgRUygpEkUlOhcpKi/8QAGgEAAgMBAQAAAAAAAAAAAAAAAAECAwUEBv/EACMRAAICAQUAAgMBAAAAAAAAAAABAgMRBBITITFBUQUiMqH/2gAMAwEAAhEDEQA/AJDZboppuvjSKKabqQGLbdbkN1tabrNeG0FR6DegDVhKRvQRu1rTJ92VPih7/TxU839ZzVc+O/E26XK4y7JZLguFAjEtOraVhby+hGR9PbHeoYtbE1uQZMt9wg7/ABuHI8sntSyMvum424kj32NkHGPFGc/bNFhAI23qgq2T46nGpJC+pO6yT55JqTuEXFK86WvUWBd5Ts2yyFBsla+bwSTjKSegHcdKMhgtSpr0rUpqi4rzUphLrJylXSvq26BDatuhnG6dHG+tCut9aYDYprelRZb3pUDCmUUYyitTKaNZRQI+oRgVDvtA8Sm9NsfoVtdCrq+3zZHRlJ7n1PYVMz/y4y1gZ5Uk48/SqOca3Vr4gTFvOLXJUoqeKj0JAIA8sDb8VFgjlVFxa3VuOqU4tfMcbkk7k19g26XNwFFwpPfzPlQkdalyuaOXVOBQASg7qq23ArRUSHZ2pVyjJXLfSFkupyU+m9c1+oVKX2dWn0zuz30isZ0rcwolLEgOE9OUigZsWfbnFNyWXUAbqS4Ov2q9N+skApOWGioDY8oqCeM+m2HYC1sNJDyQeTA6+lcsNfLftkujtl+NjxuUX2OnsxcRFymFaduskuJYITHWs5UAf2jzxnb02qwhSFJyK8/+G5uMXVvPEC0SWUqUsAfsSOqlegOKvpo64JvOmYVyBGX2+ZfoobH/ALFacWZLNrjfWhnUdadHG+tCOt9akIbS3uaVElG5pUAbGE0cwihY4pxjpoAa9UzmbdaVuPE/H8CUg4JPp+Ko1xIkO3PWV5uclJaU5hcdPIQFoCgkY/jg5q7/ABAtj06wPLjJK3WWnClI6nKCDj1x0qENf6Fb1U+i9QfkM+GtpoJGCAQCh0jslQwn+IqEnhZJQWXgiv2dtNMXefNvM5JVHtyweUJySo771Ys63/Q4YlDTLrjIHRU5pDoHmUb4+2ajbgNo5mBLu1snqIntyMhxp1SPhKRy55SMj0NdrdeESLisT2XyfmJcWHnFkBSeqVDO6cjoax5zjO5t+G7VXKulR8Z09s1zar/bHZqGHYoaTlxt7GUj7jY1EOtNbC8SFx7dZm/ABIEiS/yBR9ABvUkWvQ8ONY7tBYf94aERSStskAvk8xx5BOwx64rgLfw+YvFuansyo6XW0LZfSpOVJJJ5ts4z5HyxiowVe5uRa+TbiBGmk5j9k4qRZyYKSJsdyO6wXByuBRCdj3GSn8Vb/hREbicP7PHbWVpRHG57nJNQFaNCC76oZtER4clvjuSCdiFrJCEBR7bkn+qsppG3OWu0M21RCkRkhtKu5wBua16HmCwYWpi42NMOcRtQbqOtObiaEeT1q4oG1SNzSohSdzSoA1xhTjHG1N8anKPQARj4Dt1plc09FCpKm0BoPNqSUjoAdyPyd/T80/tJzWM6MXYa20kjmBBI69KQFf5rarPrzEdIaW4xhIK8lXIog5H2I86eNSaqkfpTaHICeZ1aWlSCjmDYPfYZNcjxdu7LvE5nTVmMRu422MXSvk+ZIfO/uwV2Ib+LHdWB1rfo/XluekNicrwHEkcyF7cqumaxtXQ6Z5iumeg0OoV1eJeodtRz4jNrQnT+qrpHYDPhBpERa2k5yVEYRkqJ36muK0TeBEVLgxHnbi6G+Z1UlkjlA6fuG1Spe4FruUMS497kxEr3UlhzCVGoqeiy5upE6V0fHenzJWefBzjPVa1dEpHcmqY4n+sfTrlKMI7n/pI/sxw3Z9w1NfXm0+FzsxmwBtzDmWSP7T/dTeGwkHbrvTVw30nH0bo+JZGXA86jLkl8Jx4zyt1Kx5dAPQCnxwVuVQ2QSPM32cljkBOpoN5PWnBwdaDfHWrCkAUNzSrNQ3NKgAWNTlGptjGg9Waw0/pC2e/X2eiOlWfCaT8TrxHZCOp+/QdyKEsgdax0qPeMXGCw6ChvQmVpuN/KD4cRtQIYJGynj9I6Hl/cfQb1CXEDj9qW8h2FpxH6FBVlPiIVzSlj1X0R/Hf1qF5Ti3VrW4pS1qJUpSjkqJ6knuaujT8yI7jKXOmTLm5dH5Trk154yFyObCy4VcxXnsc7+lS9ZbfD4o6deuENAa1Zb0ZuMdoBJlt9BIbSOpP1pHfcdcVCTKilamz0G4+1PWlb/c9NX+Le7PILEyKvmQQdlDulQ7pI2IqVtMbY4ZKq2VUt0Tonot9t3MwzcpAZHROTihNLX29aY4hWW6Wyc41K8coWTuHEkboUPqSfKrC3eyaX4oaFOurNNZs01LSnJ4WMtBaBlaXAN0qH+w/cCDg5qHIejZx1Xa3XEBREthTZSeYFJUNx5jFZPDZp5rf5n01OavVVtQ6f0THaPadssO+SLFrzT02xTI7nhrkRD7ywe4VynCwCCD9XWpc0nrPSmr45e01f4FzwMqQy58xP/kg4UPyKqf7X2nYMO9Wu7RSPeVR0sT0AdP3FlZPTcBaf4ioPtsqVBlNyoch6O+2ctutLKFpPmCNxWrKrDwZEZ5WT01c70G/3qtns5cdLvN1BG0frSaZqZpDUC4O4DqHfpbcP1BXQKO4OAcg7WSfOxqmUWngmuwRXU0qwWv4jSqIxivd4i2GwT71NP+PCYU+4AdyEjoPUnA/NUo1NqG6amv0q93WQp2VIWScnZtPZCR2SBsBVhvagvRg8N27ag/HdJiGjv9CPmK/7CR+arI3+2uipdZISCPEyKwKgR12rDPrWoK3Un8irWxCkICk84zt1wcHFJoJSCpK1KB7FWcVm2Ry1q5ChRKeh7edIDr+H2q5NhkP256a8zZLmW27k2gc2UJVkLA8x3x1TkVaCVYEw7A1dbIWXZLQSuI4ClSMqGAsbfEMK5h54FUxQv1qwnsy67EqMdBXeQcp+ZbHFHsNy19xupPpkdhVkZ9bX2imyLT3x9NPFDhrqGTpi5XqRNenzJK0uykrOStbWSkjy+EqAA26Cq5cvKVJ8q9IVxW5kORC/5GwpBI+odD/YFUS4z6bOmdeTYzbZbivK94jjHRCicp/ioKT+KUnkVTx0cUpx5hbcqM4pt5pQWhaTgpUDkEfYgV6F6NvyNSaKs1/QtKvf4TT6ynpzlI5x+Fcwrz1UPhUjt2q3fsdTHrnwhEAuoKrfPkMgKVjlQeVwD/7Nc9q+TpiSytfxGlQjjhCyM0qoJFc/a1ecMvTbHN8sNSF49eZAz/QqE0ftpUq6q/5K36JRoZxRDzeD1VilSpsEb0dVfes+1KlTGaVjCtu/WtsGZJgSmp8N5bMmMsOsuJOChaTkEfkUqVIRfvRdxkXDTNsuL/IH5MRpxzlGBlSQTj03qBvbMtsRDUCelvD4lKb5h/qpvnI/9k5/JpUqsZzQ9K1E7A+lT97F82QH9WQAv/HCYz4T5LPOkn8gD+qVKqLfDqiWCWTzHelSpVQTP//Z',
        'thomas': 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4QM7aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjUuMCI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIiB4bWxuczpJcHRjNHhtcEV4dD0iaHR0cDovL2lwdGMub3JnL3N0ZC9JcHRjNHhtcEV4dC8yMDA4LTAyLTI5LyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiBleGlmOkRhdGVUaW1lT3JpZ2luYWw9IjIwMjUtMTItMjZUMDc6MTE6MTYrMDA6MDAiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VGaWxlVHlwZT0iaHR0cDovL2N2LmlwdGMub3JnL25ld3Njb2Rlcy9kaWdpdGFsc291cmNldHlwZS9jb21wb3NpdGVXaXRoVHJhaW5lZEFsZ29yaXRobWljTWVkaWEiIElwdGM0eG1wRXh0OkRpZ2l0YWxTb3VyY2VUeXBlPSJodHRwOi8vY3YuaXB0Yy5vcmcvbmV3c2NvZGVzL2RpZ2l0YWxzb3VyY2V0eXBlL2NvbXBvc2l0ZVdpdGhUcmFpbmVkQWxnb3JpdGhtaWNNZWRpYSIgcGhvdG9zaG9wOkNyZWRpdD0iRWRpdGVkIHdpdGggR29vZ2xlIEFJIiBwaG90b3Nob3A6RGF0ZUNyZWF0ZWQ9IjIwMjUtMTItMjZUMDc6MTE6MTYrMDA6MDAiLz4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/9sAQwAFAwQEBAMFBAQEBQUFBgcMCAcHBwcPCwsJDBEPEhIRDxERExYcFxMUGhURERghGBodHR8fHxMXIiQiHiQcHh8e/9sAQwEFBQUHBgcOCAgOHhQRFB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4e/8AAEQgAZABkAwEiAAIRAQMRAf/EABwAAAIDAQEBAQAAAAAAAAAAAAUGAAQHAwECCP/EADcQAAIBAwIDBwMCBAYDAAAAAAECAwAEEQUhBhIxBxMiQVFhcRSBkTKhFSNCsQgzYsHR8HKC4f/EABoBAAIDAQEAAAAAAAAAAAAAAAIEAQMFAAb/xAAkEQACAgIDAAEEAwAAAAAAAAAAAQIRAwQSITEyBSJBoRNC8P/aAAwDAQACEQMRAD8ARkSrESV8xLmrcEdWix7FFVmOKukMW1WY4vauIsrFQoJJAA3JNLl9xvw7aytEl0906nB+nTmGfnYUF7YL7ULiaDhvS27tpU726fOPCThU++5P2rzs/wCyea/EUl3dhlYjPL5Utn2oYfkx3W0smfuKGLTuMNDu+UGWaBm8po8fuCRTEqB1DKQwIyCPOr7dj3D8lmwms5pmUfrMpyPjFLOi6ff8O8Snh+eea5sZIne2llbJBBBC/Zc/iqtbfx55cF0y7b+mZNeHN9oLNFXF4qKtD7Vwkh9qeozLBMkftVeRMUUkj61VmTY1xKYPK71K6su9SuOJAlX7eOq9slFLWPOKlIg7W0O3SraQbdK62kOR0q/Hb7dKJIEw3j6QWvHt/LJzYVYdgMnHIMYp97O+PNAtpIrO6jvbZ5CAkkkeFc+gIJ39qReJdIWTtDv9N1AvyzXGTIWO6P4lwT6A4+1NWsadw1oY03Sf4hb/AFH1CTp3ionL4lGcgbscDb0FYW3xlNprs9PoRnCCcWqNU1fj3RdL1M6PLFqMt4SRyxxqFX55iPKlbV2j1PiPSr2AMFV5CVYYI8JBB/NMWvaXwlqutQ3VzdWss5kWIz4WSMMRlA+QcE78pr1NCsbe8ltbdwIbWBRGYzgg83QexA/FJ68lDLCSXY5tY5Twzi30D3g9qrSw7Hajslv12qnPBsa9TR4yxfmi61SnTrRy4i2O1DLlMZoaJBbJvUrqwGalQSe2qijFlHnG1C7QdKO6emQKNAhGyhorDb5HSuWnw7DajFvEMdKIEyvtj4WMtqvEdoJDcW/Ikyg+HuwThvsSM+1ZnaWw1TiC3Oq3hfTrzxxKIAzgZx5++a/SPF13YaZw5fXN/JGkf08gCMwBlPKcKuepPpX584S4ot9Ni7mW1WcMQ8Z5Qwz7f8VnbUVGVr1mto5JShUu0h61HRI/4N3HD2rzGxgjQ3EMsOefDDODkYIGWzudqfeD4Gns5LvLMknKqsdy2Buf3pX0LW9U4g06PT49PeIybSTcvKqKfJfU04aCkGmXsiCRmikKpIwBKAhQBjy2x+5pLXlD+Zc/x+jQ2lN4JLGqT/Zemtxg0PuYcA7UzGKOSMPGyuh6MpyD96G3kAAO1bx5oVbqLrQa8XrtTNfR4B2oBfL1qGiUBnXxGpXSQDmNSgok+LLfFMWmAbUt2LDamPSyCRRoFjFDNDbWz3FxIsUUa8zOxwAKTeJO00rHJa8O2p70xlkvLmPKD4TOT5fqx1Gxq72hqToGnwkkC7lZxv8A0psDjz3P9qS9R0+Czs0aJonM/hdQd023z+dsUjsbTjLjE0tXTjKHOXZn+vya1qOqJqer3NzfS4J/mtzMCdth0UdRgAYovwLoltqd41uiyW98rK8IAIDrndiOmw3yKZLSziEsNzFHCXBCGAr5bjxZ8zRLhTTfpNXupYIC0fhRYS2eUSZLFSPLYD2pGU+S7HseOnS6GTQNSu4LeIWFvzpszc8LZYdcOTgA49CPij0hMVvHbQxNPJIq8zIWHJvk5PqM4zXLTJWu0kt4reJbmRSzd43IAOmAfXfH5ohp89vBOVuHmV0JBaNyMb+Xl9/PApfrxIZla7fpz1Ge60rubyAiCGcheQYIBHqvU5x871ZtdaivSIXhcTHyRCcj1x1x+aC8RlzeCeSIhJAGyc4cHJwp6e58jTb2WaZFqOvQ3JwyWyc4ULsT0Ufn84pnWy5IvjFi+xgxThymuwJeGN4+8jZXU9CpyDS7qIG9bX2mcP2kulXF/ZQJHc247xyi471f6iQPMdc/NYlqB2NbUXaMCUaYGl/WalfEpPOalCcU7F+lH7OYxwuR1CnFK1jLjFM3DbxS6lbxTMRGzcpIGcZB8vMe1S3SZKVstdqsqpqHD1iviRLFghTHiyVIxn1FLEluzSxg86EDzYbHJyD519dt5k05tNEh8NrG6IytkEc2V99iT13oZps4k01u8QrIOXx8+S7H/kZ+PtWTmT52bOtOoUELuBooO8gWZWDrz8yjnPTBAPkcH8e9FdHvwHuGEka99d4aL3CAZ9CAc7dOvpQqQtNaYn76XwkKf1BcY2P/AHzqjpcF7NbQz3GoIlghd1iGSysZCuDjyIHXOKpr8DNU+Ronfc8KB5IS4I8WNmPNgcvp6Gi+nSNlV+ntpcBTgyFTy4JJPv129hStHqzWDRxQw25MiuCO55gAM4b1Gc+fpXltd3ETNgmVg4wecDA9SfPeqmmrsNtT+IwXkEszo8jNKgyYFYjDHA8j0ON8e5xWjdj/AHEcGoXQRI3aRF5R5MATjbY4zWTy3V1cO8jxOHLBQC6gMD0AGdzt8U89i9xI1hdEISDLhFBzgco336f7UxrKproo2Z3iav8A1mqXXJPAY5BlJFKsD6HY/wB6/NeuxvaXk9q4w0MjRn7Ej/av0Sru4JJB/wDHoPv51hPavCLbjPUFAwsrLMP/AGGT++a1oMxJoTZW8ZqVykbxHepRlYCtJvemjh3nLRTAE/zB09M0i2svpWr8L2dtHpUcU+oxW8nLkqAS2ffaq5vqi2C7FPt9nRr/AExmUt15s/1e1IvCuoJ9W/epz2yJ/lh8Eb/PT7U0dvEqx2mnzxSd+sUwQsOhztSDpcT/AFrW8BA8CuzFsALjf+1I5lbNHXdRNGtbido3VgUGAxDdMe/p19tz61T029eK2t0sVcxpEjIWflYtsSMdCA2D80Pjulks75beSRmeMhULZG+d/kHpirdhaS2l431l2pOQqjlOFA2IPkNhSvjHI/d72GbaeKO0e4MzyXL4MsJGO6JJOxP7j3NFdL1CSeMxSSCJFUuJXwFQ46tjfy/NANNVlvJT36xqgJEjoSpbl9PcZA9z71cvppBYOvewzHmyVjj5SgwAc+v9OPigav0JS42l4dbq/wDpGMPeQ3AScp4RzAnoNycjcj5IFat2JPy6DMxOXN1KGcNzByHIyPxWKRytcCSBHhjfuzyBjzczZ6D2I/8Au9al2IXF7acDaaIdRNusqc5ygZSxJJ6j39aa1u5C27FRjSNns5Q2RzsSB0NY326AR8S28g6yWoz9mYVqun3VywHfCKfPSRF5c/bOKzTtk06bVOItPgt5IUdbKVyZJAowrE+f/R1NaEWZMvDKZJfEd6lU5XIcgkbbbHNSjsChd05yLiI/61/vW+WsyycLnUTb2yzrMUGIhjG1SpVcyyJkvbZObnSXmkROZyA2BgHG4PyMdaz8uRqSNgczBQTj161KlK5PR3D8WM86LbInc5UseQtnfHMozn1waJwwLNJOJWZ2DN4mOSdid81KlKy6i2OYvmkFe+e6s1707QtyqF8O2w3xuauWvLb2dzJGikjKgMOYDBByAfOpUqhr7Wi/+yYEsYo0EmF8cMiukhPiBxn4xWif4bpJL7h25JkeBraR0HcnAcc5wGU5U49cZqVKa1G3Ji28koKjX9HuWKyoEjX3VcfsNqybt6Zl1XTMMc/TSDOf9dSpWlEx5GWOx5jUqVKME//Z'
    };
    
    // Helper function to render staff avatar (image or fallback to initials)
    function renderStaffAvatar(staff, size = 50) {
        const hasHeadshot = staff && staff.id && staffHeadshots[staff.id];
        if (hasHeadshot) {
            return `<img src="${staffHeadshots[staff.id]}" alt="${staff.name}" style="width: ${size}px; height: ${size}px; border-radius: 50%; object-fit: cover;">`;
        } else {
            const bgColor = staff?.avatarColor || '#003da5';
            const initials = staff?.initials || '?';
            return `<div style="width: ${size}px; height: ${size}px; border-radius: 50%; background: ${bgColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: ${size * 0.4}px;">${initials}</div>`;
        }
    }
    
    // ============================================
    // STAFF DATABASE - Diverse Indian names/regions
    // ============================================
    
    const staffDatabase = {
        senior: [
            {
                id: 'meera',
                name: 'Meera Venkataraman',
                initials: 'MV',
                gender: 'female',
                avatarColor: '#003da5',
                role: 'CEO & Co-Founder',
                location: 'Chennai → Bangalore',
                shortBio: 'Visionary founder with deep industry expertise. Strong opinions on strategic direction.',
                fullBio: 'Meera co-founded ShieldTech after 12 years at Honeywell, where she led the Security Products division for South Asia. From Chennai, she studied engineering at IIT Madras before earning her Masters in Management at Warwick Business School, The University of Warwick. Known for bold strategic bets and long-term thinking.',
                cv: [
                    { year: '2015-now', detail: 'CEO & Co-Founder, ShieldTech India' },
                    { year: '2008-2015', detail: 'VP Security Products South Asia, Honeywell' },
                    { year: '2003-2008', detail: 'Product Manager, Siemens Building Tech' },
                    { year: '2001', detail: 'Masters in Management, Warwick Business School' },
                    { year: '1999', detail: 'B.Tech, IIT Madras' }
                ],
                style: 'Meera favours strategic, platform-oriented projects that position ShieldTech for the long term. Less focused on short-term ROI, more interested in market-shaping opportunities.',
                strengths: ['Strategic vision', 'Industry expertise', 'Bold bets'],
                biases: ['Favours platforms', 'May overlook execution risks'],
                effects: { strategic: 1.3, market: 0.9, hiddenGem: 0.7, slowBurner: 1.2 }
            },
            {
                id: 'farhan',
                name: 'Farhan Qureshi',
                initials: 'FQ',
                gender: 'male',
                avatarColor: '#0891b2',
                role: 'CFO',
                location: 'Mumbai',
                shortBio: 'Numbers-driven executive focused on ROI and capital efficiency.',
                fullBio: 'Farhan joined ShieldTech during Series A and led the company through its IPO. From Mumbai, he trained as a chartered accountant before moving into investment banking at Goldman Sachs. Sharp eye for unit economics and capital allocation.',
                cv: [
                    { year: '2017-now', detail: 'CFO, ShieldTech India' },
                    { year: '2012-2017', detail: 'Principal, Sequoia Capital India' },
                    { year: '2007-2012', detail: 'Investment Banking, Goldman Sachs Mumbai' },
                    { year: '2005', detail: 'MSc Finance, London School of Economics' },
                    { year: '2003', detail: 'CA, ICAI' }
                ],
                style: 'Farhan prioritises projects with clear financial metrics and proven demand. Skeptical of exploratory R&D without clear payback periods.',
                strengths: ['Financial discipline', 'Quick ROI', 'Risk management'],
                biases: ['Short-term focus', 'Undervalues exploration'],
                effects: { cost: 1.4, market: 1.1, hiddenGem: 0.6, moneyPit: 0.5 }
            },
            {
                id: 'sanjay',
                name: 'Sanjay Hegde',
                initials: 'SH',
                gender: 'male',
                avatarColor: '#059669',
                role: 'COO',
                location: 'Mangalore → Bangalore',
                shortBio: 'Operations mastermind who turns strategy into execution at scale.',
                fullBio: 'Sanjay oversees all operations including manufacturing, supply chain, and customer service. From coastal Karnataka, he built his career at Infosys and Flipkart before joining ShieldTech. Known for systematic thinking and operational excellence.',
                cv: [
                    { year: '2019-now', detail: 'COO, ShieldTech India' },
                    { year: '2014-2019', detail: 'VP Operations, Flipkart' },
                    { year: '2008-2014', detail: 'Delivery Head, Infosys' },
                    { year: '2006', detail: 'MBA, IIM Calcutta' },
                    { year: '2004', detail: 'B.E. Industrial Engineering, NITK Surathkal' }
                ],
                style: 'Sanjay evaluates projects through an operational lens — can we manufacture it, support it, scale it? Pushes back on technically elegant but operationally nightmarish proposals.',
                strengths: ['Operational excellence', 'Scale thinking', 'Execution focus'],
                biases: ['Favours proven models', 'Risk-averse on new processes'],
                effects: { team: 1.3, cost: 1.2, paperTiger: 0.6, conventionalWinner: 1.2 }
            },
            {
                id: 'nandini',
                name: 'Nandini Rao',
                initials: 'NR',
                gender: 'female',
                avatarColor: '#f59e0b',
                role: 'General Counsel',
                location: 'Hyderabad → Bangalore',
                shortBio: 'Legal expert who navigates IP, compliance, and risk.',
                fullBio: 'Nandini heads legal affairs including intellectual property, contracts, and regulatory compliance. From Hyderabad, she practiced corporate law at top firms before moving in-house. Sharp on IP strategy and risk assessment.',
                cv: [
                    { year: '2019-now', detail: 'General Counsel, ShieldTech India' },
                    { year: '2014-2019', detail: 'Senior Associate, AZB & Partners' },
                    { year: '2009-2014', detail: 'Associate, Cyril Amarchand Mangaldas' },
                    { year: '2009', detail: 'LL.M., University of Cambridge' },
                    { year: '2007', detail: 'B.A. LL.B., NALSAR Hyderabad' }
                ],
                style: 'Nandini evaluates IP potential and regulatory risk. Champions projects with defensible IP, cautious about those in regulatory grey zones.',
                strengths: ['IP strategy', 'Risk assessment', 'Regulatory insight'],
                biases: ['May be overly cautious', 'Slows fast-moving projects'],
                effects: { strategic: 1.1, conventionalWinner: 1.15, hiddenGem: 0.85, pivotSuccess: 0.9 }
            }
        ],
        heads: [
            {
                id: 'rajiv',
                name: 'Rajiv Kapoor',
                initials: 'RK',
                gender: 'male',
                avatarColor: '#dc2626',
                role: 'VP Sales, North & West',
                location: 'Delhi',
                shortBio: 'P&L owner for ShieldTech\'s largest and most competitive markets.',
                fullBio: 'Rajiv runs the North and West India business — covering 55% of company revenue. From Delhi, he built his career in FMCG distribution at Hindustan Unilever before moving to tech. Known for aggressive market tactics and deep retailer relationships.',
                cv: [
                    { year: '2018-now', detail: 'VP Sales North & West, ShieldTech' },
                    { year: '2013-2018', detail: 'Regional Director, Havells India' },
                    { year: '2008-2013', detail: 'Area Sales Manager, Hindustan Unilever' },
                    { year: '2006', detail: 'MBA, FMS Delhi' }
                ],
                style: 'Rajiv thinks about channel margins, retailer incentives, and competitive response. Champions products that his sales team can push through existing networks.',
                strengths: ['Distribution expertise', 'Competitive instinct', 'Revenue focus'],
                biases: ['Short-term sales focus', 'May resist premium products'],
                effects: { market: 1.35, cost: 1.1, hiddenGem: 0.75, slowBurner: 0.8 }
            },
            {
                id: 'padmini',
                name: 'Padmini Ranganathan',
                initials: 'PR',
                gender: 'female',
                avatarColor: '#059669',
                role: 'VP Sales, South & East',
                location: 'Chennai',
                shortBio: 'Runs the profitable South & East markets known for quality-conscious customers.',
                fullBio: 'Padmini leads South and East India covering Tamil Nadu, Karnataka, Kerala, AP, Telangana, and Bengal. From Chennai, she rose through ShieldTech\'s ranks from regional sales. Known for building strong customer relationships and premium positioning.',
                cv: [
                    { year: '2019-now', detail: 'VP Sales South & East, ShieldTech' },
                    { year: '2016-2019', detail: 'Regional Sales Head South, ShieldTech' },
                    { year: '2011-2016', detail: 'Territory Manager, Godrej Security' },
                    { year: '2009', detail: 'PGDM, Great Lakes Institute of Management' }
                ],
                style: 'Padmini values product quality and brand reputation. Champions products that justify premium pricing through genuine differentiation.',
                strengths: ['Premium positioning', 'Customer relationships', 'Brand building'],
                biases: ['May resist value products', 'Conservative on risks'],
                effects: { market: 1.2, strategic: 1.15, conventionalWinner: 1.25, hiddenGem: 0.9 }
            },
            {
                id: 'deepak',
                name: 'Deepak Shenoy',
                initials: 'DS',
                gender: 'male',
                avatarColor: '#7c3aed',
                role: 'VP Products',
                location: 'Bangalore',
                shortBio: 'Owns the core product portfolio — ShieldTech\'s bread and butter.',
                fullBio: 'Deepak runs the Product division including cameras, sensors, and home security kits. From coastal Karnataka, he joined from Philips consumer electronics. Responsible for product roadmap and 65% of company revenue.',
                cv: [
                    { year: '2017-now', detail: 'VP Products, ShieldTech India' },
                    { year: '2012-2017', detail: 'Product Director, Philips India' },
                    { year: '2007-2012', detail: 'Product Manager, Samsung India' },
                    { year: '2005', detail: 'MBA, IIM Lucknow' }
                ],
                style: 'Deepak protects the core business while seeking growth. Champions products that strengthen the portfolio without cannibalizing existing lines.',
                strengths: ['Core business expertise', 'Portfolio management', 'P&L discipline'],
                biases: ['Defensive of core', 'May resist disruption'],
                effects: { market: 1.2, conventionalWinner: 1.3, strategic: 1.1, hiddenGem: 0.8 }
            },
            {
                id: 'anjali',
                name: 'Anjali Deshmukh',
                initials: 'AD',
                gender: 'female',
                avatarColor: '#ec4899',
                role: 'VP Marketing',
                location: 'Pune → Bangalore',
                shortBio: 'Brand architect who built ShieldTech\'s consumer reputation.',
                fullBio: 'Anjali leads marketing, brand, and communications. From Pune, she created the "Safety for Every Home" campaign that drove awareness. Expert at consumer insights and brand building, with experience at P&G India.',
                cv: [
                    { year: '2018-now', detail: 'VP Marketing, ShieldTech India' },
                    { year: '2014-2018', detail: 'Brand Director, Flipkart' },
                    { year: '2010-2014', detail: 'Marketing Manager, P&G India' },
                    { year: '2008', detail: 'PGDM, Symbiosis Institute of Business Management' }
                ],
                style: 'Anjali champions products with compelling consumer stories. Evaluates how well products can be marketed and differentiated in crowded markets.',
                strengths: ['Brand building', 'Consumer insight', 'Storytelling'],
                biases: ['Marketing-centric', 'May favour flash over substance'],
                effects: { market: 1.3, hiddenGem: 1.2, paperTiger: 1.15, strategic: 0.95 }
            }
        ],
        tech: [
            {
                id: 'harpreet',
                name: 'Harpreet Singh',
                initials: 'HS',
                gender: 'male',
                avatarColor: '#2563eb',
                role: 'CTO',
                location: 'Delhi → Bangalore',
                shortBio: 'Technical leader who built ShieldOS and leads 200+ engineers.',
                fullBio: 'Harpreet leads all engineering across Bangalore and Hyderabad. From Delhi, he studied at Delhi College of Engineering before joining Amazon. Built ShieldOS from the ground up and is passionate about technical excellence and scalable architecture.',
                cv: [
                    { year: '2016-now', detail: 'CTO, ShieldTech India' },
                    { year: '2011-2016', detail: 'Principal Engineer, Amazon India' },
                    { year: '2006-2011', detail: 'Software Engineer, Infosys' },
                    { year: '2006', detail: 'B.Tech Computer Science, Delhi College of Engineering' }
                ],
                style: 'Harpreet evaluates projects on technical feasibility and engineering elegance. Favours projects leveraging existing capabilities, cautious about unproven tech.',
                strengths: ['Technical accuracy', 'Platform thinking', 'Engineering leadership'],
                biases: ['Conservative on new tech', 'Undervalues market factors'],
                effects: { technical: 1.4, slowBurner: 1.3, conventionalLoser: 0.5, paperTiger: 0.7 }
            },
            {
                id: 'zara',
                name: 'Zara Sheikh',
                initials: 'ZS',
                gender: 'female',
                avatarColor: '#f59e0b',
                role: 'Head of AI & Data Science',
                location: 'Hyderabad',
                shortBio: 'ML pioneer who turns data into product intelligence.',
                fullBio: 'Zara leads the data science team that powers ShieldTech\'s AI features. From Hyderabad, she studied at University of Edinburgh and did research at Microsoft Research India. Expert in computer vision and anomaly detection.',
                cv: [
                    { year: '2020-now', detail: 'Head of AI & Data Science, ShieldTech India' },
                    { year: '2017-2020', detail: 'Research Scientist, Microsoft Research India' },
                    { year: '2017', detail: 'PhD Machine Learning, University of Edinburgh' },
                    { year: '2011', detail: 'B.Tech, IIIT Hyderabad' }
                ],
                style: 'Zara champions projects where data and ML can create defensible advantages. Skeptical of AI-washing — wants genuine technical depth.',
                strengths: ['AI/ML expertise', 'Research rigour', 'Technical depth'],
                biases: ['Favours data-rich projects', 'May overcomplicate'],
                effects: { technical: 1.3, slowBurner: 1.2, conventionalLoser: 0.6, hiddenGem: 1.1 }
            }
        ],
        junior: [
            {
                id: 'priyanka',
                name: 'Priyanka Chatterjee',
                initials: 'PC',
                gender: 'female',
                avatarColor: '#8b5cf6',
                role: 'Senior Product Analyst',
                location: 'Kolkata → Bangalore',
                shortBio: 'Data-driven analyst with fresh perspectives and no sacred cows.',
                fullBio: 'Priyanka joined after completing her MBA at Warwick Business School and has impressed everyone with analytical rigour. From Kolkata, she\'s not afraid to challenge conventional wisdom with data. Brings fresh eyes unburdened by "how things have always been done."',
                cv: [
                    { year: '2021-now', detail: 'Senior Product Analyst, ShieldTech India' },
                    { year: '2021', detail: 'MBA, Warwick Business School' },
                    { year: '2019', detail: 'B.Com Honours, Presidency University Kolkata' }
                ],
                style: 'Priyanka relies on data and challenges assumptions. Particularly good at spotting overlooked opportunities and questioning "obvious" projects.',
                strengths: ['Fresh perspective', 'Data-driven', 'Challenges assumptions'],
                biases: ['Limited experience', 'May miss political factors'],
                effects: { hiddenGem: 1.4, market: 1.1, conventionalLoser: 0.7, strategic: 0.9 }
            },
            {
                id: 'thomas',
                name: 'Thomas Varghese',
                initials: 'TV',
                gender: 'male',
                avatarColor: '#dc2626',
                role: 'Senior Field Engineer',
                location: 'Kottayam → Karnataka',
                shortBio: 'Customer-facing engineer who sees what happens in the real world.',
                fullBio: 'Thomas installs and services ShieldTech products across Karnataka. From Kerala, he talks to customers every day and knows their real pain points better than anyone at headquarters. The voice of the customer in R&D decisions.',
                cv: [
                    { year: '2020-now', detail: 'Senior Field Engineer, ShieldTech (Karnataka)' },
                    { year: '2018-2020', detail: 'Service Technician, Godrej Security' },
                    { year: '2018', detail: 'Diploma in Electronics, Bangalore Polytechnic' }
                ],
                style: 'Thomas knows what customers actually struggle with and which features they use. Brilliant at spotting products that solve real problems, skeptical of those designed in conference rooms.',
                strengths: ['Customer reality', 'Field insight', 'Practical needs'],
                biases: ['Incremental focus', 'May miss tech advances'],
                effects: { hiddenGem: 1.35, market: 1.25, paperTiger: 0.65, slowBurner: 0.85 }
            }
        ]
    };
    
    // Professional avatar configuration using DiceBear avataaars
    // Configured with South Asian skin tones and gender-appropriate styling
    const staffAvatarConfig = {
        // Female staff
        meera: { seed: 'meera-ceo-2024', facialHair: '', top: 'longHair', accessories: 'prescription02' },
        nandini: { seed: 'nandini-gc-2024', facialHair: '', top: 'longHair', accessories: 'round' },
        padmini: { seed: 'padmini-vp-2024', facialHair: '', top: 'longHair', accessories: '' },
        anjali: { seed: 'anjali-mkt-2024', facialHair: '', top: 'longHair', accessories: '' },
        zara: { seed: 'zara-ai-2024', facialHair: '', top: 'hijab', accessories: '' },
        priyanka: { seed: 'priyanka-analyst-2024', facialHair: '', top: 'longHair', accessories: '' },
        // Male staff
        farhan: { seed: 'farhan-cfo-2024', facialHair: 'beardLight', top: 'shortHairShortFlat', accessories: '' },
        sanjay: { seed: 'sanjay-coo-2024', facialHair: 'moustacheFancy', top: 'shortHairShortCurly', accessories: 'prescription01' },
        rajiv: { seed: 'rajiv-vps-2024', facialHair: 'beardMedium', top: 'shortHairShortWaved', accessories: '' },
        deepak: { seed: 'deepak-vpp-2024', facialHair: '', top: 'shortHairShortFlat', accessories: 'prescription02' },
        harpreet: { seed: 'harpreet-cto-2024', facialHair: 'beardLight', top: 'turban', accessories: '' },
        thomas: { seed: 'thomas-eng-2024', facialHair: 'beardLight', top: 'shortHairShortCurly', accessories: '' }
    };
    
    function getAvatarUrl(staff) {
        // Check if we have a headshot for this staff member
        if (staff && staff.id && staffHeadshots[staff.id]) {
            return staffHeadshots[staff.id];
        }
        // Self-contained avatar to avoid external SVG requests (prevents ORB/CORP blocking)
        const initials = (staff.name || '??').split(/\s+/).filter(Boolean).slice(0,2).map(w => w[0].toUpperCase()).join('');
        const bg = (staff.avatarColor || '#4F46E5').replace('#','');
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">
          <rect width="120" height="120" rx="18" ry="18" fill="#${bg}"/>
          <text x="60" y="70" text-anchor="middle" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" font-size="44" font-weight="700" fill="#ffffff">${initials}</text>
        </svg>`;
        return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
    }

    // ============================================
    // GAME STATE
    // ============================================
    
    let gameState = {
        phase: 'landing',
        decisionModel: null,
        committee: ['meera'], // CEO is always on the R&D committee
        criteria: [],
        criteriaWeights: {},
        budget: 40,
        maxBudget: 40,
        extraBudgetRequested: false,  // Track if player requested extra Year 1 budget
        extraBudgetPerformanceBar: false, // Higher performance expectations from CEO
        bootlegOffered: false,        // Track if bootleg project was offered
        bootlegAccepted: false,       // Track if bootleg project was accepted
        selectedProjects: [],
        activeProjects: [],
        completedProjects: [],
        killedProjects: [],
        rejectedProjects: [],
        currentQuarter: 1,
        maxQuarters: 8,
                year2PlanningComplete: false,
        inYear2PlanningFlow: false,
        year2TransitionPending: false,
currentModalStaff: null,
        currentModalProject: null,
        rankedProjects: null,
        currentAssessmentIndex: 0,
        // Selection approach state
        scoringApproach: null,  // 'careful', 'rapid', or 'delegate'
        teamBlinding: null,     // 'visible' or 'blind'
        // Legacy project state
        legacyProjects: [],
        legacyBudget: { committed: 0, spent: 0, freed: 0 },
        legacyBudgetCommitted: 0,
        activeLegacyProjects: [],
        pausedProjects: [],
        currentLegacyProject: null,
        freedFromLegacy: 0,
        // Budget protection flag - prevents budget resets after selection is locked
        year1SelectionLocked: false,
        // Corporate events state
        currentEvent: null,
        activeEffects: [],  // Effects that persist across quarters
        eventHistory: [],
        pendingEventCallback: null,
        // Management dilemmas state
        currentDilemma: null,
        dilemmaHistory: [],
        pendingDilemmaCallback: null,
        mergedProjects: [],
        // Kill decision tracking for portfolio scoring
        killDecisions: [],  // { projectId, projectName, riskClass, killedAtQuarter, signalStrength, wasPerformingWell }
        // Active management tracking
        activeDecisionsMade: 0  // Count of kill/boost decisions
    };
    
    // ============================================
    // CORPORATE EVENTS DATABASE
    // ============================================
    
    const corporateEvents = [
        // LEADERSHIP EVENTS
        {
            id: 'warwick_alumni_event',
            category: 'Leadership',
            tone: 'positive',
            icon: '🎓',
            title: 'Meera Runs Into Her Old Professor',
            description: 'Meera just got back from a Warwick Business School alumni event in Mumbai. She bumped into one of her old professors, who taught her Corporate Entrepreneurship back in the day. Over drinks, he reminded her of a key lesson: the importance of developing templates before scaling new ventures. She came back fired up and wants to apply it to one of our projects. "I can\'t believe I forgot this," she said. "It\'s exactly what we need right now!"',
            effectText: 'Your newest project gets +15% success probability from better scaling approach',
            duration: 'permanent',
            apply: (gs) => { 
                if (gs.activeProjects.length > 0) {
                    // Find the newest project (most recently added)
                    const newest = gs.activeProjects[gs.activeProjects.length - 1];
                    if (newest) newest.successProb = Math.min(0.95, newest.successProb + 0.15);
                }
            }
        },
        {
            id: 'new_ceo_innovation',
            category: 'Leadership',
            tone: 'positive',
            icon: '👔',
            title: 'New CEO Wants Big Bets!',
            description: 'Just got out of the all-hands. New CEO is VERY into innovation — kept saying "think bigger" and "swing for the fences." She\'s approved a budget bump for R&D. Finally, someone who gets it! 🙌',
            effectText: '+$3M additional R&D budget this quarter',
            duration: 'instant',
            apply: (gs) => { gs.budget += 3; }
        },
        {
            id: 'new_cfo_scrutiny',
            category: 'Leadership',
            tone: 'neutral',
            icon: '📊',
            title: 'New CFO. Brace Yourselves.',
            description: 'Heads up — the new CFO is ex-private equity. Had coffee with him. He used the phrase "ROI discipline" four times. Expect a lot more questions about payback periods. Fun times ahead... 😬',
            effectText: 'Low-ROI projects will face tougher committee questions',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'roi_scrutiny', remaining: 2 }); }
        },
        {
            id: 'cto_champion',
            category: 'Leadership',
            tone: 'positive',
            icon: '🦸',
            title: 'Harpreet Loves Your Work',
            description: 'Amazing news! Harpreet mentioned your portfolio on the earnings call — called it "exactly the kind of strategic bets we need." The analysts loved it. You\'ve got air cover now. Use it wisely! 🎯',
            effectText: 'Your largest project gets +10% success probability',
            duration: 'permanent',
            apply: (gs) => { 
                const largest = gs.activeProjects.reduce((a, b) => a.budget > b.budget ? a : b, gs.activeProjects[0]);
                if (largest) largest.successProb = Math.min(0.95, largest.successProb + 0.10);
            }
        },
        {
            id: 'board_review',
            category: 'Leadership',
            tone: 'neutral',
            icon: '🔍',
            title: 'Consultants Incoming 🙄',
            description: 'So... the board hired McKinsey to "review R&D efficiency." I know, I know. They\'ll want to justify everything. Biggest project will get the most scrutiny. Start preparing your talking points.',
            effectText: 'Must justify your largest project or lose $1M from its budget',
            duration: 'instant',
            apply: (gs) => {
                const largest = gs.activeProjects.reduce((a, b) => a.budget > b.budget ? a : b, gs.activeProjects[0]);
                if (largest) largest.budget = Math.max(1, largest.budget - 1);
            }
        },
        {
            id: 'activist_investor',
            category: 'Leadership',
            tone: 'negative',
            icon: '🦈',
            title: 'Hedge Fund Circling',
            description: 'Bad news. That hedge fund from Singapore has taken 8% of the company. They\'re already talking about "operational efficiency" and "streamlining." Budget is frozen until this blows over. Keep your heads down.',
            effectText: 'Budget frozen for 2 quarters — no additional funding available',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'budget_freeze', remaining: 2 }); }
        },
        {
            id: 'founder_returns',
            category: 'Leadership',
            tone: 'neutral',
            icon: '👴',
            title: 'The Founder Is Back',
            description: 'Well, this is interesting. Mr. Venkataraman Sr. is returning as Executive Chairman. He\'s been asking questions about "what happened to our original vision." Committee might get shuffled. Stay flexible.',
            effectText: 'One random committee member replaced with new perspective',
            duration: 'instant',
            apply: (gs) => { /* Committee shuffle handled separately if needed */ }
        },
        
        // MARKET & ECONOMY EVENTS
        {
            id: 'enterprise_surge',
            category: 'Market',
            tone: 'positive',
            icon: '📈',
            title: 'Enterprises Are Panicking (Good for Us!)',
            description: 'Did you see the news about those bank hacks? Corporate India is FREAKING OUT. Enterprise security budgets just jumped 30%. Sales team can\'t keep up with inbound calls. Perfect timing for our B2B stuff!',
            effectText: 'B2B-focused projects get +10% success probability this quarter',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.scores && (p.scores.marketsize >= 4 || p.archetype?.includes('enterprise') || p.archetype?.includes('soc'))) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'smart_home_boom',
            category: 'Market',
            tone: 'positive',
            icon: '🏠',
            title: 'Smart Home Goes Mainstream!',
            description: 'Jio and Airtel are both pushing smart home bundles now. My mom asked me about "that doorbell camera thing" yesterday. MY MOM. If that\'s not a sign the market\'s ready, I don\'t know what is! 🚀',
            effectText: 'Consumer-focused projects get +10% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('value') || p.archetype?.includes('consumer') || p.archetype?.includes('niche') || p.riskProfile === 'low') {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'rupee_weakens',
            category: 'Market',
            tone: 'negative',
            icon: '💱',
            title: 'Rupee Taking a Beating',
            description: 'Finance just sent around the new exchange rates. Rupee\'s down 8% against the dollar. All those imported chips and sensors? Just got a lot more expensive. Hardware teams are not going to be happy about this.',
            effectText: 'Hardware-heavy projects cost +$0.5M more this quarter',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('drone') || p.archetype?.includes('robot') || p.archetype?.includes('edge') || p.archetype?.includes('wearable')) {
                        p.spentBudget = (p.spentBudget || 0) + 0.5;
                    }
                });
            }
        },
        {
            id: 'recession_fears',
            category: 'Market',
            tone: 'negative',
            icon: '📉',
            title: 'Economy Looking Wobbly',
            description: 'GDP forecasts just got cut to 5%. Consumer confidence is tanking. People are holding onto their wallets. Not great timing for anyone selling to regular folks. Enterprise might be safer right now.',
            effectText: 'Consumer projects get -10% success probability for 2 quarters',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'recession', remaining: 2 }); }
        },
        {
            id: 'real_estate_boom',
            category: 'Market',
            tone: 'positive',
            icon: '🏗️',
            title: 'Construction Boom!',
            description: 'Have you driven past Whitefield lately? Cranes EVERYWHERE. Construction is absolutely booming — residential, commercial, everything. Builders need security systems. This is our moment! 🏗️',
            effectText: 'Geographic expansion projects get +15% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.scores && p.scores.geographic >= 4) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                    }
                });
            }
        },
        {
            id: 'interest_rate_hike',
            category: 'Market',
            tone: 'neutral',
            icon: '🏦',
            title: 'RBI Hiking Rates Again',
            description: 'Another 50 basis points. Farhan\'s team is raising ROI thresholds again. "Cost of capital" this, "hurdle rate" that. You know the drill. Make sure your numbers look good.',
            effectText: 'Finance team will scrutinize project ROI more carefully',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'high_interest', remaining: 2 }); }
        },
        
        // REGULATORY & POLICY EVENTS
        {
            id: 'eu_trade_deal',
            category: 'Policy',
            tone: 'positive',
            icon: '🇪🇺',
            title: 'Europe Just Got Easier!',
            description: 'The India-EU trade deal just passed! Zero tariffs on security equipment to Europe. Sanjay is already planning a Munich trip. "Time to think global," he says. He\'s not wrong! 🌍',
            effectText: 'One project gets "EU Market Opportunity" — potential for international expansion',
            duration: 'permanent',
            apply: (gs) => {
                const eligible = gs.activeProjects.filter(p => p.scores && p.scores.geographic >= 3);
                if (eligible.length > 0) {
                    const lucky = eligible[Math.floor(Math.random() * eligible.length)];
                    lucky.successProb = Math.min(0.95, lucky.successProb + 0.10);
                    lucky.euOpportunity = true;
                }
            }
        },
        {
            id: 'make_in_india',
            category: 'Policy',
            tone: 'positive',
            icon: '🇮🇳',
            title: 'Free Money Alert! 💸',
            description: 'Government just announced PLI subsidies for security electronics manufacturing! Basically free money if we make stuff domestically. Already submitted our application. Fingers crossed!',
            effectText: '+$1M subsidy for domestically manufactured projects',
            duration: 'instant',
            apply: (gs) => { gs.budget += 1; }
        },
        {
            id: 'dpdp_accelerated',
            category: 'Policy',
            tone: 'neutral',
            icon: '🔐',
            title: 'Privacy Law Coming Fast',
            description: 'DPDP enforcement starting in 6 months. Legal is freaking out. But honestly? This could be good for us. Companies that can\'t figure out privacy compliance will need help. We should be ready.',
            effectText: 'Privacy-focused projects become strategically important',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('privacy') || p.archetype?.includes('compliance')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'smart_city_tenders',
            category: 'Policy',
            tone: 'positive',
            icon: '🌆',
            title: 'Government Opening the Vault!',
            description: '$10 BILLION in smart city tenders just announced. That\'s billion with a B. Government wants cameras, sensors, the works. If we\'re not bidding on this, what are we even doing? Let\'s GO! 🏃',
            effectText: 'Government/infrastructure projects get +15% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('acoustic') || p.archetype?.includes('perimeter') || p.archetype?.includes('cyber_physical')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                    }
                });
            }
        },
        {
            id: 'compliance_mandate',
            category: 'Policy',
            tone: 'negative',
            icon: '📋',
            title: 'More Compliance. Great.',
            description: 'CERT-In just mandated security certification for ALL IoT devices. Every. Single. One. The paperwork alone is going to cost us. Why can\'t they give us more than 3 months notice? *sigh*',
            effectText: 'All IoT projects need +$0.3M for certification',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('edge') || p.archetype?.includes('camera') || p.archetype?.includes('wearable')) {
                        p.spentBudget = (p.spentBudget || 0) + 0.3;
                    }
                });
            }
        },
        {
            id: 'drone_regs_eased',
            category: 'Policy',
            tone: 'positive',
            icon: '🚁',
            title: 'Drones Are Go! 🚁',
            description: 'DGCA finally came to their senses! Beyond Visual Line of Sight flights now allowed in industrial zones. The drone team is literally celebrating. I can hear them from here. This changes everything.',
            effectText: 'Drone projects get +15% success and -1 quarter timeline',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('drone')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                        p.timeline = Math.max(1, p.timeline - 1);
                    }
                });
            }
        },
        
        // TECHNOLOGY & COMPETITIVE EVENTS
        {
            id: 'ai_breakthrough',
            category: 'Technology',
            tone: 'positive',
            icon: '🤖',
            title: 'AI Just Got Insanely Good',
            description: 'Have you tried the new models?! The AI team is losing their minds (in a good way). Stuff that would\'ve taken us 6 months to build? Now it\'s like a week. This changes our whole roadmap. 🤯',
            effectText: 'AI-powered projects get +10% success and -1 quarter timeline',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('ai') || p.archetype?.includes('predictive') || p.archetype?.includes('digital_twin')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                        p.timeline = Math.max(1, p.timeline - 1);
                    }
                });
            }
        },
        {
            id: 'edge_cost_drop',
            category: 'Technology',
            tone: 'positive',
            icon: '💻',
            title: 'Chips Are Cheap Now!',
            description: 'Price war in the edge AI chip market! Costs down 40%. Procurement is doing a happy dance. Those edge computing projects that were "too expensive"? Might want to revisit those numbers... 💰',
            effectText: 'Edge computing projects get -$0.5M cost reduction',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('edge') || p.archetype?.includes('micro_nvr')) {
                        p.budget = Math.max(1, p.budget - 0.5);
                    }
                });
            }
        },
        {
            id: 'competitor_recall',
            category: 'Competitive',
            tone: 'positive',
            icon: '⚠️',
            title: 'CP Plus Is Having a Very Bad Day',
            description: 'MASSIVE recall at CP Plus. Security vulnerabilities everywhere. Their customers are panicking and calling US. Sales team is working weekends trying to handle all the inbound. I almost feel bad for them. Almost. 😏',
            effectText: 'Your most similar project gets +15% success probability',
            duration: '1 quarter',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const lucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    lucky.successProb = Math.min(0.95, lucky.successProb + 0.15);
                }
            }
        },
        {
            id: 'amazon_enters',
            category: 'Competitive',
            tone: 'negative',
            icon: '📦',
            title: 'Oh No. Amazon.',
            description: 'Amazon just announced "Amazon Secure" for India. Ring cameras bundled with Prime. Free delivery. Easy returns. This is... not great for our consumer play. We need to find our niche fast.',
            effectText: 'Consumer/value segment projects get -10% success probability',
            duration: '2 quarters',
            apply: (gs) => { gs.activeEffects.push({ type: 'amazon_competition', remaining: 2 }); }
        },
        {
            id: 'competitor_launch',
            category: 'Competitive',
            tone: 'negative',
            icon: '🚀',
            title: 'They Beat Us to Market',
            description: 'Hikvision just launched something that looks... uncomfortably similar to what we\'re building. Either they have a mole or great minds think alike. Either way, we just lost first-mover advantage. Time to differentiate.',
            effectText: 'One random project faces increased competition: -10% success',
            duration: 'permanent',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const unlucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    unlucky.successProb = Math.max(0.2, unlucky.successProb - 0.10);
                    unlucky.competitorThreat = true;
                }
            }
        },
        {
            id: 'talent_poached',
            category: 'Competitive',
            tone: 'negative',
            icon: '🚶',
            title: 'Rahul Left. For Godrej.',
            description: 'I don\'t know how to say this, but Rahul resigned. Going to Godrej. 40% raise apparently. He was the only one who understood the sensor calibration stuff. This is going to hurt. A lot.',
            effectText: 'One random project loses -10% success for 2 quarters',
            duration: '2 quarters',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const unlucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    unlucky.talentLoss = 2;
                    unlucky.successProb = Math.max(0.2, unlucky.successProb - 0.10);
                }
            }
        },
        
        // CRISIS & WILDCARD EVENTS
        {
            id: 'security_breach_news',
            category: 'Industry',
            tone: 'positive',
            icon: '📰',
            title: 'Security Is Trending (Thanks, Bank Robbers)',
            description: 'That bank heist is ALL over the news. "Outdated security systems" being blamed. Every company in India is suddenly reviewing their security budget. Our sales team says phones are ringing off the hook! 📞',
            effectText: 'All projects get +5% success probability this quarter',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.05);
                });
            }
        },
        {
            id: 'chip_shortage',
            category: 'Crisis',
            tone: 'negative',
            icon: '🔌',
            title: 'Chip Shortage. Again. 😤',
            description: 'That Taiwan fab fire is causing chaos. Chip prices doubled overnight. Lead times are now 6 months. Hardware teams are scrambling for alternatives. This is going to blow budgets AND timelines.',
            effectText: 'Hardware projects face +$0.75M cost increase and +1 quarter delay',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('drone') || p.archetype?.includes('robot') || p.archetype?.includes('edge') || p.archetype?.includes('camera')) {
                        p.spentBudget = (p.spentBudget || 0) + 0.75;
                        p.timeline += 1;
                    }
                });
            }
        },
        {
            id: 'cyber_attack',
            category: 'Crisis',
            tone: 'negative',
            icon: '💀',
            title: 'We Got Hacked. Yes, Really.',
            description: 'This is embarrassing. A security company getting ransomwared. IT is rebuilding systems. Some code was lost. The irony is not lost on anyone. Let\'s never speak of this again.',
            effectText: 'All projects lose half a quarter\'s progress',
            duration: 'instant',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.currentQuarter = Math.max(0, (p.currentQuarter || 0) - 0.5);
                });
            }
        },
        {
            id: 'industry_award',
            category: 'Industry',
            tone: 'positive',
            icon: '🏆',
            title: 'WE WON! 🏆🎉',
            description: 'We got the CII Innovation Award!!! HR is ordering champagne. Marketing is already updating the website. LinkedIn is going to be insufferable for a week. But seriously, this is amazing for brand credibility!',
            effectText: 'All projects get +10% success probability (brand halo)',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.10);
                });
            }
        },
        {
            id: 'monsoon_disruption',
            category: 'Crisis',
            tone: 'negative',
            icon: '🌧️',
            title: 'Monsoon Chaos',
            description: 'Half of Maharashtra is underwater. Logistics is a nightmare. A truck full of our components is stuck somewhere near Pune. The driver says "maybe next week?" We\'ll see. 🤷',
            effectText: 'One random hardware project delayed by 1 quarter',
            duration: 'instant',
            apply: (gs) => {
                const hardware = gs.activeProjects.filter(p => 
                    p.archetype?.includes('drone') || p.archetype?.includes('robot') || 
                    p.archetype?.includes('edge') || p.archetype?.includes('wearable')
                );
                if (hardware.length > 0) {
                    const unlucky = hardware[Math.floor(Math.random() * hardware.length)];
                    unlucky.timeline += 1;
                }
            }
        },
        {
            id: 'celebrity_endorsement',
            category: 'Industry',
            tone: 'positive',
            icon: '⭐',
            title: 'Bollywood Break-In Goes Viral!',
            description: 'Did you see Twitter?! Someone tried to break into Kareena\'s house and our system caught them. She posted about it. 2 million views. Marketing didn\'t even have to pay for this. Best. Day. Ever. 💫',
            effectText: 'Consumer products get +10% success probability (PR boost)',
            duration: '1 quarter',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.riskProfile === 'low' || p.archetype?.includes('value') || p.archetype?.includes('niche')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        
        // R&D PROJECT SUCCESS STORIES
        {
            id: 'major_customer_win',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🎉',
            title: 'TATA SIGNED!!! 🎉🎉🎉',
            description: 'I\'m literally shaking. Tata Group just signed. Multi-year deal. 200+ facilities. They loved the demo so much they skipped the second round of evaluations. The champagne is already open. GET IN HERE!',
            effectText: 'Your highest-progress project gets +15% success probability',
            duration: 'permanent',
            apply: (gs) => {
                const bestProgress = gs.activeProjects.reduce((a, b) => 
                    (a.latestUpdate?.progress || 0) > (b.latestUpdate?.progress || 0) ? a : b, gs.activeProjects[0]);
                if (bestProgress) bestProgress.successProb = Math.min(0.95, bestProgress.successProb + 0.15);
            }
        },
        {
            id: 'trade_press_feature',
            category: 'R&D Success',
            tone: 'positive',
            icon: '📰',
            title: 'We\'re Famous! (Good Famous)',
            description: 'Security Today just published a 3-page feature on us. Called our R&D portfolio "the most exciting in Indian security." Marketing is framing the article. Recruiters say applications are up 40%. Not bad, not bad at all! 📰',
            effectText: 'All projects get +5% success probability (industry credibility)',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.05);
                });
            }
        },
        {
            id: 'pilot_success',
            category: 'R&D Success',
            tone: 'positive',
            icon: '✅',
            title: 'Pilot Is Crushing It!',
            description: 'Field trial results are in and... WOW. 40% better than our projections. The pilot customers are already asking "when can we get more?" One guy literally hugged our field engineer. This is why we do this job! ✨',
            effectText: 'One random project gets +$0.5M from pilot revenue and +10% success',
            duration: 'permanent',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const lucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    lucky.successProb = Math.min(0.95, lucky.successProb + 0.10);
                    gs.budget += 0.5;
                }
            }
        },
        {
            id: 'tier2_breakthrough',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🗺️',
            title: 'Tier 2 Cities LOVE Us!',
            description: 'Remember when everyone said "focus on metros"? Well, our dealers in Pune, Ahmedabad, and Hyderabad are reporting 3x growth. Turns out there\'s a whole India outside Bangalore and Mumbai! Who knew? 🗺️',
            effectText: 'Tier 2/3 focused projects get +15% success probability',
            duration: '2 quarters',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    const hasTier23 = (p.strategicBuckets || []).some(b => b.id === 'tier23-rollout');
                    if (hasTier23 || p.scores?.geographic >= 4) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                    }
                });
            }
        },
        {
            id: 'patent_granted',
            category: 'R&D Success',
            tone: 'positive',
            icon: '📜',
            title: 'Patent Office Said YES!',
            description: 'After 18 months of back-and-forth, we finally got the AI intrusion detection patent! Legal is ecstatic. Now competitors can\'t just copy our approach. Worth every rupee we spent on those patent lawyers. 📜',
            effectText: 'AI-related projects get +10% success and improved IP position',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('ai') || p.archetype?.includes('predictive') || 
                        (p.strategicBuckets || []).some(b => b.id === 'ai-first')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'industry_award_rd',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🏆',
            title: 'Trophy Time! 🏆',
            description: 'CII just named us "Most Innovative Security Company"! Meera is over the moon. Board is thrilled. Investors suddenly returning our calls. Amazing what a shiny trophy does for credibility. Team dinner tonight!',
            effectText: 'All projects get +5% success; +$1M budget from increased investor confidence',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.05);
                });
                gs.budget += 1;
            }
        },
        {
            id: 'enterprise_reference',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🏢',
            title: 'Infosys Will Vouch For Us!',
            description: 'Big win! Infosys agreed to be a reference customer. Their CISO will speak at conferences about our tech. You know how hard it is to get enterprise references? Sales team is already lining up calls. This is HUGE.',
            effectText: 'Enterprise/B2B projects get +10% success probability',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.scores?.marketsize >= 4 || p.archetype?.includes('soc') || p.archetype?.includes('enterprise')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'distributor_expansion',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🤝',
            title: 'Reliance Digital Deal!',
            description: 'We\'re going to be in EVERY Reliance Digital store. All 500+. Nationwide. From Kashmir to Kanyakumari. The retail team has been working on this for a year. They\'re crying happy tears right now. 🛒',
            effectText: 'Consumer products get +15% success; market access improved',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.riskProfile === 'low' || p.archetype?.includes('value') || 
                        p.archetype?.includes('consumer') || p.archetype?.includes('niche')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                    }
                });
            }
        },
        {
            id: 'government_approval',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🏛️',
            title: 'We\'re Government Approved!',
            description: 'The paperwork finally came through! We\'re on the approved vendor list for critical infrastructure. Do you know how many airports, power plants, and government buildings that opens up? Me neither, but it\'s A LOT. 🏛️',
            effectText: 'One project gets "Government Approved" status (+20% success)',
            duration: 'permanent',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const eligible = gs.activeProjects.filter(p => p.scores?.strategic >= 4);
                    const target = eligible.length > 0 ? eligible[0] : gs.activeProjects[0];
                    target.successProb = Math.min(0.95, target.successProb + 0.20);
                    target.governmentApproved = true;
                }
            }
        },
        {
            id: 'recurring_revenue_milestone',
            category: 'R&D Success',
            tone: 'positive',
            icon: '💳',
            title: '50,000 Subscribers! 💳',
            description: 'We just hit 50K active subscribers on monitoring services. Monthly recurring revenue now covers 30% of R&D costs. The finance team is using words like "sustainable" and "predictable." Music to my ears!',
            effectText: '+$2M budget from recurring revenue; subscription projects +10% success',
            duration: 'permanent',
            apply: (gs) => {
                gs.budget += 2;
                gs.activeProjects.forEach(p => {
                    const hasRecurring = (p.strategicBuckets || []).some(b => b.id === 'recurring-revenue');
                    if (hasRecurring || p.archetype?.includes('service') || p.archetype?.includes('subscription')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'tech_blog_viral',
            category: 'R&D Success',
            tone: 'positive',
            icon: '📱',
            title: 'We\'re Viral! (2M Views!)',
            description: 'That YouTuber with 5M subscribers? He featured our AI demo. TWO MILLION VIEWS. Comments are amazing. "Finally an Indian company doing real innovation." Someone get the social team some pizza, they\'re going to be busy! 🚀',
            effectText: 'AI-First projects get +10% success; brand awareness boosted',
            duration: '2 quarters',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    const hasAI = (p.strategicBuckets || []).some(b => b.id === 'ai-first');
                    if (hasAI || p.archetype?.includes('ai') || p.archetype?.includes('camera')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'export_order',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🌏',
            title: 'Our First Export! 🌏',
            description: 'A UAE distributor just placed our first international order! They want Gulf region exclusivity. We\'re going global, team. ShieldTech India becoming ShieldTech International? I like the sound of that!',
            effectText: '+$1.5M from export advance; validates international potential',
            duration: 'permanent',
            apply: (gs) => {
                gs.budget += 1.5;
            }
        },
        {
            id: 'strategic_validation',
            category: 'R&D Success',
            tone: 'positive',
            icon: '🎯',
            title: 'Board Loves the Strategy!',
            description: 'Just out of the board meeting. The Chairman said, and I quote, "Finally, a coherent innovation approach." They approved everything. No budget cuts. No awkward questions. I could cry. 😭🎯',
            effectText: 'All projects get +5% success; team morale boosted',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.05);
                });
            }
        },
        
        // R&D SETBACKS - Negative project news
        {
            id: 'major_customer_loss',
            category: 'R&D Setback',
            tone: 'negative',
            icon: '😞',
            title: 'They Went With Hikvision 😞',
            description: 'Remember that big enterprise pilot? They cancelled. Said it was "strategic priorities" but someone at the account told me Hikvision undercut us by 30%. After all that work. I need a coffee. Or something stronger.',
            effectText: 'Your highest-progress project loses -15% success probability',
            duration: 'permanent',
            apply: (gs) => {
                const bestProgress = gs.activeProjects.reduce((a, b) => 
                    (a.latestUpdate?.progress || 0) > (b.latestUpdate?.progress || 0) ? a : b, gs.activeProjects[0]);
                if (bestProgress) bestProgress.successProb = Math.max(0.10, bestProgress.successProb - 0.15);
            }
        },
        {
            id: 'negative_press_coverage',
            category: 'R&D Setback',
            tone: 'negative',
            icon: '📰',
            title: 'Analyst Report Is Brutal',
            description: 'That Gartner analyst published his report. Called our R&D "unfocused and behind the curve." It\'s being forwarded everywhere. The board has already called twice. Going to be a long week explaining ourselves...',
            effectText: 'All projects get -5% success probability (credibility hit)',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.max(0.10, p.successProb - 0.05);
                });
            }
        },
        {
            id: 'pilot_failure',
            category: 'R&D Setback',
            tone: 'negative',
            icon: '❌',
            title: 'Pilot Results Are... Not Good',
            description: 'Field trial numbers just came in. We\'re 30% WORSE than lab tests. False alarms everywhere. One customer called it "more annoying than a car alarm at 3am." Sales is furious. Engineering is scrambling. This is bad.',
            effectText: 'One random project gets -$0.5M (rework costs) and -10% success',
            duration: 'permanent',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const unlucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    unlucky.successProb = Math.max(0.10, unlucky.successProb - 0.10);
                    unlucky.spentBudget = (unlucky.spentBudget || 0) + 0.5;
                }
            }
        },
        {
            id: 'patent_rejected',
            category: 'R&D Setback',
            tone: 'negative',
            icon: '⚖️',
            title: 'Patent Rejected. It Gets Worse.',
            description: 'Patent office rejected our application. "Prior art" they said. But here\'s the kicker — a competitor just filed something similar and THEIRS might go through. Legal is looking into it but... yeah. Not great.',
            effectText: 'One project with strong IP gets -15% success; IP position weakened',
            duration: 'permanent',
            apply: (gs) => {
                const ipProjects = gs.activeProjects.filter(p => p.scores?.ip >= 3);
                if (ipProjects.length > 0) {
                    const unlucky = ipProjects[Math.floor(Math.random() * ipProjects.length)];
                    unlucky.successProb = Math.max(0.10, unlucky.successProb - 0.15);
                }
            }
        },
        {
            id: 'subscription_churn',
            category: 'R&D Setback',
            tone: 'negative',
            icon: '📉',
            title: 'Subscribers Are Leaving 📉',
            description: 'Churn hit 8% this month. Eight percent! Customers are cancelling left and right. "Too many false alerts," "app is confusing," "thought it would be simpler." We\'re bleeding recurring revenue. Need to fix this fast.',
            effectText: '-$1M from lost recurring revenue; subscription projects -10% success',
            duration: 'permanent',
            apply: (gs) => {
                gs.budget = Math.max(0, gs.budget - 1);
                gs.activeProjects.forEach(p => {
                    const hasRecurring = (p.strategicBuckets || []).some(b => b.id === 'recurring-revenue');
                    if (hasRecurring || p.archetype?.includes('service') || p.archetype?.includes('subscription')) {
                        p.successProb = Math.max(0.10, p.successProb - 0.10);
                    }
                });
            }
        },
        {
            id: 'security_vulnerability',
            category: 'R&D Setback',
            tone: 'negative',
            icon: '🔓',
            title: 'We Have a Security Hole 🔓',
            description: 'A security researcher just tweeted about a vulnerability in our cloud platform. You can access other people\'s video feeds. A SECURITY company with a SECURITY flaw. Twitter is having a field day. All hands on deck.',
            effectText: '-$1.5M for emergency remediation; AI/cloud projects delayed +1 quarter',
            duration: 'instant',
            apply: (gs) => {
                gs.budget = Math.max(0, gs.budget - 1.5);
                const cloudAI = gs.activeProjects.filter(p => 
                    p.archetype?.includes('ai') || p.archetype?.includes('platform') ||
                    (p.strategicBuckets || []).some(b => b.id === 'ai-first')
                );
                if (cloudAI.length > 0) {
                    const unlucky = cloudAI[Math.floor(Math.random() * cloudAI.length)];
                    unlucky.timeline += 1;
                }
            }
        },
        
        // EXTERNAL PARTNERSHIPS & SUPPLIERS
        {
            id: 'university_delay',
            category: 'Partners',
            tone: 'negative',
            icon: '🎓',
            title: 'IIT Partnership Going Sideways',
            description: 'So... remember that IIT Bangalore collaboration? The PhD student leading it just switched thesis topics. Three months of work, gone. Prof says he\'ll "find someone else." I\'ve heard that before. Don\'t hold your breath.',
            effectText: 'One random project with research component delayed +1 quarter',
            duration: 'instant',
            apply: (gs) => {
                const research = gs.activeProjects.filter(p => 
                    p.archetype?.includes('ai') || p.archetype?.includes('predictive') || 
                    p.scores?.technical >= 4
                );
                if (research.length > 0) {
                    const unlucky = research[Math.floor(Math.random() * research.length)];
                    unlucky.timeline += 1;
                }
            }
        },
        {
            id: 'supplier_failure',
            category: 'Partners',
            tone: 'negative',
            icon: '📦',
            title: 'Our Supplier Just... Died',
            description: 'Remember that sensor module supplier? Filed for bankruptcy. Our custom components are now stuck in some legal mess between creditors. Procurement is scrambling to find alternatives but it\'s going to cost us. A lot.',
            effectText: 'Hardware projects delayed +1 quarter and cost +$0.5M to find alternatives',
            duration: 'instant',
            apply: (gs) => {
                const hardware = gs.activeProjects.filter(p => 
                    p.archetype?.includes('drone') || p.archetype?.includes('robot') || 
                    p.archetype?.includes('edge') || p.archetype?.includes('wearable') ||
                    p.archetype?.includes('camera')
                );
                if (hardware.length > 0) {
                    const unlucky = hardware[Math.floor(Math.random() * hardware.length)];
                    unlucky.timeline += 1;
                    unlucky.spentBudget = (unlucky.spentBudget || 0) + 0.5;
                }
            }
        },
        {
            id: 'consultant_leak',
            category: 'Partners',
            tone: 'negative',
            icon: '🕵️',
            title: 'That Consultant Talked 🕵️',
            description: 'Remember that BCG consultant who worked on our roadmap? Just saw on LinkedIn — he joined Godrej. And guess what they announced this week? Something VERY similar to our plans. Coincidence? I think not. Legal is furious.',
            effectText: 'Your highest-potential project loses first-mover advantage (-10% success)',
            duration: 'permanent',
            apply: (gs) => {
                const best = gs.activeProjects.reduce((a, b) => 
                    (a.successProb || 0) > (b.successProb || 0) ? a : b, gs.activeProjects[0]);
                if (best) best.successProb = Math.max(0.10, best.successProb - 0.10);
            }
        },
        {
            id: 'contract_manufacturer_quality',
            category: 'Partners',
            tone: 'negative',
            icon: '🏭',
            title: 'Quality Disaster from Shenzhen',
            description: 'That last batch from our Shenzhen factory? 15% defect rate. FIFTEEN PERCENT. Customers are returning units. We need a recall. My phone won\'t stop ringing. Customer support is in meltdown. This is a nightmare.',
            effectText: '-$1M for recall costs; consumer projects get -10% success this quarter',
            duration: '1 quarter',
            apply: (gs) => {
                gs.budget = Math.max(0, gs.budget - 1);
                gs.activeProjects.forEach(p => {
                    if (p.riskProfile === 'low' || p.archetype?.includes('value') || p.archetype?.includes('consumer')) {
                        p.successProb = Math.max(0.10, p.successProb - 0.10);
                    }
                });
            }
        },
        {
            id: 'academic_breakthrough',
            category: 'Partners',
            tone: 'positive',
            icon: '🔬',
            title: 'IISc Paper Is AMAZING! 🔬',
            description: 'The IISc collaboration just published! Their algorithm improves our detection accuracy by 40%. The research team is over the moon. Best part? We have exclusive rights for 2 years. Sometimes academia actually delivers!',
            effectText: 'AI/ML projects get +15% success and -1 quarter timeline',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('ai') || p.archetype?.includes('predictive') || 
                        p.archetype?.includes('digital_twin')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                        p.timeline = Math.max(1, p.timeline - 1);
                    }
                });
            }
        },
        {
            id: 'supplier_exclusivity',
            category: 'Partners',
            tone: 'positive',
            icon: '🤝',
            title: 'We Got Exclusive Access! 🤝',
            description: 'Big news — that Korean sensor supplier? They\'re giving us 18-month exclusivity on their next-gen chip. Hikvision can\'t get it. CP Plus can\'t get it. Only US. Procurement just earned their bonus. 🎯',
            effectText: 'Hardware projects get +10% success; competitive advantage secured',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('drone') || p.archetype?.includes('camera') || 
                        p.archetype?.includes('edge') || p.archetype?.includes('wearable')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'conference_presentation',
            category: 'Partners',
            tone: 'positive',
            icon: '🎤',
            title: 'Standing Ovation! 🎤',
            description: 'Our team just crushed it at SecureTech India. Standing ovation. People were taking photos of our slides. Three analysts asked for follow-up meetings. Marketing is THRILLED. Drinks are on them tonight!',
            effectText: 'All projects get +5% success; industry visibility improved',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.05);
                });
            }
        },
        {
            id: 'integration_partner_acquired',
            category: 'Partners',
            tone: 'negative',
            icon: '💼',
            title: 'Our Partner Got Bought. By THEM.',
            description: 'You\'re not going to believe this. That smart home platform we\'re integrating with? Amazon just bought them. First thing they\'re doing? Killing third-party integrations. Six months of work, down the drain.',
            effectText: 'One platform/integration project loses -15% success',
            duration: 'permanent',
            apply: (gs) => {
                const platform = gs.activeProjects.filter(p => 
                    p.archetype?.includes('platform') || p.archetype?.includes('integration') ||
                    p.scores?.platform >= 4
                );
                if (platform.length > 0) {
                    const unlucky = platform[Math.floor(Math.random() * platform.length)];
                    unlucky.successProb = Math.max(0.10, unlucky.successProb - 0.15);
                }
            }
        },
        {
            id: 'outsourced_team_quits',
            category: 'Partners',
            tone: 'negative',
            icon: '👋',
            title: 'The Whole Offshore Team Quit',
            description: 'That dev team in Vietnam we\'ve been working with for 18 months? Gone. All of them. Some US company offered triple the rate. They didn\'t even give proper notice. All that institutional knowledge, just... poof. 😤',
            effectText: 'Software-heavy project delayed +1 quarter; -$0.3M to onboard replacement',
            duration: 'instant',
            apply: (gs) => {
                const software = gs.activeProjects.filter(p => 
                    p.archetype?.includes('ai') || p.archetype?.includes('platform') || 
                    p.archetype?.includes('subscription')
                );
                if (software.length > 0) {
                    const unlucky = software[Math.floor(Math.random() * software.length)];
                    unlucky.timeline += 1;
                }
                gs.budget = Math.max(0, gs.budget - 0.3);
            }
        },
        {
            id: 'joint_venture_success',
            category: 'Partners',
            tone: 'positive',
            icon: '🤝',
            title: 'JV Is Crushing It!',
            description: 'Remember that JV everyone was skeptical about? It\'s working BEAUTIFULLY. Their installation network is driving 40% faster customer acquisition. Finance is very happy. Turns out partnerships can actually work!',
            effectText: 'Service/recurring revenue projects get +15% success',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    const hasRecurring = (p.strategicBuckets || []).some(b => b.id === 'recurring-revenue');
                    if (hasRecurring || p.archetype?.includes('service') || p.archetype?.includes('subscription')) {
                        p.successProb = Math.min(0.95, p.successProb + 0.15);
                    }
                });
            }
        },
        {
            id: 'api_partner_shutdown',
            category: 'Partners',
            tone: 'negative',
            icon: '🔌',
            title: 'Google Killed Our API 🔌',
            description: '90 days notice. That\'s all we got. Google is shutting down the vision API we built everything on. NINETY DAYS to re-architect the entire system. Engineering is pulling their hair out. This is going to hurt.',
            effectText: 'AI projects delayed +2 quarters; +$0.8M migration costs',
            duration: 'instant',
            apply: (gs) => {
                const ai = gs.activeProjects.filter(p => 
                    p.archetype?.includes('ai') || p.archetype?.includes('camera') ||
                    (p.strategicBuckets || []).some(b => b.id === 'ai-first')
                );
                if (ai.length > 0) {
                    const unlucky = ai[Math.floor(Math.random() * ai.length)];
                    unlucky.timeline += 2;
                }
                gs.budget = Math.max(0, gs.budget - 0.8);
            }
        },
        {
            id: 'demo_day_investor',
            category: 'Partners',
            tone: 'positive',
            icon: '💰',
            title: 'Investor Loved Demo Day! 💰',
            description: 'That strategic investor who came to demo day? They\'re IN. $5M for a minority stake, specifically earmarked for R&D. They said our innovation pipeline is "exactly what they were looking for." Meera is doing a happy dance.',
            effectText: '+$2M R&D budget from strategic investment',
            duration: 'permanent',
            apply: (gs) => {
                gs.budget += 2;
            }
        },
        {
            id: 'testing_lab_certification',
            category: 'Partners',
            tone: 'positive',
            icon: '🧪',
            title: 'Fast-Track Certification! 🧪',
            description: 'All those years of being nice to Bureau Veritas paid off! They\'re fast-tracking our certification. What usually takes 6 months? We\'re getting it in 6 weeks. Sometimes relationships really do matter.',
            effectText: 'One random project gets -1 quarter timeline (faster certification)',
            duration: 'permanent',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const lucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    lucky.timeline = Math.max(1, lucky.timeline - 1);
                }
            }
        },
        {
            id: 'trade_show_flop',
            category: 'Partners',
            tone: 'negative',
            icon: '😬',
            title: 'Demo Crashed. On Stage. Publicly.',
            description: 'I can\'t even... the demo crashed. THREE TIMES. On the main stage. At the biggest trade show of the year. Someone recorded it. It\'s on Twitter. The comments are brutal. I need to lie down. 😬',
            effectText: 'One random project gets -10% success (reputation damage)',
            duration: 'permanent',
            apply: (gs) => {
                if (gs.activeProjects.length > 0) {
                    const unlucky = gs.activeProjects[Math.floor(Math.random() * gs.activeProjects.length)];
                    unlucky.successProb = Math.max(0.10, unlucky.successProb - 0.10);
                }
            }
        },
        {
            id: 'standards_body_influence',
            category: 'Partners',
            tone: 'positive',
            icon: '📋',
            title: 'Harpreet\'s on the Standards Committee!',
            description: 'Harpreet got invited to the BIS IoT security standards committee! We\'ll know about new requirements MONTHS before competitors. Plus we can help shape the standards. This is huge for our compliance roadmap.',
            effectText: 'Regulatory/compliance projects get +10% success',
            duration: 'permanent',
            apply: (gs) => {
                gs.activeProjects.forEach(p => {
                    if (p.archetype?.includes('compliance') || p.archetype?.includes('cyber_physical') ||
                        p.scores?.strategic >= 4) {
                        p.successProb = Math.min(0.95, p.successProb + 0.10);
                    }
                });
            }
        },
        {
            id: 'key_hire_from_partner',
            category: 'Partners',
            tone: 'positive',
            icon: '🌟',
            title: 'Star Engineer Joined US! 🌟',
            description: 'You know Priya from our tech partner? The brilliant one who actually understood our requirements? SHE JOINED US. Starts Monday. Her old company is NOT happy but honestly, that\'s a them problem. Welcome to the team, Priya!',
            effectText: 'Your most complex project gets +10% success',
            duration: 'permanent',
            apply: (gs) => {
                const complex = gs.activeProjects.reduce((a, b) => 
                    (a.scores?.technical || 0) > (b.scores?.technical || 0) ? a : b, gs.activeProjects[0]);
                if (complex) complex.successProb = Math.min(0.95, complex.successProb + 0.10);
            }
        }
    ];
    
    // ============================================
    // MANAGEMENT DILEMMAS - Portfolio Tensions
    // ============================================
    
    const managementDilemmas = [
        // RESOURCE CONFLICTS
        {
            id: 'expert_conflict',
            category: 'Resource Conflict',
            source: 'below',
            sourceRole: 'Dr. Meera Krishnan, AI Lead',
            icon: '👨‍🔬',
            title: 'I Can\'t Be in Two Places at Once',
            description: 'Look, I want to help everyone, but I\'m only one person. Both {projectA} and {projectB} need me this quarter — {projectA} has a critical piece of code that\'s stuck, and {projectB}\'s AI system is throwing errors nobody else can fix. I\'ve been working weekends already. Can you please just tell me which one to prioritize? I\'ll do whatever you decide, but I can\'t keep jumping between projects like this. It\'s killing my productivity.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Focus on {projectA}',
                    description: 'The breakthrough is more important strategically',
                    consequence: 'projectA_boost',
                    narrativeGood: '{projectA} makes a breakthrough with Meera\'s dedicated support.',
                    narrativeBad: '{projectB} struggles without AI expertise and falls behind schedule.'
                },
                {
                    label: 'Focus on {projectB}',
                    description: 'The bug-fixing is blocking the whole team',
                    consequence: 'projectB_boost',
                    narrativeGood: '{projectB}\'s AI issues are resolved quickly.',
                    narrativeBad: '{projectA}\'s work stalls without specialist guidance.'
                },
                {
                    label: 'Split time 50/50',
                    description: 'Ask her to divide attention between both',
                    consequence: 'both_slow',
                    narrativeGood: 'Both projects make modest progress with part-time support.',
                    narrativeBad: 'Jumping between projects means neither gets her best work.'
                }
            ]
        },
        {
            id: 'lab_equipment',
            category: 'Resource Conflict',
            source: 'below',
            sourceRole: 'Sanjay Mehta, Test Lab Manager',
            icon: '🔬',
            title: 'Lab Scheduling Nightmare',
            description: 'Boss, I\'ve got a problem. The testing chamber is booked solid and I\'ve got two teams ready to kill each other over it. {projectA} needs it for certification — they say they\'ll miss their launch window. {projectB} needs stress tests — they\'re worried products will break in the field. Both leads have been CC\'ing you on increasingly angry emails. I\'ve tried to mediate but they both think their project is more important. Can you make the call? I\'ll enforce whatever you decide.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Give it to {projectA}',
                    description: 'Certification is blocking launch',
                    consequence: 'projectA_boost',
                    narrativeGood: '{projectA} passes certification on schedule.',
                    narrativeBad: '{projectB}\'s stress testing is delayed by a quarter.'
                },
                {
                    label: 'Give it to {projectB}',
                    description: 'Products breaking in the field would be a disaster',
                    consequence: 'projectB_boost',
                    narrativeGood: '{projectB} catches a critical flaw early.',
                    narrativeBad: '{projectA} certification slips, delaying launch.'
                },
                {
                    label: 'Rent external lab time',
                    description: 'Spend $0.5M to keep both happy',
                    consequence: 'budget_hit',
                    narrativeGood: 'Both projects proceed on schedule using external facilities.',
                    narrativeBad: 'Expensive, but keeps both projects moving.'
                }
            ]
        },
        
        // TECHNOLOGY SPILLOVERS
        {
            id: 'tech_breakthrough',
            category: 'Technology Spillover',
            source: 'below',
            sourceRole: 'Amit Sharma, {projectA} Tech Lead',
            icon: '💡',
            title: 'We Built Something Cool — Want to Share It?',
            description: 'Hey! So we accidentally built something amazing. Our new code could totally help {projectB} — I was chatting with their lead and she got really excited. The thing is, if we stop to write it up properly and teach them how to use it, we\'ll slip by about a quarter. But watching them struggle to rebuild what we\'ve already solved feels wrong? Up to you, but I think we could really help them out here. What do you think?',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Share the breakthrough',
                    description: 'Slow {projectA} to help {projectB}',
                    consequence: 'share_tech',
                    narrativeGood: 'Sharing knowledge helps both projects in the long run.',
                    narrativeBad: '{projectA} loses momentum while documenting everything.'
                },
                {
                    label: 'Keep teams focused',
                    description: 'Each project stays in its lane',
                    consequence: 'no_share',
                    narrativeGood: '{projectA} maintains momentum and ships on time.',
                    narrativeBad: '{projectB} eventually rebuilds the same thing, wasting effort.'
                },
                {
                    label: 'Hire someone to help transfer',
                    description: 'Spend $0.3M on a consultant to help',
                    consequence: 'paid_share',
                    narrativeGood: 'Smooth handoff with minimal disruption.',
                    narrativeBad: 'Expensive but it works.'
                }
            ]
        },
        {
            id: 'patent_decision',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Kavitha Rajan, Chief Legal Officer',
            icon: '📜',
            title: 'We Need a Decision on Protection. Now.',
            description: 'I\'ll keep this brief. {projectA} has made a discovery we could patent. We have two options: file for a patent (strong legal protection, but we have to publish how it works and it delays the project by 2 months), or publish a paper first (gets us industry recognition and helps recruiting, but competitors can copy our approach). I need your decision by Friday. The longer we wait, the higher the risk someone else files first. What\'s it going to be?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'File for patent',
                    description: 'Protect the invention, accept the delay',
                    consequence: 'patent_delay',
                    narrativeGood: 'Strong patent gives us legal protection from copycats.',
                    narrativeBad: '{projectA} delayed by 2 months during patent process.'
                },
                {
                    label: 'Publish immediately',
                    description: 'Get credit in the industry',
                    consequence: 'publish_fast',
                    narrativeGood: 'Publication generates buzz and attracts great job candidates.',
                    narrativeBad: 'Competitors can now copy our approach legally.'
                },
                {
                    label: 'Do both (file quick version first)',
                    description: 'File a placeholder patent, then publish. Costs $0.2M extra',
                    consequence: 'both_ip',
                    narrativeGood: 'Best of both worlds with temporary protection.',
                    narrativeBad: 'Additional legal costs but good positioning.'
                }
            ]
        },
        
        // TEAM DYNAMICS
        {
            id: 'star_performer_request',
            category: 'Team Dynamics',
            source: 'below',
            sourceRole: 'Rahul Kapoor, Senior Engineer',
            icon: '⭐',
            title: 'Can We Talk About My Career?',
            description: 'Hi, do you have a minute? I\'ve been on {projectA} for two years now and I\'ve loved it, but... {projectB} is doing exactly the kind of work I want to build my career on. I know the timing isn\'t great and I know {projectA} needs me, but I\'d really like to transfer. I\'m not trying to be difficult — I just don\'t want to wake up in five years and regret not taking this chance. Can we figure something out? I\'d hate to have to look outside the company...',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Approve the transfer',
                    description: 'Keep Rahul happy, strengthen {projectB}',
                    consequence: 'transfer_star',
                    narrativeGood: 'Rahul thrives in {projectB} and becomes even more productive.',
                    narrativeBad: '{projectA} struggles to replace his knowledge of how things work.'
                },
                {
                    label: 'Deny the request',
                    description: '{projectA} can\'t afford to lose him right now',
                    consequence: 'deny_transfer',
                    narrativeGood: '{projectA} maintains momentum with Rahul\'s expertise.',
                    narrativeBad: 'Rahul becomes disengaged and starts job hunting.'
                },
                {
                    label: 'Negotiate a delayed transfer',
                    description: 'He transfers after this milestone (2 months)',
                    consequence: 'delayed_transfer',
                    narrativeGood: 'Compromise keeps both projects staffed appropriately.',
                    narrativeBad: 'Rahul is distracted during transition period.'
                }
            ]
        },
        {
            id: 'team_friction',
            category: 'Team Dynamics',
            source: 'above',
            sourceRole: 'Priya Nair, HR Director',
            icon: '😤',
            title: 'This Situation Is Getting Out of Hand',
            description: 'I need to flag something serious. The leads of {projectA} and {projectB} had a blow-up in the cafeteria yesterday. People recorded it. The argument was about shared resources, but it\'s clearly personal now. Both teams are taking sides. I\'ve had three people ask about transfer options. This is affecting the whole floor. You need to step in — this is above my pay grade. How do you want to handle it?',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Mediate personally',
                    description: 'Get both leads in a room and sort this out',
                    consequence: 'mediate',
                    narrativeGood: 'Your intervention clears the air and rebuilds trust.',
                    narrativeBad: 'Takes your attention away from other decisions.'
                },
                {
                    label: 'Bring in HR formally',
                    description: 'Let professionals handle interpersonal conflicts',
                    consequence: 'hr_intervention',
                    narrativeGood: 'HR helps them have a productive conversation.',
                    narrativeBad: 'Both leads feel they\'re being "managed" and resent it.'
                },
                {
                    label: 'Reorganize to separate them',
                    description: 'Change who reports to whom so they don\'t interact',
                    consequence: 'reorg',
                    narrativeGood: 'Clean separation allows both to focus on their work.',
                    narrativeBad: 'Loses potential benefits of projects working together.'
                }
            ]
        },
        {
            id: 'burnout_warning',
            category: 'Team Dynamics',
            source: 'below',
            sourceRole: 'Deepa Rao, {projectA} Project Manager',
            icon: '😰',
            title: 'My Team Is Breaking Down',
            description: 'I need to be honest with you. My team is exhausted. We\'ve been doing 60+ hour weeks for two months. Ravi\'s marriage is in trouble. Sneha\'s been having panic attacks. I found Vikram sleeping at his desk at 6am yesterday. I know the deadline is important, but I\'m watching my team fall apart. I\'m not asking you to make this easy — I\'m asking you to tell me what matters more. The deadline or the people? Because I can\'t have both.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Push through',
                    description: 'The deadline is non-negotiable',
                    consequence: 'push_burnout',
                    narrativeGood: 'Team delivers heroically and celebrates victory.',
                    narrativeBad: 'Two key engineers quit after the milestone.'
                },
                {
                    label: 'Mandatory rest week',
                    description: 'Accept a 1-week delay for team health',
                    consequence: 'rest_week',
                    narrativeGood: 'Team returns refreshed and more productive.',
                    narrativeBad: 'Project delayed but team stays together.'
                },
                {
                    label: 'Bring in contractors',
                    description: 'Spend $0.4M to take pressure off',
                    consequence: 'contractor_relief',
                    narrativeGood: 'Extra help allows team to work normal hours.',
                    narrativeBad: 'Contractors take time to get up to speed but eventually help.'
                }
            ]
        },
        
        // STRATEGIC TENSIONS
        {
            id: 'project_convergence',
            category: 'Strategic',
            source: 'above',
            sourceRole: 'Harpreet Singh, CTO',
            icon: '🔀',
            title: 'We Have a Strategy Problem',
            description: 'I\'ve been reviewing where these projects are headed and I don\'t like what I see. {projectA} and {projectB} are building toward the same thing. We\'re about to have two internal teams competing for the same customers. This is a waste of money and it\'s going to create political problems. I see three options: merge them, let them compete, or kill one now. None of these is easy. But doing nothing is not an option. What\'s your call?',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Merge the projects',
                    description: 'Combine teams and budgets',
                    consequence: 'merge_projects',
                    narrativeGood: 'Merged project becomes stronger than either alone.',
                    narrativeBad: 'Culture clash and confusion slow progress.'
                },
                {
                    label: 'Let them compete',
                    description: 'Internal competition can drive better results',
                    consequence: 'internal_compete',
                    narrativeGood: 'Competition produces two distinct, viable products.',
                    narrativeBad: 'Wasted resources building similar things.'
                },
                {
                    label: 'Pick a winner now',
                    description: 'Kill one project, go all-in on the other',
                    consequence: 'pick_winner',
                    narrativeGood: 'Focused resources speed up the surviving project.',
                    narrativeBad: 'The killed project might have been the better bet.'
                }
            ]
        },
        {
            id: 'partnership_conflict',
            category: 'Strategic',
            source: 'above',
            sourceRole: 'Meera Venkataraman, CEO',
            icon: '🤝',
            title: 'Samsung Wants to Partner. We Need to Decide.',
            description: 'Samsung called. They want to partner on {projectA}. It would speed up development and give us access to their stores and distribution. But there\'s a catch — they want to share ownership of our technology, and frankly, this could hurt {projectB}\'s chances in the market. I\'m inclined to explore it, but I want your take on the R&D side. This decision goes to the board next week. Give me your recommendation.',
            requiresProjects: 2,
            choices: [
                {
                    label: 'Accept the partnership',
                    description: 'Speed up {projectA} with Samsung\'s resources',
                    consequence: 'accept_partner',
                    narrativeGood: 'Partnership provides resources and market access.',
                    narrativeBad: '{projectB} faces a newly-enabled competitor.'
                },
                {
                    label: 'Decline politely',
                    description: 'Protect our inventions and independence',
                    consequence: 'decline_partner',
                    narrativeGood: 'Staying independent keeps our options open.',
                    narrativeBad: 'Samsung approaches our competitor instead.'
                },
                {
                    label: 'Counter-propose limited scope',
                    description: 'Partner on marketing only, keep tech separate',
                    consequence: 'limited_partner',
                    narrativeGood: 'Limited partnership gives benefits without giving up our secrets.',
                    narrativeBad: 'Samsung is disappointed but accepts reduced terms.'
                }
            ]
        },
        {
            id: 'scope_creep_demand',
            category: 'Strategic',
            source: 'above',
            sourceRole: 'Nikhil Desai, VP Sales',
            icon: '📈',
            title: 'I Need This Feature or I Lose the Deal',
            description: 'I have Reliance ready to sign a $1.8M deal. READY. But they need a feature from {projectA} that\'s not in the current plan. I don\'t care about your "code quality" concerns — this is real revenue walking out the door. My team has been working this account for eight months. If you can\'t add one feature, I\'ll have to explain to the board why we lost this. So what\'s it going to be?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Add the feature',
                    description: 'Customer demand drives product direction',
                    consequence: 'add_feature',
                    narrativeGood: 'Feature becomes popular and drives more sales.',
                    narrativeBad: 'Rushed code creates problems that slow down future work.'
                },
                {
                    label: 'Hold the line',
                    description: 'Ship what we planned, feature comes later',
                    consequence: 'hold_scope',
                    narrativeGood: 'Clean code makes future changes faster.',
                    narrativeBad: 'Sales loses the deal to a competitor.'
                },
                {
                    label: 'Offer a custom build',
                    description: 'Build it separately for this customer only',
                    consequence: 'custom_build',
                    narrativeGood: 'Customer happy with customization, main product stays clean.',
                    narrativeBad: 'Now maintaining two separate versions.'
                }
            ]
        },
        
        // ETHICAL & QUALITY DILEMMAS
        {
            id: 'quality_shortcut',
            category: 'Quality',
            source: 'below',
            sourceRole: 'Ananya Iyer, QA Lead',
            icon: '⚖️',
            title: 'I Can\'t Sign Off on This',
            description: 'I need to escalate something. The {projectA} manager wants to skip the full testing cycle to hit the deadline. He says the risk is low. I\'m not comfortable. We haven\'t tested the unusual situations, and if something breaks after we ship, it\'s going to be ugly. I\'m supposed to approve quality — I can\'t put my name on this. But I also don\'t want to be the one who delayed the launch. Help?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Take the shortcut',
                    description: 'Ship on time, fix issues in updates',
                    consequence: 'shortcut',
                    narrativeGood: 'Ship goes smoothly, no issues found.',
                    narrativeBad: 'Customer-reported bugs damage reputation.'
                },
                {
                    label: 'Do full testing',
                    description: 'Accept the delay to test properly',
                    consequence: 'full_test',
                    narrativeGood: 'Testing catches critical bug that would have been costly.',
                    narrativeBad: 'Delayed launch but solid product.'
                },
                {
                    label: 'Staged rollout',
                    description: 'Release to a small group of customers first',
                    consequence: 'staged_release',
                    narrativeGood: 'Early customers catch minor issues before broad release.',
                    narrativeBad: 'Slower market reach but controlled risk.'
                }
            ]
        },
        {
            id: 'competitor_intel',
            category: 'Ethics',
            source: 'above',
            sourceRole: 'Kavitha Rajan, Chief Legal Officer',
            icon: '🕵️',
            title: 'We Have an Ethics Problem',
            description: 'I just found out that the new hire from Godrej has been offering to share their product designs with the {projectA} team. The team lead seems excited. I\'m not. This is a lawsuit waiting to happen. At minimum, it\'s an ethics violation. I\'ve put a hold on any sharing until you decide how to handle this. We need a clear policy and we need to act fast before anyone does something stupid.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept the information',
                    description: 'This is normal competitive research',
                    consequence: 'accept_intel',
                    narrativeGood: 'Information helps us get ahead of competitor\'s approach.',
                    narrativeBad: 'If discovered, could damage reputation and invite legal trouble.'
                },
                {
                    label: 'Decline firmly',
                    description: 'We compete on our own merits',
                    consequence: 'decline_intel',
                    narrativeGood: 'Ethical stance builds culture of integrity.',
                    narrativeBad: 'Competitor advantage remains unknown.'
                },
                {
                    label: 'Consult legal first',
                    description: 'Get detailed guidance on what\'s acceptable',
                    consequence: 'legal_consult',
                    narrativeGood: 'Legal identifies what\'s safe to use.',
                    narrativeBad: 'Conservative guidance means most information is off-limits.'
                }
            ]
        },
        {
            id: 'junior_breakthrough',
            category: 'Team Dynamics',
            source: 'below',
            sourceRole: 'Arjun Reddy, Junior Engineer',
            icon: '🌟',
            title: 'I Know I\'m New, But Hear Me Out?',
            description: 'Hi... sorry to bother you. I know I\'ve only been here six months, but I\'ve been looking at how {projectA} is built and... I think there\'s a better way? The senior engineers don\'t agree — they say it\'s too risky. But I ran tests and the numbers look really good. I might be totally wrong, I know. But would you at least look at my proposal? I promise I won\'t be offended if you say no.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Back the junior',
                    description: 'New ideas require taking risks on new voices',
                    consequence: 'back_junior',
                    narrativeGood: 'Junior\'s approach proves breakthrough.',
                    narrativeBad: 'Idea fails, wasting a quarter of effort.'
                },
                {
                    label: 'Go with the seniors',
                    description: 'Experience usually wins',
                    consequence: 'back_seniors',
                    narrativeGood: 'Senior approach delivers reliable results.',
                    narrativeBad: 'Junior becomes disengaged and leaves.'
                },
                {
                    label: 'Run a parallel test',
                    description: 'Try both approaches for 4 weeks',
                    consequence: 'parallel_test',
                    narrativeGood: 'Test reveals which approach is better.',
                    narrativeBad: 'Delays the decision but builds team agreement.'
                }
            ]
        },
        {
            id: 'customer_data',
            category: 'Ethics',
            source: 'below',
            sourceRole: 'Vikram Menon, AI Team Lead',
            icon: '🔐',
            title: 'We Could Build a Much Better Product If...',
            description: 'So our AI isn\'t performing well and I think I know why — we don\'t have enough real-world data. We HAVE customer usage data that would be perfect for training. Privacy says it\'s technically allowed... but customers weren\'t explicitly told we\'d use it for AI training. I\'m not sure how to feel about it. The data would really help. But it feels a bit... grey? What do you think?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Grant access',
                    description: 'It\'s allowed, and the data would really help',
                    consequence: 'grant_data',
                    narrativeGood: 'AI improves significantly with real data.',
                    narrativeBad: 'Privacy advocacy group raises concerns publicly.'
                },
                {
                    label: 'Deny access',
                    description: 'Just because we can doesn\'t mean we should',
                    consequence: 'deny_data',
                    narrativeGood: 'Privacy-first stance becomes marketing advantage.',
                    narrativeBad: 'AI underperforms without training data.'
                },
                {
                    label: 'Use anonymized data only',
                    description: 'Spend extra time to remove identifying information',
                    consequence: 'anonymize_data',
                    narrativeGood: 'Anonymization keeps data useful while protecting privacy.',
                    narrativeBad: 'Extra processing time delays the feature.'
                }
            ]
        },
        
        // PATENT & LEGAL DILEMMAS
        {
            id: 'essential_patent_opportunity',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Farhan Qureshi, CFO',
            icon: '🏆',
            title: 'There\'s a Patent for Sale That We Need',
            description: 'A competitor is going out of business and their patents are for sale. One of those patents covers something core to {projectA} — we\'ve been designing around it for a year. They want $1.2M. That\'s a lot. But owning it would eliminate our biggest legal risk and give us protection against others. I can find the budget if you think it\'s worth it. But I need a decision this week — there are other bidders.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Buy the patent',
                    description: 'Own it outright, accept the cost',
                    consequence: 'buy_patent',
                    narrativeGood: 'Buying the patent eliminates legal risk and strengthens our position.',
                    narrativeBad: 'Expensive, but we now own a valuable defensive weapon.'
                },
                {
                    label: 'Negotiate a license instead',
                    description: 'Cheaper ($0.4M) but we don\'t own it',
                    consequence: 'license_patent',
                    narrativeGood: 'License lets us use the technology at lower cost.',
                    narrativeBad: 'We\'re still dependent on the patent holder\'s goodwill.'
                },
                {
                    label: 'Design around it',
                    description: 'Engineering effort to avoid the patent entirely',
                    consequence: 'design_around',
                    narrativeGood: 'Engineers find clever workaround that avoids legal issues.',
                    narrativeBad: 'Workaround takes longer and results in worse solution.'
                }
            ]
        },
        {
            id: 'patent_filing_deadline',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Kavitha Rajan, Chief Legal Officer',
            icon: '⏰',
            title: 'We Have 30 Days or We Lose This Forever',
            description: 'I just found out that someone from {projectA} presented at a conference 11 months ago and showed off key inventions. Under patent law, we have 12 months from public disclosure to file. That means 30 days. The filing isn\'t ready. Rushing it will cost $0.3M in expedited legal fees. If we miss this window, we lose patent rights permanently. I cannot stress enough how serious this is.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Rush the filing',
                    description: 'Pay premium for expedited work',
                    consequence: 'rush_patent',
                    narrativeGood: 'Patent filed just in time—invention protected.',
                    narrativeBad: 'Rushed filing has some quality issues but captures the key ideas.'
                },
                {
                    label: 'Let it become public',
                    description: 'Accept that this invention won\'t be patented',
                    consequence: 'miss_patent',
                    narrativeGood: 'We save money and can still use the invention freely.',
                    narrativeBad: 'Competitors can now freely copy our invention.'
                },
                {
                    label: 'File a placeholder and extend',
                    description: 'Quick filing ($0.1M) buys 12 more months',
                    consequence: 'provisional_patent',
                    narrativeGood: 'Placeholder buys time for a quality full filing later.',
                    narrativeBad: 'Must remember to follow up or lose protection anyway.'
                }
            ]
        },
        {
            id: 'conference_leak',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Priya Nair, HR Director + Kavitha Rajan, Legal',
            icon: '🍺',
            title: 'Someone Talked. At the Conference. After Drinks.',
            description: 'We have a situation. At SecureTech India, one of the {projectA} engineers apparently shared technical details after a few beers. A competitor\'s blog is now referencing "exciting developments at ShieldTech." Kavitha is concerned about patent implications. I\'m concerned about secrecy culture. We need to decide: do we focus on damage control, or do we make an example? This can\'t happen again.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Emergency patent filings',
                    description: 'Rush to file everything discussed ($0.5M)',
                    consequence: 'emergency_filings',
                    narrativeGood: 'Fast filings preserve most of our rights.',
                    narrativeBad: 'Some ideas may already be too public, but we salvage what we can.'
                },
                {
                    label: 'Damage assessment first',
                    description: 'Interview staff, figure out what was actually shared',
                    consequence: 'assess_damage',
                    narrativeGood: 'Assessment reveals the leak was less serious than feared.',
                    narrativeBad: 'Weeks of investigation delay response while competitors act.'
                },
                {
                    label: 'Discipline the employee',
                    description: 'Make an example to prevent future leaks',
                    consequence: 'discipline_leaker',
                    narrativeGood: 'Clear message sent; confidentiality compliance improves.',
                    narrativeBad: 'Key engineer leaves; team morale drops. Secrets still out.'
                }
            ]
        },
        {
            id: 'jurisdiction_gap',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Kavitha Rajan, Chief Legal Officer',
            icon: '🌏',
            title: 'We Have a Gap in Our Patent Protection',
            description: 'I\'ve been reviewing our patent filings. {projectA}\'s core patent was filed in India and the US, but not in China or Europe. A Chinese manufacturer is now making something very similar. If we want protection in those markets, it\'s going to cost $0.8M and we need to act soon — the window is closing. I\'m not telling you what to do, but you need to understand the risk.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'File in all major markets',
                    description: 'Full international protection ($0.8M)',
                    consequence: 'full_international',
                    narrativeGood: 'Global protection secures markets worldwide.',
                    narrativeBad: 'Expensive, but prevents international copycats.'
                },
                {
                    label: 'Focus on Europe only',
                    description: 'Partial protection where we sell ($0.3M)',
                    consequence: 'europe_only',
                    narrativeGood: 'European protection covers our key export market.',
                    narrativeBad: 'Chinese market remains vulnerable to copying.'
                },
                {
                    label: 'Accept limited protection',
                    description: 'India and US coverage is enough for now',
                    consequence: 'accept_gaps',
                    narrativeGood: 'Cost savings can be invested in other projects.',
                    narrativeBad: 'Competitor\'s Chinese knockoff starts appearing in India.'
                }
            ]
        },
        {
            id: 'infringement_discovered',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Kavitha Rajan, Chief Legal Officer',
            icon: '⚖️',
            title: 'Someone Is Copying Our Patent. Blatantly.',
            description: 'We\'ve found clear evidence that Godrej is copying {projectA}\'s patented design. It\'s not even subtle — they basically cloned our product. We could sue, but litigation will cost $1.5M minimum and take two years. They might countersue. Or we could try to negotiate. What\'s your appetite for a fight?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Sue them',
                    description: 'Enforce our rights aggressively',
                    consequence: 'sue_infringer',
                    narrativeGood: 'Court rules in our favor; competitor must pay damages and stop.',
                    narrativeBad: 'Expensive, drawn-out legal battle with uncertain outcome.'
                },
                {
                    label: 'Send formal warning',
                    description: 'Legal letter without immediate lawsuit',
                    consequence: 'cease_desist',
                    narrativeGood: 'Competitor backs down to avoid legal costs.',
                    narrativeBad: 'They ignore the letter and continue copying.'
                },
                {
                    label: 'Propose licensing deal',
                    description: 'Turn the copier into a paying customer',
                    consequence: 'license_infringer',
                    narrativeGood: 'Competitor agrees to pay us—new revenue stream.',
                    narrativeBad: 'Negotiations drag on; they use the time to design around us.'
                }
            ]
        },
        {
            id: 'infringement_victory',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Meera Venkataraman, CEO',
            icon: '🎉',
            title: 'We Won the Lawsuit! Now What?',
            description: 'Great news — we won the patent case. They\'re paying us $2M in damages. Now I need your input on what to do with it. I\'m inclined to reinvest in R&D, but the board wants to discuss options. Should it go back to {projectA} that won the case? Should we file more patents for protection? Or spread it across all projects? What\'s your recommendation?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Reinvest in {projectA}',
                    description: 'Speed up the project that won the case',
                    consequence: 'reinvest_winnings',
                    narrativeGood: 'Additional funding speeds up development significantly.',
                    narrativeBad: 'Money well spent on the team that earned it.'
                },
                {
                    label: 'Build legal protection',
                    description: 'Fund more patent filings across all projects',
                    consequence: 'patent_warchest',
                    narrativeGood: 'Stronger legal position scares off future copiers.',
                    narrativeBad: 'Patents are valuable but don\'t ship products.'
                },
                {
                    label: 'Return to general R&D budget',
                    description: 'Spread across all projects equally',
                    consequence: 'spread_winnings',
                    narrativeGood: 'All projects benefit from the windfall.',
                    narrativeBad: 'Spread thin—no single project sees major boost.'
                }
            ]
        },
        {
            id: 'trade_secret_vs_patent',
            category: 'Legal',
            source: 'below',
            sourceRole: 'Ramesh Iyer, {projectA} Manufacturing Lead',
            icon: '🤫',
            title: 'Should We Really Patent This Process?',
            description: 'Hey, I wanted to flag something. Legal wants us to patent our new manufacturing process, but I\'m not sure that\'s smart. If we patent it, we have to publish exactly how it works — anyone can read it. Right now, only four people know the process. Maybe we should keep it secret? Coca-Cola never patented their formula, right? Just... something to think about.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Patent the process',
                    description: 'Publish how it works in exchange for legal protection',
                    consequence: 'patent_process',
                    narrativeGood: 'Patent provides clear legal protection and we can license it.',
                    narrativeBad: 'Competitors now know exactly how we do it.'
                },
                {
                    label: 'Keep it secret',
                    description: 'Maintain secrecy with strict controls',
                    consequence: 'trade_secret',
                    narrativeGood: 'Secret stays protected; competitors can\'t replicate.',
                    narrativeBad: 'Key engineer joins competitor, taking knowledge with them.'
                },
                {
                    label: 'Mix of both',
                    description: 'Patent some parts, keep core secret',
                    consequence: 'hybrid_ip',
                    narrativeGood: 'Strategic mix protects most valuable elements.',
                    narrativeBad: 'Complex to manage; some gaps in protection.'
                }
            ]
        },
        {
            id: 'prior_art_discovered',
            category: 'Legal',
            source: 'below',
            sourceRole: 'Arun Sharma, Patent Analyst',
            icon: '📚',
            title: 'I Found Something... Not Great',
            description: 'Um, so I was doing research and I found a 2015 paper from some obscure German university. It describes something very similar to what we\'re trying to patent for {projectA}. Our patent attorney says it\'s a grey area — we could argue our version is different. But I wanted you to know before we proceed. Do we push forward, narrow what we\'re claiming, or...?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Proceed and argue it\'s different',
                    description: 'Our version is sufficiently unique',
                    consequence: 'argue_novelty',
                    narrativeGood: 'Patent office accepts our arguments.',
                    narrativeBad: 'Patent granted but covers less than we hoped.'
                },
                {
                    label: 'Narrow what we\'re claiming',
                    description: 'Reduce scope to avoid overlap',
                    consequence: 'narrow_claims',
                    narrativeGood: 'Narrower but solid patent that will hold up.',
                    narrativeBad: 'Less protection leaves some inventions uncovered.'
                },
                {
                    label: 'Give up and publish instead',
                    description: 'Abandon patent, publish so nobody else can patent it',
                    consequence: 'withdraw_publish',
                    narrativeGood: 'Publication prevents competitors from patenting it.',
                    narrativeBad: 'We lose exclusive rights but so does everyone else.'
                }
            ]
        },
        
        // PARTNERSHIP & COLLABORATION DILEMMAS
        {
            id: 'supplier_codevelopment',
            category: 'Partnerships',
            source: 'above',
            sourceRole: 'Sanjay Kumar, VP Procurement',
            icon: '🏭',
            title: 'Our Supplier Wants to Build With Us',
            description: 'The sensor supplier for {projectA} has made an interesting proposal. They\'ll help develop the next-gen component at 40% lower cost — but they want our full product designs and the right to sell to anyone after 18 months. It\'s a significant cost saving, but we\'d be giving up exclusivity. I need your sign-off before I proceed.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept the partnership',
                    description: 'Cost savings outweigh exclusivity concerns',
                    consequence: 'accept_supplier_coop',
                    narrativeGood: 'Joint work yields better component at lower cost.',
                    narrativeBad: 'Supplier now understands our design; competitors may benefit later.'
                },
                {
                    label: 'Counter with longer exclusivity',
                    description: 'Negotiate 36-month exclusive period',
                    consequence: 'negotiate_exclusivity',
                    narrativeGood: 'Supplier agrees to extended exclusivity—we keep our edge.',
                    narrativeBad: 'Supplier walks away; we lose the cost savings.'
                },
                {
                    label: 'Build it ourselves instead',
                    description: 'Maintain full control, accept higher costs',
                    consequence: 'inhouse_development',
                    narrativeGood: 'Full control over our plans and technology.',
                    narrativeBad: 'Higher costs and slower work without supplier expertise.'
                }
            ]
        },
        {
            id: 'customer_codevelopment',
            category: 'Partnerships',
            source: 'above',
            sourceRole: 'Meera Venkataraman, CEO',
            icon: '🤝',
            title: 'Tata Projects Wants In on Our R&D',
            description: 'Tata Projects has approached us with an offer. They\'ll co-fund {projectA} development — $1.5M — in exchange for 12-month exclusivity and a seat at the planning table. It\'s real money and a big-name customer. But exclusivity means other enterprise deals wait a year. And they\'ll want influence over features. Your thoughts?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept Tata partnership',
                    description: 'Guaranteed funding and customer',
                    consequence: 'accept_customer_coop',
                    narrativeGood: 'Tata funding speeds up development; great reference customer.',
                    narrativeBad: 'Exclusivity delays broader market; product shaped too narrowly for Tata.'
                },
                {
                    label: 'Offer advisory role only',
                    description: 'Input without exclusivity or funding',
                    consequence: 'advisory_only',
                    narrativeGood: 'Tata provides valuable input without limiting our market.',
                    narrativeBad: 'Tata feels undervalued and looks at competitor solutions.'
                },
                {
                    label: 'Decline and stay independent',
                    description: 'Build for the broader market',
                    consequence: 'stay_independent',
                    narrativeGood: 'Product serves wider market without compromise.',
                    narrativeBad: 'Slower development without partner funding.'
                }
            ]
        },
        {
            id: 'university_collaboration',
            category: 'Partnerships',
            source: 'below',
            sourceRole: 'Dr. Meera Krishnan, AI Lead',
            icon: '🎓',
            title: 'IIT Delhi Wants to Collaborate With Us!',
            description: 'Great news! Professor Sharma from IIT Delhi\'s AI lab reached out. They want to collaborate on {projectA}\'s AI challenges — they\'d give us three PhD students for a year! The catch is they want to publish papers and share ownership of any discoveries. I know that\'s complicated, but their work is genuinely world-class. Can we make this happen?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Full research partnership',
                    description: 'Share ownership for access to top talent',
                    consequence: 'full_university_partner',
                    narrativeGood: 'PhD students solve key challenges; papers boost reputation.',
                    narrativeBad: 'Published research helps competitors; ownership gets messy.'
                },
                {
                    label: 'Sponsored research (we own it)',
                    description: 'Pay $0.4M to keep full ownership',
                    consequence: 'sponsored_research',
                    narrativeGood: 'World-class research with clear ownership.',
                    narrativeBad: 'More expensive but cleaner arrangement.'
                },
                {
                    label: 'Hire graduates instead',
                    description: 'Recruit talent without research complications',
                    consequence: 'hire_graduates',
                    narrativeGood: 'Great hires strengthen the team long-term.',
                    narrativeBad: 'Miss out on latest academic research.'
                }
            ]
        },
        {
            id: 'consortium_invitation',
            category: 'Partnerships',
            source: 'above',
            sourceRole: 'Harpreet Singh, CTO',
            icon: '🌐',
            title: 'The Smart Home Alliance Wants Us to Join',
            description: 'The Smart Home Alliance has invited us to join their industry group. Membership means sharing some of {projectA}\'s methods — but we\'d get access to everyone else\'s too. More importantly, we\'d have a vote on future standards. If we stay out and they set standards without us, we could be at a disadvantage. What\'s your view?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Join as full member',
                    description: 'Share our methods, gain influence',
                    consequence: 'join_consortium',
                    narrativeGood: 'Our methods become industry standard; competitors must follow us.',
                    narrativeBad: 'Our secret advantages get shared; harder to stand out.'
                },
                {
                    label: 'Join as observer only',
                    description: 'Watch developments without contributing',
                    consequence: 'observer_status',
                    narrativeGood: 'See what competitors are doing without giving anything away.',
                    narrativeBad: 'No vote on standards; may be disadvantaged by decisions.'
                },
                {
                    label: 'Decline and go our own way',
                    description: 'Bet on our own approach winning',
                    consequence: 'proprietary_path',
                    narrativeGood: 'Strong differentiation in a fragmented market.',
                    narrativeBad: 'Industry standardizes without us; connecting to others becomes costly.'
                }
            ]
        },
        {
            id: 'supplier_quality_crisis',
            category: 'Partnerships',
            source: 'below',
            sourceRole: 'Ramesh Iyer, Manufacturing Lead',
            icon: '😱',
            title: 'The Circuit Boards Are Bad. Really Bad.',
            description: 'I don\'t know how to tell you this. The latest batch from our factory has a 15% defect rate. FIFTEEN. They\'re blaming our design files. I don\'t buy it — we haven\'t changed anything. But the launch is in 3 weeks and I don\'t have enough good boards. I need you to decide: do we work with them to fix it, switch factories, or ship what we have and throw out the bad ones?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Work together to fix it',
                    description: 'Joint effort to find root cause',
                    consequence: 'joint_fix',
                    narrativeGood: 'Working together finds the flaw; stronger relationship.',
                    narrativeBad: 'Takes longer than expected; launch slips by 4 weeks.'
                },
                {
                    label: 'Switch factories immediately',
                    description: 'Find new manufacturer, accept delay',
                    consequence: 'switch_supplier',
                    narrativeGood: 'New factory delivers quality; worth the disruption.',
                    narrativeBad: 'Expensive transition; 6-week delay while new factory ramps.'
                },
                {
                    label: 'Accept and sort manually',
                    description: 'Throw out defects, launch with reduced inventory',
                    consequence: 'manual_screening',
                    narrativeGood: 'Launch proceeds on time with adequate inventory.',
                    narrativeBad: 'Higher unit cost; some defects slip through to customers.'
                }
            ]
        },
        {
            id: 'customer_pilot_scope',
            category: 'Partnerships',
            source: 'below',
            sourceRole: 'Ankit Patel, Customer Success Lead',
            icon: '🧪',
            title: 'Our Pilot Customer Built Their Own Add-Ons 😅',
            description: 'So... you know how excited our {projectA} pilot customer has been? Maybe too excited. They built their own add-ons to our product. Custom stuff, without asking us. Now they want us to either support their modifications officially, or let them share them publicly. I\'m not sure what to tell them. This is kind of a compliment? But also a headache?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Add them to our product',
                    description: 'Adopt their add-ons as official features',
                    consequence: 'absorb_extensions',
                    narrativeGood: 'Customer ideas improve our product for everyone.',
                    narrativeBad: 'Our plans get derailed to support customer-built features.'
                },
                {
                    label: 'Let them share publicly',
                    description: 'Allow them to give it away',
                    consequence: 'allow_opensource',
                    narrativeGood: 'Community contributions emerge; more people use our product.',
                    narrativeBad: 'Creates confusion; support burden increases.'
                },
                {
                    label: 'Enforce our license',
                    description: 'Their modifications break our rules',
                    consequence: 'enforce_license',
                    narrativeGood: 'Clear boundaries maintained; our work protected.',
                    narrativeBad: 'Customer relationship damaged; they switch to competitor.'
                }
            ]
        },
        {
            id: 'joint_venture_ip',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Kavitha Rajan, Chief Legal Officer',
            icon: '⚔️',
            title: 'Our Partner Is Claiming They Own Our Work',
            description: 'We have a serious problem. Our joint venture partner on {projectA} is claiming their engineers invented the key technology, not ours. The partnership agreement is... ambiguous on this point. They\'re threatening to license "their" invention to Hikvision if we don\'t give in. This could get ugly. I need guidance on how aggressive you want us to be.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Negotiate buyout',
                    description: 'Offer to buy their share ($0.8M)',
                    consequence: 'buyout_jv_ip',
                    narrativeGood: 'Clean ownership; partner exits satisfied.',
                    narrativeBad: 'Expensive, but eliminates ongoing conflict.'
                },
                {
                    label: 'Go to arbitration',
                    description: 'Let a neutral party decide ownership',
                    consequence: 'arbitration',
                    narrativeGood: 'Arbitrator rules in our favor; ownership secured.',
                    narrativeBad: 'Process drags on; relationship destroyed regardless of outcome.'
                },
                {
                    label: 'Propose shared use',
                    description: 'Both sides can use the technology independently',
                    consequence: 'cross_license',
                    narrativeGood: 'Practical solution keeps both sides productive.',
                    narrativeBad: 'Competitor may eventually get access through our partner.'
                }
            ]
        },
        {
            id: 'open_source_decision',
            category: 'Partnerships',
            source: 'below',
            sourceRole: 'Vikram Menon, Platform Lead',
            icon: '📖',
            title: 'Should We Give Away Our Development Tools?',
            description: 'I\'ve been thinking... what if we made {projectA}\'s developer tools free and open? I know it sounds crazy, but hear me out. Developers would flock to us. The community would fix bugs for free. Competitors could use it too, sure, but our cloud services stay paid. That\'s where the real money is anyway. What do you think? Too risky?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Make it free and open',
                    description: 'Build community, make money on cloud services',
                    consequence: 'opensource_sdk',
                    narrativeGood: 'Developer community forms; adoption speeds up.',
                    narrativeBad: 'Competitors copy and improve without giving back.'
                },
                {
                    label: 'Show the code but restrict use',
                    description: 'Viewable but restricted for business use',
                    consequence: 'source_available',
                    narrativeGood: 'Transparency builds trust; rules protect business interests.',
                    narrativeBad: 'Developers frustrated by restrictions; limited community growth.'
                },
                {
                    label: 'Keep it closed',
                    description: 'Maintain full control',
                    consequence: 'keep_proprietary',
                    narrativeGood: 'Full control; clear way to make money.',
                    narrativeBad: 'Slower adoption; developers choose open alternatives.'
                }
            ]
        },
        {
            id: 'startup_acquisition_ip',
            category: 'Legal',
            source: 'above',
            sourceRole: 'Kavitha Rajan, Chief Legal Officer',
            icon: '🚀',
            title: 'This Acquisition Has Red Flags',
            description: 'I need to flag something about that startup you want to acquire. Their tech would speed up {projectA} by 6 months — I get why you want it. But we found that the founders built this technology while working at Godrej. The ownership might be questionable. If we buy them and Godrej sues... I can\'t guarantee the outcome. Your call.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Acquire anyway',
                    description: 'Accept the risk; technology is too valuable',
                    consequence: 'acquire_risky',
                    narrativeGood: 'No legal challenge happens; technology works great.',
                    narrativeBad: 'Former employer sues; acquisition becomes a problem.'
                },
                {
                    label: 'Hire the team only',
                    description: 'Hire the people, have them rebuild from scratch',
                    consequence: 'acquihire',
                    narrativeGood: 'Talented team speeds up {projectA} with clean ownership.',
                    narrativeBad: 'Slower than buying the tech; some founders don\'t join.'
                },
                {
                    label: 'Walk away',
                    description: 'Risk is too high; find another path',
                    consequence: 'walk_away_acquisition',
                    narrativeGood: 'Avoided a legal disaster; found alternative solution.',
                    narrativeBad: 'Competitor acquires them instead.'
                }
            ]
        },
        {
            id: 'customer_data_sharing',
            category: 'Partnerships',
            source: 'above',
            sourceRole: 'Nikhil Desai, VP Sales',
            icon: '📊',
            title: 'Infosys Wants a Data Swap',
            description: 'Infosys has an interesting proposition. They\'ll share their usage data to help improve {projectA}\'s AI — but only if we share combined insights from all our customers with them. Legal says our privacy policy technically allows it. I think it could make the product way better. But I wanted to run it by you first. Thoughts?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accept the exchange',
                    description: 'Mutual data sharing benefits both sides',
                    consequence: 'data_exchange',
                    narrativeGood: 'Rich data dramatically improves product performance.',
                    narrativeBad: 'Other customers uncomfortable when they learn of arrangement.'
                },
                {
                    label: 'One-way only',
                    description: 'Take their data, share nothing back',
                    consequence: 'one_way_data',
                    narrativeGood: 'We benefit without sharing our insights.',
                    narrativeBad: 'Customer feels used; relationship strained.'
                },
                {
                    label: 'Decline entirely',
                    description: 'Keep data relationships simple',
                    consequence: 'decline_data_sharing',
                    narrativeGood: 'Clean data rules; no complicated arrangements.',
                    narrativeBad: 'Miss opportunity to improve product.'
                }
            ]
        },
        {
            id: 'partner_pivot',
            category: 'Partnerships',
            source: 'above',
            sourceRole: 'Harpreet Singh, CTO',
            icon: '🔄',
            title: 'Our Partner Just Became Our Competitor',
            description: 'You\'re not going to believe this. That development partner on {projectA}? They just announced they\'re switching to compete directly with us. And they still have access to our systems and plans. I\'ve already raised this with legal but we need a decision fast. Do we cut them off immediately, wind down slowly, or... somehow keep working with them?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Terminate immediately',
                    description: 'Cut off access, accept disruption',
                    consequence: 'terminate_partner',
                    narrativeGood: 'Clean break; they can\'t use our plans against us.',
                    narrativeBad: 'Scramble to replace their contributions; 2-month delay.'
                },
                {
                    label: 'Gradual wind-down',
                    description: '90-day transition to reduce dependencies',
                    consequence: 'orderly_winddown',
                    narrativeGood: 'Smooth transition minimizes disruption.',
                    narrativeBad: 'They continue gathering information during wind-down.'
                },
                {
                    label: 'Continue partnership anyway',
                    description: 'Their new direction doesn\'t affect our work together',
                    consequence: 'continue_despite_pivot',
                    narrativeGood: 'Practical approach; partnership still valuable.',
                    narrativeBad: 'They use inside knowledge to compete effectively.'
                }
            ]
        },
        
        // CORPORATE TENSIONS
        {
            id: 'strategy_pivot',
            category: 'Corporate',
            source: 'above',
            sourceRole: 'Meera Venkataraman, CEO',
            icon: '🎯',
            title: 'We\'re Changing Direction. Here\'s What That Means for You.',
            description: 'I\'m sure you saw the all-hands. We\'re going from "premium security" to "security for everyone." I know {projectA} was designed for big companies, and I know this might feel like the rug is being pulled out. It\'s not. But I need you to figure out if {projectA} can serve this new direction — or if we need to have a harder conversation.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Reposition the project',
                    description: 'Adapt {projectA} for the consumer market',
                    consequence: 'reposition_project',
                    narrativeGood: 'Repositioned product finds unexpected consumer appeal.',
                    narrativeBad: 'Neither enterprise nor consumer customers fully satisfied.'
                },
                {
                    label: 'Argue for exception',
                    description: 'Make the case that enterprise still matters',
                    consequence: 'argue_exception',
                    narrativeGood: 'Leadership agrees enterprise remains important; project continues.',
                    narrativeBad: 'Seen as not being a team player; project gets reduced support.'
                },
                {
                    label: 'Create separate unit',
                    description: 'Spin off enterprise division to protect the project',
                    consequence: 'spinout_unit',
                    narrativeGood: 'Separate unit thrives serving enterprise customers.',
                    narrativeBad: 'Isolated from main company resources and attention.'
                }
            ]
        },
        {
            id: 'new_cto_agenda',
            category: 'Corporate',
            source: 'above',
            sourceRole: 'New CTO (just joined)',
            icon: '👨‍💼',
            title: 'I\'ve Been Looking at How You Built This...',
            description: 'So I\'ve spent my first two weeks reviewing our technology. I have to be honest — this local-processing approach on {projectA} feels outdated to me. Where I came from, everything ran in the cloud. I want us to move that direction within 18 months. I\'d like your thoughts on how we get there, but the direction is set.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace the cloud shift',
                    description: 'Rebuild {projectA} for the cloud',
                    consequence: 'embrace_cloud',
                    narrativeGood: 'Cloud approach unlocks new capabilities and scale.',
                    narrativeBad: 'Major rework delays project; local-processing advantages lost.'
                },
                {
                    label: 'Propose mix of both',
                    description: 'Local processing with cloud backup',
                    consequence: 'hybrid_approach',
                    narrativeGood: 'Mixed model satisfies CTO while keeping local benefits.',
                    narrativeBad: 'Complexity of supporting both approaches strains team.'
                },
                {
                    label: 'Push back with evidence',
                    description: 'Present speed and reliability data for local processing',
                    consequence: 'pushback_with_data',
                    narrativeGood: 'Evidence convinces CTO; local approach preserved.',
                    narrativeBad: 'CTO feels challenged; relationship starts on wrong foot.'
                }
            ]
        },
        {
            id: 'new_erp_system',
            category: 'Corporate',
            source: 'above',
            sourceRole: 'IT Director',
            icon: '💻',
            title: 'New Budgeting System Rollout',
            description: 'IT is rolling out a new finance system that requires all projects to re-enter budgets, timelines, and milestones in a completely different format. The migration will consume 2 weeks of manager time across all projects.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Comply immediately',
                    description: 'Prioritize the migration as requested',
                    consequence: 'comply_erp',
                    narrativeGood: 'Clean migration; better visibility into project finances.',
                    narrativeBad: 'Two weeks of lost productivity; some data entry mistakes.'
                },
                {
                    label: 'Request delay',
                    description: 'Ask to migrate after current milestone',
                    consequence: 'request_exemption',
                    narrativeGood: 'IT grants delay; project maintains momentum.',
                    narrativeBad: 'IT escalates to CFO; forced compliance with bad timing.'
                },
                {
                    label: 'Delegate to junior staff',
                    description: 'Have analysts handle migration while leads focus on delivery',
                    consequence: 'delegate_erp',
                    narrativeGood: 'Analysts handle migration competently.',
                    narrativeBad: 'Data entry errors create budget problems that take weeks to fix.'
                }
            ]
        },
        {
            id: 'performance_system_change',
            category: 'Corporate',
            source: 'above',
            sourceRole: 'HR Director',
            icon: '📋',
            title: 'New Goal-Setting System',
            description: 'HR has introduced quarterly goal-setting replacing the old annual reviews. Now {projectA} team members must set quarterly goals aligned to company priorities. The team finds it time-consuming and distracting from actual work.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace it fully',
                    description: 'Make the goals meaningful for the team',
                    consequence: 'embrace_okrs',
                    narrativeGood: 'Goals actually improve team focus and alignment.',
                    narrativeBad: 'Time spent on goal-setting comes at expense of actual work.'
                },
                {
                    label: 'Do the minimum',
                    description: 'Check the boxes but don\'t let it disrupt work',
                    consequence: 'minimal_okrs',
                    narrativeGood: 'Team maintains focus; goals don\'t interfere.',
                    narrativeBad: 'HR flags team for "not taking development seriously."'
                },
                {
                    label: 'Give honest feedback',
                    description: 'Tell HR the system isn\'t working for R&D',
                    consequence: 'feedback_okrs',
                    narrativeGood: 'HR adapts system for R&D teams; becomes model for others.',
                    narrativeBad: 'Labelled as "difficult"; team watched more closely.'
                }
            ]
        },
        {
            id: 'cost_cutting_mandate',
            category: 'Corporate',
            source: 'above',
            sourceRole: 'Farhan Qureshi, CFO',
            icon: '✂️',
            title: 'We Need to Cut 15%',
            description: 'Finance has mandated 15% budget cuts across all departments. R&D must choose where to cut: headcount, outside contractors, equipment, or travel and training.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Cut contractors',
                    description: 'Reduce outside spend, keep employees',
                    consequence: 'cut_contractors',
                    narrativeGood: 'Team absorbs contractor work; capability retained.',
                    narrativeBad: 'Specialized work suffers without contractor expertise.'
                },
                {
                    label: 'Freeze hiring and training',
                    description: 'No new hires, no conferences, no courses',
                    consequence: 'freeze_growth',
                    narrativeGood: 'Short-term savings with minimal immediate impact.',
                    narrativeBad: 'Team skills stagnate; key hire vacancy hurts velocity.'
                },
                {
                    label: 'Propose project consolidation',
                    description: 'Merge {projectA} with similar effort to share resources',
                    consequence: 'consolidate_projects',
                    narrativeGood: 'Consolidated project becomes more focused and efficient.',
                    narrativeBad: 'Merged teams clash; worst of both approaches survives.'
                }
            ]
        },
        {
            id: 'reorg_announcement',
            category: 'Corporate',
            icon: '🔀',
            title: 'Reorganization Announced',
            description: 'A major reorg moves {projectA} from the Innovation division to the Product division. New management has different priorities and doesn\'t understand the project\'s exploratory nature.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Adapt to new home',
                    description: 'Reframe project in product terms',
                    consequence: 'adapt_reorg',
                    narrativeGood: 'Product framing actually helps focus and accelerate delivery.',
                    narrativeBad: 'Innovation aspects deprioritized; project becomes incremental.'
                },
                {
                    label: 'Lobby to stay in Innovation',
                    description: 'Make the case for keeping current reporting',
                    consequence: 'lobby_stay',
                    narrativeGood: 'Exception granted; project keeps exploratory mandate.',
                    narrativeBad: 'Seen as political; new Product VP becomes adversarial.'
                },
                {
                    label: 'Accept but negotiate terms',
                    description: 'Move but get commitments on timeline and approach',
                    consequence: 'negotiate_reorg',
                    narrativeGood: 'Clear agreement protects project while building new relationships.',
                    narrativeBad: 'Agreements forgotten within a quarter; back to square one.'
                }
            ]
        },
        {
            id: 'talent_poaching',
            category: 'Corporate',
            icon: '🎣',
            title: 'Competitor Poaching Talent',
            description: 'A competitor is aggressively recruiting ShieldTech engineers, offering 40% raises. Two key {projectA} team members have received offers. HR\'s hands are tied on counter-offers by company policy.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Push for exceptions',
                    description: 'Escalate to CEO for retention packages',
                    consequence: 'push_retention',
                    narrativeGood: 'CEO approves retention bonuses; key talent stays.',
                    narrativeBad: 'Sets precedent; other teams demand same treatment.'
                },
                {
                    label: 'Non-monetary retention',
                    description: 'Offer promotions, interesting work, flexibility',
                    consequence: 'nonmonetary_retain',
                    narrativeGood: 'Team values growth opportunities; most stay.',
                    narrativeBad: 'Money talks; both engineers leave despite promises.'
                },
                {
                    label: 'Let them go gracefully',
                    description: 'Wish them well, start succession planning',
                    consequence: 'graceful_departure',
                    narrativeGood: 'Departures handled well; one returns after 6 months.',
                    narrativeBad: 'Knowledge loss hurts; project momentum disrupted.'
                }
            ]
        },
        {
            id: 'compliance_overhead',
            category: 'Corporate',
            icon: '📝',
            title: 'New Compliance Requirements',
            description: 'Legal has introduced new data governance requirements after a regulatory inquiry. {projectA} must now document all data flows, conduct privacy impact assessments, and get legal sign-off on new features.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Build compliance into process',
                    description: 'Integrate requirements into sprint workflow',
                    consequence: 'integrate_compliance',
                    narrativeGood: 'Privacy-by-design becomes competitive advantage.',
                    narrativeBad: 'Velocity drops 20% from compliance overhead.'
                },
                {
                    label: 'Hire compliance specialist',
                    description: 'Dedicate headcount to handle requirements',
                    consequence: 'hire_compliance',
                    narrativeGood: 'Specialist handles compliance efficiently; team stays focused.',
                    narrativeBad: 'Budget hit for specialist; takes time to become effective.'
                },
                {
                    label: 'Batch compliance reviews',
                    description: 'Quarterly reviews instead of per-feature',
                    consequence: 'batch_compliance',
                    narrativeGood: 'Efficient approach satisfies legal with minimal disruption.',
                    narrativeBad: 'Legal rejects batching; must do per-feature after all.'
                }
            ]
        },
        {
            id: 'board_presentation',
            category: 'Corporate',
            icon: '🎤',
            title: 'Board Presentation Request',
            description: 'The CEO wants you to present {projectA} to the board next week. It\'s a visibility opportunity, but the project isn\'t ready for scrutiny—there are known issues you haven\'t resolved yet.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Present optimistically',
                    description: 'Focus on potential, downplay current issues',
                    consequence: 'present_optimistic',
                    narrativeGood: 'Board impressed; project gets champion among directors.',
                    narrativeBad: 'Board asks tough questions; unresolved issues exposed.'
                },
                {
                    label: 'Present honestly',
                    description: 'Show progress and challenges transparently',
                    consequence: 'present_honest',
                    narrativeGood: 'Board appreciates candor; offers constructive guidance.',
                    narrativeBad: 'Board questions why issues weren\'t fixed; confidence shaken.'
                },
                {
                    label: 'Request postponement',
                    description: 'Ask to present in 6 weeks when issues resolved',
                    consequence: 'postpone_presentation',
                    narrativeGood: 'CEO agrees; extra time allows stronger presentation.',
                    narrativeBad: 'Seen as not ready for prime time; slot given to another project.'
                }
            ]
        },
        {
            id: 'agile_transformation',
            category: 'Corporate',
            icon: '🔄',
            title: 'Agile Transformation Mandate',
            description: 'The COO has decreed that all teams must adopt SAFe (Scaled Agile Framework). Consultants are arriving to "transform" R&D. Your {projectA} team already uses their own lightweight agile approach that works well.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace SAFe fully',
                    description: 'Adopt the framework as prescribed',
                    consequence: 'embrace_safe',
                    narrativeGood: 'SAFe actually improves cross-team coordination.',
                    narrativeBad: 'Bureaucratic overhead slows everything down.'
                },
                {
                    label: 'SAFe on paper only',
                    description: 'Use SAFe terminology but keep current practices',
                    consequence: 'safe_theater',
                    narrativeGood: 'Consultants satisfied; team keeps working effectively.',
                    narrativeBad: 'Discovered during audit; team forced to truly adopt.'
                },
                {
                    label: 'Propose pilot exemption',
                    description: 'Ask to be compared against SAFe teams as control group',
                    consequence: 'pilot_exemption',
                    narrativeGood: 'Exemption granted; your approach becomes model for others.',
                    narrativeBad: 'COO insists on consistency; no exemptions allowed.'
                }
            ]
        },
        {
            id: 'office_relocation',
            category: 'Corporate',
            icon: '🏢',
            title: 'Office Relocation',
            description: 'Facilities is moving the R&D floor to a new "open plan collaboration space." The {projectA} team is concerned about noise and loss of focus areas for deep work.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Embrace the move',
                    description: 'Make the best of the new space',
                    consequence: 'embrace_openplan',
                    narrativeGood: 'Open plan actually improves cross-team collaboration.',
                    narrativeBad: 'Constant interruptions kill deep work; productivity drops.'
                },
                {
                    label: 'Negotiate quiet zones',
                    description: 'Push for dedicated focus rooms',
                    consequence: 'negotiate_quiet',
                    narrativeGood: 'Facilities creates bookable focus rooms; balance achieved.',
                    narrativeBad: 'Token effort; one tiny room shared by 50 people.'
                },
                {
                    label: 'Go hybrid/remote',
                    description: 'Team works from home for focus, office for collaboration',
                    consequence: 'go_hybrid',
                    narrativeGood: 'Hybrid model gives best of both worlds.',
                    narrativeBad: 'Leadership sees it as "not committed"; team viewed skeptically.'
                }
            ]
        },
        
        // STARTUP COLLABORATION DILEMMAS
        {
            id: 'startup_no_track_record',
            category: 'Startup Collaboration',
            icon: '🚀',
            title: 'Promising but Unproven Startup',
            description: 'A 6-month-old startup has impressive tech that could accelerate {projectA}. Their demo is amazing, but they have zero production deployments, no paying customers, and their CTO is 24 years old.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Partner anyway',
                    description: 'Their tech is worth the risk',
                    consequence: 'partner_unproven',
                    narrativeGood: 'Startup delivers; their hunger and agility exceed expectations.',
                    narrativeBad: 'Reality hits hard—tech works in demo, fails at scale.'
                },
                {
                    label: 'Paid proof of concept first',
                    description: 'Small engagement ($0.2M) to validate capability',
                    consequence: 'startup_poc',
                    narrativeGood: 'POC succeeds; confidence to proceed with full integration.',
                    narrativeBad: 'POC reveals gaps; saved us from bigger mistake.'
                },
                {
                    label: 'Wait for them to mature',
                    description: 'Revisit in 12 months when they have customers',
                    consequence: 'wait_startup',
                    narrativeGood: 'Found alternative; startup later implodes anyway.',
                    narrativeBad: 'Competitor partners with them; gains 6-month lead.'
                }
            ]
        },
        {
            id: 'startup_moves_fast',
            category: 'Startup Collaboration',
            icon: '⚡',
            title: 'Startup Moving Too Fast',
            description: 'The startup partner on {projectA} is shipping API changes weekly without documentation or notice. Your team spends half their time chasing breaking changes. "Move fast and break things" is their motto.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Demand stable API',
                    description: 'Require versioning and deprecation policy',
                    consequence: 'demand_stability',
                    narrativeGood: 'Startup agrees to enterprise-grade API practices.',
                    narrativeBad: 'Startup frustrated by "corporate bureaucracy"; relationship sours.'
                },
                {
                    label: 'Assign integration engineer',
                    description: 'Dedicate someone to absorb the chaos',
                    consequence: 'absorb_chaos',
                    narrativeGood: 'Integration engineer becomes expert; shields team from churn.',
                    narrativeBad: 'Burnout risk; integration engineer becomes single point of failure.'
                },
                {
                    label: 'Fork and stabilize',
                    description: 'Take their code and maintain our own version',
                    consequence: 'fork_startup',
                    narrativeGood: 'Stable fork lets team focus on features.',
                    narrativeBad: 'Miss their improvements; fork diverges, becoming maintenance burden.'
                }
            ]
        },
        {
            id: 'startup_ip_careless',
            category: 'Startup Collaboration',
            icon: '😬',
            title: 'Startup IP Carelessness',
            description: 'Your startup partner casually mentioned they\'re using the same code in {projectA} that they developed for a competitor last year. Their founder says "code is just code—we own it."',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Demand IP audit',
                    description: 'Full review of code provenance before continuing',
                    consequence: 'ip_audit',
                    narrativeGood: 'Audit reveals code is clean; founder was just sloppy with words.',
                    narrativeBad: 'Audit finds problems; 3-month delay to rewrite tainted code.'
                },
                {
                    label: 'Require clean-room rewrite',
                    description: 'They rebuild from scratch with documentation',
                    consequence: 'cleanroom_rewrite',
                    narrativeGood: 'Clean-room version is actually better designed.',
                    narrativeBad: 'Expensive delay; startup bills for rewrite time.'
                },
                {
                    label: 'Get indemnification',
                    description: 'They guarantee to cover any IP claims',
                    consequence: 'indemnification',
                    narrativeGood: 'Legal protection gives confidence to proceed.',
                    narrativeBad: 'Startup\'s indemnification is worthless—they have no assets.'
                }
            ]
        },
        {
            id: 'startup_late_delivery',
            category: 'Startup Collaboration',
            icon: '⏰',
            title: 'Startup Misses Every Deadline',
            description: 'The startup has missed three consecutive delivery milestones for {projectA} components. Each time there\'s a plausible excuse. They\'re now 8 weeks behind, and your launch date is at risk.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Give final ultimatum',
                    description: 'One more miss and we terminate',
                    consequence: 'startup_ultimatum',
                    narrativeGood: 'Ultimatum focuses minds; they finally deliver.',
                    narrativeBad: 'They miss again; now 12 weeks behind with no alternative.'
                },
                {
                    label: 'Embed our engineer',
                    description: 'Send someone to work from their office',
                    consequence: 'embed_engineer',
                    narrativeGood: 'Embedded engineer unblocks issues; delivery accelerates.',
                    narrativeBad: 'Our engineer reports chaos worse than expected.'
                },
                {
                    label: 'Parallel path with backup',
                    description: 'Start alternative development while they continue',
                    consequence: 'parallel_backup',
                    narrativeGood: 'Backup ready when startup misses again.',
                    narrativeBad: 'Expensive duplication; startup actually delivers, wasting backup effort.'
                }
            ]
        },
        {
            id: 'startup_acquihire_risk',
            category: 'Startup Collaboration',
            icon: '💰',
            title: 'Startup Acquisition Rumors',
            description: 'Rumors say Google is acquiring your startup partner. If true, {projectA}\'s critical dependency could become unavailable or absorbed into a competitor\'s ecosystem. The startup won\'t confirm or deny.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Accelerate integration',
                    description: 'Get as much value as possible before deal closes',
                    consequence: 'accelerate_integration',
                    narrativeGood: 'Integration completed before acquisition; dependency reduced.',
                    narrativeBad: 'Rushed integration creates technical debt.'
                },
                {
                    label: 'Negotiate source code escrow',
                    description: 'Get access to code if they\'re acquired',
                    consequence: 'source_escrow',
                    narrativeGood: 'Escrow agreement protects us if acquisition happens.',
                    narrativeBad: 'Startup refuses; says it would kill the deal.'
                },
                {
                    label: 'Start replacing immediately',
                    description: 'Begin migration to alternative before it\'s too late',
                    consequence: 'preemptive_replace',
                    narrativeGood: 'Migration complete when acquisition announced.',
                    narrativeBad: 'Acquisition never happens; wasted effort replacing good partner.'
                }
            ]
        },
        {
            id: 'startup_pivot',
            category: 'Startup Collaboration',
            icon: '🔄',
            title: 'Startup Pivots Away',
            description: 'Your startup partner just announced they\'re pivoting from B2B to consumer. The API {projectA} depends on is being "deprecated" in 6 months. They suggest you "transition to the new platform."',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Negotiate extended support',
                    description: 'Pay for them to maintain B2B API longer',
                    consequence: 'extended_support',
                    narrativeGood: 'Extended support buys time for proper migration.',
                    narrativeBad: 'Support is expensive and half-hearted.'
                },
                {
                    label: 'Take over the B2B product',
                    description: 'License or acquire the deprecated platform',
                    consequence: 'acquire_deprecated',
                    narrativeGood: 'Acquired platform gives full control.',
                    narrativeBad: 'Maintenance burden without their expertise.'
                },
                {
                    label: 'Accelerate replacement',
                    description: 'Find alternative within 6-month window',
                    consequence: 'rapid_replacement',
                    narrativeGood: 'New vendor actually better than original.',
                    narrativeBad: 'Rushed evaluation leads to poor choice.'
                }
            ]
        },
        {
            id: 'startup_runway',
            category: 'Startup Collaboration',
            icon: '📉',
            title: 'Startup Running Out of Cash',
            description: 'Your startup partner\'s CFO quietly mentioned they have 4 months of runway. They\'re fundraising but nothing is certain. {projectA} relies on their technology.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Prepay for services',
                    description: 'Advance $0.6M to extend their runway',
                    consequence: 'prepay_startup',
                    narrativeGood: 'Prepayment helps them survive; they raise funding.',
                    narrativeBad: 'They still fail; prepayment lost.'
                },
                {
                    label: 'Strategic investment',
                    description: 'Take equity stake to ensure survival',
                    consequence: 'strategic_invest',
                    narrativeGood: 'Investment saves them; we get upside when they succeed.',
                    narrativeBad: 'Equity worthless when they fail anyway.'
                },
                {
                    label: 'Execute exit plan',
                    description: 'Begin migrating away before collapse',
                    consequence: 'exit_startup',
                    narrativeGood: 'Migration complete when they shut down.',
                    narrativeBad: 'They survive and thrive; we look disloyal.'
                }
            ]
        },
        
        // AI & RESPONSIBLE TECHNOLOGY DILEMMAS
        {
            id: 'ai_bias_discovered',
            category: 'AI & Ethics',
            icon: '⚖️',
            title: 'AI Bias Discovered',
            description: 'Testing reveals {projectA}\'s AI model has significantly higher error rates for certain demographic groups. The bias isn\'t intentional, but it\'s measurable. Launch is in 3 weeks.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Delay for retraining',
                    description: 'Fix the bias before launch',
                    consequence: 'delay_retrain',
                    narrativeGood: 'Retrained model is fair and performs well.',
                    narrativeBad: '8-week delay; competitor launches first.'
                },
                {
                    label: 'Launch with disclosure',
                    description: 'Document limitation, commit to fix in update',
                    consequence: 'launch_disclose',
                    narrativeGood: 'Transparency appreciated; update fixes issue quickly.',
                    narrativeBad: 'Press picks up "biased AI" story; PR nightmare.'
                },
                {
                    label: 'Limit deployment scope',
                    description: 'Only deploy where bias doesn\'t affect outcomes',
                    consequence: 'limit_scope',
                    narrativeGood: 'Careful deployment avoids harm while fixing issue.',
                    narrativeBad: 'Limited scope means limited revenue.'
                }
            ]
        },
        {
            id: 'ai_transparency_demand',
            category: 'AI & Ethics',
            icon: '🔍',
            title: 'Customer Demands AI Transparency',
            description: 'A major enterprise customer for {projectA} is demanding full explainability for all AI decisions. They want to audit our model. Revealing architecture could expose competitive advantages.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Full transparency',
                    description: 'Open the black box completely',
                    consequence: 'full_transparency',
                    narrativeGood: 'Customer becomes advocate; transparency becomes selling point.',
                    narrativeBad: 'Competitor learns our approach; advantage eroded.'
                },
                {
                    label: 'Explainability layer only',
                    description: 'Add interpretable explanations without revealing model',
                    consequence: 'explain_layer',
                    narrativeGood: 'Customer satisfied with explanations; IP protected.',
                    narrativeBad: 'Explanations don\'t satisfy auditors; deal stalls.'
                },
                {
                    label: 'Decline the requirement',
                    description: 'Our model is proprietary; take it or leave it',
                    consequence: 'decline_transparency',
                    narrativeGood: 'Customer accepts; others don\'t ask either.',
                    narrativeBad: 'Customer walks; regulatory pressure increases.'
                }
            ]
        },
        {
            id: 'ai_regulation_coming',
            category: 'AI & Ethics',
            icon: '📜',
            title: 'AI Regulation Looming',
            description: 'Draft AI regulations would require {projectA} to register as "high-risk AI," conduct impact assessments, and maintain human oversight. Compliance would add 20% to costs.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Proactive compliance',
                    description: 'Build compliance in now before required',
                    consequence: 'proactive_comply',
                    narrativeGood: 'Early compliance becomes competitive advantage.',
                    narrativeBad: 'Regulations change; compliance work wasted.'
                },
                {
                    label: 'Wait and see',
                    description: 'Regulations may not pass or may change',
                    consequence: 'wait_regulation',
                    narrativeGood: 'Regulations watered down; minimal changes needed.',
                    narrativeBad: 'Strict rules pass; scramble to comply.'
                },
                {
                    label: 'Redesign to avoid scope',
                    description: 'Modify architecture to fall outside "high-risk" definition',
                    consequence: 'avoid_regulation',
                    narrativeGood: 'Clever design avoids regulatory burden.',
                    narrativeBad: 'Regulator sees through workaround; penalties threatened.'
                }
            ]
        },
        {
            id: 'ai_training_data_consent',
            category: 'AI & Ethics',
            icon: '📋',
            title: 'Training Data Consent Question',
            description: 'Legal has flagged that {projectA}\'s AI was trained on customer data collected before AI training was mentioned in the privacy policy. It\'s probably fine, but there\'s risk.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Retrain on consented data',
                    description: 'Only use data with explicit AI consent',
                    consequence: 'retrain_consent',
                    narrativeGood: 'Clean training data; unassailable compliance position.',
                    narrativeBad: 'Much smaller dataset; model performance degrades.'
                },
                {
                    label: 'Get retroactive consent',
                    description: 'Update policy and ask users to re-consent',
                    consequence: 'retroactive_consent',
                    narrativeGood: 'Most users consent; good data retained.',
                    narrativeBad: 'Consent request raises questions; some users delete data.'
                },
                {
                    label: 'Accept legal risk',
                    description: 'Proceed with legal\'s "probably fine" assessment',
                    consequence: 'accept_consent_risk',
                    narrativeGood: 'No issues arise; risk was overblown.',
                    narrativeBad: 'Class action lawsuit filed; expensive settlement.'
                }
            ]
        },
        {
            id: 'ai_hallucination',
            category: 'AI & Ethics',
            icon: '👻',
            title: 'AI Hallucination in Production',
            description: '{projectA}\'s AI assistant confidently gave a customer incorrect safety information. No one was hurt, but the potential was there. The model sometimes "hallucinates" convincingly.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Add human review',
                    description: 'All AI responses reviewed before sending',
                    consequence: 'human_review',
                    narrativeGood: 'Human review catches errors; trust rebuilt.',
                    narrativeBad: 'Review bottleneck kills response time; defeats AI purpose.'
                },
                {
                    label: 'Implement guardrails',
                    description: 'Technical limits on what AI can claim',
                    consequence: 'ai_guardrails',
                    narrativeGood: 'Guardrails prevent dangerous responses effectively.',
                    narrativeBad: 'Guardrails too restrictive; AI becomes unhelpfully cautious.'
                },
                {
                    label: 'Add prominent disclaimers',
                    description: '"AI-generated, verify important information"',
                    consequence: 'ai_disclaimers',
                    narrativeGood: 'Disclaimers manage expectations appropriately.',
                    narrativeBad: 'Disclaimers undermine trust; "why use AI if unreliable?"'
                }
            ]
        },
        {
            id: 'ai_job_displacement',
            category: 'AI & Ethics',
            icon: '👥',
            title: 'AI Automation Displaces Workers',
            description: '{projectA}\'s AI would automate work currently done by 30 employees at customer sites. Customer loves the efficiency, but press is writing about "job-killing AI." Your sales team is nervous.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Position as augmentation',
                    description: 'Market as "AI that helps workers, not replaces them"',
                    consequence: 'augmentation_message',
                    narrativeGood: 'Augmentation story resonates; employees become advocates.',
                    narrativeBad: 'Customers see through spin; they want the cost savings.'
                },
                {
                    label: 'Offer transition support',
                    description: 'Include retraining programs in the package',
                    consequence: 'transition_support',
                    narrativeGood: 'Transition programs become differentiator.',
                    narrativeBad: 'Adds cost; competitors win on price.'
                },
                {
                    label: 'Let customers decide',
                    description: 'We make the tool; how they use it is their choice',
                    consequence: 'customer_choice',
                    narrativeGood: 'Pragmatic approach; market rewards efficiency.',
                    narrativeBad: 'ShieldTech branded as job-killer; talent avoids us.'
                }
            ]
        },
        {
            id: 'ai_deepfake_misuse',
            category: 'AI & Ethics',
            icon: '🎭',
            title: 'AI Feature Enables Misuse',
            description: '{projectA}\'s face recognition could easily be adapted for deepfake detection—or deepfake creation. A security researcher publicly pointed this out. Do we restrict the API?',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Restrict API access',
                    description: 'Limit who can use sensitive capabilities',
                    consequence: 'restrict_api',
                    narrativeGood: 'Responsible restriction praised by ethics community.',
                    narrativeBad: 'Legitimate users frustrated; workarounds emerge anyway.'
                },
                {
                    label: 'Add usage monitoring',
                    description: 'Detect and block potential misuse patterns',
                    consequence: 'usage_monitoring',
                    narrativeGood: 'Monitoring catches bad actors; good actors unaffected.',
                    narrativeBad: 'Monitoring creates privacy concerns; expensive to maintain.'
                },
                {
                    label: 'Publish defense tools',
                    description: 'Release deepfake detection to counter misuse',
                    consequence: 'publish_defense',
                    narrativeGood: 'Defense tools establish us as responsible AI leader.',
                    narrativeBad: 'Detection tools help bad actors improve their fakes.'
                }
            ]
        },
        {
            id: 'ai_carbon_footprint',
            category: 'AI & Ethics',
            icon: '🌍',
            title: 'AI Carbon Footprint Criticism',
            description: 'An NGO report highlights that {projectA}\'s large AI model has a significant carbon footprint from training and inference. They\'re calling for "sustainable AI" practices.',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Switch to efficient models',
                    description: 'Use smaller, more efficient AI architectures',
                    consequence: 'efficient_models',
                    narrativeGood: 'Efficient models perform nearly as well; sustainability win.',
                    narrativeBad: 'Performance degradation noticeable; customers complain.'
                },
                {
                    label: 'Purchase carbon offsets',
                    description: 'Offset AI emissions through certified programs',
                    consequence: 'carbon_offsets',
                    narrativeGood: 'Carbon neutral AI becomes marketing advantage.',
                    narrativeBad: 'Offsets seen as greenwashing; criticism continues.'
                },
                {
                    label: 'Challenge the methodology',
                    description: 'Dispute the NGO\'s carbon calculations',
                    consequence: 'challenge_ngo',
                    narrativeGood: 'Independent review shows NGO overstated impact.',
                    narrativeBad: 'Public fight makes us look defensive; Streisand effect.'
                }
            ]
        },
        {
            id: 'ai_competitive_ethics',
            category: 'AI & Ethics',
            icon: '🏁',
            title: 'Competitor Cuts Ethical Corners',
            description: 'A competitor launched an AI product similar to {projectA} with none of our safety measures. They\'re faster and cheaper. Sales is asking why we "handicap ourselves with ethics."',
            requiresProjects: 1,
            choices: [
                {
                    label: 'Stay the course',
                    description: 'Our ethics are non-negotiable',
                    consequence: 'ethics_firm',
                    narrativeGood: 'Competitor\'s product causes incident; our ethics validated.',
                    narrativeBad: 'Competitor takes market share; ethics feels like luxury.'
                },
                {
                    label: 'Offer "lite" version',
                    description: 'Faster product with fewer safety checks for low-risk uses',
                    consequence: 'ethics_lite',
                    narrativeGood: 'Tiered approach captures both markets.',
                    narrativeBad: 'Lite version has incident; "SafetyTech isn\'t so safe" headlines.'
                },
                {
                    label: 'Advocate for regulation',
                    description: 'Push for rules that would constrain competitor too',
                    consequence: 'advocate_regulation',
                    narrativeGood: 'Regulation passes; level playing field restored.',
                    narrativeBad: 'Regulation slow; competitor entrenched by the time it passes.'
                }
            ]
        }
    ];
    
    // Track dilemma history
    function checkForManagementDilemma() {
        // R&D dilemmas are project-level decisions (frequent, 1-2 per quarter)
        // These always involve meaningful choices about your portfolio
        
        // Skip dilemmas for Q1 (focus on project selection), Q4 and Q5 (transitioning to Year 2)
        if (gameState.currentQuarter === 1 || gameState.currentQuarter >= 4) return null;
        
        // Need at least one active project
        if (gameState.activeProjects.length === 0) return null;
        
        // Don't repeat recent dilemmas
        const recentDilemmaIds = (gameState.dilemmaHistory || []).slice(-8).map(d => d.id);
        const availableDilemmas = managementDilemmas.filter(d => !recentDilemmaIds.includes(d.id));
        
        if (availableDilemmas.length === 0) return null;
        
        // Filter by project requirements
        const validDilemmas = availableDilemmas.filter(d => {
            if (d.requiresProjects === 2) return gameState.activeProjects.length >= 2;
            return gameState.activeProjects.length >= 1;
        });
        
        if (validDilemmas.length === 0) return null;
        
        // 90% chance of at least one dilemma per quarter
        const dilemmas = [];
        if (Math.random() < 0.90) {
            const shuffled = shuffleArray([...validDilemmas]);
            dilemmas.push(shuffled[0]);
            
            // 40% chance of a second dilemma (if enough projects and dilemmas)
            if (Math.random() < 0.40 && shuffled.length > 1 && gameState.activeProjects.length >= 2) {
                dilemmas.push(shuffled[1]);
            }
        }
        
        if (dilemmas.length === 0) return null;
        
        // Assign random projects to each dilemma
        return dilemmas.map(dilemma => {
            const shuffledProjects = shuffleArray([...gameState.activeProjects]);
            return {
                ...dilemma,
                projectA: shuffledProjects[0],
                projectB: shuffledProjects[1] || shuffledProjects[0]
            };
        });
    }
    
    function showManagementDilemma(dilemma, callback) {
        gameState.currentDilemma = dilemma;
        gameState.pendingDilemmaCallback = callback;
        
        // Replace placeholders with actual project names
        const replaceProjectNames = (text) => {
            return text
                .replace(/{projectA}/g, dilemma.projectA.name)
                .replace(/{projectB}/g, dilemma.projectB?.name || dilemma.projectA.name);
        };
        
        const modalHtml = `
            <div class="dilemma-modal-overlay" id="dilemma-modal">
                <div class="dilemma-modal">
                    <div class="dilemma-modal-header">
                        <div class="dilemma-icon">${dilemma.icon}</div>
                        <div class="dilemma-category">${dilemma.category}</div>
                        <h2 class="dilemma-title">${replaceProjectNames(dilemma.title)}</h2>
                    </div>
                    <div class="dilemma-modal-body">
                        <p class="dilemma-description">${replaceProjectNames(dilemma.description)}</p>
                        
                        <div class="dilemma-choices">
                            ${dilemma.choices.map((choice, index) => `
                                <button class="dilemma-choice" onclick="selectDilemmaChoice(${index})">
                                    <div class="choice-label">${replaceProjectNames(choice.label)}</div>
                                    <div class="choice-description">${replaceProjectNames(choice.description)}</div>
                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="dilemma-hint">
                            <span class="hint-icon">💭</span>
                            <span class="hint-text">There's no perfect answer here—trust your judgment.</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const container = document.createElement('div');
        container.id = 'dilemma-modal-container';
        container.innerHTML = modalHtml;
        document.body.appendChild(container);
    }
    
    function selectDilemmaChoice(choiceIndex) {
        const dilemma = gameState.currentDilemma;
        const choice = dilemma.choices[choiceIndex];
        
        // Play choice sound
        SoundManager.play('select');
        
        // Record the decision with full details for reporting
        if (!gameState.dilemmaHistory) gameState.dilemmaHistory = [];
        gameState.dilemmaHistory.push({
            id: dilemma.id,
            title: dilemma.title.replace(/{projectA}/g, dilemma.projectA.name).replace(/{projectB}/g, dilemma.projectB?.name || ''),
            category: dilemma.category,
            quarter: gameState.currentQuarter,
            choice: choiceIndex,
            choiceLabel: choice.label,
            choiceDescription: choice.description,
            projectA: dilemma.projectA.id,
            projectAName: dilemma.projectA.name,
            projectB: dilemma.projectB?.id,
            projectBName: dilemma.projectB?.name
        });
        
        // Apply consequences
        applyDilemmaConsequence(dilemma, choice);
        
        // Show outcome
        showDilemmaOutcome(dilemma, choice);
    }
    
    function applyDilemmaConsequence(dilemma, choice) {
        const projectA = gameState.activeProjects.find(p => p.id === dilemma.projectA.id);
        const projectB = dilemma.projectB ? gameState.activeProjects.find(p => p.id === dilemma.projectB.id) : null;
        
        switch (choice.consequence) {
            case 'projectA_boost':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.08);
                break;
            case 'projectB_boost':
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.10);
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                break;
            case 'both_slow':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.05);
                break;
            case 'budget_hit':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                break;
            case 'share_tech':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.12);
                break;
            case 'no_share':
                // No immediate effect, but narrative notes the missed opportunity
                break;
            case 'paid_share':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.08);
                break;
            case 'patent_delay':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'publish_fast':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'both_ip':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                break;
            case 'transfer_star':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.12);
                break;
            case 'deny_transfer':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'delayed_transfer':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.05);
                break;
            case 'mediate':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.05);
                break;
            case 'hr_intervention':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'reorg':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.03);
                break;
            case 'push_burnout':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'rest_week':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'contractor_relief':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'merge_projects':
                if (projectA && projectB) {
                    projectA.budget += projectB.budget * 0.5;
                    projectA.successProb = Math.min(0.95, (projectA.successProb + projectB.successProb) / 2 + 0.05);
                    projectB.status = 'merged';
                    gameState.activeProjects = gameState.activeProjects.filter(p => p.id !== projectB.id);
                    if (!gameState.mergedProjects) gameState.mergedProjects = [];
                    gameState.mergedProjects.push(projectB);
                }
                break;
            case 'internal_compete':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                if (projectB) projectB.successProb = Math.min(0.95, projectB.successProb + 0.03);
                break;
            case 'pick_winner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                if (projectB) {
                    projectB.status = 'killed';
                    gameState.activeProjects = gameState.activeProjects.filter(p => p.id !== projectB.id);
                    gameState.killedProjects.push({...projectB, killReason: 'Deprioritized in favor of ' + projectA.name});
                }
                break;
            case 'accept_partner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                if (projectB) projectB.successProb = Math.max(0.10, projectB.successProb - 0.08);
                break;
            case 'decline_partner':
                break;
            case 'limited_partner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'add_feature':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'hold_scope':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'custom_build':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                break;
            case 'shortcut':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'full_test':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'staged_release':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'accept_intel':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'decline_intel':
                break;
            case 'legal_consult':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'back_junior':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'back_seniors':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.02);
                break;
            case 'parallel_test':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'grant_data':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'deny_data':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'anonymize_data':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            
            // IP-specific consequences
            case 'buy_patent':
                gameState.budget = Math.max(0, gameState.budget - 1.2);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                break;
            case 'license_patent':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'design_around':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'rush_patent':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'miss_patent':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                break;
            case 'provisional_patent':
                gameState.budget = Math.max(0, gameState.budget - 0.1);
                break;
            case 'emergency_filings':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'assess_damage':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                break;
            case 'discipline_leaker':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                break;
            case 'full_international':
                gameState.budget = Math.max(0, gameState.budget - 0.8);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'europe_only':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'accept_gaps':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'sue_infringer':
                gameState.budget = Math.max(0, gameState.budget - 1.5);
                // High variance outcome
                if (Math.random() > 0.4) {
                    gameState.budget += 2.5; // Win damages
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'cease_desist':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'license_infringer':
                if (Math.random() > 0.4) {
                    gameState.budget += 0.5; // License revenue
                }
                break;
            case 'reinvest_winnings':
                gameState.budget += 2.0;
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                break;
            case 'patent_warchest':
                gameState.budget += 2.0;
                // Boost all projects slightly
                gameState.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.03);
                });
                break;
            case 'spread_winnings':
                gameState.budget += 2.0;
                break;
            case 'patent_process':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'trade_secret':
                // High risk of leak
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.12);
                }
                break;
            case 'hybrid_ip':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'argue_novelty':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'narrow_claims':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'withdraw_publish':
                // Defensive publication - no boost but no penalty
                break;
            
            // Open Innovation consequences
            case 'accept_supplier_coop':
                gameState.budget += 0.8; // Cost savings
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'negotiate_exclusivity':
                if (Math.random() > 0.5) {
                    gameState.budget += 0.6;
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                }
                break;
            case 'inhouse_development':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                break;
            case 'accept_customer_coop':
                gameState.budget += 1.5;
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'advisory_only':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'stay_independent':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                break;
            case 'full_university_partner':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                // Some IP risk
                if (Math.random() > 0.7) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'sponsored_research':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'hire_graduates':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'join_consortium':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                // Boost all projects slightly due to standards influence
                gameState.activeProjects.forEach(p => {
                    p.successProb = Math.min(0.95, p.successProb + 0.02);
                });
                break;
            case 'observer_status':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'proprietary_path':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'joint_fix':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'switch_supplier':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'manual_screening':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'absorb_extensions':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'allow_opensource':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'enforce_license':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'buyout_jv_ip':
                gameState.budget = Math.max(0, gameState.budget - 0.8);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'arbitration':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'cross_license':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'opensource_sdk':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                break;
            case 'source_available':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'keep_proprietary':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                break;
            case 'acquire_risky':
                gameState.budget = Math.max(0, gameState.budget - 2.0);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.15);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                    gameState.budget = Math.max(0, gameState.budget - 0.5); // Legal costs
                }
                break;
            case 'acquihire':
                gameState.budget = Math.max(0, gameState.budget - 1.0);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'walk_away_acquisition':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'data_exchange':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                break;
            case 'one_way_data':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'decline_data_sharing':
                break;
            case 'terminate_partner':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'orderly_winddown':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'continue_despite_pivot':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            
            // Corporate tension consequences
            case 'reposition_project':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'argue_exception':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'spinout_unit':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'embrace_cloud':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 2);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'hybrid_approach':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'pushback_cto':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.12);
                }
                break;
            case 'comply_erp':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                break;
            case 'request_exemption':
                if (Math.random() > 0.6) {
                    // Exemption granted
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'delegate_erp':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'embrace_okrs':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                }
                break;
            case 'minimal_okrs':
                if (Math.random() > 0.6) {
                    // No impact
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'feedback_okrs':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'cut_contractors':
                gameState.budget += 0.5;
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'freeze_growth':
                gameState.budget += 0.3;
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'consolidate_projects':
                if (dilemma.projectB && gameState.activeProjects.find(p => p.id === dilemma.projectB.id)) {
                    const projB = gameState.activeProjects.find(p => p.id === dilemma.projectB.id);
                    if (projectA && projB) {
                        projectA.budget += projB.budget * 0.4;
                        gameState.activeProjects = gameState.activeProjects.filter(p => p.id !== projB.id);
                        if (!gameState.mergedProjects) gameState.mergedProjects = [];
                        gameState.mergedProjects.push(projB);
                    }
                }
                break;
            case 'adapt_reorg':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'lobby_stay':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'negotiate_reorg':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'push_retention':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (Math.random() > 0.3) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'nonmonetary_retain':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'graceful_departure':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                break;
            case 'integrate_compliance':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'hire_compliance':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'batch_compliance':
                if (Math.random() > 0.6) {
                    // Efficient
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'present_optimistic':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'present_honest':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'postpone_presentation':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'embrace_safe':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'safe_theater':
                if (Math.random() > 0.6) {
                    // Get away with it
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'pilot_exemption':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                    // Boost other projects too as approach spreads
                    gameState.activeProjects.forEach(p => {
                        p.successProb = Math.min(0.95, p.successProb + 0.02);
                    });
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'embrace_openplan':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'negotiate_quiet':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'go_hybrid':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            
            // Startup collaboration consequences
            case 'partner_unproven':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.12);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'startup_poc':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'wait_startup':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'demand_stability':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'absorb_chaos':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'fork_startup':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'ip_audit':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                }
                break;
            case 'cleanroom_rewrite':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'indemnification':
                if (Math.random() > 0.7) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'startup_ultimatum':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'embed_engineer':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'parallel_backup':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'accelerate_integration':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'source_escrow':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                }
                break;
            case 'preemptive_replace':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                break;
            case 'extended_support':
                gameState.budget = Math.max(0, gameState.budget - 0.4);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'acquire_deprecated':
                gameState.budget = Math.max(0, gameState.budget - 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'rapid_replacement':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'prepay_startup':
                gameState.budget = Math.max(0, gameState.budget - 0.6);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    // Lost prepayment
                }
                break;
            case 'strategic_invest':
                gameState.budget = Math.max(0, gameState.budget - 0.8);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                    gameState.budget += 0.5; // Return on investment
                }
                break;
            case 'exit_startup':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            
            // AI & Ethics consequences
            case 'delay_retrain':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'launch_disclose':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.12);
                }
                break;
            case 'limit_scope':
                if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                break;
            case 'full_transparency':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'explain_layer':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'decline_transparency':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                }
                break;
            case 'proactive_comply':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                break;
            case 'wait_regulation':
                if (Math.random() > 0.5) {
                    // Regulations mild
                } else {
                    if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                    gameState.budget = Math.max(0, gameState.budget - 0.4);
                }
                break;
            case 'avoid_regulation':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.10);
                    gameState.budget = Math.max(0, gameState.budget - 0.3);
                }
                break;
            case 'retrain_consent':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 1);
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'retroactive_consent':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.25);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                }
                break;
            case 'accept_consent_risk':
                if (Math.random() > 0.7) {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                    gameState.budget = Math.max(0, gameState.budget - 0.8);
                }
                break;
            case 'human_review':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'ai_guardrails':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'ai_disclaimers':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'augmentation_message':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'transition_support':
                gameState.budget = Math.max(0, gameState.budget - 0.3);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'customer_choice':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'restrict_api':
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.03);
                break;
            case 'usage_monitoring':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                break;
            case 'publish_defense':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.03);
                }
                break;
            case 'efficient_models':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.05);
                }
                break;
            case 'carbon_offsets':
                gameState.budget = Math.max(0, gameState.budget - 0.2);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                }
                break;
            case 'challenge_ngo':
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.05);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'ethics_firm':
                if (Math.random() > 0.4) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.10);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.08);
                }
                break;
            case 'ethics_lite':
                if (Math.random() > 0.6) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                } else {
                    if (projectA) projectA.successProb = Math.max(0.10, projectA.successProb - 0.15);
                }
                break;
            case 'advocate_regulation':
                if (projectA) projectA.timeline = Math.min(12, (projectA.timeline || 8) + 0.5);
                if (Math.random() > 0.5) {
                    if (projectA) projectA.successProb = Math.min(0.95, projectA.successProb + 0.08);
                    // Boost all projects from level playing field
                    gameState.activeProjects.forEach(p => {
                        p.successProb = Math.min(0.95, p.successProb + 0.02);
                    });
                }
                break;
        }
    }
    
    function showDilemmaOutcome(dilemma, choice) {
        const isPositive = Math.random() > 0.4;
        const narrative = isPositive ? choice.narrativeGood : choice.narrativeBad;
        
        // Play outcome sound
        SoundManager.play(isPositive ? 'success' : 'warning');
        
        const replaceProjectNames = (text) => {
            return text
                .replace(/{projectA}/g, dilemma.projectA.name)
                .replace(/{projectB}/g, dilemma.projectB?.name || dilemma.projectA.name);
        };
        
        const outcomeHtml = `
            <div class="dilemma-outcome-overlay" id="dilemma-outcome">
                <div class="dilemma-outcome-modal">
                    <div class="outcome-header ${isPositive ? 'positive' : 'mixed'}">
                        <div class="outcome-icon">${isPositive ? '✅' : '⚠️'}</div>
                        <h3>Decision Made</h3>
                    </div>
                    <div class="outcome-body">
                        <p class="outcome-choice"><strong>You chose:</strong> ${replaceProjectNames(choice.label)}</p>
                        <p class="outcome-narrative">${replaceProjectNames(narrative)}</p>
                    </div>
                    <button class="outcome-continue-btn" onclick="closeDilemmaOutcome()">
                        Continue →
                    </button>
                </div>
            </div>
        `;
        
        const choiceContainer = document.getElementById('dilemma-modal-container');
        if (choiceContainer) choiceContainer.remove();
        
        const outcomeContainer = document.createElement('div');
        outcomeContainer.id = 'dilemma-outcome-container';
        outcomeContainer.innerHTML = outcomeHtml;
        document.body.appendChild(outcomeContainer);
    }
    
    function closeDilemmaOutcome() {
        const container = document.getElementById('dilemma-outcome-container');
        if (container) container.remove();
        
        if (gameState.pendingDilemmaCallback) {
            gameState.pendingDilemmaCallback();
            gameState.pendingDilemmaCallback = null;
        }
    }
    
    // ============================================
    // CORPORATE EVENT FUNCTIONS
    // ============================================
    
    function checkForCorporateEvent() {
        // Corporate events are company-wide news (less frequent, ~35% per quarter)
        // These are "acknowledge" style events that set context
        
        // Skip events for Q1 (focus on project selection) and Q4 (transitioning to Year 2)
        if (gameState.currentQuarter === 1 || gameState.currentQuarter >= 4) return null;
        
        if (Math.random() > 0.35) return null;
        
        // Don't repeat events that happened recently
        const recentEventIds = gameState.eventHistory.slice(-6).map(e => e.id);
        const availableEvents = corporateEvents.filter(e => !recentEventIds.includes(e.id));
        
        if (availableEvents.length === 0) return null;
        
        // Select one random event
        const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
        return [event]; // Return as array for consistency
    }
    
    function showCorporateEvent(event, callback) {
        gameState.currentEvent = event;
        gameState.pendingEventCallback = callback;
        
        // Update modal content
        const header = document.getElementById('event-modal-header');
        header.className = 'event-modal-header ' + event.tone;
        
        document.getElementById('event-icon').textContent = event.icon;
        document.getElementById('event-category').textContent = event.category;
        document.getElementById('event-title').textContent = event.title;
        document.getElementById('event-description').textContent = event.description;
        
        const effectText = document.getElementById('event-effect');
        effectText.textContent = event.effectText;
        effectText.className = 'event-effect-text ' + event.tone;
        
        // Duration text
        const durationEl = document.getElementById('event-duration');
        if (event.duration === 'instant') {
            durationEl.innerHTML = '<span class="event-duration-icon">⚡</span><span>Immediate effect</span>';
        } else if (event.duration === 'permanent') {
            durationEl.innerHTML = '<span class="event-duration-icon">♾️</span><span>Permanent effect</span>';
        } else {
            durationEl.innerHTML = `<span class="event-duration-icon">⏱️</span><span>Effect lasts ${event.duration}</span>`;
        }
        
        // Button style
        const btn = document.getElementById('event-acknowledge-btn');
        btn.className = 'event-acknowledge-btn ' + event.tone;
        
        // Show modal
        document.getElementById('corporate-event-modal').classList.remove('hidden');
    }
    
    function acknowledgeEvent() {
        const event = gameState.currentEvent;
        
        // Apply the event effect
        if (event && event.apply) {
            event.apply(gameState);
        }
        
        // Record in history
        gameState.eventHistory.push({
            id: event.id,
            title: event.title,
            quarter: gameState.currentQuarter,
            tone: event.tone
        });
        
        // Hide modal
        document.getElementById('corporate-event-modal').classList.add('hidden');
        gameState.currentEvent = null;
        
        // Execute callback (continue to quarterly review)
        if (gameState.pendingEventCallback) {
            gameState.pendingEventCallback();
            gameState.pendingEventCallback = null;
        }
    }
    
    function processActiveEffects() {
        // Decrement and remove expired effects
        gameState.activeEffects = gameState.activeEffects.filter(effect => {
            effect.remaining--;
            return effect.remaining > 0;
        });
        
        // Apply ongoing effect impacts
        gameState.activeEffects.forEach(effect => {
            if (effect.type === 'recession') {
                gameState.activeProjects.forEach(p => {
                    if (p.riskProfile === 'low' || p.archetype?.includes('value') || p.archetype?.includes('niche')) {
                        p.successProb = Math.max(0.2, p.successProb - 0.05);
                    }
                });
            }
            if (effect.type === 'amazon_competition') {
                gameState.activeProjects.forEach(p => {
                    if (p.archetype?.includes('value') || p.archetype?.includes('price_fighter')) {
                        p.successProb = Math.max(0.2, p.successProb - 0.05);
                    }
                });
            }
        });
    }
    
    function getActiveEffectsBadge() {
        if (gameState.activeEffects.length === 0) return '';
        
        const effect = gameState.activeEffects[0];
        let text = '';
        let tone = 'neutral';
        
        if (effect.type === 'roi_scrutiny') { text = '📊 ROI Scrutiny'; tone = 'neutral'; }
        if (effect.type === 'budget_freeze') { text = '❄️ Budget Frozen'; tone = 'negative'; }
        if (effect.type === 'recession') { text = '📉 Recession'; tone = 'negative'; }
        if (effect.type === 'amazon_competition') { text = '📦 Amazon Pressure'; tone = 'negative'; }
        if (effect.type === 'high_interest') { text = '🏦 High Interest'; tone = 'neutral'; }
        
        return `<span class="event-active-badge ${tone}">${text}</span>`;
    }
    
    // ============================================
    // PROJECT LEADS DATABASE
    // ============================================
    
    const projectLeads = [
        {
            id: 'vikram_shah',
            name: 'Vikram Shah',
            initials: 'VS',
            avatarColor: '#2563eb',
            role: 'Principal Engineer',
            team: 'Platform',
            yearsAtCompany: 7,
            background: 'IIT Bombay → Amazon (4 years) → ShieldTech. Built AWS IoT integrations at Amazon before joining to lead ShieldTech\'s connected device platform.',
            cv: [
                { year: '2017-now', role: 'Principal Engineer, ShieldTech', detail: 'Platform architecture lead' },
                { year: '2013-2017', role: 'SDE III, Amazon', detail: 'AWS IoT team, device shadows' },
                { year: '2013', role: 'B.Tech, IIT Bombay', detail: 'Computer Science' }
            ],
            pastProjects: [
                { name: 'ShieldOS 2.0', outcome: 'success', year: 2022, note: 'Delivered on time, 40% performance improvement' },
                { name: 'Matter Protocol Integration', outcome: 'success', year: 2023, note: 'First to market in India' },
                { name: 'Edge AI Module', outcome: 'partial', year: 2021, note: 'Shipped late, but strong adoption' }
            ],
            style: 'Methodical and thorough. Builds robust systems but can over-engineer. Excellent at platform thinking.',
            strengths: ['Platform architecture', 'Technical depth', 'Team mentorship'],
            weaknesses: ['Can over-engineer', 'Sometimes slow to ship'],
            trackRecord: { successes: 5, failures: 1, partial: 2 }
        },
        {
            id: 'priya_menon',
            name: 'Priya Menon',
            initials: 'PM',
            avatarColor: '#dc2626',
            role: 'Senior Product Manager',
            team: 'Consumer Products',
            yearsAtCompany: 4,
            background: 'NID Ahmedabad → Xiaomi India (3 years) → ShieldTech. Led Xiaomi\'s smart home products for India before bringing consumer expertise to ShieldTech.',
            cv: [
                { year: '2020-now', role: 'Senior PM, ShieldTech', detail: 'Consumer product line' },
                { year: '2017-2020', role: 'Product Manager, Xiaomi India', detail: 'Mi Home ecosystem' },
                { year: '2017', role: 'M.Des, NID Ahmedabad', detail: 'Product Design' }
            ],
            pastProjects: [
                { name: 'SmartCam Mini', outcome: 'success', year: 2021, note: 'Best-selling SKU, exceeded targets 2x' },
                { name: 'Family Safety App', outcome: 'success', year: 2022, note: '4.5 star rating, strong retention' },
                { name: 'Budget Sensor Pack', outcome: 'failure', year: 2023, note: 'Margin issues, quality complaints' }
            ],
            style: 'Customer-obsessed and moves fast. Great at finding product-market fit but sometimes cuts corners on quality.',
            strengths: ['Consumer insights', 'Speed to market', 'User experience'],
            weaknesses: ['Quality trade-offs', 'Impatient with process'],
            trackRecord: { successes: 6, failures: 2, partial: 1 }
        },
        {
            id: 'arjun_reddy',
            name: 'Arjun Reddy',
            initials: 'AR',
            avatarColor: '#059669',
            role: 'Engineering Manager',
            team: 'Hardware',
            yearsAtCompany: 5,
            background: 'BITS Pilani → Bosch (6 years) → ShieldTech. Deep hardware expertise from automotive sensors at Bosch. Known for bulletproof designs.',
            cv: [
                { year: '2019-now', role: 'Engineering Manager, ShieldTech', detail: 'Hardware team lead' },
                { year: '2013-2019', role: 'Senior Engineer, Bosch', detail: 'Automotive sensors' },
                { year: '2013', role: 'B.E., BITS Pilani', detail: 'Electronics' }
            ],
            pastProjects: [
                { name: 'WeatherProof Cam Pro', outcome: 'success', year: 2021, note: 'Zero field failures in 2 years' },
                { name: 'Industrial Sensor Suite', outcome: 'success', year: 2022, note: 'Won enterprise accounts' },
                { name: 'Solar Power Kit', outcome: 'partial', year: 2023, note: 'Good product, slow sales' }
            ],
            style: 'Quality-obsessed engineer. Products ship late but never fail. Can be inflexible on timelines.',
            strengths: ['Hardware reliability', 'Quality focus', 'Technical rigour'],
            weaknesses: ['Slow to ship', 'Resistant to trade-offs'],
            trackRecord: { successes: 7, failures: 0, partial: 2 }
        },
        {
            id: 'sneha_iyer',
            name: 'Sneha Iyer',
            initials: 'SI',
            avatarColor: '#7c3aed',
            role: 'Senior Data Scientist',
            team: 'AI/ML',
            yearsAtCompany: 3,
            background: 'IISc Bangalore → Google Research (2 years) → ShieldTech. PhD in computer vision. Published researcher who brings cutting-edge AI to products.',
            cv: [
                { year: '2021-now', role: 'Senior Data Scientist, ShieldTech', detail: 'AI/ML products' },
                { year: '2019-2021', role: 'Research Scientist, Google', detail: 'Computer vision' },
                { year: '2019', role: 'PhD, IISc Bangalore', detail: 'Computer Vision & ML' }
            ],
            pastProjects: [
                { name: 'Person Detection v2', outcome: 'success', year: 2022, note: '95% accuracy, industry-leading' },
                { name: 'Anomaly Detection Engine', outcome: 'partial', year: 2023, note: 'Great tech, hard to productize' },
                { name: 'Voice Recognition Module', outcome: 'failure', year: 2022, note: 'Accuracy issues in noisy environments' }
            ],
            style: 'Brilliant researcher but still learning product development. Needs strong PM partnership to ship.',
            strengths: ['AI/ML expertise', 'Research depth', 'Innovation'],
            weaknesses: ['Product sense developing', 'Can be too academic'],
            trackRecord: { successes: 3, failures: 1, partial: 2 }
        },
        {
            id: 'rahul_kumar',
            name: 'Rahul Kumar',
            initials: 'RK',
            avatarColor: '#ea580c',
            role: 'Product Manager',
            team: 'Enterprise',
            yearsAtCompany: 6,
            background: 'Delhi University → Infosys (3 years) → ShieldTech. Started as engineer, moved to product. Deep understanding of enterprise customer needs.',
            cv: [
                { year: '2018-now', role: 'Product Manager, ShieldTech', detail: 'Enterprise solutions' },
                { year: '2015-2018', role: 'Software Engineer, Infosys', detail: 'Enterprise projects' },
                { year: '2015', role: 'B.Tech, Delhi University', detail: 'Information Technology' }
            ],
            pastProjects: [
                { name: 'Enterprise Dashboard', outcome: 'success', year: 2020, note: 'Landed 3 Fortune 500 accounts' },
                { name: 'Multi-site Management', outcome: 'success', year: 2021, note: 'Key differentiator vs competition' },
                { name: 'API Platform', outcome: 'success', year: 2022, note: 'Enabled partner ecosystem' },
                { name: 'Compliance Module', outcome: 'partial', year: 2023, note: 'Delayed but delivered value' }
            ],
            style: 'Steady and reliable. Not flashy but consistently delivers. Strong enterprise relationships.',
            strengths: ['Enterprise sales', 'Customer relationships', 'Reliability'],
            weaknesses: ['Not innovative', 'Risk-averse'],
            trackRecord: { successes: 8, failures: 0, partial: 2 }
        },
        {
            id: 'ananya_das',
            name: 'Ananya Das',
            initials: 'AD',
            avatarColor: '#0891b2',
            role: 'Technical Lead',
            team: 'Mobile',
            yearsAtCompany: 4,
            background: 'Jadavpur University → Flipkart (4 years) → ShieldTech. Mobile engineering expert who scaled Flipkart\'s app to 100M+ users.',
            cv: [
                { year: '2020-now', role: 'Technical Lead, ShieldTech', detail: 'Mobile apps' },
                { year: '2016-2020', role: 'Senior Engineer, Flipkart', detail: 'Mobile platform' },
                { year: '2016', role: 'B.Tech, Jadavpur University', detail: 'Computer Science' }
            ],
            pastProjects: [
                { name: 'ShieldTech App 3.0', outcome: 'success', year: 2021, note: '4.6 star rating, 2M downloads' },
                { name: 'Real-time Alerts', outcome: 'success', year: 2022, note: '<100ms latency achieved' },
                { name: 'Widget System', outcome: 'failure', year: 2023, note: 'Low adoption, removed' }
            ],
            style: 'Strong mobile expertise. Can over-focus on technical elegance vs user needs.',
            strengths: ['Mobile development', 'Performance optimization', 'Code quality'],
            weaknesses: ['User research gaps', 'Feature creep'],
            trackRecord: { successes: 5, failures: 1, partial: 1 }
        },
        {
            id: 'karthik_nair',
            name: 'Karthik Nair',
            initials: 'KN',
            avatarColor: '#be123c',
            role: 'Program Manager',
            team: 'New Initiatives',
            yearsAtCompany: 2,
            background: 'IIM Kozhikode → McKinsey (5 years) → ShieldTech. Strategy consultant turned operator. Great at stakeholder management and big bets.',
            cv: [
                { year: '2022-now', role: 'Program Manager, ShieldTech', detail: 'Strategic initiatives' },
                { year: '2017-2022', role: 'Engagement Manager, McKinsey', detail: 'Tech & telecom practice' },
                { year: '2017', role: 'MBA, IIM Kozhikode', detail: 'Strategy' }
            ],
            pastProjects: [
                { name: 'Jio Partnership', outcome: 'partial', year: 2023, note: 'Deal structure good, execution ongoing' },
                { name: 'International Expansion Study', outcome: 'success', year: 2022, note: 'Informed SEA strategy' }
            ],
            style: 'Strategic thinker who can navigate complex stakeholders. Less hands-on with execution details.',
            strengths: ['Strategy', 'Stakeholder management', 'Big picture'],
            weaknesses: ['Execution details', 'Technical depth'],
            trackRecord: { successes: 2, failures: 0, partial: 1 }
        },
        {
            id: 'deepa_sharma',
            name: 'Deepa Sharma',
            initials: 'DS',
            avatarColor: '#4f46e5',
            role: 'Engineering Manager',
            team: 'Cloud Infrastructure',
            yearsAtCompany: 5,
            background: 'NIT Trichy → Microsoft (4 years) → ShieldTech. Azure expertise. Built ShieldTech\'s entire cloud backend from scratch.',
            cv: [
                { year: '2019-now', role: 'Engineering Manager, ShieldTech', detail: 'Cloud & backend' },
                { year: '2015-2019', role: 'Software Engineer, Microsoft', detail: 'Azure services' },
                { year: '2015', role: 'B.Tech, NIT Trichy', detail: 'Computer Science' }
            ],
            pastProjects: [
                { name: 'Cloud Migration Phase 1', outcome: 'success', year: 2020, note: '60% cost reduction' },
                { name: 'Real-time Event Pipeline', outcome: 'success', year: 2021, note: '10x throughput improvement' },
                { name: 'Multi-region Deployment', outcome: 'partial', year: 2022, note: 'Delayed but critical for scale' },
                { name: 'Serverless Rewrite', outcome: 'failure', year: 2023, note: 'Abandoned due to complexity' }
            ],
            style: 'Infrastructure expert. Excellent at scale challenges but can get lost in technical details.',
            strengths: ['Cloud architecture', 'Scale & reliability', 'Cost optimization'],
            weaknesses: ['Product thinking', 'Can over-engineer'],
            trackRecord: { successes: 5, failures: 1, partial: 2 }
        },
        {
            id: 'mohammed_ali',
            name: 'Mohammed Ali',
            initials: 'MA',
            avatarColor: '#65a30d',
            role: 'Senior Product Manager',
            team: 'Partnerships',
            yearsAtCompany: 3,
            background: 'XLRI → Vodafone (5 years) → ShieldTech. Telecom partnerships expert. Built Vodafone\'s IoT partner program before joining.',
            cv: [
                { year: '2021-now', role: 'Senior PM, ShieldTech', detail: 'Partner products' },
                { year: '2016-2021', role: 'Partner Manager, Vodafone', detail: 'IoT ecosystem' },
                { year: '2016', role: 'MBA, XLRI', detail: 'Marketing' }
            ],
            pastProjects: [
                { name: 'Builder Integration Program', outcome: 'success', year: 2022, note: '50+ builder partnerships' },
                { name: 'Insurance Bundle', outcome: 'success', year: 2023, note: 'New revenue stream' },
                { name: 'Retail Channel Expansion', outcome: 'failure', year: 2022, note: 'Economics didn\'t work' }
            ],
            style: 'Relationship builder who finds creative partnership structures. Can over-promise to partners.',
            strengths: ['Partnership development', 'Business development', 'Creative deal structures'],
            weaknesses: ['Over-promising', 'Internal alignment'],
            trackRecord: { successes: 4, failures: 1, partial: 1 }
        },
        {
            id: 'lakshmi_venkat',
            name: 'Lakshmi Venkataraman',
            initials: 'LV',
            avatarColor: '#0d9488',
            role: 'Principal Engineer',
            team: 'Security',
            yearsAtCompany: 6,
            background: 'IIIT Hyderabad → Symantec (5 years) → ShieldTech. Cybersecurity expert who ensures ShieldTech products are secure by design.',
            cv: [
                { year: '2018-now', role: 'Principal Engineer, ShieldTech', detail: 'Security architecture' },
                { year: '2013-2018', role: 'Security Engineer, Symantec', detail: 'Endpoint protection' },
                { year: '2013', role: 'M.Tech, IIIT Hyderabad', detail: 'Information Security' }
            ],
            pastProjects: [
                { name: 'End-to-end Encryption', outcome: 'success', year: 2020, note: 'Industry-first for smart home' },
                { name: 'Security Audit Framework', outcome: 'success', year: 2021, note: 'Passed enterprise audits' },
                { name: 'Zero-Trust Architecture', outcome: 'success', year: 2022, note: 'Key enterprise differentiator' },
                { name: 'Biometric Vault', outcome: 'partial', year: 2023, note: 'Secure but UX challenges' }
            ],
            style: 'Security-first mindset. Sometimes slows things down but catches critical issues. Non-negotiable on security.',
            strengths: ['Security expertise', 'Risk assessment', 'Compliance'],
            weaknesses: ['Can slow velocity', 'Perfectionist'],
            trackRecord: { successes: 7, failures: 0, partial: 1 }
        },
        {
            id: 'sanjay_gupta',
            name: 'Sanjay Gupta',
            initials: 'SG',
            avatarColor: '#9333ea',
            role: 'Technical Lead',
            team: 'Firmware',
            yearsAtCompany: 8,
            background: 'VIT Vellore → Samsung R&D (3 years) → ShieldTech (founding engineer). One of the first engineers. Deep institutional knowledge.',
            cv: [
                { year: '2016-now', role: 'Technical Lead, ShieldTech', detail: 'Firmware & embedded' },
                { year: '2013-2016', role: 'Firmware Engineer, Samsung R&D', detail: 'IoT devices' },
                { year: '2013', role: 'B.Tech, VIT Vellore', detail: 'Electronics' }
            ],
            pastProjects: [
                { name: 'Original ShieldOS', outcome: 'success', year: 2017, note: 'Foundation of all products' },
                { name: 'OTA Update System', outcome: 'success', year: 2019, note: '99.9% success rate' },
                { name: 'Power Optimization', outcome: 'success', year: 2020, note: '2x battery life improvement' },
                { name: 'New Chip Migration', outcome: 'partial', year: 2022, note: 'Delayed but necessary' },
                { name: 'Legacy Protocol Support', outcome: 'failure', year: 2023, note: 'Abandoned, too complex' }
            ],
            style: 'Institutional knowledge but can be set in his ways. Protective of legacy code. Reliable for core work.',
            strengths: ['Firmware expertise', 'Institutional knowledge', 'Reliability'],
            weaknesses: ['Resistant to change', 'Protective of legacy'],
            trackRecord: { successes: 9, failures: 1, partial: 2 }
        },
        {
            id: 'neha_kapoor',
            name: 'Neha Kapoor',
            initials: 'NK',
            avatarColor: '#db2777',
            role: 'Product Manager',
            team: 'Growth',
            yearsAtCompany: 2,
            background: 'ISB Hyderabad → Swiggy (3 years) → ShieldTech. Growth hacking expert who scaled Swiggy\'s user acquisition.',
            cv: [
                { year: '2022-now', role: 'Product Manager, ShieldTech', detail: 'Growth & activation' },
                { year: '2019-2022', role: 'Growth PM, Swiggy', detail: 'User acquisition' },
                { year: '2019', role: 'MBA, ISB Hyderabad', detail: 'General Management' }
            ],
            pastProjects: [
                { name: 'Referral Program 2.0', outcome: 'success', year: 2022, note: '30% of new users from referrals' },
                { name: 'Onboarding Redesign', outcome: 'success', year: 2023, note: '50% activation improvement' },
                { name: 'Gamification Features', outcome: 'failure', year: 2023, note: 'Low engagement, removed' }
            ],
            style: 'Data-driven and moves fast. Great at experimentation but can prioritize metrics over experience.',
            strengths: ['Growth hacking', 'Data analysis', 'Experimentation'],
            weaknesses: ['Short-term focus', 'Metric gaming'],
            trackRecord: { successes: 4, failures: 1, partial: 0 }
        }
    ];
    
    // Function to get a random project lead
    function getRandomProjectLead() {
        return projectLeads[Math.floor(Math.random() * projectLeads.length)];
    }
    
    // Function to get lead by ID
    function getProjectLead(leadId) {
        return projectLeads.find(l => l.id === leadId) || getRandomProjectLead();
    }
    
    // Function to calculate lead track record score (0-1)
    function getLeadTrackScore(lead) {
        const total = lead.trackRecord.successes + lead.trackRecord.failures + lead.trackRecord.partial;
        if (total === 0) return 0.5;
        const score = (lead.trackRecord.successes + lead.trackRecord.partial * 0.5) / total;
        return score;
    }
    
    // Generate a 100-150 word rapid summary for quick screening
    function generateRapidSummary(project) {
        const parts = [];
        
        // Core description (use desc which is more concise than fullDesc)
        parts.push(project.desc || project.fullDesc || 'No description available.');
        
        // Market context snippet
        if (project.marketContext) {
            const marketSnippet = project.marketContext.split('.').slice(0, 2).join('.') + '.';
            parts.push(marketSnippet);
        }
        
        // Key metrics in prose
        const metrics = [];
        if (project.trl) {
            metrics.push(`Technology moves from TRL ${project.trl.current} to ${project.trl.target}`);
        }
        if (project.milestones?.totalDuration) {
            metrics.push(`${project.milestones.totalDuration} timeline`);
        }
        if (project.financials?.projectedRevenue) {
            metrics.push(`projected ${project.financials.projectedRevenue} revenue`);
        }
        if (project.financials?.grossMargin) {
            metrics.push(`${project.financials.grossMargin} gross margin`);
        }
        if (metrics.length > 0) {
            parts.push(metrics.join(', ') + '.');
        }
        
        // IP/Risk note
        if (project.ipPosition?.risk) {
            const riskNote = project.ipPosition.risk === 'Low' ? 'Clear IP pathway with low risk.' :
                           project.ipPosition.risk === 'High' ? 'Significant IP risks require careful navigation.' :
                           'Moderate IP considerations to address.';
            parts.push(riskNote);
        }
        
        return parts.join(' ');
    }
    
    // Assign a project lead based on archetype and project characteristics
    function assignProjectLead(archetype, scores) {
        // Map archetypes to preferred lead teams/skills
        const archetypeLeadPreferences = {
            'core_upgrade': ['vikram_shah', 'arjun_reddy', 'sanjay_gupta'],
            'value_segment': ['priya_menon', 'neha_kapoor', 'mohammed_ali'],
            'frontier_tech': ['sneha_iyer', 'vikram_shah', 'lakshmi_venkat'],
            'premium_flagship': ['arjun_reddy', 'priya_menon', 'vikram_shah'],
            'niche_vertical': ['rahul_kumar', 'mohammed_ali', 'priya_menon'],
            'underserved_market': ['priya_menon', 'neha_kapoor', 'mohammed_ali'],
            'platform_infrastructure': ['vikram_shah', 'deepa_sharma', 'sanjay_gupta'],
            'market_explorer': ['karthik_nair', 'mohammed_ali', 'neha_kapoor'],
            'price_fighter': ['arjun_reddy', 'priya_menon', 'sanjay_gupta'],
            'esg_initiative': ['karthik_nair', 'rahul_kumar', 'priya_menon'],
            'proprietary_tech': ['lakshmi_venkat', 'sneha_iyer', 'vikram_shah'],
            'ai_guard': ['sneha_iyer', 'vikram_shah', 'ananya_das'],
            'camera_health': ['deepa_sharma', 'vikram_shah', 'rahul_kumar'],
            'smart_access': ['vikram_shah', 'arjun_reddy', 'lakshmi_venkat'],
            'services_platform': ['deepa_sharma', 'rahul_kumar', 'vikram_shah'],
            'autonomous_drone': ['sneha_iyer', 'arjun_reddy', 'karthik_nair'],
            'ground_robot': ['arjun_reddy', 'sneha_iyer', 'vikram_shah'],
            'vehicle_intelligence': ['sneha_iyer', 'arjun_reddy', 'vikram_shah'],
            'privacy_compliance': ['lakshmi_venkat', 'rahul_kumar', 'deepa_sharma'],
            'acoustic_detection': ['sneha_iyer', 'arjun_reddy', 'lakshmi_venkat'],
            'rtls_tracking': ['vikram_shah', 'arjun_reddy', 'rahul_kumar'],
            'digital_twin': ['sneha_iyer', 'vikram_shah', 'deepa_sharma'],
            'cyber_physical_soc': ['lakshmi_venkat', 'deepa_sharma', 'rahul_kumar'],
            'deepfake_defense': ['sneha_iyer', 'lakshmi_venkat', 'vikram_shah'],
            'predictive_risk': ['sneha_iyer', 'rahul_kumar', 'deepa_sharma'],
            'compliance_automation': ['rahul_kumar', 'lakshmi_venkat', 'deepa_sharma'],
            'perimeter_fusion': ['arjun_reddy', 'vikram_shah', 'sneha_iyer'],
            'evidence_chain': ['lakshmi_venkat', 'deepa_sharma', 'rahul_kumar'],
            'panic_wearable': ['arjun_reddy', 'priya_menon', 'ananya_das'],
            'edge_micro_nvr': ['arjun_reddy', 'sanjay_gupta', 'vikram_shah'],
            'rapid_deploy': ['arjun_reddy', 'mohammed_ali', 'sanjay_gupta'],
            // Year 1 End project archetypes
            'quick_win': ['arjun_reddy', 'sanjay_gupta', 'priya_menon'],
            'market_response': ['priya_menon', 'neha_kapoor', 'arjun_reddy'],
            'capability_build': ['vikram_shah', 'deepa_sharma', 'sneha_iyer'],
            'partnership_opportunity': ['karthik_nair', 'rahul_kumar', 'mohammed_ali'],
            'tech_adjacency': ['sneha_iyer', 'lakshmi_venkat', 'deepa_sharma'],
            // Base archetypes for Year 1 End (mapped versions)
            'conventional_winner': ['arjun_reddy', 'vikram_shah', 'priya_menon'],
            'conventional_loser': ['sneha_iyer', 'lakshmi_venkat', 'deepa_sharma'],
            'hidden_gem': ['priya_menon', 'mohammed_ali', 'neha_kapoor'],
            'slow_burner': ['vikram_shah', 'deepa_sharma', 'rahul_kumar'],
            'paper_tiger': ['arjun_reddy', 'sneha_iyer', 'vikram_shah'],
            'money_pit': ['sanjay_gupta', 'vikram_shah', 'deepa_sharma'],
            'pivot_success': ['karthik_nair', 'mohammed_ali', 'rahul_kumar'],
            'team_dependent': ['ananya_das', 'vikram_shah', 'sneha_iyer'],
            'competitive_casualty': ['priya_menon', 'arjun_reddy', 'sanjay_gupta'],
            'sustainability_play': ['karthik_nair', 'rahul_kumar', 'neha_kapoor'],
            'ip_fortress': ['lakshmi_venkat', 'sneha_iyer', 'vikram_shah']
        };
        
        // Get preferred leads for this archetype, or use random if not mapped
        let preferredLeads = archetypeLeadPreferences[archetype];
        if (!preferredLeads || preferredLeads.length === 0) {
            // Fallback: pick based on scores
            if (scores.technical >= 4) preferredLeads = ['vikram_shah', 'sneha_iyer', 'arjun_reddy'];
            else if (scores.marketsize >= 4) preferredLeads = ['priya_menon', 'neha_kapoor', 'mohammed_ali'];
            else preferredLeads = projectLeads.map(l => l.id);
        }
        
        // Pick a random lead from the preferred list
        const selectedLeadId = preferredLeads[Math.floor(Math.random() * preferredLeads.length)];
        return projectLeads.find(l => l.id === selectedLeadId) || getRandomProjectLead();
    }
    
    // Function to render lead mini-CV for modals
    // Render minimal lead link (clickable to open full CV modal)
    function renderLeadCard(lead, showDetails = false) {
        if (!lead) return '<p style="color: var(--gray-500);">No lead assigned.</p>';
        
        const trackScore = getLeadTrackScore(lead);
        const trackClass = trackScore >= 0.7 ? 'success' : trackScore >= 0.5 ? 'warning' : 'danger';
        
        // Minimal clickable link - opens full CV in modal
        return `
            <div class="lead-link" onclick="openLeadModal('${lead.id}')" title="Click to view full CV">
                <span class="lead-link-avatar" style="background: ${lead.avatarColor}20; color: ${lead.avatarColor};">${lead.initials}</span>
                <span class="lead-link-name">${lead.name}</span>
                <span class="lead-link-badge ${trackClass}">${Math.round(trackScore * 100)}%</span>
                <span class="lead-link-cta">View CV →</span>
            </div>
        `;
    }
    
    // Open lead CV modal
    function openLeadModal(leadId) {
        const lead = projectLeads.find(l => l.id === leadId);
        if (!lead) return;
        
        const trackScore = getLeadTrackScore(lead);
        const trackClass = trackScore >= 0.7 ? 'success' : trackScore >= 0.5 ? 'warning' : 'danger';
        
        // Populate header
        document.getElementById('lead-modal-avatar').textContent = lead.initials;
        document.getElementById('lead-modal-avatar').style.background = lead.avatarColor + '40';
        document.getElementById('lead-modal-avatar').style.color = 'white';
        document.getElementById('lead-modal-name').textContent = lead.name;
        document.getElementById('lead-modal-role').textContent = `${lead.role} · ${lead.team} · ${lead.yearsAtCompany} years at ShieldTech`;
        
        const scoreEl = document.getElementById('lead-modal-score');
        scoreEl.innerHTML = `
            <div class="score-value">${Math.round(trackScore * 100)}%</div>
            <div class="score-label">Track Record</div>
        `;
        
        // Populate body
        document.getElementById('lead-modal-body').innerHTML = `
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">📚 Background</div>
                <p style="color: var(--gray-700); line-height: 1.6; margin: 0;">${lead.background}</p>
            </div>
            
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">💼 Career History</div>
                <div class="cv-timeline">
                    ${lead.cv.map(item => `
                        <div class="cv-item">
                            <span class="cv-year">${item.year}</span>
                            <span class="cv-role">${item.role}</span>
                            <span class="cv-detail">${item.detail}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">🏆 Past Projects at ShieldTech</div>
                <div class="past-projects-list">
                    ${lead.pastProjects.map(p => `
                        <div class="past-project ${p.outcome}">
                            <span class="past-project-icon">${p.outcome === 'success' ? '✓' : p.outcome === 'failure' ? '✗' : '◐'}</span>
                            <span class="past-project-name">${p.name}</span>
                            <span class="past-project-year">${p.year}</span>
                            <span class="past-project-note">${p.note}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="lead-modal-section">
                <div class="lead-modal-section-title">💬 Working Style</div>
                <p style="color: var(--gray-700); font-style: italic; margin: 0 0 15px; line-height: 1.6;">"${lead.style}"</p>
                <div class="lead-traits">
                    <div class="traits-column strengths">
                        <div class="traits-label">Strengths</div>
                        ${lead.strengths.map(s => `<span class="trait">✓ ${s}</span>`).join('')}
                    </div>
                    <div class="traits-column weaknesses">
                        <div class="traits-label">Watch For</div>
                        ${lead.weaknesses.map(w => `<span class="trait">⚠ ${w}</span>`).join('')}
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-200); font-size: 0.8em; color: var(--gray-400); font-style: italic;">
                Note: Past performance is informative but not a guarantee of future results. Project success depends on many factors beyond the lead.
            </div>
        `;
        
        // Show modal
        document.getElementById('lead-cv-modal').classList.remove('hidden');
    }
    
    // Close lead CV modal
    function closeLeadModal() {
        document.getElementById('lead-cv-modal').classList.add('hidden');
    }
    
    // Open credits modal
    function openCreditsModal() {
        document.getElementById('credits-modal').classList.remove('hidden');
    }
    
    // Close credits modal
    function closeCreditsModal() {
        document.getElementById('credits-modal').classList.add('hidden');
        MobileScrollLock.unlock();
    }
    
    // Show tutorial modal
    function showTutorialModal() {
        document.getElementById('tutorial-modal').classList.remove('hidden');
    }
    
    // Close tutorial modal
    function closeTutorialModal() {
        document.getElementById('tutorial-modal').classList.add('hidden');
        MobileScrollLock.unlock();
    }
    
    const projectTemplates = [
        { 
            archetype: 'core_upgrade', 
            names: ['SmartLock Pro', 'HomeGuard Elite', 'SecureCam HD', 'SensorNet Plus'], 
            descs: [
                'Smart door lock that opens with your fingerprint (stores 100 different prints), face recognition, or PIN code. Works with the ShieldTech app. Automatically locks behind you, alerts you if someone tampers with it, and lets you create temporary codes for guests. Designed to fit standard Indian doors without major modifications.',
                'Central home security hub with a 7-inch touchscreen that connects up to 32 sensors and 8 cameras. Features a loud alarm, 8-hour battery backup if power goes out, and automatic mobile network backup if WiFi fails. Comes with easy scheduling to arm/disarm your system.',
                'Ultra-sharp 4K security camera with extra-wide viewing angle, full-colour night vision up to 10 meters, and smart detection that tells apart people, pets, and vehicles. Includes two-way talk feature with clear audio. Fully weatherproof and works in temperatures from -10°C to 50°C.',
                'Set of 6 wireless motion sensors covering up to 12 meters each. Smart enough to ignore pets up to 25kg to reduce false alarms. 2-year battery life, instant phone alerts, and works seamlessly with your other ShieldTech cameras.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 3, platform: 4, sustainability: 3, newmarket: 2, geographic: 3, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Prototype meeting specifications.', 'Customer testing feedback positive.'], bad: ['Component sourcing delays emerging.', 'Competitor launched similar feature.'] }, 
            outcomeNarrative: { success: 'Solid product-market fit. Met sales targets.', failure: 'Market more competitive than expected. Required repositioning.' } 
        },
        { 
            archetype: 'value_segment', 
            names: ['BudgetSafe', 'ValueLock Basic', 'EconoSensor', 'SmartStart Kit'], 
            descs: [
                'Affordable motion sensor with 8-meter range, built-in 90dB alarm, and phone alerts over WiFi. Simple stick-on installation with batteries lasting 1 year. Priced at $12 to compete with generic imports.',
                'Simple keypad smart lock with 4-digit PIN access and auto-lock timer. No apps or fingerprint features—designed for simplicity. Fits common door locks found in tier-2/3 cities. Target price: $30.',
                'Pack of 3 door and window sensors that detect when they open. Battery-powered (18 months), connects to ShieldTech app. Includes shop entry-chime mode. Designed for $7/pack price point.',
                'Complete starter kit: 1 hub, 2 door sensors, 1 motion sensor, 1 alarm. Pre-connected out-of-box setup taking under 10 minutes. Perfect for first-time security buyers at $50 all-in.'
            ], 
            budgetRange: [3, 4], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 3, newmarket: 3, geographic: 5, competitive: 2, devcost: 5, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Cost targets on track.', 'Distribution discussions progressing.'], bad: ['Margin pressure from component costs.', 'Quality concerns at price point.'] }, 
            outcomeNarrative: { success: 'Strong volume in tier-2/3 cities.', failure: 'Margin erosion required product redesign.' } 
        },
        { 
            archetype: 'frontier_tech', 
            names: ['HoloSecurity', 'QuantumLock', 'NeuroCam', 'BioField Detector'], 
            descs: [
                'Experimental security system that projects realistic holograms of security guards using advanced laser display technology. Triggered by motion sensors to make intruders think someone is home. Uses cutting-edge components still in development.',
                'Ultra-secure door lock using next-generation quantum encryption technology that is theoretically impossible to hack. Requires specialized sensors and cooling systems. Developed in partnership with IISc research institute.',
                'Camera with a brain-inspired vision chip that processes motion at extremely high speeds with very low power. Uses advanced light sensors for excellent low-light performance. Requires advanced manufacturing not currently available in India.',
                'Security system that detects human presence through walls by sensing subtle changes in electromagnetic fields. Based on emerging research in biosensing. Needs specialized equipment to work in typical Indian electrical environments.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 3, marketsize: 3, strategic: 4, team: 3, capability: 3, ip: 5, platform: 3, sustainability: 3, newmarket: 5, geographic: 2, competitive: 5, devcost: 2, roi: 3, speed: 2, risk: 2 }, 
            quarterNarratives: { good: ['Research milestone achieved.', 'Academic partner producing results.', 'Patent application filed.'], bad: ['Technical complexity requiring more time.', 'Prototype performance below targets.'] }, 
            outcomeNarrative: { success: 'Breakthrough technology created new category.', failure: 'Technology validated but commercialization delayed. IP retained for future.' } 
        },
        { 
            archetype: 'premium_flagship', 
            names: ['UltraVision 360', 'TotalHome Command', 'SmartFortress', 'OmniSense Pro'], 
            descs: [
                'Top-of-the-line 8K camera with true 360° coverage using 4 sensors, smart auto-tracking that follows subjects, and night vision up to 50 meters. Built-in smart processing identifies threats in real-time. Targets premium buyers at $420.',
                'Complete smart home platform connecting security with lighting (Philips Hue, Syska), air conditioning (Daikin, Voltas), entertainment (Fire TV, Chromecast), and appliances. Voice control through Alexa/Google. Plans for 50+ device categories.',
                'Military-grade security system with reinforced, impact-resistant hardware, encrypted wireless networking, anti-jamming technology, and tamper-proof sensors. Modular design for wealthy residences and farmhouses.',
                'Advanced sensing platform combining motion, microwave, ultrasonic, and heat detection for virtually zero false alarms. Requires custom setup for each location to work optimally.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 4, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 3, newmarket: 3, geographic: 3, competitive: 4, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Demo generated strong interest.', 'Premium positioning resonating.', 'Key technical milestone achieved.'], bad: ['Integration complexity higher than estimated.', 'Target market smaller than projected.'] }, 
            outcomeNarrative: { success: 'Premium flagship established technology leadership.', failure: 'Scope reduced to focus on core differentiators.' } 
        },
        { 
            archetype: 'niche_vertical', 
            names: ['ElderCare Alert', 'PetWatch Home', 'KidSafe Zone', 'GardenGuard'], 
            descs: [
                'Wearable pendant with fall detection, emergency button, and two-way voice. Base station learns daily patterns and detects unusual inactivity. Automatically alerts up to 5 family contacts with location. Large buttons, loud speaker, no smartphone needed for wearer.',
                'Security camera with pet-aware smart detection that tells dogs and cats apart from intruders (trained on 50,000 pet images). Includes treat dispenser (100g capacity), two-way audio for pet interaction, and activity tracking. Reduces false alarms for pet owners by 94%.',
                'Child safety system with wearable GPS watch, boundary alerts, and school zone monitoring. Panic button triggers recording and family alert. Safe route tracking for school commute. Tamper-resistant band design for ages 5-12.',
                'Weatherproof outdoor security for gardens and compounds. Solar-powered cameras with mobile network connectivity (no WiFi needed), motion-activated floodlights, and smart detection that ignores wildlife. Designed for farmhouses and weekend homes.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 2, strategic: 2, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 5, newmarket: 5, geographic: 3, competitive: 4, devcost: 4, roi: 3, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Customer interviews revealing strong need.', 'Word spreading in target community.'], bad: ['Market size validation ongoing.', 'Channel strategy needs refinement.'] }, 
            outcomeNarrative: { success: 'Found passionate niche with strong loyalty.', failure: 'Niche smaller than projected. Integrated features into main product line.' } 
        },
        { 
            archetype: 'underserved_market', 
            names: ['RuralSecure', 'OffGrid Guardian', 'VillageWatch', 'FarmSafe'], 
            descs: [
                'Solar-powered security kit for areas with unreliable electricity. 20W panel charges 48-hour battery backup. Mobile network alerts (not WiFi dependent). Loud 120dB siren. Dust-resistant housing tested for Rajasthan conditions. $75 price point.',
                'Satellite-connected security for areas with zero mobile coverage. Satellite-based alert transmission, 5W solar charging, built for extreme weather (-20°C to 60°C). Designed for remote farmhouses, mining camps, and forest lodges.',
                'Community security network enabling neighbouring homes to share alerts. Village-level dashboard showing security status. Long-range wireless covering 2km radius without internet. Community alert siren integration.',
                'Farm security system protecting crops and equipment. Perimeter beam sensors, equipment GPS trackers, and water tank level monitoring. Solar-powered with potential eligibility for agricultural subsidies under PM-KUSUM scheme.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 3, marketsize: 2, strategic: 3, team: 3, capability: 3, ip: 3, platform: 2, sustainability: 5, newmarket: 5, geographic: 5, competitive: 4, devcost: 3, roi: 2, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Field testing shows strong product-market fit.', 'Government scheme partnership progressing.'], bad: ['Distribution infrastructure challenging.', 'Unit economics require volume.'] }, 
            outcomeNarrative: { success: 'Opened large underserved rural market.', failure: 'Distribution costs higher than projected. Shifted to partnership model.' } 
        },
        { 
            archetype: 'platform_infrastructure', 
            names: ['AI Learning Cam', 'SmartHome Bridge', 'EcoSystem Hub', 'UniversalConnect'], 
            descs: [
                'Camera with built-in learning that adapts to your home over 90 days. Learns family faces, regular visitors, delivery schedules, and normal activity patterns. Reduces false alerts by 85% without sending data to the cloud. Privacy-first design—all learning stays on the device.',
                'Integration hub connecting ShieldTech with 50+ third-party devices: Philips Hue, Syska LED, Google Nest, Amazon Echo, Samsung SmartThings, Havells fans. Supports modern smart home standards. Enables cross-brand automation like: "When motion detected, turn on lights."',
                'Universal gateway supporting multiple wireless standards (Zigbee, Z-Wave, WiFi, Bluetooth) through a single app. Easy device discovery and setup. Scene builder for complex automations. Open to third-party developers. $60 hardware + optional $1/month cloud service.',
                'Adapter that makes traditional wired sensors smart. Converts existing magnetic contacts, motion sensors, and wired alarms to work with the wireless ShieldTech system. Enables gradual smart home upgrade without replacing existing installation.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 4, platform: 5, sustainability: 3, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Platform foundation technically solid.', 'Developer community growing.', 'Partner integrations on track.'], bad: ['Adoption curve requires patience.', 'Network effects building gradually.'] }, 
            outcomeNarrative: { success: 'Platform reached critical mass. Strong ecosystem lock-in.', failure: 'Platform viable but smaller scale than hoped. Valuable infrastructure for future.' } 
        },
        { 
            archetype: 'market_explorer', 
            names: ['SecureComm', 'AlertNet', 'GuardianLink', 'CommunityWatch'], 
            descs: [
                'Encrypted messaging app for security personnel with location sharing, shift handover logs, and incident reporting. Panic button broadcasts to team with live video. Initially targeting security agencies, may expand to gated community management.',
                'Neighbourhood alert network: when one ShieldTech system triggers, nearby subscribers receive notification. Shared suspicious activity map. Anonymous tip reporting. Requires enough users in a locality to be effective.',
                'Subscription service connecting ShieldTech users with verified security responders. $4/month gets human response within 15 minutes of confirmed alert. Partnership with security agencies for responder network. Insurance tie-up for coverage.',
                'Platform for Resident Welfare Associations (RWAs) integrating visitor management, domestic help verification, and shared perimeter security. Intercom integration, vehicle tracking, and society-wide alert broadcast. Sells to societies, reaches residents.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 4, geographic: 4, competitive: 3, devcost: 4, roi: 3, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Market feedback informing direction.', 'Early adopters showing engagement.', 'Adjacent opportunities identified.'], bad: ['Initial hypothesis needs refinement.', 'Pivot considerations emerging.'] }, 
            outcomeNarrative: { success: 'Iterative approach found strong product-market fit.', failure: 'Market learnings valuable. Team redirected to adjacent opportunity.' } 
        },
        { 
            archetype: 'price_fighter', 
            names: ['ValueCam Basic', 'BudgetLock Simple', 'EconoAlert'], 
            descs: [
                '1080p WiFi camera at $22 competing directly with Xiaomi Mi Home and Yi cameras. Features: night vision (8m), two-way audio, SD card slot (up to 128GB), ShieldTech app integration. Thin 18% margin requires 50,000 units/month volume.',
                'PIN-code smart lock at $25 undercutting Chinese imports. Basic features only: 6-digit code, auto-lock, low battery alert. No app connectivity—standalone operation. Competes on "local brand trust" positioning.',
                'Budget 3-pack sensor kit at $12 matching import pricing. Door sensor + motion sensor + alarm. Basic app with phone alerts. Deliberately minimal features to hit price point. Very thin 12% margins.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 5, strategic: 3, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 2, newmarket: 3, geographic: 5, competitive: 3, devcost: 4, roi: 3, speed: 5, risk: 3 }, 
            quarterNarratives: { good: ['Cost targets achieved.', 'Channel partnerships secured.', 'Quality holding at price point.'], bad: ['Competitor pricing aggressive.', 'Margin pressure emerging.'] }, 
            outcomeNarrative: { success: 'Volume targets met. Brand trust differentiated from imports.', failure: 'Margin erosion required repositioning upmarket.' } 
        },
        { 
            archetype: 'esg_initiative', 
            names: ['EcoSensor Green', 'SolarGuard Pro', 'RecycleReady Cam', 'CarbonLight System'], 
            descs: [
                'Motion sensor with housing made from 80% recycled ocean plastic (partnership with Plastic Bank). 100% plastic-free packaging. Includes recycling information for end-of-life. Pursuing B-Corp certification. Premium pricing at $18 vs $12 standard.',
                'Fully solar-powered security system with 30W panel, long-life battery (10 years), and energy-positive operation generating excess power. Carbon-neutral manufacturing via verified offset program. Targets eco-conscious premium buyers.',
                'Modular camera designed for 10-year lifespan with replaceable components: lens module, sensor board, WiFi chip. Repair guides and spare parts program. Trade-in recycling with $6 credit toward new purchase.',
                'Security installation service with carbon footprint tracking. Electric vehicle installer fleet, low-impact mounting materials, and tree planting (1 tree per installation). Monthly sustainability report in app.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 3, strategic: 4, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Eco-conscious segment responding well.', 'Press coverage generating brand uplift.', 'Retail partner interest strong.'], bad: ['Premium positioning requires education.', 'Recycled material supply chain building.'] }, 
            outcomeNarrative: { success: 'Sustainability leadership established. Premium justified.', failure: 'Repositioned sustainability as feature rather than primary value prop.' } 
        },
        { 
            archetype: 'proprietary_tech', 
            names: ['PatentShield Pro', 'ProprieTech Sensor', 'TradeSecret Cam'], 
            descs: [
                'Camera with patented "TruePresence" detection combining regular vision, heat sensing, and radar. 12 patents filed covering the sensor combination technology, false-alarm elimination, and adaptive learning. Could be licensed to competitors.',
                'Advanced vibration sensor detecting glass break, drilling, and forced entry with 99.7% accuracy. Manufacturing process is a trade secret impossible to copy. Patent family of 8 covering core sensing technology.',
                'Video analytics using custom-designed AI achieving 40% better accuracy than alternatives for Indian faces and conditions. Training data from 500,000 labelled Indian security videos. The trained models are protected as trade secrets.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 5, platform: 3, sustainability: 3, newmarket: 4, geographic: 3, competitive: 5, devcost: 3, roi: 4, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Key patent granted, strengthening defensive position.', 'Licensing interest from international manufacturer.', 'Technical breakthrough achieved ahead of schedule.'], bad: ['Patent examination taking longer than expected.', 'Competitor filing requires response.'] }, 
            outcomeNarrative: { success: 'IP moat created lasting competitive advantage with licensing revenue.', failure: 'Patents valuable but commercialisation required pivot. Licensing strategy generated returns.' } 
        },
        // ============================================
        // NEW PROJECTS FROM EXPANDED DATABASE
        // ============================================
        { 
            archetype: 'ai_guard_innovation', 
            names: ['AI Guard Co-Pilot', 'GuardAssist Pro', 'SmartPatrol AI', 'SentinelBuddy'], 
            descs: [
                'Smartphone/bodycam app with built-in smart detection that spots anomalies like unauthorized door following, perimeter breaches, and crowd aggression. Provides step-by-step guidance for guards in real-time and automatically logs incidents with time, location, and video clips. Works offline and escalates to the control room when needed.',
                'Smart guard companion app that understands the security context of each location to provide real-time guidance. Works with low bandwidth to summarize incidents. Builds up knowledge from incident reports and customer procedures to get smarter over time.',
                'On-device smart detection app (compressed to run on phones) with audio event detection, location awareness, and smart beacons. Automatically generates incident summaries. Focuses on making guards more effective rather than replacing video management systems.',
                'Mobile-first security assistant with secure evidence handling. Competes with video analytics companies and workflow tools. Targets the gap in guard support tools in the Indian market.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 5, platform: 4, sustainability: 4, newmarket: 4, geographic: 4, competitive: 4, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Guard pilot feedback exceptionally positive.', 'SOP recommendation accuracy exceeding targets.', 'Incident logging adoption rate strong.'], bad: ['Edge model optimization taking longer than planned.', 'Integration with legacy bodycam systems challenging.'] }, 
            outcomeNarrative: { success: 'Transformed guard effectiveness. Became standard equipment for enterprise security teams.', failure: 'Technology impressive but guard adoption slower than expected. Repositioned as SOC tool.' } 
        },
        { 
            archetype: 'services_platform', 
            names: ['Remote Video Patrol-as-a-Service', 'CloudGuard Monitoring', 'AI-Assisted SOC', 'VirtualPatrol Pro'], 
            descs: [
                'Subscription monitoring service where operators watch 50-200 cameras per site with smart filtering to reduce false alarms. AI drafts incident reports and customer updates that operators review and approve. Smart alert prioritization with workload balancing across operators.',
                'Multi-customer monitoring console connecting to various camera systems with unified event handling. AI-assisted report generation with quality review by humans. Performance tracking dashboard. Alert settings customized by industry type; staffing optimization methods are proprietary.',
                'Remote guarding platform competing with Prosegur and Securitas. AI capabilities provide 2-3 years of competitive advantage. Eagle Eye Networks and Genetec are key competitors in cloud video space.',
                'Managed monitoring service with automatically drafted reports and evidence linking. Partnership model with local monitoring centers. Focus on reducing operator fatigue while improving response quality.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 3, platform: 5, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 3, roi: 5, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Customer retention exceeding targets.', 'GenAI report quality praised by clients.', 'Operator efficiency gains validated.'], bad: ['SOC staffing costs higher than modeled.', 'False alarm reduction targets not yet met.'] }, 
            outcomeNarrative: { success: 'Recurring revenue stream established. Became preferred remote monitoring partner for enterprise clients.', failure: 'Service viable but margins tighter than planned. Focused on premium segment.' } 
        },
        { 
            archetype: 'autonomous_drone', 
            names: ['Autonomous Perimeter Drone Patrol', 'SkyGuard Sentinel', 'DronePatrol Enterprise', 'AeroWatch System'], 
            descs: [
                'Tethered drones for continuous perimeter monitoring plus untethered scheduled patrols. Self-docking and auto-charging, heat-sensing cameras, spotlight, and speaker for deterrence. Flight routes designed around aviation authority rules and site-specific risk zones.',
                'Drone-in-a-box solution that automatically launches when multiple sensors trigger an alarm. Heat-sensing cameras, secure command connection. Connects with access control and video systems. Flight logs maintained for regulatory compliance.',
                'Competing with IdeaForge (India), DJI ecosystem, and Percepto (global). Partner with manufacturers for docking hardware. Focus on Indian regulatory compliance and operational reliability.',
                'Enterprise perimeter security using self-flying aerial patrol. 24-48 month development timeline. Key advantage is aviation authority-compliant flight planning with awareness of site-specific risk zones.'
            ], 
            budgetRange: [8, 11], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 4, team: 3, capability: 3, ip: 4, platform: 3, sustainability: 3, newmarket: 5, geographic: 3, competitive: 4, devcost: 2, roi: 3, speed: 2, risk: 2 }, 
            quarterNarratives: { good: ['DGCA approval pathway clarified.', 'Pilot site demonstrating value.', 'Thermal detection accuracy exceeding specs.'], bad: ['Regulatory timeline uncertain.', 'Weather resilience requiring additional engineering.'] }, 
            outcomeNarrative: { success: 'First-mover in compliant autonomous perimeter patrol. Premium pricing justified by results.', failure: 'Technology validated but market timing premature. Shifted to manned drone services.' } 
        },
        { 
            archetype: 'ground_robot', 
            names: ['Autonomous Ground Patrol Robot', 'RoboGuard Campus', 'PatrolBot Enterprise', 'SecureRover'], 
            descs: [
                'Rugged indoor/outdoor robot with 360° cameras, heat sensing, and laser scanning for navigation. Patrol routes detect open doors, loitering, and smoke. Calls human responders when needed. Navigation system specially tuned for Indian conditions (dust, uneven floors).',
                'Robot designed to work alongside human guards. Uses laser and radar scanning for navigation, on-board processing, remote control capability, and self-docking. Enterprise-grade security features. Learns normal patterns for each facility to detect anomalies.',
                'Competing with Knightscope (global), Cobalt Robotics, Boston Dynamics partners, and local startups. 36-60 month development timeline. Focus on handling challenging Indian environmental conditions.',
                'Campus and warehouse security robot with proven navigation in difficult conditions. Competitive advantages include facility-specific mapping and anomaly detection methods.'
            ], 
            budgetRange: [9, 12], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 4, team: 3, capability: 2, ip: 4, platform: 3, sustainability: 3, newmarket: 5, geographic: 2, competitive: 3, devcost: 2, roi: 2, speed: 1, risk: 2 }, 
            quarterNarratives: { good: ['Navigation stack performing well in pilot.', 'Guard acceptance higher than expected.', 'Cost targets achievable with scale.'], bad: ['Outdoor reliability needs improvement.', 'Unit economics challenging at low volumes.'] }, 
            outcomeNarrative: { success: 'Established ShieldTech in physical robotics. Premium enterprise accounts.', failure: 'Technology validated but pivoted to partnership model with robotics manufacturer.' } 
        },
        { 
            archetype: 'privacy_compliance', 
            names: ['Privacy-Preserving Video Analytics', 'DPDP-Ready Analytics', 'AnonymousWatch', 'PrivacyFirst Vision'], 
            descs: [
                'Analytics that does not store faces by default. Processes video on-device with faces only revealed when authorized during incident investigation. Encrypted audit trails. Privacy protection that can be selectively removed when legitimately needed.',
                'Selective data sharing designed for compliance and trust. Reduces customer legal risk under India\'s Data Protection Act. Automatic face and body blurring with secure methods to reveal when authorized. Role-based access control for who can see what.',
                'Differentiation through Data Protection Act compliance and privacy-by-design. Competes with Genetec privacy features and cloud video vendors. Focus on regulated industries (banking, insurance, healthcare, government).',
                'Privacy-focused platform addressing growing regulatory requirements. 24-48 month development timeline. First-mover advantage in Indian privacy-compliant video analytics.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 4, platform: 4, sustainability: 5, newmarket: 4, geographic: 4, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['DPDP-readiness attracting enterprise interest.', 'Privacy certification on track.', 'Legal team validating approach.'], bad: ['Regulatory requirements still evolving.', 'Performance impact of encryption higher than expected.'] }, 
            outcomeNarrative: { success: 'Became the trusted choice for privacy-conscious enterprises. Regulatory tailwind accelerated adoption.', failure: 'Market demand slower than regulations suggested. Positioned as premium add-on.' } 
        },
        { 
            archetype: 'evidence_chain', 
            names: ['Verifiable Video Evidence Chain', 'CourtReady Evidence', 'TamperProof Video', 'EvidenceLock'], 
            descs: [
                'Every video clip and export is digitally signed with custody reports generated automatically. Works with bodycams and security cameras. Complete evidence trail across different camera brands and types.',
                'Multiple parties verify authenticity (client plus security provider). Secure timestamping, tamper detection, watermarking, and detailed logs. Export packaging meets evidence best practices.',
                'Competing with Axon evidence ecosystem, Motorola Solutions, and forensic tool providers. Standards-aligned with proprietary implementation. 18-30 month development timeline.',
                'Court-admissible video evidence solution. Addresses growing need for legally defensible security footage. Key advantage is support for different camera brands and types.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Legal validation of evidence chain approach.', 'Integration with major VMS platforms complete.', 'Enterprise pilot generating positive feedback.'], bad: ['Key management complexity higher than expected.', 'Legacy camera integration challenging.'] }, 
            outcomeNarrative: { success: 'Standard for court-ready video evidence in India. Strong recurring revenue from enterprise accounts.', failure: 'Technology validated but sales cycle longer than expected. Focused on high-value accounts.' } 
        },
        { 
            archetype: 'smart_access', 
            names: ['Smart Access Control with RBA', 'RiskGate Pro', 'AdaptiveAccess', 'ContextualEntry'], 
            descs: [
                'Access decisions based on risk factors (time of day, crowding, badge anomalies, probability of unauthorized following). Requests additional verification (PIN, fingerprint, or security question) only when risk is elevated. Risk scoring for physical access using multiple sensors.',
                'Flexible policies per zone with risk management layer. Works with access controllers, short-range wireless, turnstiles, and camera-based detection of unauthorized following. Differentiates from HID Global and Honeywell through the overall management layer.',
                'Competing with Johnson Controls, Suprema, and local integrators. 24-36 month development timeline. Risk-adaptive approach reduces inconvenience while maintaining security.',
                'Next-generation access control moving beyond simple allow/deny to contextual risk assessment. Strong intellectual property in risk scoring methods.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 4, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Risk scoring accuracy exceeding targets.', 'Tailgating detection precision validated.', 'Enterprise pilot showing reduced friction.'], bad: ['Integration with legacy access systems complex.', 'False positive rate needs optimization.'] }, 
            outcomeNarrative: { success: 'Redefined access control category. Premium positioning justified by measurable security improvement.', failure: 'Technology sound but market education required. Partnered with access control vendors.' } 
        },
        { 
            archetype: 'rtls_tracking', 
            names: ['Ultra-Wideband (UWB) Indoor Tracking Platform', 'AssetTrack Pro', 'SafeZone RTLS', 'PrecisionLocate'], 
            descs: [
                'Precision indoor tracking using short-range wireless technology to locate forklifts, valuable assets, and workers. Alerts for proximity hazards and restricted zones. Security-grade location tracking with tamper detection and incident replay. Links with camera footage timeline.',
                'Movement and incident analysis per location type creates valuable data asset. Precision tracking with Bluetooth backup, location engine, mobile dashboards, connects with safety and security systems. Competing with Zebra, Quuppa, Sewio.',
                'Indian indoor location solution optimized for warehouse and manufacturing environments. Focus on safety compliance and asset protection. Partnership potential with workplace safety software vendors.',
                'Enterprise positioning system combining asset tracking with staff safety. Unique integration with security infrastructure differentiates from pure location tracking vendors.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 4, sustainability: 4, newmarket: 4, geographic: 3, competitive: 3, devcost: 3, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Positioning accuracy exceeding requirements.', 'Safety use cases resonating with EHS teams.', 'CCTV integration creating differentiation.'], bad: ['UWB anchor deployment costs higher than modeled.', 'Battery life optimization needed for wearables.'] }, 
            outcomeNarrative: { success: 'Expanded ShieldTech into industrial safety market. Strong cross-sell with existing security products.', failure: 'Technology validated but focused on partnership with RTLS specialist.' } 
        },
        { 
            archetype: 'acoustic_detection', 
            names: ['Gunshot/Blast Acoustic Detection', 'SoundSentinel Network', 'AcousticAlert Pro', 'BlastDetect'], 
            descs: [
                'Distributed sound sensors detect gunshot-like signatures, explosions, and glass breaking. Pinpoint location, automatically point cameras, and dispatch responders. Cost-effective sound localization tuned for Indian urban environments.',
                'False-alarm suppression using context (events, festivals, traffic patterns). Microphone arrays, on-device audio processing, AI classifiers, precise time synchronization, automatic camera control. Competing with ShotSpotter-style solutions globally.',
                'Specialized audio detection for urban and campus environments. 36-60 month development timeline. Focus on Indian-specific sound environment challenges.',
                'Sound-based threat detection that complements video analytics. Strong intellectual property in contextual false-alarm suppression. Partnership potential with smart city initiatives.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 3, capability: 3, ip: 4, platform: 3, sustainability: 3, newmarket: 5, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Detection accuracy validated in controlled tests.', 'Urban soundscape model improving.', 'Smart city pilot interest strong.'], bad: ['False positive rate in dense urban areas challenging.', 'Hardware costs higher than targets.'] }, 
            outcomeNarrative: { success: 'Pioneered acoustic detection for Indian smart cities. Government contracts secured.', failure: 'Technology promising but market timing early. Maintained as R&D capability.' } 
        },
        { 
            archetype: 'digital_twin', 
            names: ['Secure Facility Digital Twin', 'SimulationShield', 'TwinGuard Platform', 'VirtualSite Pro'], 
            descs: [
                'Virtual 3D model of each client site showing zones, cameras, access points, and patrol routes. Run "what-if" simulations and tabletop exercises. Generate training scenarios for guards. Automatically builds the virtual model from floorplans and camera information.',
                'AI-generated training drills based on actual near-miss incidents. Risk models by industry type are proprietary. Imports floorplans, builds relationship maps, runs simulations, generates training content, and tracks performance.',
                'Competing with large facility management platforms and specialized simulation vendors. 24-48 month development timeline. Focus on security-specific use cases.',
                'Training and planning platform using virtual site models. Strong differentiation through AI-generated scenarios based on real incident patterns.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 5, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 4, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Auto-twin generation accuracy improving.', 'Training scenario engagement high.', 'Enterprise security teams showing strong interest.'], bad: ['Floorplan ingestion more complex than expected.', 'Simulation fidelity requirements increasing scope.'] }, 
            outcomeNarrative: { success: 'Transformed security training and planning. Platform became sticky enterprise tool.', failure: 'Technology validated but narrowed focus to training content generation.' } 
        },
        { 
            archetype: 'perimeter_fusion', 
            names: ['Multi-Sensor Perimeter System', 'FenceGuard Fusion', 'PerimeterShield Pro', 'BoundaryWatch'], 
            descs: [
                'Complete perimeter security kit: fiber vibration sensing, microwave sensors, radar, plus heat-sensing cameras combined into a single alarm feed with intrusion tracking. Smart sensor combination with automatic adjustment. Terrain-aware intrusion tracking.',
                'Fiber-optic sensing integration, radar, thermal cameras, on-site processing, map-based interface. Individual sensors are commoditized; our value is in combining them and providing a great user experience. Competing with Magal, Senstar, Dahua/Hikvision perimeter products.',
                'Indian perimeter integration solution with superior sensor combination and user experience. Strong position against commodity sensor vendors through software differentiation.',
                'Enterprise perimeter security combining best-of-breed sensors with unified management. Shorter development timeline given mature component technologies.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Sensor fusion accuracy exceeding targets.', 'Installation time significantly reduced.', 'Customer UX feedback very positive.'], bad: ['Fiber sensing integration more complex than planned.', 'Calibration requirements varying by terrain.'] }, 
            outcomeNarrative: { success: 'Became preferred perimeter solution for critical infrastructure. Strong margins on software layer.', failure: 'Product viable but competed on hardware integration services rather than software premium.' } 
        },
        { 
            archetype: 'cyber_physical_soc', 
            names: ['Cyber-Physical SOC Platform', 'UnifiedSOC Pro', 'ConvergenceCenter', 'HybridThreat Platform'], 
            descs: [
                'Control room platform that connects physical events (door forced, camera offline) with IT and industrial system signals (network anomaly, equipment alert) to detect coordinated attacks. Cross-system correlation rules and anomaly analysis. Response procedures coordinating guards and IT team.',
                'Connects with IT security tools, normalizes events, provides analysis, automates responses, secure multi-customer capability. Partner with IT security vendors; keep correlation technology proprietary. Competing with Splunk, Microsoft Sentinel ecosystem.',
                'Addressing the combination of physical and cyber security. 24-48 month development timeline. Strong differentiation through physical security expertise.',
                'Enterprise security operations platform bridging traditional departments. Unique positioning at intersection of physical security and cybersecurity markets.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 4, newmarket: 5, geographic: 3, competitive: 4, devcost: 2, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Correlation engine detecting novel attack patterns.', 'SIEM integration partnerships progressing.', 'Enterprise pilot validating value proposition.'], bad: ['Integration complexity higher than planned.', 'Sales cycle requiring both physical and IT security buy-in.'] }, 
            outcomeNarrative: { success: 'Defined new category of converged security operations. Premium enterprise pricing.', failure: 'Technology validated but focused on partnership with SIEM vendor.' } 
        },
        { 
            archetype: 'camera_health', 
            names: ['Camera/IoT Health Assurance', 'SurveillanceHealth Pro', 'CamCare Platform', 'IoTGuardian'], 
            descs: [
                'Detect when cameras are blocked, out of focus, covered, cables tampered with, or when recorders have disk failures. Auto-fix problems (reboot, switch video stream, dispatch technician) and prove uptime guarantees. Vision-based self-diagnosis with automatic troubleshooting.',
                'Vendor-specific repair procedures are proprietary. Visual health checks, device monitoring, remote management, performance dashboards. Short development timeline given mature underlying technologies.',
                'Competing with video system health modules and device management startups. Differentiation through proactive problem-solving and uptime proof.',
                'Infrastructure reliability platform ensuring security systems work when needed. Strong recurring revenue potential through managed service model.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 3, platform: 4, sustainability: 4, newmarket: 2, geographic: 4, competitive: 3, devcost: 4, roi: 5, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Health detection accuracy very high.', 'Auto-remediation reducing service calls.', 'SLA dashboard praised by facility managers.'], bad: ['Legacy camera support more complex than expected.', 'Some vendors resisting deep integration.'] }, 
            outcomeNarrative: { success: 'Essential tool for managed security services. Strong attach rate to camera deployments.', failure: 'Viable product but bundled with services rather than sold standalone.' } 
        },
        { 
            archetype: 'panic_wearable', 
            names: ['Smart Panic Wearables', 'StaffSafe Pro', 'VIPGuard Wearable', 'PanicButton Plus'], 
            descs: [
                'Wearable panic button with motion sensors that detect falls and assaults. Discreet emergency alert with location. Automatically records audio snippet. Connects to nearest guard and control room. Fall and assault detection with escalation logic. Privacy-respecting audio capture with consent workflow.',
                'Hardware may be sourced externally; we protect the software and backend. Wireless wearables, location awareness, mobile app, control room dispatch, battery optimization. Competing with safety apps and telecom wearable offerings.',
                'Staff and VIP safety solution combining hardware and services. Short development timeline. Focus on enterprise deployment with control room integration.',
                'Personal safety wearable with professional-grade response infrastructure. Differentiation through seamless control room integration and evidence capture.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Fall detection accuracy validated.', 'Enterprise adoption strong in healthcare.', 'SOC integration seamless.'], bad: ['Battery life optimization ongoing.', 'Consumer market more competitive than expected.'] }, 
            outcomeNarrative: { success: 'Standard safety equipment for high-risk industries. Strong recurring revenue from monitoring service.', failure: 'Enterprise focus validated. Exited consumer market to focus on B2B.' } 
        },
        { 
            archetype: 'vehicle_intelligence', 
            names: ['LPR + Vehicle Intent Scoring', 'SmartGate Analytics', 'VehicleIQ Platform', 'IntentWatch'], 
            descs: [
                'Beyond license plate recognition: score vehicle behavior using entry patterns, time spent on site, driver behavior, approved/blocked lists, and unusual routes. Reduce insider theft and staging. Vehicle behavior analysis combined with delivery schedules and access logs.',
                'Site-specific vehicle pattern analysis as competitive advantage. License plate cameras, vehicle identification, rule-based and AI scoring, integration with gate operations. Competing with license plate vendors and logistics security platforms.',
                'Advanced vehicle analytics for gated campuses and logistics facilities. 24-36 month development timeline. Focus on insider threat detection.',
                'Next-generation vehicle access management moving beyond simple plate recognition to behavioral analysis. Strong intellectual property in behavior scoring methods.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 4, platform: 4, sustainability: 3, newmarket: 3, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Intent scoring reducing false positives.', 'Logistics customers seeing theft reduction.', 'Integration with gate systems smooth.'], bad: ['Training data collection slower than planned.', 'Privacy concerns requiring additional safeguards.'] }, 
            outcomeNarrative: { success: 'Redefined vehicle access security. Strong adoption in logistics and manufacturing.', failure: 'Technology validated but market education required. Partnered with LPR vendors.' } 
        },
        { 
            archetype: 'compliance_automation', 
            names: ['One-Click Compliance Reporting', 'AuditReady Platform', 'ComplianceBot Pro', 'RegReport Suite'], 
            descs: [
                'Auto-generate monthly/quarterly security compliance reports: patrol completeness, incident response times, access anomalies, camera uptime, training attendance. Export to client formats. Central data storage, report generator, dashboards, digital approvals, and audit trails.',
                'Performance benchmarks by industry are proprietary. Defensible through integrations and library of regulatory requirement mappings. Competing with governance/risk tools and facility management suites. Short development timeline.',
                'Compliance automation for banking, pharma, and data center industries. Focus on reducing audit burden while improving compliance posture.',
                'Enterprise compliance platform using ShieldTech ecosystem data. Strong recurring revenue through subscription model.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 4, sustainability: 4, newmarket: 2, geographic: 4, competitive: 3, devcost: 5, roi: 5, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Report templates well-received by compliance teams.', 'Integration with audit workflows smooth.', 'Time savings quantified and significant.'], bad: ['Regulatory mapping more complex than expected.', 'Customization requests increasing scope.'] }, 
            outcomeNarrative: { success: 'Essential tool for regulated industries. High attach rate to enterprise deployments.', failure: 'Viable product but competed with established GRC vendors. Focused on security-specific compliance.' } 
        },
        { 
            archetype: 'deepfake_defense', 
            names: ['Deepfake-Resistant Authorization', 'TrueIdentity Pro', 'LivenessGuard', 'AuthentiCheck'], 
            descs: [
                'For remote gate approvals, fund/asset release, or VIP access: multiple verification steps including "liveness" detection, challenge-response questions, and device verification. Detects AI-generated fake video/voice and replay attacks. Risk-based verification for physical security approvals.',
                'Use licensed liveness detection where needed; we own the management and policy system. Liveness detection, voice anti-spoofing, device verification, transaction signing, audit trails. 24-48 month development timeline.',
                'Addressing emerging deepfake threat to remote authorization. Competing with identity verification vendors and fintech providers. Physical security-specific focus differentiates.',
                'Future-proof authentication for high-value approvals. Strong intellectual property in risk-based management. Partnership potential with biometric vendors.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 5, team: 4, capability: 3, ip: 4, platform: 4, sustainability: 4, newmarket: 5, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Deepfake detection accuracy improving rapidly.', 'High-value use cases generating strong interest.', 'Partnership with liveness vendor progressing.'], bad: ['Deepfake technology evolving faster than detection.', 'User experience friction requiring optimization.'] }, 
            outcomeNarrative: { success: 'Became trusted solution for high-stakes remote authorization. Premium pricing for critical use cases.', failure: 'Technology validated but market timing early. Maintained as advanced authentication option.' } 
        },
        { 
            archetype: 'edge_micro_nvr', 
            names: ['Edge AI Micro-NVR', 'LocalGuard Box', 'SiteCache Pro', 'EdgeVault'], 
            descs: [
                'Small rugged box (or camera software) running smart analytics and storing encrypted footage locally. Only uploads events to cloud, not full video. Ideal for tier-2/3 cities and remote factories. Event-first upload with bandwidth-aware storage management.',
                'Hardware is commodity; we protect the software and management system. Local processing, modular analytics, encrypted storage, efficient uploading, remote management. Competing with closed-system vendors like Verkada.',
                'Low-bandwidth video security for underserved markets. Short development timeline. Strong fit with ShieldTech rural/semi-urban expansion strategy.',
                'Hybrid cloud-local architecture optimized for Indian infrastructure realities. Differentiation through intelligent uploading and bandwidth management.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 4, geographic: 5, competitive: 4, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Bandwidth reduction exceeding targets.', 'Tier-2/3 city pilots very successful.', 'Edge analytics performance validated.'], bad: ['Hardware supply chain challenges.', 'Remote management requiring more features.'] }, 
            outcomeNarrative: { success: 'Enabled expansion into bandwidth-constrained markets. Strong volume growth.', failure: 'Technology validated but competed with cloud-only pricing. Repositioned as premium option.' } 
        },
        { 
            archetype: 'rapid_deploy_kit', 
            names: ['Rapid-Deploy Pop-up Security Kit', 'EventGuard Express', 'TempSecure Box', 'InstantShield'], 
            descs: [
                'Boxed kit deployed in under 2 hours: solar plus LTE cameras, perimeter beacons, portable access control, panic buttons, command tablet. Priced per day/week. LTE cameras, battery/solar, mesh networking, temporary mounts, preconfigured SOC profiles.',
                'Mostly system design plus logistics; patent limited but defensible via packaging plus SOP plus rental network. Strong operational moat. Quick timeline to TRL 9.',
                'Competing with event security providers and CCTV rental firms. Differentiation through integrated solution and rapid deployment.',
                'Temporary security solution for events, construction sites, and emergency response. Rental model creates recurring revenue opportunity.'
            ], 
            budgetRange: [8, 10], baseSuccess: 0.65, 
            riskProfile: 'low', rewardProfile: 'low',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 3, newmarket: 4, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Deployment time meeting targets.', 'Event security market responding well.', 'Rental economics validated.'], bad: ['Logistics network build-out slower than planned.', 'Damage/loss rates higher than modeled.'] }, 
            outcomeNarrative: { success: 'Created new revenue stream in temporary security market. Strong utilization rates.', failure: 'Viable business but logistics challenges led to partnership with event rental company.' } 
        },
        { 
            archetype: 'predictive_risk', 
            names: ['Predictive Security Risk Engine', 'RiskForecast Pro', 'ThreatPredict Platform', 'SecurityAI Planner'], 
            descs: [
                'Use historical incidents plus environment signals (shift patterns, holidays, local events, weather, footfall) to forecast risk by site/zone. Recommend patrol schedules, staffing, and sensor upgrades. Security-specific causal features plus counterfactual staffing simulator.',
                'Multi-client anonymized benchmarks (with consent plus privacy controls) as data moat. Time-series forecasting, causal modeling, optimization, integration with rostering plus SOC plus digital twin. 36-60 month development timeline.',
                'Competing with analytics consultancies and workforce management vendors adding AI. Focus on security-specific modeling expertise.',
                'Advanced analytics platform for security resource optimization. Long development timeline but significant differentiation potential through proprietary models.'
            ], 
            budgetRange: [7, 9], baseSuccess: 0.65, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 3, strategic: 5, team: 4, capability: 3, ip: 5, platform: 5, sustainability: 4, newmarket: 5, geographic: 3, competitive: 5, devcost: 2, roi: 3, speed: 1, risk: 2 }, 
            quarterNarratives: { good: ['Forecast accuracy improving with more data.', 'Early adopters seeing measurable improvements.', 'Model interpretability praised by security directors.'], bad: ['Data collection and normalization challenging.', 'Proving ROI requires longer customer engagement.'] }, 
            outcomeNarrative: { success: 'Transformed security from reactive to predictive. Strategic differentiator for enterprise accounts.', failure: 'Technology validated but narrowed focus to specific use cases. Continued as R&D initiative.' } 
        },
        { 
            archetype: 'visitor_flow', 
            names: ['VisitorFlow Pro', 'QueueGuard Service', 'EntryCare Manager', 'LobbyControl System'], 
            descs: [
                'Managed service keeping entrances calm at high-footfall sites. Pre-registration + walk-in handling, badge issuing, queue monitoring with supervisor visibility, incident logging with photo/clip evidence, and monthly insights on peak times and bottlenecks.',
                'Corporate lobby and clinic entrance management combining visitor check-in workflow, crowd density monitoring via cameras, rule-based alerts for crowding thresholds, and audit-ready incident records with time-stamped actions.',
                'Campus and event venue queue security with SMS/WhatsApp pass links, people counting for queue length, escalation procedures for denied entry patterns, and monthly performance reporting with recommended fixes.',
                'Plant and warehouse visitor management integrating access control, dwell-time monitoring near sensitive doors, supervisor dashboards for peak hours, and compliance-ready documentation for client reviews.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Visitor check-in workflow streamlined.', 'Client feedback on queue management positive.', 'Incident documentation praised by auditors.'], bad: ['Peak hour staffing coordination challenging.', 'Integration with existing access systems complex.'] }, 
            outcomeNarrative: { success: 'Became standard offering for corporate clients. Strong recurring revenue from managed service.', failure: 'Service viable but scaled back to high-value sites only.' } 
        },
        { 
            archetype: 'security_score', 
            names: ['SiteScore Pro', 'SecurityHealth Check', 'GuardMetrics Monthly', 'FacilityAudit Service'], 
            descs: [
                'Monthly or quarterly security review scoring sites on camera uptime, blind spots, door misuse, guard tour completion, alarm response time, and incident patterns. Board-ready reports with improvement roadmaps and gap registers.',
                'Standardized 8-12 metric scorecard with on-site walk-throughs, remote system checks, and benchmark comparisons by industry. Clients use reports to justify upgrades and track year-over-year improvements.',
                'Quarterly health check combining patrol log analysis, CCTV health monitoring, access control anomalies, and incident MTTR tracking. Delivers prioritized action lists: quick fixes vs capital projects.',
                'Enterprise security assessment service with industry benchmarks for warehouses, offices, hospitals. Dashboard pulling data from patrol apps, camera health tools, and access logs for comprehensive site evaluation.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.75, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 5, competitive: 3, devcost: 5, roi: 4, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Scoring methodology validated by clients.', 'Benchmark library growing rapidly.', 'Renewal rates exceeding projections.'], bad: ['Data collection from legacy systems challenging.', 'Standardization across site types complex.'] }, 
            outcomeNarrative: { success: 'Essential service for multi-site enterprises. High attach rate to existing contracts.', failure: 'Valuable but bundled with other services rather than standalone.' } 
        },
        { 
            archetype: 'smart_key_control', 
            names: ['KeyVault Pro', 'AssetCustody System', 'SmartLocker Plus', 'ShiftControl Manager'], 
            descs: [
                'Smart key cabinet and locker system preventing loss of master keys, radios, and shared tools. Role-based access, shift handover workflows, supervisor sign-off, and alerts for late returns or unusual access patterns.',
                'RFID/iButton tagged asset management for warehouses and plants. Tamper-logged lockers with audit reports supporting investigations. Integration with HR rostering and access control systems.',
                'Hospital and campus key control with custody chain tracking, exception handling workflows, and after-hours asset removal alerts. Compliance reporting for regulatory audits.',
                'Industrial asset accountability system combining smart cabinets, mobile supervisor dashboards, anomaly detection for frequency/duration/time-of-day patterns, and effortless audit documentation.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Handover workflow reducing disputes.', 'Audit capabilities praised by compliance teams.', 'Hardware reliability exceeding expectations.'], bad: ['Legacy locker integration more complex than planned.', 'User adoption requiring additional training.'] }, 
            outcomeNarrative: { success: 'Standard solution for industrial clients. Strong margins on hardware + service bundle.', failure: 'Hardware viable but software differentiation limited. Partnered with locker vendors.' } 
        },
        { 
            archetype: 'emergency_muster', 
            names: ['MusterPoint Pro', 'RollCall System', 'EvacTrack Platform', 'HeadCount Manager'], 
            descs: [
                'Mustering system for drills and real emergencies quickly confirming who is safe, who is missing, and their last-known zone. Zone-based check-in via QR/NFC badges, offline-capable app for weak network areas, and after-action timeline reports.',
                'Factory and warehouse roll-call solution with real-time missing person lists, integration with access systems for last-known location, and incident commander dashboard for coordinated response.',
                'Construction site and campus evacuation tracking using BLE/UWB for zone accuracy in complex facilities. Exportable logs for compliance and improvement action documentation.',
                'Large office mustering platform with automatic escalation workflows, offline-first design syncing on network return, and drill performance analytics for continuous improvement.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Drill response times significantly improved.', 'Offline mode performing reliably.', 'EHS teams championing adoption.'], bad: ['BLE accuracy in industrial environments challenging.', 'Integration with legacy access systems complex.'] }, 
            outcomeNarrative: { success: 'Required system for large industrial sites. Strong cross-sell with other safety solutions.', failure: 'Technology validated but market fragmented. Focused on vertical specialization.' } 
        },
        { 
            archetype: 'night_escort', 
            names: ['SafeRoute Service', 'NightGuard Escort', 'CampusSafe Tracker', 'EscortLink Platform'], 
            descs: [
                'Campus and corporate park night escort service with app-based requests, guard dispatch with response SLAs, live GPS tracking to destination, and SOS/panic escalation to supervisors or remote monitoring.',
                'University safety service combining request-to-dispatch workflow, automatic start/end journey confirmations, supervisor visibility dashboard, and monthly hotspot reports for high-request areas.',
                'Corporate park escort tracking with optional wearable panic buttons for higher-risk users, integration with guard shift rosters, and performance analytics proving response times to clients.',
                'Tech park night safety solution with geofenced alerts, route tracking with audit trails, and monthly insights identifying areas and times with elevated incidents or requests.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 3, strategic: 3, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['User adoption exceeding expectations.', 'Response SLAs consistently met.', 'Campus administrators highly satisfied.'], bad: ['Coverage density requiring more resources than planned.', 'App reliability in low-connectivity areas challenging.'] }, 
            outcomeNarrative: { success: 'Differentiating service for campus security contracts. Strong recurring revenue.', failure: 'Service valuable but labor-intensive. Optimized for premium locations only.' } 
        },
        { 
            archetype: 'guard_training_sim', 
            names: ['GuardSim Pro', 'ScenarioDrill Platform', 'TrainingEdge System', 'SOPTrainer Mobile'], 
            descs: [
                'Phone-based guard training with 30-60 branching scenarios per industry: tailgating, suspicious packages, aggressive visitors, medical emergencies. SOP-aligned feedback, certification tracking, and monthly micro-drill schedules.',
                'Mobile learning platform with multilingual support, short video/audio prompts, and offline mode. Supervisor dashboard showing completion rates, scores, and coaching suggestions for underperformers.',
                'Convert real incidents into new training scenarios. Scenario library mapped to client SOPs, scoring rubrics for consistent evaluation, and refresher schedules ensuring continuous readiness.',
                'Guard readiness platform reducing variation in service quality through realistic drills. Quick quizzes, branching decisions, and performance analytics identifying training gaps across the workforce.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 3, geographic: 5, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Scenario engagement rates high.', 'Guard performance metrics improving.', 'Client feedback on training quality positive.'], bad: ['Content localization more extensive than planned.', 'Offline sync reliability requiring fixes.'] }, 
            outcomeNarrative: { success: 'Standard training platform for security workforce. Strong differentiation in contract bids.', failure: 'Content valuable but delivery platform competitive. Licensed scenarios to training partners.' } 
        },
        { 
            archetype: 'incident_invoice', 
            names: ['ProofPack Service', 'ResponseDoc System', 'IncidentBill Pro', 'EvidenceChain Platform'], 
            descs: [
                'System packaging response work into clean billing records: dispatch time, arrival time, actions taken, photos/video clips, and digital sign-offs. Reduces disputes with automated proof pack PDFs for each call-out.',
                'Guard and supervisor mobile reporting with standard incident forms, evidence attachments, and client contact approvals. Monthly service summaries showing volumes, response times, and recommendations.',
                'Field service documentation combining CCTV clip links, time-stamps, digital signatures, and exportable reporting. Makes performance visible to clients and auditors.',
                'Evidence-backed billing platform integrating dispatch/ticketing systems, standard response steps per incident type, and transparent proof of service delivery for enterprise accounts.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 5, speed: 5, risk: 5 }, 
            quarterNarratives: { good: ['Billing disputes significantly reduced.', 'Client satisfaction with transparency high.', 'Audit documentation praised.'], bad: ['Guard adoption requiring workflow changes.', 'Integration with legacy systems challenging.'] }, 
            outcomeNarrative: { success: 'Transformed client relationships through transparency. Essential for enterprise contracts.', failure: 'Valuable but integrated into broader service platform rather than standalone.' } 
        },
        { 
            archetype: 'parking_security', 
            names: ['ParkWatch Pro', 'VehicleAlert System', 'LotGuard Platform', 'ParkingSafe Service'], 
            descs: [
                'Parking lot and campus road security reducing theft, stalking risk, and misuse. Flags wrong-way entry, repeated late-night visits, plate mismatches, and long-dwell vehicles near sensitive doors.',
                'LPR-based parking security with rule engine for time-of-day, dwell time, and repeat attempt patterns. Gate/barrier integration for manual approval and deny lists. Weekly hotspot reporting.',
                'Campus parking analytics with zone-specific rules for visitor lots, staff lots, loading bays. Guard/SOC alerts with supporting snapshots and recommended actions.',
                'Logistics yard security combining license plate recognition, vehicle behavior scoring by zone, barrier controller integration, and monthly analysis with recommended fixes.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['False alarm rates lower than expected.', 'Integration with barriers smooth.', 'Security teams finding alerts actionable.'], bad: ['LPR accuracy in poor lighting challenging.', 'Rule tuning requiring more site-specific work.'] }, 
            outcomeNarrative: { success: 'Standard add-on for campus and logistics contracts. Strong margins on analytics layer.', failure: 'Technology validated but competed with parking management vendors. Focused on security-specific use cases.' } 
        },
        { 
            archetype: 'shrink_prevention', 
            names: ['ShrinkGuard Package', 'WarehouseLoss Control', 'DockWatch System', 'InventoryShield Service'], 
            descs: [
                'Bundled warehouse shrink prevention combining dock-door monitoring, high-risk area coverage, checklist inspections, and exception reports highlighting suspicious patterns. Monthly shrink driver analysis.',
                'Logistics hub loss prevention with cameras alerting after-hours movement, door-open duration, and restricted zone entry. Mobile inspection checklists with supervisor sign-off and evidence clips.',
                'Shrink risk mapping for docks, high-value aisles, returns areas, scrap zones, and exits. Standard operating checks for seal verification and random inspections with audit documentation.',
                'Distribution center security package integrating access log analysis, camera alerts, inspection workflows, and monthly reporting with corrective action tracking and ROI measurement.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Shrink rates measurably reduced at pilot sites.', 'Exception alerts catching real issues.', 'Operations teams embracing methodology.'], bad: ['Integration with WMS systems complex.', 'False positive tuning requiring ongoing effort.'] }, 
            outcomeNarrative: { success: 'Proven ROI drove rapid adoption in logistics vertical. Premium pricing justified by measurable results.', failure: 'Methodology validated but delivery labor-intensive. Repositioned as consulting engagement.' } 
        },
        { 
            archetype: 'alarm_response_network', 
            names: ['ResponseNet Service', 'SharedPatrol Network', 'AlarmGuard Subscription', 'MobileResponse Pro'], 
            descs: [
                'Subscription mobile response service with teams responding to alarms for multiple customers. Defined coverage plans, response SLAs, incident proof packs, and customer portal for performance tracking and billing.',
                'Shared response network reducing cost vs dedicated guards. GPS-tracked dispatch, step-by-step mobile procedures, arrival verification, and transparent evidence documentation.',
                'Alarm monitoring add-on with physical response capability. Integration with alarm panels, standard response procedures, reset actions, escalation notes, and performance analytics.',
                'Multi-client response service with route optimization, staffing density management, and partnership model for coverage expansion. Customer portal showing response times and incident details.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 5, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 4, newmarket: 4, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Response SLAs consistently met.', 'Customer acquisition costs lower than projected.', 'Responder network scaling efficiently.'], bad: ['Coverage density in new areas challenging.', 'Alarm panel integration more complex than expected.'] }, 
            outcomeNarrative: { success: 'Became major service line with strong recurring revenue. Network effects creating barrier to entry.', failure: 'Viable in dense urban areas but rural economics challenging. Focused on metro markets.' } 
        },
        { 
            archetype: 'camera_subscription', 
            names: ['CamCare Subscription', 'VideoGuard aaS', 'CCTV Refresh Plan', 'SurveillanceCloud Service'], 
            descs: [
                'Subscription camera service removing upfront spending. Standard packages with install, maintenance, planned refresh cycles, remote health monitoring, and uptime reporting. Attractive for multi-site customers.',
                'Camera-as-a-Service with cloud/hybrid storage, preventative maintenance, automatic replacements, and technology roadmap per site. Service ticketing and spares logistics included.',
                'CCTV subscription bundles: basic/standard/premium tiers with clear inclusions. Remote device health monitoring detecting offline cameras, storage errors, and degradation.',
                'Multi-site camera program with centralized management, refresh planning, and consistent SLA delivery across locations. Financing model enabling cash-flow-conscious buyers.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 5, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Subscription uptake exceeding projections.', 'Churn rates very low.', 'Service delivery costs optimized.'], bad: ['Working capital requirements significant.', 'Equipment refresh timing complex to manage.'] }, 
            outcomeNarrative: { success: 'Transformed business model with predictable recurring revenue. Strong customer lock-in.', failure: 'Model viable but capital-intensive. Partnered with financing provider for scale.' } 
        },
        { 
            archetype: 'privacy_analytics', 
            names: ['PrivacyFirst Analytics', 'BlurGuard Platform', 'ConsentView System', 'DataSafe CCTV'], 
            descs: [
                'Analytics service reducing privacy risk. Default face blurring, event-only clip retention, restricted evidence access with approval workflows, and audit logs of all exports. Privacy-by-design configuration.',
                'Office and hospital video analytics with masking/redaction tools, role-based access control, retention automation, and evidence handling processes documenting who can unmask footage.',
                'Campus CCTV privacy solution with workshop-based configuration, documented settings per zone, secure evidence vault, and compliance reporting for GDPR-style requirements.',
                'Privacy-preserving video platform enabling analytics while protecting individuals. Reversible blur with approval workflows, access audit trails, and regulatory-ready documentation.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 4, capability: 4, ip: 3, platform: 4, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Privacy workflow design praised by legal teams.', 'Compliance positioning resonating with enterprises.', 'Audit capabilities exceeding requirements.'], bad: ['Performance impact of real-time masking challenging.', 'Policy complexity requiring extensive customization.'] }, 
            outcomeNarrative: { success: 'Essential for privacy-conscious enterprises. Premium positioning justified by compliance value.', failure: 'Technology validated but market education required. Focused on regulated verticals.' } 
        },
        { 
            archetype: 'guard_tour_proof', 
            names: ['TourVerify Pro', 'PatrolProof System', 'AntiSpoof GuardTrack', 'TamperGuard Tours'], 
            descs: [
                'Guard tour system reducing fake patrol risk with tamper-resistant checkpoints, randomized routes, GPS validation, and cross-checks on time/location patterns. Supervisor dashboards with exception alerts.',
                'NFC/QR checkpoint deployment with BLE beacons for indoor zones. Rules detecting missed points, too-fast scans, and suspicious sequences. Client reporting proving patrol completion.',
                'Anti-fraud patrol verification using randomization and multi-sensor checks. Historical patrol data building trust with governance-focused clients.',
                'Tamper-resistant tour system combining checkpoint scanning, phone GPS validation, random route prompts, and anomaly detection for scan speed and sequence irregularities.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 3, platform: 3, sustainability: 4, newmarket: 2, geographic: 5, competitive: 3, devcost: 4, roi: 4, speed: 5, risk: 4 }, 
            quarterNarratives: { good: ['Fraud detection catching real issues.', 'Client confidence in patrol data high.', 'Checkpoint deployment efficient.'], bad: ['GPS accuracy in indoor environments variable.', 'Guard resistance to increased monitoring.'] }, 
            outcomeNarrative: { success: 'Standard tool for managed guarding. Strong differentiation in contract proposals.', failure: 'Technology validated but competitive with existing tour apps. Bundled with service contracts.' } 
        },
        { 
            archetype: 'smart_intercom', 
            names: ['GateCall Pro', 'IntercomPlus System', 'SmartEntry Manager', 'VisitorGate Platform'], 
            descs: [
                'Auditable gated entry with IP intercoms, mobile answering app, decision logging with photo/video snapshots, call recording, and monthly insights on peak times and repeat issues.',
                'Factory and campus gate management integrating intercom hardware, barrier controls, allow/deny decision logs with evidence, and searchable history for investigations.',
                'Corporate campus entry system with visitor verification, approval workflows, gate integration, and analytics on entry patterns and improvement opportunities.',
                'High-visitor office intercom solution combining smooth operator workflows, decision audit trails, call recording with role-based access, and gate delay reduction metrics.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.70, 
            riskProfile: 'low', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 3, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Gate delays significantly reduced.', 'Decision logging praised by compliance teams.', 'Integration with barriers smooth.'], bad: ['Call quality in noisy environments challenging.', 'Recording consent workflow requiring clarification.'] }, 
            outcomeNarrative: { success: 'Standard entry solution for gated facilities. Strong margins on integration services.', failure: 'Viable product but competed with intercom manufacturers. Focused on software/service layer.' } 
        },
        { 
            archetype: 'wander_management', 
            names: ['WanderGuard Care', 'PatientSafe System', 'ExitAlert Healthcare', 'VulnerableWatch Platform'], 
            descs: [
                'Hospital and care site safety solution reducing wandering risk. BLE/UWB tags for high-risk patients, exit/zone rules with approach alerts, staff response playbooks, and compliance reporting.',
                'Opt-in tagging program with consent workflows, door-side alerts, calm reunite procedures, and incident documentation for regulatory compliance.',
                'Pediatric and elder care wander prevention with early warning alerts to security and nursing stations. False-alarm reduction through zone-specific tuning.',
                'Healthcare facility exit monitoring integrating tags, door sensors, alerting dashboards, and response playbooks designed for non-disruptive patient handling.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 4, capability: 3, ip: 3, platform: 3, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Clinical staff adoption strong.', 'False alarm rates acceptably low.', 'Family feedback on safety very positive.'], bad: ['Tag battery life requiring optimization.', 'Integration with nurse call systems complex.'] }, 
            outcomeNarrative: { success: 'Essential safety system for hospitals and care homes. Strong cross-sell with other healthcare solutions.', failure: 'Technology validated but healthcare sales cycle long. Partnered with healthcare IT vendors.' } 
        },
        { 
            archetype: 'contractor_screening', 
            names: ['StaffScreen Service', 'VendorVerify Platform', 'ContractorCheck System', 'TrustGate Background'], 
            descs: [
                'Consent-based screening for temporary staff, vendors, and contractors. Document verification, reference checks, and performance flags from prior assignments. Pass/fail outcomes with review workflows.',
                'Risk-tiered screening packages: basic/standard/high-risk roles. Consent capture, secure data handling, and optional re-screening on role changes or periodic schedules.',
                'Vendor management integration providing screening status, assignment history, and compliance documentation. Audit logs and retention controls for regulatory requirements.',
                'Contract workforce screening combining identity verification, reference checks, incident history from prior deployments, and ongoing monitoring with flag alerts.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 3, devcost: 4, roi: 4, speed: 4, risk: 4 }, 
            quarterNarratives: { good: ['Verification turnaround times fast.', 'Client trust in screening quality high.', 'Repeat screening adoption growing.'], bad: ['Reference check response rates variable.', 'Cross-border verification more complex than expected.'] }, 
            outcomeNarrative: { success: 'Trusted screening provider for enterprise clients. Strong integration with vendor management processes.', failure: 'Service viable but competed with established background verification firms. Focused on security-specific screening.' } 
        },
        { 
            archetype: 'ai_video_search', 
            names: ['VideoSearch AI', 'ClipFinder Pro', 'InvestigateIQ Platform', 'SmartRetrieve System'], 
            descs: [
                'AI-assisted video search by description: person in red, white truck, movement near loading bay after 11 PM. Policy controls on who can search, audit trails, and responsible-use guidelines.',
                'Indexed video search with attribute detection for vehicles, uniforms, bags, helmets. Evidence export workflows with review steps and role-based access control.',
                'Investigation acceleration platform reducing hours of manual review. Search interface connected to VMS, privacy-aware query restrictions, and misuse prevention through approvals.',
                'Video analytics search combining object detection, temporal queries, and governance controls. Operator training program and tuning services for each deployment environment.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.55, 
            riskProfile: 'high', rewardProfile: 'high',
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 4, platform: 4, sustainability: 4, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 3, speed: 2, risk: 3 }, 
            quarterNarratives: { good: ['Search accuracy exceeding expectations.', 'Investigation time savings dramatic.', 'Governance controls praised by compliance.'], bad: ['Training data requirements significant.', 'Privacy concerns requiring careful positioning.'] }, 
            outcomeNarrative: { success: 'Transformed investigation workflows. Premium feature driving enterprise upgrades.', failure: 'Technology validated but competed with VMS vendor features. Focused on governance differentiation.' } 
        },
        { 
            archetype: 'safety_security_soc', 
            names: ['UnifiedWatch Center', 'SafetySecure SOC', 'CombinedOps Platform', 'IntegratedCommand Service'], 
            descs: [
                'Merged safety and security monitoring: PPE compliance, unsafe zones, near-misses combined with intrusion, access anomalies, and incident response. Single dashboard, unified playbooks, joint monthly reviews.',
                'Combined command center reducing tool sprawl. Camera analytics for PPE and unsafe behaviors, integration with alarms and access control, and reporting layer covering both domains.',
                'Industrial operations platform handling safety events (confined space entry, hot work) and security events (unauthorized access, theft indicators) through coordinated response.',
                'Unified monitoring service with cross-trained operators, integrated incident workflows, and consolidated KPI reporting for safety and security leadership.'
            ], 
            budgetRange: [6, 8], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'high',
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 3, ip: 3, platform: 4, sustainability: 5, newmarket: 4, geographic: 3, competitive: 4, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Unified operations reducing response times.', 'Client consolidation appetite strong.', 'Operator efficiency improved.'], bad: ['Playbook integration more complex than planned.', 'Safety and security team coordination challenging.'] }, 
            outcomeNarrative: { success: 'Defined new category of unified operations. Strong differentiation in industrial verticals.', failure: 'Integration validated but organizational silos persistent. Offered as optional unification service.' } 
        },
        { 
            archetype: 'anti_drone_service', 
            names: ['DroneWatch Service', 'AirspaceGuard Platform', 'UAVAlert System', 'SkyShield Detection'], 
            descs: [
                'Compliance-first drone detection for sensitive sites. RF-based sensors with optional camera/thermal confirmation, detection-confirmation workflow reducing false alarms, evidence packs, and escalation procedures.',
                'Perimeter airspace monitoring with site survey, coverage design, geofenced rules by time and zone, and alert integration with SOC/dispatch. Regular testing and performance reports.',
                'Critical infrastructure drone detection combining multi-sensor deployment, incident documentation, and response playbooks. Focus on detection and escalation, not takedown.',
                'Data center and industrial site airspace security with RF detection, visual confirmation, time-stamped evidence, and regulatory-compliant incident handling procedures.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.55, 
            riskProfile: 'high', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 4, team: 4, capability: 3, ip: 2, platform: 3, sustainability: 3, newmarket: 4, geographic: 3, competitive: 3, devcost: 3, roi: 3, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Detection reliability validated in pilots.', 'False alarm handling workflows effective.', 'Client interest from critical infrastructure strong.'], bad: ['RF environment variability affecting detection.', 'Regulatory clarity on response options limited.'] }, 
            outcomeNarrative: { success: 'Trusted provider for critical infrastructure. Strong government and enterprise relationships.', failure: 'Technology viable but market smaller than projected. Offered as add-on for high-security sites.' } 
        },
        { 
            archetype: 'predictive_door_maintenance', 
            names: ['DoorHealth Pro', 'EntryPoint Predict', 'AccessMaintain Platform', 'TurnstileCare Service'], 
            descs: [
                'Predictive maintenance for doors, locks, and turnstiles. Usage pattern analysis detecting early warning signs: abnormal open duration, repeated retries, unusual after-hours use. Maintenance tickets with priority and parts recommendations.',
                'Critical entry infrastructure reliability service combining door sensors, access event logs, optional motor/vibration monitoring, and integration with maintenance ticketing.',
                'Turnstile and gate health monitoring with instrumentation planning, threshold configuration, uptime dashboards, and monthly reliability reports with improvement actions.',
                'Access hardware predictive maintenance reducing security gaps from failures. Anomaly detection, proactive scheduling, and documented downtime reduction for client reviews.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.60, 
            riskProfile: 'medium', rewardProfile: 'moderate',
            scores: { technical: 4, marketsize: 3, strategic: 3, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 4, newmarket: 3, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 3, risk: 4 }, 
            quarterNarratives: { good: ['Failure prediction accuracy improving.', 'Maintenance cost savings documented.', 'Facility managers praising proactive approach.'], bad: ['Sensor deployment in legacy doors challenging.', 'Integration with diverse maintenance systems complex.'] }, 
            outcomeNarrative: { success: 'Essential service for large campuses. Strong cross-sell with access control contracts.', failure: 'Technology validated but market fragmented. Focused on enterprise accounts with centralized maintenance.' } 
        }
    ];
    
    // ============================================
    // LEGACY R&D PORTFOLIO PROJECTS
    // ============================================
    // These are projects inherited from previous leadership decisions
    // Players must decide what to do with them before selecting new projects
    
    const legacyProjectTemplates = [
        {
            id: 'legacy-1',
            name: 'SmartLock 2.0',
            archetype: 'legacy_incremental',
            desc: 'Incremental update to existing SmartLock product line. Adds Bluetooth 5.0, improves battery life by 20%, and adds Hindi voice prompts. Announced to 200+ channel dealers at last year\'s distributor conference.',
            quarterStarted: -3,
            quartersRemaining: 8,
            totalBudget: 3.5,
            spentBudget: 2.0,
            remainingBudget: 1.5,
            progress: 72,
            status: 'amber',
            teamSize: 4,
            strategicAlignment: 'low',
            alignmentNote: 'Core business incremental. Won\'t differentiate us, but maintains dealer relationships.',
            externalCommitment: 'Announced to 200+ dealers at annual conference. Price lists distributed.',
            politicalContext: 'Sales team strongly committed. VP Sales (Deepak) championed this at leadership.',
            quarterlyUpdates: [
                { quarter: -3, status: 'green', narrative: 'Project kickoff smooth. Team assembled.' },
                { quarter: -2, status: 'green', narrative: 'BT 5.0 integration completed. Voice prompts recorded.' },
                { quarter: -1, status: 'amber', narrative: 'Battery optimisation hitting limits. May only hit 15% improvement.' }
            ],
            scores: { technical: 4, marketsize: 3, strategic: 2, team: 4, capability: 5, ip: 2, newmarket: 1, roi: 3 },
            riskIfContinued: 'Resources tied up in incremental work. Opportunity cost for breakthrough projects.',
            riskIfKilled: 'Sales team loses credibility with dealers. Deepak vocal at leadership. Q3 revenue gap.'
        },
        {
            id: 'legacy-2',
            name: 'Regional Language App',
            archetype: 'legacy_incremental',
            desc: 'ShieldTech app localisation for Tamil, Telugu, Kannada, and Malayalam. Press release already issued announcing "India\'s first vernacular smart home security app".',
            quarterStarted: -2,
            quartersRemaining: 8,
            totalBudget: 1.5,
            spentBudget: 1.0,
            remainingBudget: 0.5,
            progress: 85,
            status: 'green',
            teamSize: 2,
            strategicAlignment: 'medium',
            alignmentNote: 'Supports Tier 2/3 city expansion. Modest strategic value but good optics.',
            externalCommitment: 'Press release issued. Tech media covered the announcement.',
            politicalContext: 'Marketing (Anjali) championed this. Good PR value but limited revenue impact.',
            quarterlyUpdates: [
                { quarter: -2, status: 'green', narrative: 'Translation partners engaged. UI adaptation started.' },
                { quarter: -1, status: 'green', narrative: 'Tamil and Telugu complete. Southern languages on track.' }
            ],
            scores: { technical: 3, marketsize: 3, strategic: 3, team: 4, capability: 5, ip: 1, newmarket: 3, roi: 2 },
            riskIfContinued: 'Small resource drain. Minor opportunity cost.',
            riskIfKilled: 'Press release already out. Embarrassing public reversal. Anjali upset.'
        },
        {
            id: 'legacy-3',
            name: 'Executive Analytics Dashboard',
            archetype: 'legacy_pet_project',
            desc: 'Enterprise analytics dashboard showing security metrics, trends, and ROI calculations for corporate customers. Former COO\'s initiative before his departure.',
            quarterStarted: -4,
            quartersRemaining: 9,
            totalBudget: 5.0,
            spentBudget: 2.5,
            remainingBudget: 2.5,
            progress: 38,
            status: 'red',
            teamSize: 5,
            strategicAlignment: 'questionable',
            alignmentNote: 'Former COO\'s vision for B2B pivot. New strategy focuses on consumer premium.',
            externalCommitment: 'Pilot agreement with 3 enterprise customers. Non-binding.',
            politicalContext: 'Project orphaned after COO left. Team demoralised. No executive sponsor.',
            quarterlyUpdates: [
                { quarter: -4, status: 'green', narrative: 'Strong executive backing. Architecture defined.' },
                { quarter: -3, status: 'amber', narrative: 'Scope creep. Additional requirements from enterprise pilots.' },
                { quarter: -2, status: 'amber', narrative: 'COO departure. Project direction uncertain.' },
                { quarter: -1, status: 'red', narrative: 'Team attrition. Lead developer resigned. Velocity down 60%.' }
            ],
            scores: { technical: 4, marketsize: 3, strategic: 2, team: 2, capability: 3, ip: 2, newmarket: 4, roi: 2 },
            riskIfContinued: 'Zombie project consuming resources. Team morale deteriorating further.',
            riskIfKilled: 'Sunk cost write-off. 3 enterprise pilots disappointed. Team layoffs required.'
        },
        {
            id: 'legacy-4',
            name: 'ShieldOS 3.0 Platform Rewrite',
            archetype: 'legacy_strategic_troubled',
            desc: 'Complete rewrite of core operating system for all ShieldTech devices. Promises 50% faster OTA updates, better security, and unified codebase. Critical for future platform strategy.',
            quarterStarted: -5,
            quartersRemaining: 9,
            totalBudget: 10.0,
            spentBudget: 6.0,
            remainingBudget: 4.0,
            progress: 30,
            status: 'red',
            teamSize: 8,
            strategicAlignment: 'high',
            alignmentNote: 'Critical platform enabler. All future products depend on this. But massively behind schedule.',
            externalCommitment: 'Internal roadmap. No external commitments yet.',
            politicalContext: 'CTO (Harpreet) staked his reputation on this. Board asking hard questions.',
            quarterlyUpdates: [
                { quarter: -5, status: 'green', narrative: 'Ambitious vision. Team excited. Architecture approved.' },
                { quarter: -4, status: 'amber', narrative: 'Complexity higher than estimated. Timeline slipping.' },
                { quarter: -3, status: 'amber', narrative: 'Legacy system integration challenges. Technical debt.' },
                { quarter: -2, status: 'red', narrative: 'Major architectural revision required. 6-month slip.' },
                { quarter: -1, status: 'red', narrative: 'Burn rate concerns. Quality issues in testing.' }
            ],
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 3, capability: 3, ip: 4, newmarket: 3, roi: 3 },
            riskIfContinued: 'Continues to drain resources. Risk of becoming a "bet the company" project.',
            riskIfKilled: 'Platform roadmap collapses. CTO credibility damaged. $5.6M write-off.'
        },
        {
            id: 'legacy-5',
            name: 'OEM White-Label Program',
            archetype: 'legacy_partnership',
            desc: 'White-label security devices for major telecom (Jio) to bundle with broadband. Partnership negotiation has stalled twice. Deal terms unfavorable but revenue significant.',
            quarterStarted: -3,
            quartersRemaining: 9,
            totalBudget: 5.0,
            spentBudget: 2.0,
            remainingBudget: 3.0,
            progress: 45,
            status: 'amber',
            teamSize: 4,
            strategicAlignment: 'questionable',
            alignmentNote: 'Volume revenue but destroys brand differentiation. Sets dangerous precedent.',
            externalCommitment: 'LOI signed with Jio. Exclusivity period expires in 60 days.',
            politicalContext: 'CEO initially excited about Jio scale. Now having second thoughts on brand dilution.',
            quarterlyUpdates: [
                { quarter: -3, status: 'green', narrative: 'Jio excited. LOI signed. Technical integration started.' },
                { quarter: -2, status: 'amber', narrative: 'Pricing negotiation stalled. Jio wants 45% discount.' },
                { quarter: -1, status: 'amber', narrative: 'Terms improved slightly. Still margin negative at volume.' }
            ],
            scores: { technical: 3, marketsize: 5, strategic: 2, team: 4, capability: 4, ip: 1, newmarket: 2, roi: 2 },
            riskIfContinued: 'Even if successful, low margins and brand dilution. Sets precedent for commoditisation.',
            riskIfKilled: 'Write off $1.9M. Jio relationship damaged. CEO loses a strategic bet.'
        },
        {
            id: 'legacy-6',
            name: 'Cost-Reduced Sensor v2',
            archetype: 'legacy_defensive',
            desc: 'Re-engineering door/window sensors to reduce BOM cost by 30%. Switches to cheaper Chinese MCU, simplifies antenna design, and uses injection-molded housing. Response to Xiaomi\'s aggressive pricing.',
            quarterStarted: -2,
            quartersRemaining: 8,
            totalBudget: 2.8,
            spentBudget: 0.8,
            remainingBudget: 2.0,
            progress: 40,
            status: 'green',
            teamSize: 3,
            strategicAlignment: 'medium',
            alignmentNote: 'Necessary defensive move for Tier 2/3 price-sensitive market. But risk of quality perception damage.',
            externalCommitment: 'None external. Internal commitment to hit $5 price point.',
            politicalContext: 'Hardware Lead (Anand) driving this. Finance supportive. Quality team has concerns.',
            quarterlyUpdates: [
                { quarter: -2, status: 'green', narrative: 'Alternative components identified. Testing begun.' },
                { quarter: -1, status: 'green', narrative: 'New MCU validated. Antenna redesign in progress.' }
            ],
            scores: { technical: 3, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 1, newmarket: 2, roi: 4 },
            riskIfContinued: 'May affect quality reputation. Race to bottom on pricing.',
            riskIfKilled: 'Cedes low-end market to Xiaomi. Finance team unhappy with margin trajectory.'
        },
        {
            id: 'legacy-7',
            name: 'Cloud Migration Initiative',
            archetype: 'legacy_infrastructure',
            desc: 'Moving ShieldTech cloud infrastructure from on-premise data centre to AWS India region. Promises 40% cost reduction and better scalability. IT team\'s top priority.',
            quarterStarted: -3,
            quartersRemaining: 9,
            totalBudget: 3.0,
            spentBudget: 1.5,
            remainingBudget: 1.5,
            progress: 65,
            status: 'amber',
            teamSize: 3,
            strategicAlignment: 'medium',
            alignmentNote: 'Important infrastructure modernisation. Enables future scale but not customer-visible.',
            externalCommitment: 'AWS partnership agreement signed. Data centre lease expires in 6 months.',
            politicalContext: 'IT Director (Suresh) driving. Low visibility project. Easy to defer.',
            quarterlyUpdates: [
                { quarter: -3, status: 'green', narrative: 'AWS architecture designed. Migration plan approved.' },
                { quarter: -2, status: 'green', narrative: 'Non-production workloads migrated. Testing positive.' },
                { quarter: -1, status: 'amber', narrative: 'Production migration hitting latency issues. Optimisation needed.' }
            ],
            scores: { technical: 4, marketsize: 3, strategic: 3, team: 4, capability: 4, ip: 1, newmarket: 1, roi: 4 },
            riskIfContinued: 'Moderate resource drain. Some customer experience risk during migration.',
            riskIfKilled: 'Data centre lease renewal expensive. Technical debt accumulates. Suresh demotivated.'
        }
    ];
    
    // Legacy project decision options
    const legacyDecisionOptions = {
        continue: {
            label: 'Continue as Planned',
            icon: '▶️',
            description: 'Maintain current scope, timeline, and budget allocation.',
            budgetImpact: 1.0 // 100% of remaining budget
        },
        accelerate: {
            label: 'Accelerate',
            icon: '⏩',
            description: 'Add resources to complete faster. Higher cost but earlier delivery.',
            budgetImpact: 1.4 // 140% of remaining budget
        },
        reduce_scope: {
            label: 'Reduce Scope',
            icon: '✂️',
            description: 'Cut features to ship sooner with lower cost. May affect commitments.',
            budgetImpact: 0.6 // 60% of remaining budget
        },
        pause: {
            label: 'Pause',
            icon: '⏸️',
            description: 'Stop active work but preserve option to resume. Minimal holding cost.',
            budgetImpact: 0.1 // 10% holding cost
        },
        kill: {
            label: 'Kill Project',
            icon: '⛔',
            description: 'Terminate completely. Write off sunk cost. Free up team.',
            budgetImpact: 0 // No further budget
        }
    };
    
    // ============================================
    // UI FUNCTIONS
    // ============================================
    
    function showPhase(phase) {
        document.querySelectorAll('.phase-content').forEach(el => el.classList.add('hidden'));
        const phaseEl = document.getElementById(`phase-${phase}`);
        if (phaseEl) {
            phaseEl.classList.remove('hidden');
        } else {
            console.error('Phase not found:', phase);
        }
        gameState.phase = phase;
        window.scrollTo(0, 0);
        
        if (phase === 'design-committee') {
            renderStaffCards();
            updateCommitteeDisplay();
        }
    }
    
    function startCommitteeSelection() {
        // Set default decision model to committee
        gameState.decisionModel = 'committee';
        renderStaffCards();
        showPhase('design-committee');
    }
    
    function selectDecisionModel(model) {
        gameState.decisionModel = model;
        document.querySelectorAll('.model-card').forEach(card => card.classList.remove('selected'));
        document.querySelector(`[data-model="${model}"]`).classList.add('selected');
        document.getElementById('decision-model-next').disabled = false;
    }
    
    function proceedFromDecisionModel() {
        if (gameState.decisionModel === 'committee') {
            showPhase('design-committee');
        } else {
            showPhase('design-criteria');
        }
    }
    
    function renderStaffCards() {
        Object.keys(staffDatabase).forEach(category => {
            const container = document.getElementById(`staff-${category}`);
            container.innerHTML = staffDatabase[category].map(staff => {
                const isSelected = gameState.committee.includes(staff.id);
                const isCEO = staff.id === 'meera';
                return `
                <div class="staff-tile ${isSelected ? 'selected' : ''} ${isCEO ? 'locked' : ''}" 
                     data-staff-id="${staff.id}">
                    <div class="selection-check">${isCEO ? '🔒' : ''}</div>
                    <div class="staff-tile-header" style="background: linear-gradient(135deg, ${staff.avatarColor}08 0%, ${staff.avatarColor}15 100%);">
                        <div class="staff-tile-avatar" style="background: linear-gradient(135deg, ${staff.avatarColor} 0%, ${staff.avatarColor}cc 100%);">
                            <img src="${getAvatarUrl(staff)}" alt="${staff.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="staff-tile-initials" style="display: none;">${staff.initials}</span>
                        </div>
                        <div class="staff-tile-header-info">
                            <div class="staff-tile-name">${staff.name}</div>
                            <div class="staff-tile-role">${staff.role}</div>
                            <div class="staff-tile-location">📍 ${staff.location}</div>
                        </div>
                    </div>
                    <div class="staff-tile-body">
                        <p class="staff-tile-bio">${staff.shortBio}</p>
                        <div class="staff-tile-traits">
                            <div class="staff-tile-traits-label">Key Traits</div>
                            <div class="staff-tile-tags">
                                ${staff.strengths.slice(0,2).map(s => `<span class="staff-tag pro">✓ ${s}</span>`).join('')}
                                ${staff.biases.slice(0,1).map(b => `<span class="staff-tag con">⚠ ${b}</span>`).join('')}
                            </div>
                        </div>
                        <div class="staff-tile-actions">
                            <button class="staff-btn-details" onclick="event.stopPropagation(); openStaffModal('${staff.id}')">
                                <span>👤</span> Profile
                            </button>
                            ${isCEO ? `
                            <button class="staff-btn-select selected locked" disabled title="CEO is a mandatory committee member">
                                <span>🔒</span> Required
                            </button>
                            ` : `
                            <button class="staff-btn-select ${isSelected ? 'selected' : ''}" onclick="toggleStaff('${staff.id}')">
                                ${isSelected ? '<span>✓</span> Selected' : '<span>+</span> Add'}
                            </button>
                            `}
                        </div>
                    </div>
                </div>
            `}).join('');
        });
    }
    
    function findStaff(id) {
        for (const category of Object.values(staffDatabase)) {
            const found = category.find(s => s.id === id);
            if (found) return found;
        }
        return null;
    }
    
    function toggleStaff(staffId) {
        // CEO is a mandatory committee member
        if (staffId === 'meera') return;
        
        const index = gameState.committee.indexOf(staffId);
        if (index > -1) {
            gameState.committee.splice(index, 1);
            SoundManager.play('deselect');
        } else {
            gameState.committee.push(staffId);
            SoundManager.play('select');
        }
        renderStaffCards();
        updateCommitteeDisplay();
    }
    
    function updateCommitteeDisplay() {
        const container = document.getElementById('committee-members');
        document.getElementById('committee-count').textContent = gameState.committee.length;
        
        if (gameState.committee.length === 0) {
            container.innerHTML = '<div class="empty-committee">Click on staff members below to add them to your committee</div>';
        } else {
            container.innerHTML = gameState.committee.map(staffId => {
                const staff = findStaff(staffId);
                const isCEO = staffId === 'meera';
                return `
                    <div class="committee-member-chip ${isCEO ? 'locked' : ''}">
                        <img src="${getAvatarUrl(staff)}" alt="${staff.name}" onerror="this.style.background='${staff.avatarColor}'; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22/>';">
                        <span>${staff.name.split(' ')[0]}</span>
                        ${isCEO ? '<span class="locked-badge" title="CEO is a mandatory committee member">🔒</span>' : `<button class="remove-btn" onclick="removeFromCommittee('${staffId}')">×</button>`}
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('committee-next').disabled = gameState.committee.length === 0;
    }
    
    function removeFromCommittee(staffId) {
        // CEO is a mandatory committee member
        if (staffId === 'meera') return;
        
        const index = gameState.committee.indexOf(staffId);
        if (index > -1) {
            gameState.committee.splice(index, 1);
            renderStaffCards();
            updateCommitteeDisplay();
        }
    }
    
    function openStaffModal(staffId) {
        const staff = findStaff(staffId);
        if (!staff) return;
        
        gameState.currentModalStaff = staffId;
        
        document.getElementById('modal-avatar').src = getAvatarUrl(staff);
        document.getElementById('modal-avatar').style.background = staff.avatarColor;
        document.getElementById('modal-name').textContent = staff.name;
        document.getElementById('modal-role').textContent = `${staff.role} • ${staff.location}`;
        document.getElementById('modal-bio').textContent = staff.fullBio;
        document.getElementById('modal-style').textContent = staff.style;
        
        document.getElementById('modal-cv').innerHTML = staff.cv.map(item => `
            <div class="cv-item">
                <span class="cv-year">${item.year}</span>
                <span class="cv-detail">${item.detail}</span>
            </div>
        `).join('');
        
        document.getElementById('modal-traits').innerHTML = [
            ...staff.strengths.map(s => `<span class="staff-trait strength">${s}</span>`),
            ...staff.biases.map(b => `<span class="staff-trait bias">${b}</span>`)
        ].join('');
        
        const addBtn = document.getElementById('modal-add-btn');
        const inCommittee = gameState.committee.includes(staffId);
        
        if (inCommittee) {
            addBtn.textContent = 'Remove from Committee';
            addBtn.className = 'add-to-committee-btn remove';
        } else {
            addBtn.textContent = 'Add to Committee';
            addBtn.className = 'add-to-committee-btn';
        }
        
        document.getElementById('staff-modal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('staff-modal').classList.add('hidden');
        gameState.currentModalStaff = null;
    }
    
    function showReferencesModal() {
        document.getElementById('references-modal').classList.remove('hidden');
    }
    
    function closeReferencesModal() {
        document.getElementById('references-modal').classList.add('hidden');
    }
    
    function addFromModal() {
        if (gameState.currentModalStaff) {
            toggleStaff(gameState.currentModalStaff);
            closeModal();
        }
    }
    
    function toggleCriteria(criteriaId) {
        const index = gameState.criteria.indexOf(criteriaId);
        const card = document.querySelector(`[data-criteria="${criteriaId}"]`);
        
        if (index > -1) {
            gameState.criteria.splice(index, 1);
            card.classList.remove('selected');
            SoundManager.play('deselect');
        } else {
            gameState.criteria.push(criteriaId);
            card.classList.add('selected');
            SoundManager.play('select');
        }
        
        // Update button and recommendation message
        const count = gameState.criteria.length;
        document.getElementById('criteria-next').disabled = count < 1;
        
        // Show recommendation warning
        const warningEl = document.getElementById('criteria-warning');
        if (warningEl) {
            if (count === 0) {
                warningEl.textContent = 'Select at least one criterion to continue';
                warningEl.className = 'criteria-warning error';
            } else if (count < 4) {
                warningEl.textContent = `${count} selected — we recommend 4-6 criteria for balanced evaluation`;
                warningEl.className = 'criteria-warning warning';
            } else if (count > 6) {
                warningEl.textContent = `${count} selected — more than 6 criteria may dilute focus`;
                warningEl.className = 'criteria-warning warning';
            } else {
                warningEl.textContent = `${count} selected — good balance ✓`;
                warningEl.className = 'criteria-warning success';
            }
        }
    }
    
    function goBackFromCriteria() {
        showPhase('design-committee');
    }
    
    // ============================================
    // CRITERIA WEIGHTING
    // ============================================
    
    const criteriaDetails = {
        technical: { 
            name: 'Technical Feasibility', 
            icon: '🔧', 
            color: '#6366f1', 
            short: 'Tech',
            question: 'Can we build it?',
            desc: 'Assess engineering complexity, technology readiness, and whether we have the technical skills to deliver.',
            pro: 'Catches unrealistic projects',
            con: 'May favour incremental',
            category: 'technical'
        },
        capability: { 
            name: 'Core Capability Fit', 
            icon: '🏗️', 
            color: '#8b5cf6', 
            short: 'Cap',
            question: 'Does it leverage what we\'re good at?',
            desc: 'Evaluate alignment with existing capabilities in hardware, software, distribution, and customer relationships.',
            pro: 'Builds on strengths',
            con: 'May block diversification',
            category: 'technical'
        },
        ip: { 
            name: 'IP & Defensibility', 
            icon: '🛡️', 
            color: '#0891b2', 
            short: 'IP',
            question: 'Can we protect the innovation?',
            desc: 'Assess patent potential, trade secrets, and barriers to imitation by competitors.',
            pro: 'Long-term protection',
            con: 'Favours novel tech over execution',
            category: 'technical'
        },
        strategic: { 
            name: 'Strategic Priority Fit', 
            icon: '🎯', 
            color: '#7c3aed', 
            short: 'Strat',
            question: 'Does it address board priorities?',
            desc: 'Check alignment with the four strategic priorities: defend core, tier-2/3 expansion, platform ecosystem, R&D productivity.',
            pro: 'Board alignment',
            con: 'May reject disruptive ideas',
            category: 'strategic'
        },
        platform: { 
            name: 'Platform & Ecosystem', 
            icon: '🔗', 
            color: '#059669', 
            short: 'Plat',
            question: 'Does it strengthen our platform?',
            desc: 'Evaluate contribution to smart home ecosystem, partner integrations, and network effects.',
            pro: 'Long-term positioning',
            con: 'Slow payback periods',
            category: 'strategic'
        },
        sustainability: { 
            name: 'Sustainability Impact', 
            icon: '🌱', 
            color: '#16a34a', 
            short: 'Sust',
            question: 'Does it create positive impact?',
            desc: 'Consider environmental footprint, social benefit, and alignment with corporate responsibility goals.',
            pro: 'ESG alignment',
            con: 'May trade off profitability',
            category: 'strategic'
        },
        marketsize: { 
            name: 'Market Size (TAM)', 
            icon: '📊', 
            color: '#f59e0b', 
            short: 'Mkt',
            question: 'How big is the opportunity?',
            desc: 'Evaluate total addressable market, serviceable market, and realistic revenue potential.',
            pro: 'Revenue focused',
            con: 'May miss valuable niches',
            category: 'market'
        },
        competitive: { 
            name: 'Competitive Differentiation', 
            icon: '⚔️', 
            color: '#ef4444', 
            short: 'Comp',
            question: 'Will we stand out from rivals?',
            desc: 'Assess uniqueness versus Chinese imports, local competitors, and global players entering India.',
            pro: 'Avoids price wars',
            con: 'May overvalue novelty',
            category: 'market'
        },
        newmarket: { 
            name: 'New Market Creation', 
            icon: '🚀', 
            color: '#ec4899', 
            short: 'New',
            question: 'Does it open new segments?',
            desc: 'Assess potential to create new product categories, reach non-consumers, or disrupt adjacent markets.',
            pro: 'Growth potential',
            con: 'Higher uncertainty',
            category: 'market'
        },
        geographic: { 
            name: 'Geographic Expansion', 
            icon: '🗺️', 
            color: '#14b8a6', 
            short: 'Geo',
            question: 'Does it help us expand to new regions?',
            desc: 'Evaluate fit for tier-2/3 cities, rural markets, or eventual international expansion.',
            pro: 'Distribution growth',
            con: 'May require adaptation',
            category: 'market'
        },
        devcost: { 
            name: 'Development Cost', 
            icon: '💵', 
            color: '#dc2626', 
            short: 'Cost',
            question: 'What\'s the R&D investment required?',
            desc: 'Evaluate total development budget, resource requirements, and cost predictability.',
            pro: 'Budget discipline',
            con: 'May kill ambitious projects',
            category: 'financial'
        },
        roi: { 
            name: 'Expected ROI', 
            icon: '📈', 
            color: '#65a30d', 
            short: 'ROI',
            question: 'What\'s the return on investment?',
            desc: 'Calculate expected returns relative to investment, including payback period and NPV.',
            pro: 'Financial rigour',
            con: 'Underweights optionality',
            category: 'financial'
        },
        speed: { 
            name: 'Time to Market', 
            icon: '⚡', 
            color: '#f97316', 
            short: 'Speed',
            question: 'How fast can we launch?',
            desc: 'Prioritise projects that can reach customers quickly and capture market windows.',
            pro: 'Captures urgency',
            con: 'May skip big bets',
            category: 'financial'
        },
        team: { 
            name: 'Team Capability', 
            icon: '👥', 
            color: '#8b5cf6', 
            short: 'Team',
            question: 'Can this team deliver?',
            desc: 'Assess the project team\'s track record, skills, bandwidth, and leadership quality.',
            pro: 'Execution focused',
            con: 'Favours known teams',
            category: 'financial'
        },
        risk: { 
            name: 'Risk Profile', 
            icon: '⚠️', 
            color: '#78716c', 
            short: 'Risk',
            question: 'What could go wrong?',
            desc: 'Evaluate technical, market, regulatory, and execution risks. Consider downside scenarios.',
            pro: 'Avoids disasters',
            con: 'May be too conservative',
            category: 'financial'
        }
    };
    
    function renderCriteriaTiles() {
        const categories = {
            technical: document.getElementById('criteria-technical'),
            strategic: document.getElementById('criteria-strategic'),
            market: document.getElementById('criteria-market'),
            financial: document.getElementById('criteria-financial')
        };
        
        Object.entries(criteriaDetails).forEach(([id, detail]) => {
            const container = categories[detail.category];
            if (!container) return;
            
            const isSelected = gameState.criteria.includes(id);
            const tile = document.createElement('div');
            tile.className = `criteria-tile ${isSelected ? 'selected' : ''}`;
            tile.setAttribute('data-criteria', id);
            tile.onclick = () => toggleCriteria(id);
            
            tile.innerHTML = `
                <div class="selection-check"></div>
                <div class="criteria-tile-header">
                    <div class="criteria-tile-icon" style="background: ${detail.color};">
                        ${detail.icon}
                    </div>
                    <div class="criteria-tile-info">
                        <div class="criteria-tile-title">${detail.name}</div>
                        <div class="criteria-tile-question">${detail.question}</div>
                    </div>
                </div>
                <div class="criteria-tile-body">
                    <div class="criteria-tile-desc">${detail.desc}</div>
                    <div class="criteria-tile-tags">
                        <span class="criteria-tag pro">✓ ${detail.pro}</span>
                        <span class="criteria-tag con">⚡ ${detail.con}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(tile);
        });
    }
    
    // Initialize criteria tiles when page loads
    document.addEventListener('DOMContentLoaded', () => {
        renderCriteriaTiles();
    });
    
    function showCriteriaWeights() {
        // Initialize weights if not set
        if (!gameState.criteriaWeights) {
            gameState.criteriaWeights = {};
        }
        
        // Set equal weights initially if empty
        if (Object.keys(gameState.criteriaWeights).length === 0) {
            const equalWeight = Math.floor(100 / gameState.criteria.length);
            const remainder = 100 - (equalWeight * gameState.criteria.length);
            gameState.criteria.forEach((c, i) => {
                gameState.criteriaWeights[c] = equalWeight + (i === 0 ? remainder : 0);
            });
        }
        
        renderWeightsGrid();
        showPhase('criteria-weights');
    }
    
    function renderWeightsGrid() {
        const grid = document.getElementById('weights-grid');
        grid.innerHTML = gameState.criteria.map(criteriaId => {
            const detail = criteriaDetails[criteriaId] || { name: criteriaId, icon: '📋', color: '#6b7280', short: criteriaId, question: '' };
            const weight = gameState.criteriaWeights[criteriaId] || 0;
            return `
                <div class="weight-tile ${weight > 0 ? 'has-value' : ''}" data-criteria="${criteriaId}">
                    <div class="weight-tile-icon" style="background: linear-gradient(135deg, ${detail.color} 0%, ${detail.color}dd 100%);">
                        ${detail.icon}
                    </div>
                    <div class="weight-tile-content">
                        <div class="weight-tile-header">
                            <div>
                                <div class="weight-tile-title">${detail.name}</div>
                                <div style="font-size: 0.8em; color: var(--gray-500); font-style: italic;">${detail.question || ''}</div>
                            </div>
                            <div class="weight-tile-value">
                                <input type="number" class="weight-tile-input" min="0" max="100" step="1"
                                       value="${weight}" onchange="updateWeight('${criteriaId}', this.value)"
                                       id="weight-input-${criteriaId}">
                                <span class="weight-tile-pct">%</span>
                            </div>
                        </div>
                        <input type="range" class="weight-tile-slider" min="0" max="100" step="1" 
                               value="${weight}" onchange="updateWeight('${criteriaId}', this.value)"
                               oninput="updateWeightPreview('${criteriaId}', this.value)">
                    </div>
                </div>
            `;
        }).join('');
        
        updateWeightsTotal();
        updateWeightsFormula();
    }
    
    function updateWeightPreview(criteriaId, value) {
        document.getElementById(`weight-input-${criteriaId}`).value = value;
        // Update total preview
        const tempWeights = { ...gameState.criteriaWeights };
        tempWeights[criteriaId] = parseInt(value) || 0;
        const total = Object.values(tempWeights).reduce((sum, w) => sum + w, 0);
        
        const totalEl = document.getElementById('weights-total');
        totalEl.textContent = total;
        totalEl.className = 'weights-value ' + (total < 100 ? 'under' : total > 100 ? 'over' : 'exact');
    }
    
    function updateWeight(criteriaId, value) {
        const numValue = Math.max(0, Math.min(100, parseInt(value) || 0));
        gameState.criteriaWeights[criteriaId] = numValue;
        
        // Update slider and input to match
        const item = document.querySelector(`.weight-tile[data-criteria="${criteriaId}"]`);
        if (item) {
            item.querySelector('.weight-tile-slider').value = numValue;
            item.querySelector('.weight-tile-input').value = numValue;
            item.classList.toggle('has-value', numValue > 0);
        }
        
        updateWeightsTotal();
        updateWeightsFormula();
    }
    
    function updateWeightsTotal() {
        const total = Object.values(gameState.criteriaWeights).reduce((sum, w) => sum + (w || 0), 0);
        
        const totalEl = document.getElementById('weights-total');
        const wasNotHundred = totalEl.textContent !== '100';
        totalEl.textContent = total;
        totalEl.className = 'weights-value ' + (total < 100 ? 'under' : total > 100 ? 'over' : 'exact');
        
        const statusEl = document.getElementById('weights-status');
        if (total === 100) {
            statusEl.textContent = '✓ Perfect! Ready to continue';
            statusEl.className = 'weights-status valid';
            if (wasNotHundred) SoundManager.play('success');
        } else if (total < 100) {
            statusEl.textContent = `${100 - total} points remaining`;
            statusEl.className = 'weights-status';
        } else {
            statusEl.textContent = `${total - 100} points over limit`;
            statusEl.className = 'weights-status invalid';
        }
        
        // Enable/disable next button
        document.getElementById('weights-next').disabled = total !== 100;
    }
    
    function updateWeightsFormula() {
        const formula = document.getElementById('weights-formula');
        const terms = gameState.criteria
            .filter(c => gameState.criteriaWeights[c] > 0)
            .map((c, i, arr) => {
                const detail = criteriaDetails[c] || { short: c };
                const weight = gameState.criteriaWeights[c];
                return `
                    <span class="formula-term">
                        <span class="formula-weight">${weight}%</span>
                        <span class="formula-criteria">${detail.short}</span>
                    </span>
                    ${i < arr.length - 1 ? '<span class="formula-operator">+</span>' : ''}
                `;
            }).join('');
        
        formula.innerHTML = terms || '<span style="color: var(--gray-400);">Assign weights to see your formula</span>';
    }
    
    function distributeWeightsEvenly() {
        const count = gameState.criteria.length;
        const equalWeight = Math.floor(100 / count);
        const remainder = 100 - (equalWeight * count);
        
        gameState.criteria.forEach((c, i) => {
            gameState.criteriaWeights[c] = equalWeight + (i === 0 ? remainder : 0);
        });
        
        renderWeightsGrid();
    }
    
    function resetWeights() {
        gameState.criteria.forEach(c => {
            gameState.criteriaWeights[c] = 0;
        });
        renderWeightsGrid();
    }
    
    function confirmWeightsAndStart() {
        // Verify total is 100
        const total = Object.values(gameState.criteriaWeights).reduce((sum, w) => sum + (w || 0), 0);
        if (total !== 100) {
            alert('Please ensure your weights add up to exactly 100%');
            return;
        }
        
        // Proceed to project selection
        startProjectSelection();
    }
    
    // New function to show legacy portfolio first
    function confirmWeightsAndShowLegacy() {
        // Verify total is 100
        const total = Object.values(gameState.criteriaWeights).reduce((sum, w) => sum + (w || 0), 0);
        if (total !== 100) {
            alert('Please ensure your weights add up to exactly 100%');
            return;
        }
        
        // Generate and show legacy portfolio
        generateLegacyPortfolio();
        renderLegacyPortfolio();
        showPhase('legacy-portfolio');
    }
    
    // ============================================
    // LEGACY PORTFOLIO FUNCTIONS
    // ============================================
    
    function generateLegacyPortfolio() {
        // Lead assignments for legacy projects
        const legacyLeadAssignments = {
            'legacy-1': 'sanjay_gupta',      // SmartLock 2.0 - firmware expertise
            'legacy-2': 'ananya_das',        // Regional Language App - mobile
            'legacy-3': 'rahul_kumar',       // Executive Dashboard - enterprise
            'legacy-4': 'vikram_shah',       // ShieldOS 3.0 - platform
            'legacy-5': 'mohammed_ali',      // OEM White-Label - partnerships
            'legacy-6': 'arjun_reddy',       // Cost-Reduced Sensor - hardware
            'legacy-7': 'deepa_sharma'       // Cloud Migration - infrastructure
        };
        
        // Initialize legacy projects from templates with leads
        gameState.legacyProjects = legacyProjectTemplates.map(template => ({
            ...template,
            decision: 'continue', // Default decision
            lead: projectLeads.find(l => l.id === legacyLeadAssignments[template.id]) || getRandomProjectLead()
        }));
        
        // Calculate initial budget sums
        gameState.legacyBudget = {
            committed: gameState.legacyProjects.reduce((sum, p) => sum + p.remainingBudget, 0),
            spent: gameState.legacyProjects.reduce((sum, p) => sum + p.spentBudget, 0),
            freed: 0
        };
    }
    
    function renderLegacyPortfolio() {
        const container = document.getElementById('legacy-projects-container');
        if (!container) return;
        
        // Update summary stats
        const greenCount = gameState.legacyProjects.filter(p => p.status === 'green').length;
        const amberCount = gameState.legacyProjects.filter(p => p.status === 'amber').length;
        const redCount = gameState.legacyProjects.filter(p => p.status === 'red').length;
        
        document.getElementById('legacy-count').textContent = gameState.legacyProjects.length;
        document.getElementById('legacy-committed-budget').textContent = `$${gameState.legacyBudget.committed.toFixed(1)}M`;
        document.getElementById('legacy-sunk-cost').textContent = `$${gameState.legacyBudget.spent.toFixed(1)}M`;
        document.getElementById('legacy-green-count').textContent = `${greenCount} On Track`;
        document.getElementById('legacy-amber-count').textContent = `${amberCount} At Risk`;
        document.getElementById('legacy-red-count').textContent = `${redCount} Troubled`;
        
        // Render simplified project cards with inline decision buttons
        container.innerHTML = gameState.legacyProjects.map(project => {
            const budgetImpact = project.decision === 'continue' ? project.remainingBudget :
                project.decision === 'accelerate' ? (project.remainingBudget * 1.4) :
                project.decision === 'reduce_scope' ? (project.remainingBudget * 0.6) :
                project.decision === 'pause' ? (project.remainingBudget * 0.1) : 0;
            
            return `
            <div class="legacy-project-card status-${project.status}" id="legacy-card-${project.id}">
                <div class="legacy-card-header" style="cursor: default;">
                    <div style="flex: 1;">
                        <h3>
                            ${project.name}
                            <span class="legacy-badge inherited">Inherited</span>
                            <span class="legacy-status-badge ${project.status}">${project.status.toUpperCase()}</span>
                        </h3>
                        <p class="legacy-card-summary">${project.desc.substring(0, 120)}...</p>
                        <div class="legacy-card-metrics">
                            <span class="legacy-metric"><strong>${project.progress}%</strong> complete</span>
                            <span class="legacy-metric"><strong>$${project.remainingBudget}M </strong> remaining</span>
                            <span class="legacy-metric"><strong>${project.quartersRemaining}Q</strong> to finish</span>
                            <span class="legacy-metric">Alignment: <strong style="color: ${project.strategicAlignment === 'high' ? 'var(--success)' : project.strategicAlignment === 'medium' ? 'var(--warning)' : 'var(--danger)'};">${project.strategicAlignment}</strong></span>
                        </div>
                        
                        <div class="legacy-quick-actions" id="legacy-actions-${project.id}">
                            <button class="legacy-quick-btn decision-continue ${project.decision === 'continue' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'continue')" title="Continue as planned">
                                ▶️ Continue
                            </button>
                            <button class="legacy-quick-btn decision-accelerate ${project.decision === 'accelerate' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'accelerate')" title="Add resources, faster delivery (+40% cost)">
                                ⏩ Accelerate
                            </button>
                            <button class="legacy-quick-btn decision-reduce_scope ${project.decision === 'reduce_scope' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'reduce_scope')" title="Cut features, save 40%">
                                ✂️ Reduce
                            </button>
                            <button class="legacy-quick-btn decision-pause ${project.decision === 'pause' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'pause')" title="Stop work, keep option to resume (10% holding cost)">
                                ⏸️ Pause
                            </button>
                            <button class="legacy-quick-btn decision-kill ${project.decision === 'kill' ? 'selected' : ''}" 
                                    onclick="setLegacyDecisionQuick('${project.id}', 'kill')" title="Terminate and free budget">
                                ⛔ Kill
                            </button>
                        </div>
                    </div>
                    <div class="legacy-card-right">
                        <div class="legacy-budget-impact" id="legacy-budget-${project.id}">
                            <div class="amount">$${budgetImpact.toFixed(1)}M </div>
                            <div class="label">Budget Required</div>
                        </div>
                        <span class="legacy-details-link" onclick="openLegacyModal('${project.id}')">
                            📋 View full details →
                        </span>
                    </div>
                </div>
            </div>
        `}).join('');
        
        updateLegacyBudgetSummary();
    }
    
    // Quick decision setter for legacy cards (no modal)
    function setLegacyDecisionQuick(projectId, decision) {
        const project = gameState.legacyProjects.find(p => p.id === projectId);
        if (!project) return;
        
        project.decision = decision;
        
        // Update button states
        const actionsContainer = document.getElementById(`legacy-actions-${projectId}`);
        if (actionsContainer) {
            actionsContainer.querySelectorAll('.legacy-quick-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = actionsContainer.querySelector(`.decision-${decision}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }
        
        // Update budget display
        const budgetImpact = decision === 'continue' ? project.remainingBudget :
            decision === 'accelerate' ? (project.remainingBudget * 1.4) :
            decision === 'reduce_scope' ? (project.remainingBudget * 0.6) :
            decision === 'pause' ? (project.remainingBudget * 0.1) : 0;
        
        const budgetEl = document.getElementById(`legacy-budget-${projectId}`);
        if (budgetEl) {
            budgetEl.innerHTML = `
                <div class="amount" style="color: ${decision === 'kill' ? 'var(--success)' : 'var(--primary)'};">
                    ${decision === 'kill' ? '$0' : '$' + budgetImpact.toFixed(1)} M
                </div>
                <div class="label">${decision === 'kill' ? 'Budget Freed' : 'Budget Required'}</div>
            `;
        }
        
        // Update summary
        updateLegacyBudgetSummary();
    }
    
    function openLegacyModal(projectId) {
        const project = gameState.legacyProjects.find(p => p.id === projectId);
        if (!project) return;
        
        gameState.currentLegacyProject = projectId;
        
        // Populate modal header
        document.getElementById('legacy-modal-name').textContent = project.name;
        document.getElementById('legacy-modal-progress').textContent = `${project.progress}%`;
        
        const statusBadge = document.getElementById('legacy-modal-status');
        statusBadge.textContent = project.status.toUpperCase();
        statusBadge.className = `legacy-status-badge ${project.status}`;
        
        // Project overview
        document.getElementById('legacy-modal-desc').textContent = project.desc;
        
        // Strategic alignment
        const alignmentColor = project.strategicAlignment === 'high' ? 'var(--success)' : 
            project.strategicAlignment === 'medium' ? 'var(--warning)' : 'var(--danger)';
        document.getElementById('legacy-modal-alignment').innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <span style="font-weight: 600; color: ${alignmentColor}; text-transform: uppercase;">${project.strategicAlignment} Alignment</span>
            </div>
            <p style="color: var(--gray-600); margin: 0;">${project.alignmentNote}</p>
        `;
        
        // Budget status
        const progressPct = (project.spentBudget / project.totalBudget) * 100;
        document.getElementById('legacy-modal-budget').innerHTML = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
                <div class="financial-item" style="background: var(--gray-100);">
                    <div class="value" style="color: var(--gray-600);">$${project.spentBudget}M </div>
                    <div class="label">Already Spent (Sunk Cost)</div>
                </div>
                <div class="financial-item" style="background: var(--primary-lighter);">
                    <div class="value">$${project.remainingBudget}M </div>
                    <div class="label">Remaining to Complete</div>
                </div>
                <div class="financial-item" style="background: var(--gold-light);">
                    <div class="value" style="color: var(--gold-dark);">$${project.totalBudget}M </div>
                    <div class="label">Total Budget</div>
                </div>
                <div class="financial-item">
                    <div class="value">${project.teamSize}</div>
                    <div class="label">Team Members</div>
                </div>
                <div class="financial-item">
                    <div class="value">${project.quartersRemaining}Q</div>
                    <div class="label">Quarters Remaining</div>
                </div>
            </div>
            <div style="background: var(--gray-100); border-radius: 8px; height: 10px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%); height: 100%; width: ${progressPct}%; border-radius: 8px;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: var(--gray-500); margin-top: 5px;">
                <span>${project.progress}% complete</span>
                <span>${progressPct.toFixed(0)}% of budget consumed</span>
            </div>
        `;
        
        // External commitments
        document.getElementById('legacy-modal-commitments').textContent = project.externalCommitment;
        
        // Political context
        document.getElementById('legacy-modal-politics').textContent = project.politicalContext;
        
        // Project history timeline
        document.getElementById('legacy-modal-history').innerHTML = `
            <div class="legacy-timeline">
                ${project.quarterlyUpdates.map(update => `
                    <div class="legacy-timeline-item status-${update.status}">
                        <div class="legacy-timeline-quarter">Q${update.quarter < 0 ? update.quarter : '+' + update.quarter}</div>
                        <div class="legacy-timeline-narrative">${update.narrative}</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Project lead
        document.getElementById('legacy-modal-lead').innerHTML = project.lead ? 
            renderLeadCard(project.lead) : 
            '<p style="color: var(--gray-500);">No lead currently assigned.</p>';
        
        // Risk assessment
        document.getElementById('legacy-modal-risks').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="legacy-risk-box" style="display: block; margin: 0;">
                    <h5>⚠️ Risk if Continued</h5>
                    <p>${project.riskIfContinued}</p>
                </div>
                <div class="legacy-risk-box risk-kill" style="display: block; margin: 0;">
                    <h5>💥 Risk if Killed</h5>
                    <p>${project.riskIfKilled}</p>
                </div>
            </div>
        `;
        
        // Decision options
        document.getElementById('legacy-modal-decisions').innerHTML = Object.entries(legacyDecisionOptions).map(([key, option]) => {
            const budgetAmount = key === 'continue' ? project.remainingBudget :
                key === 'accelerate' ? (project.remainingBudget * 1.4) :
                key === 'reduce_scope' ? (project.remainingBudget * 0.6) :
                key === 'pause' ? (project.remainingBudget * 0.1) : 0;
            const freedAmount = project.remainingBudget - budgetAmount;
            
            return `
                <button class="legacy-decision-btn decision-${key} ${project.decision === key ? 'selected' : ''}" 
                        onclick="setLegacyDecision('${project.id}', '${key}')">
                    <span class="decision-icon">${option.icon}</span>
                    <span class="decision-label">${option.label}</span>
                    <span class="decision-desc">
                        ${key === 'kill' ? 'Frees $' + project.remainingBudget.toFixed(1) + 'M' :
                          key === 'pause' ? 'Frees $' + freedAmount.toFixed(1) + 'M' :
                          '$' + budgetAmount.toFixed(1) + 'M'}
                    </span>
                </button>
            `;
        }).join('');
        
        // Budget impact preview
        updateLegacyModalImpact(project);
        
        // Show modal
        document.getElementById('legacy-project-modal').classList.remove('hidden');
    }
    
    function updateLegacyModalImpact(project) {
        const option = legacyDecisionOptions[project.decision];
        const budgetAmount = project.remainingBudget * option.budgetImpact;
        const freedAmount = project.remainingBudget - budgetAmount;
        
        document.getElementById('legacy-modal-impact').innerHTML = `
            <div style="display: flex; gap: 20px; padding: 15px; background: ${freedAmount > 0 ? 'var(--success-light)' : 'var(--primary-lighter)'}; border-radius: 8px;">
                <div>
                    <div style="font-size: 0.8em; color: var(--gray-600);">Budget Required</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--primary);">$${budgetAmount.toFixed(1)}M </div>
                </div>
                ${freedAmount > 0 ? `
                <div>
                    <div style="font-size: 0.8em; color: var(--gray-600);">Budget Freed</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--success);">+$${freedAmount.toFixed(1)}M </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    function closeLegacyModal() {
        document.getElementById('legacy-project-modal').classList.add('hidden');
        gameState.currentLegacyProject = null;
    }
    
    function setLegacyDecision(projectId, decision) {
        const project = gameState.legacyProjects.find(p => p.id === projectId);
        if (!project) return;
        
        project.decision = decision;
        
        // Update button states in modal if open
        const modal = document.getElementById('legacy-project-modal');
        if (!modal.classList.contains('hidden')) {
            modal.querySelectorAll('.legacy-decision-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            modal.querySelector(`.decision-${decision}`).classList.add('selected');
            updateLegacyModalImpact(project);
        }
        
        // Update card quick buttons
        const actionsContainer = document.getElementById(`legacy-actions-${projectId}`);
        if (actionsContainer) {
            actionsContainer.querySelectorAll('.legacy-quick-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = actionsContainer.querySelector(`.decision-${decision}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }
        
        // Update card budget display
        const budgetImpact = decision === 'continue' ? project.remainingBudget :
            decision === 'accelerate' ? (project.remainingBudget * 1.4) :
            decision === 'reduce_scope' ? (project.remainingBudget * 0.6) :
            decision === 'pause' ? (project.remainingBudget * 0.1) : 0;
        
        const budgetEl = document.getElementById(`legacy-budget-${projectId}`);
        if (budgetEl) {
            budgetEl.innerHTML = `
                <div class="amount" style="color: ${decision === 'kill' ? 'var(--success)' : 'var(--primary)'};">
                    ${decision === 'kill' ? '$0' : '$' + budgetImpact.toFixed(1)} M
                </div>
                <div class="label">${decision === 'kill' ? 'Budget Freed' : 'Budget Required'}</div>
            `;
        }
        
        updateLegacyBudgetSummary();
    }
    
    function updateLegacyBudgetSummary() {
        let newCommitted = 0;
        let freed = 0;
        
        gameState.legacyProjects.forEach(project => {
            const option = legacyDecisionOptions[project.decision];
            const impact = project.remainingBudget * option.budgetImpact;
            newCommitted += impact;
            
            if (project.decision === 'kill' || project.decision === 'pause') {
                freed += project.remainingBudget - impact;
            } else if (project.decision === 'reduce_scope') {
                freed += project.remainingBudget * 0.4; // 40% freed from scope reduction
            }
        });
        
        gameState.legacyBudget.committed = newCommitted;
        gameState.legacyBudget.freed = freed;
        
        // Update UI
        document.getElementById('legacy-new-budget').textContent = `$${newCommitted.toFixed(1)}M`;
        document.getElementById('legacy-freed-budget').textContent = `$${freed.toFixed(1)}M`;
        
        // Calculate available for new projects (base budget + freed from legacy)
        // Base budget for new projects + any freed legacy budget
        const baseBudgetForNew = gameState.maxBudget; // Use the game's max budget
        const availableForNew = baseBudgetForNew + freed;
        document.getElementById('available-for-new').textContent = availableForNew.toFixed(1);
    }
    
    function confirmLegacyDecisions() {
        // Calculate the budget impact of legacy decisions
        let legacyBudgetCommitted = 0;
        
        gameState.legacyProjects.forEach(project => {
            const option = legacyDecisionOptions[project.decision];
            const impact = project.remainingBudget * option.budgetImpact;
            legacyBudgetCommitted += impact;
        });
        
        // Store legacy budget commitment in game state
        gameState.legacyBudgetCommitted = legacyBudgetCommitted;
        
        // CORRECT BUDGET CALCULATION:
        // Available for new projects = Annual budget - Legacy commitments
        // If you kill a project (budgetImpact=0), it doesn't consume budget
        // If you continue a project (budgetImpact=1.0), it consumes its remaining budget
        gameState.budget = gameState.maxBudget - legacyBudgetCommitted;
        
        // Move killed/paused projects to a separate list
        gameState.killedProjects = gameState.legacyProjects.filter(p => p.decision === 'kill');
        gameState.pausedProjects = gameState.legacyProjects.filter(p => p.decision === 'pause');
        
        // Keep active legacy projects (they'll appear in the portfolio alongside new selections)
        gameState.activeLegacyProjects = gameState.legacyProjects.filter(p => 
            !['kill', 'pause'].includes(p.decision)
        );
        
        // Now proceed to new project selection
        startProjectSelection();
    }
    
    // ============================================
    // GAME LOGIC
    // ============================================
    
    function calculateCommitteeEffects() {
        const effects = { technical: 1, market: 1, strategic: 1, team: 1, cost: 1, hiddenGem: 1, slowBurner: 1, paperTiger: 1, moneyPit: 1, conventionalWinner: 1, conventionalLoser: 1, pivotSuccess: 1 };
        
        gameState.committee.forEach(staffId => {
            const staff = findStaff(staffId);
            if (staff && staff.effects) {
                Object.keys(staff.effects).forEach(key => {
                    effects[key] = (effects[key] || 1) * staff.effects[key];
                });
            }
        });
        
        return effects;
    }
    
    function generateProjectPool() {
        const pool = [];
        const usedNames = new Set();
        const effects = calculateCommitteeEffects();
        
        let projectId = 1;
        
        // Target pool size: random between 10-12 projects (manageable to review)
        const targetPoolSize = 10 + Math.floor(Math.random() * 3);
        
        // Minimum total budget should be ~2.5x the max possible budget (50M * 2.5 = 125M)
        // Budget multiplier creates scarcity while keeping projects affordable enough for 4-6 selections
        const minTotalBudget = 100;
        const budgetMultiplier = 1.3;
        
        // Shuffle templates
        const shuffled = shuffleArray([...projectTemplates]);
        
        let totalBudget = 0;
        let templateIndex = 0;
        
        // Keep generating until we have enough projects AND enough total budget
        while ((pool.length < targetPoolSize || totalBudget < minTotalBudget) && templateIndex < shuffled.length) {
            const template = shuffled[templateIndex];
            
            // Pick 1-2 projects from each template
            const count = 1 + Math.floor(Math.random() * 2);
            const indices = shuffleArray([...Array(template.names.length).keys()]).slice(0, count);
            
            for (const i of indices) {
                const name = template.names[i];
                if (usedNames.has(name)) continue;
                usedNames.add(name);
                
                const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                const budget = Math.round(budgetRaw * budgetMultiplier * 10) / 10; // Apply multiplier and round to 1 decimal
                
                // Get risk classification for this archetype
                const riskClass = getProjectRiskClassForProject(name, template.archetype);
                const desc = (template.descs && (template.descs[i] || template.descs[0])) ? (template.descs[i] || template.descs[0]) : '';
                const successRange = riskClassSuccessProb[riskClass];
                const roiRange = riskClassROI[riskClass];
                
                // Calculate success probability based on risk class (with some variance)
                let successProb = successRange.min + Math.random() * (successRange.max - successRange.min);
                
                // Calculate ROI multiplier for this project
                const roiMultiplier = roiRange.min + Math.random() * (roiRange.max - roiRange.min);
                
                // Apply committee effects based on archetype
                const archetypeMapping = {
                    'conventional_winner': 'conventionalWinner',
                    'conventional_loser': 'conventionalLoser',
                    'hidden_gem': 'hiddenGem',
                    'slow_burner': 'slowBurner',
                    'paper_tiger': 'paperTiger',
                    'money_pit': 'moneyPit',
                    'pivot_success': 'pivotSuccess',
                    'sustainability_play': 'sustainability',
                    'ip_fortress': 'ip',
                    'team_dependent': 'team',
                    'competitive_casualty': 'competitive'
                };
                const mappedKey = archetypeMapping[template.archetype];
                if (mappedKey && effects[mappedKey]) {
                    successProb *= effects[mappedKey];
                }
                
                pool.push({
                    id: 'proj-' + projectId,
                    numId: projectId,
                    name: name,
                    desc: desc,
                    shortDesc: desc,
                    tagline: getTagline(template.archetype),
                    fullDesc: generateFullDesc(name, template.descs[i], template.archetype),
                    marketContext: generateProjectMarketContext(name, desc, template.archetype, riskClass),
                    capabilityFit: generateCapabilityFit(template.archetype, template.scores.capability),
                    risks: generateRisks(template.archetype),
                    teamNote: generateTeamNote(template.archetype),
                    teamDetails: generateTeamDetails(name, template.archetype, template.scores),
                    strategicBuckets: getStrategicBuckets(template.archetype),
                    trl: getTRL(template.archetype),
                    ipPosition: getIPPosition(template.archetype, name),
                    competitors: generateProjectCompetitors(name, template.archetype, riskClass),
                    developmentCosts: getDevelopmentCosts(budget, template.archetype),
                    milestones: getMilestones(template.archetype, budget),
                    financials: generateFinancials(budget, template.archetype),
                    synergies: generateSynergies(name, template.archetype),
                    archetype: template.archetype,
                    riskClass: riskClass,
                    
                    roiMultiplier: roiMultiplier,
                    budget: budget,
                    successProb: Math.max(0.05, Math.min(0.95, successProb)),
                    scores: { ...template.scores },
                    quarterNarratives: template.quarterNarratives,
                    outcomeNarrative: template.outcomeNarrative,
                    pivotRequired: template.pivotRequired || false,
                    teamSensitive: template.teamSensitive || false,
                    timeline: getTimelineForProject(name, template.archetype, riskClass),
                    status: 'proposed',
                    currentQuarter: 0,
                    spentBudget: 0,
                    quarterlyUpdates: [],
                    decision: null,
                    outcome: null,
                    playerScores: {},
                    committeeScores: {},
                    lead: assignProjectLead(template.archetype, template.scores)
                });
                
                totalBudget += budget;
                projectId++;
                
                // Stop if we have enough projects AND enough budget
                if (pool.length >= targetPoolSize && totalBudget >= minTotalBudget) break;
            }
            
            templateIndex++;
        }
        balanceProjectPoolByRisk(pool, 'year1');
        pool.forEach(ensureProjectCompleteness);
        return pool;
    }
    
    function getTimelineByArchetype(archetype) {
        // Different project types have different realistic development timelines
        // This ensures portfolio doesn't empty out during the 8-quarter game
        const timelineRanges = {
            // Long-term research/platform projects (10-12 quarters) - extend beyond game
            'frontier_tech': { min: 10, max: 12 },
            'moonshot': { min: 11, max: 12 },
            'platform_infrastructure': { min: 9, max: 12 },
            'slow_burner': { min: 9, max: 12 },
            
            // Medium-term strategic projects (8-11 quarters)
            'premium_flagship': { min: 8, max: 11 },
            'paper_tiger': { min: 8, max: 11 },
            'money_pit': { min: 9, max: 12 },
            'niche_vertical': { min: 8, max: 10 },
            'market_explorer': { min: 8, max: 10 },
            'ip_fortress': { min: 8, max: 11 },
            
            // Standard projects (8-10 quarters) - span the full game
            'core_upgrade': { min: 8, max: 10 },
            'conventional_winner': { min: 8, max: 10 },
            'conventional_loser': { min: 8, max: 11 },
            'hidden_gem': { min: 8, max: 10 },
            'pivot_success': { min: 8, max: 10 },
            'team_dependent': { min: 8, max: 10 },
            'sustainability_play': { min: 8, max: 10 },
            'esg_initiative': { min: 8, max: 10 },
            'underserved_market': { min: 8, max: 10 },
            
            // Previously shorter projects - now 8-9 quarters to ensure game-length duration
            'value_segment': { min: 8, max: 10 },
            'price_fighter': { min: 8, max: 10 },
            'competitive_casualty': { min: 8, max: 10 },
            'defensive': { min: 8, max: 10 },
            
            // Service/product archetypes (8-10 quarters)
            'visitor_flow': { min: 8, max: 10 },
            'security_score': { min: 8, max: 10 },
            'smart_key_control': { min: 8, max: 10 },
            'emergency_muster': { min: 8, max: 10 },
            'night_escort': { min: 8, max: 10 },
            'guard_training_sim': { min: 8, max: 10 },
            'incident_invoice': { min: 8, max: 10 },
            'parking_security': { min: 8, max: 10 },
            'shrink_prevention': { min: 8, max: 10 },
            'alarm_response_network': { min: 8, max: 11 },
            'camera_subscription': { min: 8, max: 10 },
            'privacy_analytics': { min: 8, max: 10 },
            'guard_tour_proof': { min: 8, max: 10 },
            'smart_intercom': { min: 8, max: 10 },
            'wander_management': { min: 8, max: 10 },
            'contractor_screening': { min: 8, max: 10 },
            'ai_video_search': { min: 9, max: 12 },
            'safety_security_soc': { min: 8, max: 11 },
            'anti_drone_service': { min: 8, max: 11 },
            'predictive_door_maintenance': { min: 8, max: 10 }
        };
        
        const range = timelineRanges[archetype] || { min: 8, max: 10 };
        return range.min + Math.floor(Math.random() * (range.max - range.min + 1));
    }
    
    function getTagline(archetype) {
        const taglines = {
            'conventional_winner': 'Proven opportunity with clear path to success',
            'conventional_loser': 'Ambitious technology with uncertain feasibility',
            'hidden_gem': 'Overlooked opportunity in an underserved segment',
            'slow_burner': 'Long-term strategic play requiring patience',
            'paper_tiger': 'Impressive specs but execution challenges ahead',
            'money_pit': 'High ambition project with scope risk',
            'pivot_success': 'Flexible concept that may need to evolve',
            'team_dependent': 'Success depends heavily on key people',
            'competitive_casualty': 'Value play in a price-competitive segment',
            'sustainability_play': 'ESG-focused product for conscious consumers',
            'ip_fortress': 'Innovation with strong IP protection potential'
        };
        return taglines[archetype] || 'Strategic opportunity for growth';
    }
    
    function generateFullDesc(name, shortDesc, archetype) {
        // The short description now contains product details, so fullDesc adds strategic context
        const strategicContext = {
            'conventional_winner': `This project builds on ShieldTech's proven capabilities and addresses validated market demand. The technology path is well-understood and supplier relationships are established. Key success factors: execution quality, maintaining differentiation, and timing the launch window. Risk profile: Lower technical risk, moderate competitive risk.`,
            'conventional_loser': `This ambitious research initiative explores breakthrough technology that could establish ShieldTech as an innovation leader. Academic partnerships provide access to world-class expertise, and the extended timeline allows methodical de-risking through stage-gated investment. Key success factors: research breakthroughs, talent retention, and patient capital. Risk profile: Higher technical uncertainty, but transformative upside if successful.`,
            'hidden_gem': `This project targets an underserved segment with passionate users that mainstream competitors have overlooked. Early customer research shows strong unmet demand and willingness to pay premium prices. The focused scope keeps development lean while niche positioning reduces competitive pressure. Key success factors: deep customer understanding, community building, and word-of-mouth growth. Risk profile: Market validation risk, but limited downside and loyal customer potential.`,
            'slow_burner': `This strategic platform investment builds foundational capabilities with compounding returns. While early metrics may appear modest, ecosystem control and partner lock-in create durable competitive advantage. Key success factors: sustained commitment, partner acquisition, and patience through the J-curve. Risk profile: Execution timeline risk, but strategic value compounds over time.`,
            'paper_tiger': `This technically ambitious project demonstrates ShieldTech's engineering leadership in premium segments. The specifications would lead the market and command premium pricing. Modular architecture enables incremental validation. Key success factors: integration discipline, quality focus, and premium positioning. Risk profile: Higher complexity risk, but strong margin potential and brand halo effects.`,
            'money_pit': `This foundational infrastructure investment addresses technical debt constraining future growth. Phased delivery with clear milestones ensures business continuity while enabling capability transformation. Comparable rewrites at peer companies have delivered substantial operational efficiencies. Key success factors: scope discipline, stakeholder alignment, and milestone-based governance. Risk profile: Execution and timeline risk, but enables future product velocity.`,
            'pivot_success': `This exploratory project tests new market directions with minimal upfront commitment. The lean approach emphasises validated learning, with explicit decision points to scale winning directions or redirect quickly. Key success factors: rapid experimentation, market listening, and pivot readiness. Risk profile: Direction uncertainty, but structured to limit downside while preserving optionality.`,
            'team_dependent': `This project leverages exceptional talent with unique domain expertise and strong track record. The team's capabilities make ambitious outcomes possible. Clear knowledge transfer plans ensure organisational learning. Key success factors: team retention, autonomy, and executive sponsorship. Risk profile: Concentration risk on key individuals, but high ceiling with right team.`,
            'competitive_casualty': `This project responds to market pressure with a cost-optimised offering leveraging ShieldTech's scale advantages. Aggressive timeline tests execution speed and operational discipline. Key success factors: supply chain optimisation, disciplined scope, and channel partnerships. Risk profile: Margin pressure and competitive response, but strengthens market position if executed well.`,
            'sustainability_play': `This project positions ShieldTech at the forefront of sustainable product development as consumer and regulatory interest grows. First-mover advantage in green security products creates brand differentiation and premium positioning. Key success factors: authentic sustainability credentials, certification, and effective storytelling. Risk profile: Market timing and premium realisation, but growing tailwinds and PR value.`,
            'ip_fortress': `This project builds proprietary technology protected by strong intellectual property. Patent filings create defensive moats against commoditisation and potential licensing revenue. Key success factors: novel innovation, IP prosecution, and enforcement readiness. Risk profile: Technical and legal complexity, but durable competitive advantage if patents hold.`
        };
        
        return shortDesc + '\n\n' + (strategicContext[archetype] || '');
    }
    
    

    // Generic helpers so every project has complete Market & Competition details (even for newer archetypes)
    function inferMarketDomainFromArchetype(archetype) {
        const a = (archetype || '').toLowerCase();
        if (a.includes('drone') || a.includes('uav')) return 'drones & counter-drone security';
        if (a.includes('guard') || a.includes('patrol') || a.includes('tour') || a.includes('contractor') || a.includes('response')) return 'guarding & field operations';
        if (a.includes('video') || a.includes('camera') || a.includes('vms') || a.includes('nvr') || a.includes('cv')) return 'video surveillance & analytics';
        if (a.includes('cyber') || a.includes('deepfake') || a.includes('soc')) return 'cyber-physical security operations';
        if (a.includes('compliance') || a.includes('evidence') || a.includes('chain') || a.includes('invoice') || a.includes('audit')) return 'compliance, evidence & governance';
        if (a.includes('digital_twin') || a.includes('twin')) return 'digital twins & operational intelligence';
        if (a.includes('subscription') || a.includes('saas') || a.includes('platform')) return 'subscription software & platforms';
        if (a.includes('training') || a.includes('sim')) return 'training, enablement & safety';
        if (a.includes('acquisition') || a.includes('integration')) return 'M&A integration & platform consolidation';
        return 'security technology & services';
    }

    function generateMarketContextFallback(archetype) {
        const domain = inferMarketDomainFromArchetype(archetype);
        const a = (archetype || '').toLowerCase();

        const buyer = (
            a.includes('enterprise') || a.includes('soc') || a.includes('compliance') ? 'mid-to-large enterprises and regulated operators' :
            a.includes('home') || a.includes('consumer') ? 'urban consumers and residential societies' :
            a.includes('guard') || a.includes('patrol') ? 'security service providers and facility managers' :
            'operators across residential, commercial, and public-sector segments'
        );

        const differentiation = (
            a.includes('ai') || a.includes('ml') || a.includes('cv') ? 'measurable accuracy/latency gains, reliable edge deployment, and an operational feedback loop that improves models over time' :
            a.includes('subscription') ? 'clear ROI for recurring fees, low-friction onboarding, and retention-driving product value' :
            a.includes('integration') ? 'reduced complexity, cleaner workflows, and lower total cost of ownership versus fragmented tooling' :
            'execution quality, distribution, and defensible operating advantages'
        );

        return `This project targets the ${domain} market, with primary buyers being ${buyer}. Success depends on ${differentiation}. Competitive pressure will come from incumbents bundling features and focused specialists moving faster—so a crisp wedge, strong GTM, and proof of value in early pilots will be key.`;
    }


    // ============================================================
    // Per-project (name-specific) market + competitor storytelling
    // Ensures every R&D project feels unique (no generic placeholders)
    // ============================================================

    function _hashStringToSeed(str) {
        // FNV-1a 32-bit
        let h = 2166136261;
        for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 16777619);
        }
        return h >>> 0;
    }

    function _mulberry32(a) {
        return function() {
            let t = a += 0x6D2B79F5;
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
    }

    function _rngForKey(key) {
        return _mulberry32(_hashStringToSeed(String(key || '')));
    }

    function _pick(arr, rng) {
        if (!Array.isArray(arr) || arr.length === 0) return null;
        return arr[Math.floor(rng() * arr.length)];
    }

    function _pickN(arr, n, rng) {
        const a = Array.isArray(arr) ? [...arr] : [];
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(rng() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a.slice(0, Math.max(0, Math.min(n, a.length)));
    }

    function _isRAndDArchetype(archetype) {
        const a = String(archetype || '').toLowerCase();
        const set = new Set([
            'frontier_tech','proprietary_tech','platform_infrastructure','ai_guard_innovation',
            'ai_video_search','autonomous_drone','ground_robot','digital_twin','perimeter_fusion',
            'cyber_physical_soc','acoustic_detection','deepfake_defense','predictive_risk','anti_drone_service',
            'safety_security_soc','moonshot'
        ]);
        return set.has(a);
    }

    function getProjectRiskClassForProject(name, archetype) {
        const base = getProjectRiskClass(archetype) || 'moderate';
        const rng = _rngForKey('risk|' + name + '|' + archetype);

        // Keep non-R&D archetypes stable.
        if (!_isRAndDArchetype(archetype)) return base;

        // Within R&D projects, introduce variety so not everything is "high risk".
        // Still anchored to the base archetype classification.
        if (base === 'transformational') {
            // Some projects are "applied R&D" (still hard, but less moonshot).
            return rng() < 0.28 ? 'moderate' : 'transformational';
        }
        if (base === 'moderate') {
            // Occasionally a "low-risk R&D" (integration-heavy, proven components).
            return rng() < 0.18 ? 'incremental' : 'moderate';
        }
        return base;
    }

    function getTimelineForProject(name, archetype, riskClass) {
        const rng = _rngForKey('timeline|' + name + '|' + archetype);
        let t = getTimelineByArchetype(archetype);

        const n = (String(name || '') + ' ' + String(archetype || '')).toLowerCase();

        // R&D tends to run longer; calibrate beyond the 8-quarter play window.
        if (riskClass === 'transformational') {
            t = Math.max(t, 9 + Math.floor(rng() * 4)); // 9-12 quarters
        } else if (riskClass === 'moderate') {
            t = Math.max(t, 8 + Math.floor(rng() * 3)); // 8-10 quarters
        }

        // Platform/robotics/drone/digital-twin programs typically slip longer.
        if (/(platform|infrastructure|twin|soc|drone|robot|fusion|qkd|quantum)/.test(n)) {
            t = Math.min(12, t + 1);
        }

        return Math.max(6, Math.min(12, t));
    }

    function _extractWedge(name, desc, archetype) {
        const s = (String(name || '') + ' ' + String(desc || '') + ' ' + String(archetype || '')).toLowerCase();
        if (s.includes('quantum') || s.includes('qkd') || s.includes('post-quantum')) return 'quantum‑resistant trust and key management';
        if (s.includes('neuromorphic') || s.includes('retina') || s.includes('10,000')) return 'ultra‑low‑power, high‑speed event vision';
        if (s.includes('holo') || s.includes('holog')) return 'deterrence-through-presence (visual deception) with measurable response lift';
        if (s.includes('drone')) return 'autonomous patrol operations with DGCA‑compliant workflows';
        if (s.includes('robot')) return 'always‑on deterrence plus consistent patrol data';
        if (s.includes('deepfake') || s.includes('voice cloning')) return 'liveness, channel verification, and policy guardrails against social engineering';
        if (s.includes('radar') || s.includes('doppler') || s.includes('fusion')) return 'sensor fusion that reduces false alarms in cluttered sites';
        if (s.includes('edge') || s.includes('on-device') || s.includes('offline')) return 'reliable edge inference under poor connectivity and low-end devices';
        if (s.includes('subscription') || s.includes('as-a-service') || s.includes('monitor')) return 'retention-driving service quality with provable SLA outcomes';
        if (s.includes('privacy') || s.includes('anonym') || s.includes('federated')) return 'privacy-preserving analytics with auditable controls';
        if (s.includes('blockchain') || s.includes('chain-of-custody') || s.includes('evidence')) return 'tamper-resistant evidence with courtroom-ready audit trails';
        if (s.includes('solar') || s.includes('lifepo') || s.includes('energy')) return 'off-grid reliability and lower lifecycle cost';
        if (s.includes('biometric') || s.includes('fingerprint') || s.includes('facial')) return 'high-accuracy identity at the door with local-language UX';
        return 'a differentiated workflow + product wedge that improves outcomes and reduces total cost of ownership';
    }

    function generateProjectCompetitors(name, archetype, riskClass) {
        const rng = _rngForKey('comp|' + name + '|' + archetype);
        const a = String(archetype || '').toLowerCase();
        const wedge = _extractWedge(name, '', archetype);

        const pools = {
            consumer: ['Hikvision', 'Dahua', 'CP Plus', 'Godrej Security', 'Yale (ASSA ABLOY)', 'Xiaomi/Tapo', 'Qubo (Hero Group)', 'Imou/Lechange'],
            enterprise: ['Honeywell', 'Genetec', 'Milestone', 'Eagle Eye Networks', 'Motorola Solutions', 'Johnson Controls', 'Siemens', 'Bosch Security'],
            ai: ['BriefCam', 'Avigilon', 'Verkada', 'Cisco Meraki', 'ServiceNow (workflows)', 'Staqu (India)', 'AnyVision/Local CV vendors', 'Cloud-first challengers'],
            drone: ['ideaForge', 'DJI Enterprise', 'Percepto', 'Skydio', 'Local drone integrators', 'BEL / defense integrators', 'Event security vendors', 'Airport/infra incumbents'],
            robotics: ['Knightscope', 'Cobalt Robotics', 'Local robotics startups', 'Facility management incumbents', 'Traditional guarding (agencies)', 'Integrator-led automation', 'Industrial AMR vendors'],
            compliance: ['ServiceNow GRC', 'Resolver', 'MetricStream', 'Audit consultancies', 'In-house spreadsheets', 'Local compliance SaaS'],
            platform: ['Open VMS ecosystems', 'Hikvision/Dahua analytics', 'Genetec Marketplace', 'Integrator custom stacks', 'Cloud-first challengers', 'PSIM incumbents']
        };

        let pool = pools.enterprise;
        if (a.includes('drone')) pool = pools.drone;
        else if (a.includes('robot')) pool = pools.robotics;
        else if (a.includes('ai') || a.includes('video') || a.includes('search') || a.includes('deepfake')) pool = pools.ai;
        else if (a.includes('compliance') || a.includes('privacy') || a.includes('evidence')) pool = pools.compliance;
        else if (a.includes('platform') || a.includes('soc') || a.includes('twin') || a.includes('fusion')) pool = pools.platform;
        else if (a.includes('home') || a.includes('lock') || a.includes('camera') || a.includes('sensor') || a.includes('intercom')) pool = pools.consumer;

        const picks = _pickN(pool, 4, rng);
        const threatByRisk = riskClass === 'transformational' ? ['High','High','Medium','Medium'] :
                             riskClass === 'moderate' ? ['High','Medium','Medium','Low'] :
                             ['Medium','Medium','Low','Low'];

        return picks.map((c, idx) => {
            const type = String(c).toLowerCase();
            const isIncumbent = /hikvision|dahua|honeywell|genetec|milestone|motorola|siemens|bosch|johnson/.test(type);
            const isStatusQuo = /integrator|consult|spreadsheets|in-house|agenc/.test(type);

            let position = '';
            if (isIncumbent) {
                position = 'Incumbent that can bundle adjacent features, lean on channel power, and compress prices during tenders.';
            } else if (isStatusQuo) {
                position = 'Status-quo alternative that wins via relationships and procurement familiarity, even if the tech is less differentiated.';
            } else {
                position = 'Focused competitor pitching a narrow wedge and faster time-to-value; strong at demos and early pilots.';
            }

            const twist = _pick([
                `They will challenge our wedge on ${wedge}.`,
                'They compete by promising quicker deployment and lower operator training.',
                'They will undercut on unit economics or subscription pricing to win pilots.',
                'They focus on one vertical (logistics, campuses, retail) with deep workflow fit.',
                'They may win regulated deals via certifications and tender relationships.'
            ], rng);

            return {
                name: c,
                position: position + ' ' + twist,
                threat: threatByRisk[idx] || (isIncumbent ? 'High' : 'Medium')
            };
        });
    }

    function generateProjectMarketContext(name, desc, archetype, riskClass) {
        const rng = _rngForKey('market|' + name + '|' + archetype);
        const domain = inferMarketDomainFromArchetype(archetype);
        const wedge = _extractWedge(name, desc, archetype);

        const a = String(archetype || '').toLowerCase();
        const buyer = (
            a.includes('enterprise') || a.includes('soc') || a.includes('compliance') || a.includes('platform') ? 'enterprise security heads, facility directors, and system integrators' :
            a.includes('drone') || a.includes('robot') ? 'large-site operators buying outcomes (response time, deterrence, coverage) rather than gadgets' :
            a.includes('home') || a.includes('lock') || a.includes('camera') || a.includes('sensor') || a.includes('intercom') ? 'urban households and gated communities (often via installers or online marketplaces)' :
            a.includes('guard') || a.includes('patrol') ? 'security agencies and enterprise supervisors standardizing guard performance' :
            'buyers across residential, commercial, and public-sector segments'
        );

        const tam = Math.round(180 + rng() * 920); // $180M - $1.10B
        const cagr = Math.round(12 + rng() * 22);  // 12% - 34%
        const horizon = riskClass === 'transformational' ? '24–36 months' : (riskClass === 'moderate' ? '12–24 months' : '6–12 months');

        const comps = generateProjectCompetitors(name, archetype, riskClass);
        const compA = comps[0]?.name || 'a major incumbent';
        const compB = comps[1]?.name || 'a focused specialist';

        const barrier = _pick([
            'proving reliability in India’s power/connectivity conditions',
            'collecting enough local data to hit accuracy targets in real deployments',
            'integrating into existing CCTV/access workflows without operator overload',
            'regulatory and safety approvals that can extend timelines',
            'installer training and service readiness across Tier‑1 and Tier‑2 cities',
            'getting procurement comfortable with maintenance and support SLAs'
        ], rng);

        const winCondition = _pick([
            'a wedge pilot in 2–3 flagship sites with measured outcome metrics (false-alarm reduction, response time, or guard productivity)',
            'a “land-and-expand” rollout through integrators with a repeatable deployment playbook',
            'a proof-of-value story tied to customer P&L (loss reduction, uptime, compliance cost)',
            'a clear pricing ladder (starter → enterprise) that protects margins while enabling trials'
        ], rng);

        return `${name} targets the ${domain} market, selling primarily to ${buyer}. India TAM is estimated at ~$${tam}M with ~${cagr}% CAGR driven by digitization and the shift from guard-heavy models toward tech-enabled outcomes. The buying bar will be set by ${compA} on breadth and channel reach, and by ${compB} on speed of demos—so differentiation must center on ${wedge}. The biggest adoption barrier is ${barrier}; a realistic commercialization horizon is ${horizon}. The most credible path to win is ${winCondition}.`;
    }

    // Ensure every generated project has complete fields required by the UI (market, competitors, etc.)
    function ensureProjectCompleteness(project) {
        if (!project) return project;

        // Market & competition are the most user-visible; always fill them.
        if (!project.marketContext || String(project.marketContext).trim().length < 40) {
            project.marketContext = generateProjectMarketContext(project.name || 'Project', project.desc || project.fullDesc || '', project.archetype, project.riskClass || getProjectRiskClassForProject(project.name || 'Project', project.archetype));
        }
        if (!Array.isArray(project.competitors) || project.competitors.length === 0) {
            project.competitors = generateProjectCompetitors(project.name || 'Project', project.archetype, project.riskClass || getProjectRiskClassForProject(project.name || 'Project', project.archetype));
        } else {
            // Ensure competitor cards don't break if an entry is missing fields
            project.competitors = project.competitors.map(c => ({
                name: c?.name || 'Unnamed competitor',
                position: c?.position || 'Positioning to be determined.',
                threat: c?.threat || 'Low'
            }));
        }

        // A few common “sometimes missing” fields (safe defaults)
        project.fullDesc = project.fullDesc || project.desc || 'Description pending.';
        project.desc = project.desc || project.fullDesc || 'Description pending.';
        project.financials = project.financials || generateFinancials(project.budget || 0, project.archetype);
        project.milestones = project.milestones || getMilestones(project.archetype, project.budget || 0);
        // Normalize milestone structure so UI rendering never crashes
        if (project.milestones && Array.isArray(project.milestones.milestones)) {
            project.milestones.milestones = project.milestones.milestones.map(mm => ({
                phase: mm?.phase || 'Phase',
                quarters: mm?.quarters || '',
                duration: mm?.duration || '',
                costAmount: (mm?.costAmount ?? 0),
                deliverables: Array.isArray(mm?.deliverables) ? mm.deliverables : [],
                metrics: Array.isArray(mm?.metrics) ? mm.metrics : []
            }));
        }
project.trl = project.trl || getTRL(project.archetype);

        // Ensure quarterly simulation fields exist (prevents stalls during Q reviews)
        if (!project.timeline || isNaN(project.timeline) || Number(project.timeline) < 1) {
            project.timeline = 4;
        } else {
            project.timeline = Number(project.timeline);
        }
        if (!project.currentQuarter || isNaN(project.currentQuarter)) project.currentQuarter = 1;
        if (!Array.isArray(project.quarterlyUpdates)) project.quarterlyUpdates = [];
        if (!project.quarterNarratives && project.quarterNarratives) { /* legacy name noop */ }
        if (!project.quarterNarratives || typeof project.quarterNarratives !== 'object') {
            project.quarterNarratives = {
                good: ['Steady progress this quarter.', 'Milestones met and risks contained.', 'Team delivered ahead of plan.'],
                bad: ['Unexpected blockers slowed progress.', 'Integration friction and rework increased.', 'Key dependency slipped, pushing timeline.']
            };
        }
        if (!Array.isArray(project.quarterNarratives.good) || project.quarterNarratives.good.length === 0) {
            project.quarterNarratives.good = ['Steady progress this quarter.', 'Milestones met and risks contained.', 'Team delivered ahead of plan.'];
        }
        if (!Array.isArray(project.quarterNarratives.bad) || project.quarterNarratives.bad.length === 0) {
            project.quarterNarratives.bad = ['Unexpected blockers slowed progress.', 'Integration friction and rework increased.', 'Key dependency slipped, pushing timeline.'];
        }


        return project;
    }

    // --- Risk balancing for project pools ---
    // We want each new project pool to encourage trade-offs: a mix of low-risk (incremental),
    // medium-risk (moderate), and high-risk (transformational) opportunities.
    function _riskTargetsForPoolSize(n, kind) {
        // Small pools (e.g., Year 2) should still contain at least one "high" and one "low" when possible.
        if (kind === 'year2') {
            if (n <= 2) return { incremental: 0, moderate: n, transformational: 0 };
            if (n === 3) return { incremental: 1, moderate: 1, transformational: 1 };
            // n = 4-5
            return { incremental: 1, moderate: n - 2, transformational: 1 };
        }

        // Larger pools (Year 1, etc.): aim for ~30/40/30 with at least 2 moderate projects.
        let incremental = Math.max(2, Math.round(n * 0.30));
        let transformational = Math.max(2, Math.round(n * 0.30));

        // Keep at least 2 moderate projects for sane portfolio choices.
        while (incremental + transformational > n - 2) {
            if (incremental >= transformational && incremental > 2) incremental--;
            else if (transformational > 2) transformational--;
            else break;
        }

        const moderate = Math.max(0, n - incremental - transformational);
        return { incremental, moderate, transformational };
    }

    function _countRiskClasses(pool) {
        const counts = { incremental: 0, moderate: 0, transformational: 0 };
        pool.forEach(p => {
            const rc = p?.riskClass || getProjectRiskClassForProject(p?.name || 'Project', p?.archetype || '');
            if (counts[rc] !== undefined) counts[rc]++;
        });
        return counts;
    }

    function _pickSurplusClass(counts, targets, avoid) {
        const classes = ['incremental', 'moderate', 'transformational'];
        let best = null;
        let bestDelta = -Infinity;
        classes.forEach(c => {
            if (c === avoid) return;
            const delta = (counts[c] || 0) - (targets[c] || 0);
            if (delta > bestDelta) {
                bestDelta = delta;
                best = c;
            }
        });
        return bestDelta > 0 ? best : null;
    }

    function _pickShortageClass(counts, targets) {
        const classes = ['incremental', 'moderate', 'transformational'];
        for (const c of classes) {
            if ((counts[c] || 0) < (targets[c] || 0)) return c;
        }
        return null;
    }

    function _buildYear1ProjectFromTemplate(template, i, projectId, name, effects) {
        const budgetMultiplier = 1.3;
        const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
        const budget = Math.round(budgetRaw * budgetMultiplier * 10) / 10;

        const riskClass = getProjectRiskClassForProject(name, template.archetype);
        const desc = (template.descs && (template.descs[i] || template.descs[0])) ? (template.descs[i] || template.descs[0]) : '';
        const successRange = riskClassSuccessProb[riskClass];
        const roiRange = riskClassROI[riskClass];

        let successProb = successRange.min + Math.random() * (successRange.max - successRange.min);
        const roiMultiplier = roiRange.min + Math.random() * (roiRange.max - roiRange.min);

        // Apply committee effects based on archetype (same logic as the main generator)
        const archetypeMapping = {
            'conventional_winner': 'conventionalWinner',
            'conventional_loser': 'conventionalLoser',
            'hidden_gem': 'hiddenGem',
            'slow_burner': 'slowBurner',
            'paper_tiger': 'paperTiger',
            'money_pit': 'moneyPit',
            'pivot_success': 'pivotSuccess',
            'sustainability_play': 'sustainability',
            'ip_fortress': 'ip',
            'team_dependent': 'team',
            'competitive_casualty': 'competitive'
        };
        const mappedKey = archetypeMapping[template.archetype];
        if (mappedKey && effects && effects[mappedKey]) {
            successProb *= effects[mappedKey];
        }

        return {
            id: 'proj-' + projectId,
            numId: projectId,
            name: name,
            desc: desc,
            shortDesc: desc,
            tagline: getTagline(template.archetype),
            fullDesc: generateFullDesc(name, template.descs[i], template.archetype),
            marketContext: generateProjectMarketContext(name, desc, template.archetype, riskClass),
            capabilityFit: generateCapabilityFit(template.archetype, template.scores.capability),
            risks: generateRisks(template.archetype),
            teamNote: generateTeamNote(template.archetype),
            teamDetails: generateTeamDetails(name, template.archetype, template.scores),
            strategicBuckets: getStrategicBuckets(template.archetype),
            trl: getTRL(template.archetype),
            ipPosition: getIPPosition(template.archetype),
            developmentCosts: getDevelopmentCosts(budget, template.archetype),
            milestones: getMilestones(template.archetype, budget),
            financials: generateFinancials(budget, template.archetype),
            synergies: generateSynergies(name, template.archetype),
            archetype: template.archetype,
            riskClass: riskClass,

            roiMultiplier: roiMultiplier,
            budget: budget,
            successProb: Math.max(0.05, Math.min(0.95, successProb)),
            scores: { ...template.scores },
            quarterNarratives: template.quarterNarratives,
            outcomeNarrative: template.outcomeNarrative,
            pivotRequired: template.pivotRequired || false,
            teamSensitive: template.teamSensitive || false,
            timeline: getTimelineForProject(name, template.archetype, riskClass),

            status: 'proposed',
            currentQuarter: 0,
            spentBudget: 0,
            quarterlyUpdates: [],
            decision: null,
            outcome: null,
            playerScores: {},
            committeeScores: {},
            lead: assignProjectLead(template.archetype, template.scores)
        };
    }

    function _buildYear2ProjectFromTemplate(template, i, projectId, name, riskClass) {
        const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
        const budget = Math.round(budgetRaw * 10) / 10;

        const successRange = riskClassSuccessProb[riskClass];
        let successProb = successRange.min + Math.random() * (successRange.max - successRange.min);

        return {
            id: 'y2proj-' + projectId,
            numId: projectId,
            name: name,
            desc: template.descs[i] || template.descs[0],
            description: template.descs[i] || template.descs[0],
            shortDesc: template.descs[i] || template.descs[0],
            fullDesc: template.descs[i] || template.descs[0],
            tagline: getYear2Tagline(template.archetype),
            archetype: template.archetype,
            riskClass: riskClass,

            budget: budget,
            successProb: Math.max(0.05, Math.min(0.95, successProb)),
            scores: { ...template.scores },
            quarterNarratives: template.quarterNarratives,
            outcomeNarrative: template.outcomeNarrative,
            pivotRequired: template.pivotRequired || false,

            timeline: 4 + Math.floor(Math.random() * 3),
            status: 'proposed',
            currentQuarter: 0,
            spentBudget: 0,
            roiMultiplier: 1,
            decision: null,
            outcome: null,
            playerScores: {},
            committeeScores: {},
            isYear2Project: true,
            team: generateRandomTeam(),
            lead: generateYear2ProjectLead(),
            strategicBuckets: generateStrategicBuckets(template.archetype),
            milestones: getMilestones(template.archetype, budget),
            marketContext: generateProjectMarketContext(name, (template.descs[i] || template.descs[0] || ''), template.archetype, riskClass),
            capabilityFit: generateYear2CapabilityFit(template.archetype),
            trl: getYear2TRL(template.archetype),
            ipPosition: getYear2IPPosition(template.archetype),
            competitors: generateProjectCompetitors(name, template.archetype, riskClass),
            developmentCosts: getDevelopmentCosts(budget, template.archetype),
            financials: generateYear2Financials(budget, template.archetype),
            quarterlyUpdates: []
        };
    }

    function balanceProjectPoolByRisk(pool, kind) {
        try {
            if (!Array.isArray(pool) || pool.length < 3) return pool;

            const targets = _riskTargetsForPoolSize(pool.length, kind);
            const counts = _countRiskClasses(pool);

            // Fast path: already meets minimum targets
            if (!(_pickShortageClass(counts, targets))) return pool;

            const usedNames = new Set(pool.map(p => p?.name).filter(Boolean));
            const effects = (kind === 'year1') ? calculateCommitteeEffects() : null;
            const templates = (kind === 'year2') ? (Array.isArray(year2ProjectTemplates) ? year2ProjectTemplates : []) : (Array.isArray(projectTemplates) ? projectTemplates : []);
            if (!templates.length) return pool;

            let nextNumId = Math.max(...pool.map(p => p?.numId || 0)) + 1;

            function buildCandidate(desiredRisk) {
                const maxAttempts = 400;
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    const template = templates[Math.floor(Math.random() * templates.length)];
                    if (!template || !Array.isArray(template.names) || template.names.length === 0) continue;

                    const i = Math.floor(Math.random() * template.names.length);
                    const name = template.names[i];
                    if (!name || usedNames.has(name)) continue;

                    const rc = getProjectRiskClassForProject(name, template.archetype);
                    if (rc !== desiredRisk) continue;

                    const project = (kind === 'year2')
                        ? _buildYear2ProjectFromTemplate(template, i, nextNumId, name, rc)
                        : _buildYear1ProjectFromTemplate(template, i, nextNumId, name, effects);

                    // Sanity: ensure risk class matches (should)
                    project.riskClass = desiredRisk;
                    return project;
                }
                return null;
            }

            let guard = 0;
            while (guard++ < 50) {
                const need = _pickShortageClass(counts, targets);
                if (!need) break;

                const surplus = _pickSurplusClass(counts, targets, need);
                if (!surplus) break;

                const idx = pool.findIndex(p => (p?.riskClass || getProjectRiskClassForProject(p?.name || 'Project', p?.archetype || '')) === surplus);
                if (idx < 0) break;

                const oldName = pool[idx]?.name;
                if (oldName) usedNames.delete(oldName);

                const candidate = buildCandidate(need);
                if (!candidate) {
                    // Restore and give up on this shortage; prevents infinite loops on limited template sets
                    if (oldName) usedNames.add(oldName);
                    break;
                }

                pool[idx] = candidate;
                usedNames.add(candidate.name);
                counts[surplus]--;
                counts[need]++;
                nextNumId++;
            }

            return pool;
        } catch (e) {
            console.warn('Risk balancing failed:', e);
            return pool;
        }
    }



    function generateMarketContext(archetype) {
        const contexts = {
            "acoustic_detection": "Public-safety and critical-infrastructure sites in India are exploring rapid gunshot/blast detection to shorten response time. Adoption hinges on low false positives in noisy environments, SOP integration, and procurement comfort with calibration and support.",
            "acquisition_integration": "Post-acquisition integration is where value is won or lost: customers fear product disruption and integrators fear changing workflows. The market opportunity is to merge roadmaps without breaking installs\u2014unified licensing, consistent UX, and a clear migration plan that keeps enterprise accounts confident.",
            "ai_guard_innovation": "India\u2019s guard workforce is huge, but supervision and consistency are chronic pain points for enterprises. AI copilots that reduce paperwork, guide patrols, and flag anomalies can sell if they fit guard realities\u2014local languages, low-end devices, intermittent connectivity\u2014and if HR/labor concerns are handled.",
            "ai_video_search": "Enterprises with large camera estates struggle to investigate incidents quickly. AI-assisted search that cuts review time sells if it\u2019s accurate in Indian conditions (crowds, low light), respects privacy controls, and integrates with existing VMS/NVR workflows.",
            "alarm_response_network": "Alarm response is moving from \u2018hardware + guard\u2019 to subscription outcomes: verified alarms, predictable response times, and documented resolution. Opportunity is strongest in retail chains and SMBs that can\u2019t justify dedicated response teams but will pay for reliable coverage.",
            "anti_drone_service": "Counter\u2011UAS needs are growing around airports, events, prisons, and critical infrastructure. In India, adoption depends on clear legal/regulatory alignment, safe mitigation options, and a service model that security teams can operate\u2014detection, verification, escalation, and reporting rather than \u2018gadget\u2019 deployments.",
            "autonomous_drone": "Drone-based perimeter patrol appeals to large sites (industrial parks, solar farms, logistics hubs) but faces regulatory, safety and operations hurdles. Adoption depends on proving repeatable patrol routes, reliable incident triage, and clear compliance with DGCA norms and site safety procedures.",
            "camera_health": "Camera uptime is a silent cost in India: power issues, dust and installer variability drive outages. A health assurance layer that reduces truck rolls and downtime has clear ROI for enterprises and integrators\u2014especially with actionable diagnostics and SLA reporting.",
            "camera_subscription": "Subscription camera bundles compete on total experience: easy setup, storage, alerts, and hassle-free replacement. Indian buyers are value-driven and churn-prone, so retention depends on trustworthy notifications, transparent pricing, and strong support.",
            "capability_build": "This is an internal capability investment to unlock multiple future products. The market impact is indirect: faster model iteration, better localization for India conditions, and reduced dependency on external vendors\u2014paid back through improved differentiation and lower long-term costs.",
            "competitive_casualty": "The value segment is crowded and price wars are common. Winning requires ruthless cost control, tight supply chain execution, and clear \u2018good enough\u2019 differentiation that survives discounting.",
            "compliance_automation": "Security compliance is paperwork-heavy for enterprises (audits, drills, incident logs, access reviews). Automation wins if it maps to common standards, reduces manual work, and withstands inspection scrutiny with reliable audit trails.",
            "contractor_screening": "Enterprises increasingly screen contractors and temporary staff for safety and security risk. The market rewards services that are fast, compliant, and integrated into onboarding workflows, with transparent verification sources and clear dispute handling.",
            "conventional_loser": "The concept is technically exciting but sits far from current buying behavior and channel readiness in India. Expect long validation cycles, limited willingness to pay today, and a high risk that near-term wins are academic rather than commercial.",
            "conventional_winner": "India\u2019s smart-home security category is growing through e-commerce and installer channels, with consumers upgrading from basic CCTV to app-connected locks, cameras and sensors. Differentiation comes from reliability, after-sales service, and strong local integrations (power backup, low-light performance, multilingual UX).",
            "core_upgrade": "The consumer smart-security upgrade cycle in India is driven by apartment living, rising parcel deliveries, and increasing comfort with app-based devices. Buyers expect quick installation, stable Wi\u2011Fi/Bluetooth performance, and dependable after-sales support; products that \u2018just work\u2019 and integrate with common Indian door formats and power conditions win share.",
            "cyber_physical_soc": "Boards are asking for unified visibility across IT and physical security as cameras and access systems become networked endpoints. A cyber-physical SOC platform wins if it reduces alert overload, supports playbooks, and fits existing SIEM/PSIM stacks.",
            "deepfake_defense": "Deepfakes and voice cloning raise fraud risk for high-value actions (access overrides, payment approvals, executive requests). Buyers want practical protections\u2014multi-factor liveness, verified channels, and policy guardrails\u2014rather than exotic research demos.",
            "digital_twin": "Operators want a \u2018single pane of glass\u2019 for security\u2014maps, devices, zones and live status. Digital twins sell when they reduce operator error, speed response, and simplify expansions via clean integrations to CCTV, access and safety systems.",
            "edge_micro_nvr": "Edge micro\u2011NVRs are popular for distributed sites (retail chains, clinics) where IT support is minimal. Buyers value low maintenance, remote updates, and good compression/low bandwidth performance for backhaul.",
            "emergency_muster": "Safety teams need fast, reliable headcounts during evacuations and drills. Muster tools win when they work offline, integrate with access/visitor systems, and produce compliance reports that management and auditors accept.",
            "emerging_segment": "Small businesses are adopting security as a managed service rather than buying boxes. The key is a simple bundle\u2014camera + app + support\u2014sold through local channels with predictable monthly pricing and rapid replacement.",
            "esg_initiative": "Sustainability features resonate most in enterprise RFPs and government tenders when tied to measurable impact (lower power draw, recyclable packaging, longer lifecycle). The market is skeptical of vague green claims, so certification, transparent reporting, and lifecycle economics are the route to trust.",
            "evidence_chain": "As disputes rise (theft, accidents, compliance incidents), buyers want video evidence that is tamper-resistant and easy to present to management, insurers and law enforcement. A chain-of-custody story\u2014timestamps, access logs, export controls\u2014creates premium value for enterprises.",
            "frontier_tech": "This concept rides emerging sensing/AR/next-gen interfaces that are still early in Indian security procurement. Early demand will come from flagship campuses, premium retail and high-visibility pilots; commercialization depends on showing hard operational benefits (faster response, fewer false alarms) rather than \u2018wow\u2019 demos.",
            "ground_robot": "Autonomous ground patrol robots are early in India and will be judged on uptime, navigation reliability, and support costs. Best early customers are controlled environments (campuses, gated factories) where robots augment guards and generate visible deterrence and analytics.",
            "guard_tour_proof": "Guard tour verification is mature, but many deployments fail due to poor adoption and \u2018checkbox\u2019 behavior. The market favors tools that are simple, tamper-resistant, and paired with supervisor analytics that improve performance and accountability.",
            "guard_training_sim": "Security training is shifting from classroom to scenario-based learning with measurable outcomes. Simulation tools have a strong pitch if they improve response consistency, but must be affordable, repeatable, and localized to Indian site realities.",
            "hidden_gem": "A niche security need with clear pain, but historically underserved by mainstream brands. If ShieldTech packages it as a simple, trusted solution with distribution partners, it can scale faster than it looks and open adjacent upsell paths.",
            "incident_invoice": "Retailers and property managers want \u2018proof packs\u2019 for chargebacks, disputes and insurance claims. A service that packages evidence quickly and defensibly can command recurring fees if it integrates with common video systems and meets fast turnaround expectations.",
            "ip_fortress": "A defensible IP position can create licensing and partnership options, particularly with OEMs and large integrators. The challenge is translating patents into shipped products and enforceable differentiation.",
            "legacy_defensive": "Defensive iterations in a saturated doorbell market are about protecting share from cheaper alternatives. Success depends on cost discipline, channel incentives, and a clear \u2018trusted brand\u2019 promise with fewer support issues than bargain competitors.",
            "legacy_incremental": "Incremental upgrades in doorbell/entry compete on reliability, app polish and installation simplicity. The opportunity is to reduce churn and returns with better firmware stability, clearer setup flows, and small features that improve daily use.",
            "legacy_infrastructure": "Legacy infrastructure work (backend stability, device management, OTA reliability) directly reduces support cost and improves ratings. The business case should be anchored in measurable uptime, ticket reduction and faster release velocity.",
            "legacy_partnership": "Partnership-led extensions of a mature category can unlock distribution (builders, societies, installers) without heavy new R&D. Value comes from integration quality, shared go-to-market, and clear customer support ownership.",
            "legacy_pet_project": "Niche features in a mature category can become expensive complexity with low adoption. To justify spend, the project must tie to a clear segment and measurable value, with strict scope control and a kill switch if adoption lags.",
            "legacy_strategic_troubled": "A strategically important legacy line can still struggle due to tech debt and channel confusion. The market exists, but the path requires simplifying the offer, stabilizing reliability, and rebuilding trust with partners and customers.",
            "market_explorer": "Secure communications for guards and facility teams competes with WhatsApp and basic radios, so the bar for switching is workflow value. The strongest wedge is compliance and auditability\u2014structured incidents, role controls, and reliable push-to-talk in noisy, low-connectivity environments.",
            "market_response": "A fast-follow response to competitive moves where time-to-market matters. The goal is to neutralize a competitor\u2019s talking point quickly with credible parity, then differentiate through service and ecosystem after launch.",
            "money_pit": "This is enabling infrastructure: the value is real, but benefits arrive indirectly through lower support costs, better uptime and faster rollouts. Strong governance is needed to avoid scope creep and keep ROI visible.",
            "niche_vertical": "Care and assisted-living security is growing as urban families look for monitoring solutions for elders at home. Trust, privacy, and low-friction caregiver workflows matter more than cutting-edge tech; partnerships with clinics, home-care providers and insurers can accelerate adoption.",
            "night_escort": "Personal safety services are demanded by campuses, hospitals and large employers for late-night staff and visitors. Buyers value predictable response, verified escorts, and clear liability handling, often purchased alongside broader security contracts.",
            "panic_wearable": "Panic wearables sell when they integrate into real response workflows\u2014alerts must reach the right people with location context, and false activations must be manageable. Adoption drivers include enterprise safety policies and healthcare.",
            "paper_tiger": "Premium buyers in top metros will compare specs and brand cues aggressively, but volume may remain limited unless the product earns trust and word-of-mouth. A halo product can still justify itself by raising brand perception and pulling the portfolio up-market.",
            "parking_security": "Parking areas are high-incident zones (theft, vandalism, disputes) and hard to cover with guards alone. Solutions win when they combine LPR/coverage with clear evidence capture and workflows that reduce disputes and improve throughput.",
            "partnership_opportunity": "Builders and apartment societies are a powerful channel in India, but they demand low support burden and clean handoffs. Integration modules that fit property workflows (visitors, deliveries, maintenance) can scale quickly if partnerships are managed tightly.",
            "perimeter_fusion": "Perimeter security is an enterprise/critical-infra purchase where false alarms are costly. Multi-sensor fusion is attractive when it reduces nuisance alerts and provides clear verification for response teams under tough weather/terrain.",
            "pivot_success": "A flexible product concept with multiple credible landing zones. Early pilots should be structured to learn quickly and lock onto one or two repeatable use-cases before scaling spend.",
            "platform_infrastructure": "This is foundational camera/edge infrastructure that improves the whole portfolio: better detection accuracy, lower bandwidth, and smoother remote management. The market rewards platforms that reduce total cost of ownership for installers and enterprise security teams through standardized deployment and lifecycle tooling.",
            "predictive_door_maintenance": "Door/access failures create real security risk and high service cost. Predictive maintenance can win in multi-site enterprises if it reduces downtime and emergency calls, with easy retrofits and maintenance scheduling outputs.",
            "predictive_risk": "Risk engines matter when they turn messy operational data into trusted prioritization. Buyers demand explainability and alignment to SOPs; the wedge is better resource allocation and fewer repeat incidents.",
            "premium_flagship": "High-end surveillance and access systems sell in India to corporates, luxury residences and critical infrastructure where reliability and low-light performance matter more than headline specs. Premium buyers expect polished software, strong cyber hygiene, and integrator-friendly deployment; reference installs and service SLAs drive credibility.",
            "price_fighter": "Budget cameras and kits are a commodity battle in India, flooded by imports and aggressive online brands. To win without destroying margins, the offer must cut returns (stable firmware, good low-light), simplify installation, and create small but meaningful differentiation like better app UX and local service.",
            "privacy_analytics": "Demand for privacy masking, redaction and consent-aware analytics is rising as CCTV expands. Solutions that default to privacy, allow role-based unmasking, and produce audit trails reduce compliance anxiety and unlock analytics budgets.",
            "privacy_compliance": "Privacy expectations are rising in India, especially for offices, hospitals and campuses adopting video analytics. Solutions that minimize personal data, control access, and produce audit-ready reports reduce buyer risk; procurement increasingly asks for DPDP-aligned practices and clear retention controls.",
            "proprietary_tech": "Proprietary sensing or algorithms can create a defensible performance edge (false-alarm reduction, detection in tough Indian conditions like dust and glare). The advantage appears when packaged into an installer-friendly product with clear benchmark results and a roadmap for protected differentiation.",
            "quick_win": "Quick wins in mature categories deliver near-term revenue and reduce churn through small, high-impact improvements. The market rewards better installation experience, fewer defects, and simple feature upgrades that matter in reviews.",
            "rapid_deploy_kit": "Events, pop-up stores and temporary sites need security fast without heavy installs. Rapid-deploy kits sell when truly plug-and-play, with remote monitoring options and a clear rental/short-term pricing model.",
            "regulatory_opportunity": "Certification and compliance can be a growth lever when buyers face procurement constraints. A compliant \u2018safe choice\u2019 product can win tenders and enterprise deals even if feature parity is similar.",
            "rtls_tracking": "Indoor location tracking is sought by factories, warehouses and hospitals for safety, asset utilization and compliance. Buyers scrutinize accuracy vs cost and installation burden; the clearest wins come from targeted, high-ROI use cases like tool tracking and emergency mustering.",
            "safety_security_soc": "Many mid-to-large enterprises are consolidating fragmented security operations into unified command centers (CCTV, access, alarms, safety, cyber liaison). The market values systems that reduce noise, standardize playbooks, and provide real-time dashboards and after-action reporting, with strong integration and uptime guarantees.",
            "security_score": "CISOs and facility heads want quantifiable security posture to justify spend. A standardized scorecard that ties findings to actions, budgets and year-over-year improvement can become a sticky recurring service.",
            "services_platform": "Remote monitoring and virtual patrol services are gaining traction as businesses try to reduce guard costs while improving coverage. Buyers value predictable SLAs, documented evidence, and easy escalation workflows; the constraint is operational excellence in the response center and partner network.",
            "shrink_prevention": "Retail shrink is a measurable P&L problem; buyers pay for solutions that reduce loss and improve prosecution/chargeback outcomes. Successful offers combine deterrence, analytics and workflows rather than standalone sensors.",
            "slow_burner": "This is a platform bet where adoption follows a J-curve: slow early traction while workflows and integrations mature, then sharper growth once switching costs and trust are established. Patience and credible reference customers are key.",
            "smart_access": "Access control demand is expanding beyond IT parks into mid-market offices, schools and warehouses. Buyers want simple enrollment, strong offline reliability, and flexible policies; integration with attendance, visitor management and incident workflows is a common driver.",
            "smart_intercom": "Apartment and gated-community entry systems are evolving toward app-enabled intercoms with visitor verification. Buyers expect reliable connectivity, multilingual support, and clean integration with guard posts and society apps.",
            "smart_key_control": "Key control is a compliance and loss-prevention need for facilities, hotels and fleets. Solutions win when they enforce accountability (who took what, when), integrate with access policies, and are robust in high-usage environments.",
            "sustainability_play": "Sustainability is increasingly used as a procurement filter for enterprise and government buyers. The best path is to tie green claims to measurable outcomes (energy, waste, lifecycle) and credible certification.",
            "team_dependent": "The market is attractive, but execution quality will make or break outcomes. Success depends on strong cross-functional delivery (hardware, app, installer ops) and tight milestone control.",
            "tech_adjacency": "Adjacency features (health monitoring, safety add-ons) can increase ARPU if they fit naturally into an existing security install base. The market rewards clear outcomes and partnerships (clinics/insurers) rather than standalone gadgets.",
            "tech_refresh": "Technology refreshes keep the portfolio competitive while reducing maintenance cost (new sensors, better compute, improved battery). Success is measured in reliability, unit economics, and a clear migration path for existing customers.",
            "underserved_market": "Rural and Tier\u20113/Tier\u20114 demand is rising but distribution and service are the real constraints. Winning solutions are rugged, low-maintenance, tolerate poor connectivity/power, and are sold through local dealers with predictable spares and training.",
            "value_segment": "Entry-level security in India is extremely price sensitive and dominated by online deals and local installers. Volume exists, but churn is high unless reliability and service are strong; the best strategy is a simple feature set, low returns, and clear value messaging (warranty, local support, spares).",
            "vehicle_intelligence": "Vehicle intelligence is valuable for gated communities, logistics yards and parking operators. Buyers want high accuracy across Indian plate variations and night conditions, plus integrations to barriers, watchlists and incident workflows.",
            "visitor_flow": "Visitor management is becoming standard, but the market is crowded. Winning products reduce front-desk friction, integrate with access control, and provide compliance-grade logs and reporting.",
            "wander_management": "Wandering prevention in eldercare and hospitals is high-stakes; false negatives are unacceptable. Best solutions combine location accuracy, caregiver workflows, and privacy-respecting data handling, often sold with service and training."
        };
        return contexts[archetype] || generateMarketContextFallback(archetype);
    }
    
    function generateCapabilityFit(archetype, capScore) {
        const capabilityDetails = {
            'conventional_winner': 'Strong fit with existing hardware design and ShieldOS platform capabilities. Manufacturing can leverage current ODM partners (Foxconn, Salcomp). App team has delivered similar features successfully. QA processes are established and proven. Low capability risk—focus is on execution excellence.',
            'conventional_loser': 'Requires new capabilities in advanced research: physics/materials expertise, academic partnerships, and experimental prototyping. Plan includes hiring 3-5 specialist researchers and establishing lab facilities. IISc partnership provides access to talent pipeline. Capability building is part of the investment thesis.',
            'hidden_gem': 'Core sensing technology transfers from existing products—engineering lift is manageable. New capabilities needed: deep segment research (budgeted for user research program), specialised channel partnerships (conversations initiated), and adapted support processes. Gap analysis shows clear paths to address each.',
            'slow_burner': 'Platform engineering team has strong API and integration experience from ShieldOS. Requires dedicated partnership resources—business development and legal capacity being added. Developer relations capability being built with industry hires. Foundation exists; scaling the team is the focus.',
            'paper_tiger': 'Pushes hardware capabilities into new territory—exciting growth opportunity for engineering. New chip partnerships identified (Qualcomm, Ambarella). Manufacturing process development budgeted. Will consume senior engineering bandwidth but builds valuable institutional capability for future premium products.',
            'money_pit': 'Engineering team has the technical skills; capacity planning accounts for dual-track development. Phased approach with dedicated platform squad maintains existing products. Historical lessons from peer companies inform our governance model. Capability is present; execution discipline is the focus.',
            'pivot_success': 'Initial concept fits current capabilities well. Team assembled with learning agility and entrepreneurial mindset—flexibility is a selection criterion. External hiring budget reserved for capabilities gaps that emerge from market feedback. Adaptability built into team design.',
            'team_dependent': 'Capability assessment centres on team composition. Identified candidates have strong track records and relevant domain expertise. Retention packages and autonomy commitments designed to secure and motivate key individuals. Success depends on assembling the right people—selection process is rigorous.',
            'competitive_casualty': 'Manufacturing and supply chain capabilities exist. Cost engineering has been gap—now addressed with new procurement leadership hire. Operations team trained on lean methodology. Finance processes tightened for thin-margin discipline. Capability gaps are being actively closed.',
            'sustainability_play': 'Core product capabilities transfer directly. Addressing specific gaps: sustainable material sourcing (3 suppliers identified), environmental certification (B-Corp consultant engaged), and eco-segment marketing (agency with relevant experience shortlisted). Clear plan to build new capabilities.',
            'ip_fortress': 'R&D team fully capable of novel technology development. Patent strategy gap addressed: external IP counsel retained, and patent engineer role budgeted. Building IP capability is strategic priority with clear investment. Legal and technical tracks aligned.'
        };
        
        return capabilityDetails[archetype] || (capScore >= 4 
            ? 'Strong alignment with existing capabilities. Team has relevant experience and infrastructure is in place.'
            : capScore >= 3 
                ? 'Moderate fit with current capabilities. Specific gaps identified with plans to address.'
                : 'Requires targeted capability building. Clear investment plan to address gaps. Higher execution complexity but achievable with focus.');
    }
    
    function generateRisks(archetype) {
        const risks = {
            'conventional_winner': 'Competitive response: Godrej or Yale could match features and undercut on price within 6 months. Component supply: Biometric modules from single supplier (Fingerprint Cards AB). Premium pricing requires flawless launch—early quality issues would damage brand positioning.',
            'conventional_loser': 'Technology risk is fundamental—underlying physics may not support consumer product. Academic research rarely translates to manufacturable products. Team morale will suffer if repeated setbacks occur. Budget and timeline estimates are highly speculative.',
            'hidden_gem': 'Market size risk: Passionate users in research may not translate to sustainable business. Customer acquisition cost could exceed LTV if segment proves smaller than surveys suggest. May cannibalise resources from core products for uncertain return.',
            'slow_burner': 'Patience risk: Q2-Q3 metrics will disappoint, creating pressure to cut funding before network effects materialise. Platform dependency: Google/Amazon could prioritise India integrations, making our bridge redundant. Team retention through slow early phases.',
            'paper_tiger': 'Execution risk is severe: 8K processing generates heat requiring redesigned thermal management. Integration complexity grows exponentially with features. Quality issues in premium segment amplified by vocal reviewers. Key engineer single-point-of-failure.',
            'money_pit': 'Scope creep is near-certain: discovery of additional technical debt will expand requirements. Opportunity cost: engineering bandwidth unavailable for customer-facing features. Sunk cost fallacy may prevent rational stop decision. 2-3x budget overrun is industry norm.',
            'pivot_success': 'Direction uncertainty: original concept may fail requiring pivot, but pivot direction is unknown. Team may resist abandoning initial vision. Multiple pivots could exhaust budget before finding fit. Market timing window may close during iteration.',
            'team_dependent': 'Key person risk is existential: 2 of 6 team members have received Google/Amazon offers in past year. Team chemistry is fragile—one personality conflict could derail project. Knowledge concentration means departure = project failure.',
            'competitive_casualty': 'Price war risk is extreme: Xiaomi can sustain losses to gain market share. Rupee weakness directly impacts component costs (70% imported). Single supply chain disruption eliminates thin margin. Brand dilution from "budget" positioning.',
            'sustainability_play': 'Greenwashing accusations if claims don\'t withstand scrutiny. Ocean plastic supply chain unproven at scale. Premium pricing may limit to <10,000 units/year—subscale for manufacturing efficiency. ESG standards evolving rapidly.',
            'ip_fortress': 'Patent prosecution takes 3-4 years—competitors may design around. Legal costs for defence against challenges: $60K-$120K. Key patents could be invalidated on prior art grounds. Technology may become obsolete before patent enforcement possible.'
        };
        return risks[archetype] || 'Risk assessment pending.';
    }
    
    function generateTeamNote(archetype) {
        const notes = {
            'conventional_winner': 'Standard product team can execute. Clear ownership and accountability.',
            'conventional_loser': 'Needs researchers comfortable with uncertainty. May struggle with ambiguity.',
            'hidden_gem': 'Requires product manager who deeply understands the target segment.',
            'slow_burner': 'Team must be comfortable with delayed gratification. Not for impatient builders.',
            'paper_tiger': 'Best engineers needed. Will stretch the team significantly.',
            'money_pit': 'Requires strong project management. Scope discipline is critical.',
            'pivot_success': 'Entrepreneurial team needed. Must embrace uncertainty and iteration.',
            'team_dependent': 'Success tied to specific individuals. Their engagement is essential.',
            'competitive_casualty': 'Cost engineering expertise required. Manufacturing efficiency critical.',
            'sustainability_play': 'Need supply chain expertise for sustainable materials.',
            'ip_fortress': 'Legal and engineering alignment required. Patent strategy is key.'
        };
        return notes[archetype] || 'Team assignment pending.';
    }
    
    function generateTeamDetails(name, archetype, scores) {
        // Select appropriate team leads based on project type
        const teamLeads = {
            'conventional_winner': [
                { role: 'Project Lead', staffId: 'deepak', reason: 'Core product expertise and P&L experience' },
                { role: 'Technical Lead', staffId: 'harpreet', reason: 'Platform integration and engineering leadership' },
                { role: 'Product Manager', staffId: null, reason: 'To be assigned from product team' }
            ],
            'conventional_loser': [
                { role: 'Research Lead', staffId: 'zara', reason: 'Advanced R&D and experimental technology expertise' },
                { role: 'Technical Advisor', staffId: 'aisha', reason: 'Systems architecture for novel approaches' },
                { role: 'Feasibility Reviewer', staffId: 'mohammed', reason: 'Honest technical assessment' }
            ],
            'hidden_gem': [
                { role: 'Market Champion', staffId: 'bandana', reason: 'Understanding of underserved segments' },
                { role: 'Field Insight', staffId: 'thomas', reason: 'Direct customer knowledge from the field' },
                { role: 'Product Lead', staffId: null, reason: 'Requires hire with segment expertise' }
            ],
            'slow_burner': [
                { role: 'Platform Lead', staffId: 'krishna', reason: 'Ecosystem thinking and partnership building' },
                { role: 'Architecture', staffId: 'aisha', reason: 'Long-term technical vision' },
                { role: 'Technical Lead', staffId: 'prakash', reason: 'Infrastructure and scalability expertise' }
            ],
            'paper_tiger': [
                { role: 'Engineering Lead', staffId: 'harpreet', reason: 'Can push team to ambitious specs' },
                { role: 'Hardware Lead', staffId: 'anand', reason: 'Complex hardware integration' },
                { role: 'QA Oversight', staffId: null, reason: 'Will need dedicated QA resources' }
            ],
            'money_pit': [
                { role: 'Program Manager', staffId: 'sanjay', reason: 'Operations discipline and scope control' },
                { role: 'Technical Sponsor', staffId: 'harpreet', reason: 'Platform ownership and architecture' },
                { role: 'Finance Oversight', staffId: 'farhan', reason: 'Budget governance and milestone tracking' }
            ],
            'pivot_success': [
                { role: 'Venture Lead', staffId: null, reason: 'Needs entrepreneurial mindset - internal or external hire' },
                { role: 'Market Guidance', staffId: 'joseph', reason: 'Customer feedback loops and iteration' },
                { role: 'Technical Support', staffId: 'mohammed', reason: 'Flexible problem-solving across pivots' }
            ],
            'team_dependent': [
                { role: 'Team Lead', staffId: 'mohammed', reason: 'Distinguished engineer with cross-functional respect' },
                { role: 'Technical Sponsor', staffId: 'aisha', reason: 'Chief architect oversight' },
                { role: 'Retention Support', staffId: 'kavitha', reason: 'HR support for team engagement' }
            ],
            'competitive_casualty': [
                { role: 'Cost Engineering', staffId: 'anand', reason: 'Hardware cost optimization expertise' },
                { role: 'Manufacturing', staffId: 'sanjay', reason: 'Operations and supply chain efficiency' },
                { role: 'Sales Input', staffId: 'rajiv', reason: 'Channel pricing and competitive intelligence' }
            ],
            'sustainability_play': [
                { role: 'Sustainability Lead', staffId: null, reason: 'Requires new hire with ESG expertise' },
                { role: 'Supply Chain', staffId: 'sanjay', reason: 'Sustainable sourcing and manufacturing' },
                { role: 'Marketing', staffId: 'anjali', reason: 'Brand positioning for eco-conscious segment' }
            ],
            'ip_fortress': [
                { role: 'Legal Lead', staffId: 'nandini', reason: 'IP strategy and patent portfolio management' },
                { role: 'Technical Inventor', staffId: 'zara', reason: 'Novel algorithm development' },
                { role: 'Patent Liaison', staffId: null, reason: 'Needs dedicated patent engineer' }
            ]
        };
        
        const team = teamLeads[archetype] || teamLeads['conventional_winner'];
        
        // Generate team strength assessment
        let teamStrength = 'moderate';
        let teamRisks = [];
        let teamStrengths = [];
        
        // Check if we have strong leads assigned
        const assignedLeads = team.filter(t => t.staffId !== null);
        if (assignedLeads.length >= 2) {
            teamStrength = 'strong';
            teamStrengths.push('Experienced leadership identified');
        } else {
            teamRisks.push('Key roles require new hires');
        }
        
        // Add archetype-specific assessments
        if (archetype === 'paper_tiger' || archetype === 'money_pit') {
            teamRisks.push('Project complexity will stretch resources');
        }
        if (archetype === 'hidden_gem') {
            teamStrengths.push('Field team brings customer insight');
        }
        if (archetype === 'team_dependent') {
            teamRisks.push('High dependency on key individuals');
            teamRisks.push('Retention critical to success');
        }
        if (scores.team >= 4) {
            teamStrengths.push('Strong team capability scores');
        } else if (scores.team <= 2) {
            teamRisks.push('Team capability gaps identified');
        }
        
        return {
            leads: team,
            strength: teamStrength,
            risks: teamRisks,
            strengths: teamStrengths,
            headcount: getHeadcount(archetype),
            skillsNeeded: getSkillsNeeded(archetype)
        };
    }
    
    function getHeadcount(archetype) {
        const headcounts = {
            'conventional_winner': { engineers: '4-6', product: 1, design: 1, qa: 1, total: '7-9' },
            'conventional_loser': { engineers: '6-10', product: 1, design: 1, qa: 2, research: 2, total: '12-16' },
            'hidden_gem': { engineers: '3-4', product: 1, design: 1, qa: 1, field: 2, total: '8-9' },
            'slow_burner': { engineers: '5-8', product: 2, design: 1, qa: 1, partnerships: 1, total: '10-13' },
            'paper_tiger': { engineers: '8-12', product: 2, design: 2, qa: 3, total: '15-19' },
            'money_pit': { engineers: '10-15', product: 2, design: 1, qa: 3, devops: 2, total: '18-23' },
            'pivot_success': { engineers: '3-5', product: 1, design: 1, qa: 1, total: '6-8' },
            'team_dependent': { engineers: '4-6', product: 1, design: 1, qa: 1, total: '7-9' },
            'competitive_casualty': { engineers: '3-4', product: 1, qa: 1, manufacturing: 2, total: '7-8' },
            'sustainability_play': { engineers: '3-5', product: 1, design: 1, qa: 1, supply_chain: 1, total: '7-9' },
            'ip_fortress': { engineers: '5-7', product: 1, design: 1, qa: 1, legal: 1, total: '9-11' }
        };
        return headcounts[archetype] || headcounts['conventional_winner'];
    }
    
    function getSkillsNeeded(archetype) {
        const skills = {
            'conventional_winner': ['Mobile development', 'Hardware integration', 'Cloud backend', 'UX design'],
            'conventional_loser': ['Research methodology', 'Experimental design', 'Advanced physics/ML', 'Prototyping'],
            'hidden_gem': ['User research', 'Field testing', 'Segment expertise', 'Rapid iteration'],
            'slow_burner': ['API development', 'Partner integration', 'Platform architecture', 'Developer relations'],
            'paper_tiger': ['Advanced hardware', 'Firmware optimisation', 'System integration', 'Performance tuning'],
            'money_pit': ['Legacy systems', 'Migration planning', 'Architecture refactoring', 'DevOps'],
            'pivot_success': ['Lean methodology', 'Customer development', 'Rapid prototyping', 'Flexibility'],
            'team_dependent': ['Cross-functional collaboration', 'Innovation process', 'Self-direction'],
            'competitive_casualty': ['Cost engineering', 'Manufacturing optimisation', 'Supply chain', 'Value engineering'],
            'sustainability_play': ['Sustainable materials', 'Lifecycle analysis', 'ESG compliance', 'Eco-design'],
            'ip_fortress': ['Patent drafting', 'Prior art research', 'Defensive design', 'IP strategy']
        };
        return skills[archetype] || skills['conventional_winner'];
    }
    
    function generateFinancials(budget, archetype) {
        const multipliers = {
            // Original archetypes
            'conventional_winner': { rev1: 12, rev2: 20, margin: 38, breakeven: 14 },
            'conventional_loser': { rev1: 3, rev2: 8, margin: 20, breakeven: 36 },
            'hidden_gem': { rev1: 6, rev2: 15, margin: 42, breakeven: 16 },
            'slow_burner': { rev1: 3, rev2: 12, margin: 55, breakeven: 26 },
            'paper_tiger': { rev1: 10, rev2: 18, margin: 35, breakeven: 20 },
            'money_pit': { rev1: 0, rev2: 5, margin: 30, breakeven: 40 },
            'pivot_success': { rev1: 5, rev2: 14, margin: 45, breakeven: 18 },
            'team_dependent': { rev1: 8, rev2: 16, margin: 40, breakeven: 15 },
            'competitive_casualty': { rev1: 15, rev2: 22, margin: 18, breakeven: 10 },
            'sustainability_play': { rev1: 5, rev2: 12, margin: 38, breakeven: 16 },
            'ip_fortress': { rev1: 6, rev2: 15, margin: 45, breakeven: 22 },
            
            // Core/upgrade archetypes
            'core_upgrade': { rev1: 10, rev2: 18, margin: 40, breakeven: 12 },
            'value_segment': { rev1: 8, rev2: 16, margin: 28, breakeven: 10 },
            'premium_flagship': { rev1: 6, rev2: 14, margin: 48, breakeven: 18 },
            'niche_vertical': { rev1: 4, rev2: 10, margin: 45, breakeven: 15 },
            'underserved_market': { rev1: 5, rev2: 12, margin: 32, breakeven: 14 },
            'platform_infrastructure': { rev1: 2, rev2: 10, margin: 65, breakeven: 24 },
            'market_explorer': { rev1: 3, rev2: 9, margin: 50, breakeven: 20 },
            'price_fighter': { rev1: 12, rev2: 20, margin: 18, breakeven: 8 },
            'esg_initiative': { rev1: 4, rev2: 10, margin: 42, breakeven: 18 },
            'proprietary_tech': { rev1: 5, rev2: 14, margin: 52, breakeven: 20 },
            'frontier_tech': { rev1: 1, rev2: 6, margin: 55, breakeven: 36 },
            
            // AI and advanced tech
            'ai_guard_innovation': { rev1: 4, rev2: 12, margin: 58, breakeven: 18 },
            'services_platform': { rev1: 6, rev2: 16, margin: 62, breakeven: 16 },
            'autonomous_drone': { rev1: 2, rev2: 8, margin: 45, breakeven: 30 },
            'ground_robot': { rev1: 1, rev2: 6, margin: 42, breakeven: 36 },
            'privacy_compliance': { rev1: 5, rev2: 14, margin: 55, breakeven: 18 },
            'evidence_chain': { rev1: 6, rev2: 15, margin: 58, breakeven: 16 },
            'smart_access': { rev1: 8, rev2: 18, margin: 48, breakeven: 14 },
            'rtls_tracking': { rev1: 4, rev2: 12, margin: 52, breakeven: 20 },
            'acoustic_detection': { rev1: 3, rev2: 10, margin: 50, breakeven: 24 },
            'digital_twin': { rev1: 2, rev2: 8, margin: 60, breakeven: 28 },
            'perimeter_fusion': { rev1: 5, rev2: 14, margin: 48, breakeven: 18 },
            'cyber_physical_soc': { rev1: 4, rev2: 12, margin: 55, breakeven: 22 },
            'camera_health': { rev1: 7, rev2: 16, margin: 65, breakeven: 12 },
            'panic_wearable': { rev1: 6, rev2: 14, margin: 42, breakeven: 14 },
            'vehicle_intelligence': { rev1: 5, rev2: 14, margin: 50, breakeven: 18 },
            'compliance_automation': { rev1: 8, rev2: 18, margin: 68, breakeven: 12 },
            'deepfake_defense': { rev1: 3, rev2: 10, margin: 58, breakeven: 24 },
            'edge_micro_nvr': { rev1: 8, rev2: 18, margin: 38, breakeven: 12 },
            'rapid_deploy_kit': { rev1: 10, rev2: 20, margin: 35, breakeven: 10 },
            'predictive_risk': { rev1: 3, rev2: 10, margin: 62, breakeven: 26 },
            'visitor_flow': { rev1: 6, rev2: 14, margin: 55, breakeven: 14 },
            'security_score': { rev1: 5, rev2: 12, margin: 70, breakeven: 16 },
            'smart_key_control': { rev1: 7, rev2: 16, margin: 45, breakeven: 14 },
            'emergency_muster': { rev1: 5, rev2: 12, margin: 52, breakeven: 16 },
            'night_escort': { rev1: 4, rev2: 10, margin: 48, breakeven: 18 },
            'guard_training_sim': { rev1: 3, rev2: 8, margin: 65, breakeven: 20 },
            'incident_invoice': { rev1: 6, rev2: 14, margin: 72, breakeven: 12 },
            'parking_security': { rev1: 7, rev2: 16, margin: 48, breakeven: 14 },
            'shrink_prevention': { rev1: 8, rev2: 18, margin: 55, breakeven: 12 },
            'alarm_response_network': { rev1: 5, rev2: 14, margin: 58, breakeven: 16 },
            'camera_subscription': { rev1: 4, rev2: 12, margin: 68, breakeven: 14 },
            'privacy_analytics': { rev1: 5, rev2: 14, margin: 60, breakeven: 18 },
            'guard_tour_proof': { rev1: 6, rev2: 14, margin: 62, breakeven: 14 },
            'smart_intercom': { rev1: 8, rev2: 18, margin: 42, breakeven: 12 },
            'wander_management': { rev1: 4, rev2: 10, margin: 52, breakeven: 18 },
            'contractor_screening': { rev1: 5, rev2: 12, margin: 65, breakeven: 14 },
            'ai_video_search': { rev1: 4, rev2: 12, margin: 58, breakeven: 18 },
            'safety_security_soc': { rev1: 5, rev2: 14, margin: 55, breakeven: 20 },
            'anti_drone_service': { rev1: 3, rev2: 10, margin: 52, breakeven: 24 },
            'predictive_door_maintenance': { rev1: 6, rev2: 14, margin: 68, breakeven: 14 },
            
            // Legacy archetypes
            'legacy_incremental': { rev1: 8, rev2: 16, margin: 38, breakeven: 12 },
            'legacy_pet_project': { rev1: 2, rev2: 6, margin: 25, breakeven: 30 },
            'legacy_strategic_troubled': { rev1: 4, rev2: 10, margin: 32, breakeven: 24 },
            'legacy_partnership': { rev1: 6, rev2: 14, margin: 35, breakeven: 18 },
            'legacy_defensive': { rev1: 10, rev2: 18, margin: 30, breakeven: 10 },
            'legacy_infrastructure': { rev1: 0, rev2: 4, margin: 0, breakeven: 48 }
        };
        const m = multipliers[archetype] || { rev1: 8, rev2: 15, margin: 35, breakeven: 18 };
        return {
            devCost: '$' + budget.toFixed(1) + 'M',
            timeline: (2 + Math.floor(Math.random() * 3)) + ' quarters',
            projectedRevenue: '$' + Math.round(budget * m.rev1) + ' M (Y1), $' + Math.round(budget * m.rev2) + ' M (Y2)',
            grossMargin: m.margin + '%',
            breakeven: m.breakeven + ' months'
        };
    }
    
    function generateSynergies(name, archetype) {
        const baseSynergies = [
            'Shares app and cloud infrastructure with other products',
            'Could bundle with complementary products',
            'Distribution channels apply to other offerings'
        ];
        if (archetype === 'slow_burner' || archetype === 'paper_tiger') {
            baseSynergies.push('Platform capabilities benefit entire portfolio');
        }
        if (archetype === 'hidden_gem') {
            baseSynergies.push('Opens new customer segment for cross-selling');
        }
        return baseSynergies.slice(0, 2 + Math.floor(Math.random() * 2));
    }
    
    // Strategic buckets aligned to ShieldTech's corporate priorities
    const strategicBuckets = {
        'defend-metro': {
            id: 'defend-metro',
            name: 'Defend Metro Leadership',
            color: '#2563eb',
            description: 'Retain #1 position in top 8 cities',
            icon: '🛡️'
        },
        'tier23-rollout': {
            id: 'tier23-rollout',
            name: 'Tier 2/3 Rollout',
            color: '#059669',
            description: 'Profitable entry into 50 emerging cities',
            icon: '🗺️'
        },
        'recurring-revenue': {
            id: 'recurring-revenue',
            name: 'Recurring Revenue',
            color: '#7c3aed',
            description: 'Shift to services and subscription model',
            icon: '💳'
        },
        'ai-first': {
            id: 'ai-first',
            name: 'AI-First Products',
            color: '#dc2626',
            description: 'Lead the transition to intelligent security',
            icon: '🤖'
        }
    };
    
    function getStrategicBuckets(archetype) {
        const bucketMapping = {
            // Defend Metro Leadership
            'core_upgrade': ['defend-metro'],
            'premium_flagship': ['defend-metro'],
            'proprietary_tech': ['defend-metro'],
            'smart_access': ['defend-metro'],
            'evidence_chain': ['defend-metro'],
            'deepfake_defense': ['defend-metro'],
            'camera_health': ['defend-metro'],
            'compliance_automation': ['defend-metro'],
            'legacy_incremental': ['defend-metro'],
            'legacy_defensive': ['defend-metro'],
            
            // Tier 2/3 Rollout
            'value_segment': ['tier23-rollout'],
            'underserved_market': ['tier23-rollout'],
            'price_fighter': ['tier23-rollout'],
            'edge_micro_nvr': ['tier23-rollout'],
            'rapid_deploy_kit': ['tier23-rollout'],
            'camera_subscription': ['tier23-rollout'],
            'niche_vertical': ['tier23-rollout'],
            'panic_wearable': ['tier23-rollout'],
            'smart_key_control': ['tier23-rollout'],
            'night_escort': ['tier23-rollout'],
            'smart_intercom': ['tier23-rollout'],
            'guard_training_sim': ['tier23-rollout'],
            
            // Recurring Revenue
            'services_platform': ['recurring-revenue'],
            'platform_infrastructure': ['recurring-revenue'],
            'market_explorer': ['recurring-revenue'],
            'alarm_response_network': ['recurring-revenue'],
            'visitor_flow': ['recurring-revenue'],
            'guard_tour_proof': ['recurring-revenue'],
            'incident_invoice': ['recurring-revenue'],
            'parking_security': ['recurring-revenue'],
            'shrink_prevention': ['recurring-revenue'],
            'security_score': ['recurring-revenue'],
            
            // AI-First Products
            'frontier_tech': ['ai-first'],
            'ai_guard_innovation': ['ai-first'],
            'autonomous_drone': ['ai-first'],
            'ground_robot': ['ai-first'],
            'privacy_compliance': ['ai-first'],
            'acoustic_detection': ['ai-first'],
            'digital_twin': ['ai-first'],
            'perimeter_fusion': ['ai-first'],
            'cyber_physical_soc': ['ai-first'],
            'rtls_tracking': ['ai-first'],
            'vehicle_intelligence': ['ai-first'],
            'predictive_risk': ['ai-first'],
            'ai_video_search': ['ai-first'],
            'safety_security_soc': ['ai-first'],
            'anti_drone_service': ['ai-first'],
            'predictive_door_maintenance': ['ai-first']
            
            // No bucket assigned (cross-cutting or doesn't fit):
            // esg_initiative, wander_management, contractor_screening, emergency_muster
            // legacy_pet_project, legacy_strategic_troubled, legacy_partnership, legacy_infrastructure
        };
        
        const bucketIds = bucketMapping[archetype] || [];
        return bucketIds.map(id => strategicBuckets[id]);
    }
    
    // Risk classification for portfolio balance scoring
    // Transformational = high risk, high reward (lower success prob, higher ROI)
    // Incremental = lower risk, lower reward (higher success prob, lower ROI)
    const projectRiskClassification = {
        // Transformational projects (30-45% base success, 4-6x ROI potential)
        'frontier_tech': 'transformational',
        'ai_guard_innovation': 'transformational',
        'autonomous_drone': 'transformational',
        'ground_robot': 'transformational',
        'digital_twin': 'transformational',
        'perimeter_fusion': 'transformational',
        'cyber_physical_soc': 'transformational',
        'acoustic_detection': 'transformational',
        'deepfake_defense': 'transformational',
        'platform_infrastructure': 'transformational',
        'predictive_risk': 'transformational',
        'ai_video_search': 'transformational',
        'safety_security_soc': 'transformational',
        'anti_drone_service': 'transformational',
        'moonshot': 'transformational',
        'hidden_gem': 'transformational',
        
        // Incremental projects (60-75% base success, 1.5-2x ROI potential)
        'core_upgrade': 'incremental',
        'value_segment': 'incremental',
        'price_fighter': 'incremental',
        'edge_micro_nvr': 'incremental',
        'rapid_deploy_kit': 'incremental',
        'camera_subscription': 'incremental',
        'compliance_automation': 'incremental',
        'camera_health': 'incremental',
        'smart_access': 'incremental',
        'guard_tour_proof': 'incremental',
        'incident_invoice': 'incremental',
        'parking_security': 'incremental',
        'visitor_flow': 'incremental',
        'smart_intercom': 'incremental',
        'guard_training_sim': 'incremental',
        'legacy_incremental': 'incremental',
        'legacy_defensive': 'incremental',
        
        // Moderate risk projects (45-55% base success, 2.5-3.5x ROI potential)
        'premium_flagship': 'moderate',
        'niche_vertical': 'moderate',
        'underserved_market': 'moderate',
        'services_platform': 'moderate',
        'market_explorer': 'moderate',
        'esg_initiative': 'moderate',
        'proprietary_tech': 'moderate',
        'privacy_compliance': 'moderate',
        'evidence_chain': 'moderate',
        'rtls_tracking': 'moderate',
        'vehicle_intelligence': 'moderate',
        'panic_wearable': 'moderate',
        'alarm_response_network': 'moderate',
        'shrink_prevention': 'moderate',
        'security_score': 'moderate',
        'wander_management': 'moderate',
        'contractor_screening': 'moderate',
        'emergency_muster': 'moderate',
        'smart_key_control': 'moderate',
        'night_escort': 'moderate',
        'predictive_door_maintenance': 'moderate',
        'legacy_pet_project': 'moderate',
        'legacy_strategic_troubled': 'moderate',
        'legacy_partnership': 'moderate',
        'legacy_infrastructure': 'moderate'
    };
    
    // Get risk classification for a project archetype
    function getProjectRiskClass(archetype) {
        return projectRiskClassification[archetype] || 'moderate';
    }
    
    // ROI multipliers by risk class (applied to successful projects)
    const riskClassROI = {
        'incremental': { min: 1.3, max: 2.0 },      // Safe but capped upside
        'moderate': { min: 2.0, max: 3.5 },         // Balanced risk/reward
        'transformational': { min: 3.5, max: 6.0 }  // High risk, high reward
    };
    
    // Base success probabilities by risk class
    const riskClassSuccessProb = {
        'incremental': { min: 0.60, max: 0.75 },
        'moderate': { min: 0.45, max: 0.55 },
        'transformational': { min: 0.28, max: 0.42 }
    };
    
    // Technology Readiness Level definitions
    const trlDefinitions = {
        1: { level: 1, name: 'Basic Research', desc: 'Basic principles observed, scientific research begins' },
        2: { level: 2, name: 'Concept Formulated', desc: 'Technology concept and application formulated' },
        3: { level: 3, name: 'Proof of Concept', desc: 'Analytical and experimental proof of concept' },
        4: { level: 4, name: 'Lab Validation', desc: 'Technology validated in laboratory environment' },
        5: { level: 5, name: 'Relevant Environment', desc: 'Technology validated in relevant environment' },
        6: { level: 6, name: 'Prototype Demo', desc: 'Prototype demonstrated in relevant environment' },
        7: { level: 7, name: 'Operational Demo', desc: 'System prototype demonstrated in operational environment' },
        8: { level: 8, name: 'System Complete', desc: 'Actual system completed and qualified through testing' },
        9: { level: 9, name: 'Production Ready', desc: 'Actual system proven in operational environment' }
    };
    
    function getTRL(archetype) {
        const trlMapping = {
            // Original archetypes
            'conventional_winner': { current: 6, target: 9, note: 'Core technology proven in lab and field tests. Engineering focus is productionisation and scale-up—well-understood process.' },
            'conventional_loser': { current: 2, target: 6, note: 'Fundamental research stage with promising early results. Stage-gated approach de-risks investment through validated learning milestones.' },
            'hidden_gem': { current: 5, target: 8, note: 'Technology validated in related applications. Adaptation for new use case is straightforward engineering with manageable technical risk.' },
            'slow_burner': { current: 5, target: 9, note: 'Platform architecture proven. Focus is ecosystem development and integration breadth—execution rather than technical uncertainty.' },
            'paper_tiger': { current: 4, target: 9, note: 'Lab demonstrations successful. Scaling to production requires engineering discipline but follows established patterns. Technical stretch builds capability.' },
            'money_pit': { current: 3, target: 7, note: 'Architecture defined with clear technical path. Implementation complexity is known and budgeted. Modern tooling reduces migration risk.' },
            'pivot_success': { current: 5, target: 8, note: 'Base technology ready for multiple market directions. Flexibility to adapt reduces technical commitment until market validated.' },
            'team_dependent': { current: 4, target: 8, note: 'Concept proven with team expertise. Technical path depends on direction chosen—team capability provides confidence in delivery.' },
            'competitive_casualty': { current: 7, target: 9, note: 'Technology mature and production-ready. Challenge is cost optimisation, not technical capability—operations focus.' },
            'sustainability_play': { current: 5, target: 8, note: 'Product technology proven. Sustainable supply chain and manufacturing processes are the development focus—known but new to ShieldTech.' },
            'ip_fortress': { current: 4, target: 8, note: 'Novel technology in active development with encouraging results. Patent protection being established as technical milestones achieved.' },
            
            // Core product archetypes
            'core_upgrade': { current: 6, target: 9, note: 'Incremental improvement on proven platform. Low technical risk with well-understood engineering path.' },
            'value_segment': { current: 7, target: 9, note: 'Cost-reduced version of existing technology. Focus is supply chain and manufacturing optimisation.' },
            'premium_flagship': { current: 5, target: 9, note: 'Advanced features require integration of multiple technologies. Complex but achievable engineering challenge.' },
            'niche_vertical': { current: 5, target: 8, note: 'Adaptation of core technology for specific use case. Domain expertise more critical than technical innovation.' },
            'underserved_market': { current: 6, target: 9, note: 'Ruggedisation and simplification of proven tech. Engineering focus on reliability in challenging conditions.' },
            'platform_infrastructure': { current: 4, target: 8, note: 'Software platform development with known architecture patterns. Integration complexity is the main challenge.' },
            'market_explorer': { current: 5, target: 8, note: 'Technology proven; market fit uncertain. Rapid iteration capability more important than deep R&D.' },
            'price_fighter': { current: 7, target: 9, note: 'Aggressive cost engineering on mature technology. Manufacturing and sourcing innovation required.' },
            'esg_initiative': { current: 5, target: 8, note: 'Sustainability technology with proven alternatives. Supply chain transformation is key challenge.' },
            'proprietary_tech': { current: 4, target: 8, note: 'Novel technology development with strong IP potential. Technical risk balanced by competitive moat creation.' },
            'frontier_tech': { current: 2, target: 6, note: 'Early-stage research with breakthrough potential. High technical uncertainty but transformative upside.' },
            
            // AI and advanced tech archetypes
            'ai_guard_innovation': { current: 4, target: 8, note: 'On-device AI requires edge optimisation. Model compression and real-time inference are key challenges.' },
            'services_platform': { current: 5, target: 9, note: 'Cloud platform with proven architecture. Scale and reliability engineering are primary focus.' },
            'autonomous_drone': { current: 3, target: 7, note: 'Autonomous systems require extensive testing. Regulatory compliance adds to development timeline.' },
            'ground_robot': { current: 2, target: 6, note: 'Mobile robotics in unstructured environments. Navigation and reliability require significant R&D.' },
            'privacy_compliance': { current: 4, target: 8, note: 'Privacy-preserving computation techniques. Cryptographic methods add performance challenges.' },
            'evidence_chain': { current: 5, target: 9, note: 'Blockchain and cryptographic signing. Well-understood technology, integration is key.' },
            'smart_access': { current: 5, target: 9, note: 'Risk-based authentication with proven components. ML model training on access patterns required.' },
            'rtls_tracking': { current: 5, target: 8, note: 'UWB positioning technology maturing rapidly. Integration with security systems is straightforward.' },
            'acoustic_detection': { current: 3, target: 7, note: 'Audio ML models require extensive training data. False positive management is critical.' },
            'digital_twin': { current: 3, target: 7, note: 'Simulation technology with heavy data requirements. Model fidelity requires iterative refinement.' },
            'perimeter_fusion': { current: 4, target: 8, note: 'Multi-sensor fusion algorithms proven in defence. Adaptation for commercial use manageable.' },
            'cyber_physical_soc': { current: 4, target: 8, note: 'Integration of IT and OT security. Architecture complexity is main challenge.' },
            'camera_health': { current: 6, target: 9, note: 'Predictive analytics on camera telemetry. Well-understood ML application.' },
            'panic_wearable': { current: 6, target: 9, note: 'Wearable technology with proven components. Miniaturisation and battery life optimisation needed.' },
            'vehicle_intelligence': { current: 4, target: 8, note: 'Computer vision for vehicle analysis. Training data collection is key milestone.' },
            'compliance_automation': { current: 6, target: 9, note: 'Report automation with standard integrations. Template library development is main effort.' },
            'deepfake_defense': { current: 3, target: 7, note: 'Rapidly evolving adversarial landscape. Continuous model updates required.' },
            'edge_micro_nvr': { current: 6, target: 9, note: 'Edge computing with proven hardware. Software optimisation for resource constraints.' },
            'rapid_deploy_kit': { current: 7, target: 9, note: 'Packaging of existing technology. Industrial design and logistics focus.' },
            'predictive_risk': { current: 3, target: 7, note: 'ML models require extensive historical data. Model validation is critical milestone.' },
            'visitor_flow': { current: 5, target: 9, note: 'People counting with mature CV technology. Integration with access systems needed.' },
            'security_score': { current: 4, target: 8, note: 'Risk scoring algorithms require calibration. Data collection for model training.' },
            'smart_key_control': { current: 6, target: 9, note: 'Key management with proven technology. Hardware-software integration focus.' },
            'emergency_muster': { current: 5, target: 9, note: 'Location tracking with standard protocols. Integration with HR systems required.' },
            'night_escort': { current: 6, target: 9, note: 'Mobile app with proven location services. Service design more critical than technology.' },
            'guard_training_sim': { current: 4, target: 8, note: 'Simulation technology with VR/AR elements. Content development is major effort.' },
            'incident_invoice': { current: 6, target: 9, note: 'Billing automation with standard integrations. Workflow customisation for each client.' },
            'parking_security': { current: 5, target: 9, note: 'LPR technology mature. Integration with parking systems is key challenge.' },
            'shrink_prevention': { current: 5, target: 8, note: 'Retail analytics with CV and POS integration. Model training on loss patterns.' },
            'alarm_response_network': { current: 5, target: 9, note: 'Dispatch platform with proven architecture. Partner integration is main effort.' },
            'camera_subscription': { current: 6, target: 9, note: 'Cloud video with proven infrastructure. Provisioning automation focus.' },
            'privacy_analytics': { current: 4, target: 8, note: 'Privacy-preserving analytics. Edge processing to avoid data transmission.' },
            'guard_tour_proof': { current: 6, target: 9, note: 'NFC/GPS tracking with proven technology. Mobile app and reporting focus.' },
            'smart_intercom': { current: 6, target: 9, note: 'Video intercom with proven components. Cloud integration and mobile app.' },
            'wander_management': { current: 5, target: 8, note: 'Location tracking for healthcare. Regulatory compliance (HIPAA-like) required.' },
            'contractor_screening': { current: 5, target: 9, note: 'Background check integration. API connections to verification databases.' },
            'ai_video_search': { current: 4, target: 8, note: 'Natural language video search. Large-scale indexing infrastructure required.' },
            'safety_security_soc': { current: 4, target: 8, note: 'EHS and security integration. Multi-system correlation engine development.' },
            'anti_drone_service': { current: 3, target: 7, note: 'Counter-drone technology evolving rapidly. Regulatory framework still developing.' },
            'predictive_door_maintenance': { current: 5, target: 9, note: 'IoT sensors with predictive ML. Failure mode data collection needed.' },
            
            // Legacy archetypes
            'legacy_incremental': { current: 7, target: 9, note: 'Enhancement of production system. Well-understood development path.' },
            'legacy_pet_project': { current: 3, target: 7, note: 'Technically uncertain project with sponsor protection. Real TRL may be lower than claimed.' },
            'legacy_strategic_troubled': { current: 4, target: 8, note: 'Strategic technology facing execution challenges. Recovery plan needed.' },
            'legacy_partnership': { current: 5, target: 8, note: 'Partner-dependent technology. Integration complexity is main risk.' },
            'legacy_defensive': { current: 6, target: 9, note: 'Competitive response with proven technology. Speed to market is critical.' },
            'legacy_infrastructure': { current: 3, target: 7, note: 'Internal systems modernisation. Migration complexity is significant.' }
        };
        return trlMapping[archetype] || { current: 5, target: 8, note: 'Standard development path with manageable technical risk.' };
    }
    
    function getIPPosition(archetype, projectName) {
        const ipPositions = {
            'conventional_winner': {
                shieldtech: 'ShieldTech holds 3 design patents on housing aesthetics and 2 utility patents on ShieldOS integration protocols. Trade secrets protect manufacturing processes. Solid defensive position.',
                competitors: 'Yale holds foundational smart lock patents (US8593249, expiring 2026). Godrej has Indian design registrations. Xiaomi relies on Chinese utility models not enforceable in India. Landscape is navigable.',
                fto: 'Freedom to operate is CLEAR. No blocking patents identified. Design-around for Yale\'s motorised deadbolt mechanism documented as precaution.',
                risk: 'Low'
            },
            'conventional_loser': {
                shieldtech: 'Research partnership with IISc includes joint IP provisions—ShieldTech gets exclusive commercial license for security applications. Early filing opportunity as field develops.',
                competitors: 'Field is pre-competitive with mostly academic publications. IBM and Google hold broad patents that may become relevant but licensing is standard. First-mover advantage possible.',
                fto: 'Freedom to operate assessment ongoing as technology develops. Early-stage means opportunity to design around any issues identified. IP counsel monitoring landscape.',
                risk: 'Medium'
            },
            'hidden_gem': {
                shieldtech: 'Limited existing IP in this segment—opportunity to establish position. Design patents on form factor and utility patents on detection algorithms filed with this project.',
                competitors: 'Philips holds elder care monitoring patents focused on clinical settings, not home use. Indian market has few registered IP rights in niche. First-mover advantage achievable.',
                fto: 'Freedom to operate is LIKELY CLEAR. FTO search completed for core functionality. Philips patents don\'t cover home monitoring use case.',
                risk: 'Low'
            },
            'slow_burner': {
                shieldtech: 'ShieldTech holds API design copyrights and ShieldOS trademark. Platform architecture documented as trade secret. Opportunity to patent integration innovations.',
                competitors: 'Matter protocol is royalty-free standard. Amazon and Google license smart home patents freely within their ecosystems. Standard licensing terms apply.',
                fto: 'Freedom to operate is CLEAR for Matter-compliant implementations. Proprietary integrations designed to avoid known patent clusters.',
                risk: 'Low'
            },
            'paper_tiger': {
                shieldtech: 'Opportunity to patent sensor fusion algorithms and thermal-visual combination methods. Engineering team documenting innovations for IP review.',
                competitors: 'Hikvision holds CCTV patents globally. Ambarella patents on edge AI chips available through standard licensing. Licensing costs budgeted in BOM.',
                fto: 'Freedom to operate REQUIRES LICENSING. Ambarella chip licensing standard and budgeted. Custom algorithms designed to create new protectable IP.',
                risk: 'Medium'
            },
            'money_pit': {
                shieldtech: 'All platform code is proprietary work product. Architecture documents protected as trade secrets. New platform will generate additional trade secrets.',
                competitors: 'No direct IP conflict—internal infrastructure. Cloud architecture uses standard AWS/Azure services under normal licensing terms.',
                fto: 'Freedom to operate is CLEAR. Internal platform choices with standard cloud provider terms. No external IP dependencies.',
                risk: 'Low'
            },
            'pivot_success': {
                shieldtech: 'Messaging encryption uses open-source Signal protocol (MIT license). Opportunity to patent novel workflow and coordination features.',
                competitors: 'WhatsApp/Signal encryption freely licensed. Community platform IP fragmented across small players—limited blocking risk.',
                fto: 'Freedom to operate is CLEAR with open protocols. Novel features being documented for potential patent filing.',
                risk: 'Low'
            },
            'team_dependent': {
                shieldtech: 'IP position depends on innovation direction. Clear invention assignment agreements in place. Team briefed on documentation requirements.',
                competitors: 'Landscape assessment will be conducted once direction chosen. Team includes IP-aware engineers who will flag freedom-to-operate considerations.',
                fto: 'Freedom to operate to be assessed as technical direction emerges. Standard process integrated into milestone reviews.',
                risk: 'Low'
            },
            'competitive_casualty': {
                shieldtech: 'Budget products use commodity components with minimal proprietary elements. Focus on trade secrets in cost engineering and supply chain.',
                competitors: 'Chinese manufacturers hold design registrations in China with limited international protection. No blocking patents in commodity segment.',
                fto: 'Freedom to operate is CLEAR. Commodity technology with no blocking patents. Design differentiation documented.',
                risk: 'Low'
            },
            'sustainability_play': {
                shieldtech: 'Opportunity to patent sustainable manufacturing processes and material compositions. First-mover advantage in green security IP.',
                competitors: 'Limited IP in sustainable security products. Broader green tech patents are material-supplier owned—licensing included in supply agreements.',
                fto: 'Freedom to operate is CLEAR. Emerging field with limited patent density. Material supplier agreements include necessary IP rights.',
                risk: 'Low'
            },
            'ip_fortress': {
                shieldtech: '12 patents pending covering sensor fusion, detection algorithms, and signal processing. 3 trade secrets in calibration methods. Building strong defensive position.',
                competitors: 'Bosch holds MEMS sensor patents. Texas Instruments has signal processing IP. Design choices made to work within or around existing patents.',
                fto: 'Freedom to operate LARGELY CLEAR. Core novel algorithms clear. MEMS implementation uses licensed Bosch technology per standard terms.',
                risk: 'Low-Medium'
            },
            
            // Core product archetypes
            'core_upgrade': {
                shieldtech: 'Builds on existing ShieldTech IP portfolio. Incremental innovations documented for potential filing.',
                competitors: 'Established players hold relevant patents but licensing paths clear. No blocking IP identified.',
                fto: 'Freedom to operate CLEAR. Extension of existing licensed technologies.',
                risk: 'Low'
            },
            'value_segment': {
                shieldtech: 'Focus on manufacturing trade secrets rather than patents. Cost engineering methods protected.',
                competitors: 'Generic Chinese imports have limited IP protection. No blocking patents for commodity features.',
                fto: 'Freedom to operate CLEAR. Commodity technology segment with minimal IP barriers.',
                risk: 'Low'
            },
            'premium_flagship': {
                shieldtech: 'Multiple patent opportunities in advanced features. Design patents on premium aesthetics.',
                competitors: 'Premium competitors have strong IP but focused on enterprise. Consumer premium segment less protected.',
                fto: 'Freedom to operate REQUIRES REVIEW. Premium features may touch competitor patents—design-arounds documented.',
                risk: 'Medium'
            },
            'niche_vertical': {
                shieldtech: 'Limited existing IP in niche. Opportunity to establish defensive position early.',
                competitors: 'Niche segments typically have fragmented IP landscape. No dominant patent holders identified.',
                fto: 'Freedom to operate LIKELY CLEAR. Niche application reduces patent density.',
                risk: 'Low'
            },
            'underserved_market': {
                shieldtech: 'Ruggedisation methods documented as trade secrets. Limited patentable innovations.',
                competitors: 'Industrial players hold rugged design patents but different application domain.',
                fto: 'Freedom to operate CLEAR. Consumer ruggedisation distinct from industrial IP.',
                risk: 'Low'
            },
            'platform_infrastructure': {
                shieldtech: 'APIs and architecture protected as trade secrets. Copyright on code base.',
                competitors: 'Platform patents held by major tech companies but licensing terms standard.',
                fto: 'Freedom to operate CLEAR with standard licenses. Architecture choices avoid known patents.',
                risk: 'Low'
            },
            'market_explorer': {
                shieldtech: 'IP strategy TBD pending market validation. Documentation practices in place.',
                competitors: 'Emerging market with limited patent density. First-mover IP advantage possible.',
                fto: 'Freedom to operate assessment ongoing. Early stage reduces IP risk.',
                risk: 'Low'
            },
            'price_fighter': {
                shieldtech: 'Cost engineering trade secrets. No patentable innovations expected.',
                competitors: 'Low-cost segment has minimal IP protection. Commodity technology.',
                fto: 'Freedom to operate CLEAR. Commodity segment with no blocking patents.',
                risk: 'Low'
            },
            'esg_initiative': {
                shieldtech: 'Sustainable process innovations may be patentable. Supply chain trade secrets.',
                competitors: 'Green technology IP held by material suppliers—licensing included.',
                fto: 'Freedom to operate CLEAR. Material suppliers provide necessary IP rights.',
                risk: 'Low'
            },
            'proprietary_tech': {
                shieldtech: 'Strong patent filing strategy. 5+ patent applications planned.',
                competitors: 'Novel technology area with limited prior art. Defensive moat building.',
                fto: 'Freedom to operate being established. Novel approach minimizes conflict.',
                risk: 'Low-Medium'
            },
            'frontier_tech': {
                shieldtech: 'Research IP strategy with academic partners. Joint filing provisions in place.',
                competitors: 'Pre-competitive research with mostly academic IP. Licensing paths available.',
                fto: 'Freedom to operate evolving. Early stage allows design flexibility.',
                risk: 'Medium'
            },
            
            // AI and advanced tech archetypes
            'ai_guard_innovation': {
                shieldtech: 'AI model architecture as trade secret. Edge deployment methods documented for filing.',
                competitors: 'Computer vision patents dense but specific implementations clear. Standard ML techniques freely available.',
                fto: 'Freedom to operate LARGELY CLEAR. Custom models avoid competitor IP.',
                risk: 'Low-Medium'
            },
            'services_platform': {
                shieldtech: 'Platform code protected by copyright. Service delivery methods as trade secrets.',
                competitors: 'Monitoring service IP fragmented. No blocking patents for cloud delivery model.',
                fto: 'Freedom to operate CLEAR. Service innovation rather than technology IP.',
                risk: 'Low'
            },
            'autonomous_drone': {
                shieldtech: 'Flight control customisations documented. Regulatory compliance methods unique.',
                competitors: 'DJI holds extensive drone patents. Design choices made for India-specific compliance.',
                fto: 'Freedom to operate REQUIRES LICENSING. DJI patents navigable with standard terms.',
                risk: 'Medium'
            },
            'ground_robot': {
                shieldtech: 'Navigation algorithms in development. Trade secrets on Indian environment adaptation.',
                competitors: 'Mobile robotics patents held by Boston Dynamics, Knightscope. Licensing paths exist.',
                fto: 'Freedom to operate REQUIRES REVIEW. Novel navigation approach being validated.',
                risk: 'Medium-High'
            },
            'privacy_compliance': {
                shieldtech: 'Privacy-preserving algorithms potentially patentable. Implementation as trade secret.',
                competitors: 'Privacy tech IP emerging. Apple, Google hold broad patents but licensing available.',
                fto: 'Freedom to operate LARGELY CLEAR. Compliance implementation distinct from platform IP.',
                risk: 'Low-Medium'
            },
            'evidence_chain': {
                shieldtech: 'Blockchain implementation uses open protocols. Evidence packaging innovations protectable.',
                competitors: 'Axon holds body camera evidence IP. Enterprise security evidence chains less protected.',
                fto: 'Freedom to operate CLEAR. Open blockchain protocols and standard cryptography.',
                risk: 'Low'
            },
            'smart_access': {
                shieldtech: 'Risk scoring algorithms as trade secrets. Integration methods documented.',
                competitors: 'Access control IP held by HID, Suprema. Standard integration approaches clear.',
                fto: 'Freedom to operate LARGELY CLEAR. Novel risk approach avoids existing IP.',
                risk: 'Low'
            },
            'rtls_tracking': {
                shieldtech: 'UWB implementation uses standard protocols. Fusion with security systems novel.',
                competitors: 'UWB patents held by Apple, Zebra. Licensing costs factored into BOM.',
                fto: 'Freedom to operate with LICENSE. Standard UWB licensing terms.',
                risk: 'Low-Medium'
            },
            'acoustic_detection': {
                shieldtech: 'Audio ML models as trade secrets. Detection algorithms potentially patentable.',
                competitors: 'Gunshot detection patents held by ShotSpotter. Different approach minimizes conflict.',
                fto: 'Freedom to operate LARGELY CLEAR. Novel acoustic approach documented.',
                risk: 'Low-Medium'
            },
            'digital_twin': {
                shieldtech: 'Simulation models as trade secrets. Facility-specific optimizations proprietary.',
                competitors: 'Digital twin IP held by Siemens, GE in industrial context. Security application distinct.',
                fto: 'Freedom to operate CLEAR for security application. Industrial patents not relevant.',
                risk: 'Low'
            },
            'perimeter_fusion': {
                shieldtech: 'Sensor fusion algorithms potentially patentable. Integration architecture as trade secret.',
                competitors: 'Defence contractors hold perimeter IP but different application domain.',
                fto: 'Freedom to operate LARGELY CLEAR. Commercial adaptation distinct from defence IP.',
                risk: 'Low-Medium'
            },
            'cyber_physical_soc': {
                shieldtech: 'Correlation engine as trade secret. Integration methods documented.',
                competitors: 'SIEM vendors hold IT security IP. Physical security integration less protected.',
                fto: 'Freedom to operate CLEAR. Novel IT-OT convergence approach.',
                risk: 'Low'
            },
            'camera_health': {
                shieldtech: 'Predictive models as trade secrets. Diagnostic methods potentially patentable.',
                competitors: 'Camera vendors have limited predictive maintenance IP. Field is open.',
                fto: 'Freedom to operate CLEAR. Novel predictive approach in security domain.',
                risk: 'Low'
            },
            'panic_wearable': {
                shieldtech: 'Wearable design potentially protectable. Fall detection algorithms as trade secrets.',
                competitors: 'Medical alert IP held by Philips Lifeline. Consumer safety distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Consumer focus avoids medical device IP.',
                risk: 'Low'
            },
            'vehicle_intelligence': {
                shieldtech: 'Intent scoring algorithms as trade secrets. Vehicle pattern analysis protectable.',
                competitors: 'LPR patents dense but commodity. Advanced analytics less protected.',
                fto: 'Freedom to operate CLEAR. Novel behavioral analysis distinct from basic LPR.',
                risk: 'Low'
            },
            'compliance_automation': {
                shieldtech: 'Report templates as trade secrets. Workflow automation proprietary.',
                competitors: 'GRC vendors have broad patents but different domain. Security compliance distinct.',
                fto: 'Freedom to operate CLEAR. Security-specific compliance tooling.',
                risk: 'Low'
            },
            'deepfake_defense': {
                shieldtech: 'Detection models as trade secrets. Liveness methods potentially patentable.',
                competitors: 'Biometric vendors hold liveness IP. Licensing paths available.',
                fto: 'Freedom to operate REQUIRES LICENSING. Liveness component licensing standard.',
                risk: 'Medium'
            },
            'edge_micro_nvr': {
                shieldtech: 'Firmware as trade secret. Sync protocol potentially protectable.',
                competitors: 'NVR patents held by Hikvision, Verkada. Edge approach provides differentiation.',
                fto: 'Freedom to operate LARGELY CLEAR. Edge-first architecture distinct.',
                risk: 'Low'
            },
            'rapid_deploy_kit': {
                shieldtech: 'Packaging design protectable. Quick-deploy methods as trade secrets.',
                competitors: 'Temporary security IP fragmented. No blocking patents identified.',
                fto: 'Freedom to operate CLEAR. Novel packaging and deployment approach.',
                risk: 'Low'
            },
            'predictive_risk': {
                shieldtech: 'Risk prediction models as trade secrets. Scoring methodology proprietary.',
                competitors: 'Insurance and security risk IP fragmented. Novel approach has freedom.',
                fto: 'Freedom to operate CLEAR. Unique risk scoring methodology.',
                risk: 'Low'
            },
            'visitor_flow': {
                shieldtech: 'People counting algorithms widely available. Integration approach proprietary.',
                competitors: 'Retail analytics IP dense but different application. Security use distinct.',
                fto: 'Freedom to operate CLEAR. Security integration distinct from retail analytics.',
                risk: 'Low'
            },
            'security_score': {
                shieldtech: 'Scoring algorithms as trade secrets. Methodology proprietary to ShieldTech.',
                competitors: 'No direct competitor IP. Novel category with freedom to establish.',
                fto: 'Freedom to operate CLEAR. First-mover in security scoring.',
                risk: 'Low'
            },
            'smart_key_control': {
                shieldtech: 'Key management methods as trade secrets. Hardware design protectable.',
                competitors: 'Key cabinet IP held by KeyTrak, others. Electronic key control distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Smart approach avoids mechanical IP.',
                risk: 'Low'
            },
            'emergency_muster': {
                shieldtech: 'Muster algorithms as trade secrets. Integration with access systems proprietary.',
                competitors: 'EHS vendors have broad IP but muster-specific coverage limited.',
                fto: 'Freedom to operate CLEAR. Security-first muster approach distinct.',
                risk: 'Low'
            },
            'night_escort': {
                shieldtech: 'Service design as trade secret. App features standard.',
                competitors: 'Safety app IP fragmented. Service innovation rather than technology.',
                fto: 'Freedom to operate CLEAR. Service model distinct from technology IP.',
                risk: 'Low'
            },
            'guard_training_sim': {
                shieldtech: 'Training content as trade secret. Simulation methods potentially protectable.',
                competitors: 'Training simulation IP in defence sector. Commercial security training open.',
                fto: 'Freedom to operate CLEAR. Commercial training distinct from defence IP.',
                risk: 'Low'
            },
            'incident_invoice': {
                shieldtech: 'Billing automation as trade secret. Integration methods proprietary.',
                competitors: 'Billing software IP not relevant. Security-specific integration novel.',
                fto: 'Freedom to operate CLEAR. Novel security billing automation.',
                risk: 'Low'
            },
            'parking_security': {
                shieldtech: 'Integration approach proprietary. Analytics methods as trade secrets.',
                competitors: 'Parking IP held by specialized vendors. Security overlay distinct.',
                fto: 'Freedom to operate CLEAR. Security integration distinct from parking IP.',
                risk: 'Low'
            },
            'shrink_prevention': {
                shieldtech: 'Loss detection algorithms as trade secrets. POS integration proprietary.',
                competitors: 'Retail LP IP held by Checkpoint, Sensormatic. Analytics approach distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Analytics-first approach avoids hardware IP.',
                risk: 'Low'
            },
            'alarm_response_network': {
                shieldtech: 'Dispatch algorithms as trade secrets. Partner network proprietary.',
                competitors: 'Monitoring centre IP fragmented. Network model novel.',
                fto: 'Freedom to operate CLEAR. Novel response network approach.',
                risk: 'Low'
            },
            'camera_subscription': {
                shieldtech: 'Subscription management as trade secret. Cloud architecture standard.',
                competitors: 'VSaaS IP held by Eagle Eye, Verkada. Provisioning approach distinct.',
                fto: 'Freedom to operate CLEAR. Subscription model distinct from technology IP.',
                risk: 'Low'
            },
            'privacy_analytics': {
                shieldtech: 'Edge processing methods as trade secrets. Privacy approach potentially patentable.',
                competitors: 'Privacy analytics emerging field. Limited blocking IP.',
                fto: 'Freedom to operate LARGELY CLEAR. Novel privacy-first approach.',
                risk: 'Low'
            },
            'guard_tour_proof': {
                shieldtech: 'Proof methods as trade secrets. Verification algorithms proprietary.',
                competitors: 'Guard tour IP held by STANLEY, Trackforce. Proof-centric approach distinct.',
                fto: 'Freedom to operate CLEAR. Novel verification methodology.',
                risk: 'Low'
            },
            'smart_intercom': {
                shieldtech: 'Cloud integration as trade secret. Video calling uses standard protocols.',
                competitors: 'Intercom IP held by Aiphone, 2N. Cloud approach provides differentiation.',
                fto: 'Freedom to operate LARGELY CLEAR. Cloud-first approach distinct.',
                risk: 'Low'
            },
            'wander_management': {
                shieldtech: 'Tracking algorithms as trade secrets. Healthcare integration proprietary.',
                competitors: 'Healthcare tracking IP in different regulatory context. Consumer version distinct.',
                fto: 'Freedom to operate CLEAR. Consumer healthcare distinct from clinical IP.',
                risk: 'Low'
            },
            'contractor_screening': {
                shieldtech: 'Verification workflow as trade secret. Integration methods proprietary.',
                competitors: 'Background check IP held by service providers. Integration approach distinct.',
                fto: 'Freedom to operate CLEAR. Orchestration distinct from verification IP.',
                risk: 'Low'
            },
            'ai_video_search': {
                shieldtech: 'Search algorithms potentially patentable. Index methods as trade secrets.',
                competitors: 'Video search IP held by Google, Amazon. Security context provides distinction.',
                fto: 'Freedom to operate LARGELY CLEAR. Security-specific search implementation.',
                risk: 'Low-Medium'
            },
            'safety_security_soc': {
                shieldtech: 'Correlation algorithms as trade secrets. Integration architecture proprietary.',
                competitors: 'EHS and security SOC IP fragmented. Convergence approach novel.',
                fto: 'Freedom to operate CLEAR. Novel safety-security convergence.',
                risk: 'Low'
            },
            'anti_drone_service': {
                shieldtech: 'Detection methods as trade secrets. Response protocols proprietary.',
                competitors: 'Counter-drone IP held by defence contractors. Commercial service distinct.',
                fto: 'Freedom to operate LARGELY CLEAR. Service model distinct from equipment IP.',
                risk: 'Low-Medium'
            },
            'predictive_door_maintenance': {
                shieldtech: 'Prediction models as trade secrets. Sensor fusion proprietary.',
                competitors: 'Predictive maintenance IP in industrial context. Door-specific application distinct.',
                fto: 'Freedom to operate CLEAR. Door-specific application novel.',
                risk: 'Low'
            },
            
            // Legacy archetypes
            'legacy_incremental': {
                shieldtech: 'Builds on existing IP portfolio. Incremental improvements documented.',
                competitors: 'Established landscape. No new IP concerns.',
                fto: 'Freedom to operate CLEAR. Extension of existing position.',
                risk: 'Low'
            },
            'legacy_pet_project': {
                shieldtech: 'IP position unclear. Documentation practices inconsistent.',
                competitors: 'Unknown IP landscape. Assessment needed.',
                fto: 'Freedom to operate UNCERTAIN. IP review recommended.',
                risk: 'Medium'
            },
            'legacy_strategic_troubled': {
                shieldtech: 'Original IP strategy may need revision. Documentation review underway.',
                competitors: 'Competitive IP landscape may have shifted. Reassessment needed.',
                fto: 'Freedom to operate REQUIRES REVIEW. Strategy pivot may affect IP.',
                risk: 'Medium'
            },
            'legacy_partnership': {
                shieldtech: 'Joint IP provisions in partnership agreement. ShieldTech retains implementation rights.',
                competitors: 'Partner provides IP coverage for joint technology.',
                fto: 'Freedom to operate CLEAR per partnership terms.',
                risk: 'Low'
            },
            'legacy_defensive': {
                shieldtech: 'Competitive response uses established technology. Limited new IP.',
                competitors: 'Responding to competitor move. Established IP landscape.',
                fto: 'Freedom to operate CLEAR. Defensive position well-understood.',
                risk: 'Low'
            },
            'legacy_infrastructure': {
                shieldtech: 'Internal systems with no external IP exposure.',
                competitors: 'Not applicable for internal infrastructure.',
                fto: 'Freedom to operate CLEAR. Internal use only.',
                risk: 'Low'
            }
        };
        return ipPositions[archetype] || { shieldtech: 'IP assessment in progress.', competitors: 'Competitor IP analysis underway.', fto: 'FTO review scheduled.', risk: 'Low' };
    }
    
    

    // Fallback competitors so every archetype lists a plausible competitive set
    function generateCompetitorsFallback(archetype) {
        const domain = inferMarketDomainFromArchetype(archetype);
        const a = (archetype || '').toLowerCase();

        const sets = {
            'video surveillance & analytics': [
                { name: 'Hikvision', position: 'Global surveillance incumbent with broad channel reach and aggressive pricing.', threat: 'Medium' },
                { name: 'Dahua', position: 'High-volume competitor strong on value hardware; fast to copy features.', threat: 'Medium' },
                { name: 'Axis / Bosch', position: 'Premium enterprise brands; win on reliability, integrations, and installer trust.', threat: 'Low' },
                { name: 'CP Plus / local OEMs', position: 'Strong India distribution; compete on bundles and service networks.', threat: 'Low' }
            ],
            'guarding & field operations': [
                { name: 'G4S / Allied Universal', position: 'Large guard services; process maturity and enterprise contracts.', threat: 'Medium' },
                { name: 'SIS (India) / local majors', position: 'Deep India footprint; price competitive and relationship driven.', threat: 'Medium' },
                { name: 'Facility management suites', position: 'Bundled ops tooling; security is a module, not the core focus.', threat: 'Low' },
                { name: 'Regional agencies', position: 'Fragmented providers; compete on price and staffing availability.', threat: 'Low' }
            ],
            'drones & counter-drone security': [
                { name: 'DJI', position: 'Category leader; hardware ecosystem and strong developer support.', threat: 'Medium' },
                { name: 'Skydio / autonomy vendors', position: 'Autonomous flight + CV stacks; strong differentiation in capability.', threat: 'Medium' },
                { name: 'ideaForge / local OEMs', position: 'Local procurement advantage; building B2B/government presence.', threat: 'Low' },
                { name: 'Dedrone / counter-UAS', position: 'Specialists in detection/mitigation; can be partners or competitors.', threat: 'Low' }
            ],
            'cyber-physical security operations': [
                { name: 'Palo Alto / CrowdStrike', position: 'Security platforms expanding into operations; strong brand trust.', threat: 'Medium' },
                { name: 'Splunk / SIEM vendors', position: 'Data platforms; win where integration and analytics breadth matter.', threat: 'Medium' },
                { name: 'Managed SOC providers', position: 'Service-led competitors; compete on SLAs and staffing scale.', threat: 'Low' },
                { name: 'Niche security startups', position: 'Move fast on point solutions; often weaker on support and reliability.', threat: 'Low' }
            ],
            'compliance, evidence & governance': [
                { name: 'ServiceNow / GRC suites', position: 'Workflow incumbents; strong in enterprises with existing contracts.', threat: 'Medium' },
                { name: 'SAP / Oracle modules', position: 'Bundled compliance; heavy but sticky in large accounts.', threat: 'Low' },
                { name: 'Specialist compliance startups', position: 'Point solutions focused on audits, evidence, and reporting.', threat: 'Low' },
                { name: 'In-house tooling', position: 'Homegrown spreadsheets and scripts; main competitor is inertia.', threat: 'Low' }
            ],
            'digital twins & operational intelligence': [
                { name: 'Siemens / Honeywell', position: 'Industrial incumbents; win on integration with facilities and OT systems.', threat: 'Low' },
                { name: 'Dassault / Autodesk', position: 'Strong modelling ecosystems; broad user base and partner networks.', threat: 'Low' },
                { name: 'IoT platforms', position: 'Horizontal platforms; compete on dashboards and device connectivity.', threat: 'Low' },
                { name: 'Systems integrators', position: 'Service-led delivery; compete on relationships and implementation speed.', threat: 'Low' }
            ],
            'subscription software & platforms': [
                { name: 'Verkada / cloud VMS', position: 'Cloud-first incumbents; strong UX and subscription GTM.', threat: 'Medium' },
                { name: 'Genetec / Milestone', position: 'Enterprise ecosystems; deep integrations and partner networks.', threat: 'Low' },
                { name: 'Telecom bundles', position: 'ISP bundles; compete on distribution and discounts.', threat: 'Low' },
                { name: 'Fast-follow startups', position: 'Aggressive pricing and features; often weaker on support.', threat: 'Low' }
            ],
            'training, enablement & safety': [
                { name: 'HR/learning platforms', position: 'Generic training suites; lack security-specific depth.', threat: 'Low' },
                { name: 'Safety training vendors', position: 'Established in compliance; can extend into security workflows.', threat: 'Low' },
                { name: 'In-house training teams', position: 'Cheapest option; inconsistent and hard to scale.', threat: 'Low' },
                { name: 'Simulation startups', position: 'Innovative but unproven; compete on novelty and content.', threat: 'Low' }
            ],
            'M&A integration & platform consolidation': [
                { name: 'Integration consultancies', position: 'Service-led; win on resourcing and playbooks.', threat: 'Low' },
                { name: 'Legacy platforms', position: 'The status quo; migration risk and organizational resistance.', threat: 'Medium' },
                { name: 'New platform vendors', position: 'Push rip-and-replace; compete on speed and packaged offerings.', threat: 'Low' },
                { name: 'Internal complexity', position: 'The real competitor is change management and execution risk.', threat: 'Medium' }
            ],
            'security technology & services': [
                { name: 'Large incumbents', position: 'Bundle adjacent features and sell through channel relationships.', threat: 'Medium' },
                { name: 'Regional specialists', position: 'Deep domain focus; compete on credibility and speed.', threat: 'Low' },
                { name: 'Platform ecosystems', position: 'Win via integrations and developer communities.', threat: 'Low' },
                { name: 'DIY/in-house', position: 'Manual ops and spreadsheets; inertia is the competitor.', threat: 'Low' }
            ]
        };

        const base = (sets[domain] || sets['security technology & services']).slice();

        // If it’s clearly AI-heavy but not video, add an AI-competition flavor
        if ((a.includes('ai') || a.includes('ml')) && domain !== 'video surveillance & analytics') {
            base.unshift({ name: 'Big Tech AI stacks', position: 'Commodity models + tooling; differentiation needs proprietary data + workflow lock-in.', threat: 'Medium' });
        }

        return base.slice(0, 4);
    }
function getCompetitors(archetype) {
        const competitors = {
            "acoustic_detection": [
                { "name": "FLIR", "position": "Thermal + perimeter detection systems.", "threat": "Medium" },
                { "name": "Senstar", "position": "Perimeter intrusion detection and analytics.", "threat": "Medium" },
                { "name": "Honeywell", "position": "Enterprise perimeter stacks via integrators.", "threat": "Medium" },
                { "name": "Local integrators", "position": "Custom sensor fusion projects.", "threat": "Medium" }
            ],
            "acquisition_integration": [
                { "name": "Genetec", "position": "Stable enterprise platform; can win during migration churn.", "threat": "Medium" },
                { "name": "Milestone", "position": "Open ecosystem; integrators can pivot quickly.", "threat": "Medium" },
                { "name": "Hikvision/Dahua", "position": "Aggressive replacement bids during uncertainty.", "threat": "Medium" },
                { "name": "Verkada", "position": "Cloud simplification pitch (availability dependent).", "threat": "Low" }
            ],
            "ai_guard_innovation": [
                { "name": "TrackTik", "position": "Guard workforce management platform.", "threat": "Medium" },
                { "name": "Silvertrac", "position": "Guard tour + reporting workflows.", "threat": "Low" },
                { "name": "Local guard ops apps", "position": "Low-cost attendance + tour verification.", "threat": "High" },
                { "name": "Security agencies", "position": "May bundle their own tooling with contracts.", "threat": "Medium" }
            ],
            "ai_video_search": [
                { "name": "BriefCam", "position": "Video synopsis/search; enterprise credibility.", "threat": "High" },
                { "name": "Genetec", "position": "VMS ecosystem; search via analytics partners.", "threat": "Medium" },
                { "name": "Hikvision/Dahua analytics", "position": "Bundled features at low cost.", "threat": "Medium" },
                { "name": "Verkada", "position": "Cloud UX with fast search (availability dependent).", "threat": "Low" }
            ],
            "alarm_response_network": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "anti_drone_service": [
                { "name": "Dedrone", "position": "Counter\u2011UAS detection and RF sensing platform.", "threat": "Medium" },
                { "name": "DroneShield", "position": "Detection and mitigation offerings; defense-aligned positioning.", "threat": "Medium" },
                { "name": "BEL / defense integrators", "position": "Local procurement familiarity and system integration.", "threat": "High" },
                { "name": "Event security vendors", "position": "Ad-hoc deployments; lower tech but entrenched relationships.", "threat": "Medium" }
            ],
            "autonomous_drone": [
                { "name": "ideaForge", "position": "Indian enterprise drones; strong go-to-market.", "threat": "High" },
                { "name": "DJI Enterprise", "position": "Best-in-class hardware; policy sensitivity.", "threat": "Medium" },
                { "name": "Skydio", "position": "Autonomy-focused; limited India footprint.", "threat": "Low" },
                { "name": "Local drone integrators", "position": "Service-led offerings; variable quality.", "threat": "Medium" }
            ],
            "camera_health": [
                { "name": "Hikvision", "position": "Dominant hardware breadth; aggressive pricing.", "threat": "High" },
                { "name": "Dahua", "position": "Competitive pricing and features across tiers.", "threat": "High" },
                { "name": "CP Plus", "position": "India-focused distribution and support.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Premium quality; enterprise credibility.", "threat": "Medium" }
            ],
            "camera_subscription": [
                { "name": "Hikvision", "position": "Dominant hardware breadth; aggressive pricing.", "threat": "High" },
                { "name": "Dahua", "position": "Competitive pricing and features across tiers.", "threat": "High" },
                { "name": "CP Plus", "position": "India-focused distribution and support.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Premium quality; enterprise credibility.", "threat": "Medium" }
            ],
            "capability_build": [
                { "name": "AWS SageMaker", "position": "Managed ML platform; accelerates model ops.", "threat": "Medium" },
                { "name": "Google Vertex AI", "position": "Managed training + deployment workflows.", "threat": "Medium" },
                { "name": "Open-source MLOps (Kubeflow)", "position": "Cost-efficient; high engineering burden.", "threat": "Medium" },
                { "name": "Specialist AI vendors", "position": "Outsourced model development; dependency risk.", "threat": "Medium" }
            ],
            "competitive_casualty": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "compliance_automation": [
                { "name": "ServiceNow GRC", "position": "Enterprise workflow platform; compliance modules.", "threat": "Medium" },
                { "name": "Resolver", "position": "Risk + incident tooling used by enterprises.", "threat": "Medium" },
                { "name": "Audit consultancies", "position": "Manual compliance execution; relationships.", "threat": "High" },
                { "name": "In-house spreadsheets", "position": "Status quo; hard to displace.", "threat": "High" }
            ],
            "contractor_screening": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "conventional_loser": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "conventional_winner": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "core_upgrade": [
                { "name": "Hikvision", "position": "Dominant hardware breadth; aggressive pricing.", "threat": "High" },
                { "name": "Dahua", "position": "Competitive pricing and features across tiers.", "threat": "High" },
                { "name": "CP Plus", "position": "India-focused distribution and support.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Premium quality; enterprise credibility.", "threat": "Medium" }
            ],
            "cyber_physical_soc": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "deepfake_defense": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "digital_twin": [
                { "name": "Honeywell Forge", "position": "Facilities digital twin + ops dashboards.", "threat": "Medium" },
                { "name": "Siemens", "position": "Building digitalization and security integration.", "threat": "Medium" },
                { "name": "Johnson Controls", "position": "Enterprise facilities platform.", "threat": "Medium" },
                { "name": "Matterport ecosystem", "position": "3D capture; needs security integration.", "threat": "Low" }
            ],
            "edge_micro_nvr": [
                { "name": "Hikvision", "position": "Dominant hardware breadth; aggressive pricing.", "threat": "High" },
                { "name": "Dahua", "position": "Competitive pricing and features across tiers.", "threat": "High" },
                { "name": "CP Plus", "position": "India-focused distribution and support.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Premium quality; enterprise credibility.", "threat": "Medium" }
            ],
            "emergency_muster": [
                { "name": "Everbridge", "position": "Notification + safety workflows.", "threat": "Medium" },
                { "name": "Honeywell Safety", "position": "Bundled into enterprise safety stacks.", "threat": "Medium" },
                { "name": "Motorola Solutions", "position": "Command center and incident response tooling.", "threat": "Medium" },
                { "name": "Manual processes", "position": "Clipboards/spreadsheets; entrenched habit.", "threat": "High" }
            ],
            "emerging_segment": [
                { "name": "Xiaomi / Tapo", "position": "Online-first SMB/consumer overlap.", "threat": "High" },
                { "name": "CP Plus", "position": "Dealer channels for SMB installs.", "threat": "High" },
                { "name": "Local installers", "position": "Service relationship; low switching cost.", "threat": "High" },
                { "name": "DIY alarm brands", "position": "Low upfront cost and simple kits.", "threat": "Medium" }
            ],
            "esg_initiative": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "evidence_chain": [
                { "name": "Axon", "position": "Evidence management; chain-of-custody tooling.", "threat": "Medium" },
                { "name": "Genetec Clearance", "position": "Evidence sharing + collaboration workflows.", "threat": "Medium" },
                { "name": "NICE", "position": "Enterprise incident and evidence workflows.", "threat": "Medium" },
                { "name": "Manual forensic vendors", "position": "Service-based evidence packaging.", "threat": "High" }
            ],
            "frontier_tech": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "ground_robot": [
                { "name": "Knightscope", "position": "Security robots; strong brand recognition.", "threat": "Low" },
                { "name": "Cobalt Robotics", "position": "Indoor security robot + remote ops.", "threat": "Low" },
                { "name": "Local robotics startups", "position": "Cost-competitive; support risk.", "threat": "Medium" },
                { "name": "Traditional guarding", "position": "Human guards remain default baseline.", "threat": "High" }
            ],
            "guard_tour_proof": [
                { "name": "TrackTik", "position": "Guard workforce management platform.", "threat": "Medium" },
                { "name": "Silvertrac", "position": "Guard tour + reporting workflows.", "threat": "Low" },
                { "name": "Local guard ops apps", "position": "Low-cost attendance + tour verification.", "threat": "High" },
                { "name": "Security agencies", "position": "May bundle their own tooling with contracts.", "threat": "Medium" }
            ],
            "guard_training_sim": [
                { "name": "TrackTik", "position": "Guard workforce management platform.", "threat": "Medium" },
                { "name": "Silvertrac", "position": "Guard tour + reporting workflows.", "threat": "Low" },
                { "name": "Local guard ops apps", "position": "Low-cost attendance + tour verification.", "threat": "High" },
                { "name": "Security agencies", "position": "May bundle their own tooling with contracts.", "threat": "Medium" }
            ],
            "hidden_gem": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "incident_invoice": [
                { "name": "Axon", "position": "Evidence management; chain-of-custody tooling.", "threat": "Medium" },
                { "name": "Genetec Clearance", "position": "Evidence sharing + collaboration workflows.", "threat": "Medium" },
                { "name": "NICE", "position": "Enterprise incident and evidence workflows.", "threat": "Medium" },
                { "name": "Manual forensic vendors", "position": "Service-based evidence packaging.", "threat": "High" }
            ],
            "ip_fortress": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "legacy_defensive": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "legacy_incremental": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "legacy_infrastructure": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "legacy_partnership": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "legacy_pet_project": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "legacy_strategic_troubled": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "market_explorer": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "market_response": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "money_pit": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "niche_vertical": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "night_escort": [
                { "name": "Safetipin", "position": "Safety mapping and program partnerships.", "threat": "Medium" },
                { "name": "Enterprise safety vendors", "position": "SOS/worker safety bundles.", "threat": "Medium" },
                { "name": "Apple/Android SOS", "position": "Platform features reduce perceived need.", "threat": "Medium" },
                { "name": "Local security agencies", "position": "Service-led escorts and response.", "threat": "High" }
            ],
            "panic_wearable": [
                { "name": "Safetipin", "position": "Safety mapping and program partnerships.", "threat": "Medium" },
                { "name": "Enterprise safety vendors", "position": "SOS/worker safety bundles.", "threat": "Medium" },
                { "name": "Apple/Android SOS", "position": "Platform features reduce perceived need.", "threat": "Medium" },
                { "name": "Local security agencies", "position": "Service-led escorts and response.", "threat": "High" }
            ],
            "paper_tiger": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "parking_security": [
                { "name": "Rekor / OpenALPR", "position": "LPR analytics stacks.", "threat": "Medium" },
                { "name": "Hikvision LPR", "position": "Bundled cameras + LPR at scale.", "threat": "High" },
                { "name": "Park+ / parking operators", "position": "Workflow ownership; can push their own tech.", "threat": "Medium" },
                { "name": "Local barrier vendors", "position": "Hardware incumbents with bundled software.", "threat": "Medium" }
            ],
            "partnership_opportunity": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "perimeter_fusion": [
                { "name": "FLIR", "position": "Thermal + perimeter detection systems.", "threat": "Medium" },
                { "name": "Senstar", "position": "Perimeter intrusion detection and analytics.", "threat": "Medium" },
                { "name": "Honeywell", "position": "Enterprise perimeter stacks via integrators.", "threat": "Medium" },
                { "name": "Local integrators", "position": "Custom sensor fusion projects.", "threat": "Medium" }
            ],
            "pivot_success": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "platform_infrastructure": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "predictive_door_maintenance": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "predictive_risk": [
                { "name": "Big 4 consultancies", "position": "Audit-ready assessments; trusted with boards.", "threat": "High" },
                { "name": "ISO/ISMS auditors", "position": "Compliance-first posture scoring.", "threat": "Medium" },
                { "name": "GRC platforms", "position": "Risk modules adjacent to security scoring.", "threat": "Medium" },
                { "name": "Internal security teams", "position": "DIY scorecards in spreadsheets.", "threat": "High" }
            ],
            "premium_flagship": [
                { "name": "Hikvision", "position": "Dominant hardware breadth; aggressive pricing.", "threat": "High" },
                { "name": "Dahua", "position": "Competitive pricing and features across tiers.", "threat": "High" },
                { "name": "CP Plus", "position": "India-focused distribution and support.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Premium quality; enterprise credibility.", "threat": "Medium" }
            ],
            "price_fighter": [
                { "name": "Hikvision", "position": "Dominant hardware breadth; aggressive pricing.", "threat": "High" },
                { "name": "Dahua", "position": "Competitive pricing and features across tiers.", "threat": "High" },
                { "name": "CP Plus", "position": "India-focused distribution and support.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Premium quality; enterprise credibility.", "threat": "Medium" }
            ],
            "privacy_analytics": [
                { "name": "Genetec", "position": "Enterprise VMS governance and privacy controls.", "threat": "Medium" },
                { "name": "Milestone Systems", "position": "Ecosystem leader; privacy via partners and policies.", "threat": "Medium" },
                { "name": "BriefCam", "position": "Analytics with redaction and audit support.", "threat": "Medium" },
                { "name": "In-house IT/security", "position": "Process + tooling to satisfy privacy requirements.", "threat": "High" }
            ],
            "privacy_compliance": [
                { "name": "Genetec", "position": "Enterprise VMS governance and privacy controls.", "threat": "Medium" },
                { "name": "Milestone Systems", "position": "Ecosystem leader; privacy via partners and policies.", "threat": "Medium" },
                { "name": "BriefCam", "position": "Analytics with redaction and audit support.", "threat": "Medium" },
                { "name": "In-house IT/security", "position": "Process + tooling to satisfy privacy requirements.", "threat": "High" }
            ],
            "proprietary_tech": [
                { "name": "Hikvision R&D", "position": "Scale advantages in CV and edge compute.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Imaging quality and enterprise trust.", "threat": "Medium" },
                { "name": "AI startups", "position": "Niche model performance; fast iteration.", "threat": "Medium" },
                { "name": "Academic labs", "position": "Research leadership; limited productization.", "threat": "Low" }
            ],
            "quick_win": [
                { "name": "Ring", "position": "Doorbell category benchmark; strong UX and ecosystem.", "threat": "Medium" },
                { "name": "Xiaomi / Mi Home", "position": "Aggressive pricing and fast iteration in smart home.", "threat": "High" },
                { "name": "CP Plus", "position": "Local dealer network; value devices and installation support.", "threat": "Medium" },
                { "name": "Generic imports", "position": "Race-to-the-bottom pricing on marketplaces.", "threat": "Medium" }
            ],
            "rapid_deploy_kit": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "regulatory_opportunity": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "rtls_tracking": [
                { "name": "Zebra Technologies", "position": "Warehouse/hospital RTLS and scanners.", "threat": "High" },
                { "name": "Cisco Spaces", "position": "Wi\u2011Fi location analytics; easier install, less accuracy.", "threat": "Medium" },
                { "name": "Ubisense / Hexagon", "position": "Industrial RTLS; enterprise sales.", "threat": "Medium" },
                { "name": "Local RTLS startups", "position": "Lower cost; variable support.", "threat": "Medium" }
            ],
            "safety_security_soc": [
                { "name": "Honeywell", "position": "Command center + building/security integration.", "threat": "High" },
                { "name": "Johnson Controls", "position": "Enterprise security management via integrator ecosystem.", "threat": "Medium" },
                { "name": "Siemens", "position": "Building digitalization; can bundle unified ops dashboards.", "threat": "Medium" },
                { "name": "Motorola Solutions", "position": "Command center + incident response platforms.", "threat": "Medium" }
            ],
            "security_score": [
                { "name": "Big 4 consultancies", "position": "Audit-ready assessments; trusted with boards.", "threat": "High" },
                { "name": "ISO/ISMS auditors", "position": "Compliance-first posture scoring.", "threat": "Medium" },
                { "name": "GRC platforms", "position": "Risk modules adjacent to security scoring.", "threat": "Medium" },
                { "name": "Internal security teams", "position": "DIY scorecards in spreadsheets.", "threat": "High" }
            ],
            "services_platform": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "shrink_prevention": [
                { "name": "Sensormatic", "position": "EAS and retail loss prevention leader.", "threat": "High" },
                { "name": "Checkpoint Systems", "position": "Retail protection + RFID.", "threat": "Medium" },
                { "name": "RetailNext", "position": "Store analytics and traffic insights.", "threat": "Medium" },
                { "name": "Local CCTV integrators", "position": "Low-cost deterrence installs.", "threat": "Medium" }
            ],
            "slow_burner": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "smart_access": [
                { "name": "HID Global", "position": "Enterprise access control leader.", "threat": "High" },
                { "name": "ZKTeco", "position": "Aggressive pricing in biometric access.", "threat": "High" },
                { "name": "Honeywell", "position": "Broad access portfolio; integrator reach.", "threat": "Medium" },
                { "name": "Suprema", "position": "Biometric performance + enterprise features.", "threat": "Medium" }
            ],
            "smart_intercom": [
                { "name": "MyGate", "position": "Society app ecosystem; visitor and entry workflows.", "threat": "High" },
                { "name": "Hikvision Intercom", "position": "Hardware + integrator channel strength.", "threat": "Medium" },
                { "name": "Akuvox/Aiphone", "position": "Dedicated intercom vendors; premium positioning.", "threat": "Medium" },
                { "name": "Local installers", "position": "Bundle intercom with CCTV and maintenance contracts.", "threat": "Medium" }
            ],
            "smart_key_control": [
                { "name": "HID Global", "position": "Enterprise access control leader.", "threat": "High" },
                { "name": "ZKTeco", "position": "Aggressive pricing in biometric access.", "threat": "High" },
                { "name": "Honeywell", "position": "Broad access portfolio; integrator reach.", "threat": "Medium" },
                { "name": "Suprema", "position": "Biometric performance + enterprise features.", "threat": "Medium" }
            ],
            "sustainability_play": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "team_dependent": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "tech_adjacency": [
                { "name": "Philips", "position": "Healthcare-aligned monitoring devices and services.", "threat": "Medium" },
                { "name": "Practo/health platforms", "position": "Workflow ownership; can bundle monitoring.", "threat": "Low" },
                { "name": "Apple/Google health features", "position": "Platform baseline; reduces differentiation.", "threat": "Medium" },
                { "name": "Local home-care providers", "position": "Service-led monitoring bundles.", "threat": "Medium" }
            ],
            "tech_refresh": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "underserved_market": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ],
            "value_segment": [
                { "name": "Hikvision", "position": "Dominant hardware breadth; aggressive pricing.", "threat": "High" },
                { "name": "Dahua", "position": "Competitive pricing and features across tiers.", "threat": "High" },
                { "name": "CP Plus", "position": "India-focused distribution and support.", "threat": "High" },
                { "name": "Axis/Bosch", "position": "Premium quality; enterprise credibility.", "threat": "Medium" }
            ],
            "vehicle_intelligence": [
                { "name": "Rekor / OpenALPR", "position": "LPR analytics stacks.", "threat": "Medium" },
                { "name": "Hikvision LPR", "position": "Bundled cameras + LPR at scale.", "threat": "High" },
                { "name": "Park+ / parking operators", "position": "Workflow ownership; can push their own tech.", "threat": "Medium" },
                { "name": "Local barrier vendors", "position": "Hardware incumbents with bundled software.", "threat": "Medium" }
            ],
            "visitor_flow": [
                { "name": "Envoy", "position": "Visitor management benchmark UX.", "threat": "Medium" },
                { "name": "Proxyclick", "position": "Enterprise visitor workflows and compliance.", "threat": "Medium" },
                { "name": "Zoho (India)", "position": "Suite bundling and local procurement comfort.", "threat": "Medium" },
                { "name": "Kisi", "position": "Access + visitor integration play.", "threat": "Low" }
            ],
            "wander_management": [
                { "name": "Honeywell", "position": "Enterprise security stack via integrators.", "threat": "Medium" },
                { "name": "Hikvision", "position": "Scale pricing and channel power.", "threat": "High" },
                { "name": "Local system integrators", "position": "Control deployments and can steer vendor choice.", "threat": "High" },
                { "name": "Niche startups", "position": "Fast iteration in narrow use-cases.", "threat": "Medium" }
            ]
        };
        return competitors[archetype] || generateCompetitorsFallback(archetype);
    }
    
    function getDevelopmentCosts(budget, archetype) {
        // Break down total budget into cost categories
        const costProfiles = {
            'conventional_winner': { personnel: 0.45, hardware: 0.25, software: 0.10, external: 0.10, contingency: 0.10 },
            'conventional_loser': { personnel: 0.35, hardware: 0.15, software: 0.05, external: 0.25, contingency: 0.20 },
            'hidden_gem': { personnel: 0.50, hardware: 0.20, software: 0.10, external: 0.10, contingency: 0.10 },
            'slow_burner': { personnel: 0.55, hardware: 0.05, software: 0.20, external: 0.10, contingency: 0.10 },
            'paper_tiger': { personnel: 0.40, hardware: 0.30, software: 0.10, external: 0.05, contingency: 0.15 },
            'money_pit': { personnel: 0.50, hardware: 0.05, software: 0.15, external: 0.10, contingency: 0.20 },
            'pivot_success': { personnel: 0.50, hardware: 0.10, software: 0.15, external: 0.10, contingency: 0.15 },
            'team_dependent': { personnel: 0.60, hardware: 0.10, software: 0.10, external: 0.05, contingency: 0.15 },
            'competitive_casualty': { personnel: 0.35, hardware: 0.35, software: 0.10, external: 0.10, contingency: 0.10 },
            'sustainability_play': { personnel: 0.40, hardware: 0.25, software: 0.10, external: 0.15, contingency: 0.10 },
            'ip_fortress': { personnel: 0.40, hardware: 0.20, software: 0.10, external: 0.20, contingency: 0.10 }
        };
        
        const profile = costProfiles[archetype] || costProfiles['conventional_winner'];
        
        return {
            total: budget,
            personnel: { 
                amount: (budget * profile.personnel).toFixed(1), 
                pct: Math.round(profile.personnel * 100),
                detail: 'Engineering salaries, product management, design, QA'
            },
            hardware: { 
                amount: (budget * profile.hardware).toFixed(1), 
                pct: Math.round(profile.hardware * 100),
                detail: 'Prototyping, components, testing equipment, tooling'
            },
            software: { 
                amount: (budget * profile.software).toFixed(1), 
                pct: Math.round(profile.software * 100),
                detail: 'Cloud infrastructure, development tools, licenses'
            },
            external: { 
                amount: (budget * profile.external).toFixed(1), 
                pct: Math.round(profile.external * 100),
                detail: 'Consultants, contractors, legal, certifications'
            },
            contingency: { 
                amount: (budget * profile.contingency).toFixed(1), 
                pct: Math.round(profile.contingency * 100),
                detail: 'Risk buffer for scope changes and unknowns'
            }
        };
    }
    
    function getMilestones(archetype, budget) {
        const milestoneTemplates = {
            'conventional_winner': {
                totalDuration: '12 months',
                milestones: [
                    { 
                        phase: 'M1: Design & Prototype', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Industrial design approved', 'Functional prototype', 'BOM finalised', 'User testing complete'],
                        metrics: [
                            { name: 'Prototype sign-off', target: 'Product & Engineering approval' },
                            { name: 'BOM cost', target: '< target for 35% gross margin' },
                            { name: 'User testing NPS', target: '> 40 from 20 beta testers' }
                        ],
                        gate: 'Design Review Board approval'
                    },
                    { 
                        phase: 'M2: Engineering & Certification', 
                        quarters: 'Q3',
                        duration: '3 months', 
                        cost: 0.35,
                        deliverables: ['DVT units (50)', 'BIS certification', 'App integration', 'Manufacturing setup'],
                        metrics: [
                            { name: 'DVT pass rate', target: '> 95% units pass all tests' },
                            { name: 'Certifications', target: 'BIS, WiFi Alliance complete' },
                            { name: 'Production yield', target: '> 98% first-pass' }
                        ],
                        gate: 'Quality & Operations sign-off'
                    },
                    { 
                        phase: 'M3: Launch & Scale', 
                        quarters: 'Q4',
                        duration: '3 months', 
                        cost: 0.30,
                        deliverables: ['Market launch', 'Channel inventory', 'Support operations', 'Marketing campaign'],
                        metrics: [
                            { name: 'Launch inventory', target: '5,000 units in channel' },
                            { name: 'Day-30 sales', target: '> 1,000 units' },
                            { name: 'Return rate', target: '< 3%' }
                        ],
                        gate: 'Commercial success review'
                    }
                ]
            },
            'conventional_loser': {
                totalDuration: '36-48 months',
                milestones: [
                    { 
                        phase: 'M1: Research & Proof of Concept', 
                        quarters: 'Q1-Q6',
                        duration: '18 months', 
                        cost: 0.45,
                        deliverables: ['Research team assembled', 'Lab setup', 'Core technology demonstration', 'Patent applications filed'],
                        metrics: [
                            { name: 'Technical proof', target: 'Demonstrate core principle' },
                            { name: 'IP filings', target: '2+ provisional patents' },
                            { name: 'Publication', target: 'Paper submitted to journal' }
                        ],
                        gate: 'Scientific Advisory Board review'
                    },
                    { 
                        phase: 'M2: Lab Validation', 
                        quarters: 'Q7-Q12',
                        duration: '18 months', 
                        cost: 0.35,
                        deliverables: ['Working lab prototype', 'Performance characterisation', 'Repeatability testing', 'Productisation assessment'],
                        metrics: [
                            { name: 'Performance', target: 'Within 50% of theoretical' },
                            { name: 'Repeatability', target: '> 80% consistent results' },
                            { name: 'Cost path', target: 'Route to viable unit cost' }
                        ],
                        gate: 'Go/No-Go on commercialisation'
                    },
                    { 
                        phase: 'M3: Development Planning', 
                        quarters: 'Q13-Q16',
                        duration: '12 months', 
                        cost: 0.20,
                        deliverables: ['Product roadmap', 'Resource plan', 'Partnership agreements', 'Phase 2 business case'],
                        metrics: [
                            { name: 'Roadmap clarity', target: '24-month plan defined' },
                            { name: 'Resource commitment', target: 'Team & budget approved' },
                            { name: 'Strategic fit', target: 'Board endorsement' }
                        ],
                        gate: 'Full development authorisation'
                    }
                ]
            },
            'hidden_gem': {
                totalDuration: '12 months',
                milestones: [
                    { 
                        phase: 'M1: Discovery & MVP', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.40,
                        deliverables: ['50+ user interviews', 'Persona documentation', 'MVP launched', 'Beta program active'],
                        metrics: [
                            { name: 'Problem validation', target: '> 70% confirm pain point' },
                            { name: 'Beta signups', target: '> 100 users' },
                            { name: 'Activation rate', target: '> 60% complete setup' }
                        ],
                        gate: 'Product-market fit signal'
                    },
                    { 
                        phase: 'M2: Pilot Launch', 
                        quarters: 'Q3',
                        duration: '3 months', 
                        cost: 0.35,
                        deliverables: ['Limited market launch', 'Feedback integration', 'Unit economics validated', 'Referral program'],
                        metrics: [
                            { name: 'Pilot sales', target: '> 500 units' },
                            { name: 'NPS score', target: '> 50' },
                            { name: 'Referral rate', target: '> 20%' }
                        ],
                        gate: 'Scalability assessment'
                    },
                    { 
                        phase: 'M3: Scale & Expand', 
                        quarters: 'Q4',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Multi-city launch', 'Marketing playbook', 'Support operations', 'Channel partnerships'],
                        metrics: [
                            { name: 'Geographic reach', target: 'Live in 5 cities' },
                            { name: 'Growth rate', target: '> 30% MoM' },
                            { name: 'CAC payback', target: '< 6 months' }
                        ],
                        gate: 'Mainstream market readiness'
                    }
                ]
            },
            'slow_burner': {
                totalDuration: '24 months',
                milestones: [
                    { 
                        phase: 'M1: Platform Foundation', 
                        quarters: 'Q1-Q3',
                        duration: '9 months', 
                        cost: 0.40,
                        deliverables: ['Core API architecture', 'SDK v1.0', 'Developer documentation', '5 device integrations'],
                        metrics: [
                            { name: 'API stability', target: '< 5% breaking changes' },
                            { name: 'Documentation', target: '100% API coverage' },
                            { name: 'Internal adoption', target: '3 ShieldTech products' }
                        ],
                        gate: 'Platform architecture review'
                    },
                    { 
                        phase: 'M2: Ecosystem Growth', 
                        quarters: 'Q4-Q6',
                        duration: '9 months', 
                        cost: 0.35,
                        deliverables: ['25 partner integrations', 'Developer program', 'App marketplace', 'Community forums'],
                        metrics: [
                            { name: 'Partners certified', target: '25 devices' },
                            { name: 'Developers', target: '> 500 registered' },
                            { name: 'Third-party apps', target: '> 20 in marketplace' }
                        ],
                        gate: 'Ecosystem traction review'
                    },
                    { 
                        phase: 'M3: Network Effects', 
                        quarters: 'Q7-Q8',
                        duration: '6 months', 
                        cost: 0.25,
                        deliverables: ['Viral growth mechanics', 'Cross-promotion', 'Platform monetisation', 'Self-sustaining growth'],
                        metrics: [
                            { name: 'Organic growth', target: '> 40% from referral' },
                            { name: 'Multi-device homes', target: '> 30% have 3+ integrations' },
                            { name: 'Platform revenue', target: 'First $12K partner fees' }
                        ],
                        gate: 'Self-sustaining growth achieved'
                    }
                ]
            },
            'paper_tiger': {
                totalDuration: '18 months',
                milestones: [
                    { 
                        phase: 'M1: Architecture & Subsystems', 
                        quarters: 'Q1-Q3',
                        duration: '9 months', 
                        cost: 0.40,
                        deliverables: ['System architecture', 'All subsystems functional', 'Interface definitions', 'Unit test coverage'],
                        metrics: [
                            { name: 'Spec completeness', target: '100% documented' },
                            { name: 'Subsystems', target: 'All 5 individually working' },
                            { name: 'Test coverage', target: '> 80%' }
                        ],
                        gate: 'Architecture review board'
                    },
                    { 
                        phase: 'M2: Integration & Testing', 
                        quarters: 'Q4-Q5',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Integrated system', 'Performance benchmarks', 'Stress testing', 'Quality certification'],
                        metrics: [
                            { name: 'Integration', target: 'All subsystems working together' },
                            { name: 'Performance', target: '> 90% of spec targets' },
                            { name: 'Stability', target: '< 1 crash per 1,000 hours' }
                        ],
                        gate: 'Quality release criteria'
                    },
                    { 
                        phase: 'M3: Production & Launch', 
                        quarters: 'Q6',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Production units', 'Launch materials', 'Support readiness', 'Premium positioning'],
                        metrics: [
                            { name: 'Production yield', target: '> 92%' },
                            { name: 'Launch inventory', target: '2,000 units' },
                            { name: 'Support certification', target: '100% staff trained' }
                        ],
                        gate: 'Commercial launch authorisation'
                    }
                ]
            },
            'money_pit': {
                totalDuration: '30-36 months',
                milestones: [
                    { 
                        phase: 'M1: Discovery & Foundation', 
                        quarters: 'Q1-Q4',
                        duration: '12 months', 
                        cost: 0.35,
                        deliverables: ['Technical discovery', 'Architecture blueprint', 'Core infrastructure', 'Data layer'],
                        metrics: [
                            { name: 'Scope definition', target: 'Complete inventory documented' },
                            { name: 'Dependencies', target: '100% mapped' },
                            { name: 'Foundation deployed', target: 'Core services in staging' }
                        ],
                        gate: 'Scope and budget validation'
                    },
                    { 
                        phase: 'M2: Feature Parity', 
                        quarters: 'Q5-Q10',
                        duration: '18 months', 
                        cost: 0.45,
                        deliverables: ['All features rebuilt', 'Performance benchmarks', 'User acceptance testing', 'Security audit'],
                        metrics: [
                            { name: 'Feature completion', target: '100% existing features' },
                            { name: 'Performance', target: '> 95% of current' },
                            { name: 'UAT sign-off', target: 'All business units' }
                        ],
                        gate: 'Migration readiness certification'
                    },
                    { 
                        phase: 'M3: Migration & Cutover', 
                        quarters: 'Q11-Q12',
                        duration: '6 months', 
                        cost: 0.20,
                        deliverables: ['Phased migration', 'User transition', 'Legacy decommission', 'Documentation'],
                        metrics: [
                            { name: 'User migration', target: '100% on new platform' },
                            { name: 'Incidents', target: '< 5 P1 during migration' },
                            { name: 'Legacy shutdown', target: 'Old systems decommissioned' }
                        ],
                        gate: 'Project closure and benefits'
                    }
                ]
            },
            'pivot_success': {
                totalDuration: '12-15 months',
                milestones: [
                    { 
                        phase: 'M1: Hypothesis & Prototype', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Market hypotheses tested', 'Clickable prototype', 'Landing page tests', 'Direction selected'],
                        metrics: [
                            { name: 'Hypotheses tested', target: '5 core validated/invalidated' },
                            { name: 'Prototype feedback', target: '> 60% positive' },
                            { name: 'Waitlist', target: '> 500 interested users' }
                        ],
                        gate: 'Direction decision point'
                    },
                    { 
                        phase: 'M2: MVP & Validation', 
                        quarters: 'Q3-Q4',
                        duration: '6 months', 
                        cost: 0.40,
                        deliverables: ['Working product', 'Paid pilot customers', 'Iteration backlog', 'Unit economics'],
                        metrics: [
                            { name: 'Paying customers', target: '> 50' },
                            { name: 'Revenue', target: 'First $6K' },
                            { name: 'Retention', target: '> 70% month-2' }
                        ],
                        gate: 'Product-market fit assessment'
                    },
                    { 
                        phase: 'M3: Scale or Pivot', 
                        quarters: 'Q5',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Growth playbook OR pivot plan', 'Resource request', 'Updated business case'],
                        metrics: [
                            { name: 'Growth rate', target: '> 20% MoM OR pivot thesis' },
                            { name: 'Unit economics', target: 'LTV > 3x CAC trajectory' },
                            { name: 'Team alignment', target: 'Clear path forward' }
                        ],
                        gate: 'Investment committee review'
                    }
                ]
            },
            'team_dependent': {
                totalDuration: '15 months',
                milestones: [
                    { 
                        phase: 'M1: Team & Exploration', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Team assembled', 'Working agreements', '3-5 concept prototypes', 'User research synthesis'],
                        metrics: [
                            { name: 'Team composition', target: 'All 6 roles with A-players' },
                            { name: 'Concepts explored', target: 'Minimum 3 prototyped' },
                            { name: 'User research', target: '50+ hours completed' }
                        ],
                        gate: 'Concept selection decision'
                    },
                    { 
                        phase: 'M2: Deep Development', 
                        quarters: 'Q3-Q4',
                        duration: '6 months', 
                        cost: 0.45,
                        deliverables: ['Production-quality build', 'Beta testing', 'Launch plan', 'Knowledge documentation'],
                        metrics: [
                            { name: 'Product quality', target: 'Meets ShieldTech bar' },
                            { name: 'Beta NPS', target: '> 50' },
                            { name: 'Team retention', target: '100% core retained' }
                        ],
                        gate: 'Launch readiness review'
                    },
                    { 
                        phase: 'M3: Launch & Handover', 
                        quarters: 'Q5',
                        duration: '3 months', 
                        cost: 0.20,
                        deliverables: ['Market launch', 'Transition to product team', 'Knowledge transfer', 'Team redeployment'],
                        metrics: [
                            { name: 'Launch success', target: 'Success metrics met' },
                            { name: 'Handover', target: 'Receiving team trained' },
                            { name: 'Team next steps', target: 'All have next assignment' }
                        ],
                        gate: 'Project completion'
                    }
                ]
            },
            'competitive_casualty': {
                totalDuration: '9 months',
                milestones: [
                    { 
                        phase: 'M1: Cost Engineering', 
                        quarters: 'Q1',
                        duration: '3 months', 
                        cost: 0.30,
                        deliverables: ['Cost-reduced BOM', 'Supplier negotiations', 'Value engineering', 'Certification prep'],
                        metrics: [
                            { name: 'BOM cost', target: '20% below competitor' },
                            { name: 'Supplier terms', target: '60-day payment' },
                            { name: 'Feature parity', target: '90% at 70% cost' }
                        ],
                        gate: 'Cost target confirmed'
                    },
                    { 
                        phase: 'M2: Rapid Production', 
                        quarters: 'Q2',
                        duration: '3 months', 
                        cost: 0.40,
                        deliverables: ['Production-ready design', 'BIS certification', 'First production run', 'Channel seeding'],
                        metrics: [
                            { name: 'Certification', target: 'BIS obtained' },
                            { name: 'Production', target: '10,000 units' },
                            { name: 'Channel placement', target: '500 retail points' }
                        ],
                        gate: 'Manufacturing & go-to-market'
                    },
                    { 
                        phase: 'M3: Market Battle', 
                        quarters: 'Q3',
                        duration: '3 months', 
                        cost: 0.30,
                        deliverables: ['Full launch', 'Competitive response plan', 'Cost reduction roadmap', 'Volume ramp'],
                        metrics: [
                            { name: 'Market share', target: '> 5% in 90 days' },
                            { name: 'Velocity', target: '> 2,000 units/month' },
                            { name: 'Margin', target: '> 15% gross sustained' }
                        ],
                        gate: 'Sustainable position'
                    }
                ]
            },
            'sustainability_play': {
                totalDuration: '15 months',
                milestones: [
                    { 
                        phase: 'M1: Sustainable Design', 
                        quarters: 'Q1-Q2',
                        duration: '6 months', 
                        cost: 0.35,
                        deliverables: ['Eco-design specs', 'Material sourcing', 'Lifecycle assessment', 'Consumer testing'],
                        metrics: [
                            { name: 'Recycled content', target: '> 80%' },
                            { name: 'Suppliers', target: '3 certified sustainable' },
                            { name: 'Consumer belief', target: '> 70% trust claims' }
                        ],
                        gate: 'Sustainability authenticity'
                    },
                    { 
                        phase: 'M2: Green Production', 
                        quarters: 'Q3-Q4',
                        duration: '6 months', 
                        cost: 0.40,
                        deliverables: ['Sustainable manufacturing', 'Carbon-neutral production', 'Plastic-free packaging', 'Take-back program'],
                        metrics: [
                            { name: 'Manufacturing', target: 'Carbon-neutral achieved' },
                            { name: 'Packaging', target: '100% plastic-free' },
                            { name: 'Circularity', target: 'Take-back operational' }
                        ],
                        gate: 'Full sustainability certification'
                    },
                    { 
                        phase: 'M3: Green Launch', 
                        quarters: 'Q5',
                        duration: '3 months', 
                        cost: 0.25,
                        deliverables: ['Market launch', 'PR campaign', 'Impact reporting', 'Certification badges'],
                        metrics: [
                            { name: 'Media coverage', target: '> 10 mentions' },
                            { name: 'Price premium', target: '20% above standard' },
                            { name: 'Impact report', target: 'Quarterly published' }
                        ],
                        gate: 'Sustainability brand established'
                    }
                ]
            },
            'ip_fortress': {
                totalDuration: '24 months',
                milestones: [
                    { 
                        phase: 'M1: IP Strategy & Filing', 
                        quarters: 'Q1-Q3',
                        duration: '9 months', 
                        cost: 0.40,
                        deliverables: ['Patent landscape', 'FTO clearance', '8 provisional patents', 'Trade secret protocols'],
                        metrics: [
                            { name: 'FTO', target: 'Freedom to operate confirmed' },
                            { name: 'Filings', target: '8 provisional applications' },
                            { name: 'Trade secrets', target: 'Protocols implemented' }
                        ],
                        gate: 'IP strategy approval'
                    },
                    { 
                        phase: 'M2: Development & Protection', 
                        quarters: 'Q4-Q6',
                        duration: '9 months', 
                        cost: 0.35,
                        deliverables: ['Core technology validated', 'Full patent applications', 'Working prototype', 'Licensing framework'],
                        metrics: [
                            { name: 'Patents converted', target: 'All provisionals to full' },
                            { name: 'Technical validation', target: 'Algorithm performance proven' },
                            { name: 'Licensing terms', target: 'Standard agreement ready' }
                        ],
                        gate: 'Commercial IP package'
                    },
                    { 
                        phase: 'M3: Launch & Defend', 
                        quarters: 'Q7-Q8',
                        duration: '6 months', 
                        cost: 0.25,
                        deliverables: ['Product launch', 'Competitor monitoring', 'Enforcement readiness', 'Licensing outreach'],
                        metrics: [
                            { name: 'Launch', target: 'Product in market with IP' },
                            { name: 'Monitoring', target: 'Watch service active' },
                            { name: 'Defence', target: 'Legal team briefed' }
                        ],
                        gate: 'IP moat established'
                    }
                ]
            },
            // Core product archetypes with varied durations
            'core_upgrade': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Design', quarters: 'Q1-Q2', duration: '6 months', cost: 0.40 }, { phase: 'M2: Build', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Launch', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'value_segment': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Cost Design', quarters: 'Q1', duration: '3 months', cost: 0.35 }, { phase: 'M2: Sourcing', quarters: 'Q2', duration: '3 months', cost: 0.40 }, { phase: 'M3: Launch', quarters: 'Q3', duration: '3 months', cost: 0.25 }] },
            'premium_flagship': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Concept', quarters: 'Q1-Q3', duration: '9 months', cost: 0.35 }, { phase: 'M2: Engineering', quarters: 'Q4-Q6', duration: '9 months', cost: 0.40 }, { phase: 'M3: Premium Launch', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'niche_vertical': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Discovery', quarters: 'Q1-Q2', duration: '6 months', cost: 0.40 }, { phase: 'M2: Adapt', quarters: 'Q3-Q4', duration: '6 months', cost: 0.35 }, { phase: 'M3: Niche Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'underserved_market': { totalDuration: '12-18 months', milestones: [{ phase: 'M1: Field Research', quarters: 'Q1-Q2', duration: '6 months', cost: 0.35 }, { phase: 'M2: Ruggedise', quarters: 'Q3-Q4', duration: '6 months', cost: 0.40 }, { phase: 'M3: Distribution', quarters: 'Q5-Q6', duration: '6 months', cost: 0.25 }] },
            'platform_infrastructure': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Architecture', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Build & Integrate', quarters: 'Q4-Q6', duration: '9 months', cost: 0.40 }, { phase: 'M3: Ecosystem', quarters: 'Q7-Q8', duration: '6 months', cost: 0.20 }] },
            'market_explorer': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: MVP', quarters: 'Q1-Q2', duration: '6 months', cost: 0.50 }, { phase: 'M2: Iterate', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Scale/Pivot', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'price_fighter': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Cost Engineering', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Volume Production', quarters: 'Q3', duration: '3 months', cost: 0.55 }] },
            'esg_initiative': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Sustainability Design', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Supply Chain', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Certified Launch', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'proprietary_tech': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Innovation', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Protection', quarters: 'Q5-Q6', duration: '6 months', cost: 0.30 }, { phase: 'M3: Commercialise', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'frontier_tech': { totalDuration: '36-48 months', milestones: [{ phase: 'M1: Research', quarters: 'Q1-Q8', duration: '24 months', cost: 0.50 }, { phase: 'M2: Validation', quarters: 'Q9-Q12', duration: '12 months', cost: 0.30 }, { phase: 'M3: Path to Product', quarters: 'Q13-Q16', duration: '12 months', cost: 0.20 }] },
            
            // AI and advanced tech archetypes
            'ai_guard_innovation': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: AI Development', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Edge Deploy', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Field Pilot', quarters: 'Q6', duration: '3 months', cost: 0.20 }] },
            'services_platform': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Platform Build', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: SOC Setup', quarters: 'Q4', duration: '3 months', cost: 0.35 }, { phase: 'M3: Service Launch', quarters: 'Q5', duration: '3 months', cost: 0.20 }] },
            'autonomous_drone': { totalDuration: '30-36 months', milestones: [{ phase: 'M1: Development', quarters: 'Q1-Q6', duration: '18 months', cost: 0.45 }, { phase: 'M2: Regulatory', quarters: 'Q7-Q10', duration: '12 months', cost: 0.35 }, { phase: 'M3: Commercial Ops', quarters: 'Q11-Q12', duration: '6 months', cost: 0.20 }] },
            'ground_robot': { totalDuration: '36-48 months', milestones: [{ phase: 'M1: Robotics R&D', quarters: 'Q1-Q8', duration: '24 months', cost: 0.50 }, { phase: 'M2: Field Testing', quarters: 'Q9-Q14', duration: '18 months', cost: 0.35 }, { phase: 'M3: Deployment', quarters: 'Q15-Q16', duration: '6 months', cost: 0.15 }] },
            'privacy_compliance': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Privacy Tech', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Certification', quarters: 'Q5-Q6', duration: '6 months', cost: 0.30 }, { phase: 'M3: Enterprise Sales', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'evidence_chain': { totalDuration: '12-18 months', milestones: [{ phase: 'M1: Chain Development', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Legal Validation', quarters: 'Q4-Q5', duration: '6 months', cost: 0.30 }, { phase: 'M3: Market Entry', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'smart_access': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Risk Engine', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Integration', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Pilot & Scale', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'rtls_tracking': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: UWB Platform', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Security Fusion', quarters: 'Q4-Q5', duration: '6 months', cost: 0.35 }, { phase: 'M3: Enterprise Deploy', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'acoustic_detection': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Audio ML', quarters: 'Q1-Q5', duration: '15 months', cost: 0.45 }, { phase: 'M2: Network Deploy', quarters: 'Q6-Q8', duration: '9 months', cost: 0.35 }, { phase: 'M3: City Pilot', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'digital_twin': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Simulation Engine', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Facility Modeling', quarters: 'Q7-Q9', duration: '9 months', cost: 0.30 }, { phase: 'M3: Predictive Ops', quarters: 'Q10', duration: '3 months', cost: 0.20 }] },
            'perimeter_fusion': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Sensor Fusion', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Enterprise Config', quarters: 'Q5-Q6', duration: '6 months', cost: 0.30 }, { phase: 'M3: Multi-site', quarters: 'Q7-Q8', duration: '6 months', cost: 0.25 }] },
            'cyber_physical_soc': { totalDuration: '21-24 months', milestones: [{ phase: 'M1: Convergence Platform', quarters: 'Q1-Q5', duration: '15 months', cost: 0.45 }, { phase: 'M2: Correlation Engine', quarters: 'Q6-Q7', duration: '6 months', cost: 0.35 }, { phase: 'M3: SOC Operations', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'camera_health': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Analytics Build', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Fleet Integration', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Service Launch', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'panic_wearable': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Hardware Design', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: SOC Connect', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Enterprise Roll', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'vehicle_intelligence': { totalDuration: '18-21 months', milestones: [{ phase: 'M1: Intent Models', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Gate Integration', quarters: 'Q5-Q6', duration: '6 months', cost: 0.35 }, { phase: 'M3: Logistics Pilot', quarters: 'Q7', duration: '3 months', cost: 0.20 }] },
            'compliance_automation': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Report Engine', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Template Library', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Enterprise Sales', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'deepfake_defense': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Detection R&D', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Liveness Integration', quarters: 'Q7-Q8', duration: '6 months', cost: 0.30 }, { phase: 'M3: High-Security Deploy', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'edge_micro_nvr': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Firmware Dev', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Cloud Sync', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Channel Launch', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'rapid_deploy_kit': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Kit Design', quarters: 'Q1-Q2', duration: '6 months', cost: 0.50 }, { phase: 'M2: Production', quarters: 'Q3', duration: '3 months', cost: 0.50 }] },
            'predictive_risk': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Data & Models', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Validation', quarters: 'Q7-Q8', duration: '6 months', cost: 0.30 }, { phase: 'M3: Insurance Partnership', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'visitor_flow': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: CV Integration', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Access Linkage', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Enterprise Sales', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'security_score': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Scoring Algorithm', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Dashboard Build', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: B2B Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'smart_key_control': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Hardware Dev', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Cloud Platform', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Facility Deploy', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'emergency_muster': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Platform Build', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: HR Integration', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: EHS Sales', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'night_escort': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: App Development', quarters: 'Q1-Q2', duration: '6 months', cost: 0.50 }, { phase: 'M2: Service Operations', quarters: 'Q3', duration: '3 months', cost: 0.50 }] },
            'guard_training_sim': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Simulation Dev', quarters: 'Q1-Q5', duration: '15 months', cost: 0.50 }, { phase: 'M2: Content Library', quarters: 'Q6-Q7', duration: '6 months', cost: 0.30 }, { phase: 'M3: Training Deploy', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'incident_invoice': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Billing Engine', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: ERP Integration', quarters: 'Q3', duration: '3 months', cost: 0.35 }, { phase: 'M3: Enterprise Roll', quarters: 'Q4', duration: '3 months', cost: 0.20 }] },
            'parking_security': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: LPR Integration', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Parking Systems', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Multi-site', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'shrink_prevention': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Retail Analytics', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: POS Integration', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Retail Pilot', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'alarm_response_network': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Dispatch Platform', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Partner Network', quarters: 'Q4', duration: '3 months', cost: 0.35 }, { phase: 'M3: Service Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'camera_subscription': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Cloud Platform', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Provisioning', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Channel Enable', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'privacy_analytics': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Edge Processing', quarters: 'Q1-Q4', duration: '12 months', cost: 0.50 }, { phase: 'M2: Privacy Cert', quarters: 'Q5', duration: '3 months', cost: 0.25 }, { phase: 'M3: Enterprise Sales', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'guard_tour_proof': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Proof System', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Mobile App', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: Security Partner', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'smart_intercom': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: Hardware Dev', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: Cloud Video', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Builder Channel', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            'wander_management': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Tracking System', quarters: 'Q1-Q4', duration: '12 months', cost: 0.45 }, { phase: 'M2: Healthcare Cert', quarters: 'Q5', duration: '3 months', cost: 0.30 }, { phase: 'M3: Facility Sales', quarters: 'Q6', duration: '3 months', cost: 0.25 }] },
            'contractor_screening': { totalDuration: '9-12 months', milestones: [{ phase: 'M1: Verification APIs', quarters: 'Q1-Q2', duration: '6 months', cost: 0.45 }, { phase: 'M2: Workflow Build', quarters: 'Q3', duration: '3 months', cost: 0.30 }, { phase: 'M3: FM Partner', quarters: 'Q4', duration: '3 months', cost: 0.25 }] },
            'ai_video_search': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Search Engine', quarters: 'Q1-Q5', duration: '15 months', cost: 0.50 }, { phase: 'M2: Index Scale', quarters: 'Q6-Q7', duration: '6 months', cost: 0.30 }, { phase: 'M3: Enterprise Deploy', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'safety_security_soc': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Convergence Build', quarters: 'Q1-Q5', duration: '15 months', cost: 0.45 }, { phase: 'M2: EHS Integration', quarters: 'Q6-Q7', duration: '6 months', cost: 0.35 }, { phase: 'M3: Operations', quarters: 'Q8', duration: '3 months', cost: 0.20 }] },
            'anti_drone_service': { totalDuration: '24-30 months', milestones: [{ phase: 'M1: Detection R&D', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Response Protocol', quarters: 'Q7-Q8', duration: '6 months', cost: 0.30 }, { phase: 'M3: Service Ops', quarters: 'Q9-Q10', duration: '6 months', cost: 0.20 }] },
            'predictive_door_maintenance': { totalDuration: '12-15 months', milestones: [{ phase: 'M1: IoT Sensors', quarters: 'Q1-Q3', duration: '9 months', cost: 0.45 }, { phase: 'M2: ML Models', quarters: 'Q4', duration: '3 months', cost: 0.30 }, { phase: 'M3: Service Launch', quarters: 'Q5', duration: '3 months', cost: 0.25 }] },
            
            // Legacy archetypes
            'legacy_incremental': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Enhancement', quarters: 'Q1-Q2', duration: '6 months', cost: 0.60 }, { phase: 'M2: Release', quarters: 'Q3', duration: '3 months', cost: 0.40 }] },
            'legacy_pet_project': { totalDuration: '24-36 months', milestones: [{ phase: 'M1: Validation', quarters: 'Q1-Q6', duration: '18 months', cost: 0.50 }, { phase: 'M2: Reassess', quarters: 'Q7-Q10', duration: '12 months', cost: 0.30 }, { phase: 'M3: Decision Point', quarters: 'Q11-Q12', duration: '6 months', cost: 0.20 }] },
            'legacy_strategic_troubled': { totalDuration: '18-24 months', milestones: [{ phase: 'M1: Recovery Plan', quarters: 'Q1-Q4', duration: '12 months', cost: 0.50 }, { phase: 'M2: Execution', quarters: 'Q5-Q7', duration: '9 months', cost: 0.35 }, { phase: 'M3: Validation', quarters: 'Q8', duration: '3 months', cost: 0.15 }] },
            'legacy_partnership': { totalDuration: '15-18 months', milestones: [{ phase: 'M1: Partner Align', quarters: 'Q1-Q3', duration: '9 months', cost: 0.40 }, { phase: 'M2: Joint Development', quarters: 'Q4-Q5', duration: '6 months', cost: 0.40 }, { phase: 'M3: Market Entry', quarters: 'Q6', duration: '3 months', cost: 0.20 }] },
            'legacy_defensive': { totalDuration: '6-9 months', milestones: [{ phase: 'M1: Rapid Response', quarters: 'Q1-Q2', duration: '6 months', cost: 0.65 }, { phase: 'M2: Counter Launch', quarters: 'Q3', duration: '3 months', cost: 0.35 }] },
            'legacy_infrastructure': { totalDuration: '36-48 months', milestones: [{ phase: 'M1: Planning', quarters: 'Q1-Q4', duration: '12 months', cost: 0.25 }, { phase: 'M2: Migration', quarters: 'Q5-Q12', duration: '24 months', cost: 0.55 }, { phase: 'M3: Stabilise', quarters: 'Q13-Q16', duration: '12 months', cost: 0.20 }] }
        };
        
        const template = milestoneTemplates[archetype] || milestoneTemplates['conventional_winner'];
        
        // Add actual costs based on budget
        return {
            totalDuration: template.totalDuration,
            milestones: template.milestones.map(m => ({
                ...m,
                costAmount: (budget * m.cost).toFixed(1)
            }))
        };
    }
    
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }
    
    function startProjectSelection() {
        gameState.projectPool = generateProjectPool();
        gameState.selectedProjects = [];
        // If legacy decisions were made, budget was already set in confirmLegacyDecisions
        // Otherwise use maxBudget (no legacy projects scenario)
        if (gameState.legacyBudgetCommitted === undefined) {
            gameState.budget = gameState.maxBudget;
        }
        // Otherwise the budget was already set in confirmLegacyDecisions
        
        // If solo mode, skip assessment and go directly to selection
        if (gameState.decisionModel === 'solo') {
            showPhase('selection');
        } else if (gameState.decisionModel === 'random') {
            // Random selection - auto-select projects
            autoSelectRandomProjects();
            showPhase('selection');
        } else {
            // Committee or jury - show approach modal first, then go through assessment
            showApproachModal();
        }
    }
    
    // ============================================
    // SELECTION APPROACH MODAL FUNCTIONS
    // ============================================
    
    function showApproachModal() {
        // Reset selection state
        gameState.scoringApproach = null;
        gameState.teamBlinding = null;
        
        document.querySelectorAll('.approach-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('approach-confirm-btn').disabled = true;
        document.getElementById('approach-confirm-btn').textContent = 'Make Both Selections to Continue';
        
        // Show modal
        document.getElementById('approach-modal').classList.remove('hidden');
    }
    
    function selectApproachOption(choice, value) {
        // Update the selection for this choice group
        if (choice === 'scoring') {
            gameState.scoringApproach = value;
        } else if (choice === 'blinding') {
            gameState.teamBlinding = value;
        }
        
        // Update visual selection within this choice group
        document.querySelectorAll(`.approach-option[data-choice="${choice}"]`).forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="${choice}"][data-value="${value}"]`).classList.add('selected');
        
        // Check if both choices are made
        updateApproachConfirmButton();
    }
    
    function updateApproachConfirmButton() {
        const btn = document.getElementById('approach-confirm-btn');
        
        if (gameState.scoringApproach && gameState.teamBlinding) {
            btn.disabled = false;
            
            // Build descriptive button text
            const scoringLabels = {
                'careful': 'Careful Evaluation',
                'rapid': 'Rapid Screening',
                'delegate': 'Committee Scoring'
            };
            const blindingLabels = {
                'visible': 'Team Visible',
                'blind': 'Blind Review'
            };
            
            btn.textContent = `Begin with ${scoringLabels[gameState.scoringApproach]} + ${blindingLabels[gameState.teamBlinding]} →`;
        } else {
            btn.disabled = true;
            btn.textContent = 'Make Both Selections to Continue';
        }
    }
    
    function confirmApproach() {
        if (!gameState.scoringApproach || !gameState.teamBlinding) return;
        
        // Close modal
        document.getElementById('approach-modal').classList.add('hidden');
        
        // Initialize projectTriage if needed
        if (!gameState.projectTriage) {
            gameState.projectTriage = {};
        }
        
        // Route based on scoring approach
        if (gameState.scoringApproach === 'delegate') {
            // Skip player assessment, generate committee scores, go to triage
            generateCommitteeOnlyScores();
            renderTriageCards();
            showPhase('committee-feedback');
        } else {
            // Player will score projects (careful or rapid mode)
            renderAssessmentGrid();
            showPhase('assessment');
        }
    }
    
    function generateCommitteeOnlyScores() {
        // When player delegates scoring, generate committee scores for all projects
        gameState.projectPool.forEach(project => {
            // Initialize player scores as empty (they didn't score)
            project.playerScores = {};
            
            // Generate committee scores
            project.committeeScores = {};
            gameState.committee.forEach(staffId => {
                const staff = findStaff(staffId);
                if (staff) {
                    project.committeeScores[staffId] = calculateCommitteeScore(project, staff);
                }
            });
        });
    }
    
    function calculateCommitteeScore(project, staff) {
        // Base score influenced by project archetype and staff biases
        let score = 3; // Neutral starting point
        
        const archetype = project.archetype;
        const effects = staff.effects || {};
        
        // Apply staff-specific modifiers
        if (archetype === 'hidden_gem' && effects.hiddenGem) {
            score *= effects.hiddenGem;
        }
        if (archetype === 'slow_burner' && effects.slowBurner) {
            score *= effects.slowBurner;
        }
        if (archetype === 'money_pit' && effects.moneyPit) {
            score *= effects.moneyPit;
        }
        if (effects.strategic && project.scores?.strategic > 7) {
            score *= effects.strategic;
        }
        if (effects.market && project.scores?.market > 7) {
            score *= effects.market;
        }
        if (effects.cost && project.budget < 6) {
            score *= effects.cost;
        }
        
        // Add some randomness
        score += (Math.random() - 0.5) * 1.5;
        
        // Factor in project's inherent quality
        const avgQuality = (project.scores?.strategic + project.scores?.technical + project.scores?.market) / 3 || 5;
        score = (score + avgQuality / 2) / 2;
        
        // Clamp to valid range
        return Math.max(1, Math.min(5, Math.round(score)));
    }
    
    // Helper function to check if team info should be shown
    function shouldShowTeamInfo() {
        return gameState.teamBlinding !== 'blind';
    }
    
    // Helper function to check if using rapid scoring mode
    function isRapidScoringMode() {
        return gameState.scoringApproach === 'rapid';
    }
    
    // Helper function to check if player is delegating to committee
    function isDelegateMode() {
        return gameState.scoringApproach === 'delegate';
    }
    
    function autoSelectRandomProjects() {
        // Randomly select projects until budget is exhausted
        const shuffled = shuffleArray([...gameState.projectPool]);
        gameState.selectedProjects = [];
        let budget = gameState.maxBudget;
        
        for (const project of shuffled) {
            if (project.budget <= budget) {
                gameState.selectedProjects.push(project.id);
                budget -= project.budget;
            }
        }
        gameState.budget = budget;
    }
    
    function renderAssessmentGrid() {
        // Now we render one project at a time
        gameState.currentAssessmentIndex = 0;
        renderCurrentProject();
    }
    
    function renderCurrentProject() {
        const project = gameState.projectPool[gameState.currentAssessmentIndex];
        const criteria = gameState.criteria;
        const total = gameState.projectPool.length;
        const current = gameState.currentAssessmentIndex + 1;
        
        const isRapid = isRapidScoringMode();
        const showTeam = shouldShowTeamInfo();
        
        // Update progress
        document.getElementById('current-project-num').textContent = current;
        document.getElementById('total-projects').textContent = total;
        document.getElementById('assessment-progress-fill').style.width = `${(current / total) * 100}%`;
        
        // Render progress dots
        renderProgressDots();
        
        // Update navigation buttons
        document.getElementById('prev-project-btn').disabled = gameState.currentAssessmentIndex === 0;
        const isLastProject = gameState.currentAssessmentIndex === total - 1;
        const nextBtn = document.getElementById('next-project-btn');
        nextBtn.textContent = isLastProject ? 'See Committee Feedback →' : 'Next Project →';
        
        // Extract short description (first sentence or up to 150 chars)
        const fullDesc = project.fullDesc || project.desc || 'No description available.';
        const shortDesc = fullDesc.length > 150 ? fullDesc.substring(0, 150) + '...' : fullDesc;
        
        // Generate rapid summary for rapid mode
        const rapidSummary = generateRapidSummary(project);
        
        // Render project view based on mode
        const projectView = document.getElementById('assessment-project-view');
        
        if (isRapid) {
            // Calculate lead track record percentage
            const leadTrackPct = project.lead ? Math.round(getLeadTrackScore(project.lead) * 100) : null;
            const leadTrackClass = leadTrackPct >= 70 ? 'success' : leadTrackPct >= 50 ? 'warning' : 'danger';
            
            // RAPID SCORING MODE - Condensed view
            projectView.innerHTML = `
                <div class="rapid-mode-badge">⚡ Rapid Screening Mode</div>
                
                <div class="assessment-project-header">
                    <div>
                        <div class="assessment-project-title">${project.name}</div>
                        <div class="assessment-project-tagline">${project.tagline}</div>
                        ${renderInnovationBadges(project, true, true)}
                    </div>
                    <div class="assessment-project-budget">$${project.budget}M </div>
                </div>
                
                <div class="strategic-buckets">
                    ${(project.strategicBuckets || []).map(bucket => `
                        <span class="strategic-bucket" style="background: ${bucket.color}20; color: ${bucket.color}; border: 1px solid ${bucket.color}40;">
                            ${bucket.icon} ${bucket.name}
                        </span>
                    `).join('')}
                </div>
                
                <!-- RAPID KEY FACTS -->
                <div class="key-facts-grid rapid-facts">
                    <div class="key-fact">
                        <div class="key-fact-value">${project.milestones?.totalDuration || '12 months'}</div>
                        <div class="key-fact-label">Duration</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value">TRL ${project.trl?.current || '?'} → ${project.trl?.target || '?'}</div>
                        <div class="key-fact-label">Tech Readiness</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value">${project.financials?.grossMargin || 'TBD'}</div>
                        <div class="key-fact-label">Gross Margin</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value fto-${(project.ipPosition?.risk || 'unknown').toLowerCase().replace('-', '')}">${project.ipPosition?.risk || '?'}</div>
                        <div class="key-fact-label">IP Risk</div>
                    </div>
                </div>
                
                <!-- RAPID SUMMARY - 100-150 words -->
                <div class="assessment-section rapid-summary">
                    <p class="project-rapid-desc">${rapidSummary}</p>
                </div>
                
                ${showTeam && project.lead ? `
                    <div class="rapid-team-hint">
                        <span class="team-icon">👤</span>
                        <span class="team-text">Lead: <strong>${project.lead.name}</strong> · <span class="track-record-badge ${leadTrackClass}">${leadTrackPct}% track record</span></span>
                    </div>
                ` : !showTeam ? `
                    <div class="rapid-team-hint blinded">
                        <span class="team-icon">🎭</span>
                        <span class="team-text">Team information hidden (Blind Review)</span>
                    </div>
                ` : ''}
                
                <div class="rapid-details-link">
                    <button class="btn btn-sm btn-secondary" onclick="openProjectTemplateModal('${project.id}')">
                        📋 View Full Project Details
                    </button>
                </div>
            `;
        } else {
            // CAREFUL SCORING MODE - Compact view (details in pop-up)
            const techRisks = (project.technicalRisks || []).slice(0, 3);
            const marketRisks = (project.marketRisks || []).slice(0, 3);

            projectView.innerHTML = `
                <div class="assessment-project-header">
                    <div>
                        <div class="assessment-project-title">${project.name}</div>
                        <div class="assessment-project-tagline">${project.tagline}</div>
                        ${renderInnovationBadges(project, true, true)}
                    </div>
                    <div class="assessment-project-budget">$${project.budget}M</div>
                </div>

                <div class="strategic-buckets">
                    ${(project.strategicBuckets || []).map(bucket => `
                        <span class="strategic-bucket" style="background: ${bucket.color}15; color: ${bucket.color}; border: 1px solid ${bucket.color}40;">
                            ${bucket.icon} ${bucket.name}
                        </span>
                    `).join('')}
                </div>

                <div class="key-facts-grid">
                    <div class="key-fact">
                        <div class="key-fact-value">${project.milestones?.totalDuration || (project.timeline ? `${project.timeline} qtrs` : 'TBD')}</div>
                        <div class="key-fact-label">Time Horizon</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value">TRL ${project.trl?.current || '?'} → ${project.trl?.target || '?'}</div>
                        <div class="key-fact-label">Tech Readiness</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value">${project.financials?.peakAnnualRevenue || project.revenuePotential || 'TBD'}</div>
                        <div class="key-fact-label">Revenue Potential</div>
                    </div>
                    <div class="key-fact">
                        <div class="key-fact-value">${project.financials?.grossMargin || 'TBD'}</div>
                        <div class="key-fact-label">Gross Margin</div>
                    </div>
                </div>

                <div class="assessment-summary">
                    <p style="margin: 10px 0; color: var(--gray-700);">${project.desc || project.description || ''}</p>
                </div>

                <div class="two-col" style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <div class="mini-panel" style="padding: 10px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 12px;">
                        <div style="font-weight: 700; margin-bottom: 6px;">⚠️ Technical watch-outs</div>
                        <ul style="margin-left: 18px; color: var(--gray-700);">
                            ${(techRisks.length ? techRisks : ['Key technical risks are described in the full proposal.']).map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mini-panel" style="padding: 10px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 12px;">
                        <div style="font-weight: 700; margin-bottom: 6px;">📈 Market watch-outs</div>
                        <ul style="margin-left: 18px; color: var(--gray-700);">
                            ${(marketRisks.length ? marketRisks : ['Key market risks are described in the full proposal.']).map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div style="margin-top: 12px; display:flex; justify-content:flex-end;">
                    <button class="btn btn-sm btn-secondary" onclick="openProjectTemplateModal('${project.id}')">📋 View Full Project Details</button>
                </div>
            `;
        } // End of else (careful mode)
        
        // Render scoring interface
        renderScoringInterface(project, criteria);
    }
    
    function renderTeamLeads(teamDetails) {
        if (!teamDetails || !teamDetails.leads) return '<p style="color: var(--gray-500);">Team assignment pending.</p>';
        
        return teamDetails.leads.map(lead => {
            const staff = lead.staffId ? findStaff(lead.staffId) : null;
            
            if (staff) {
                // Get initials for avatar fallback
                const initials = staff.name.split(' ').map(n => n[0]).join('');
                return `
                    <div class="team-lead-card">
                        <div class="team-lead-avatar" style="background: ${staff.avatarColor || '#003da5'}; color: white; font-weight: 600;">
                            ${initials}
                        </div>
                        <div class="team-lead-info">
                            <div class="team-lead-name">${staff.name}</div>
                            <div class="team-lead-role">${lead.role}</div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="team-lead-card team-lead-vacancy">
                        <div class="team-lead-avatar">?</div>
                        <div class="team-lead-info">
                            <div class="team-lead-name">To Be Hired</div>
                            <div class="team-lead-role">${lead.role}</div>
                        </div>
                    </div>
                `;
            }
        }).join('');
    }
    
    function renderScoringInterface(project, criteria) {
        const criteriaInfo = {
            technical: { name: 'Technical Feasibility', question: 'Can we realistically build this?' },
            capability: { name: 'Capability Fit', question: 'Do we have the skills and resources?' },
            ip: { name: 'IP & Defensibility', question: 'Can we protect this innovation?' },
            strategic: { name: 'Strategic Fit', question: 'Does it align with board priorities?' },
            platform: { name: 'Platform Value', question: 'Does it strengthen our ecosystem?' },
            sustainability: { name: 'Sustainability', question: 'Does it create positive impact?' },
            marketsize: { name: 'Market Size', question: 'How big is the opportunity?' },
            newmarket: { name: 'New Market Creation', question: 'Does it open new segments?' },
            geographic: { name: 'Geographic Expansion', question: 'Does it expand our reach?' },
            competitive: { name: 'Competitive Differentiation', question: 'Will we stand out from rivals?' },
            devcost: { name: 'Development Cost', question: 'Is the investment reasonable?' },
            roi: { name: 'Expected ROI', question: 'Will we get a good return?' },
            speed: { name: 'Time to Market', question: 'Can we launch quickly?' },
            team: { name: 'Team Capability', question: 'Can the team deliver?' },
            risk: { name: 'Risk Profile', question: 'Are the risks manageable?' }
        };
        
        // 3-point scale: Weak (1), OK (3), Strong (5) - keeps same numerical range for calculations
        const scaleOptions = [
            { value: 1, label: 'Weak', icon: '👎', color: '#ef4444' },
            { value: 3, label: 'OK', icon: '👋', color: '#f59e0b' },
            { value: 5, label: 'Strong', icon: '👍', color: '#22c55e' }
        ];
        
        const scoringDiv = document.getElementById('assessment-scoring');
        scoringDiv.innerHTML = `
            <div class="scoring-title">Rate This Project on Your Criteria</div>
            <div class="scoring-criteria-list">
                ${criteria.map(c => {
                    const info = criteriaInfo[c] || { name: c, question: '' };
                    const currentScore = project.playerScores[c];
                    
                    return `
                        <div class="scoring-criterion">
                            <div class="criterion-info">
                                <div class="criterion-name">${info.name}</div>
                                <div class="criterion-question">${info.question}</div>
                            </div>
                            <div class="criterion-scale three-point">
                                ${scaleOptions.map(opt => `
                                    <button class="scale-btn ${currentScore === opt.value ? 'selected' : ''}" 
                                            style="--btn-color: ${opt.color}"
                                            onclick="scoreCurrentProject('${c}', ${opt.value})">
                                        <span class="scale-icon">${opt.icon}</span>
                                        <span class="scale-text">${opt.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isProjectFullyScored(project) ? '<div class="scoring-complete">✓ All criteria rated — ready to continue</div>' : ''}
        `;
    }
    
    function scoreCurrentProject(criterion, score) {
        const project = gameState.projectPool[gameState.currentAssessmentIndex];
        project.playerScores[criterion] = score;
        renderScoringInterface(project, gameState.criteria);
        renderProgressDots(); // Update progress dots when score changes
    }
    
    function isProjectFullyScored(project) {
        return gameState.criteria.every(c => project.playerScores[c] !== undefined);
    }
    
    function getProjectScoringStatus(project) {
        const scoredCount = gameState.criteria.filter(c => project.playerScores[c] !== undefined).length;
        const totalCriteria = gameState.criteria.length;
        
        if (scoredCount === 0) return 'unvisited';
        if (scoredCount === totalCriteria) return 'complete';
        return 'partial';
    }
    
    function renderProgressDots() {
        const container = document.getElementById('project-progress-dots');
        if (!container) return;
        
        const currentIndex = gameState.currentAssessmentIndex;
        
        container.innerHTML = `
            <div class="progress-dots-row">
                ${gameState.projectPool.map((project, index) => {
                    let status = getProjectScoringStatus(project);
                    if (index === currentIndex) status = 'current';
                    
                    const isComplete = isProjectFullyScored(project);
                    const displayText = isComplete && index !== currentIndex ? '✓' : (index + 1);
                    
                    return `
                        <div class="progress-dot ${status}" 
                             onclick="jumpToProject(${index})"
                             title="Project ${index + 1}: ${project.name}">
                            ${displayText}
                        </div>
                    `;
                }).join('')}
            </div>
            <div class="progress-legend">
                <div class="legend-item">
                    <div class="legend-dot unvisited"></div>
                    <span>Not scored</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot partial"></div>
                    <span>Partially scored</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot complete"></div>
                    <span>Complete</span>
                </div>
            </div>
        `;
    }
    
    function jumpToProject(index) {
        gameState.currentAssessmentIndex = index;
        renderCurrentProject();
        document.getElementById('phase-assessment').scrollIntoView({ behavior: 'smooth' });
    }
    
    function nextProject() {
        const total = gameState.projectPool.length;
        
        if (gameState.currentAssessmentIndex === total - 1) {
            // Last project - proceed to committee feedback
            showCommitteeFeedback();
        } else {
            gameState.currentAssessmentIndex++;
            renderCurrentProject();
            // Scroll to top of card
            document.getElementById('phase-assessment').scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function prevProject() {
        if (gameState.currentAssessmentIndex > 0) {
            gameState.currentAssessmentIndex--;
            renderCurrentProject();
            document.getElementById('phase-assessment').scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function scoreProject(projectId, criterion, score) {
        const project = gameState.projectPool.find(p => p.id === projectId);
        if (project) {
            project.playerScores[criterion] = score;
        }
    }
    
    function updateAssessmentProgress() {
        // Legacy function - no longer needed with new design
    }
    
    function generateCommitteeScores() {
        // Each committee member scores projects based on their expertise and biases
        const committee = gameState.committee;
        const criteria = gameState.criteria;
        
        gameState.projectPool.forEach(project => {
            project.committeeScores = {};
            
            committee.forEach(memberId => {
                const member = findStaff(memberId);
                if (!member) return;
                
                // Calculate member's score based on their effects and project scores
                let totalScore = 0;
                let weightSum = 0;
                
                criteria.forEach(c => {
                    const baseScore = project.scores[c] || 3;
                    let adjustedScore = baseScore;
                    
                    // Apply member's effects/biases
                    if (member.effects) {
                        // Check if member has relevant expertise
                        if (c === 'technical' && member.effects.technical) {
                            adjustedScore = baseScore * (member.effects.technical > 1 ? 1.1 : 0.9);
                        }
                        if (c === 'marketsize' && member.effects.market) {
                            adjustedScore = baseScore * (member.effects.market > 1 ? 1.1 : 0.9);
                        }
                        if (c === 'strategic' && member.effects.strategic) {
                            adjustedScore = baseScore * (member.effects.strategic > 1 ? 1.1 : 0.9);
                        }
                        if (c === 'team' && member.effects.team) {
                            adjustedScore = baseScore * (member.effects.team > 1 ? 1.1 : 0.9);
                        }
                        
                        // Apply archetype preferences
                        const archetypeEffects = {
                            'conventional_winner': member.effects.conventionalWinner || 1,
                            'hidden_gem': member.effects.hiddenGem || 1,
                            'slow_burner': member.effects.slowBurner || 1,
                            'paper_tiger': member.effects.paperTiger || 1
                        };
                        if (archetypeEffects[project.archetype]) {
                            adjustedScore *= archetypeEffects[project.archetype];
                        }
                    }
                    
                    // Add some randomness for personality
                    adjustedScore += (Math.random() - 0.5) * 0.8;
                    
                    totalScore += Math.max(1, Math.min(5, adjustedScore));
                    weightSum++;
                });
                
                // Member's overall score is average across criteria, with some variance
                const avgScore = totalScore / weightSum;
                project.committeeScores[memberId] = Math.round(Math.max(1, Math.min(5, avgScore)) * 10) / 10;
            });
        });
    }
    
    function showCommitteeFeedback() {
        // For jury mode, randomly select some staff to give feedback
        if (gameState.decisionModel === 'jury' && gameState.committee.length === 0) {
            // Pick 4-6 random staff members for the jury
            const allStaff = [
                ...staffDatabase.senior,
                ...staffDatabase.heads,
                ...staffDatabase.tech,
                ...staffDatabase.junior
            ];
            const shuffled = shuffleArray(allStaff);
            gameState.committee = shuffled.slice(0, 4 + Math.floor(Math.random() * 3)).map(s => s.id);
        }
        
        // Initialize triage state if needed
        if (!gameState.projectTriage) {
            gameState.projectTriage = {};
        }
        
        generateCommitteeScores();
        renderTriageCards();
        showPhase('committee-feedback');
    }
    
    function renderTriageCards() {
        const criteria = gameState.criteria;
        
        // Calculate average scores and rank projects
        const projectsWithScores = gameState.projectPool.map(project => {
            // Player's average score
            const playerScores = Object.values(project.playerScores);
            const playerAvg = playerScores.length > 0 
                ? playerScores.reduce((a, b) => a + b, 0) / playerScores.length 
                : 3;
            
            // Committee average
            const committeeScores = Object.values(project.committeeScores);
            const committeeAvg = committeeScores.length > 0 
                ? committeeScores.reduce((a, b) => a + b, 0) / committeeScores.length 
                : 3;
            
            // Overall average (player counts as one voice)
            const allScores = [playerAvg, ...committeeScores];
            const overallAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
            
            // Calculate consensus (standard deviation)
            const variance = allScores.reduce((sum, s) => sum + Math.pow(s - overallAvg, 2), 0) / allScores.length;
            const stdDev = Math.sqrt(variance);
            
            return {
                ...project,
                playerAvg,
                committeeAvg,
                overallAvg,
                stdDev,
                highConsensus: stdDev < 0.6
            };
        });
        
        // Sort by overall average
        projectsWithScores.sort((a, b) => b.overallAvg - a.overallAvg);
        
        // Store ranked projects
        gameState.rankedProjects = projectsWithScores;
        
        // Auto-suggest triage based on scores (if not already set)
        projectsWithScores.forEach((project, index) => {
            if (!gameState.projectTriage[project.id]) {
                // Top third: suggest fund, middle third: marginal, bottom third: stop
                const percentile = index / projectsWithScores.length;
                if (percentile < 0.33) {
                    gameState.projectTriage[project.id] = 'marginal'; // Default to marginal to encourage thought
                } else if (percentile < 0.67) {
                    gameState.projectTriage[project.id] = 'marginal';
                } else {
                    gameState.projectTriage[project.id] = 'marginal';
                }
            }
        });
        
        // Render triage cards
        const grid = document.getElementById('triage-grid');
        grid.innerHTML = projectsWithScores.map((project, index) => {
            const rank = index + 1;
            const status = gameState.projectTriage[project.id] || 'marginal';
            
            return `
                <div class="triage-card status-${status}" data-project-id="${project.id}">
                    <div class="triage-card-header">
                        <div class="triage-card-rank">#${rank}</div>
                        <div class="triage-card-title">
                            <h4>${project.name}</h4>
                            <span class="tagline">${project.tagline}</span>
                        </div>
                        <div class="triage-card-budget">$${project.budget}M </div>
                    </div>
                    
                    <div class="triage-card-scores">
                        <div class="score-pill avg-score">
                            Avg: <strong>${project.overallAvg.toFixed(1)}</strong>
                        </div>
                        <div class="score-pill your-score">
                            You: <strong>${project.playerAvg.toFixed(1)}</strong>
                        </div>
                        ${!project.highConsensus ? `
                            <div class="score-pill consensus">
                                ⚠️ Views differ
                            </div>
                        ` : ''}
                    </div>
                    
                    ${project.lead && shouldShowTeamInfo() ? `
                    <div class="lead-link" onclick="openLeadModal('${project.lead.id}')" title="Click to view full CV" style="margin: 8px 0;">
                        <span class="lead-link-avatar" style="background: ${project.lead.avatarColor}20; color: ${project.lead.avatarColor};">${project.lead.initials}</span>
                        <span class="lead-link-name">${project.lead.name}</span>
                        <span class="lead-link-badge ${getLeadTrackScore(project.lead) >= 0.7 ? 'success' : getLeadTrackScore(project.lead) >= 0.5 ? 'warning' : 'danger'}">${Math.round(getLeadTrackScore(project.lead) * 100)}%</span>
                        <span class="lead-link-cta">View CV →</span>
                    </div>
                    ` : !shouldShowTeamInfo() ? `
                    <div class="lead-link blinded" style="margin: 8px 0;">
                        <span class="lead-link-avatar" style="background: #e0e7ff; color: #4338ca;">🎭</span>
                        <span class="lead-link-name" style="color: #6366f1;">Team info hidden</span>
                    </div>
                    ` : ''}
                    
                    <div class="triage-card-actions">
                        <button class="triage-btn fund-btn ${status === 'fund' ? 'active' : ''}" 
                                onclick="setTriage('${project.id}', 'fund')">
                            ✅ Fund
                        </button>
                        <button class="triage-btn marginal-btn ${status === 'marginal' ? 'active' : ''}" 
                                onclick="setTriage('${project.id}', 'marginal')">
                            ⚖️ Marginal
                        </button>
                        <button class="triage-btn stop-btn ${status === 'stop' ? 'active' : ''}" 
                                onclick="setTriage('${project.id}', 'stop')">
                            🚫 Stop
                        </button>
                        <button class="triage-btn info-btn" onclick="openProjectModal('${project.id}')">
                            ℹ️
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        updateTriageSummary();
    }
    
    function setTriage(projectId, status) {
        gameState.projectTriage[projectId] = status;
        
        // Update card styling
        const card = document.querySelector(`.triage-card[data-project-id="${projectId}"]`);
        if (card) {
            card.className = `triage-card status-${status}`;
            card.querySelectorAll('.triage-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(`${status}-btn`)) {
                    btn.classList.add('active');
                }
            });
        }
        
        updateTriageSummary();
    }
    
    function updateTriageSummary() {
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        let fundedCount = 0, marginalCount = 0, stopCount = 0;
        let fundedBudget = 0, marginalBudget = 0;
        
        projects.forEach(project => {
            const status = gameState.projectTriage[project.id] || 'marginal';
            if (status === 'fund') {
                fundedCount++;
                fundedBudget += project.budget;
            } else if (status === 'marginal') {
                marginalCount++;
                marginalBudget += project.budget;
            } else {
                stopCount++;
            }
        });
        
        // Update counts
        document.getElementById('count-fund').textContent = fundedCount;
        document.getElementById('count-marginal').textContent = marginalCount;
        document.getElementById('count-stop').textContent = stopCount;
        
        // Update budget bar
        const percentage = (fundedBudget / gameState.maxBudget) * 100;
        document.getElementById('triage-budget-fill').style.width = `${Math.min(100, percentage)}%`;
        document.getElementById('triage-funded-amount').textContent = `$${fundedBudget.toFixed(1)}M`;
        document.getElementById('triage-remaining-amount').textContent = `$${(gameState.maxBudget - fundedBudget).toFixed(1)}M`;
        document.getElementById('triage-marginal-amount').textContent = `$${marginalBudget.toFixed(1)}M`;
        
        // Check if over budget
        if (fundedBudget > gameState.maxBudget) {
            document.getElementById('triage-budget-fill').style.background = '#ef4444';
        } else {
            document.getElementById('triage-budget-fill').style.background = 'linear-gradient(90deg, #22c55e 0%, var(--primary) 100%)';
        }
    }
    
    // Legacy function - keep for compatibility
    function renderCommitteeFeedback() {
        renderTriageCards();
    }
    
    function showFinalSelection() {
        // Prevent budget reset if selection has already been locked
        if (gameState.year1SelectionLocked) {
            console.warn('Portfolio already locked - cannot reset budget');
            return;
        }

        gameState.selectedProjects = [];
        // Reset budget: Annual budget minus legacy commitments
        gameState.budget = gameState.maxBudget - (gameState.legacyBudgetCommitted || 0);

        // Default Year 1 selection to Card View, with Risk–Speed as the first landscape
        y1SelectionView = 'cards';
        y1SelectionMatrix = 'risk-speed';

        renderProjectGrid();
        showPhase('selection');

        // Ensure selection UI matches view state
        switchY1SelectionView(y1SelectionView);
    }
    
    
    // ============================================================
    // YEAR 1 SELECTION: optional Landscape View (same 4 matrices as Y2)
    // ============================================================
    let y1SelectionView = 'cards';
    let y1SelectionMatrix = 'risk-speed';

    function switchY1SelectionView(view) {
        y1SelectionView = view;

        const scope = document.getElementById('phase-selection') || document;
        scope.querySelectorAll('.portfolio-view-tabs .view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === view);
        });

        const cards = document.getElementById('y1-selection-cards-view');
        const matrix = document.getElementById('y1-selection-matrix-view');
        if (cards) cards.classList.toggle('hidden', view !== 'cards');
        if (matrix) matrix.classList.toggle('hidden', view !== 'matrix');

        if (view === 'matrix') {
            renderY1SelectionMatrix();
        }
    }

    function switchY1SelectionMatrix(matrixType) {
        y1SelectionMatrix = matrixType;

        const scope = document.getElementById('phase-selection') || document;
        scope.querySelectorAll('#y1-selection-matrix-view .matrix-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.matrix === matrixType);
        });

        renderY1SelectionMatrix();
    }

    function getProjectMatrixScoreFor(project, matrixType, axis) {
        const pos = projectMatrixPositions[project.id]?.[matrixType];
        if (pos) return axis === 'x' ? pos.x : pos.y;
        return 50;
    }

    function renderY1SelectionMatrix() {
        const container = document.getElementById('y1-selection-matrix');
        if (!container) return;

        // Ensure positions exist for the current pool (ranked or unranked)
        computeProjectPositions();

        const config = matrixConfigs[y1SelectionMatrix] || matrixConfigs['risk-speed'];
        const projects = gameState.rankedProjects || gameState.projectPool;

        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;

        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;

        const bubblesHtml = projects.map((project, index) => {
            const isSelected = gameState.selectedProjects.includes(project.id);
            const canAfford = isSelected || project.budget <= gameState.budget;

            const xPos = getProjectMatrixScoreFor(project, y1SelectionMatrix, 'x');
            const yPos = 100 - getProjectMatrixScoreFor(project, y1SelectionMatrix, 'y'); // invert for CSS top

            const minBudget = 2, maxBudget = 15;
            const budgetNorm = (project.budget - minBudget) / (maxBudget - minBudget);
            const size = 40 + clamp(budgetNorm, 0, 1) * 30;

            let statusClass = 'marginal-out';
            let clickable = true;

            if (isSelected) {
                statusClass = 'marginal-in';
            } else if (!canAfford) {
                statusClass = 'unaffordable';
                clickable = false;
            }

            const rank = (gameState.rankedProjects ? index + 1 : null);
            return `
                <div class="project-bubble ${statusClass}"
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px;"
                     onclick="${clickable ? `toggleProject('${project.id}')` : ''}"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${rank ? `#${rank} ` : ''}${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M</div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.85;">
                            ${isSelected ? '✓ Selected' : canAfford ? 'Click to select' : 'Over budget'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = quadrantsHtml + axesHtml + bubblesHtml;
    }

    // ============================================
    // PORTFOLIO BUILDER - 2x2 MATRIX VISUALIZATION
    // ============================================
    
    const matrixConfigs = {
        'risk-speed': {
            title: 'Speed vs Risk',
            // NOTE: In the portfolio landscapes we treat Risk as the horizontal axis and Speed/Time-to-Market as the vertical axis.
            // This matches how most players reason about "risk appetite" left→right and "urgency/speed" bottom→top.
            xAxis: { label: 'Risk Level', min: 'Lower Risk', max: 'Higher Risk', key: 'risk' },
            yAxis: { label: 'Time to Market', min: 'Slower', max: 'Faster', key: 'speed' },
            quadrants: {
                // q1 = top-right, q2 = top-left, q3 = bottom-left, q4 = bottom-right
                q1: { label: 'Quick Wins', desc: 'Fast & risky — move quickly' },
                q2: { label: 'Low Hanging Fruit', desc: 'Fast & safe — easy wins' },
                q3: { label: 'Safe & Steady', desc: 'Slow & safe — proven path' },
                q4: { label: 'Big Bets', desc: 'Slow & risky — high uncertainty' }
            }
        },
        'market-tech': {
            title: 'Market vs Technology',
            xAxis: { label: 'Technology Novelty', min: 'Existing Tech', max: 'New Tech', key: 'technical' },
            yAxis: { label: 'Market Expansion', min: 'Existing Markets', max: 'New Markets', key: 'newmarket' },
            quadrants: {
                q1: { label: 'Breakthrough', desc: 'New tech, new markets' },
                q2: { label: 'Market Pioneer', desc: 'Existing tech, new markets' },
                q3: { label: 'Core Enhancement', desc: 'Existing tech, existing markets' },
                q4: { label: 'Tech Leadership', desc: 'New tech, existing markets' }
            }
        },
        'capability-strategic': {
            title: 'Capability vs Strategy',
            xAxis: { label: 'Capability Fit', min: 'New Capabilities', max: 'Core Strengths', key: 'capability' },
            yAxis: { label: 'Strategic Priority', min: 'Lower Priority', max: 'Board Priority', key: 'strategic' },
            quadrants: {
                q1: { label: 'Strategic Core', desc: 'High priority, leverages strengths' },
                q2: { label: 'Strategic Stretch', desc: 'High priority, needs new skills' },
                q3: { label: 'Exploration', desc: 'Lower priority, builds new capabilities' },
                q4: { label: 'Efficiency Plays', desc: 'Lower priority, uses existing skills' }
            }
        },
        'roi-cost': {
            title: 'ROI vs Investment',
            xAxis: { label: 'Development Cost', min: 'Lower Cost', max: 'Higher Cost', key: 'devcost' },
            yAxis: { label: 'Expected ROI', min: 'Lower ROI', max: 'Higher ROI', key: 'roi' },
            quadrants: {
                q1: { label: 'Premium Bets', desc: 'High ROI, high cost - flagship projects' },
                q2: { label: 'Stars', desc: 'High ROI, low cost - prioritise these' },
                q3: { label: 'Fillers', desc: 'Low ROI, low cost - opportunistic' },
                q4: { label: 'Question Marks', desc: 'Low ROI, high cost - reconsider' }
            }
        }
    };
    
    let currentMatrix = 'risk-speed';
    
    function showPortfolioBuilder() {
        // Prevent budget reset if selection has already been locked
        if (gameState.year1SelectionLocked) {
            console.warn('Portfolio already locked - cannot reset budget');
            return;
        }
        
        // Initialize selected projects based on triage
        gameState.selectedProjects = [];
        // Reset budget: Annual budget minus legacy commitments
        gameState.budget = gameState.maxBudget - (gameState.legacyBudgetCommitted || 0);
        
        // Auto-include funded projects
        const projects = gameState.rankedProjects || gameState.projectPool;
        projects.forEach(project => {
            const status = gameState.projectTriage[project.id];
            if (status === 'fund') {
                gameState.selectedProjects.push(project.id);
                gameState.budget -= project.budget;
            }
        });
        
        currentMatrix = 'risk-speed';
        currentPortfolioView = 'matrix';
        
        // Compute matrix positions for all projects
        computeProjectPositions();
        
        renderMatrix();
        renderPortfolioListView();
        updatePortfolioSidebar();
        showPhase('portfolio-builder');
    }
    
    let currentPortfolioView = 'matrix';
    
    function switchPortfolioView(view) {
        currentPortfolioView = view;

        const scope = document.getElementById('phase-portfolio-builder') || document;
        scope.querySelectorAll('.view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === view);
        });

        document.getElementById('portfolio-matrix-view').classList.toggle('hidden', view !== 'matrix');
        document.getElementById('portfolio-list-view').classList.toggle('hidden', view !== 'list');

        if (view === 'list') {
            renderPortfolioListView();
        }
    }
    
    function switchMatrix(matrixType) {
        currentMatrix = matrixType;

        // Scope UI updates to Year 1 portfolio builder so we don't toggle hidden tabs in other phases
        const scope = document.getElementById('phase-portfolio-builder') || document;
        scope.querySelectorAll('.matrix-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.matrix === matrixType);
        });

        renderMatrix();
    }
    
    // Store computed positions so they're consistent
    let projectMatrixPositions = {};
    
    function computeProjectPositions() {
        // Clear previous positions
        projectMatrixPositions = {};
        
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        // For each matrix type, compute positions based on project attributes
        projects.forEach((project, index) => {
            projectMatrixPositions[project.id] = {};
            
            // Use a seeded random based on project id for consistent jitter
            const seed = hashString(project.id);
            const jitterX = seededRandom(seed) * 15 - 7.5;
            const jitterY = seededRandom(seed + 1) * 15 - 7.5;
            
            // Risk-Speed: align with what players see (risk + speed criteria), while keeping sensible fallbacks
            let riskScore = (project.criteriaScores?.risk ?? project.scores?.risk ?? null);
            if (riskScore == null) {
                const successRate = (project.baseSuccessRate != null)
                    ? project.baseSuccessRate
                    : Math.round((project.successProb != null ? project.successProb : 0.65) * 100);
                // Convert success-rate to a 1–5 risk score (lower success => higher risk)
                riskScore = mapToRange(100 - successRate, 5, 60, 1, 5);
            }
            riskScore = clamp(riskScore, 1, 5);
            const riskPos = mapToRange(riskScore, 1, 5, 15, 85);

            let speedScore = (project.criteriaScores?.speed ?? project.scores?.speed ?? null);
            if (speedScore == null) {
                const timeline = (project.timeline != null)
                    ? project.timeline
                    : (project.quartersRemaining != null ? project.quartersRemaining : null);
                if (timeline != null) {
                    // Shorter timeline => faster
                    speedScore = mapToRange(timeline, 12, 3, 1, 5);
                } else {
                    const trlCurrent = project.trl?.current || 3;
                    // Higher TRL => faster
                    speedScore = mapToRange(trlCurrent, 1, 9, 1, 5);
                }
            }
            speedScore = clamp(speedScore, 1, 5);
            const speedPos = mapToRange(speedScore, 1, 5, 15, 85);

            // NOTE: Risk is X (left→right), Speed is Y (bottom→top)
            projectMatrixPositions[project.id]['risk-speed'] = {
                x: clamp(riskPos + jitterX, 8, 92),
                y: clamp(speedPos + jitterY, 8, 92)
            };

            // Market-Tech: align with innovation cues (tech novelty + market newness)
            const techLevel = getTechNoveltyLevel(project);      // 1–4 (Existing → Frontier)
            const marketLevel = getMarketNewnessLevel(project);  // 1–4 (Sustaining → New category)

            const techPos = mapToRange(techLevel, 1, 4, 15, 85);
            const marketPos = mapToRange(marketLevel, 1, 4, 15, 85);

            projectMatrixPositions[project.id]['market-tech'] = {
                x: clamp(techPos + jitterX, 8, 92),
                y: clamp(marketPos + jitterY, 8, 92)
            };

            // Capability-Strategic: Use capability fit and strategic alignment
            const capabilityFit = project.criteriaScores?.capability || getCapabilityScore(project);
            const strategicPriority = project.criteriaScores?.strategic || getStrategicScore(project);
            projectMatrixPositions[project.id]['capability-strategic'] = {
                x: clamp(mapToRange(capabilityFit, 1, 5, 15, 85) + jitterX, 8, 92),
                y: clamp(mapToRange(strategicPriority, 1, 5, 15, 85) + jitterY, 8, 92)
            };
            
            // ROI-Cost: Use budget and expected returns
            const costScore = mapToRange(project.budget, 2, 15, 15, 85); // Higher budget = higher cost
            const roiScore = project.criteriaScores?.roi || getROIScore(project);
            projectMatrixPositions[project.id]['roi-cost'] = {
                x: clamp(costScore + jitterX, 8, 92),
                y: clamp(mapToRange(roiScore, 1, 5, 15, 85) + jitterY, 8, 92)
            };
        });
    }
    
    function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return Math.abs(hash);
    }
    
    function seededRandom(seed) {
        const x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
    }
    
    function mapToRange(value, inMin, inMax, outMin, outMax) {
        return ((value - inMin) / (inMax - inMin)) * (outMax - outMin) + outMin;
    }
    
    function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
    }
    
    function getTechNoveltyScore(project) {
        // Based on archetype and TRL
        const archetype = project.archetype || '';
        const trl = project.trl?.current || 5;
        
        let base = 50;
        if (archetype.includes('platform') || archetype.includes('moonshot')) base = 75;
        else if (archetype.includes('incremental') || archetype.includes('cost')) base = 25;
        else if (archetype.includes('adjacent')) base = 55;
        else if (archetype.includes('ip') || archetype.includes('tech')) base = 70;
        
        // Lower TRL = more novel tech
        const trlAdjust = (5 - trl) * 5;
        return mapToRange(base + trlAdjust, 0, 100, 15, 85);
    }
    
    function getMarketExpansionScore(project) {
        // Based on strategic buckets and archetype
        const buckets = project.strategicBuckets || [];
        const bucketIds = buckets.map(b => b.id).join(' ');
        
        let score = 50;
        if (bucketIds.includes('ai-first')) score = 80;
        else if (bucketIds.includes('tier23-rollout')) score = 70;
        else if (bucketIds.includes('defend-metro')) score = 25;
        else if (bucketIds.includes('recurring-revenue')) score = 60;
        
        return mapToRange(score, 0, 100, 15, 85);
    }

    // ============================================================
    // INNOVATION CUES: Tech Novelty + Market Newness (player signals)
    // ============================================================
    const TECH_NOVELTY_LEVELS = [
        { level: 1, label: 'Existing stack', icon: '🛠️', hint: 'Technology ShieldTech already uses and understands well. Teams have deep expertise; integration and scaling are predictable. Low capability risk.' },
        { level: 2, label: 'Extension',     icon: '🧩', hint: 'Builds on existing tech with modest adaptations—new features, updated algorithms, or expanded use cases. Some learning required but core competencies apply. Moderate capability risk.' },
        { level: 3, label: 'New-to-firm',    icon: '🧪', hint: 'Technology ShieldTech hasn\'t worked with before. Requires building new skills, partnerships, or infrastructure. Higher capability and integration risk; longer ramp-up time.' },
        { level: 4, label: 'Frontier',      icon: '🚀', hint: 'Cutting-edge tech with significant unknowns—may still be maturing industry-wide. High feasibility risk; success depends on solving hard technical problems first.' }
    ];
    const MARKET_NEWNESS_LEVELS = [
        { level: 1, label: 'Sustaining',     icon: '🏙️', hint: 'Serving existing customers in familiar markets. Sales channels, pricing, and buyer relationships are established. Low go-to-market risk; success depends on execution.' },
        { level: 2, label: 'Adjacent',       icon: '🧭', hint: 'Moving into neighboring segments or geographies—different buyers but related needs. Requires adapting positioning and channels. Moderate adoption risk.' },
        { level: 3, label: 'New market',     icon: '🏬', hint: 'Entering markets where ShieldTech has no presence or brand recognition. Must build awareness, credibility, and new channel partnerships. Higher market risk and longer sales cycles.' },
        { level: 4, label: 'New category',   icon: '🌱', hint: 'Creating or defining an entirely new product category. Buyers may not know they need it yet. Requires heavy education, ecosystem building, and patience. Highest adoption risk.' }
    ];

    function clampLevel(v, min=1, max=4) { return Math.max(min, Math.min(max, v)); }

    function getSectorHint(project) {
        const a = (project.archetype || '').toLowerCase();
        if (a.includes('shrink') || a.includes('visitor_flow')) return 'retail';
        if (a.includes('wander') || a.includes('emergency_muster')) return 'healthcare / safety';
        if (a.includes('rtls') || a.includes('vehicle')) return 'logistics / mobility';
        if (a.includes('drone') || a.includes('anti_drone')) return 'critical infrastructure';
        if (a.includes('compliance') || a.includes('contractor')) return 'regulated enterprise';
        if (a.includes('soc') || a.includes('cyber') || a.includes('deepfake')) return 'security operations';
        if (a.includes('smart_access') || a.includes('smart_key') || a.includes('smart_intercom')) return 'physical access';
        if (a.includes('camera') || a.includes('video')) return 'video security';
        if (a.includes('services_platform') || a.includes('alarm_response')) return 'services & platforms';
        if ((project.strategicBuckets||[]).some(b=>b.id==='tier23-rollout')) return 'tier-2/3 city SMB';
        return 'enterprise security';
    }

    function pickBuyerHint(project) {
        const buckets = project.strategicBuckets || [];
        const ids = buckets.map(b => b.id);
        if (ids.includes('defend-metro')) return 'existing metro enterprise accounts';
        if (ids.includes('tier23-rollout')) return 'Tier-2/3 city SMB buyers';
        if (ids.includes('recurring-revenue')) return 'installed base (upsell/cross-sell)';
        if (ids.includes('ai-first')) return 'AI-forward buyers + innovation teams';
        return 'core security decision makers';
    }

    function inferTechSignals(project) {
        const name = (project.name || '').toLowerCase();
        const a = (project.archetype || '').toLowerCase();
        const out = [];

        if (a.includes('ai') || name.includes('ai') || name.includes('vision')) out.push('Needs a new ML model + training data pipeline tuned for Indian conditions.');
        if (a.includes('drone') || name.includes('drone')) out.push('Requires autonomy/control logic, safety constraints, and reliable field testing.');
        if (a.includes('deepfake') || name.includes('deepfake')) out.push('Depends on robust liveness + spoof detection under varied cameras and lighting.');
        if (a.includes('digital_twin') || name.includes('twin')) out.push('Needs sensor fusion + mapping to maintain a live operational model at scale.');
        if (a.includes('rtls') || name.includes('tracking')) out.push('Relies on accurate indoor localization (UWB/BLE), calibration, and drift handling.');
        if (a.includes('soc') || a.includes('cyber')) out.push('Requires secure telemetry, correlation rules, and SOC workflows that scale across sites.');
        if (out.length === 0) out.push('Main technical risk is integration, reliability, and operating at Indian scale and network variability.');
        return out.slice(0, 3);
    }

    function inferMarketSignals(project) {
        const a = (project.archetype || '').toLowerCase();
        const sector = getSectorHint(project);
        const buyer = pickBuyerHint(project);
        const out = [];

        // A couple of concrete hooks so this doesn't feel generic
        if (sector.includes('retail')) out.push('Value proof must tie to shrink reduction and store ops simplicity (low training overhead).');
        if (sector.includes('healthcare')) out.push('Adoption hinges on incident reduction + compliance; pilots need frontline workflow fit.');
        if (sector.includes('logistics')) out.push('Winning needs measurable throughput gains and integration to dispatch/WMS workflows.');
        if (sector.includes('critical')) out.push('Sales cycles depend on risk/compliance stakeholders; require strong ROI + incident narrative.');

        if ((project.strategicBuckets||[]).some(b=>b.id==='tier23-rollout')) out.push('Route-to-market leans on installers + local partners; price sensitivity is higher.');
        if ((project.strategicBuckets||[]).some(b=>b.id==='recurring-revenue')) out.push('Packaging + retention mechanics matter as much as initial win (churn + attach rate).');

        if (a.includes('subscription') || a.includes('services')) out.push('Requires clear “why subscribe” story: monitoring outcomes, not just features.');
        if (out.length === 0) out.push(`Primary adoption and buying center is ${buyer}; success depends on messaging + proof points.`);

        return out.slice(0, 3);
    }

    function getTechNoveltyLevel(project) {
        const trl = project.trl?.current ?? 5;
        const a = (project.archetype || '').toLowerCase();
        let level = 2;
        if (trl >= 7) level = 1;
        else if (trl >= 5) level = 2;
        else if (trl >= 3) level = 3;
        else level = 4;

        // Bump for inherently novel archetypes
        if (a.includes('ai_') || a.includes('deepfake') || a.includes('digital_twin') || a.includes('autonomous') || a.includes('proprietary_tech')) level += 1;
        // Downshift for incremental / operational archetypes
        if (a.includes('core_upgrade') || a.includes('camera_health') || a.includes('rapid_deploy') || a.includes('security_score') || a.includes('shrink_prevention')) level -= 1;

        return clampLevel(level);
    }

    function getMarketNewnessLevel(project) {
        const a = (project.archetype || '').toLowerCase();
        const ids = (project.strategicBuckets || []).map(b => b.id);
        let level = 2;

        if (ids.includes('defend-metro')) level = 1;
        if (ids.includes('recurring-revenue')) level = Math.max(level, 2);
        if (ids.includes('tier23-rollout')) level = Math.max(level, 2);
        if (ids.includes('ai-first')) level = Math.max(level, 3);

        // Archetype nudges
        if (a.includes('underserved_market') || a.includes('anti_drone') || a.includes('wander') || a.includes('emergency_muster') || a.includes('rtls')) level = Math.max(level, 3);
        if (a.includes('proprietary_tech') || a.includes('digital_twin')) level = Math.max(level, 4);
        if (a.includes('core_upgrade') || a.includes('camera_health') || a.includes('smart_access') || a.includes('smart_key')) level = Math.min(level, 2);

        return clampLevel(level);
    }

    function getInnovationCues(project) {
        const techLevel = getTechNoveltyLevel(project);
        const marketLevel = getMarketNewnessLevel(project);

        const techMeta = TECH_NOVELTY_LEVELS.find(x => x.level === techLevel);
        const marketMeta = MARKET_NEWNESS_LEVELS.find(x => x.level === marketLevel);

        return {
            tech: {
                ...techMeta,
                level: techLevel,
                signals: inferTechSignals(project),
                trl: project.trl?.current ?? null
            },
            market: {
                ...marketMeta,
                level: marketLevel,
                signals: inferMarketSignals(project),
                sector: getSectorHint(project)
            }
        };
    }

        function renderInnovationBadges(project, compact=true, withHelp=false) {
        const cues = getInnovationCues(project);
        const techTitle = `${cues.tech.hint}${cues.tech.trl ? ` (Current TRL: ${cues.tech.trl}/9)` : ''}

Signals:
- ${cues.tech.signals.join('\n- ')}`;
        const marketTitle = `${cues.market.hint} (Sector: ${cues.market.sector})

Signals:
- ${cues.market.signals.join('\n- ')}`;

        return `
            <div class="cue-row">
                <span class="cue-badge tech" title="${escapeHtml(techTitle)}">${cues.tech.icon} Tech: <strong>${cues.tech.label}</strong></span>
                <span class="cue-badge market" title="${escapeHtml(marketTitle)}">${cues.market.icon} Market: <strong>${cues.market.label}</strong></span>
                ${withHelp ? `<button class="cue-help-btn" onclick="openInnovationCueHelp(event)" title="What do these labels mean?">?</button>` : ''}
            </div>
        `;
    }

    function renderInnovationDetail(project) {
        const cues = getInnovationCues(project);
        return `
            ${renderInnovationBadges(project, false, true)}
            <div class="cue-detail">
                <div><strong>Tech risk signal:</strong> ${cues.tech.label}${cues.tech.trl ? ` (TRL ${cues.tech.trl}/9)` : ''}</div>
                <ul>${cues.tech.signals.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ul>
                <div style="margin-top:10px;"><strong>Market newness signal:</strong> ${cues.market.label} — ${escapeHtml(cues.market.sector)}</div>
                <ul>${cues.market.signals.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ul>
                <div style="margin-top:10px; font-size: 0.85em; color: var(--gray-500);">Tip: treat these as directional cues—combine with TRL, milestones, and your strategy.</div>
            </div>
        `;
    }

    function openInnovationCueHelp(evt) {
        if (evt && evt.stopPropagation) evt.stopPropagation();
        openInnovationCueHelpModal();
    }

    function openInnovationCueHelpModal() {
        let overlay = document.getElementById('innovation-cue-help-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'innovation-cue-help-overlay';
            overlay.className = 'modal-overlay';
            overlay.style.zIndex = '5000';
            overlay.onclick = (e) => { if (e.target === overlay) closeInnovationCueHelpModal(); };

            const techRows = TECH_NOVELTY_LEVELS.map(t => `
                <div style="display:flex; gap:10px; padding:10px 12px; border:1px solid var(--gray-200); border-radius:12px; background: var(--gray-50);">
                    <div style="font-size: 1.25em; width: 28px; text-align:center;">${t.icon}</div>
                    <div>
                        <div style="font-weight:800; color: var(--gray-800);">Tech: ${t.label}</div>
                        <div style="color: var(--gray-600); font-size: 0.9em;">${t.hint}</div>
                    </div>
                </div>
            `).join('');

            const marketRows = MARKET_NEWNESS_LEVELS.map(m => `
                <div style="display:flex; gap:10px; padding:10px 12px; border:1px solid var(--gray-200); border-radius:12px; background: var(--gray-50);">
                    <div style="font-size: 1.25em; width: 28px; text-align:center;">${m.icon}</div>
                    <div>
                        <div style="font-weight:800; color: var(--gray-800);">Market: ${m.label}</div>
                        <div style="color: var(--gray-600); font-size: 0.9em;">${m.hint}</div>
                    </div>
                </div>
            `).join('');

            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 760px; position: relative;">
                    <button class="modal-close" onclick="closeInnovationCueHelpModal()">×</button>
                    <h2 style="color: var(--primary); margin-bottom: 10px;">🧭 What do “Tech” and “Market” cues mean?</h2>
                    <p style="color: var(--gray-600); margin-bottom: 18px;">
                        These are quick signals to help you balance the portfolio. <strong>Tech</strong> reflects how novel the technology is for ShieldTech (capability/feasibility risk).
                        <strong>Market</strong> reflects how new the target market/category is for ShieldTech (adoption/go-to-market risk).
                    </p>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                        <div>
                            <h3 style="margin: 0 0 10px; color: var(--gray-800);">Technology novelty (new-to-firm)</h3>
                            <div style="display:flex; flex-direction:column; gap:10px;">${techRows}</div>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px; color: var(--gray-800);">Market newness (new-to-firm)</h3>
                            <div style="display:flex; flex-direction:column; gap:10px;">${marketRows}</div>
                        </div>
                    </div>

                    <div style="margin-top: 18px; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--primary-pale); background: var(--primary-lighter); color: var(--gray-700);">
                        <strong>How to use:</strong> Aim for a mix—pair a few “Existing/Extension” projects with 1–2 “New-to-firm/Frontier” bets, and balance sustaining vs adjacent/new market plays.
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        overlay.classList.remove('hidden');
    }

    function closeInnovationCueHelpModal() {
        const overlay = document.getElementById('innovation-cue-help-overlay');
        if (overlay) overlay.classList.add('hidden');
    }

    // Escapes text for safe attribute/tooltips. (We keep it tiny and local.)
    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    
    function getCapabilityScore(project) {
        // Higher TRL and familiar archetype = better capability fit
        const trl = project.trl?.current || 5;
        const archetype = project.archetype || '';
        
        let base = 3;
        if (archetype.includes('incremental') || archetype.includes('derivative')) base = 4.5;
        else if (archetype.includes('moonshot') || archetype.includes('pivot')) base = 1.5;
        else if (archetype.includes('platform')) base = 2.5;
        
        // Higher TRL = better capability fit
        const trlBonus = (trl - 3) * 0.2;
        return clamp(base + trlBonus, 1, 5);
    }
    
    function getStrategicScore(project) {
        // Based on strategic buckets
        const buckets = project.strategicBuckets || [];
        if (buckets.length === 0) return 3;
        
        // Having a bucket = strategic alignment
        let score = 3.5;
        
        // Certain buckets are higher priority
        const bucketIds = buckets.map(b => b.id).join(' ');
        if (bucketIds.includes('defend-metro')) score += 0.5;
        if (bucketIds.includes('recurring-revenue')) score += 0.3;
        
        return clamp(score, 1, 5);
    }
    
    function getROIScore(project) {
        // Based on financials and success rate
        const successRate = project.baseSuccessRate || 65;
        const margin = parseFloat(project.financials?.grossMargin) || 40;
        
        let score = 3;
        if (successRate > 75) score += 0.8;
        else if (successRate < 55) score -= 0.8;
        
        if (margin > 50) score += 0.5;
        else if (margin < 30) score -= 0.5;
        
        return clamp(score, 1, 5);
    }
    
    function getProjectMatrixScore(project, key, axis) {
        // Use pre-computed positions
        const pos = projectMatrixPositions[project.id]?.[currentMatrix];
        if (pos) {
            return axis === 'x' ? pos.x : pos.y;
        }
        // Fallback
        return 50;
    }
    
    function renderMatrix() {
        const config = matrixConfigs[currentMatrix];
        const container = document.getElementById('matrix-container');
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        // Build quadrant labels
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        // Build axes
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build project bubbles with triage status
        const bubblesHtml = projects.map(project => {
            const triageStatus = gameState.projectTriage[project.id] || 'marginal';
            const isSelected = gameState.selectedProjects.includes(project.id);
            const canAfford = isSelected || project.budget <= gameState.budget;
            
            // Get positions (0-100) from pre-computed positions
            const xPos = getProjectMatrixScore(project, config.xAxis.key, 'x');
            const yPos = 100 - getProjectMatrixScore(project, config.yAxis.key, 'y'); // Invert Y
            
            // Size based on budget (40-75px for better mobile touch targets)
            const minBudget = 2, maxBudget = 15;
            const budgetNorm = (project.budget - minBudget) / (maxBudget - minBudget);
            const size = 40 + budgetNorm * 35;
            
            // Determine bubble class based on triage status
            let statusClass;
            let clickable = true;
            
            if (triageStatus === 'fund') {
                statusClass = 'funded';
                clickable = false; // Funded projects are locked
            } else if (triageStatus === 'stop') {
                statusClass = 'stopped';
                clickable = false; // Stopped projects are locked
            } else {
                // Marginal - can toggle
                if (isSelected) {
                    statusClass = 'marginal-in';
                } else if (canAfford) {
                    statusClass = 'marginal-out';
                } else {
                    statusClass = 'unaffordable';
                    clickable = false;
                }
            }
            
            const avgScore = project.overallAvg ? project.overallAvg.toFixed(1) : '?';
            
            return `
                <div class="project-bubble ${statusClass}" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px;"
                     onclick="${clickable ? `togglePortfolioProject('${project.id}')` : ''}"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M • Score: ${avgScore}</div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.8;">
                            ${triageStatus === 'fund' ? '✅ Funded (locked)' : 
                              triageStatus === 'stop' ? '🚫 Stopped' : 
                              isSelected ? '⚖️ Marginal (in portfolio)' : '⚖️ Marginal (available)'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = quadrantsHtml + axesHtml + bubblesHtml;
    }
    
    function renderPortfolioListView() {
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        const funded = projects.filter(p => gameState.projectTriage[p.id] === 'fund');
        const marginal = projects.filter(p => gameState.projectTriage[p.id] === 'marginal' || !gameState.projectTriage[p.id]);
        const stopped = projects.filter(p => gameState.projectTriage[p.id] === 'stop');
        
        // Render funded list
        document.getElementById('portfolio-funded-list').innerHTML = funded.length === 0 
            ? '<div style="color: var(--gray-400); font-style: italic; padding: 10px;">No projects marked as funded</div>'
            : funded.map((project, i) => renderListItem(project, i, 'fund')).join('');
        
        // Render marginal list
        document.getElementById('portfolio-marginal-list').innerHTML = marginal.length === 0
            ? '<div style="color: var(--gray-400); font-style: italic; padding: 10px;">No marginal projects</div>'
            : marginal.map((project, i) => renderListItem(project, i, 'marginal')).join('');
        
        // Render stopped list
        document.getElementById('portfolio-stopped-list').innerHTML = stopped.length === 0
            ? '<div style="color: var(--gray-400); font-style: italic; padding: 10px;">No projects stopped</div>'
            : stopped.map((project, i) => renderListItem(project, i, 'stop')).join('');
    }
    
    function renderListItem(project, index, triageStatus) {
        const isSelected = gameState.selectedProjects.includes(project.id);
        const canAfford = project.budget <= gameState.budget;
        const rank = gameState.rankedProjects ? gameState.rankedProjects.findIndex(p => p.id === project.id) + 1 : index + 1;
        const avgScore = project.overallAvg ? project.overallAvg.toFixed(1) : '?';
        const yourScore = project.playerAvg ? project.playerAvg.toFixed(1) : '?';
        
        const isMarginal = triageStatus === 'marginal';
        const showToggle = isMarginal && (isSelected || canAfford);
        
        // Lead info
        const leadHtml = project.lead ? `
            <div class="item-lead" onclick="event.stopPropagation(); openLeadModal('${project.lead.id}')" title="Click to view CV">
                <span class="item-lead-avatar" style="background: ${project.lead.avatarColor}20; color: ${project.lead.avatarColor};">${project.lead.initials}</span>
                <span class="item-lead-name">${project.lead.name.split(' ')[0]}</span>
                <span class="item-lead-score ${getLeadTrackScore(project.lead) >= 0.7 ? 'success' : getLeadTrackScore(project.lead) >= 0.5 ? 'warning' : 'danger'}">${Math.round(getLeadTrackScore(project.lead) * 100)}%</span>
            </div>
        ` : '';
        
        return `
            <div class="portfolio-list-item ${isSelected ? 'in-portfolio' : ''}" data-project-id="${project.id}">
                <div class="item-rank">#${rank}</div>
                <div class="item-info">
                    <div class="item-name">${project.name}</div>
                    <div class="item-scores">Avg: ${avgScore} • You: ${yourScore}</div>
                </div>
                ${leadHtml}
                <div class="item-budget">$${project.budget}M </div>
                ${showToggle ? `
                    <button class="item-toggle ${isSelected ? 'remove' : 'add'}" 
                            onclick="togglePortfolioProject('${project.id}')">
                        ${isSelected ? '− Remove' : '+ Add'}
                    </button>
                ` : ''}
                <button class="item-details" onclick="openProjectModal('${project.id}')">
                    Details
                </button>
            </div>
        `;
    }
    
    function togglePortfolioProject(projectId) {
        const project = gameState.projectPool.find(p => p.id === projectId);
        if (!project) return;
        
        // Only allow toggling marginal projects
        const triageStatus = gameState.projectTriage[projectId];
        if (triageStatus === 'fund' || triageStatus === 'stop') {
            return; // Locked
        }
        
        const index = gameState.selectedProjects.indexOf(projectId);
        
        if (index > -1) {
            // Remove from portfolio
            gameState.selectedProjects.splice(index, 1);
            gameState.budget += project.budget;
        } else {
            // Check if can afford
            if (project.budget > gameState.budget) {
                // Show feedback that can't afford
                return;
            }
            // Add to portfolio
            gameState.selectedProjects.push(projectId);
            gameState.budget -= project.budget;
        }
        
        renderMatrix();
        renderPortfolioListView();
        updatePortfolioSidebar();
    }
    
    function updatePortfolioSidebar() {
        // Calculate budget breakdown
        const legacyCommitted = gameState.legacyBudgetCommitted || 0;
        const availableForNew = gameState.maxBudget - legacyCommitted;
        
        // Calculate spending on new projects only
        const newProjectSpending = gameState.selectedProjects.reduce((sum, projectId) => {
            const project = (gameState.rankedProjects || gameState.projectPool).find(p => p.id === projectId);
            return sum + (project?.budget || 0);
        }, 0);
        
        const remainingBudget = availableForNew - newProjectSpending;
        const percentageUsed = availableForNew > 0 ? (newProjectSpending / availableForNew) * 100 : 0;
        
        // Update budget breakdown display
        const breakdownEl = document.getElementById('budget-breakdown');
        if (breakdownEl) {
            let breakdownHtml = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Annual Budget:</span>
                    <strong>$${gameState.maxBudget.toFixed(1)}M </strong>
                </div>`;
            
            if (legacyCommitted > 0) {
                breakdownHtml += `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--warning);">
                    <span>Legacy Commitments:</span>
                    <strong>-$${legacyCommitted.toFixed(1)}M </strong>
                </div>`;
            }
            
            breakdownHtml += `
                <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid var(--gray-200); color: var(--primary); font-weight: 600;">
                    <span>Available for New:</span>
                    <span>$${availableForNew.toFixed(1)}M </span>
                </div>`;
            
            breakdownEl.innerHTML = breakdownHtml;
        }
        
        // Update budget meter (shows new project spending as % of available)
        document.getElementById('portfolio-budget-fill').style.width = `${Math.min(100, percentageUsed)}%`;
        document.getElementById('portfolio-budget-spent').textContent = `$${newProjectSpending.toFixed(1)}M spent`;
        document.getElementById('portfolio-budget-total').textContent = `/ $${availableForNew.toFixed(1)}M available`;
        document.getElementById('portfolio-project-count').textContent = gameState.selectedProjects.length;
        
        // Warn if over budget
        const fillEl = document.getElementById('portfolio-budget-fill');
        if (newProjectSpending > availableForNew) {
            fillEl.style.background = 'var(--danger)';
        } else if (percentageUsed > 90) {
            fillEl.style.background = 'var(--warning)';
        } else {
            fillEl.style.background = 'linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%)';
        }
        
        // Update strategic buckets
        const bucketCounts = {};
        const allBuckets = [
            { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' },
            { id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' },
            { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' },
            { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
        ];
        
        allBuckets.forEach(b => bucketCounts[b.id] = 0);
        
        gameState.selectedProjects.forEach(projectId => {
            const project = gameState.projectPool.find(p => p.id === projectId);
            if (project?.strategicBuckets) {
                project.strategicBuckets.forEach(bucket => {
                    // Match to our buckets by id
                    if (bucket.id && bucketCounts.hasOwnProperty(bucket.id)) {
                        bucketCounts[bucket.id]++;
                    }
                });
            }
        });
        
        const bucketsHtml = allBuckets.map(bucket => `
            <div class="portfolio-bucket-item">
                <span class="bucket-icon">${bucket.icon}</span>
                <span class="bucket-name">${bucket.name}</span>
                <span class="bucket-count ${bucketCounts[bucket.id] > 0 ? 'filled' : ''}">${bucketCounts[bucket.id]}</span>
            </div>
        `).join('');
        
        document.getElementById('portfolio-buckets-summary').innerHTML = bucketsHtml;
        
        // Render project scores list
        renderPortfolioScoresList();
        
        // Enable/disable confirm button - must have projects AND not be over budget
        const isOverBudget = newProjectSpending > availableForNew;
        document.getElementById('confirm-portfolio-btn').disabled = gameState.selectedProjects.length === 0 || isOverBudget;
        
        // Update button text if over budget
        const confirmBtn = document.getElementById('confirm-portfolio-btn');
        if (isOverBudget) {
            confirmBtn.textContent = '⚠️ Over Budget - Remove Projects';
        } else {
            confirmBtn.textContent = 'Confirm Portfolio →';
        }
        
        // Check if we should show the extra budget request option
        updateExtraBudgetPrompt(remainingBudget, availableForNew);
    }
    
    // ============================================
    // EXTRA BUDGET REQUEST FEATURE
    // ============================================
    
    function updateExtraBudgetPrompt(remainingBudget, availableForNew) {
        const promptEl = document.getElementById('extra-budget-prompt');
        const grantedEl = document.getElementById('extra-budget-granted');
        
        if (!promptEl || !grantedEl) return;
        
        // If already requested, show granted message instead
        if (gameState.extraBudgetRequested) {
            promptEl.classList.add('hidden');
            grantedEl.classList.remove('hidden');
            return;
        }
        
        // Hide granted message
        grantedEl.classList.add('hidden');
        
        // Check if there are unselected projects the player could afford with $5M more
        const projects = gameState.rankedProjects || gameState.projectPool;
        const unselectedProjects = projects.filter(p => !gameState.selectedProjects.includes(p.id));
        
        // Find the cheapest unselected project that's currently unaffordable but would be with extra budget
        const potentialWithExtra = unselectedProjects.filter(p => 
            p.budget > remainingBudget && p.budget <= (remainingBudget + 5)
        );
        
        // Also show if remaining budget is low (< $3M) and there are projects between $3-8M
        const wouldHelpWithMarginal = remainingBudget < 3 && unselectedProjects.some(p => 
            p.budget > remainingBudget && p.budget <= 8
        );
        
        // Show prompt if extra budget would enable at least one more project
        if (potentialWithExtra.length > 0 || wouldHelpWithMarginal) {
            promptEl.classList.remove('hidden');
        } else {
            promptEl.classList.add('hidden');
        }
    }
    
    function openExtraBudgetModal() {
        SoundManager.play('notification');
        document.getElementById('extra-budget-modal').classList.add('visible');
    }
    
    function closeExtraBudgetModal() {
        const modal = document.getElementById('extra-budget-modal');
        if (!modal) return;

        modal.classList.remove('visible');

        // Safety net: if the modal fades out via CSS transition, the scroll-lock
        // might stay engaged unless we re-check after the animation completes.
        try {
            setTimeout(() => MobileScrollLock.checkModals(), 350);
        } catch (e) {}
    }
    
    function acceptExtraBudget() {
        // Grant the extra budget with higher performance expectations
        const extraAmount = 5;
        
        gameState.extraBudgetRequested = true;
        gameState.extraBudgetPerformanceBar = true; // CEO expects stronger results
        gameState.maxBudget += extraAmount;
        gameState.budget += extraAmount;
        
        // Play success sound
        SoundManager.play('levelup');
        
        // Close modal
        closeExtraBudgetModal();
        
        // Update the portfolio builder displays (this is where extra budget is requested)
        updatePortfolioSidebar();
        
        // Re-render the matrix and list views to update affordability
        if (typeof renderMatrix === 'function') {
            renderMatrix();
        }
        if (typeof renderPortfolioListView === 'function') {
            renderPortfolioListView();
        }
        
        // Show toast notification
        showToast('💬 Meera: "I\'ve got your back. Now show me what this portfolio can do."', 'success');
    }
    
    // ============================================
    // BOOTLEG PROJECT FEATURE
    // ============================================
    // When players kill projects, they free up resources. Staff members may approach
    // with "skunkworks" projects they've been developing informally.
    
    const bootlegProjectTemplates = [
        {
            pitcher: { name: 'Ravi', role: 'Senior Engineer', avatar: '👨‍💻' },
            pitch: "I've been tinkering with something on weekends. You know how our cameras struggle in monsoon conditions? I've built a prototype that uses acoustic sensors alongside video — it can detect intrusions even when visibility is zero. It's rough, but it works.",
            project: {
                name: 'AcoustiGuard Prototype',
                desc: 'Hybrid acoustic-visual intrusion detection. Uses microphone arrays to detect footsteps, glass breaks, and vehicle sounds when cameras are blinded by rain, fog, or darkness. Low-cost retrofit for existing installations.',
                budget: 2.5,
                timeline: 5,
                archetype: 'hidden_gem',
                successProb: 0.55,
                riskClass: 'moderate'
            }
        },
        {
            pitcher: { name: 'Priya', role: 'Data Scientist', avatar: '👩‍🔬' },
            pitch: "Remember all those false alarms from the motion sensors? I've trained a model on our historical data that can distinguish between real threats and, well, monkeys and birds. It runs on-device — no cloud needed. I've been testing it at my apartment complex.",
            project: {
                name: 'Smart Filter AI',
                desc: 'Edge-deployed false alarm reduction using lightweight ML. Trained on 50,000 labeled events from ShieldTech installations. Reduces false positives by 70% while maintaining detection sensitivity.',
                budget: 1.8,
                timeline: 4,
                archetype: 'conventional_winner',
                successProb: 0.70,
                riskClass: 'incremental'
            }
        },
        {
            pitcher: { name: 'Amit', role: 'Field Engineer', avatar: '🧑‍🔧' },
            pitch: "Our enterprise customers keep asking for the same thing — they want to see all their sites on one screen. I built a dashboard over the holidays that pulls feeds from any ShieldTech camera, any location. It's not pretty yet, but the pilot customer loves it.",
            project: {
                name: 'MultiSite Command',
                desc: 'Unified dashboard for multi-location security management. Aggregates feeds, alerts, and analytics across unlimited sites. Built on web standards, works on any device. Subscription revenue model.',
                budget: 2.2,
                timeline: 4,
                archetype: 'conventional_winner',
                successProb: 0.65,
                riskClass: 'incremental'
            }
        },
        {
            pitcher: { name: 'Deepa', role: 'UX Designer', avatar: '👩‍🎨' },
            pitch: "I've been volunteering at an elderly care home, and I noticed something. They don't need security — they need peace of mind. I designed an app for families to check on elderly parents. Non-intrusive, privacy-first. Uses our existing sensors but completely reframes the value proposition.",
            project: {
                name: 'FamilyWatch',
                desc: 'Wellness monitoring for elderly living alone. Activity patterns, medication reminders, emergency alerts — all through existing ShieldTech sensors. New market segment with recurring revenue potential.',
                budget: 3.0,
                timeline: 6,
                archetype: 'hidden_gem',
                successProb: 0.50,
                riskClass: 'moderate'
            }
        },
        {
            pitcher: { name: 'Vikram', role: 'Hardware Lead', avatar: '👨‍🔬' },
            pitch: "You know those expensive PTZ cameras we sell? I've figured out how to get 80% of the functionality using software pan-tilt-zoom on a wide-angle fixed camera. The image quality is almost as good, but the BOM cost is one-third. Could be a game-changer for price-sensitive segments.",
            project: {
                name: 'SoftPTZ Camera',
                desc: 'Software-defined pan-tilt-zoom using high-resolution fixed cameras and digital cropping. Dramatic cost reduction with minimal quality trade-off. Targets Tier 2/3 city market.',
                budget: 2.0,
                timeline: 5,
                archetype: 'value_segment',
                successProb: 0.60,
                riskClass: 'incremental'
            }
        },
        {
            pitcher: { name: 'Sunita', role: 'Product Manager', avatar: '👩‍💼' },
            pitch: "I keep hearing from installers that our onboarding is too complicated. So I built a prototype — you just scan a QR code and the camera configures itself. It finds the WiFi, registers with our cloud, everything. Installation time drops from 45 minutes to 5.",
            project: {
                name: 'ZeroTouch Setup',
                desc: 'QR-based automatic camera provisioning and configuration. Eliminates technical installation barriers. Enables DIY market and reduces installer dependency. Patent-pending approach.',
                budget: 1.5,
                timeline: 4,
                archetype: 'conventional_winner',
                successProb: 0.72,
                riskClass: 'incremental'
            }
        }
    ];
    
    let currentBootlegProject = null;
    
    function checkForBootlegOpportunity() {
        // Don't offer during Year 2 transition or if already offered
        if (gameState.currentQuarter === 4 || gameState.currentQuarter === 5) return null;
        if (gameState.bootlegOffered) return null;
        
        // Check conditions:
        // 1. Player has killed at least 2 projects
        // 2. Player has significant unused budget capacity (estimated from active project spending)
        const totalKills = gameState.killedProjects?.length || 0;
        if (totalKills < 2) return null;
        
        // Estimate available capacity
        const activeSpending = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        const estimatedCapacity = gameState.maxBudget - activeSpending;
        if (estimatedCapacity < 4) return null;  // Need at least $4M idle capacity
        
        // Random chance (60%) to actually trigger when conditions are met
        if (Math.random() > 0.6) return null;
        
        // Pick a random bootleg project
        const available = bootlegProjectTemplates.filter(b => 
            !gameState.activeProjects.some(p => p.name === b.project.name)
        );
        
        if (available.length === 0) return null;
        
        return available[Math.floor(Math.random() * available.length)];
    }
    
    function showBootlegOpportunity(bootleg) {
        currentBootlegProject = bootleg;
        gameState.bootlegOffered = true;
        
        // Populate pitcher info
        document.getElementById('bootleg-pitch').innerHTML = `
            <div class="bootleg-pitcher">
                <div class="bootleg-pitcher-avatar">${bootleg.pitcher.avatar}</div>
                <div class="bootleg-pitcher-name">${bootleg.pitcher.name}</div>
                <div class="bootleg-pitcher-role">${bootleg.pitcher.role}</div>
            </div>
            <div class="bootleg-speech">
                <p>"${bootleg.pitch}"</p>
            </div>
        `;
        
        // Populate project card
        const proj = bootleg.project;
        document.getElementById('bootleg-project-card').innerHTML = `
            <div class="bootleg-project-header">
                <div class="bootleg-project-name">${proj.name}</div>
                <div class="bootleg-project-budget">$${proj.budget}M</div>
            </div>
            <div class="bootleg-project-desc">${proj.desc}</div>
            <div class="bootleg-project-stats">
                <div class="bootleg-stat">
                    <span class="bootleg-stat-icon">⏱️</span>
                    <span>${proj.timeline} quarters</span>
                </div>
                <div class="bootleg-stat">
                    <span class="bootleg-stat-icon">📊</span>
                    <span>${proj.riskClass} risk</span>
                </div>
                <div class="bootleg-stat">
                    <span class="bootleg-stat-icon">🎯</span>
                    <span>Grassroots innovation</span>
                </div>
            </div>
        `;
        
        // Show modal
        SoundManager.play('notification');
        document.getElementById('bootleg-modal').classList.add('visible');
    }
    
    function acceptBootlegProject() {
        if (!currentBootlegProject) return;
        
        const template = currentBootlegProject.project;
        const pitcherInitials = currentBootlegProject.pitcher.name.split(' ').map(n => n[0]).join('');
        
        // Create full project object with all required fields
        const project = {
            id: 'bootleg-' + Date.now(),
            numId: 900 + Math.floor(Math.random() * 100),
            name: template.name,
            desc: template.desc,
            shortDesc: template.desc,
            fullDesc: template.desc,
            tagline: 'Grassroots innovation from the team',
            archetype: template.archetype,
            riskClass: template.riskClass,
            budget: template.budget,
            timeline: template.timeline,
            successProb: template.successProb,
            baseSuccessRate: Math.round(template.successProb * 100),
            roiMultiplier: template.riskClass === 'incremental' ? 2.0 : 3.0,
            status: 'active',
            isBootleg: true,
            currentQuarter: 0,
            spentBudget: 0,
            quarterlyUpdates: [],
            decision: 'continue',
            scores: { technical: 3, marketsize: 3, strategic: 3, team: 4, capability: 4, ip: 2, platform: 2, sustainability: 3, newmarket: 3, geographic: 3, competitive: 3, devcost: 3, roi: 3, speed: 3, risk: 3 },
            strategicBuckets: [],
            quarterNarratives: {
                good: ['Team enthusiasm driving progress.', 'Prototype exceeding expectations.', 'Early user feedback positive.'],
                bad: ['Formalizing the approach taking time.', 'Some technical debt to address.', 'Scaling challenges emerging.']
            },
            outcomeNarrative: {
                success: 'The grassroots project proved the value of bottom-up innovation. The team delivered a winner that formal processes might have overlooked.',
                failure: 'Despite passion and effort, the bootleg project couldn\'t overcome its informal origins. Still, the team learned valuable lessons.'
            },
            lead: {
                name: currentBootlegProject.pitcher.name,
                initials: pitcherInitials,
                role: currentBootlegProject.pitcher.role,
                avatarColor: '#7c3aed',
                strength: 'Passionate founder with deep domain knowledge',
                trackRecord: null
            }
        };
        
        // Ensure all fields are populated before adding
        ensureProjectCompleteness(project);
        
        // Add to active projects
        gameState.activeProjects.push(project);
        gameState.bootlegAccepted = true;
        
        // Play success sound
        SoundManager.play('levelup');
        
        // Close modal
        document.getElementById('bootleg-modal').classList.remove('visible');
        
        // Show confirmation toast
        showToast(`🔧 ${template.name} added to portfolio! ${currentBootlegProject.pitcher.name} is thrilled.`, 'success');
        
        currentBootlegProject = null;
        
        // Continue to quarterly review
        if (gameState.pendingBootlegCallback) {
            gameState.pendingBootlegCallback();
            gameState.pendingBootlegCallback = null;
        }
    }
    
    function declineBootlegProject() {
        document.getElementById('bootleg-modal').classList.remove('visible');
        showToast(`Maybe next time. ${currentBootlegProject?.pitcher.name || 'The team'} will keep iterating.`, 'info');
        currentBootlegProject = null;
        
        // Continue to quarterly review
        if (gameState.pendingBootlegCallback) {
            gameState.pendingBootlegCallback();
            gameState.pendingBootlegCallback = null;
        }
    }
    
    function renderPortfolioScoresList() {
        const projects = gameState.rankedProjects || gameState.projectPool;
        const container = document.getElementById('portfolio-scores-list');
        if (!container) return;
        
        container.innerHTML = projects.map((project, index) => {
            const triageStatus = gameState.projectTriage[project.id] || 'marginal';
            const isSelected = gameState.selectedProjects.includes(project.id);
            const isFunded = triageStatus === 'fund';
            const isStopped = triageStatus === 'stop';
            
            const avgScore = project.overallAvg ? project.overallAvg.toFixed(1) : '?';
            const yourScore = project.playerAvg ? project.playerAvg.toFixed(1) : '?';
            
            let statusIcon = '';
            if (isFunded) statusIcon = '✅';
            else if (isStopped) statusIcon = '🚫';
            else if (isSelected) statusIcon = '⚖️';
            
            let rowClass = 'score-row';
            if (isFunded) rowClass += ' is-funded';
            else if (isStopped) rowClass += ' is-stopped';
            else if (isSelected) rowClass += ' in-portfolio';
            
            return `
                <div class="${rowClass}" onclick="openProjectModal('${project.id}')" data-project-id="${project.id}">
                    <div class="score-row-rank">${index + 1}</div>
                    <div class="score-row-info">
                        <div class="score-row-name">${project.name}</div>
                        <div class="score-row-meta">$${project.budget}M </div>
                    </div>
                    <div class="score-row-scores">
                        <span class="score-badge avg">${avgScore}</span>
                        <span class="score-badge you">${yourScore}</span>
                    </div>
                    <div class="score-row-status">${statusIcon}</div>
                </div>
            `;
        }).join('');
    }
    
    function confirmPortfolio() {
        // Start quarterly reviews with selected portfolio
        if (gameState.selectedProjects.length === 0) {
            SoundManager.play('error');
            alert('Please select at least one project for your portfolio.');
            return;
        }
        // Lock the Year 1 selection to prevent budget manipulation
        gameState.year1SelectionLocked = true;
        SoundManager.play('levelup');
        startQuarterlyReviews();
    }
    
    function renderProjectGrid() {
        const grid = document.getElementById('project-grid');
        
        // Use ranked projects if available, otherwise use projectPool
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        grid.innerHTML = projects.map((project, index) => {
            const isSelected = gameState.selectedProjects.includes(project.id);
            const canAfford = project.budget <= gameState.budget;
            const isLocked = !isSelected && !canAfford;
            const rank = gameState.rankedProjects ? index + 1 : null;
            
            const bucketsHtml = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}20; color: ${bucket.color}; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
            
            return `
                <div class="project-card ${isSelected ? 'selected' : ''} ${isLocked ? 'locked' : ''}" data-id="${project.id}">
                    ${rank ? `<div style="position: absolute; top: -10px; left: -10px; background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85em;">#${rank}</div>` : ''}
                    <div class="project-header" style="margin-left: ${rank ? '20px' : '0'};">
                        <span class="project-name">${project.name}</span>
                        <span class="project-budget">$${project.budget}M </span>
                    </div>
                    <div class="project-tagline">${project.tagline || ''}</div>
                    ${renderInnovationBadges(project, true)}
                    <div style="margin: 8px 0;">${bucketsHtml}</div>
                    ${project.overallAvg ? `
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; font-size: 0.85em;">
                            <span style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">
                                Avg: <strong>${project.overallAvg.toFixed(1)}</strong>
                            </span>
                            <span style="background: var(--primary-lighter); padding: 4px 8px; border-radius: 4px;">
                                You: <strong>${project.playerAvg.toFixed(1)}</strong>
                            </span>
                            ${!project.highConsensus ? '<span style="color: var(--warning);">⚠️ Views differ</span>' : ''}
                        </div>
                    ` : ''}
                    <div class="project-desc">${project.shortDesc || project.desc}</div>
                    <div class="project-card-actions">
                        <button class="project-learn-more" onclick="openProjectModal('${project.id}')">Learn More</button>
                        <button class="project-select-btn ${isSelected ? 'selected' : ''}" 
                                onclick="toggleProject('${project.id}')" 
                                ${isLocked ? 'disabled' : ''}>
                            ${isSelected ? '✓ Selected' : isLocked ? 'Over Budget' : 'Select'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        updateBudgetDisplay();
        updateStrategicBalance();
    }
    
    function updateStrategicBalance() {
        const balanceDiv = document.getElementById('strategic-balance');
        if (!balanceDiv) return;
        
        const projects = gameState.rankedProjects || gameState.projectPool;
        const selectedProjects = projects.filter(p => gameState.selectedProjects.includes(p.id));
        
        // Count projects per bucket
        const bucketCounts = {};
        Object.values(strategicBuckets).forEach(bucket => {
            bucketCounts[bucket.id] = 0;
        });
        
        selectedProjects.forEach(project => {
            (project.strategicBuckets || []).forEach(bucket => {
                bucketCounts[bucket.id]++;
            });
        });
        
        // Render balance display
        balanceDiv.innerHTML = '<div style="width: 100%; margin-bottom: 8px; font-weight: 600; color: var(--gray-600);">Strategic Balance:</div>' +
            Object.values(strategicBuckets).map(bucket => {
                const count = bucketCounts[bucket.id];
                const hasProjects = count > 0;
                return `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; 
                                background: ${hasProjects ? bucket.color + '20' : 'var(--gray-100)'}; 
                                color: ${hasProjects ? bucket.color : 'var(--gray-400)'}; 
                                border: 1px solid ${hasProjects ? bucket.color + '40' : 'var(--gray-200)'};">
                        <span>${bucket.icon}</span>
                        <span style="font-size: 0.85em;">${bucket.name}</span>
                        <span style="font-weight: 700; margin-left: 4px;">${count}</span>
                    </div>
                `;
            }).join('');
    }
    
    function openProjectModal(projectId, context = 'year1') {
        // Find project in Year 1 pools, Year 2 pools, or active projects
        const year1Projects = gameState.rankedProjects || gameState.projectPool || [];
        const year2Projects = year2RankedProjects || [];
        const activeProjects = gameState.activeProjects || [];
        
        let project = year1Projects.find(p => p.id === projectId);
        if (!project) project = year2Projects.find(p => p.id === projectId);
        if (!project) project = activeProjects.find(p => p.id === projectId);
        if (!project) return;
        
        gameState.currentModalProject = projectId;
        gameState.currentModalContext = context; // 'year1', 'year2', or 'ongoing'
        
        document.getElementById('project-modal-name').textContent = project.name;
        document.getElementById('project-modal-tagline').textContent = project.tagline || '';
        document.getElementById('project-modal-budget').textContent = `$${project.budget}M`;
        document.getElementById('project-modal-desc').textContent = project.fullDesc || project.desc;
        const cuesEl = document.getElementById('project-modal-cues');
        if (cuesEl) cuesEl.innerHTML = renderInnovationDetail(project);
        document.getElementById('project-modal-market').textContent = project.marketContext || 'Market analysis pending.';
        document.getElementById('project-modal-capability').textContent = project.capabilityFit || 'Capability assessment pending.';
        
        // Render Development Costs
        const devCosts = project.developmentCosts || {};
        document.getElementById('project-modal-dev-costs').innerHTML = `
            <div class="dev-costs-grid">
                <div class="dev-cost-item total">
                    <div class="dev-cost-amount">$${devCosts.total || project.budget}M </div>
                    <div class="dev-cost-label">Total Budget</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.personnel?.amount || '?'}M </div>
                    <div class="dev-cost-label">Personnel</div>
                    <div class="dev-cost-pct">${devCosts.personnel?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.hardware?.amount || '?'}M </div>
                    <div class="dev-cost-label">Hardware/Components</div>
                    <div class="dev-cost-pct">${devCosts.hardware?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.software?.amount || '?'}M </div>
                    <div class="dev-cost-label">Software/Tools</div>
                    <div class="dev-cost-pct">${devCosts.software?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.external?.amount || '?'}M </div>
                    <div class="dev-cost-label">External/Legal</div>
                    <div class="dev-cost-pct">${devCosts.external?.pct || '?'}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.contingency?.amount || '?'}M </div>
                    <div class="dev-cost-label">Contingency</div>
                    <div class="dev-cost-pct">${devCosts.contingency?.pct || '?'}%</div>
                </div>
            </div>
        `;
        
        // Render Milestones
        const milestonesData = project.milestones || { totalDuration: '12 months', milestones: [] };
        const milestonesList = milestonesData.milestones || [];
        document.getElementById('project-modal-milestones').innerHTML = `
            <div class="milestones-header">
                <span class="total-duration">📅 Total Duration: <strong>${milestonesData.totalDuration}</strong></span>
            </div>
            <div class="milestones-summary">
                ${milestonesList.map((m, i) => `
                    <div class="milestone-summary-item">
                        <div class="milestone-summary-phase">${m.quarters}</div>
                        <div class="milestone-summary-duration">${m.phase.split(': ')[1] || m.phase}</div>
                        <div class="milestone-summary-cost">$${m.costAmount}M </div>
                    </div>
                `).join('')}
            </div>
            <div class="milestones-timeline">
                ${milestonesList.map(m => `
                    <div class="milestone-item">
                        <div class="milestone-header">
                            <div class="milestone-phase">${m.phase}</div>
                            <div class="milestone-meta">
                                <span>📆 ${m.quarters}</span>
                                <span>⏱️ ${m.duration}</span>
                                <span>💰 $${m.costAmount}M </span>
                            </div>
                        </div>
                        <div class="milestone-deliverables">
                            <div class="milestone-deliverables-title">Key Deliverables</div>
                            ${(m.deliverables || []).map(d => `<span class="deliverable-tag">${d}</span>`).join('') || '<span class="deliverable-tag">TBD</span>'}
                        </div>
                        <details class="milestone-metrics-details">
                            <summary>Success Metrics & Gate</summary>
                            <div class="milestone-metrics">
                                ${(m.metrics || []).map(metric => `
                                    <div class="metric-row">
                                        <span class="metric-name">${metric.name}</span>
                                        <span class="metric-target">${metric.target}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="milestone-gate">${m.gate || 'Gate criteria TBD'}</div>
                        </details>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Render TRL
        const trl = project.trl || { current: 5, target: 8, note: '' };
        document.getElementById('project-modal-trl').innerHTML = `
            <div class="trl-display">
                <div class="trl-bar">
                    ${[1,2,3,4,5,6,7,8,9].map(level => `
                        <div class="trl-level ${level <= trl.current ? 'current' : ''} ${level <= trl.target ? 'target' : ''}" title="TRL ${level}">
                            ${level}
                        </div>
                    `).join('')}
                </div>
                <div class="trl-legend">
                    <span><span class="trl-dot current"></span> Current: TRL ${trl.current}</span>
                    <span><span class="trl-dot target"></span> Target: TRL ${trl.target}</span>
                </div>
                <p style="margin-top: 10px; font-size: 0.9em;">${trl.note}</p>
            </div>
        `;
        
        // Render IP Position
        const ip = project.ipPosition || {};
        const ipRiskClass = ip.risk === 'High' ? 'high-risk' : (ip.risk === 'Medium' || ip.risk === 'Medium-High') ? 'medium-risk' : 'low-risk';
        document.getElementById('project-modal-ip').innerHTML = `
            <div class="ip-grid">
                <div class="ip-box">
                    <div class="ip-box-header">🛡️ ShieldTech IP</div>
                    <p>${ip.shieldtech || 'Assessment pending.'}</p>
                </div>
                <div class="ip-box">
                    <div class="ip-box-header">🏢 Competitor IP</div>
                    <p>${ip.competitors || 'Assessment pending.'}</p>
                </div>
            </div>
            <div class="fto-assessment ${ipRiskClass}">
                <strong>Freedom to Operate:</strong> ${ip.fto || 'FTO review needed.'}
                <span class="fto-risk-badge">${ip.risk || 'Unknown'} Risk</span>
            </div>
        `;
        
        // Render Competitors
        const comps = project.competitors || [];
        document.getElementById('project-modal-competitors').innerHTML = comps.length > 0 ? `
            <div class="competitors-grid">
                ${comps.map(comp => `
                    <div class="competitor-card threat-${(comp.threat || 'unknown').toLowerCase().replace(' ', '-')}">
                        <div class="competitor-name">${comp.name}</div>
                        <div class="competitor-position">${comp.position}</div>
                        <div class="competitor-threat">Threat: <strong>${comp.threat}</strong></div>
                    </div>
                `).join('')}
            </div>
        ` : '<p>Competitor analysis pending.</p>';
        
        // Render strategic buckets
        const bucketsHtml = (project.strategicBuckets || []).map(bucket => `
            <span class="strategic-bucket" style="background: ${bucket.color}20; color: ${bucket.color}; border: 1px solid ${bucket.color}40;">
                ${bucket.icon} ${bucket.name}
            </span>
        `).join('');
        document.getElementById('project-modal-buckets').innerHTML = bucketsHtml;
        
        // Render detailed team information (respects blinding setting)
        const teamDetails = project.teamDetails;
        if (shouldShowTeamInfo()) {
            // Show team info normally - simplified to Project Lead and team size only
            let teamHtml = '';
            
            // Project Lead - primary responsibility
            if (project.lead) {
                teamHtml += '<div style="margin-bottom: 20px;">';
                teamHtml += '<div style="margin-bottom: 10px;"><strong>🎯 Project Lead:</strong></div>';
                teamHtml += renderLeadCard(project.lead);
                teamHtml += '</div>';
            }
            
            // Team size - simplified to just total FTE
            if (teamDetails && teamDetails.headcount) {
                const hc = teamDetails.headcount;
                teamHtml += `<div style="background: var(--primary-lighter); padding: 15px; border-radius: 8px; text-align: center; max-width: 150px;">
                    <div style="font-size: 1.5em; font-weight: 700; color: var(--primary);">${hc.total}</div>
                    <div style="font-size: 0.85em; color: var(--gray-500);">Team Size (FTE)</div>
                </div>`;
            }
            
            document.getElementById('project-modal-team-details').innerHTML = teamHtml;
            // Show team note
            document.getElementById('project-modal-team').textContent = project.teamNote || 'Team assignment pending.';
        } else {
            // Blind mode - hide all team information
            document.getElementById('project-modal-team-details').innerHTML = `
                <div class="blinded-section">
                    <div class="blinded-icon">🎭</div>
                    <div class="blinded-text">
                        <strong>Team Information Hidden</strong>
                        <span>You've chosen Blind Review — team details are not visible to reduce bias.</span>
                    </div>
                </div>
            `;
            document.getElementById('project-modal-team').textContent = 'Team information hidden (Blind Review mode)';
        }
        
        // Financials
        const financials = project.financials || {};
        document.getElementById('project-modal-financials').innerHTML = `
            <div class="financial-item"><div class="value">${financials.devCost || '$' + project.budget + 'M'}</div><div class="label">Development Cost</div></div>
            <div class="financial-item"><div class="value">${financials.timeline || project.timeline + ' quarters'}</div><div class="label">Timeline</div></div>
            <div class="financial-item"><div class="value">${financials.projectedRevenue || 'TBD'}</div><div class="label">Projected Revenue</div></div>
            <div class="financial-item"><div class="value">${financials.grossMargin || 'TBD'}</div><div class="label">Gross Margin</div></div>
            <div class="financial-item"><div class="value">${financials.breakeven || 'TBD'}</div><div class="label">Breakeven</div></div>
        `;
        
        // Synergies
        const synergies = project.synergies || [];
        document.getElementById('project-modal-synergies').innerHTML = synergies.length > 0 
            ? synergies.map(s => `<span class="synergy-item">${s}</span>`).join('')
            : '<p style="color: var(--gray-500);">No identified synergies with other portfolio projects.</p>';
        
        // Button state - handle both Year 1 and Year 2
        const btn = document.getElementById('project-modal-btn');
        const triageActions = document.getElementById('modal-triage-actions');
        
        if (gameState.currentModalContext === 'year2') {
            // Year 2 portfolio builder
            const isSelected = year2SelectedProjects.includes(project.id);
            const isSkipped = year2ProjectTriage[project.id] === 'stop';
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            
            triageActions.classList.add('hidden');
            btn.classList.remove('hidden');
            btn.onclick = function() { toggleProjectFromModal(); };
            
            if (isSkipped) {
                btn.textContent = '🚫 Skipped by Committee';
                btn.className = 'add-to-committee-btn';
                btn.disabled = true;
                btn.style.background = 'var(--gray-300)';
            } else if (isSelected) {
                btn.textContent = 'Remove from Portfolio';
                btn.className = 'add-to-committee-btn remove';
                btn.disabled = false;
                btn.style.background = '';
            } else if (canAfford) {
                btn.textContent = 'Add to Portfolio';
                btn.className = 'add-to-committee-btn';
                btn.disabled = false;
                btn.style.background = '';
            } else {
                btn.textContent = 'Exceeds Remaining Budget';
                btn.className = 'add-to-committee-btn';
                btn.disabled = true;
                btn.style.background = 'var(--gray-300)';
            }
        } else if (gameState.currentModalContext === 'ongoing') {
            // Ongoing project - view only
            triageActions.classList.add('hidden');
            btn.classList.remove('hidden');
            btn.textContent = '📂 Ongoing Project';
            btn.className = 'add-to-committee-btn';
            btn.disabled = true;
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
        } else {
            // Year 1 logic
            const isSelected = gameState.selectedProjects.includes(project.id);
            const canAfford = project.budget <= gameState.budget;
            
            if (isSelected) {
                btn.textContent = 'Remove from Portfolio';
                btn.className = 'add-to-committee-btn remove';
                btn.disabled = false;
            } else if (canAfford) {
                btn.textContent = 'Add to Portfolio';
                btn.className = 'add-to-committee-btn';
                btn.disabled = false;
            } else {
                btn.textContent = 'Exceeds Remaining Budget';
                btn.className = 'add-to-committee-btn';
                btn.disabled = true;
                btn.style.background = 'var(--gray-300)';
            }
            
            // Show/hide triage buttons based on current phase
            if (gameState.phase === 'committee-feedback') {
                triageActions.classList.remove('hidden');
                btn.classList.add('hidden');
                
                const currentTriage = gameState.projectTriage[projectId] || 'marginal';
                ['fund', 'marginal', 'stop'].forEach(status => {
                    const triageBtn = document.getElementById('modal-' + status + '-btn');
                    if (triageBtn) {
                        if (currentTriage === status) {
                            triageBtn.classList.add('active');
                        } else {
                            triageBtn.classList.remove('active');
                        }
                    }
                });
            } else {
                triageActions.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }
        
        document.getElementById('project-modal').classList.remove('hidden');
    }
    
    function setTriageFromModal(status) {
        if (gameState.currentModalProject) {
            setTriage(gameState.currentModalProject, status);
            closeProjectModal();
        }
    }
    
    function closeProjectModal() {
        document.getElementById('project-modal').classList.add('hidden');
        // Reset button styles
        const btn = document.getElementById('project-modal-btn');
        if (btn) {
            btn.style.background = '';
            btn.style.color = '';
        }
        gameState.currentModalProject = null;
        gameState.currentModalContext = null;
    }
    
    function toggleProjectFromModal() {
        if (gameState.currentModalProject) {
            // Check if we're in Year 1 End selection context
            if (gameState.currentModalContext === 'year1end') {
                toggleYear1EndProject(gameState.currentModalProject);
                openYear1EndProjectModal(gameState.currentModalProject); // Refresh modal state
            } else if (gameState.currentModalContext === 'year2') {
                year2Toggle(gameState.currentModalProject);
                openProjectModal(gameState.currentModalProject, 'year2'); // Refresh modal state
            } else {
                // Default: original project selection
                const project = gameState.projectPool.find(p => p.id === gameState.currentModalProject);
                if (project) {
                    toggleProject(project.id);
                    openProjectModal(gameState.currentModalProject); // Refresh modal state
                }
            }
        }
    }
    
    function toggleProject(projectId) {
        // Find project in either rankedProjects or projectPool
        const projects = gameState.rankedProjects || gameState.projectPool;
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        const index = gameState.selectedProjects.indexOf(projectId);

        if (index > -1) {
            gameState.selectedProjects.splice(index, 1);
            gameState.budget += project.budget;
            SoundManager.play('deselect');
        } else if (project.budget <= gameState.budget) {
            gameState.selectedProjects.push(projectId);
            gameState.budget -= project.budget;
            SoundManager.play('coin');
        } else {
            SoundManager.play('error');
        }

        renderProjectGrid();
        if (y1SelectionView === 'matrix') {
            renderY1SelectionMatrix();
        }
    }
    
    function updateBudgetDisplay() {
        document.getElementById('budget-remaining').textContent = `$${gameState.budget.toFixed(1)}M`;
        document.getElementById('projects-selected').textContent = gameState.selectedProjects.length;
        document.getElementById('start-reviews-btn').disabled = gameState.selectedProjects.length === 0;
    }
    
    function startQuarterlyReviews() {
        // Use rankedProjects if available, otherwise projectPool
        const projects = gameState.rankedProjects || gameState.projectPool;
        
        // Add new selected projects
        const newActiveProjects = gameState.selectedProjects.map(id => {
            const project = projects.find(p => p.id === id);
            const active = { ...project, status: 'active', currentQuarter: 0, spentBudget: 0, quarterlyUpdates: [], decision: 'continue', isLegacy: false };
            return ensureProjectCompleteness(active);
        });
        
        // Add active legacy projects (continue, accelerate, reduce_scope)
        const legacyNarratives = {
            good: [
                'Team making solid progress on deliverables.',
                'Key milestone achieved ahead of schedule.',
                'Integration testing going smoothly.',
                'Stakeholder feedback positive.',
                'Technical challenges resolved efficiently.'
            ],
            bad: [
                'Unexpected technical debt slowing progress.',
                'Key team member out sick, causing delays.',
                'Scope creep emerging from stakeholder requests.',
                'Integration issues with legacy systems.',
                'Quality issues requiring rework.'
            ]
        };
        
        const activeLegacy = (gameState.activeLegacyProjects || []).map(p => {
                        // Calculate success probability based on decision
            let successProb = 0.65;
            if (p.decision === 'accelerate') successProb = 0.55; // Higher risk
            if (p.decision === 'reduce_scope') successProb = 0.75; // Lower risk
            if (p.status === 'green') successProb += 0.1;
            if (p.status === 'red') successProb -= 0.15;
            
            const active = {
                ...p,
                status: 'active',
                currentQuarter: p.quarterlyUpdates?.length || 0,
                decision: p.decision || 'continue',
                isLegacy: true,
                budget: p.remainingBudget + p.spentBudget,
                timeline: p.quartersRemaining + (p.quarterlyUpdates?.length || 0),
                successProb: successProb,
                quarterNarratives: legacyNarratives,
                quarterlyUpdates: p.quarterlyUpdates || [], // Ensure array exists
                outcomeNarrative: {
                    success: 'Legacy project completed successfully. Delivered on remaining commitments.',
                    failure: 'Legacy project faced challenges. Some objectives met but others deferred.'
                },
                milestones: { phases: [
                    { phase: 'Completion Phase', deliverables: ['Final development', 'Testing', 'Documentation'] }
                ]}
            };
            return ensureProjectCompleteness(active);
        });
        
        // Combine both types
        gameState.activeProjects = [...newActiveProjects, ...activeLegacy];
        
        gameState.rejectedProjects = projects.filter(p => !gameState.selectedProjects.includes(p.id)).map(p => ({...p, status: 'rejected'}));
        gameState.currentQuarter = 1;
        gameState.completedProjects = [];
        // Keep killed projects from legacy decisions
        if (!gameState.killedProjects) gameState.killedProjects = [];
        
        // Start the quarterly review process (cockpit will be shown after projects are updated)
        renderQuarterlyReview();
    }
    
    function renderQuarterlyReview() {
        // Process any active effects from previous events
        processActiveEffects();
        
        // TWO-TIER EVENT SYSTEM:
        // 1. Corporate Events (~35% per quarter): Company-wide news, acknowledge only
        // 2. R&D Dilemmas (~90% per quarter, 1-2): Project-level decisions with choices
        
        // Check for corporate events first (less frequent, context-setting)
        const events = checkForCorporateEvent();
        if (events && events.length > 0) {
            showCorporateEventsSequentially(events, 0, () => {
                checkAndShowDilemma();
            });
        } else {
            checkAndShowDilemma();
        }
    }
    
    function showCorporateEventsSequentially(events, index, finalCallback) {
        if (index >= events.length) {
            // All events shown, proceed to final callback
            finalCallback();
            return;
        }
        
        const event = events[index];
        showCorporateEvent(event, () => {
            // Show next event after this one is acknowledged
            showCorporateEventsSequentially(events, index + 1, finalCallback);
        });
    }
    
    function checkAndShowDilemma() {
        // Check for R&D dilemmas (1-2 per quarter, 90% chance)
        const dilemmas = checkForManagementDilemma();
        if (dilemmas && dilemmas.length > 0) {
            showDilemmasSequentially(dilemmas, 0, () => {
                checkAndShowBootleg();
            });
        } else {
            checkAndShowBootleg();
        }
    }
    
    function checkAndShowBootleg() {
        // Check if conditions are met for a bootleg project opportunity
        const bootleg = checkForBootlegOpportunity();
        if (bootleg) {
            showBootlegOpportunity(bootleg);
            // Wait for player to accept/decline, then continue
            // The accept/decline functions will call actuallyRenderQuarterlyReview
            gameState.pendingBootlegCallback = actuallyRenderQuarterlyReview;
        } else {
            actuallyRenderQuarterlyReview();
        }
    }
    
    function showDilemmasSequentially(dilemmas, index, finalCallback) {
        if (index >= dilemmas.length) {
            finalCallback();
            return;
        }
        
        const dilemma = dilemmas[index];
        showManagementDilemma(dilemma, () => {
            showDilemmasSequentially(dilemmas, index + 1, finalCallback);
        });
    }
    
    function actuallyRenderQuarterlyReview() {
        var year = gameState.currentQuarter <= 4 ? 1 : 2;
        var quarterInYear = gameState.currentQuarter <= 4 ? gameState.currentQuarter : gameState.currentQuarter - 4;
        
        // Add active effects badge to title
        const effectsBadge = getActiveEffectsBadge();
        document.getElementById('quarter-title').innerHTML = `Q${gameState.currentQuarter} Review ${effectsBadge}`;
        document.getElementById('quarter-subtitle').textContent = `Year ${year}, Quarter ${quarterInYear}`;
        
        // Generate updates for all projects first AND increment currentQuarter
        // This must happen BEFORE commercialization check so projects at 0Q left complete properly
        gameState.activeProjects.forEach(project => {
            ensureProjectCompleteness(project);
            const update = generateQuarterlyUpdate(project);
            project.latestUpdate = update; // Store for modal access
            project.quarterlyUpdates.push(update);
            project.currentQuarter++;
        });
        
        // Now check for commercialization (projects that have reached their timeline)
        document.getElementById('commercialisation-events').innerHTML = renderCommercializationEvents();
        
        // Filter out completed projects before rendering tiles
        gameState.activeProjects = gameState.activeProjects.filter(p => p.status !== 'completed');
        
        // Update portfolio summary AFTER completion processing
        document.getElementById('portfolio-summary').innerHTML = `
            <div class="portfolio-stat"><div class="num">${gameState.activeProjects.length}</div><div class="lbl">Active</div></div>
            <div class="portfolio-stat"><div class="num">${gameState.completedProjects.length}</div><div class="lbl">Completed</div></div>
            <div class="portfolio-stat"><div class="num">${gameState.killedProjects.length}</div><div class="lbl">Killed</div></div>
            <div class="portfolio-stat"><div class="num">$${gameState.budget.toFixed(1)}M </div><div class="lbl">Remaining</div></div>
        `;
        
        // Render compact tiles
        document.getElementById('review-cards').innerHTML = `
            <div class="review-tiles-grid">
                ${gameState.activeProjects.map(project => {
                    const update = project.latestUpdate;
                    const statusClass = update.status;
                    const budgetPct = Math.round((update.spent / project.budget) * 100);
                    
                    // Generate compact strategic bucket badges
                    const tileBuckets = (project.strategicBuckets || []).map(b => `
                        <span style="display: inline-block; background: ${b.color || '#6366f1'}15; color: ${b.color || '#6366f1'}; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; font-weight: 500;">
                            ${b.icon} ${b.name}
                        </span>
                    `).join(' ');
                    
                    return `
                        <div class="review-tile ${statusClass}" data-project-id="${project.id}">
                            <div class="tile-header">
                                <span class="tile-status-dot ${statusClass}"></span>
                                <span class="tile-name">${project.name}</span>
                            </div>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;">
                                ${tileBuckets || '<span style="font-size: 0.7em; color: var(--gray-400);">No strategic alignment</span>'}
                            </div>
                            
                            <div class="tile-phase">📍 ${update.currentMilestone} (${update.milestonesComplete}/${update.totalMilestones} phases)</div>
                            
                            <div class="tile-metrics">
                                <div class="tile-metric">
                                    <span class="metric-value">${update.progress}%</span>
                                    <span class="metric-label">Progress</span>
                                </div>
                                <div class="tile-metric">
                                    <span class="metric-value ${budgetPct > 80 ? 'warning' : ''}">${budgetPct}%</span>
                                    <span class="metric-label">Budget</span>
                                </div>
                                <div class="tile-metric">
                                    <span class="metric-value">${Math.max(0, project.timeline - project.currentQuarter)}Q</span>
                                    <span class="metric-label">Left</span>
                                </div>
                            </div>
                            
                            <div class="tile-objectives">
                                ${(update.objectiveStatus || []).map(obj => 
                                    '<div class="tile-obj ' + obj.status + '">' + obj.icon + ' ' + obj.name.substring(0, 35) + (obj.name.length > 35 ? '...' : '') + '</div>'
                                ).join('')}
                            </div>
                            
                            <div class="tile-narrative">"${update.narrative.substring(0, 80)}${update.narrative.length > 80 ? '...' : ''}"</div>
                            
                            <button class="tile-details-btn" onclick="openReviewModal('${project.id}')">
                                📋 View Details & Intel
                            </button>
                            
                            <div class="tile-actions">
                                <button class="tile-action continue ${project.decision === 'continue' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'continue')" title="Continue at current pace">
                                    ▶️
                                </button>
                                <button class="tile-action accelerate ${project.decision === 'accelerate' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'accelerate')" title="Accelerate: +50% budget, -1Q">
                                    ⚡
                                </button>
                                <button class="tile-action reduce ${project.decision === 'reduce' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'reduce')" title="Reduce: -30% budget, +1Q">
                                    🔻
                                </button>
                                <button class="tile-action kill ${project.decision === 'kill' ? 'selected' : ''}" 
                                        onclick="event.stopPropagation(); setDecision('${project.id}', 'kill')" title="Kill project">
                                    🛑
                                </button>
                            </div>
                            
                            <div class="tile-decision-label" id="decision-label-${project.id}">
                                ${getDecisionLabel(project.decision)}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        const btn = document.getElementById('next-quarter-btn');
        const cockpitBtn = document.getElementById('cockpit-next-btn');
        var nextLabel;
        if (gameState.currentQuarter >= gameState.maxQuarters || gameState.activeProjects.length === 0) {
            nextLabel = 'View Final Results →';
        } else if (gameState.currentQuarter === 4) {
            nextLabel = 'Proceed to Year 2 Budget Review →';
        } else {
            nextLabel = 'Submit Decisions & Go to Q' + (gameState.currentQuarter + 1) + ' →';
        }
        if (btn) btn.textContent = nextLabel;
        if (cockpitBtn) cockpitBtn.textContent = nextLabel;
        
        // Update cockpit view AFTER projects have been updated with quarterly data
        showCockpitView();
    }
    
    function getDecisionLabel(decision) {
        const labels = {
            'continue': '<span class="decision-tag continue">▶️ Continuing</span>',
            'accelerate': '<span class="decision-tag accelerate">⚡ Accelerating</span>',
            'reduce': '<span class="decision-tag reduce">🔻 Reducing</span>',
            'kill': '<span class="decision-tag kill">🛑 Killing</span>'
        };
        return labels[decision] || labels['continue'];
    }
    
    function openReviewModal(projectId) {
        const project = gameState.activeProjects.find(p => String(p.id) === String(projectId));
        if (!project) return;
        
        const update = project.latestUpdate;
        const milestoneInfo = getMilestoneProgress(project);
        const competitorUpdate = getCompetitorUpdate(project, update.isGoodQuarter);
        const ipUpdate = getIPUpdate(project, update.isGoodQuarter);
        const teamUpdate = getTeamUpdate(project, update.isGoodQuarter);
        const riskAssessment = getRiskAssessment(project, update);
        const recommendation = getCommitteeRecommendation(project, update);
        
        const modalHtml = `
            <div class="review-modal-overlay" onclick="closeReviewModal()">
                <div class="review-modal" onclick="event.stopPropagation()">
                    <button class="review-modal-close" onclick="closeReviewModal()">×</button>
                    
                    <div class="review-modal-header ${update.status}">
                        <h2>${project.name}</h2>
                        <p>${project.tagline || ''}</p>
                        <span class="status-badge ${update.status}">${update.status.toUpperCase()}</span>
                    </div>
                    
                    <div class="review-modal-body">
                        <div class="review-modal-section">
                            <h3>📊 Key Metrics</h3>
                            <div class="modal-metrics-grid">
                                <div class="modal-metric">
                                    <div class="value">${update.progress}%</div>
                                    <div class="label">Progress</div>
                                </div>
                                <div class="modal-metric">
                                    <div class="value">$${update.spent.toFixed(1)}M </div>
                                    <div class="label">Spent</div>
                                </div>
                                <div class="modal-metric">
                                    <div class="value">${Math.max(0, project.timeline - project.currentQuarter)}Q</div>
                                    <div class="label">Remaining</div>
                                </div>
                                <div class="modal-metric ${update.spent > project.budget * 0.8 ? 'warning' : ''}">
                                    <div class="value">${Math.round((update.spent / project.budget) * 100)}%</div>
                                    <div class="label">Budget Used</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>📋 Project Snapshot</h3>
                            <div class="modal-facts-grid">
                                <div><strong>Original Budget:</strong> $${project.budget.toFixed(1)}M </div>
                                <div><strong>Timeline:</strong> ${project.timeline} quarters</div>
                                <div><strong>TRL:</strong> ${project.trl?.current || '?'} → ${project.trl?.target || '?'}</div>
                                <div><strong>Strategic Focus:</strong> ${(project.strategicBuckets || []).map(b => b.icon + ' ' + b.name).join(', ') || '—'}</div>
                            </div>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>🎯 Milestone Progress</h3>
                            <div class="milestone-track">${milestoneInfo.html}</div>
                            <p class="milestone-narrative">${milestoneInfo.narrative}</p>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>📝 Team Update</h3>
                            <div class="review-narrative">"${update.narrative}"</div>
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>👤 Project Lead</h3>
                            ${project.lead ? renderLeadCard(project.lead) : '<p style="color: var(--gray-500);">No lead assigned.</p>'}
                        </div>
                        
                        <div class="review-modal-section">
                            <h3>🔍 Intelligence Report</h3>
                            <div class="modal-intel-grid">
                                <div class="intel-card competitor">
                                    <h5>🏁 Competitor Intel</h5>
                                    <p>${competitorUpdate}</p>
                                </div>
                                <div class="intel-card ip">
                                    <h5>🛡️ IP Position</h5>
                                    <p>${ipUpdate}</p>
                                </div>
                                <div class="intel-card team">
                                    <h5>👥 Team & Resources</h5>
                                    <p>${teamUpdate}</p>
                                </div>
                                <div class="intel-card risk">
                                    <h5>⚠️ Risk Assessment</h5>
                                    <p>${riskAssessment}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="review-modal-section recommendation">
                            <h3>💡 Committee Recommendation</h3>
                            <p>${recommendation}</p>
                        </div>
                    </div>
                    
                    <div class="review-modal-footer">
                        <h4>Your Decision</h4>
                        <div class="modal-actions">
                            <button class="action-btn continue ${project.decision === 'continue' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'continue')">
                                <span class="action-icon">▶️</span>
                                <span class="action-label">Continue</span>
                                <span class="action-desc">Maintain current pace</span>
                            </button>
                            <button class="action-btn accelerate ${project.decision === 'accelerate' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'accelerate')">
                                <span class="action-icon">⚡</span>
                                <span class="action-label">Accelerate</span>
                                <span class="action-desc">+50% budget, -1Q timeline</span>
                            </button>
                            <button class="action-btn reduce ${project.decision === 'reduce' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'reduce')">
                                <span class="action-icon">🔻</span>
                                <span class="action-label">Reduce</span>
                                <span class="action-desc">-30% budget, +1Q timeline</span>
                            </button>
                            <button class="action-btn kill ${project.decision === 'kill' ? 'selected' : ''}" 
                                    onclick="setDecisionAndUpdate('${project.id}', 'kill')">
                                <span class="action-icon">🛑</span>
                                <span class="action-label">Kill</span>
                                <span class="action-desc">Stop project</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to DOM
        const modalContainer = document.createElement('div');
        modalContainer.id = 'review-modal-container';
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);
    }
    
    function closeReviewModal() {
        const container = document.getElementById('review-modal-container');
        if (container) {
            container.remove();
        }
    }
    
    function setDecisionAndUpdate(projectId, decision) {
        setDecision(projectId, decision);
        
        // Update modal buttons
        const modalActions = document.querySelector('.modal-actions');
        if (modalActions) {
            modalActions.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.classList.contains(decision)) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // Auto-close modal after brief delay to show selection feedback
        setTimeout(() => {
            closeReviewModal();
        }, 300);
    }
    
    function getMilestoneProgress(project) {
        const milestones = project.milestones?.milestones || project.milestones?.phases || [
            { name: 'Research', duration: '3 months' },
            { name: 'Development', duration: '6 months' },
            { name: 'Testing', duration: '2 months' },
            { name: 'Launch', duration: '1 month' }
        ];
        
        const quarterProgress = project.currentQuarter / project.timeline;
        const currentMilestoneIndex = Math.min(Math.floor(quarterProgress * milestones.length), milestones.length - 1);
        
        const html = milestones.map((m, i) => {
            let status = 'upcoming';
            if (i < currentMilestoneIndex) status = 'complete';
            else if (i === currentMilestoneIndex) status = 'current';
            
            return `<div class="milestone-item ${status}">
                <div class="milestone-dot"></div>
                <div class="milestone-name">${m.name || m.phase || `Phase ${i+1}`}</div>
            </div>`;
        }).join('<div class="milestone-connector"></div>');
        
        const currentMilestone = milestones[currentMilestoneIndex];
        const narratives = [
            `Currently in ${currentMilestone?.name || 'development'} phase. Team is ${quarterProgress > 0.5 ? 'making good progress' : 'ramping up'}.`,
            `${currentMilestone?.name || 'Current phase'} underway. ${Math.round(quarterProgress * 100)}% through planned timeline.`,
            `Working on ${currentMilestone?.name || 'deliverables'}. ${currentMilestoneIndex > 0 ? 'Previous milestones completed.' : 'Initial phase.'}`
        ];
        
        return { 
            html, 
            narrative: narratives[Math.floor(Math.random() * narratives.length)]
        };
    }
    
    function getCompetitorUpdate(project, isGoodQuarter) {
        const competitors = project.competitors || [];
        const competitorNames = competitors.map(c => c.name || c).slice(0, 2);
        
        const goodUpdates = [
            `Market analysis shows our approach is differentiated. ${competitorNames[0] || 'Key competitor'} facing delays.`,
            `Competitive position strengthening. Early customer feedback favours our solution.`,
            `No major competitor moves detected. Our first-mover advantage intact.`,
            `${competitorNames[0] || 'Primary rival'} pivoted away from this segment. Less competitive pressure.`
        ];
        
        const badUpdates = [
            `${competitorNames[0] || 'Major competitor'} announced similar product. Time pressure increasing.`,
            `Competitor pricing aggressive. May need to adjust our go-to-market strategy.`,
            `New entrant detected in adjacent space. Monitoring closely.`,
            `${competitorNames[0] || 'Rival'} secured key partnership. Competitive dynamics shifting.`
        ];
        
        const updates = isGoodQuarter ? goodUpdates : badUpdates;
        return updates[Math.floor(Math.random() * updates.length)];
    }
    
    function getIPUpdate(project, isGoodQuarter) {
        const ipPosition = project.ipAnalysis?.shieldtechIP || 'Limited existing IP';
        
        const goodUpdates = [
            `Patent application progressing well. Freedom to operate confirmed for key features.`,
            `Strengthened defensive position. Two provisional patents filed this quarter.`,
            `IP landscape clear. No blocking patents identified in target markets.`,
            `Trade secret protections in place. Key algorithms secured.`
        ];
        
        const badUpdates = [
            `IP review flagged potential overlap with existing patents. Legal assessing options.`,
            `Competitor filed broad claims in adjacent area. May need design-around.`,
            `Patent search revealed prior art. Adjusting claims strategy.`,
            `Freedom to operate analysis ongoing. Some uncertainty in key markets.`
        ];
        
        const updates = isGoodQuarter ? goodUpdates : badUpdates;
        return updates[Math.floor(Math.random() * updates.length)];
    }
    
    function getTeamUpdate(project, isGoodQuarter) {
        const teamLeads = project.teamLeads || [];
        const leadName = teamLeads[0]?.name || 'Project lead';
        
        const goodUpdates = [
            `Team morale high. ${leadName} reports strong collaboration across functions.`,
            `Successfully onboarded key specialist. Capability gaps addressed.`,
            `Team velocity improving. Sprint commitments being met consistently.`,
            `Cross-functional alignment strong. No resource conflicts this quarter.`
        ];
        
        const badUpdates = [
            `Key engineer departed. Knowledge transfer underway but causing delays.`,
            `Team stretched thin across multiple priorities. ${leadName} requesting additional headcount.`,
            `Some friction between engineering and product. Working to resolve.`,
            `Resource contention with other projects. May need to reprioritise.`
        ];
        
        const updates = isGoodQuarter ? goodUpdates : badUpdates;
        return updates[Math.floor(Math.random() * updates.length)];
    }
    
    function getRiskAssessment(project, update) {
        const progress = update.progress;
        const budgetUsed = (update.spent / project.budget) * 100;
        const timeUsed = (project.currentQuarter / project.timeline) * 100;
        
        if (update.status === 'red') {
            if (budgetUsed > timeUsed + 20) {
                return `⛔ HIGH RISK: Budget burn rate ${Math.round(budgetUsed - timeUsed)}% ahead of timeline. Cost overrun likely without intervention.`;
            } else if (progress < timeUsed - 25) {
                return `⛔ HIGH RISK: Progress ${Math.round(timeUsed - progress)}% behind schedule. Timeline at risk. Consider scope reduction.`;
            }
            return `⛔ HIGH RISK: Multiple warning indicators. Recommend thorough review before proceeding.`;
        } else if (update.status === 'yellow') {
            return `⚠️ MODERATE RISK: Some concerns flagged. Close monitoring recommended. Mitigation actions underway.`;
        } else {
            return `✅ LOW RISK: Project tracking to plan. No immediate concerns. Continue current approach.`;
        }
    }
    
    function getCommitteeRecommendation(project, update) {
        const progress = update.progress;
        const budgetUsed = (update.spent / project.budget) * 100;
        const timeUsed = (project.currentQuarter / project.timeline) * 100;
        
        // Get committee members' perspectives
        const committee = gameState.committee || [];
        const memberOpinions = committee.slice(0, 2).map(memberId => {
            const member = findStaff(memberId);
            if (!member) return null;
            
            let opinion;
            if (update.status === 'green') {
                opinion = member.bias?.includes('growth') ? 'accelerate' : 'continue';
            } else if (update.status === 'red') {
                opinion = member.bias?.includes('risk') ? 'kill' : 'reduce';
            } else {
                opinion = 'continue';
            }
            return { name: member.name.split(' ')[0], opinion };
        }).filter(Boolean);
        
        let recommendation = '';
        
        if (update.status === 'green' && progress > timeUsed) {
            recommendation = `Strong performance suggests opportunity to accelerate. ROI case strengthening.`;
        } else if (update.status === 'red' && budgetUsed > timeUsed + 15) {
            recommendation = `Significant concerns warrant serious consideration of scope reduction or termination.`;
        } else if (update.status === 'yellow') {
            recommendation = `Mixed signals. Recommend maintaining current pace while addressing flagged issues.`;
        } else {
            recommendation = `On track. No changes recommended at this time.`;
        }
        
        if (memberOpinions.length > 0) {
            recommendation += ` ${memberOpinions[0].name} suggests "${memberOpinions[0].opinion}".`;
        }
        
        return recommendation;
    }
    
    function generateQuarterlyUpdate(project) {
        const quarterNum = project.currentQuarter;
        let isGoodQuarter = Math.random() < project.successProb;
        
        if (project.archetype === 'slow_burner' && quarterNum < 5) isGoodQuarter = Math.random() < 0.3;
        if (project.archetype === 'paper_tiger' && quarterNum < 3) isGoodQuarter = Math.random() < 0.7;
        if (project.archetype === 'money_pit') isGoodQuarter = Math.random() < 0.4;
        if (project.archetype === 'hidden_gem' && quarterNum > 3) isGoodQuarter = Math.random() < 0.75;
        
        const narratives = isGoodQuarter ? project.quarterNarratives.good : project.quarterNarratives.bad;
        const narrative = narratives[Math.floor(Math.random() * narratives.length)];
        const expectedProgress = (quarterNum / project.timeline) * 100;
        const progressVariance = isGoodQuarter ? Math.random() * 15 : -Math.random() * 25;
        // Cap progress at 99% until project reaches its final quarter (prevents misleading 100% before completion)
        const maxProgress = quarterNum >= project.timeline ? 100 : 99;
        const progress = Math.min(maxProgress, Math.max(0, Math.round(expectedProgress + progressVariance)));
        const quarterlyBudget = project.budget / project.timeline;
        const spent = project.spentBudget + quarterlyBudget * (1 + (isGoodQuarter ? 0 : Math.random() * 0.3));
        project.spentBudget = spent;
        
        let status = 'green';
        if (!isGoodQuarter) status = 'yellow';
        if (progress < expectedProgress - 20 || spent > project.budget * 0.9) status = 'red';
        
        // Generate milestone status
        const milestones = project.milestones?.milestones || project.milestones?.phases || [];
        const totalMilestones = milestones.length || 3;
        const milestonesComplete = Math.min(totalMilestones, Math.floor((quarterNum / project.timeline) * totalMilestones));
        const currentMilestone = milestones[milestonesComplete] || { phase: 'Development', deliverables: ['Core features'] };
        
        // Generate objective status
        const objectiveStatus = generateObjectiveStatus(project, quarterNum, isGoodQuarter);
        
        return { 
            status, 
            progress, 
            spent, 
            narrative, 
            isGoodQuarter,
            milestonesComplete,
            totalMilestones,
            currentMilestone: currentMilestone.phase || 'In Progress',
            objectiveStatus
        };
    }
    
    function generateObjectiveStatus(project, quarterNum, isGoodQuarter) {
        // Generate 3-4 specific objectives with status
        const objectives = [];
        const milestones = project.milestones?.milestones || project.milestones?.phases || [];
        const currentPhase = milestones[Math.min(milestones.length - 1, Math.floor((quarterNum / project.timeline) * milestones.length))] || {};
        const deliverables = currentPhase.deliverables || ['Core development', 'Testing', 'Documentation'];
        const metrics = currentPhase.metrics || [];
        
        // Add deliverable-based objectives
        deliverables.slice(0, 2).forEach((d, i) => {
            const complete = isGoodQuarter ? Math.random() > 0.3 : Math.random() > 0.7;
            const inProgress = !complete && Math.random() > 0.4;
            objectives.push({
                name: d,
                status: complete ? 'complete' : (inProgress ? 'in-progress' : 'at-risk'),
                icon: complete ? '✅' : (inProgress ? '🔄' : '⚠️')
            });
        });
        
        // Add metric-based objectives
        metrics.slice(0, 2).forEach((m, i) => {
            const onTrack = isGoodQuarter ? Math.random() > 0.25 : Math.random() > 0.6;
            objectives.push({
                name: m.name + ': ' + m.target,
                status: onTrack ? 'on-track' : 'behind',
                icon: onTrack ? '📊' : '📉'
            });
        });
        
        // Ensure at least 3 objectives
        if (objectives.length < 3) {
            const genericObjectives = [
                { name: 'Technical milestones', status: isGoodQuarter ? 'on-track' : 'behind', icon: isGoodQuarter ? '✅' : '⚠️' },
                { name: 'Budget compliance', status: project.spentBudget < project.budget * 0.8 ? 'on-track' : 'at-risk', icon: project.spentBudget < project.budget * 0.8 ? '💰' : '⚠️' },
                { name: 'Timeline adherence', status: isGoodQuarter ? 'on-track' : 'behind', icon: isGoodQuarter ? '📅' : '⏰' }
            ];
            while (objectives.length < 3 && genericObjectives.length > 0) {
                objectives.push(genericObjectives.shift());
            }
        }
        
        return objectives.slice(0, 4);
    }
    
    function renderCommercializationEvents() {
        const completing = gameState.activeProjects.filter(p => p.currentQuarter >= p.timeline && p.decision !== 'kill');
        if (!completing.length) return '';
        
        // Default narratives for legacy projects or projects without outcomeNarrative
        const defaultNarratives = {
            success: 'Project delivered successfully and met key objectives.',
            failure: 'Project faced challenges but provided valuable learnings for future initiatives.'
        };
        
        return completing.map(project => {
            const success = Math.random() < project.successProb;
            project.outcome = success ? 'success' : 'failure';
            project.status = 'completed';
            gameState.completedProjects.push(project);
            // Use risk-based ROI multiplier for successful projects
            const baseMultiplier = project.roiMultiplier || 2.5;
            const variance = 0.5 + Math.random() * 0.5; // 0.5-1.0 variance factor
            project.revenue = success ? project.budget * baseMultiplier * variance : -project.spentBudget;
            
            // Use project's narrative or default
            const narrative = project.outcomeNarrative || defaultNarratives;
            const narrativeText = success ? narrative.success : narrative.failure;
            
            return `
                <div class="event-card">
                    <h4>🎉 Project Completed: ${project.name}</h4>
                    <p class="${success ? 'outcome-success' : 'outcome-failure'}" style="font-size: 1.1em; margin-bottom: 10px;">${success ? '✅ SUCCESS' : '❌ FAILURE'}</p>
                    <p style="color: var(--gray-600); margin-bottom: 10px;">${narrativeText}</p>
                    <p><strong>Financial Impact:</strong> <span class="${success ? 'outcome-success' : 'outcome-failure'}">${project.revenue >= 0 ? '+' : ''}$${Math.abs(project.revenue).toFixed(1)}M </span></p>
                </div>
            `;
        }).join('');
    }
    
    function setDecision(projectId, decision) {
        // Ensure projectId is a string for comparison
        const targetId = String(projectId);
        const project = gameState.activeProjects.find(p => String(p.id) === targetId);
        if (project) {
            project.decision = decision;
            
            // Update tile buttons
            const tile = document.querySelector(`.review-tile[data-project-id="${targetId}"]`);
            if (tile) {
                tile.querySelectorAll('.tile-action').forEach(btn => btn.classList.remove('selected'));
                const selectedBtn = tile.querySelector(`.tile-action.${decision}`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
                
                // Update decision label
                const label = document.getElementById(`decision-label-${targetId}`);
                if (label) {
                    label.innerHTML = getDecisionLabel(decision);
                }
            }
            
            // Update card buttons (legacy)
            const card = document.querySelector(`.review-card[data-project-id="${targetId}"]`);
            if (card) {
                card.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('selected'));
                const selectedBtn = card.querySelector(`.action-btn.${decision}`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
            }
        }
    }
    
    function nextQuarter() {
        // Year 2 planning gate: do not advance beyond Q5 until the player completes Year 2 planning
        // (assessment → optional Resource Run → selection/confirmation). This prevents accidental/skipped transitions.
        if (gameState.currentQuarter >= 5 && !gameState.year2PlanningComplete) {
            if (gameState.currentQuarter > 5) gameState.currentQuarter = 5;
            if (!gameState.inYear2PlanningFlow) {
                showYear1PortfolioReview();
            }
            return;
        }

        gameState.activeProjects = gameState.activeProjects.filter(p => p.status !== 'completed');
        gameState.activeProjects = gameState.activeProjects.filter(project => {
            if (project.decision === 'kill') {
                project.status = 'killed';
                
                // Track kill decision for portfolio scoring
                const latestUpdate = project.latestUpdate || {};
                const signalStrength = latestUpdate.status || 'unknown'; // green, yellow, red
                const wasPerformingWell = signalStrength === 'green' || (signalStrength === 'yellow' && latestUpdate.isGoodQuarter);
                
                gameState.killDecisions.push({
                    projectId: project.id,
                    projectName: project.name,
                    riskClass: project.riskClass || getProjectRiskClass(project.archetype),
                    killedAtQuarter: gameState.currentQuarter,
                    signalStrength: signalStrength,
                    wasPerformingWell: wasPerformingWell,
                    successProb: project.successProb
                });
                
                gameState.activeDecisionsMade++;
                gameState.killedProjects.push(project);
                return false;
            }
            if (project.decision === 'accelerate') { 
                project.budget *= 1.5; 
                project.timeline = Math.max(1, project.timeline - 1); 
                project.successProb += 0.05; 
                gameState.activeDecisionsMade++;
            }
            if (project.decision === 'reduce') { 
                project.budget *= 0.7; 
                project.timeline += 1; 
                project.successProb -= 0.1; 
                gameState.activeDecisionsMade++;
            }
            project.decision = 'continue';
            return true;
        });
        
        gameState.currentQuarter++;
        
        if (gameState.currentQuarter === 5) {
            // End of Year 1 (entering Q5) – always show review + Year 2 opportunity flow, even if no active projects.
            showYear1PortfolioReview();
        
            return;
} else if (gameState.currentQuarter > gameState.maxQuarters) {
        gameState.activeProjects.forEach(project => {
                        const success = Math.random() < project.successProb;
                        project.outcome = success ? 'success' : 'failure';
                        project.status = 'completed';
                        // Use risk-based ROI multiplier for successful projects
                        const baseMultiplier = project.roiMultiplier || 2.5;
                        const variance = 0.5 + Math.random() * 0.5; // 0.5-1.0 variance factor
                        project.revenue = success ? project.budget * baseMultiplier * variance : -project.spentBudget;
                        gameState.completedProjects.push(project);
                    });
                    gameState.activeProjects = [];
                    showResults();
        } else if (gameState.activeProjects.length === 0) {
            // No active projects left mid-game: end early.
            showResults();
        } else {
            // Start the quarterly review process (cockpit will be shown after projects are updated)
            renderQuarterlyReview();
        }
}
    
    function showResults() {
        SoundManager.play('dramatic');
        const results = calculateResults();
        
        // Calculate career outcome
        const careerOutcome = calculateCareerOutcome(results);
        
        // Update career outcome banner
        const banner = document.getElementById('career-outcome-banner');
        banner.style.background = careerOutcome.gradient;
        document.getElementById('career-outcome-icon').textContent = careerOutcome.icon;
        document.getElementById('career-outcome-title').textContent = careerOutcome.title;
        document.getElementById('career-outcome-subtitle').textContent = careerOutcome.subtitle;
        
        // Update narrative
        document.getElementById('career-narrative-text').textContent = careerOutcome.narrative;
        
        // Update stats
        document.getElementById('tp-count').textContent = results.truePositives;
        document.getElementById('fp-count').textContent = results.falsePositives;
        document.getElementById('fn-count').textContent = results.falseNegatives;
        document.getElementById('tn-count').textContent = results.trueNegatives;
        document.getElementById('roi-value').textContent = `${results.roi}%`;
        document.getElementById('hit-rate').textContent = `${results.hitRate}%`;
        document.getElementById('waste-value').textContent = `$${results.waste.toFixed(1)}M`;
        document.getElementById('missed-value').textContent = `$${results.missed.toFixed(1)}M`;
        
        // Update process insights and counterfactuals
        document.getElementById('process-insights').innerHTML = generateProcessInsights(results);
        document.getElementById('counterfactuals').innerHTML = generateCounterfactuals();
        
        // Generate board feedback
        document.getElementById('board-feedback').innerHTML = generateBoardFeedback(results, careerOutcome);
        
        showPhase('results');
    }
    
    function calculateCareerOutcome(results) {
        // Base score calculation (0-100)
        const hitRateScore = results.hitRate;
        const roiScore = Math.min(100, Math.max(0, (results.roi + 50))); // Normalize ROI to 0-100
        const fnPenalty = Math.min(100, Math.max(0, 100 - (results.falseNegatives * 20))); // Fewer FN = better
        const tnBonus = Math.min(100, results.trueNegatives * 20); // More TN = better
        
        let baseScore = (hitRateScore * 0.35) + (roiScore * 0.25) + (fnPenalty * 0.15) + (tnBonus * 0.10);
        
        // Apply portfolio balance multiplier (0.7 - 1.1)
        const balanceMultiplier = results.portfolioBalance?.multiplier || 1.0;
        
        // Apply bucket coverage bonus/penalty (-0.1 to +0.2)
        const bucketBonus = results.bucketCoverage?.netBonus || 0;
        
        // Apply kill quality points (-20 to +20 roughly, normalize to percentage)
        const killPoints = results.killQuality?.points || 0;
        const killBonus = Math.max(-15, Math.min(15, killPoints)); // Cap at ±15
        
        // Apply active management bonus (0 or 5)
        const activeBonus = results.activeManagementBonus?.bonus || 0;
        
        // Calculate final composite score
        let compositeScore = (baseScore * balanceMultiplier) * (1 + bucketBonus) + killBonus + activeBonus;
        
        // If player requested extra budget from CEO, the bar is higher
        // They need to exceed expectations, not just meet them
        const askedForExtraBudget = gameState.extraBudgetPerformanceBar || false;
        const extraBudgetScoreAdjustment = askedForExtraBudget ? -10 : 0; // Effective score reduction for threshold comparisons
        const adjustedScore = compositeScore + extraBudgetScoreAdjustment;
        
        // Additional factors
        const totalProjects = results.truePositives + results.falsePositives;
        
        // Success with transformational projects (high risk, high reward path)
        const hasTransformationalSuccess = results.transformationalSuccesses >= 1;
        const hasBlockbuster = results.truePositives >= 2 && results.roi > 60 && hasTransformationalSuccess;
        
        // Disaster scenarios
        const isDisaster = results.falsePositives > results.truePositives && results.roi < -30;
        const missedBigOnes = results.falseNegatives >= 3;
        
        // Good portfolio management indicators
        const goodKillDiscipline = results.killQuality?.points >= 5;
        const excellentBalance = results.portfolioBalance?.category === 'optimal';
        const perfectTriage = results.falseNegatives === 0 && results.trueNegatives >= 2;
        
        // Penalty for all-safe portfolio (pedagogical: don't just play it safe)
        const tooConservative = results.portfolioBalance?.category === 'too_safe';
        const playedItSafe = results.incrementalCount >= results.totalPortfolio * 0.7 && results.transformationalSuccesses === 0;
        
        // Determine outcome based on composite score and factors
        // Note: If player asked for extra budget, adjustedScore is lower, making thresholds harder to meet
        
        // TOP TIER: CTO or Venture Lead
        if (adjustedScore >= 75 || hasBlockbuster) {
            if (hasBlockbuster && excellentBalance && goodKillDiscipline) {
                const extraBudgetNote = askedForExtraBudget ? ' Meera noted that your conviction in requesting additional funding was justified — "You asked for more resources and delivered exceptional results."' : '';
                return {
                    outcome: 'cto',
                    icon: '🚀',
                    title: 'Promoted to Chief Technology Officer',
                    subtitle: 'The board was so impressed, they\'ve elevated you to the C-suite',
                    gradient: 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
                    narrative: `Your exceptional R&D leadership delivered ${results.truePositives} successful project(s) including transformational wins, with a ${results.roi}% ROI. Your balanced portfolio strategy — mixing stable bets with breakthrough opportunities — proved masterful.${extraBudgetNote} The board unanimously voted to promote you to CTO, citing your "rare combination of strategic vision, risk management, and execution discipline."`,
                    boardMood: 'delighted',
                    compositeScore
                };
            } else {
                const extraBudgetNote = askedForExtraBudget ? ' Your willingness to make a personal case for more resources — and then deliver — impressed the CEO.' : '';
                return {
                    outcome: 'venture_lead',
                    icon: '⭐',
                    title: 'Tapped to Lead New Corporate Venture',
                    subtitle: 'Your success has earned you a high-profile spin-off opportunity',
                    gradient: 'linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%)',
                    narrative: `With ${results.truePositives} successful launches and a ${results.hitRate}% hit rate${hasTransformationalSuccess ? ', including breakthrough project wins' : ''}, the board sees you as someone who can spot and scale winners.${extraBudgetNote} They've asked you to lead a new corporate venture unit with $100M in seed capital.`,
                    boardMood: 'impressed',
                    compositeScore
                };
            }
        } 
        
        // UPPER-MID TIER: Senior Director or Retention
        else if (adjustedScore >= 50 || (results.truePositives >= 2 && results.roi >= 0)) {
            if (goodKillDiscipline && perfectTriage) {
                return {
                    outcome: 'senior_director',
                    icon: '📈',
                    title: 'Promoted to Senior Director of R&D',
                    subtitle: 'Your portfolio discipline caught leadership\'s attention',
                    gradient: 'linear-gradient(135deg, #2563eb 0%, #60a5fa 100%)',
                    narrative: `While not every bet paid off, your ${results.trueNegatives} well-reasoned rejections and zero missed opportunities demonstrated strong judgment. Your kill quality score of ${results.killQuality?.points} points shows you understand when to persist and when to cut. The CFO particularly appreciated how you "avoided throwing good money after bad." You've been promoted to Senior Director with expanded oversight.`,
                    boardMood: 'satisfied',
                    compositeScore
                };
            } else if (tooConservative || playedItSafe) {
                // Penalty for playing it too safe even with decent results
                return {
                    outcome: 'reassigned_safe',
                    icon: '🔒',
                    title: 'Reassigned to Operations Role',
                    subtitle: 'Your safe approach limited upside potential',
                    gradient: 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)',
                    narrative: `Your portfolio achieved modest returns with a ${results.hitRate}% hit rate, but the board is concerned about your conservative approach. With ${results.incrementalCount} incremental projects and no transformational wins, you missed the growth opportunities ShieldTech needed. "We hired you to find breakthrough innovations, not optimise existing products," the CEO noted. You've been reassigned to Operations where your risk-averse approach may be more suitable.`,
                    boardMood: 'disappointed',
                    compositeScore
                };
            } else {
                return {
                    outcome: 'retention',
                    icon: '🤝',
                    title: 'Retained with Performance Bonus',
                    subtitle: 'Solid results — you\'ve earned another year to prove yourself',
                    gradient: 'linear-gradient(135deg, #0891b2 0%, #22d3ee 100%)',
                    narrative: `Your portfolio achieved ${results.truePositives} success(es) with a ${results.hitRate}% hit rate. ${excellentBalance ? 'Your balanced approach to risk was noted.' : 'The board would like to see more strategic risk-taking.'} ${results.killQuality?.points > 0 ? 'Your portfolio tending showed promise.' : 'Consider being more active in managing underperformers.'} You've earned a continuation with modest bonus.`,
                    boardMood: 'neutral',
                    compositeScore
                };
            }
        } 
        
        // LOWER-MID TIER: Probation or Reassignment
        else if (adjustedScore >= 30 || results.truePositives >= 1) {
            if (missedBigOnes) {
                return {
                    outcome: 'reassigned',
                    icon: '↩️',
                    title: 'Reassigned to Operations Role',
                    subtitle: 'The board has "found a better fit" for your talents',
                    gradient: 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)',
                    narrative: `While you had ${results.truePositives} success(es), the board is troubled by the ${results.falseNegatives} opportunities you passed on that would have succeeded. ${results.killQuality?.points < -5 ? 'Your kill decisions also raised concerns — several projects you cut were showing promise.' : ''} "You showed good execution but poor selection," the CEO noted. You've been reassigned to Operations Excellence — away from strategic R&D decisions.`,
                    boardMood: 'disappointed',
                    compositeScore
                };
            } else if (results.killQuality?.points < -5) {
                return {
                    outcome: 'probation_kills',
                    icon: '⚠️',
                    title: 'Placed on Performance Improvement Plan',
                    subtitle: 'Your portfolio management needs work',
                    gradient: 'linear-gradient(135deg, #d97706 0%, #fbbf24 100%)',
                    narrative: `With a ${results.hitRate}% hit rate, the board has concerns about your portfolio management. ${results.killQuality.analysis.filter(k => k.points < 0).slice(0, 2).map(k => k.analysis).join('. ')}. You've been placed on a 90-day improvement plan. The board wants to see more thoughtful tending of the portfolio — knowing when to persist with transformational bets and when to cut incremental losers.`,
                    boardMood: 'concerned',
                    compositeScore
                };
            } else {
                const extraBudgetNote = askedForExtraBudget ? ' The CEO is particularly disappointed — she personally secured extra funding for your portfolio and expected stronger results.' : '';
                return {
                    outcome: 'probation',
                    icon: '⚠️',
                    title: 'Placed on Performance Improvement Plan',
                    subtitle: 'The board is giving you 90 days to turn things around',
                    gradient: 'linear-gradient(135deg, #d97706 0%, #fbbf24 100%)',
                    narrative: `With a ${results.hitRate}% hit rate and ${results.falsePositives} failed investment(s), the board has concerns.${extraBudgetNote} ${!excellentBalance ? 'Your portfolio balance could be improved. ' : ''}${results.activeManagementBonus?.qualifies ? '' : 'The board would like to see more active portfolio management. '}You've been placed on a 90-day improvement plan with monthly reviews.`,
                    boardMood: 'concerned',
                    compositeScore
                };
            }
        } 
        
        // BOTTOM TIER: Fired or Demoted
        else {
            if (isDisaster) {
                const extraBudgetNote = askedForExtraBudget ? ' "You asked for extra funding and delivered this?" — the CEO\'s disappointment was palpable.' : '';
                return {
                    outcome: 'fired',
                    icon: '📦',
                    title: 'Position Eliminated',
                    subtitle: 'The board has decided to "restructure" the R&D function',
                    gradient: 'linear-gradient(135deg, #b91c1c 0%, #ef4444 100%)',
                    narrative: `With ${results.falsePositives} failed projects, $${results.waste.toFixed(0)}M in wasted R&D spend, and a ${results.roi}% ROI, the board has lost confidence.${extraBudgetNote} ${tooConservative ? 'Your conservative portfolio produced neither safety nor returns.' : 'Random project selection would have performed as well.'} ${results.killQuality?.points < 0 ? 'Your kill decisions compounded the problem.' : ''} The R&D organization is being restructured.`,
                    boardMood: 'furious',
                    compositeScore
                };
            } else {
                return {
                    outcome: 'demoted',
                    icon: '⬇️',
                    title: 'Demoted to Project Manager',
                    subtitle: 'The board has "rightsized" your responsibilities',
                    gradient: 'linear-gradient(135deg, #dc2626 0%, #f87171 100%)',
                    narrative: `Your portfolio's ${results.hitRate}% hit rate and ${results.roi < 0 ? 'negative' : 'weak'} returns have convinced the board you're not ready for portfolio-level decisions. ${!results.activeManagementBonus?.qualifies ? 'Your passive management approach didn\'t help. ' : ''}You've been demoted to Project Manager for a single lower-risk initiative. It's a significant step back, but a chance to rebuild through execution.`,
                    boardMood: 'frustrated',
                    compositeScore
                };
            }
        }
    }
    
    function generateBoardFeedback(results, careerOutcome) {
        const feedback = [];
        
        // CEO feedback based on outcome
        const ceoQuotes = {
            delighted: `"Exceptional performance. You've demonstrated exactly the kind of strategic thinking we need at the executive level. I'm personally recommending you to the board."`,
            impressed: `"You've shown real talent for identifying winners. I want you working on our highest-priority strategic initiatives going forward."`,
            satisfied: `"Solid work this year. You've proven you can manage a portfolio responsibly. Let's see if you can push for more breakthrough wins next year."`,
            neutral: `"Mixed results, but you've shown potential. The board is watching closely to see how you adapt your approach."`,
            concerned: `"We expected more from someone in your position. You need to demonstrate better judgment in project selection going forward."`,
            disappointed: `"I'm disappointed. We missed opportunities and wasted resources. Something needs to change."`,
            frustrated: `"This isn't working. We need to see immediate improvement or we'll need to make changes."`,
            furious: `"I won't sugarcoat this — your tenure has been a failure. We're taking corrective action immediately."`
        };
        
        const meeraImg = staffHeadshots['meera'] ? `<img src="${staffHeadshots['meera']}" alt="Meera" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 10px;">` : '';
        feedback.push(`<div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 12px;">${meeraImg}<div><strong>CEO Meera Venkataraman:</strong><br/><em style="color: rgba(255,255,255,0.85);">${ceoQuotes[careerOutcome.boardMood]}</em></div></div>`);
        
        // CFO feedback on financials
        const farhanImg = staffHeadshots['farhan'] ? `<img src="${staffHeadshots['farhan']}" alt="Farhan" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 10px;">` : '';
        if (results.roi > 30) {
            feedback.push(`<div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 12px;">${farhanImg}<div><strong>CFO Farhan Qureshi:</strong><br/><em style="color: rgba(255,255,255,0.85);">"${results.roi}% ROI — these are the returns we need to see. Your financial discipline is commendable."</em></div></div>`);
        } else if (results.roi < 0) {
            feedback.push(`<div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 12px;">${farhanImg}<div><strong>CFO Farhan Qureshi:</strong><br/><em style="color: rgba(255,255,255,0.85);">"$${results.waste.toFixed(0)}M in sunk costs with negative returns. We need to have a serious conversation about your evaluation criteria."</em></div></div>`);
        }
        
        // Portfolio balance feedback
        const harpreetImg = staffHeadshots['harpreet'] ? `<img src="${staffHeadshots['harpreet']}" alt="Harpreet" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 10px;">` : '';
        if (results.portfolioBalance) {
            const balance = results.portfolioBalance;
            if (balance.category === 'optimal') {
                feedback.push(`<div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 12px;">${harpreetImg}<div><strong>CTO Harpreet Singh:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Excellent portfolio balance. You understood that we need both stable revenue streams and breakthrough bets. That's sophisticated R&D thinking."</em></div></div>`);
            } else if (balance.category === 'too_safe') {
                feedback.push(`<div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 12px;">${harpreetImg}<div><strong>CTO Harpreet Singh:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Your portfolio was too conservative. We hired you to find transformational opportunities, not just optimise what we already have. Where's the ambition?"</em></div></div>`);
            } else if (balance.category === 'too_risky') {
                feedback.push(`<div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 12px;">${harpreetImg}<div><strong>CTO Harpreet Singh:</strong><br/><em style="color: rgba(255,255,255,0.85);">"All moonshots and no foundation. We need some stable projects to fund the bold bets. Pure gambling isn't a strategy."</em></div></div>`);
            }
        }
        
        // Kill quality feedback
        if (results.killQuality) {
            const kills = results.killQuality;
            if (kills.points >= 8) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Board Observer:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Impressive portfolio tending. You knew when to be patient with transformational projects and when to cut incremental losers. That's rare judgment."</em></div>`);
            } else if (kills.points >= 3) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Board Observer:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Good discipline in managing the portfolio. Your kill decisions saved capital and freed resources for better opportunities."</em></div>`);
            } else if (kills.points <= -5) {
                const badKills = kills.analysis.filter(k => k.points < 0).slice(0, 1);
                const example = badKills.length > 0 ? ` ${badKills[0].analysis}.` : '';
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Board Observer:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Your kill timing needs work.${example} Understanding when to persist vs. cut is a critical skill you should develop."</em></div>`);
            }
        }
        
        // Strategic bucket coverage feedback
        if (results.bucketCoverage) {
            const coverage = results.bucketCoverage;
            if (coverage.coveredBuckets === 4) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Strategy Director:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Full strategic coverage. Your portfolio touched all our key growth vectors. That's aligned thinking."</em></div>`);
            } else if (coverage.concentrationPenalty > 0) {
                feedback.push(`<div style="margin-bottom: 15px;"><strong>Strategy Director:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Concentration risk concerns me. Over 60% of budget in one strategic bucket exposes us to sector-specific downturns."</em></div>`);
            }
        }
        
        // Transformational success feedback
        if (results.transformationalSuccesses >= 2) {
            feedback.push(`<div style="margin-bottom: 15px;"><strong>Innovation Committee Chair:</strong><br/><em style="color: rgba(255,255,255,0.85);">"Multiple breakthrough wins! You proved that strategic risk-taking pays off when done thoughtfully. This is exactly what we hoped for."</em></div>`);
        } else if (results.transformationalCount === 0) {
            feedback.push(`<div style="margin-bottom: 15px;"><strong>Innovation Committee Chair:</strong><br/><em style="color: rgba(255,255,255,0.85);">"I'm concerned we had no transformational projects in the portfolio. Where's our next growth engine going to come from?"</em></div>`);
        }
        
        // Active management feedback
        if (results.activeManagementBonus && !results.activeManagementBonus.qualifies) {
            feedback.push(`<div><strong>HR Director:</strong><br/><em style="color: rgba(255,255,255,0.85);">"The portfolio seemed to run itself. Active management — making tough calls on when to accelerate, reduce, or kill — is part of the job."</em></div>`);
        }
        
        return feedback.join('');
    }
    
    function calculateResults() {
        let truePositives = 0, falsePositives = 0, falseNegatives = 0, trueNegatives = 0, totalRevenue = 0, totalSpent = 0, waste = 0, missed = 0;
        
        // Track risk class distribution of funded projects
        let incrementalCount = 0, moderateCount = 0, transformationalCount = 0;
        let incrementalSuccesses = 0, transformationalSuccesses = 0;
        
        gameState.completedProjects.forEach(p => {
            totalSpent += p.spentBudget;
            const riskClass = p.riskClass || getProjectRiskClass(p.archetype);
            
            if (riskClass === 'incremental') incrementalCount++;
            else if (riskClass === 'transformational') transformationalCount++;
            else moderateCount++;
            
            if (p.outcome === 'success') { 
                truePositives++; 
                totalRevenue += p.revenue;
                if (riskClass === 'incremental') incrementalSuccesses++;
                if (riskClass === 'transformational') transformationalSuccesses++;
            }
            else { falsePositives++; waste += p.spentBudget; }
        });
        
        // Count active projects too for portfolio composition
        gameState.activeProjects.forEach(p => {
            const riskClass = p.riskClass || getProjectRiskClass(p.archetype);
            if (riskClass === 'incremental') incrementalCount++;
            else if (riskClass === 'transformational') transformationalCount++;
            else moderateCount++;
        });
        
        gameState.killedProjects.forEach(p => {
            totalSpent += p.spentBudget;
            const wouldSucceed = Math.random() < p.successProb;
            p.wouldSucceed = wouldSucceed;
            if (wouldSucceed) { falseNegatives++; missed += p.budget * (p.roiMultiplier || 2.5); } else { trueNegatives++; }
        });
        
        gameState.rejectedProjects.forEach(p => {
            const wouldSucceed = Math.random() < p.successProb;
            p.wouldSucceed = wouldSucceed;
            if (wouldSucceed) { falseNegatives++; missed += p.budget * (p.roiMultiplier || 2.5); } else { trueNegatives++; }
        });
        
        const totalFunded = truePositives + falsePositives;
        const totalPortfolio = incrementalCount + moderateCount + transformationalCount;
        
        // Calculate Portfolio Balance Score
        const portfolioBalance = calculatePortfolioBalance(incrementalCount, moderateCount, transformationalCount, totalPortfolio);
        
        // Calculate Strategic Bucket Coverage
        const bucketCoverage = calculateBucketCoverage();
        
        // Calculate Kill Decision Quality
        const killQuality = calculateKillQuality();
        
        // Calculate Active Management Bonus
        const activeManagementBonus = calculateActiveManagementBonus();
        
        return {
            truePositives, falsePositives, falseNegatives, trueNegatives,
            hitRate: totalFunded > 0 ? Math.round((truePositives / totalFunded) * 100) : 0,
            roi: totalSpent > 0 ? Math.round(((totalRevenue - totalSpent) / totalSpent) * 100) : 0,
            waste, missed, totalRevenue, totalSpent,
            // New portfolio scoring dimensions
            portfolioBalance,
            bucketCoverage,
            killQuality,
            activeManagementBonus,
            // Risk distribution stats
            incrementalCount,
            moderateCount, 
            transformationalCount,
            incrementalSuccesses,
            transformationalSuccesses,
            totalPortfolio
        };
    }
    
    // Calculate portfolio balance multiplier based on risk mix
    function calculatePortfolioBalance(incremental, moderate, transformational, total) {
        if (total === 0) return { multiplier: 1.0, description: 'No projects to evaluate', category: 'neutral' };
        
        const incrementalPct = (incremental / total) * 100;
        const transformationalPct = (transformational / total) * 100;
        
        // All incremental - penalize playing it too safe
        if (incrementalPct >= 80) {
            return { 
                multiplier: 0.7, 
                description: 'Portfolio too conservative - all safe bets limit upside',
                category: 'too_safe'
            };
        }
        
        // All transformational - penalize reckless betting
        if (transformationalPct >= 80) {
            return { 
                multiplier: 0.8, 
                description: 'Portfolio too risky - no stable foundation',
                category: 'too_risky'
            };
        }
        
        // Heavily unbalanced (>70% either way)
        if (incrementalPct >= 70 || transformationalPct >= 70) {
            return { 
                multiplier: 0.9, 
                description: 'Portfolio somewhat unbalanced',
                category: 'unbalanced'
            };
        }
        
        // Optimal balance (some incremental, some transformational, room for moderate)
        const hasIncremental = incremental >= 1;
        const hasTransformational = transformational >= 1;
        const goodMix = hasIncremental && hasTransformational && incrementalPct >= 20 && transformationalPct >= 20;
        
        if (goodMix) {
            return { 
                multiplier: 1.1, 
                description: 'Excellent portfolio balance - stable foundation with growth bets',
                category: 'optimal'
            };
        }
        
        // Balanced but not optimal
        return { 
            multiplier: 1.0, 
            description: 'Reasonable portfolio balance',
            category: 'balanced'
        };
    }
    
    // Calculate strategic bucket coverage bonus/penalty
    function calculateBucketCoverage() {
        const bucketIds = ['defend-metro', 'tier23-rollout', 'recurring-revenue', 'ai-first'];
        const bucketCounts = {};
        let totalBudgetByBucket = {};
        let totalBudget = 0;
        
        bucketIds.forEach(id => {
            bucketCounts[id] = 0;
            totalBudgetByBucket[id] = 0;
        });
        
        // Count projects in each bucket (completed + active)
        const allProjects = [...gameState.completedProjects, ...gameState.activeProjects];
        allProjects.forEach(p => {
            totalBudget += p.budget;
            (p.strategicBuckets || []).forEach(bucket => {
                if (bucket && bucket.id) {
                    bucketCounts[bucket.id] = (bucketCounts[bucket.id] || 0) + 1;
                    totalBudgetByBucket[bucket.id] = (totalBudgetByBucket[bucket.id] || 0) + p.budget;
                }
            });
        });
        
        // Calculate coverage bonus (+5% per bucket with at least one project)
        const coveredBuckets = bucketIds.filter(id => bucketCounts[id] > 0).length;
        const coverageBonus = coveredBuckets * 0.05;
        
        // Calculate concentration penalty (-10% if >60% of budget in single bucket)
        let concentrationPenalty = 0;
        let concentratedBucket = null;
        bucketIds.forEach(id => {
            if (totalBudget > 0 && (totalBudgetByBucket[id] / totalBudget) > 0.6) {
                concentrationPenalty = 0.10;
                concentratedBucket = id;
            }
        });
        
        return {
            coveredBuckets,
            coverageBonus,
            concentrationPenalty,
            concentratedBucket,
            netBonus: coverageBonus - concentrationPenalty,
            bucketCounts,
            description: concentrationPenalty > 0 
                ? `${coveredBuckets}/4 buckets covered, but over-concentrated in one area`
                : `${coveredBuckets}/4 strategic buckets covered`
        };
    }
    
    // Calculate kill decision quality score
    function calculateKillQuality() {
        let killQualityPoints = 0;
        const killAnalysis = [];
        
        gameState.killDecisions.forEach(kill => {
            const quarter = kill.killedAtQuarter;
            const riskClass = kill.riskClass;
            const signal = kill.signalStrength;
            const wasGood = kill.wasPerformingWell;
            
            // Determine kill timing category
            let timing = 'mid'; // Q3-4
            if (quarter <= 2) timing = 'early'; // Q1-2
            else if (quarter >= 5) timing = 'late'; // Q5+
            
            // Score based on project type, timing, and signals
            let points = 0;
            let analysis = '';
            
            if (riskClass === 'incremental') {
                // Incremental projects with poor signals should be killed early/mid
                if (signal === 'red' || !wasGood) {
                    if (timing === 'early') { points = 5; analysis = 'Good discipline: killed underperforming safe bet early'; }
                    else if (timing === 'mid') { points = 3; analysis = 'Reasonable: killed struggling incremental project'; }
                    else { points = -3; analysis = 'Wasted resources: held failing incremental too long'; }
                } else {
                    // Incremental with good signals - killing is questionable
                    if (timing === 'early') { points = -3; analysis = 'Premature: killed promising incremental project'; }
                    else { points = 0; analysis = 'Neutral: killed performing incremental project'; }
                }
            } else if (riskClass === 'transformational') {
                // Transformational projects need patience - early kills are bad
                if (signal === 'red' || !wasGood) {
                    if (timing === 'early') { points = -5; analysis = 'Too hasty: transformational projects need runway'; }
                    else if (timing === 'mid') { points = 0; analysis = 'Reasonable: gave transformational project a chance'; }
                    else { points = 5; analysis = 'Good judgment: appropriate persistence before cutting'; }
                } else {
                    // Transformational with good signals - killing is very bad
                    if (timing === 'early') { points = -8; analysis = 'Major mistake: killed promising breakthrough project'; }
                    else if (timing === 'mid') { points = -5; analysis = 'Questionable: killed transformational project showing progress'; }
                    else { points = -3; analysis = 'Late pivot: killed breakthrough project that was working'; }
                }
            } else {
                // Moderate risk projects - balanced approach
                if (signal === 'red' || !wasGood) {
                    if (timing === 'early') { points = 2; analysis = 'Proactive: cut moderate-risk project showing problems'; }
                    else if (timing === 'mid') { points = 3; analysis = 'Good timing: killed struggling project mid-cycle'; }
                    else { points = 0; analysis = 'Late but reasonable: finally cut underperformer'; }
                } else {
                    points = -2; analysis = 'Questionable: killed moderate project that was on track';
                }
            }
            
            killQualityPoints += points;
            killAnalysis.push({
                projectName: kill.projectName,
                points,
                analysis,
                timing,
                riskClass,
                signal
            });
        });
        
        return {
            points: killQualityPoints,
            analysis: killAnalysis,
            totalKills: gameState.killDecisions.length,
            description: killQualityPoints > 5 
                ? 'Excellent kill discipline - you tended the portfolio well'
                : killQualityPoints < -5 
                    ? 'Poor kill timing - review when to cut vs. persist'
                    : 'Reasonable kill decisions overall'
        };
    }
    
    // Calculate active management bonus
    function calculateActiveManagementBonus() {
        const totalProjects = gameState.completedProjects.length + gameState.activeProjects.length + gameState.killedProjects.length;
        const decisionsRatio = totalProjects > 0 ? gameState.activeDecisionsMade / totalProjects : 0;
        
        // Active management bonus if player made decisions on 50%+ of projects
        const qualifies = decisionsRatio >= 0.5;
        const bonus = qualifies ? 5 : 0;
        
        return {
            bonus,
            decisionsRatio: Math.round(decisionsRatio * 100),
            qualifies,
            description: qualifies 
                ? 'Active portfolio management demonstrated'
                : 'Portfolio was largely passive - consider more active tending'
        };
    }
    
    function generateProcessInsights(results) {
        const insights = [];
        
        if (gameState.decisionModel === 'solo') {
            insights.push(`<div class="insight-item">You made all decisions alone. Speed was maximized but individual biases shaped the portfolio. ${results.falsePositives > 2 ? 'Several failures suggest blind spots.' : ''}</div>`);
        } else if (gameState.decisionModel === 'committee') {
            const names = gameState.committee.slice(0, 4).map(id => findStaff(id)?.name.split(' ')[0]).join(', ');
            const more = gameState.committee.length > 4 ? ` and ${gameState.committee.length - 4} others` : '';
            insights.push(`<div class="insight-item">Your committee (${names}${more}) brought ${gameState.committee.length} perspectives. ${results.truePositives > results.falsePositives ? 'Diverse views helped find opportunities.' : 'However, collective biases may have emerged.'}</div>`);
        } else if (gameState.decisionModel === 'jury') {
            insights.push(`<div class="insight-item">Staff jury selection democratized decisions. ${results.hitRate > 50 ? 'Fresh eyes found winners.' : 'Variable expertise led to inconsistent results.'}</div>`);
        } else {
            insights.push(`<div class="insight-item">Random selection removed bias entirely. ${results.hitRate}% hit rate shows expertise's value (or lack thereof) in uncertain domains.</div>`);
        }
        
        // Criteria-based insights
        const criteria = gameState.criteria;
        
        if (criteria.includes('strategic') && !criteria.includes('newmarket')) {
            insights.push(`<div class="insight-item">Prioritising strategic fit without new market creation may have led to internally coherent but incrementally focused choices.</div>`);
        }
        
        if (criteria.includes('marketsize') && !criteria.includes('sustainability')) {
            insights.push(`<div class="insight-item">Focus on market size without sustainability criteria may have missed emerging ESG-conscious segments.</div>`);
        }
        
        if (criteria.includes('devcost') && criteria.includes('roi')) {
            insights.push(`<div class="insight-item">Double emphasis on development cost and ROI created strong financial discipline — but may have filtered out higher-risk, higher-reward opportunities.</div>`);
        }
        
        if (criteria.includes('ip') && results.truePositives > 0) {
            insights.push(`<div class="insight-item">IP focus helped identify projects with defensible advantages. Consider if this came at the cost of speed to market.</div>`);
        }
        
        if (criteria.includes('geographic') && results.falseNegatives > 2) {
            insights.push(`<div class="insight-item">Geographic expansion focus may have overlooked strong opportunities in existing markets.</div>`);
        }
        
        if (criteria.includes('capability') && !criteria.includes('newmarket')) {
            insights.push(`<div class="insight-item">Strong focus on core capabilities without new market criteria may have reinforced existing strengths while missing adjacent opportunities.</div>`);
        }
        
        if (criteria.includes('risk') && results.falseNegatives > results.falsePositives) {
            insights.push(`<div class="insight-item">Risk-focused criteria protected against failures but may have filtered out promising uncertain opportunities (more false negatives than false positives).</div>`);
        }
        
        if (criteria.includes('speed') && !criteria.includes('platform')) {
            insights.push(`<div class="insight-item">Time-to-market focus without platform thinking may have favoured quick wins over long-term positioning.</div>`);
        }
        
        if (criteria.includes('technical') && results.falsePositives > 2) {
            insights.push(`<div class="insight-item">Technical feasibility was prioritised, but ${results.falsePositives} projects still failed. Technical excellence ≠ market success.</div>`);
        }
        
        return insights.length ? insights.join('') : '<div class="insight-item">Your process produced mixed results. Consider how different criteria choices might change outcomes.</div>';
    }
    
    function generateCounterfactuals() {
        const reveals = [];
        
        gameState.killedProjects.filter(p => p.wouldSucceed).slice(0, 3).forEach(p => {
            reveals.push(`<div class="insight-item" style="border-left-color: var(--warning);"><strong>${p.name}</strong> (Killed): Would have succeeded. ${p.outcomeNarrative.success}</div>`);
        });
        
        gameState.rejectedProjects.filter(p => p.wouldSucceed).slice(0, 3).forEach(p => {
            reveals.push(`<div class="insight-item" style="border-left-color: var(--warning);"><strong>${p.name}</strong> (Never funded): Would have succeeded. ${p.outcomeNarrative.success}</div>`);
        });
        
        const goodKills = gameState.killedProjects.filter(p => !p.wouldSucceed);
        if (goodKills.length) {
            reveals.push(`<div class="insight-item" style="border-left-color: var(--success);"><strong>Good calls:</strong> Killed ${goodKills.length} project(s) that would have failed.</div>`);
        }
        
        return reveals.length ? reveals.join('') : '<div class="insight-item">All decisions aligned with outcomes — impressive!</div>';
    }
    
    // PDF CASE STUDY GENERATOR
    // ============================================
    // Professional narrative case study format
    // ============================================
    
    function showToast(message, type = 'error') {
        const toast = document.createElement('div');
        let bgColor = 'var(--danger, #dc2626)';
        if (type === 'success') bgColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        else if (type === 'info') bgColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        
        toast.style.cssText = `
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: ${bgColor}; color: white; padding: 12px 24px;
            border-radius: 8px; font-size: 14px; z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function downloadPerformanceReport() {
        try {
            const caseStudy = buildCaseStudyModel();
            renderCaseStudyPDF(caseStudy);
        } catch (e) {
            console.error('PDF generation error:', e);
            showToast('PDF export failed. Check console for details.');
        }
    }

    // Build comprehensive case study data model
    function buildCaseStudyModel() {
        const results = typeof calculateResults === 'function' ? calculateResults() : computeBasicResults();
        const careerOutcome = typeof calculateCareerOutcome === 'function' ? calculateCareerOutcome(results) : { title: 'Career Outcome Pending', narrative: '' };
        
        const funded = []
            .concat(gameState.activeProjects || [])
            .concat(gameState.completedProjects || [])
            .concat(gameState.killedProjects || []);
        
        const completed = gameState.completedProjects || [];
        const killed = gameState.killedProjects || [];
        const rejected = gameState.rejectedProjects || [];
        const active = gameState.activeProjects || [];
        
        // Calculate financial metrics
        const spent = funded.reduce((sum, p) => sum + (Number(p.spentBudget ?? p.budget ?? 0) || 0), 0);
        const revenue = completed.reduce((sum, p) => sum + (Number(p.revenue ?? 0) || 0), 0);
        const successCount = completed.filter(p => p.outcome === 'success').length;
        const failureCount = completed.filter(p => p.outcome === 'failure').length;
        
        // Risk class counts
        const riskCounts = { incremental: 0, moderate: 0, transformational: 0 };
        funded.forEach(p => {
            const rc = p.riskClass || 'moderate';
            if (riskCounts[rc] !== undefined) riskCounts[rc]++;
        });

        // Build committee names
        const committeeNames = buildCommitteeNames();
        
        // Get decision approach description
        const approachDesc = getApproachDescription();
        
        // Get Year 1 project summaries
        const year1Projects = buildYear1ProjectSummary(funded);
        
        // Get killed project narratives
        const killNarratives = buildKillNarratives(killed);
        
        // Get Year 2 additions
        const year2Additions = buildYear2Additions();
        
        // Get outcome narratives
        const outcomeNarratives = buildOutcomeNarratives(completed);
        
        // Get counterfactual summary
        const counterfactualSummary = buildCounterfactualSummary(rejected, killed);
        
        // Generate lessons learned
        const lessons = buildLessonsLearned(results, riskCounts, funded.length);
        
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        
        return {
            // Metadata
            date: dateStr,
            filename: `ShieldTech-Case-Study-${now.toISOString().slice(0,10)}.pdf`,
            
            // Key outcomes
            hitRate: results.hitRate || 0,
            roi: results.roi || 0,
            successCount,
            fundedCount: funded.length,
            
            // Portfolio composition
            incrementalCount: riskCounts.incremental,
            moderateCount: riskCounts.moderate,
            transformationalCount: riskCounts.transformational,
            
            // Narrative elements
            committeeNames,
            approachDesc,
            year1Projects,
            killNarratives,
            year2Additions,
            outcomeNarratives,
            counterfactualSummary,
            lessons,
            careerOutcome,
            
            // Raw data for scorecard
            killedCount: killed.length,
            activeCount: active.length,
            completedCount: completed.length,
            failureCount,
            spent,
            revenue,
            
            // Kill quality for scorecard
            killQuality: results.killQuality?.points || 0,
            missedOpportunities: results.falseNegatives || 0,
            goodRejections: results.trueNegatives || 0,
            bucketsCovered: results.bucketCoverage?.covered || 4
        };
    }
    
    function computeBasicResults() {
        const completed = gameState.completedProjects || [];
        const killed = gameState.killedProjects || [];
        const funded = completed.concat(killed).concat(gameState.activeProjects || []);
        
        const successes = completed.filter(p => p.outcome === 'success').length;
        const failures = completed.filter(p => p.outcome === 'failure').length;
        const spent = funded.reduce((s, p) => s + (Number(p.spentBudget ?? p.budget ?? 0) || 0), 0);
        const revenue = completed.reduce((s, p) => s + (Number(p.revenue ?? 0) || 0), 0);
        
        return {
            hitRate: (successes + failures) > 0 ? Math.round((successes / (successes + failures)) * 100) : 0,
            roi: spent > 0 ? Math.round(((revenue - spent) / spent) * 100) : 0,
            truePositives: successes,
            falsePositives: failures,
            falseNegatives: 0,
            trueNegatives: 0
        };
    }
    
    function buildCommitteeNames() {
        const committee = gameState.committee || ['meera'];
        const nameMap = {
            meera: 'Meera Venkataraman',
            sanjay: 'Sanjay Hegde',
            priya: 'Priya Sharma',
            harpreet: 'Harpreet Singh',
            farhan: 'Farhan Qureshi',
            anita: 'Anita Desai',
            rahul: 'Rahul Krishnan'
        };
        return committee.map(id => nameMap[id] || id).join(' and ');
    }
    
    function getApproachDescription() {
        const approach = gameState.scoringApproach || 'careful';
        const blinding = gameState.teamBlinding || 'visible';
        
        let desc = '';
        if (approach === 'delegate') {
            desc = 'The VP delegated evaluation to the committee, trusting collective judgment over individual analysis.';
        } else if (approach === 'rapid') {
            desc = 'The VP conducted rapid assessments, prioritizing speed and gut instinct over exhaustive analysis.';
        } else {
            desc = 'The VP led careful, systematic evaluation of each proposal against strategic criteria.';
        }
        
        if (blinding === 'blind') {
            desc += ' Team information was hidden during evaluation to reduce bias.';
        }
        
        return desc;
    }
    
    function buildYear1ProjectSummary(funded) {
        const year1 = funded.filter(p => !p.addedInYear2);
        if (year1.length === 0) return 'No projects were selected in Year One.';
        
        const totalBudget = year1.reduce((s, p) => s + (Number(p.budget ?? 0) || 0), 0);
        
        const lines = [];
        year1.slice(0, 5).forEach(p => {
            const budget = (Number(p.budget ?? 0) || 0).toFixed(1);
            const risk = p.riskClass || 'moderate';
            const reason = p.strategicRationale || p.description || 'Strategic opportunity for growth.';
            lines.push(`${p.name} ($${budget}M) — ${reason.substring(0, 100)}${reason.length > 100 ? '...' : ''}`);
        });
        
        if (year1.length > 5) {
            lines.push(`...and ${year1.length - 5} additional projects.`);
        }
        
        return {
            summary: `After evaluation, the committee selected ${year1.length} projects for Year One funding, committing $${totalBudget.toFixed(1)} million of the available budget:`,
            projects: lines
        };
    }
    
    function buildKillNarratives(killed) {
        if (killed.length === 0) {
            return { hasKills: false, narrative: 'No projects were terminated during the simulation period.' };
        }
        
        const sample = killed.find(p => p.killReason) || killed[0];
        const projectName = sample.name || 'a struggling project';
        const reason = sample.killReason || 'persistent performance issues';
        
        return {
            hasKills: true,
            narrative: `Perhaps the most difficult decision came when ${projectName} showed persistent red flags. The project had consumed budget with limited progress. Team morale was suffering. Yet killing a project meant admitting failure, writing off sunk costs, and potentially demoralising the broader organisation.`,
            resolution: `The VP chose to terminate. The reasoning was straightforward: continuing would consume resources with low probability of success, while freed capacity could flow to higher-potential projects. The decision was announced transparently, with the team reassigned rather than blamed. It would prove to be the right call — the project had fundamental problems that execution alone could not fix.`,
            count: killed.length
        };
    }
    
    function buildYear2Additions() {
        const funded = []
            .concat(gameState.activeProjects || [])
            .concat(gameState.completedProjects || [])
            .concat(gameState.killedProjects || []);
        
        const year2Projects = funded.filter(p => p.addedInYear2);
        
        if (year2Projects.length === 0) {
            return { hasAdditions: false, text: 'The portfolio remained stable entering Year Two, with focus on executing existing commitments.' };
        }
        
        const names = year2Projects.slice(0, 3).map(p => p.name).join(', ');
        return {
            hasAdditions: true,
            text: `Entering Year Two, the portfolio had evolved. ${year2Projects.length} new project${year2Projects.length > 1 ? 's were' : ' was'} added: ${names}. These reflected lessons learned — maintaining strategic coverage while building on emerging strengths.`
        };
    }
    
    function buildOutcomeNarratives(completed) {
        const successes = completed.filter(p => p.outcome === 'success');
        const failures = completed.filter(p => p.outcome === 'failure');
        
        const narratives = [];
        
        if (successes.length > 0) {
            const topSuccess = successes.reduce((a, b) => 
                (Number(a.revenue ?? 0) > Number(b.revenue ?? 0)) ? a : b
            );
            narratives.push(`${topSuccess.name} demonstrated that the selection process could identify winners. ${topSuccess.successNarrative || 'Defined new category in its market segment. Premium enterprise pricing achieved.'}`);
        }
        
        if (failures.length > 0) {
            const failNames = failures.slice(0, 2).map(p => p.name).join(' and ');
            narratives.push(`${failures.length} project${failures.length > 1 ? 's' : ''} failed to meet objectives. ${failNames} ${failures.length > 1 ? 'were' : 'was'} among those that didn't achieve target outcomes. These outcomes, while disappointing, are inherent to innovation portfolios — not every bet pays off.`);
        }
        
        return narratives;
    }
    
    function buildCounterfactualSummary(rejected, killed) {
        const fnCount = [...rejected, ...killed].filter(p => p.wouldSucceed).length;
        const tnCount = [...rejected, ...killed].filter(p => !p.wouldSucceed).length;
        
        return {
            missedOpportunities: fnCount,
            goodRejections: tnCount,
            text: `Counterfactual analysis revealed important patterns. ${fnCount} rejected project${fnCount !== 1 ? 's' : ''} would likely have succeeded — opportunities the selection process failed to identify. However, ${tnCount} rejection${tnCount !== 1 ? 's were' : ' was'} validated — these projects would have failed, and avoiding them preserved resources for better uses.`
        };
    }
    
    function buildLessonsLearned(results, riskCounts, fundedCount) {
        const lessons = [];
        
        // Lesson 1: Portfolio composition
        const totalRisk = riskCounts.incremental + riskCounts.moderate + riskCounts.transformational;
        if (totalRisk > 0) {
            const transformPct = Math.round((riskCounts.transformational / totalRisk) * 100);
            if (transformPct > 40) {
                lessons.push('First, portfolio composition shaped outcomes significantly. The heavy weighting toward transformational bets increased both upside potential and volatility.');
            } else if (transformPct < 15) {
                lessons.push('First, portfolio composition shaped outcomes significantly. The conservative weighting improved predictability but may have limited breakthrough opportunities.');
            } else {
                lessons.push('First, portfolio composition shaped outcomes significantly. The balance between safe bets and ambitious projects determined both the floor and ceiling of possible results.');
            }
        }
        
        // Lesson 2: Kill discipline
        const killedCount = (gameState.killedProjects || []).length;
        if (killedCount > 0) {
            lessons.push(`Second, killing projects is a feature, not a bug. The early termination of ${killedCount} struggling project${killedCount > 1 ? 's' : ''} freed resources for higher-value work and limited losses. Too many R&D organisations treat project kills as failures rather than rational portfolio management decisions.`);
        } else {
            lessons.push('Second, active portfolio management matters. Knowing when to cut losses on struggling projects frees resources for higher-value work. The reluctance to kill projects can lead to resource drain.');
        }
        
        // Lesson 3: Uncertainty
        lessons.push('Finally, uncertainty is irreducible. Despite careful analysis, some failures were unavoidable and some opportunities were missed. The goal is not perfect prediction but systematic improvement in hit rates over time.');
        
        return lessons;
    }

    // ============================================
    // PDF RENDERING - Professional Case Study Format
    // ============================================
    
    function renderCaseStudyPDF(cs) {
        const pageW = 595.28; // A4 points
        const pageH = 841.89;
        const margin = 50;
        const contentWidth = pageW - (margin * 2);
        
        const pages = [];
        let currentPage = [];
        let y = pageH - margin;
        
        // Font sizes
        const TITLE_SIZE = 24;
        const HEADING_SIZE = 14;
        const SUBHEAD_SIZE = 11;
        const BODY_SIZE = 10;
        const SMALL_SIZE = 9;
        const FOOTER_SIZE = 8;
        
        // Leading
        const BODY_LEADING = 14;
        const HEADING_LEADING = 18;
        
        function newPage() {
            if (currentPage.length > 0) {
                pages.push(currentPage);
            }
            currentPage = [];
            y = pageH - margin;
        }
        
        function ensureSpace(needed) {
            if (y - needed < margin + 40) {
                newPage();
            }
        }
        
        function addText(fontKey, size, x, yPos, text, color) {
            currentPage.push({ type: 'text', fontKey, size, x, y: yPos, txt: escPdf(text), color });
        }
        
        function addRect(x, yPos, w, h, fill, stroke, lineW) {
            currentPage.push({ type: 'rect', x, y: yPos, w, h, fill, stroke, lineW });
        }
        
        function addLine(x1, y1, x2, y2, color, lineW) {
            currentPage.push({ type: 'line', x1, y1, x2, y2, color, lineW });
        }
        
        function escPdf(s) {
            return String(s || '')
                .replace(/\\/g, '\\\\')
                .replace(/\(/g, '\\(')
                .replace(/\)/g, '\\)')
                .replace(/[\r\n]+/g, ' ');
        }
        
        function wrapText(text, maxChars) {
            const words = String(text || '').split(/\s+/).filter(Boolean);
            const lines = [];
            let line = '';
            for (const w of words) {
                const cand = line ? (line + ' ' + w) : w;
                if (cand.length <= maxChars) {
                    line = cand;
                } else {
                    if (line) lines.push(line);
                    line = w.length > maxChars ? w.substring(0, maxChars) : w;
                }
            }
            if (line) lines.push(line);
            return lines.length ? lines : [''];
        }
        
        function writeWrappedText(text, maxChars, fontKey, size, leading, xPos) {
            const lines = wrapText(text, maxChars);
            lines.forEach(line => {
                ensureSpace(leading);
                addText(fontKey, size, xPos, y, line);
                y -= leading;
            });
        }
        
        function drawHeading(text) {
            ensureSpace(HEADING_LEADING + 10);
            y -= 8;
            addText('F2', HEADING_SIZE, margin, y, text);
            y -= HEADING_LEADING;
        }
        
        function drawParagraph(text) {
            writeWrappedText(text, 85, 'F1', BODY_SIZE, BODY_LEADING, margin);
            y -= 6;
        }
        
        function drawBullet(text) {
            const lines = wrapText(text, 80);
            ensureSpace(lines.length * BODY_LEADING);
            lines.forEach((line, i) => {
                if (i === 0) {
                    addText('F1', BODY_SIZE, margin, y, '•');
                    addText('F1', BODY_SIZE, margin + 12, y, line);
                } else {
                    addText('F1', BODY_SIZE, margin + 12, y, line);
                }
                y -= BODY_LEADING;
            });
        }
        
        // ============================================
        // PAGE 1: Title and Abstract
        // ============================================
        newPage();
        
        // Title
        addText('F2', TITLE_SIZE, margin, y, 'BUILD, BIN, BOOST');
        y -= 28;
        addText('F1', SUBHEAD_SIZE, margin, y, 'The R&D Portfolio Simulation');
        y -= 20;
        addText('F1', SMALL_SIZE, margin, y, cs.date);
        y -= 30;
        
        // Subtitle
        addText('F2', 16, margin, y, 'ShieldTech India:');
        y -= 20;
        addText('F2', 16, margin, y, 'Two Years in R&D Leadership');
        y -= 16;
        addText('F3', BODY_SIZE, margin, y, 'Your portfolio management case study');
        y -= 30;
        
        // Abstract Section
        addText('F2', HEADING_SIZE, margin, y, 'ABSTRACT');
        y -= 18;
        
        const abstractText = `This case study examines the strategic decisions made during a two-year tenure as VP of R&D at ShieldTech India, a mid-sized security technology company based in Bangalore. The portfolio comprised ${cs.incrementalCount} incremental, ${cs.moderateCount} moderate-risk, and ${cs.transformationalCount} transformational projects. Through a combination of delegated assessment, active portfolio management, and difficult termination decisions, the R&D function achieved a ${cs.hitRate}% hit rate and ${cs.roi}% ROI. The case offers insights into innovation portfolio management, decision-making under uncertainty, and the balance between exploitation and exploration.`;
        
        writeWrappedText(abstractText, 85, 'F1', BODY_SIZE, BODY_LEADING, margin);
        y -= 15;
        
        // Key Outcomes Box
        ensureSpace(80);
        const boxTop = y;
        const boxHeight = 50;
        addRect(margin, y - boxHeight, contentWidth, boxHeight, 0.95, 0.3, 0.5);
        
        addText('F2', SUBHEAD_SIZE, margin + 10, y - 15, 'KEY OUTCOMES');
        y -= 35;
        
        const col1 = margin + 10;
        const col2 = margin + 140;
        const col3 = margin + 280;
        const col4 = margin + 400;
        
        addText('F2', BODY_SIZE, col1, y, `Portfolio Hit Rate: ${cs.hitRate}%`);
        addText('F2', BODY_SIZE, col2, y, `ROI: ${cs.roi >= 0 ? '+' : ''}${cs.roi}%`);
        addText('F2', BODY_SIZE, col3, y, `Projects Launched: ${cs.successCount} of ${cs.fundedCount}`);
        
        y = boxTop - boxHeight - 15;
        
        // Career outcome teaser
        const careerShort = cs.careerOutcome.title || 'Career Outcome Determined';
        addText('F2', BODY_SIZE, margin, y, `Career Outcome: ${careerShort}`);
        y -= 25;
        
        // Footer for page 1
        addLine(margin, 35, pageW - margin, 35, 0.7, 0.5);
        addText('F3', FOOTER_SIZE, margin, 25, 'Build, Bin, Boost: The R&D Portfolio Simulation');
        addText('F1', FOOTER_SIZE, pageW - margin - 50, 25, 'Page 1');
        
        // ============================================
        // PAGE 2: The Situation & Assembling the Team
        // ============================================
        newPage();
        
        drawHeading('The Situation');
        
        const situationP1 = `When appointed VP of R&D at ShieldTech India in early 2024, the incoming leader faced a portfolio in transition. The company, a $290 million security technology manufacturer, had built its reputation on reliable hardware — CCTV cameras, access control systems, and perimeter sensors for the Indian market. But the competitive landscape was shifting. Chinese manufacturers were undercutting on price. Software-defined security was emerging. And the board had mandated a push into AI-enabled products and recurring revenue services.`;
        drawParagraph(situationP1);
        
        const situationP2 = `The R&D budget stood at $46 million for the coming year, with four strategic priorities defined by the executive team: defend market share in metro cities, expand into Tier 2 and 3 towns, build recurring revenue through services, and establish AI-first product capabilities. A portfolio of project proposals awaited evaluation, ranging from incremental camera upgrades to ambitious autonomous systems. Legacy projects from the previous regime also required decisions — continue, accelerate, reduce scope, or kill.`;
        drawParagraph(situationP2);
        
        y -= 10;
        drawHeading('Assembling the Team');
        
        const teamP1 = `The new VP's first decision was how to structure the evaluation process. Rather than relying solely on personal judgment, a selection committee was assembled: ${cs.committeeNames} would bring diverse perspectives to portfolio decisions.`;
        drawParagraph(teamP1);
        
        drawParagraph(cs.approachDesc + ' This distributed the cognitive load but required alignment on criteria.');
        
        y -= 10;
        drawHeading('Year One: Building the Portfolio');
        
        if (typeof cs.year1Projects === 'object' && cs.year1Projects.summary) {
            drawParagraph(cs.year1Projects.summary);
            y -= 5;
            cs.year1Projects.projects.forEach(proj => {
                drawBullet(proj);
            });
        } else {
            drawParagraph(cs.year1Projects || 'Projects were selected for Year One.');
        }
        
        y -= 8;
        const balanceText = `The portfolio reflected deliberate balance: ${cs.incrementalCount} incremental projects provided near-term revenue protection, while ${cs.transformationalCount} transformational bet${cs.transformationalCount !== 1 ? 's' : ''} pursued breakthrough opportunities. ${cs.moderateCount} moderate-risk projects filled the middle ground. This mix aimed to balance exploitation of current strengths with exploration of new possibilities.`;
        drawParagraph(balanceText);
        
        // Footer
        addLine(margin, 35, pageW - margin, 35, 0.7, 0.5);
        addText('F3', FOOTER_SIZE, margin, 25, 'Build, Bin, Boost: The R&D Portfolio Simulation');
        addText('F1', FOOTER_SIZE, pageW - margin - 50, 25, 'Page 2');
        
        // ============================================
        // PAGE 3: Navigating Uncertainty & Difficult Decisions
        // ============================================
        newPage();
        
        drawHeading('Navigating Uncertainty');
        
        drawParagraph('The first quarter passed as teams mobilised. But subsequent quarters brought real tests of portfolio management skill. Resource conflicts emerged. External pressures mounted. And some projects began showing concerning signals.');
        
        y -= 10;
        drawHeading('The Difficult Decisions');
        
        if (cs.killNarratives.hasKills) {
            drawParagraph(cs.killNarratives.narrative);
            drawParagraph(cs.killNarratives.resolution);
        } else {
            drawParagraph('Throughout the simulation, the VP maintained confidence in the selected portfolio. While some projects faced challenges, none were terminated early. This approach preserved team momentum but meant resources remained committed to all funded initiatives.');
        }
        
        y -= 10;
        drawHeading('Year Two: Adaptation');
        
        drawParagraph(cs.year2Additions.text);
        
        drawParagraph('Active portfolio management continued throughout. When projects hit obstacles, interventions were considered — additional resources, scope adjustments, or staged reviews. Each decision reflected a philosophy of incremental commitment: invest progressively, reassess frequently, pivot when evidence warranted.');
        
        // Footer
        addLine(margin, 35, pageW - margin, 35, 0.7, 0.5);
        addText('F3', FOOTER_SIZE, margin, 25, 'Build, Bin, Boost: The R&D Portfolio Simulation');
        addText('F1', FOOTER_SIZE, pageW - margin - 50, 25, 'Page 3');
        
        // ============================================
        // PAGE 4: Outcomes & Scorecard
        // ============================================
        newPage();
        
        drawHeading('Outcomes');
        
        const outcomeIntro = `By the end of Year Two, the portfolio had delivered ${cs.successCount} successful product launch${cs.successCount !== 1 ? 'es' : ''}.`;
        drawParagraph(outcomeIntro);
        
        cs.outcomeNarratives.forEach(narrative => {
            drawParagraph(narrative);
        });
        
        drawParagraph(cs.counterfactualSummary.text);
        
        y -= 15;
        
        // Portfolio Scorecard Box
        ensureSpace(180);
        addText('F2', HEADING_SIZE, margin, y, 'PORTFOLIO SCORECARD');
        y -= 20;
        
        const scoreBoxTop = y;
        const scoreBoxH = 150;
        addRect(margin, y - scoreBoxH, contentWidth, scoreBoxH, 0.97, 0.4, 0.5);
        
        // Scorecard content in two columns
        const leftCol = margin + 15;
        const rightCol = margin + contentWidth/2 + 15;
        let scoreY = y - 18;
        
        const scoreItems = [
            [`Successful launches: ${cs.successCount}`, `Failed projects: ${cs.failureCount} (${cs.killedCount} killed early)`],
            [`Portfolio hit rate: ${cs.hitRate}%`, `Portfolio ROI: ${cs.roi >= 0 ? '+' : ''}${cs.roi}%`],
            [`Strategic buckets covered: ${cs.bucketsCovered} of 4`, `Kill decision quality: ${cs.killQuality >= 0 ? '+' : ''}${cs.killQuality} points`],
            [`Missed opportunities: ${cs.missedOpportunities}`, `Good rejections: ${cs.goodRejections}`]
        ];
        
        scoreItems.forEach(row => {
            addText('F1', BODY_SIZE, leftCol, scoreY, row[0]);
            addText('F1', BODY_SIZE, rightCol, scoreY, row[1]);
            scoreY -= 18;
        });
        
        y = scoreBoxTop - scoreBoxH - 20;
        
        // Footer
        addLine(margin, 35, pageW - margin, 35, 0.7, 0.5);
        addText('F3', FOOTER_SIZE, margin, 25, 'Build, Bin, Boost: The R&D Portfolio Simulation');
        addText('F1', FOOTER_SIZE, pageW - margin - 50, 25, 'Page 4');
        
        // ============================================
        // PAGE 5: Lessons Learned & Career Outcome
        // ============================================
        newPage();
        
        drawHeading('Lessons Learned');
        
        cs.lessons.forEach(lesson => {
            drawParagraph(lesson);
        });
        
        y -= 15;
        drawHeading('Career Outcome');
        
        const careerText = cs.careerOutcome.narrative || `Your portfolio achieved ${cs.successCount} success(es) with a ${cs.hitRate}% hit rate. The board has evaluated your performance and determined your next role.`;
        drawParagraph(careerText);
        
        y -= 30;
        
        // Credits
        addLine(margin, y, pageW - margin, y, 0.5, 0.5);
        y -= 20;
        addText('F3', SMALL_SIZE, margin, y, 'Developed by Ammon Salter, Warwick Business School');
        y -= 14;
        addText('F3', SMALL_SIZE, margin, y, 'Built with Claude, GPT-5 & Gemini | Build, Bin, Boost: The R&D Portfolio Simulation');
        
        // Footer
        addLine(margin, 35, pageW - margin, 35, 0.7, 0.5);
        addText('F3', FOOTER_SIZE, margin, 25, 'Build, Bin, Boost: The R&D Portfolio Simulation');
        addText('F1', FOOTER_SIZE, pageW - margin - 50, 25, 'Page 5');
        
        // Finalize
        if (currentPage.length > 0) {
            pages.push(currentPage);
        }
        
        // Build and download PDF
        const pdfBytes = buildCaseStudyPdfBytes(pages, pageW, pageH);
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = cs.filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
    }
    
    function buildCaseStudyPdfBytes(pages, pageW, pageH) {
        // Build a minimal but complete PDF with proper structure
        const objects = [];
        
        // Object 1: Catalog
        objects.push('<< /Type /Catalog /Pages 2 0 R >>');
        
        // Object 2: Pages parent
        const pageRefs = pages.map((_, i) => `${4 + i * 2} 0 R`).join(' ');
        objects.push(`<< /Type /Pages /Kids [${pageRefs}] /Count ${pages.length} >>`);
        
        // Object 3: Font resources
        objects.push(`<< /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica /Encoding /WinAnsiEncoding >> /F2 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica-Bold /Encoding /WinAnsiEncoding >> /F3 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica-Oblique /Encoding /WinAnsiEncoding >> >> >>`);
        
        // Create page objects and content streams
        pages.forEach((pageOps, idx) => {
            const contentObjNum = 5 + idx * 2;
            const stream = buildPageContentStream(pageOps);
            const streamBytes = new TextEncoder().encode(stream);
            
            // Page object
            objects.push(`<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageW} ${pageH}] /Contents ${contentObjNum} 0 R /Resources 3 0 R >>`);
            
            // Content stream object
            objects.push(`<< /Length ${streamBytes.length} >>\nstream\n${stream}\nendstream`);
        });
        
        // Build the PDF file
        let pdf = '%PDF-1.4\n%âãÏÓ\n';
        const offsets = [];
        
        objects.forEach((obj, idx) => {
            offsets.push(pdf.length);
            pdf += `${idx + 1} 0 obj\n${obj}\nendobj\n`;
        });
        
        const xrefStart = pdf.length;
        pdf += 'xref\n';
        pdf += `0 ${objects.length + 1}\n`;
        pdf += '0000000000 65535 f \n';
        offsets.forEach(off => {
            pdf += String(off).padStart(10, '0') + ' 00000 n \n';
        });
        
        pdf += 'trailer\n';
        pdf += `<< /Size ${objects.length + 1} /Root 1 0 R >>\n`;
        pdf += 'startxref\n';
        pdf += `${xrefStart}\n`;
        pdf += '%%EOF';
        
        return new TextEncoder().encode(pdf);
    }
    
    function buildPageContentStream(ops) {
        const parts = [];
        
        ops.forEach(op => {
            if (op.type === 'rect') {
                parts.push('q');
                // Fill color (grayscale)
                if (op.fill !== undefined) {
                    parts.push(`${op.fill.toFixed(2)} g`);
                }
                // Stroke color
                if (op.stroke !== undefined) {
                    parts.push(`${op.stroke.toFixed(2)} G`);
                }
                // Line width
                parts.push(`${(op.lineW || 0.5).toFixed(2)} w`);
                // Rectangle path
                parts.push(`${op.x.toFixed(2)} ${op.y.toFixed(2)} ${op.w.toFixed(2)} ${op.h.toFixed(2)} re`);
                // Fill and stroke
                parts.push('B');
                parts.push('Q');
            } else if (op.type === 'line') {
                parts.push('q');
                parts.push(`${(op.color || 0).toFixed(2)} G`);
                parts.push(`${(op.lineW || 0.5).toFixed(2)} w`);
                parts.push(`${op.x1.toFixed(2)} ${op.y1.toFixed(2)} m`);
                parts.push(`${op.x2.toFixed(2)} ${op.y2.toFixed(2)} l`);
                parts.push('S');
                parts.push('Q');
            } else if (op.type === 'text') {
                parts.push('BT');
                // Text color (default black)
                if (op.color !== undefined) {
                    parts.push(`${op.color.toFixed(2)} g`);
                } else {
                    parts.push('0 g');
                }
                parts.push(`/${op.fontKey} ${op.size} Tf`);
                parts.push(`1 0 0 1 ${op.x.toFixed(2)} ${op.y.toFixed(2)} Tm`);
                parts.push(`(${op.txt}) Tj`);
                parts.push('ET');
            }
        });
        
        return parts.join('\n');
    }

    
    function restartGame() {
        gameState = {
            phase: 'landing', decisionModel: null, committee: ['meera'], criteria: [],
            criteriaWeights: {},
            budget: 40, maxBudget: 40, 
            extraBudgetRequested: false, extraBudgetPerformanceBar: false,
            bootlegOffered: false, bootlegAccepted: false,
            selectedProjects: [], activeProjects: [],
            completedProjects: [], killedProjects: [], rejectedProjects: [],
            currentQuarter: 1, maxQuarters: 8, currentModalStaff: null, 
            currentModalProject: null, rankedProjects: null, projectPool: [],
            currentAssessmentIndex: 0,
            // Legacy project state
            legacyProjects: [], legacyBudget: { committed: 0, spent: 0, freed: 0 },
            legacyBudgetCommitted: 0, activeLegacyProjects: [], pausedProjects: [],
            currentLegacyProject: null, freedFromLegacy: 0,
            // Budget protection flag
            year1SelectionLocked: false,
            // Corporate events state
            currentEvent: null, activeEffects: [], eventHistory: [], pendingEventCallback: null,
            // Kill decision tracking for portfolio scoring
            killDecisions: [],
            activeDecisionsMade: 0
        };
        document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.criteria-card').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.criteria-tile').forEach(c => c.classList.remove('selected'));
        showPhase('landing');
    }
    
    // ========== COMMITTEE CHAOS MINI-GAME (EMBEDDED) ==========
    
    var CC_GAME_BASE64 = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+Q29tbWl0dGVlIENoYW9zPC90aXRsZT4KICAgIDxzdHlsZT4KICAgICAgICAqIHsgbWFyZ2luOiAwOyBwYWRkaW5nOiAwOyBib3gtc2l6aW5nOiBib3JkZXItYm94OyB9CiAgICAgICAgCiAgICAgICAgOnJvb3QgewogICAgICAgICAgICAtLWF1YmVyZ2luZTogIzVDMkQ1QzsKICAgICAgICAgICAgLS1hdWJlcmdpbmUtbGlnaHQ6ICM3QTQwODA7CiAgICAgICAgICAgIC0tZ29sZDogI0M5QTIyNzsKICAgICAgICAgICAgLS1nb2xkLWxpZ2h0OiAjRThDNTQ3OwogICAgICAgICAgICAtLXN1Y2Nlc3M6ICMxNkEzNEE7CiAgICAgICAgICAgIC0td2FybmluZzogI0Q5NzcwNjsKICAgICAgICAgICAgLS1kYW5nZXI6ICNEQzI2MjY7CiAgICAgICAgICAgIC0tYmctcGFnZTogI0YwRUJFMzsKICAgICAgICAgICAgLS1iZy13aGl0ZTogI0ZGRkZGRjsKICAgICAgICAgICAgLS1iZy1jcmVhbTogI0ZBRjhGNTsKICAgICAgICAgICAgLS1iZy1saWdodDogI0Y1RjBFODsKICAgICAgICAgICAgLS10ZXh0LWRhcms6ICMxRjI5Mzc7CiAgICAgICAgICAgIC0tdGV4dC1tZWRpdW06ICM0QjU1NjM7CiAgICAgICAgICAgIC0tdGV4dC1saWdodDogIzZCNzI4MDsKICAgICAgICAgICAgLS1ib3JkZXI6ICNEMUM3Qjc7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGJvZHkgewogICAgICAgICAgICBmb250LWZhbWlseTogJ1NlZ29lIFVJJywgc3lzdGVtLXVpLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy1wYWdlKTsKICAgICAgICAgICAgaGVpZ2h0OiAxMDB2aDsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IHN0cmV0Y2g7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nOiAwOwogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5nYW1lLWNvbnRhaW5lciB7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBoZWlnaHQ6IDEwMHZoOwogICAgICAgICAgICBtYXgtd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLXdoaXRlKTsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogPT09PT09PT09PSBUSVRMRSBTQ1JFRU4gPT09PT09PT09PSAqLwogICAgICAgIC50aXRsZS1zY3JlZW4gewogICAgICAgICAgICBwYWRkaW5nOiAzdmggM3Z3OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCB2YXIoLS1iZy1jcmVhbSkgMCUsIHZhcigtLWJnLXdoaXRlKSAxMDAlKTsKICAgICAgICAgICAgb3ZlcmZsb3cteTogYXV0bzsKICAgICAgICAgICAgaGVpZ2h0OiAxMDB2aDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnRpdGxlLWhlYWRlciB7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogM3ZoOwogICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMnZoOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnRpdGxlLWhlYWRlciBoMSB7IAogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDEuOGVtLCA1dncsIDNlbSk7IAogICAgICAgICAgICBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgCiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICB9CiAgICAgICAgLnRpdGxlLWhlYWRlciAuc3VidGl0bGUgeyAKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjllbSwgMnZ3LCAxLjNlbSk7IAogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAudHV0b3JpYWwtY29udGFpbmVyIHsKICAgICAgICAgICAgbWF4LXdpZHRoOiA5MDBweDsKICAgICAgICAgICAgbWFyZ2luOiAwIGF1dG87CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC50dXRvcmlhbC1zZWN0aW9uIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctbGlnaHQpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICAgICAgICBwYWRkaW5nOiAydmggMnZ3OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAydmg7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC50dXRvcmlhbC1zZWN0aW9uIGgzIHsKICAgICAgICAgICAgY29sb3I6IHZhcigtLWF1YmVyZ2luZSk7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC45NWVtLCAyLjJ2dywgMS4zZW0pOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxLjV2aDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnR1dG9yaWFsLXNlY3Rpb24gcCB7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuODVlbSwgMS44dncsIDEuMWVtKTsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDEuNjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMS41dmg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5oaWdobGlnaHQgeyBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgZm9udC13ZWlnaHQ6IDcwMDsgfQogICAgICAgIC5kYW5nZXItdGV4dCB7IGNvbG9yOiB2YXIoLS1kYW5nZXIpOyBmb250LXdlaWdodDogNjAwOyB9CiAgICAgICAgLnN1Y2Nlc3MtdGV4dCB7IGNvbG9yOiB2YXIoLS1zdWNjZXNzKTsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIAogICAgICAgIC50d28tY29sIHsKICAgICAgICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMWZyOwogICAgICAgICAgICBnYXA6IDJ2dzsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmluZm8tcm93IHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgZ2FwOiAxLjV2dzsKICAgICAgICAgICAgcGFkZGluZzogMS41dmggMS41dnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLXdoaXRlKTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMS41dmg7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgfQogICAgICAgIC5pbmZvLXJvdzpsYXN0LWNoaWxkIHsgbWFyZ2luLWJvdHRvbTogMDsgfQogICAgICAgIC5pbmZvLXJvdyAuaS1pY29uIHsgZm9udC1zaXplOiBjbGFtcCgxLjJlbSwgMi41dncsIDEuNmVtKTsgbWluLXdpZHRoOiAzNXB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7IH0KICAgICAgICAuaW5mby1yb3cgLmktbmFtZSB7IGZvbnQtd2VpZ2h0OiA3MDA7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyBmb250LXNpemU6IGNsYW1wKDAuODVlbSwgMS44dncsIDEuMWVtKTsgbWluLXdpZHRoOiA4MHB4OyB9CiAgICAgICAgLmluZm8tcm93IC5pLWRlc2MgeyBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOyBmb250LXNpemU6IGNsYW1wKDAuNzhlbSwgMS42dncsIDFlbSk7IGZsZXg6IDE7IGxpbmUtaGVpZ2h0OiAxLjU7IH0KICAgICAgICAuaW5mby1yb3cgLmktbGltaXQgeyAKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZFRjNDNzsKICAgICAgICAgICAgY29sb3I6IHZhcigtLXdhcm5pbmcpOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuN2VtLCAxLjR2dywgMC45ZW0pOyAKICAgICAgICAgICAgcGFkZGluZzogMC41dmggMXZ3OyAKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjRkNEMzREOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAua2V5LXBvaW50IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZFRjlFNzsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZ29sZCk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDEuNXZoIDJ2dzsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMnZoOwogICAgICAgIH0KICAgICAgICAua2V5LXBvaW50IC5rcC10aXRsZSB7IGNvbG9yOiB2YXIoLS1nb2xkKTsgZm9udC1zaXplOiBjbGFtcCgwLjg1ZW0sIDEuOHZ3LCAxLjFlbSk7IGZvbnQtd2VpZ2h0OiA3MDA7IG1hcmdpbi1ib3R0b206IDF2aDsgfQogICAgICAgIC5rZXktcG9pbnQgLmtwLXRleHQgeyBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsgZm9udC1zaXplOiBjbGFtcCgwLjhlbSwgMS42dncsIDFlbSk7IGxpbmUtaGVpZ2h0OiAxLjU7IH0KICAgICAgICAKICAgICAgICAuZmFpbC1ncmlkIHsKICAgICAgICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMywgMWZyKTsKICAgICAgICAgICAgZ2FwOiAxLjV2dzsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMnZoOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuZmFpbC1pdGVtIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nOiAxLjV2aCAxdnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNGRUYyRjI7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNGRUNBQ0E7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgfQogICAgICAgIC5mYWlsLWl0ZW0gLmYtaWNvbiB7IGZvbnQtc2l6ZTogY2xhbXAoMS40ZW0sIDN2dywgMmVtKTsgfQogICAgICAgIC5mYWlsLWl0ZW0gLmYtdGV4dCB7IGNvbG9yOiB2YXIoLS1kYW5nZXIpOyBmb250LXNpemU6IGNsYW1wKDAuNzVlbSwgMS41dncsIDAuOTVlbSk7IG1hcmdpbi10b3A6IDF2aDsgbGluZS1oZWlnaHQ6IDEuNDsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIAogICAgICAgIC5zdGFydC1zZWN0aW9uIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBwYWRkaW5nLXRvcDogMnZoOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuc3RhcnQtYnRuIHsKICAgICAgICAgICAgcGFkZGluZzogMnZoIDV2dzsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgxLjFlbSwgMi41dncsIDEuNWVtKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgdmFyKC0tYXViZXJnaW5lKSwgdmFyKC0tYXViZXJnaW5lLWxpZ2h0KSk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAzNXB4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCAxNXB4IHJnYmEoOTIsNDUsOTIsMC4zNSk7CiAgICAgICAgfQogICAgICAgIC5zdGFydC1idG46aG92ZXIgeyAKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjA1KTsgCiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNnB4IDIwcHggcmdiYSg5Miw0NSw5MiwwLjQ1KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogPT09PT09PT09PSBHQU1FIFNDUkVFTiA9PT09PT09PT09ICovCiAgICAgICAgLmdhbWUtc2NyZWVuIHsgZGlzcGxheTogbm9uZTsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgaGVpZ2h0OiAxMDB2aDsgfQogICAgICAgIC5nYW1lLXNjcmVlbi5hY3RpdmUgeyBkaXNwbGF5OiBmbGV4OyB9CiAgICAgICAgCiAgICAgICAgLmdhbWUtaGVhZGVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCB2YXIoLS1hdWJlcmdpbmUpLCB2YXIoLS1hdWJlcmdpbmUtbGlnaHQpKTsKICAgICAgICAgICAgcGFkZGluZzogMC44dmggMnZ3OwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQgMC4zczsKICAgICAgICAgICAgZmxleC1zaHJpbms6IDA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5nYW1lLWhlYWRlci5kYW5nZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICM5OTFCMUIsICNEQzI2MjYpOwogICAgICAgICAgICBhbmltYXRpb246IGhlYWRlclB1bHNlIDAuNXMgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgaGVhZGVyUHVsc2UgewogICAgICAgICAgICAwJSwgMTAwJSB7IG9wYWNpdHk6IDE7IH0KICAgICAgICAgICAgNTAlIHsgb3BhY2l0eTogMC44NTsgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAuaGVhZGVyLWxlZnQgeyBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDJ2dzsgfQogICAgICAgIAogICAgICAgIC50aW1lci1ib3ggeyAKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjMDAwOwogICAgICAgICAgICBwYWRkaW5nOiAwLjh2aCAxLjV2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgYm9yZGVyOiA0cHggc29saWQgI0ZFRjA4QTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDI1cHggcmdiYSgyNTQsMjQwLDEzOCwwLjcpOwogICAgICAgIH0KICAgICAgICAudGltZXItYm94IC50aW1lIHsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgyZW0sIDV2aCwgNGVtKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgY29sb3I6ICNGRUYwOEE7CiAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAnQ291cmllciBOZXcnLCBtb25vc3BhY2U7CiAgICAgICAgICAgIHRleHQtc2hhZG93OiAwIDAgMTVweCByZ2JhKDI1NCwyNDAsMTM4LDAuOCk7CiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OiAxOwogICAgICAgIH0KICAgICAgICAudGltZXItYm94IC50aW1lLnVyZ2VudCB7IGNvbG9yOiAjRkNBNUE1OyBhbmltYXRpb246IHB1bHNlIDAuM3MgaW5maW5pdGU7IH0KICAgICAgICAudGltZXItYm94IC5sYWJlbCB7IGZvbnQtc2l6ZTogY2xhbXAoMC41ZW0sIDF2aCwgMC43ZW0pOyBjb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjkpOyBmb250LXdlaWdodDogNjAwOyBsZXR0ZXItc3BhY2luZzogMXB4OyB9CiAgICAgICAgCiAgICAgICAgQGtleWZyYW1lcyBwdWxzZSB7IDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfSA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDgpOyB9IH0KICAgICAgICAKICAgICAgICAucHJvZ3Jlc3MtYm94IHsgdGV4dC1hbGlnbjogY2VudGVyOyB9CiAgICAgICAgLnByb2dyZXNzLWJveCAuY291bnQgeyBmb250LXNpemU6IGNsYW1wKDEuMmVtLCAzdmgsIDJlbSk7IGZvbnQtd2VpZ2h0OiA3MDA7IGNvbG9yOiAjODZFRkFDOyB9CiAgICAgICAgLnByb2dyZXNzLWJveCAubGFiZWwgeyBmb250LXNpemU6IGNsYW1wKDAuNWVtLCAxdmgsIDAuN2VtKTsgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC44KTsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIAogICAgICAgIC5wYWNlLWJveCB7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgcGFkZGluZzogMC44dmggMS4ydnc7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNHZoLCAxZW0pOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgIH0KICAgICAgICAucGFjZS1ib3guZ29vZCB7IGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsMC4yKTsgY29sb3I6ICM4NkVGQUM7IH0KICAgICAgICAucGFjZS1ib3gud2FybiB7IGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsMC4yKTsgY29sb3I6ICNGREUwNDc7IH0KICAgICAgICAucGFjZS1ib3guYmFkIHsgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwwLjIpOyBjb2xvcjogI0ZDQTVBNTsgfQogICAgICAgIC5wYWNlLWJveCAucGFjZS1sYWJlbCB7IGZvbnQtc2l6ZTogMC45ZW07IH0KICAgICAgICAKICAgICAgICAuaGVhZGVyLW1ldGVycyB7IGRpc3BsYXk6IGZsZXg7IGdhcDogMS41dnc7IH0KICAgICAgICAKICAgICAgICAuaC1tZXRlciB7IHdpZHRoOiBjbGFtcCgxMDBweCwgMTR2dywgMTgwcHgpOyB9CiAgICAgICAgLmgtbWV0ZXIgLm1ldGVyLWxhYmVsIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNmVtLCAxLjJ2aCwgMC44NWVtKTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAycHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgfQogICAgICAgIC5oLW1ldGVyIC5tZXRlci1iYXIgewogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDEwcHgsIDJ2aCwgMTZweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC4yNSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgcmdiYSgyNTUsMjU1LDI1NSwwLjMpOwogICAgICAgIH0KICAgICAgICAuaC1tZXRlciAubWV0ZXItZmlsbCB7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzOwogICAgICAgIH0KICAgICAgICAuaC1tZXRlci5lbmVyZ3kgLm1ldGVyLWZpbGwgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNFRjQ0NDQsICNGQkJGMjQsICMyMkM1NUUpOyB9CiAgICAgICAgLmgtbWV0ZXIudGVuc2lvbiAubWV0ZXItZmlsbCB7IGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzIyQzU1RSwgI0ZCQkYyNCwgI0VGNDQ0NCk7IH0KICAgICAgICAKICAgICAgICAuaC1tZXRlciAubWV0ZXItYmFyLmNyaXRpY2FsIHsgYW5pbWF0aW9uOiBtZXRlclB1bHNlIDAuNHMgaW5maW5pdGU7IH0KICAgICAgICBAa2V5ZnJhbWVzIG1ldGVyUHVsc2UgeyAwJSwgMTAwJSB7IGJveC1zaGFkb3c6IDAgMCA4cHggI0VGNDQ0NDsgfSA1MCUgeyBib3gtc2hhZG93OiAwIDAgMTZweCAjRUY0NDQ0OyB9IH0KICAgICAgICAKICAgICAgICAuZ2FtZS1tYWluIHsgCiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7IAogICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICBtaW4taGVpZ2h0OiAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBNZWV0aW5nIFJvb20gKi8KICAgICAgICAubWVldGluZy1yb29tIHsKICAgICAgICAgICAgd2lkdGg6IDM4JTsKICAgICAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjRThGNEZELCAjRDFFOEZBKTsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgYm9yZGVyLXJpZ2h0OiAzcHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmZsYXNoLW92ZXJsYXkgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogMDsgbGVmdDogMDsgcmlnaHQ6IDA7IGJvdHRvbTogMDsKICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4xczsKICAgICAgICAgICAgei1pbmRleDogNTA7CiAgICAgICAgfQogICAgICAgIC5mbGFzaC1vdmVybGF5LmJhZCB7IGJhY2tncm91bmQ6IHJnYmEoMjM5LDY4LDY4LDAuMzUpOyB9CiAgICAgICAgLmZsYXNoLW92ZXJsYXkuZ29vZCB7IGJhY2tncm91bmQ6IHJnYmEoMzQsMTk3LDk0LDAuMzUpOyB9CiAgICAgICAgLmZsYXNoLW92ZXJsYXkuY2VvIHsgYmFja2dyb3VuZDogcmdiYSgxNDcsNTEsMjM0LDAuMzUpOyB9CiAgICAgICAgLmZsYXNoLW92ZXJsYXkuYWN0aXZlIHsgb3BhY2l0eTogMTsgfQogICAgICAgIAogICAgICAgIC5yb29tLXN0YXR1cyB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiA1MCU7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMi41ZW0sIDZ2dywgNGVtKTsKICAgICAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICAgICAgei1pbmRleDogNjA7CiAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAycHggNXB4IHJnYmEoMCwwLDAsMC4zKSk7CiAgICAgICAgfQogICAgICAgIC5yb29tLXN0YXR1cy5zaG93IHsgb3BhY2l0eTogMTsgYW5pbWF0aW9uOiBzdGF0dXNQb3AgMC4zNXMgZWFzZTsgfQogICAgICAgIEBrZXlmcmFtZXMgc3RhdHVzUG9wIHsgMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLC01MCUpIHNjYWxlKDAuNSk7IH0gNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwtNTAlKSBzY2FsZSgxLjE1KTsgfSAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwtNTAlKSBzY2FsZSgxKTsgfSB9CiAgICAgICAgCiAgICAgICAgLm1lZXRpbmctdGFibGUgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogNTAlOwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICB3aWR0aDogY2xhbXAoNjBweCwgMTB2dywgMTAwcHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDQwcHgsIDd2dywgNzBweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNBNjdDNTIsICM4QjZCNDUpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDE1cHggcmdiYSgwLDAsMCwwLjI1KTsKICAgICAgICAgICAgYm9yZGVyOiAzcHggc29saWQgIzdBNUMzQjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlciB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICB3aWR0aDogY2xhbXAoNTVweCwgOHZ3LCA5NXB4KTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMTVzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLWF2YXRhciB7CiAgICAgICAgICAgIHdpZHRoOiBjbGFtcCg0MHB4LCA2dncsIDcwcHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDQwcHgsIDZ2dywgNzBweCk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbjogMCBhdXRvOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCB3aGl0ZTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMTVzOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDNweCAxMHB4IHJnYmEoMCwwLDAsMC4yKTsKICAgICAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYXZhdGFyLWZhY2UgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hdmF0YXItZmFjZSAuZmFjZS1iZyB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBFeWVzICovCiAgICAgICAgLmF2YXRhci1mYWNlIC5leWVzIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDMyJTsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogY2xhbXAoNnB4LCAxLjJ2dywgMTFweCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hdmF0YXItZmFjZSAuZXllIHsKICAgICAgICAgICAgd2lkdGg6IGNsYW1wKDVweCwgMXZ3LCA5cHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDVweCwgMXZ3LCA5cHgpOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjMUYyOTM3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF2YXRhci1mYWNlIC5leWU6OmFmdGVyIHsKICAgICAgICAgICAgY29udGVudDogJyc7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgd2lkdGg6IGNsYW1wKDFweCwgMC4zdncsIDNweCk7CiAgICAgICAgICAgIGhlaWdodDogY2xhbXAoMXB4LCAwLjN2dywgM3B4KTsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgdG9wOiAxcHg7CiAgICAgICAgICAgIGxlZnQ6IDFweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogRXllYnJvd3MgKi8KICAgICAgICAuYXZhdGFyLWZhY2UgLmV5ZWJyb3dzIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDI0JTsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogY2xhbXAoMTBweCwgMS44dncsIDE2cHgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYXZhdGFyLWZhY2UgLmV5ZWJyb3cgewogICAgICAgICAgICB3aWR0aDogY2xhbXAoN3B4LCAxLjN2dywgMTFweCk7CiAgICAgICAgICAgIGhlaWdodDogM3B4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNEI1NTYzOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBNb3V0aCAqLwogICAgICAgIC5hdmF0YXItZmFjZSAubW91dGggewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMjIlOwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgd2lkdGg6IDE2cHg7CiAgICAgICAgICAgIGhlaWdodDogOHB4OwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCAjNEI1NTYzOwogICAgICAgICAgICBib3JkZXItdG9wOiBub25lOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAwIDAgMTZweCAxNnB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8qIEhhaXIgc3R5bGVzICovCiAgICAgICAgLmF2YXRhci1mYWNlIC5oYWlyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDA7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBDaGFyYWN0ZXItc3BlY2lmaWMgc3R5bGVzICovCiAgICAgICAgLmF2YXRhci1tZWVyYSAuZmFjZS1iZyB7IGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICNEREQ2RkUsICNDNEI1RkQpOyB9CiAgICAgICAgLmF2YXRhci1tZWVyYSAuaGFpciB7CiAgICAgICAgICAgIHdpZHRoOiA1MHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxRjI5Mzc7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDI1cHggMjVweCAwIDA7CiAgICAgICAgICAgIHRvcDogLTJweDsKICAgICAgICB9CiAgICAgICAgLmF2YXRhci1tZWVyYSAuaGFpcjo6YWZ0ZXIgewogICAgICAgICAgICBjb250ZW50OiAnJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogOHB4OwogICAgICAgICAgICBoZWlnaHQ6IDhweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzkzMzNFQTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICB0b3A6IDhweDsKICAgICAgICAgICAgbGVmdDogMjFweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF2YXRhci1yYWogLmZhY2UtYmcgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjQkFFNkZELCAjN0REM0ZDKTsgfQogICAgICAgIC5hdmF0YXItcmFqIC5oYWlyIHsKICAgICAgICAgICAgd2lkdGg6IDQ1cHg7CiAgICAgICAgICAgIGhlaWdodDogMTZweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzFGMjkzNzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweCAyMHB4IDAgMDsKICAgICAgICAgICAgdG9wOiAtMnB4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLXJhajo6YWZ0ZXIgewogICAgICAgICAgICBjb250ZW50OiAn8J+UrCc7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjVlbTsKICAgICAgICAgICAgdG9wOiAycHg7CiAgICAgICAgICAgIHJpZ2h0OiAycHg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hdmF0YXItcHJpeWEgLmZhY2UtYmcgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjQkJGN0QwLCAjODZFRkFDKTsgfQogICAgICAgIC5hdmF0YXItcHJpeWEgLmhhaXIgewogICAgICAgICAgICB3aWR0aDogNTVweDsKICAgICAgICAgICAgaGVpZ2h0OiAyNXB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjMUYyOTM3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAzMHB4IDMwcHggMCAwOwogICAgICAgICAgICB0b3A6IC00cHg7CiAgICAgICAgfQogICAgICAgIC5hdmF0YXItcHJpeWEgLmhhaXI6OmJlZm9yZSB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiAxMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDMwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxRjI5Mzc7CiAgICAgICAgICAgIGxlZnQ6IC01cHg7CiAgICAgICAgICAgIHRvcDogMTVweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMCAwIDVweCAxMHB4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLXByaXlhIC5oYWlyOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiAxMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDMwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxRjI5Mzc7CiAgICAgICAgICAgIHJpZ2h0OiAtNXB4OwogICAgICAgICAgICB0b3A6IDE1cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgMCAxMHB4IDVweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF2YXRhci1kZXYgLmZhY2UtYmcgeyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjRkVGM0M3LCAjRkRFNjhBKTsgfQogICAgICAgIC5hdmF0YXItZGV2IC5oYWlyIHsKICAgICAgICAgICAgd2lkdGg6IDQ4cHg7CiAgICAgICAgICAgIGhlaWdodDogMTRweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzc4MzUwRjsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweCAyMHB4IDAgMDsKICAgICAgICAgICAgdG9wOiAtMnB4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLWRldiAuZ2xhc3NlcyB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiAyOCU7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgICAgICB3aWR0aDogMzZweDsKICAgICAgICAgICAgaGVpZ2h0OiAxNHB4OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjNzgzNTBGOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgICAgfQogICAgICAgIC5hdmF0YXItZGV2IC5nbGFzc2VzOjpiZWZvcmUgewogICAgICAgICAgICBjb250ZW50OiAnJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogNnB4OwogICAgICAgICAgICBoZWlnaHQ6IDJweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzc4MzUwRjsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0b3A6IDRweDsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYXZhdGFyLWFuaXRhIC5mYWNlLWJnIHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgI0ZFQ0FDQSwgI0ZDQTVBNSk7IH0KICAgICAgICAuYXZhdGFyLWFuaXRhIC5oYWlyIHsKICAgICAgICAgICAgd2lkdGg6IDUycHg7CiAgICAgICAgICAgIGhlaWdodDogMjJweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzFGMjkzNzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjZweCAyNnB4IDAgMDsKICAgICAgICAgICAgdG9wOiAtM3B4OwogICAgICAgIH0KICAgICAgICAuYXZhdGFyLWFuaXRhIC5oYWlyOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiA2cHg7CiAgICAgICAgICAgIGhlaWdodDogNnB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRUY0NDQ0OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIHRvcDogNXB4OwogICAgICAgICAgICByaWdodDogNXB4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBFbW90aW9uYWwgc3RhdGVzICovCiAgICAgICAgLm1lbWJlci5hbmdyeSAuZXllYnJvdzpmaXJzdC1jaGlsZCB7IHRyYW5zZm9ybTogcm90YXRlKDIwZGVnKSB0cmFuc2xhdGVZKDJweCk7IH0KICAgICAgICAubWVtYmVyLmFuZ3J5IC5leWVicm93Omxhc3QtY2hpbGQgeyB0cmFuc2Zvcm06IHJvdGF0ZSgtMjBkZWcpIHRyYW5zbGF0ZVkoMnB4KTsgfQogICAgICAgIC5tZW1iZXIuYW5ncnkgLm1vdXRoIHsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTZweCAxNnB4IDAgMDsKICAgICAgICAgICAgYm9yZGVyOiAzcHggc29saWQgI0RDMjYyNjsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogbm9uZTsKICAgICAgICAgICAgaGVpZ2h0OiA2cHg7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuYW5ncnkgLmV5ZSB7IGJhY2tncm91bmQ6ICNEQzI2MjY7IH0KICAgICAgICAKICAgICAgICAubWVtYmVyLnRlbnNlIC5leWVicm93OmZpcnN0LWNoaWxkIHsgdHJhbnNmb3JtOiByb3RhdGUoMTBkZWcpIHRyYW5zbGF0ZVkoMXB4KTsgfQogICAgICAgIC5tZW1iZXIudGVuc2UgLmV5ZWJyb3c6bGFzdC1jaGlsZCB7IHRyYW5zZm9ybTogcm90YXRlKC0xMGRlZykgdHJhbnNsYXRlWSgxcHgpOyB9CiAgICAgICAgLm1lbWJlci50ZW5zZSAubW91dGggewogICAgICAgICAgICB3aWR0aDogMTJweDsKICAgICAgICAgICAgaGVpZ2h0OiA0cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDJweDsKICAgICAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNEI1NTYzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLmhhcHB5IC5tb3V0aCB7CiAgICAgICAgICAgIHdpZHRoOiAyMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDEwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgMCAyMHB4IDIwcHg7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogIzE2QTM0QTsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci5oYXBweSAuZXllIHsgCiAgICAgICAgICAgIGhlaWdodDogNHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHggNHB4IDAgMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci5zcGVha2luZyAubW91dGggewogICAgICAgICAgICB3aWR0aDogMTRweDsKICAgICAgICAgICAgaGVpZ2h0OiAxNHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIGJvcmRlcjogM3B4IHNvbGlkICM0QjU1NjM7CiAgICAgICAgICAgIGFuaW1hdGlvbjogdGFsa2luZyAwLjJzIGluZmluaXRlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLnRpcmVkIC5leWUgewogICAgICAgICAgICBoZWlnaHQ6IDZweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMCAwIDZweCA2cHg7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgycHgpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLnRpcmVkIC5leWVicm93IHsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDNweCk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIudGlyZWQgLm1vdXRoIHsKICAgICAgICAgICAgd2lkdGg6IDEycHg7CiAgICAgICAgICAgIGhlaWdodDogM3B4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAycHg7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzlDQTNBRjsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci50aXJlZCAubWVtYmVyLWF2YXRhciB7CiAgICAgICAgICAgIG9wYWNpdHk6IDAuODU7CiAgICAgICAgICAgIGZpbHRlcjogc2F0dXJhdGUoMC43KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQGtleWZyYW1lcyB0YWxraW5nIHsKICAgICAgICAgICAgMCUsIDEwMCUgeyBoZWlnaHQ6IDEwcHg7IHdpZHRoOiAxMnB4OyB9CiAgICAgICAgICAgIDUwJSB7IGhlaWdodDogMTZweDsgd2lkdGg6IDE0cHg7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci5jZW8tbW9kZSAubW91dGggewogICAgICAgICAgICB3aWR0aDogMThweDsKICAgICAgICAgICAgaGVpZ2h0OiA4cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgMCAxOHB4IDE4cHg7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogIzdDM0FFRDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogUm9vbSB0aXJlZG5lc3Mgb3ZlcmxheSAqLwogICAgICAgIC5tZWV0aW5nLXJvb20udGlyZWQtcm9vbSB7CiAgICAgICAgICAgIGZpbHRlcjogc2F0dXJhdGUoMC44NSkgYnJpZ2h0bmVzcygwLjk1KTsKICAgICAgICB9CiAgICAgICAgLm1lZXRpbmctcm9vbS5leGhhdXN0ZWQtcm9vbSB7CiAgICAgICAgICAgIGZpbHRlcjogc2F0dXJhdGUoMC43KSBicmlnaHRuZXNzKDAuOSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5tZW1iZXItZW1vdGlvbiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm90dG9tOiAtMnB4OwogICAgICAgICAgICByaWdodDogLTJweDsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjZlbSwgMS40dncsIDAuODVlbSk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIHdpZHRoOiBjbGFtcCgxNHB4LCAyLjV2dywgMjJweCk7CiAgICAgICAgICAgIGhlaWdodDogY2xhbXAoMTRweCwgMi41dncsIDIycHgpOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAxcHggNHB4IHJnYmEoMCwwLDAsMC4yKTsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgd2hpdGU7CiAgICAgICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC41KTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICAgICAgICAgIHotaW5kZXg6IDEwOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLWVtb3Rpb24uc2hvdyB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5tZW1iZXIuc3BlYWtpbmcgLm1lbWJlci1hdmF0YXIgewogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWdvbGQpOwogICAgICAgICAgICBhbmltYXRpb246IHNwZWFrUHVsc2UgMC4zcyBpbmZpbml0ZTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDIwcHggcmdiYSgyMDEsMTYyLDM5LDAuOCk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuc3BlYWtpbmcgLm1lbWJlci1lbW90aW9uIHsKICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxKTsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci5hbmdyeSAubWVtYmVyLWF2YXRhciB7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogdmFyKC0tZGFuZ2VyKTsKICAgICAgICAgICAgYW5pbWF0aW9uOiBhbmdyeVNoYWtlIDAuMXMgaW5maW5pdGU7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMjIwLDM4LDM4LDAuOSk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuYW5ncnkgLm1lbWJlci1lbW90aW9uIHsKICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLnRlbnNlIC5tZW1iZXItYXZhdGFyIHsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiB2YXIoLS13YXJuaW5nKTsKICAgICAgICAgICAgYW5pbWF0aW9uOiB0ZW5zZVB1bHNlIDAuNnMgaW5maW5pdGU7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAxOHB4IHJnYmEoMjQ1LDE1OCwxMSwwLjcpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLnRlbnNlIC5tZW1iZXItZW1vdGlvbiB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMSk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuaGFwcHkgLm1lbWJlci1hdmF0YXIgewogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLXN1Y2Nlc3MpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMThweCByZ2JhKDIyLDE2Myw3NCwwLjcpOwogICAgICAgIH0KICAgICAgICAubWVtYmVyLmhhcHB5IC5tZW1iZXItZW1vdGlvbiB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMSk7CiAgICAgICAgfQogICAgICAgIC5tZW1iZXIuY2VvLW1vZGUgLm1lbWJlci1hdmF0YXIgewogICAgICAgICAgICBib3JkZXItY29sb3I6ICM5MzMzRUE7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAyNXB4IHJnYmEoMTQ3LDUxLDIzNCwwLjgpOwogICAgICAgICAgICBhbmltYXRpb246IGNlb1B1bHNlIDAuM3MgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgc3BlYWtQdWxzZSB7IDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfSA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDUpOyB9IH0KICAgICAgICBAa2V5ZnJhbWVzIGFuZ3J5U2hha2UgeyAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsgfSAzMyUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTNweCk7IH0gNjYlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDNweCk7IH0gfQogICAgICAgIEBrZXlmcmFtZXMgdGVuc2VQdWxzZSB7IDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgYm94LXNoYWRvdzogMCAwIDEycHggcmdiYSgyNDUsMTU4LDExLDAuNSk7IH0gNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjAzKTsgYm94LXNoYWRvdzogMCAwIDIycHggcmdiYSgyNDUsMTU4LDExLDAuOCk7IH0gfQogICAgICAgIEBrZXlmcmFtZXMgY2VvUHVsc2UgeyAwJSwgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0gNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA1KTsgfSB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci1uYW1lIHsgCiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC42NWVtLCAxLjV2dywgMC45NWVtKTsgCiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyAKICAgICAgICAgICAgbWFyZ2luLXRvcDogMC41dmg7IAogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICB0ZXh0LXNoYWRvdzogMCAxcHggMnB4IHJnYmEoMjU1LDI1NSwyNTUsMC45KTsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwwLjgpOwogICAgICAgICAgICBwYWRkaW5nOiAwLjJ2aCAwLjZ2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWVtYmVyLXJvbGUgewogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNWVtLCAxLjJ2dywgMC44ZW0pOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOwogICAgICAgICAgICBtYXJnaW4tdG9wOiAwLjF2aDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lbWJlci1zdGF0dXMgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogLTAuNXZoOwogICAgICAgICAgICByaWdodDogMC41dnc7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC45ZW0sIDJ2dywgMS4zZW0pOwogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4yczsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci1zdGF0dXMuc2hvdyB7IG9wYWNpdHk6IDE7IH0KICAgICAgICAKICAgICAgICAubWVtYmVyLWJhciB7CiAgICAgICAgICAgIHdpZHRoOiBjbGFtcCgzNXB4LCA1dncsIDYwcHgpOwogICAgICAgICAgICBoZWlnaHQ6IGNsYW1wKDRweCwgMC44dmgsIDdweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC4xNSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDNweDsKICAgICAgICAgICAgbWFyZ2luOiAwLjN2aCBhdXRvIDA7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMCwwLDAsMC4xKTsKICAgICAgICB9CiAgICAgICAgLm1lbWJlci1iYXItZmlsbCB7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjMjJDNTVFLCAjRkJCRjI0LCAjRUY0NDQ0KTsKICAgICAgICAgICAgYmFja2dyb3VuZC1zaXplOiAyMDAlIDEwMCU7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuc3BlZWNoLWJ1YmJsZSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuOHZoIDF2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS42dncsIDAuOTVlbSk7CiAgICAgICAgICAgIG1heC13aWR0aDogY2xhbXAoMTAwcHgsIDE1dncsIDE3MHB4KTsKICAgICAgICAgICAgbWluLXdpZHRoOiBjbGFtcCg2MHB4LCA4dncsIDEwMHB4KTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTRweCByZ2JhKDAsMCwwLDAuMik7CiAgICAgICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC44KTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMTVzOwogICAgICAgICAgICB6LWluZGV4OiAxMDA7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBsaW5lLWhlaWdodDogMS4zNTsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgLnNwZWVjaC1idWJibGU6OmFmdGVyIHsKICAgICAgICAgICAgY29udGVudDogJyc7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm90dG9tOiAtOHB4OwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgYm9yZGVyOiA4cHggc29saWQgdHJhbnNwYXJlbnQ7CiAgICAgICAgICAgIGJvcmRlci10b3AtY29sb3I6IHdoaXRlOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiBub25lOwogICAgICAgIH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS52aXNpYmxlIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgICAgIC5zcGVlY2gtYnViYmxlLmFuZ3J5IHsgCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNGRUYyRjI7IAogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWRhbmdlcik7IAogICAgICAgICAgICBjb2xvcjogIzk5MUIxQjsgCiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGFuaW1hdGlvbjogYW5ncnlTcGVlY2ggMC4xNXMgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIC5zcGVlY2gtYnViYmxlLmFuZ3J5OjphZnRlciB7IGJvcmRlci10b3AtY29sb3I6ICNGRUYyRjI7IH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS5nb29kIHsgYmFja2dyb3VuZDogI0YwRkRGNDsgYm9yZGVyLWNvbG9yOiB2YXIoLS1zdWNjZXNzKTsgY29sb3I6ICMxNjY1MzQ7IH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS5nb29kOjphZnRlciB7IGJvcmRlci10b3AtY29sb3I6ICNGMEZERjQ7IH0KICAgICAgICAuc3BlZWNoLWJ1YmJsZS5jZW8geyBiYWNrZ3JvdW5kOiAjRkFGNUZGOyBib3JkZXItY29sb3I6ICM5MzMzRUE7IGNvbG9yOiAjNkIyMUE4OyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLnNwZWVjaC1idWJibGUuY2VvOjphZnRlciB7IGJvcmRlci10b3AtY29sb3I6ICNGQUY1RkY7IH0KICAgICAgICAKICAgICAgICBAa2V5ZnJhbWVzIGFuZ3J5U3BlZWNoIHsKICAgICAgICAgICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEpOyB9CiAgICAgICAgICAgIDUwJSB7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogQ3VycmVudCBzcGVha2VyIGhpZ2hsaWdodCAqLwogICAgICAgIC5jdXJyZW50LXNwZWFrZXIgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMXZoOwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuNXZoIDEuNXZ3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxNXB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDNweCAxMHB4IHJnYmEoMCwwLDAsMC4xNSk7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNnZ3LCAwLjk1ZW0pOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsKICAgICAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICAgICAgICAgIHotaW5kZXg6IDgwOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDAuOHZ3OwogICAgICAgIH0KICAgICAgICAuY3VycmVudC1zcGVha2VyLnNob3cgeyBvcGFjaXR5OiAxOyB9CiAgICAgICAgLmN1cnJlbnQtc3BlYWtlciAuc3BlYWtlci1pY29uIHsgZm9udC1zaXplOiAxLjFlbTsgfQogICAgICAgIC5jdXJyZW50LXNwZWFrZXIgLnNwZWFrZXItdGV4dCB7IG1heC13aWR0aDogMjB2dzsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgb3ZlcmZsb3c6IGhpZGRlbjsgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7IH0KICAgICAgICAuY3VycmVudC1zcGVha2VyLmFuZ3J5IHsgYmFja2dyb3VuZDogI0ZFRjJGMjsgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIC5jdXJyZW50LXNwZWFrZXIuZ29vZCB7IGJhY2tncm91bmQ6ICNGMEZERjQ7IGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLXN1Y2Nlc3MpOyB9CiAgICAgICAgCiAgICAgICAgLmZsb2F0LWVmZmVjdCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgxLjhlbSwgNHZ3LCAyLjVlbSk7CiAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICBhbmltYXRpb246IGZsb2F0VXAgMC41cyBlYXNlLW91dCBmb3J3YXJkczsKICAgICAgICAgICAgei1pbmRleDogMjAwOwogICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMykpOwogICAgICAgIH0KICAgICAgICBAa2V5ZnJhbWVzIGZsb2F0VXAgeyAwJSB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKSBzY2FsZSgxKTsgfSAxMDAlIHsgb3BhY2l0eTogMDsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC00dmgpIHNjYWxlKDEuMSk7IH0gfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgcm9vbVB1bHNlIHsgCiAgICAgICAgICAgIDAlLCAxMDAlIHsgYm94LXNoYWRvdzogaW5zZXQgMCAwIDMwcHggcmdiYSgyMjAsMzgsMzgsMC4zKTsgfSAKICAgICAgICAgICAgNTAlIHsgYm94LXNoYWRvdzogaW5zZXQgMCAwIDUwcHggcmdiYSgyMjAsMzgsMzgsMC41KTsgfSAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgQGtleWZyYW1lcyB0ZW5zaW9uU2hha2UgewogICAgICAgICAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsgfQogICAgICAgICAgICAyNSUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTJweCk7IH0KICAgICAgICAgICAgNzUlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDJweCk7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1lZXRpbmctcm9vbS50ZW5zZSB7CiAgICAgICAgICAgIGFuaW1hdGlvbjogcm9vbVB1bHNlIDAuOHMgaW5maW5pdGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5tZWV0aW5nLXJvb20uY3JpdGljYWwgewogICAgICAgICAgICBhbmltYXRpb246IHJvb21QdWxzZSAwLjRzIGluZmluaXRlLCB0ZW5zaW9uU2hha2UgMC4xcyBpbmZpbml0ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLyogQ29udHJvbCBQYW5lbCAqLwogICAgICAgIC5jb250cm9sLXBhbmVsIHsKICAgICAgICAgICAgZmxleDogMTsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctY3JlYW0pOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICBtaW4td2lkdGg6IDA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5wcm9qZWN0LXNlY3Rpb24gewogICAgICAgICAgICBwYWRkaW5nOiAxdmggMS41dnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLWxpZ2h0KTsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgICAgIGZsZXgtc2hyaW5rOiAwOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC1oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDAuNXZoOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC1oZWFkZXIgaDMgeyBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgZm9udC1zaXplOiBjbGFtcCgwLjc1ZW0sIDEuNXZoLCAxZW0pOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLnByb2plY3QtdGltZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDF2dzsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS40dmgsIDAuOWVtKTsKICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgLnByb2plY3QtdGltZXIgLnB0LXRpbWUgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuM3ZoIDAuOHZ3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwogICAgICAgICAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC10aW1lciAucHQtdGltZS5zbG93IHsgY29sb3I6IHZhcigtLXdhcm5pbmcpOyBib3JkZXItY29sb3I6ICNGQ0QzNEQ7IGJhY2tncm91bmQ6ICNGRkZCRUI7IH0KICAgICAgICAucHJvamVjdC10aW1lciAucHQtdGltZS5kcmFnIHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGJvcmRlci1jb2xvcjogI0ZFQ0FDQTsgYmFja2dyb3VuZDogI0ZFRjJGMjsgfQogICAgICAgIC5wcm9qZWN0LWNhcmQgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgcGFkZGluZzogMC44dmggMXZ3OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgIH0KICAgICAgICAucHJvamVjdC1uYW1lIHsgZm9udC1zaXplOiBjbGFtcCgwLjhlbSwgMS42dmgsIDFlbSk7IGZvbnQtd2VpZ2h0OiA3MDA7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyB9CiAgICAgICAgLnByb2plY3QtZGVzYyB7IGZvbnQtc2l6ZTogY2xhbXAoMC42NWVtLCAxLjJ2aCwgMC44NWVtKTsgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsgbGluZS1oZWlnaHQ6IDEuMzsgfQogICAgICAgIAogICAgICAgIC5zdGF0dXMtc2VjdGlvbiB7CiAgICAgICAgICAgIHBhZGRpbmc6IDF2aCAxLjV2dzsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctd2hpdGUpOwogICAgICAgICAgICBib3JkZXItYm90dG9tOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICAgICAgZmxleC1zaHJpbms6IDA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5jcmlzaXMtYmFubmVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZFRjJGMjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tZGFuZ2VyKTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiAwLjh2aCAxdnc7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgICAgICAgYW5pbWF0aW9uOiBjcmlzaXNQdWxzZSAwLjVzIGluZmluaXRlOwogICAgICAgIH0KICAgICAgICAuY3Jpc2lzLWJhbm5lci5zaG93IHsgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyB9CiAgICAgICAgLmNyaXNpcy1iYW5uZXIgLmNyaXNpcy10ZXh0IHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGZvbnQtd2VpZ2h0OiA3MDA7IGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNHZoLCAwLjk1ZW0pOyB9CiAgICAgICAgLmNyaXNpcy1iYW5uZXIgLmNyaXNpcy1oaW50IHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjg1ZW0pOyB9CiAgICAgICAgQGtleWZyYW1lcyBjcmlzaXNQdWxzZSB7IDAlLCAxMDAlIHsgb3BhY2l0eTogMTsgfSA1MCUgeyBvcGFjaXR5OiAwLjg1OyB9IH0KICAgICAgICAKICAgICAgICAuZHJhZy13YXJuaW5nIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI0ZGRkJFQjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI0ZDRDM0RDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBwYWRkaW5nOiAwLjV2aCAxdnc7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjY1ZW0sIDEuM3ZoLCAwLjg1ZW0pOwogICAgICAgICAgICBjb2xvcjogdmFyKC0td2FybmluZyk7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgLmRyYWctd2FybmluZy5zaG93IHsgZGlzcGxheTogYmxvY2s7IH0KICAgICAgICAKICAgICAgICAuc3RhdHVzLXJvdyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDMsIDFmcik7CiAgICAgICAgICAgIGdhcDogMC44dnc7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5zdGF0dXMtY2hpcCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuNnZoOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy1saWdodCk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICB9CiAgICAgICAgLnN0YXR1cy1jaGlwLmFsZXJ0IHsgYmFja2dyb3VuZDogI0ZFRjJGMjsgYm9yZGVyLWNvbG9yOiB2YXIoLS1kYW5nZXIpOyB9CiAgICAgICAgLnN0YXR1cy1jaGlwLndhcm4geyBiYWNrZ3JvdW5kOiAjRkZGQkVCOyBib3JkZXItY29sb3I6ICNGQ0QzNEQ7IH0KICAgICAgICAuc3RhdHVzLWNoaXAuZ29vZCB7IGJhY2tncm91bmQ6ICNGMEZERjQ7IGJvcmRlci1jb2xvcjogdmFyKC0tc3VjY2Vzcyk7IH0KICAgICAgICAuc3RhdHVzLWNoaXAgLmNoaXAtaWNvbiB7IGZvbnQtc2l6ZTogY2xhbXAoMWVtLCAydmgsIDEuNWVtKTsgfQogICAgICAgIC5zdGF0dXMtY2hpcCAuY2hpcC10ZXh0IHsgY29sb3I6IHZhcigtLXRleHQtZGFyayk7IGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjhlbSk7IGZvbnQtd2VpZ2h0OiA2MDA7IH0KICAgICAgICAKICAgICAgICAuYXR0ZW50aW9uLXJvdyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGdhcDogMC41dnc7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDAuOHZoOwogICAgICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDJ2aDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmF0dG4tY2hpcCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogMC4zdnc7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuM3ZoIDAuNnZ3OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjhlbSk7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgfQogICAgICAgIC5hdHRuLWNoaXAuYW5ncnkgeyBiYWNrZ3JvdW5kOiAjRkVFMkUyOyBib3JkZXI6IDFweCBzb2xpZCAjRkVDQUNBOyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIC5hdHRuLWNoaXAud2FpdGluZyB7IGJhY2tncm91bmQ6ICNEQkVBRkU7IGJvcmRlcjogMXB4IHNvbGlkICM5M0M1RkQ7IGNvbG9yOiAjMUQ0RUQ4OyB9CiAgICAgICAgLmF0dG4tY2hpcC5xdWlldCB7IGJhY2tncm91bmQ6ICNGM0U4RkY7IGJvcmRlcjogMXB4IHNvbGlkICNEOEI0RkU7IGNvbG9yOiAjN0MzQUVEOyB9CiAgICAgICAgCiAgICAgICAgLmFjdGlvbi1zZWN0aW9uIHsKICAgICAgICAgICAgZmxleDogMTsKICAgICAgICAgICAgcGFkZGluZzogMS4ydmggMS41dnc7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLWNyZWFtKTsKICAgICAgICAgICAgbWluLWhlaWdodDogMDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmFjdGlvbi1oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgZmxleC1zaHJpbms6IDA7CiAgICAgICAgfQogICAgICAgIC5hY3Rpb24taGVhZGVyIGg0IHsgY29sb3I6IHZhcigtLWF1YmVyZ2luZSk7IGZvbnQtc2l6ZTogY2xhbXAoMC44ZW0sIDEuNnZoLCAxZW0pOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLmFjdGlvbi1oZWFkZXIgLmxpbWl0ZWQtaW5mbyB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNHZoLCAwLjllbSk7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LW1lZGl1bSk7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgfQogICAgICAgIC5hY3Rpb24taGVhZGVyIC5saW1pdGVkLWluZm8gc3BhbiB7IAogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRkVGM0M3OwogICAgICAgICAgICBwYWRkaW5nOiAwLjN2aCAwLjh2dzsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgICAgICAgICBtYXJnaW4tbGVmdDogMC41dnc7CiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS13YXJuaW5nKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmFjdGlvbi1ncmlkIHsKICAgICAgICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMywgMWZyKTsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1yb3dzOiByZXBlYXQoMiwgMWZyKTsKICAgICAgICAgICAgZ2FwOiAxdmggMXZ3OwogICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICBtaW4taGVpZ2h0OiAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAuYWN0aW9uLWJ0biB7CiAgICAgICAgICAgIHBhZGRpbmc6IDF2aCAwLjV2dzsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctd2hpdGUpOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjFzOwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICBnYXA6IDAuNXZoOwogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDYwcHg7CiAgICAgICAgfQogICAgICAgIC5hY3Rpb24tYnRuOmhvdmVyOm5vdCg6ZGlzYWJsZWQpIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctbGlnaHQpOwogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWF1YmVyZ2luZSk7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMnB4KTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMTUpOwogICAgICAgIH0KICAgICAgICAuYWN0aW9uLWJ0bjpkaXNhYmxlZCB7IG9wYWNpdHk6IDAuMzU7IGN1cnNvcjogbm90LWFsbG93ZWQ7IH0KICAgICAgICAuYWN0aW9uLWJ0bi5yZWNvbW1lbmRlZCB7IAogICAgICAgICAgICBib3JkZXItY29sb3I6IHZhcigtLWdvbGQpOyAKICAgICAgICAgICAgYm9yZGVyLXdpZHRoOiAzcHg7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMjAxLDE2MiwzOSwwLjYpOyAKICAgICAgICAgICAgYW5pbWF0aW9uOiByZWNQdWxzZSAwLjZzIGluZmluaXRlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjRkZGQkVCOwogICAgICAgIH0KICAgICAgICAuYWN0aW9uLWJ0bi5saW1pdGVkIHsgYm9yZGVyLWNvbG9yOiB2YXIoLS13YXJuaW5nKTsgfQogICAgICAgIC5hY3Rpb24tYnRuIC51c2VzIHsgCiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgCiAgICAgICAgICAgIHRvcDogM3B4OyAKICAgICAgICAgICAgcmlnaHQ6IDVweDsgCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLXdhcm5pbmcpOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7IAogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNmVtLCAxLjF2aCwgMC44ZW0pOyAKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsgCiAgICAgICAgICAgIHBhZGRpbmc6IDJweCA2cHg7IAogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7IAogICAgICAgIH0KICAgICAgICAKICAgICAgICBAa2V5ZnJhbWVzIHJlY1B1bHNlIHsgCiAgICAgICAgICAgIDAlLCAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDZweCByZ2JhKDIwMSwxNjIsMzksMC40KTsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfSAKICAgICAgICAgICAgNTAlIHsgYm94LXNoYWRvdzogMCAwIDE4cHggcmdiYSgyMDEsMTYyLDM5LDAuOCk7IHRyYW5zZm9ybTogc2NhbGUoMS4wMik7IH0gCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5hY3Rpb24tYnRuIC5pY29uIHsgZm9udC1zaXplOiBjbGFtcCgxLjNlbSwgM3ZoLCAyZW0pOyB9CiAgICAgICAgLmFjdGlvbi1idG4gLmxhYmVsIHsgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS40dmgsIDAuOTVlbSk7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLmFjdGlvbi1idG4gLndoZW4geyBmb250LXNpemU6IGNsYW1wKDAuNTVlbSwgMS4xdmgsIDAuNzVlbSk7IGNvbG9yOiB2YXIoLS10ZXh0LWxpZ2h0KTsgfQogICAgICAgIAogICAgICAgIC5hY3Rpb24tYnRuLmNvb2xkb3duOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMDsgbGVmdDogMDsgcmlnaHQ6IDA7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgwLDAsMCwwLjUpOwogICAgICAgICAgICBhbmltYXRpb246IGNvb2xkb3duIHZhcigtLWNkKSBsaW5lYXIgZm9yd2FyZHM7CiAgICAgICAgfQogICAgICAgIEBrZXlmcmFtZXMgY29vbGRvd24geyBmcm9tIHsgaGVpZ2h0OiAxMDAlOyB9IHRvIHsgaGVpZ2h0OiAwJTsgfSB9CiAgICAgICAgCiAgICAgICAgLmRlY2lzaW9uLXNlY3Rpb24gewogICAgICAgICAgICBwYWRkaW5nOiAxdmggMS41dnc7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnLWxpZ2h0KTsKICAgICAgICAgICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkIHZhcigtLWJvcmRlcik7CiAgICAgICAgICAgIGZsZXgtc2hyaW5rOiAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAucXVhbGl0eS1kaXNwbGF5IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctd2hpdGUpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxdmggMS41dnc7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDF2aDsKICAgICAgICAgICAgYm9yZGVyOiAzcHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBib3JkZXItY29sb3IgMC4zczsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktZGlzcGxheS5sb3cgeyBib3JkZXItY29sb3I6IHZhcigtLWRhbmdlcik7IGJhY2tncm91bmQ6ICNGRUYyRjI7IH0KICAgICAgICAucXVhbGl0eS1kaXNwbGF5Lm1lZGl1bSB7IGJvcmRlci1jb2xvcjogdmFyKC0td2FybmluZyk7IGJhY2tncm91bmQ6ICNGRkZCRUI7IH0KICAgICAgICAucXVhbGl0eS1kaXNwbGF5Lmdvb2QgeyBib3JkZXItY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyBiYWNrZ3JvdW5kOiAjRjBGREY0OyB9CiAgICAgICAgLnF1YWxpdHktZGlzcGxheS5ncmVhdCB7IGJvcmRlci1jb2xvcjogIzA1OTY2OTsgYmFja2dyb3VuZDogI0VDRkRGNTsgfQogICAgICAgIAogICAgICAgIEBrZXlmcmFtZXMgc2hha2UgewogICAgICAgICAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsgfQogICAgICAgICAgICAyMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTZweCk7IH0KICAgICAgICAgICAgNDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDZweCk7IH0KICAgICAgICAgICAgNjAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC02cHgpOyB9CiAgICAgICAgICAgIDgwJSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCg2cHgpOyB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5xdWFsaXR5LWhlYWRlciB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMC41dmg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5xdWFsaXR5LXRpdGxlIHsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjdlbSwgMS40dmgsIDAuOWVtKTsKICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktc2NvcmUgewogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDEuOGVtLCA0dmgsIDNlbSk7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA4MDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjNzOwogICAgICAgIH0KICAgICAgICAucXVhbGl0eS1zY29yZS5sb3cgeyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIC5xdWFsaXR5LXNjb3JlLm1lZGl1bSB7IGNvbG9yOiB2YXIoLS13YXJuaW5nKTsgfQogICAgICAgIC5xdWFsaXR5LXNjb3JlLmdvb2QgeyBjb2xvcjogdmFyKC0tc3VjY2Vzcyk7IH0KICAgICAgICAucXVhbGl0eS1zY29yZS5ncmVhdCB7IGNvbG9yOiAjMDU5NjY5OyB0ZXh0LXNoYWRvdzogMCAwIDEwcHggcmdiYSg1LDE1MCwxMDUsMC4zKTsgfQogICAgICAgIAogICAgICAgIC5xdWFsaXR5LXNjb3JlLnB1bHNlIHsKICAgICAgICAgICAgYW5pbWF0aW9uOiBxdWFsaXR5UHVsc2UgMC4zcyBlYXNlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBAa2V5ZnJhbWVzIHF1YWxpdHlQdWxzZSB7CiAgICAgICAgICAgIDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMSk7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktYmFyLWNvbnRhaW5lciB7CiAgICAgICAgICAgIGhlaWdodDogY2xhbXAoOHB4LCAxLjV2aCwgMTRweCk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNFNUU3RUI7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgbWFyZ2luOiAwLjV2aCAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAucXVhbGl0eS1iYXIgewogICAgICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuM3M7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgdmFyKC0tZGFuZ2VyKSwgdmFyKC0td2FybmluZyksIHZhcigtLXN1Y2Nlc3MpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktZmFjdG9ycyB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICBnYXA6IDF2dzsKICAgICAgICAgICAgZmxleC13cmFwOiB3cmFwOwogICAgICAgICAgICBmb250LXNpemU6IGNsYW1wKDAuNmVtLCAxLjJ2aCwgMC44NWVtKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnF1YWxpdHktZmFjdG9yIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgZ2FwOiAwLjN2dzsKICAgICAgICAgICAgcGFkZGluZzogMC4zdmggMC44dnc7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmctbGlnaHQpOwogICAgICAgIH0KICAgICAgICAucXVhbGl0eS1mYWN0b3IucG9zaXRpdmUgeyBjb2xvcjogdmFyKC0tc3VjY2Vzcyk7IGJhY2tncm91bmQ6ICNEQ0ZDRTc7IH0KICAgICAgICAucXVhbGl0eS1mYWN0b3IubmVnYXRpdmUgeyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgYmFja2dyb3VuZDogI0ZFRTJFMjsgfQogICAgICAgIC5xdWFsaXR5LWZhY3Rvci5uZXV0cmFsIHsgY29sb3I6IHZhcigtLXRleHQtbWVkaXVtKTsgfQogICAgICAgIAogICAgICAgIC5kZWNpc2lvbi1pbmZvIHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxdmg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC43ZW0sIDEuNXZoLCAxZW0pOwogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOwogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgIH0KICAgICAgICAuZGVjaXNpb24taW5mby5yZWFkeSB7IGNvbG9yOiB2YXIoLS1zdWNjZXNzKTsgZm9udC13ZWlnaHQ6IDcwMDsgfQogICAgICAgIC5kZWNpc2lvbi1pbmZvLndhcm4geyBjb2xvcjogdmFyKC0td2FybmluZyk7IGZvbnQtd2VpZ2h0OiA3MDA7IH0KICAgICAgICAKICAgICAgICAuZGVjaXNpb24tYnRucyB7IGRpc3BsYXk6IGZsZXg7IGdhcDogMXZ3OyB9CiAgICAgICAgCiAgICAgICAgLmRlY2lzaW9uLWJ0biB7CiAgICAgICAgICAgIGZsZXg6IDE7CiAgICAgICAgICAgIHBhZGRpbmc6IDEuMnZoOwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgZm9udC1zaXplOiBjbGFtcCgwLjhlbSwgMS42dmgsIDEuMWVtKTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMXM7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgM3B4IDEwcHggcmdiYSgwLDAsMCwwLjE1KTsKICAgICAgICB9CiAgICAgICAgLmRlY2lzaW9uLWJ0bi5hcHByb3ZlIHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzIyQzU1RSwgIzE2QTM0QSk7IGNvbG9yOiB3aGl0ZTsgfQogICAgICAgIC5kZWNpc2lvbi1idG4ucmVqZWN0IHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzlDQTNBRiwgIzZCNzI4MCk7IGNvbG9yOiB3aGl0ZTsgfQogICAgICAgIC5kZWNpc2lvbi1idG46aG92ZXI6bm90KDpkaXNhYmxlZCkgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMDIpOyBib3gtc2hhZG93OiAwIDVweCAxNXB4IHJnYmEoMCwwLDAsMC4yKTsgfQogICAgICAgIAogICAgICAgIC5ldmVudC1sb2cgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7CiAgICAgICAgICAgIHBhZGRpbmc6IDAuNXZoIDF2dzsKICAgICAgICAgICAgbWF4LWhlaWdodDogMy41dmg7CiAgICAgICAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICAgICAgICAgIGZvbnQtc2l6ZTogY2xhbXAoMC42ZW0sIDEuMnZoLCAwLjhlbSk7CiAgICAgICAgICAgIGJvcmRlci10b3A6IDFweCBzb2xpZCB2YXIoLS1ib3JkZXIpOwogICAgICAgICAgICBmbGV4LXNocmluazogMDsKICAgICAgICB9CiAgICAgICAgLmV2ZW50LWl0ZW0geyBjb2xvcjogdmFyKC0tdGV4dC1tZWRpdW0pOyBwYWRkaW5nOiAwLjJ2aCAwOyB9CiAgICAgICAgLmV2ZW50LWl0ZW0uYmFkIHsgY29sb3I6IHZhcigtLWRhbmdlcik7IGZvbnQtd2VpZ2h0OiA3MDA7IH0KICAgICAgICAuZXZlbnQtaXRlbS5nb29kIHsgY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgLmV2ZW50LWl0ZW0ud2FybiB7IGNvbG9yOiB2YXIoLS13YXJuaW5nKTsgZm9udC13ZWlnaHQ6IDcwMDsgfQogICAgICAgIC5ldmVudC1pdGVtLmNlbyB7IGNvbG9yOiAjOTMzM0VBOyBmb250LXdlaWdodDogNzAwOyB9CiAgICAgICAgCiAgICAgICAgLyogPT09PT09PT09PSBSRVNVTFQgU0NSRUVOID09PT09PT09PT0gKi8KICAgICAgICAucmVzdWx0LXNjcmVlbiB7CiAgICAgICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICAgICAgICAgIHBhZGRpbmc6IDM1cHggMzBweDsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCB2YXIoLS1iZy1jcmVhbSksIHZhcigtLWJnLWxpZ2h0KSk7CiAgICAgICAgfQogICAgICAgIC5yZXN1bHQtc2NyZWVuLmFjdGl2ZSB7IGRpc3BsYXk6IGJsb2NrOyB9CiAgICAgICAgLnJlc3VsdC1zY3JlZW4gaDIgeyBmb250LXNpemU6IDEuN2VtOyBtYXJnaW4tYm90dG9tOiAxMnB4OyB9CiAgICAgICAgLnJlc3VsdC1zY3JlZW4ud2luIGgyIHsgY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyB9CiAgICAgICAgLnJlc3VsdC1zY3JlZW4ucGFydGlhbCBoMiB7IGNvbG9yOiB2YXIoLS13YXJuaW5nKTsgfQogICAgICAgIC5yZXN1bHQtc2NyZWVuLmxvc2UgaDIgeyBjb2xvcjogdmFyKC0tZGFuZ2VyKTsgfQogICAgICAgIAogICAgICAgIC5yZXN1bHQtbWVzc2FnZSB7IAogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsgCiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDIycHg7IAogICAgICAgICAgICBsaW5lLWhlaWdodDogMS41OyAKICAgICAgICAgICAgZm9udC1zaXplOiAwLjk1ZW07IAogICAgICAgICAgICBtYXgtd2lkdGg6IDUwMHB4OyAKICAgICAgICAgICAgbWFyZ2luLWxlZnQ6IGF1dG87IAogICAgICAgICAgICBtYXJnaW4tcmlnaHQ6IGF1dG87CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5yZXN1bHQtZ3JpZCB7IGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBnYXA6IDE0cHg7IGZsZXgtd3JhcDogd3JhcDsgbWFyZ2luLWJvdHRvbTogMjJweDsgfQogICAgICAgIC5yZXN1bHQtY2FyZCB7IAogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iZy13aGl0ZSk7IAogICAgICAgICAgICBwYWRkaW5nOiAxNHB4IDIycHg7IAogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OyAKICAgICAgICAgICAgbWluLXdpZHRoOiAxMDBweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgdmFyKC0tYm9yZGVyKTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAzcHggMTBweCByZ2JhKDAsMCwwLDAuMDgpOwogICAgICAgIH0KICAgICAgICAucmVzdWx0LWNhcmQgLnItdmFsdWUgeyBmb250LXNpemU6IDEuNWVtOyBmb250LXdlaWdodDogNzAwOyBjb2xvcjogdmFyKC0tYXViZXJnaW5lKTsgfQogICAgICAgIC5yZXN1bHQtY2FyZCAuci1sYWJlbCB7IGZvbnQtc2l6ZTogMC43ZW07IGNvbG9yOiB2YXIoLS10ZXh0LW1lZGl1bSk7IG1hcmdpbi10b3A6IDRweDsgZm9udC13ZWlnaHQ6IDYwMDsgfQogICAgICAgIC5yZXN1bHQtY2FyZC5nb29kIC5yLXZhbHVlIHsgY29sb3I6IHZhcigtLXN1Y2Nlc3MpOyB9CiAgICAgICAgLnJlc3VsdC1jYXJkLmJhZCAuci12YWx1ZSB7IGNvbG9yOiB2YXIoLS1kYW5nZXIpOyB9CiAgICAgICAgCiAgICAgICAgLmhpZGRlbiB7IGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImdhbWUtY29udGFpbmVyIj4KICAgICAgICA8IS0tID09PT09PT09PT0gVElUTEUgU0NSRUVOID09PT09PT09PT0gLS0+CiAgICAgICAgPGRpdiBjbGFzcz0idGl0bGUtc2NyZWVuIiBpZD0idGl0bGUtc2NyZWVuIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idGl0bGUtaGVhZGVyIj4KICAgICAgICAgICAgICAgIDxoMT7wn6qRIENvbW1pdHRlZSBDaGFvczwvaDE+CiAgICAgICAgICAgICAgICA8cCBjbGFzcz0ic3VidGl0bGUiPkdldCA1IGhpZ2gtcXVhbGl0eSBkZWNpc2lvbnMgdGhyb3VnaCBhIHRlbnNlIGNvbW1pdHRlZSBtZWV0aW5nPC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0dXRvcmlhbC1zZWN0aW9uIj4KICAgICAgICAgICAgICAgICAgICA8aDM+8J+OryBZb3VyIEdvYWw6IFF1YWxpdHkgRGVjaXNpb25zPC9oMz4KICAgICAgICAgICAgICAgICAgICA8cD5Zb3UncmUgY2hhaXJpbmcgYW4gUiZEIGNvbW1pdHRlZS4gR2V0IDxzcGFuIGNsYXNzPSJoaWdobGlnaHQiPjUgaGlnaC1xdWFsaXR5IGRlY2lzaW9uczwvc3Bhbj4gKDU1JSsgZWFjaCkgaW4gPHNwYW4gY2xhc3M9ImhpZ2hsaWdodCI+NzUgc2Vjb25kczwvc3Bhbj4uPC9wPgogICAgICAgICAgICAgICAgICAgIDxwPjxzcGFuIGNsYXNzPSJzdWNjZXNzLXRleHQiPlRoZSBrZXk6PC9zcGFuPiA8c3Ryb25nPldhaXQgZm9yIHBlb3BsZSB0byBzcGVhayE8L3N0cm9uZz4gUXVhbGl0eSBqdW1wcyArMTUlIGZvciBlYWNoIHZvaWNlIGhlYXJkLiBUaGUgYmFyIHR1cm5zIGdyZWVuIHdoZW4gMysgcGVvcGxlIGhhdmUgY29udHJpYnV0ZWQuIDxzcGFuIGNsYXNzPSJkYW5nZXItdGV4dCI+UnVzaGluZyA9IGxvdyBxdWFsaXR5ITwvc3Bhbj48L3A+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idHV0b3JpYWwtc2VjdGlvbiI+CiAgICAgICAgICAgICAgICAgICAgPGgzPuKaoSBUaGUgRHJhbWE8L2gzPgogICAgICAgICAgICAgICAgICAgIDxwPjxzcGFuIGNsYXNzPSJkYW5nZXItdGV4dCI+Q29uZmxpY3RzIGJ1aWxkIHVwITwvc3Bhbj4gUmFqIHZzIFByaXlhIGFuZCBEZXYgdnMgQW5pdGEgYXJlIHJpdmFscy4gWW91J2xsIHNlZSA8c3BhbiBjbGFzcz0iaGlnaGxpZ2h0Ij53YXJuaW5nIHNpZ25zPC9zcGFuPiBiZWZvcmUgdGhleSBjbGFzaCDigJQgdGVuc2UgbG9va3MsIHNuaXBweSBjb21tZW50cy48L3A+CiAgICAgICAgICAgICAgICAgICAgPHA+PHNwYW4gY2xhc3M9InN1Y2Nlc3MtdGV4dCI+UHJvIHRpcDo8L3NwYW4+IFVzZSDwn5WK77iPIERlZnVzZSBkdXJpbmcgdGhlIGJ1aWxkdXAgdG8gPHN0cm9uZz5wcmV2ZW50IHRoZSBjb25mbGljdCBlbnRpcmVseSE8L3N0cm9uZz4gV2F0Y2ggZm9yIHllbGxvdyBnbG93aW5nIGF2YXRhcnMuPC9wPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR3by1jb2wiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8aDM+8J+TiiBXaGF0IEFmZmVjdHMgUXVhbGl0eTwvaDM+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWljb24iPvCfl6PvuI88L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5Wb2ljZXM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj48c3Ryb25nPisxNSUgcGVyIHBlcnNvbiE8L3N0cm9uZz4gV2FpdCBmb3IgMy00IHZvaWNlcyBiZWZvcmUgZGVjaWRpbmcuIFRoaXMgaXMgdGhlIGtleSE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7ij7M8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5QYXRpZW5jZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWRlc2MiPjxzdHJvbmc+RG9uJ3QgcnVzaCE8L3N0cm9uZz4gRGVjaWRpbmcgd2l0aCAmbHQ7MiB2b2ljZXMgPSBiaWcgcGVuYWx0eSArIGFuZ3J5IHBlb3BsZS48L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7imqE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5Db25mbGljdHM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj48c3Ryb25nPi0xMiUgcXVhbGl0eTwvc3Ryb25nPiB3aGlsZSBhY3RpdmUuIERlZnVzZSBiZWZvcmUgZGVjaWRpbmchPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+8J+RlDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLW5hbWUiPkNFTyBDYXJkPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktZGVzYyI+PHN0cm9uZz4tMTAlIHF1YWxpdHk8L3N0cm9uZz4gcGVuYWx0eS4gTnVjbGVhciBvcHRpb24gb25seS48L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8aDM+8J+OrCBZb3VyIEFjdGlvbnM8L2gzPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7wn5GPPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktbmFtZSI+QWNrbm93bGVkZ2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj5WYWxpZGF0ZSBhIHNwZWFrZXIuIENhbG1zIGZydXN0cmF0ZWQgcGVvcGxlLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tcm93IiBzdHlsZT0iYmFja2dyb3VuZDogI0YzRThGRjsgYm9yZGVyLWNvbG9yOiAjRDhCNEZFOyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1pY29uIj7wn5ej77iPPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktbmFtZSI+SW52aXRlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktZGVzYyI+PHN0cm9uZz5LRVkgQUNUSU9OITwvc3Ryb25nPiBCcmluZ3MgaW4gcXVpZXQgbWVtYmVycy4gU29tZSB3b24ndCBzcGVhayB3aXRob3V0IHRoaXMhPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+8J+Viu+4jzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLW5hbWUiPkRlZnVzZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWRlc2MiPjxzdHJvbmc+UHJldmVudCBvciByZXNvbHZlIGNvbmZsaWN0cyE8L3N0cm9uZz4gVXNlIHdoZW4geW91IHNlZSB3YXJuaW5nIHNpZ25zLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImluZm8tcm93Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWljb24iPvCfmII8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1uYW1lIj5Kb2tlPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktZGVzYyI+PHN0cm9uZz5SZXN0b3JlcyBlbmVyZ3khPC9zdHJvbmc+IFJlbGlldmVzIHRlbnNpb24uIEJldHRlciB3aGVuIHRpcmVkLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWxpbWl0Ij7DlzI8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmZvLXJvdyIgc3R5bGU9ImJhY2tncm91bmQ6ICNGRUYzQzc7IGJvcmRlci1jb2xvcjogI0ZERTY4QTsiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+4piVPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktbmFtZSI+QnJlYWs8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1kZXNjIj48c3Ryb25nPkJJRyBlbmVyZ3kgcmVzdG9yZTwvc3Ryb25nPiArIHJlc2V0IGNvb2xkb3ducy4gTW9yZSBlZmZlY3RpdmUgd2hlbiB0aXJlZCE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaS1saW1pdCI+w5cxPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5mby1yb3ciPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImktaWNvbiI+8J+RlDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLW5hbWUiPkNFTzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWRlc2MiPk51Y2xlYXIgb3B0aW9uLiBFbmRzIGNyaXNpcywgdGFua3MgbW9yYWxlLjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpLWxpbWl0Ij7DlzE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InR1dG9yaWFsLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgIDxoMz7imqDvuI8gSG93IFlvdSBMb3NlPC9oMz4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmYWlsLWdyaWQiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmYWlsLWl0ZW0iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZi1pY29uIj7wn5KlPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmLXRleHQiPlRlbnNpb24gaGl0cyAxMDAlPGJyPk1lZXRpbmcgZXhwbG9kZXM8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZhaWwtaXRlbSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmLWljb24iPvCfmKk8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImYtdGV4dCI+RW5lcmd5IGhpdHMgMCU8YnI+RXZlcnlvbmUgZ2l2ZXMgdXA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZhaWwtaXRlbSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmLWljb24iPuKPsDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZi10ZXh0Ij5NaXNzIGRlY2lzaW9uczxicj4tMTUlIHF1YWxpdHkgZWFjaDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrZXktcG9pbnQiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrcC10aXRsZSI+8J+SoSBLZXkgU3RyYXRlZ3k6IE9yZ2FuaWMgVm9pY2VzIE1hdHRlciBNb3N0ITwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrcC10ZXh0Ij5XYWl0IGZvciBwZW9wbGUgdG8gPHN0cm9uZz5zcGVhayBuYXR1cmFsbHk8L3N0cm9uZz4g4oCUIG9yZ2FuaWMgdm9pY2VzIGFkZCBtb3JlIHF1YWxpdHkgdGhhbiBpbnZpdGVkIG9uZXMuIFVzZSDwn5ej77iPIEludml0ZSBvbmx5IGZvciBxdWlldCBtZW1iZXJzIHdobyB3b24ndCBzcGVhayB1cCBvbiB0aGVpciBvd24uIDxzcGFuIGNsYXNzPSJkYW5nZXItdGV4dCI+T3Zlci1pbnZpdGluZyBmZWVscyBmb3JjZWQgYW5kIGh1cnRzIHF1YWxpdHkhPC9zcGFuPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImtleS1wb2ludCIgc3R5bGU9ImJhY2tncm91bmQ6ICNGRUYzQzc7IGJvcmRlci1jb2xvcjogI0ZERTY4QTsiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrcC10aXRsZSI+8J+UpSBXYXRjaCBmb3IgU2ltbWVyaW5nIElzc3VlcyE8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ia3AtdGV4dCI+RWFjaCBwcm9qZWN0IGhhcyA8c3Ryb25nPnVuZGVybHlpbmcgY29uY2VybnM8L3N0cm9uZz4gKGJ1ZGdldCwgdGVjaG5pY2FsLCB0aW1lbGluZSkgdGhhdCBidWlsZCB1cC4gV2hlbiB3YXJuZWQsIDxzdHJvbmc+Z2V0IHRoYXQgcGVyc29uIHRvIHNwZWFrPC9zdHJvbmc+IHRvIGFkZHJlc3MgdGhlIGlzc3VlIGJlZm9yZSBkZWNpZGluZywgb3IgZmFjZSBxdWFsaXR5IHBlbmFsdGllcyE8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrZXktcG9pbnQiIHN0eWxlPSJiYWNrZ3JvdW5kOiAjREJFQUZFOyBib3JkZXItY29sb3I6ICM5M0M1RkQ7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ia3AtdGl0bGUiPuKaoSBXYXRjaCB0aGUgRW5lcmd5ITwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJrcC10ZXh0Ij5FbmVyZ3kgZHJhaW5zIHRocm91Z2hvdXQgdGhlIG1lZXRpbmcuIDxzdHJvbmc+TG93IGVuZXJneSA9IHRpcmVkIGZhY2VzLCB3b3JzZSBkZWNpc2lvbnM8L3N0cm9uZz4sIGZhc3RlciBjb25mbGljdHMuIFVzZSDwn5iCIEpva2VzIGZvciBzbWFsbCBlbmVyZ3kgYm9vc3RzLiBTYXZlIHRoZSDimJUgQnJlYWsgZm9yIHdoZW4gZW5lcmd5IGdldHMgY3JpdGljYWwhPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFydC1zZWN0aW9uIj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InN0YXJ0LWJ0biIgb25jbGljaz0ic3RhcnRHYW1lKCkiPlN0YXJ0IHRoZSBNZWV0aW5nIPCfjqw8L2J1dHRvbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPCEtLSA9PT09PT09PT09IEdBTUUgU0NSRUVOID09PT09PT09PT0gLS0+CiAgICAgICAgPGRpdiBjbGFzcz0iZ2FtZS1zY3JlZW4iIGlkPSJnYW1lLXNjcmVlbiI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImdhbWUtaGVhZGVyIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImhlYWRlci1sZWZ0Ij4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0aW1lci1ib3giPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0aW1lIiBpZD0idGltZXIiPjE6MDA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibGFiZWwiPlRPVEFMIFRJTUU8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9ncmVzcy1ib3giPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb3VudCIgaWQ9ImRlY2lkZWQtY291bnQiPjAvNTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJsYWJlbCI+REVDSURFRDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InBhY2UtYm94IGdvb2QiIGlkPSJwYWNlLWJveCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+T24gUGFjZTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwYWNlLWxhYmVsIj7wn5GNPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaGVhZGVyLW1ldGVycyI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaC1tZXRlciBlbmVyZ3kiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRlci1sYWJlbCI+PHNwYW4+4pqhIEVuZXJneTwvc3Bhbj48c3BhbiBpZD0iZW5lcmd5LXZhbCI+ODAlPC9zcGFuPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRlci1iYXIiIGlkPSJlbmVyZ3ktYmFyLWMiPjxkaXYgY2xhc3M9Im1ldGVyLWZpbGwiIGlkPSJlbmVyZ3ktYmFyIiBzdHlsZT0id2lkdGg6ODAlIj48L2Rpdj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJoLW1ldGVyIHRlbnNpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRlci1sYWJlbCI+PHNwYW4+8J+UpSBUZW5zaW9uPC9zcGFuPjxzcGFuIGlkPSJ0ZW5zaW9uLXZhbCI+MjUlPC9zcGFuPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZXRlci1iYXIiIGlkPSJ0ZW5zaW9uLWJhci1jIj48ZGl2IGNsYXNzPSJtZXRlci1maWxsIiBpZD0idGVuc2lvbi1iYXIiIHN0eWxlPSJ3aWR0aDoyNSUiPjwvZGl2PjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBjbGFzcz0iZ2FtZS1tYWluIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1lZXRpbmctcm9vbSIgaWQ9Im1lZXRpbmctcm9vbSI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZmxhc2gtb3ZlcmxheSBiYWQiIGlkPSJmbGFzaC1iYWQiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsYXNoLW92ZXJsYXkgZ29vZCIgaWQ9ImZsYXNoLWdvb2QiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZsYXNoLW92ZXJsYXkgY2VvIiBpZD0iZmxhc2gtY2VvIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZWV0aW5nLXRhYmxlIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyb29tLXN0YXR1cyIgaWQ9InJvb20tc3RhdHVzIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJtZW1iZXJzLWNvbnRhaW5lciI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iYnViYmxlcy1jb250YWluZXIiPjwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2wtcGFuZWwiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2plY3Qtc2VjdGlvbiI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2plY3QtaGVhZGVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxoMz7wn5OLIERFQ0lTSU9OIDxzcGFuIGlkPSJwcm9qZWN0LW51bSI+MS81PC9zcGFuPjwvaDM+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9qZWN0LXRpbWVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj5UaGlzIGl0ZW06PC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJwdC10aW1lIiBpZD0iaXRlbS10aW1lIj4wczwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvamVjdC1jYXJkIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InByb2plY3QtbmFtZSIgaWQ9InByb2plY3QtbmFtZSI+TG9hZGluZy4uLjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvamVjdC1kZXNjIiBpZD0icHJvamVjdC1kZXNjIj4uLi48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjcmlzaXMtYmFubmVyIiBpZD0iY3Jpc2lzLWJhbm5lciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iY3Jpc2lzLXRleHQiIGlkPSJjcmlzaXMtdGV4dCI+4pqhIENPTkZMSUNUPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImNyaXNpcy1oaW50Ij5Vc2Ug8J+Viu+4jyBEZWZ1c2UhPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZHJhZy13YXJuaW5nIiBpZD0iZHJhZy13YXJuaW5nIj7ij7MgRGlzY3Vzc2lvbiBkcmFnZ2luZyDigJQgdGVuc2lvbiByaXNpbmcgZmFzdGVyITwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLXJvdyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtY2hpcCIgaWQ9ImNoaXAtdm9pY2VzIj48c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5ej77iPPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiIGlkPSJ2b2ljZXMtdGV4dCI+MC80PC9zcGFuPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdHVzLWNoaXAiIGlkPSJjaGlwLWZhdGlndWUiPjxzcGFuIGNsYXNzPSJjaGlwLWljb24iPvCfmIo8L3NwYW4+PHNwYW4gY2xhc3M9ImNoaXAtdGV4dCIgaWQ9ImZhdGlndWUtdGV4dCI+RnJlc2g8L3NwYW4+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0dXMtY2hpcCIgaWQ9ImNoaXAtcm9vbSI+PHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+YkDwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij5PSzwvc3Bhbj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhdHRlbnRpb24tcm93IiBpZD0iYXR0ZW50aW9uLXJvdyI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aW9uLXNlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpb24taGVhZGVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxoND7wn46sIEFDVElPTlM8L2g0PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibGltaXRlZC1pbmZvIj5MaW1pdGVkOjxzcGFuIGlkPSJsaW0tam9rZSI+Mjwvc3Bhbj7wn5iCIDxzcGFuIGlkPSJsaW0tYnJlYWsiPjE8L3NwYW4+4piVIDxzcGFuIGlkPSJsaW0tY2VvIj4xPC9zcGFuPvCfkZQ8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1ncmlkIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImFjdGlvbi1idG4iIGlkPSJidG4tYWNrIiBvbmNsaWNrPSJkb0FjdGlvbignYWNrJykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uIj7wn5GPPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJsYWJlbCI+QWNrbm93bGVkZ2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9IndoZW4iPnJlY2VudCBzcGVha2VyPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIiBpZD0iYnRuLWludml0ZSIgb25jbGljaz0iZG9BY3Rpb24oJ2ludml0ZScpIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbiI+8J+Xo++4jzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibGFiZWwiPkludml0ZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0id2hlbiI+cXVpZXQgbWVtYmVyczwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biIgaWQ9ImJ0bi1kZWZ1c2UiIG9uY2xpY2s9ImRvQWN0aW9uKCdkZWZ1c2UnKSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24iPvCflYrvuI88L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxhYmVsIj5EZWZ1c2U8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9IndoZW4iPnByZXZlbnQvcmVzb2x2ZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biBsaW1pdGVkIiBpZD0iYnRuLWpva2UiIG9uY2xpY2s9ImRvQWN0aW9uKCdqb2tlJykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ1c2VzIiBpZD0idS1qb2tlIj4yPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uIj7wn5iCPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJsYWJlbCI+Sm9rZTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0id2hlbiI+K2VuZXJneTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYWN0aW9uLWJ0biBsaW1pdGVkIiBpZD0iYnRuLWJyZWFrIiBvbmNsaWNrPSJkb0FjdGlvbignYnJlYWsnKSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InVzZXMiIGlkPSJ1LWJyZWFrIj4xPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uIj7imJU8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxhYmVsIj5CcmVhazwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0id2hlbiI+cmVzdG9yZSBlbmVyZ3khPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJhY3Rpb24tYnRuIGxpbWl0ZWQiIGlkPSJidG4tY2VvIiBvbmNsaWNrPSJkb0FjdGlvbignY2VvJykiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ1c2VzIiBpZD0idS1jZW8iPjE8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24iPvCfkZQ8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxhYmVsIj5DRU88L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9IndoZW4iPm51Y2xlYXI8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGVjaXNpb24tc2VjdGlvbiI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InF1YWxpdHktZGlzcGxheSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWFsaXR5LWhlYWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InF1YWxpdHktdGl0bGUiPvCfjq8gREVDSVNJT04gUVVBTElUWTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icXVhbGl0eS10aXRsZSIgaWQ9InF1YWxpdHktZ29hbCI+TmVlZCAzKyB2b2ljZXMgZm9yIGdyZWVuPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWFsaXR5LXNjb3JlIG1lZGl1bSIgaWQ9InF1YWxpdHktc2NvcmUiPjM1JTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icXVhbGl0eS1iYXItY29udGFpbmVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJxdWFsaXR5LWJhciIgaWQ9InF1YWxpdHktYmFyIiBzdHlsZT0id2lkdGg6IDM1JSI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InF1YWxpdHktZmFjdG9ycyIgaWQ9InF1YWxpdHktZmFjdG9ycyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5ldXRyYWwiPvCfl6PvuI8gMC80IHZvaWNlczwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmV1dHJhbCI+4o+zIFdhaXRpbmcuLi48L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRlY2lzaW9uLWluZm8iIGlkPSJkZWNpc2lvbi1pbmZvIj5HZXQgbW9yZSB2b2ljZXMgaGVhcmQgdG8gaW1wcm92ZSBxdWFsaXR5PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImRlY2lzaW9uLWJ0bnMiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVjaXNpb24tYnRuIGFwcHJvdmUiIG9uY2xpY2s9Im1ha2VEZWNpc2lvbignYXBwcm92ZScpIj7inJMgQXBwcm92ZTwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iZGVjaXNpb24tYnRuIHJlamVjdCIgb25jbGljaz0ibWFrZURlY2lzaW9uKCdyZWplY3QnKSI+4pyXIFJlamVjdDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImV2ZW50LWxvZyIgaWQ9ImV2ZW50LWxvZyI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPCEtLSA9PT09PT09PT09IFJFU1VMVCBTQ1JFRU4gPT09PT09PT09PSAtLT4KICAgICAgICA8ZGl2IGNsYXNzPSJyZXN1bHQtc2NyZWVuIiBpZD0icmVzdWx0LXNjcmVlbiI+CiAgICAgICAgICAgIDxoMiBpZD0icmVzdWx0LXRpdGxlIj5NZWV0aW5nIE92ZXI8L2gyPgogICAgICAgICAgICA8cCBjbGFzcz0icmVzdWx0LW1lc3NhZ2UiIGlkPSJyZXN1bHQtbWVzc2FnZSI+PC9wPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJyZXN1bHQtZ3JpZCIgaWQ9InJlc3VsdC1ncmlkIj48L2Rpdj4KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0ic3RhcnQtYnRuIiBvbmNsaWNrPSJzZW5kUmVzdWx0VG9QYXJlbnQoKSI+Q29udGludWUg4oaSPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIAogICAgPHNjcmlwdD4KICAgICAgICBjb25zdCBNRU1CRVJTID0gWwogICAgICAgICAgICB7IGlkOiAnY2VvJywgbmFtZTogJ01lZXJhJywgaWNvbjogJ/CfkZQnLCBjb2xvcjogJyM5MzMzRUEnLCBwb3M6IHsgdG9wOiAnMyUnLCBsZWZ0OiAnNTAlJywgdHJhbnNmb3JtOiAndHJhbnNsYXRlWCgtNTAlKScgfSwgaXNDRU86IHRydWUgfSwKICAgICAgICAgICAgeyBpZDogJ3RlY2gnLCBuYW1lOiAnUmFqJywgaWNvbjogJ/CflKwnLCBjb2xvcjogJyMwRUE1RTknLCBwb3M6IHsgdG9wOiAnMzIlJywgbGVmdDogJzIlJyB9LCByaXZhbDogJ2ZpbmFuY2UnLCBhc3NlcnRpdmU6IDAuOCB9LAogICAgICAgICAgICB7IGlkOiAnZmluYW5jZScsIG5hbWU6ICdQcml5YScsIGljb246ICfwn5KwJywgY29sb3I6ICcjMjJDNTVFJywgcG9zOiB7IHRvcDogJzMyJScsIHJpZ2h0OiAnMiUnIH0sIHJpdmFsOiAndGVjaCcsIGFzc2VydGl2ZTogMC44NSB9LAogICAgICAgICAgICB7IGlkOiAnbWt0JywgbmFtZTogJ0RldicsIGljb246ICfwn5OiJywgY29sb3I6ICcjRjU5RTBCJywgcG9zOiB7IGJvdHRvbTogJzE4JScsIGxlZnQ6ICcyJScgfSwgcml2YWw6ICdvcHMnLCBhc3NlcnRpdmU6IDAuNiB9LAogICAgICAgICAgICB7IGlkOiAnb3BzJywgbmFtZTogJ0FuaXRhJywgaWNvbjogJ+Kame+4jycsIGNvbG9yOiAnI0VGNDQ0NCcsIHBvczogeyBib3R0b206ICcxOCUnLCByaWdodDogJzIlJyB9LCByaXZhbDogJ21rdCcsIGFzc2VydGl2ZTogMC40NSB9CiAgICAgICAgXTsKICAgICAgICAKICAgICAgICBjb25zdCBQUk9KRUNUUyA9IFsKICAgICAgICAgICAgeyBuYW1lOiAn8J+kliBBSSBBc3Npc3RhbnQnLCBkZXNjOiAnQ3VzdG9tZXIgY2hhdGJvdC4gVGVjaCB2cyBGaW5hbmNlIGNsYXNoLicgfSwKICAgICAgICAgICAgeyBuYW1lOiAn8J+MsSBHcmVlbiBJbml0aWF0aXZlJywgZGVzYzogJ0NhcmJvbiByZWR1Y3Rpb24uIE9wcyBkcmVhZHMgaXQuJyB9LAogICAgICAgICAgICB7IG5hbWU6ICfwn5OIIEFuYWx5dGljcyBQbGF0Zm9ybScsIGRlc2M6ICdEYXRhIHVuaWZpY2F0aW9uLiBFdmVyeW9uZSBkaXNhZ3JlZXMuJyB9LAogICAgICAgICAgICB7IG5hbWU6ICfimpnvuI8gUHJvY2VzcyBBdXRvbWF0aW9uJywgZGVzYzogJ1F1aWNrIGZpeCB2cyBwcm9wZXIgYXJjaGl0ZWN0dXJlLicgfSwKICAgICAgICAgICAgeyBuYW1lOiAn8J+UrCBMYWIgRXhwYW5zaW9uJywgZGVzYzogJ0xvbmctdGVybSB2cyBpbW1lZGlhdGUgYnVkZ2V0LicgfQogICAgICAgIF07CiAgICAgICAgCiAgICAgICAgY29uc3QgUEhSQVNFUyA9IHsKICAgICAgICAgICAgYW5ncnk6IFsiUmlkaWN1bG91cyEiLCAiTm90IGxpc3RlbmluZyEiLCAiQWJzdXJkISIsICJEaXNhZ3JlZSEiLCAiVW5hY2NlcHRhYmxlISIsICJObyB3YXkhIiwgIlRoaXMgaXMgd3JvbmchIl0sCiAgICAgICAgICAgIGNvbmNlcm46IFsiQ29uY2VybnMgaGVyZS4iLCAiQnVkZ2V0IGlzc3VlLiIsICJUb28gcmlza3kuIiwgIlJPST8iLCAiVGltZWxpbmU/IiwgIlJlc291cmNlcz8iLCAiV2hvIG93bnMgdGhpcz8iXSwKICAgICAgICAgICAgdGlyZWQ6IFsiKnlhd24qIiwgIipzaWdoKiIsICJXcmFwIHVwPyIsICJHb2luZyBsb25nLi4uIiwgIkNhbiB3ZSBtb3ZlIG9uPyIsICJIb3cgbXVjaCBsb25nZXI/IiwgIk5lZWQgY29mZmVlLi4uIiwgIkxvc3QgbXkgdHJhaW4gb2YgdGhvdWdodCIsICJXaGF0IHdlcmUgd2Ugc2F5aW5nPyIsICJJJ20gZmFkaW5nIGhlcmUuLi4iXSwKICAgICAgICAgICAgZ29vZDogWyJGYWlyIHBvaW50LiIsICJNYWtlcyBzZW5zZS4iLCAiQWdyZWVkLiIsICJJIGNhbiB3b3JrIHdpdGggdGhhdC4iLCAiR29vZCBpZGVhLiJdLAogICAgICAgICAgICBjb25mbGljdDogWyJXcm9uZyEiLCAiTm9uc2Vuc2UhIiwgIkxldCBtZSBmaW5pc2ghIiwgIllvdSBhbHdheXMgZG8gdGhpcyEiLCAiVGhhdCdzIG5vdCB0cnVlISIsICJMaXN0ZW4gdG8gbWUhIl0sCiAgICAgICAgICAgIGpva2VzOiBbIlRvbyBtYW55IHN0YWtlaG9sZGVycyEg8J+lgSIsICJUaW1lbGluZT8gQXNwaXJhdGlvbmFsISDwn5iFIiwgIkJ1ZGdldCA9IHJlamVjdCEg8J+SuCJdLAogICAgICAgICAgICBjZW86IFsiSSdtIGRlY2lkaW5nLiIsICJNb3Zpbmcgb24uIiwgIkVub3VnaC4iLCAiRmluYWwgd29yZC4iLCAiV2UncmUgZG9uZSBoZXJlLiJdLAogICAgICAgICAgICBlbmVyZ3lMb3c6IFsiRXZlcnlvbmUgbG9va3MgdGlyZWQuLi4iLCAiVGhlIHJvb20gaXMgbG9zaW5nIGZvY3VzLiIsICJBdHRlbnRpb24gaXMgZHJpZnRpbmcuIiwgIlBlb3BsZSBhcmUgY2hlY2tpbmcgcGhvbmVzLiJdCiAgICAgICAgfTsKICAgICAgICAKICAgICAgICBsZXQgRyA9IHt9OwogICAgICAgIGxldCB0aW1lckludCwgdGlja0ludCwgdGVuc2lvbkludDsKICAgICAgICAKICAgICAgICBmdW5jdGlvbiBzdGFydEdhbWUoKSB7CiAgICAgICAgICAgIEcgPSB7CiAgICAgICAgICAgICAgICBydW5uaW5nOiB0cnVlLAogICAgICAgICAgICAgICAgdGltZTogNzUsCiAgICAgICAgICAgICAgICBlbmVyZ3k6IDkwLAogICAgICAgICAgICAgICAgdGVuc2lvbjogMTAsCiAgICAgICAgICAgICAgICBwcm9qZWN0OiAwLAogICAgICAgICAgICAgICAgaXRlbVRpbWU6IDAsCiAgICAgICAgICAgICAgICBkZWNpc2lvbnM6IFtdLAogICAgICAgICAgICAgICAgZGlzY3Vzc2lvbjogeyB2b2ljZXM6IG5ldyBTZXQoKSwgb3JnYW5pY1ZvaWNlczogbmV3IFNldCgpLCBpbnZpdGVkVm9pY2VzOiBuZXcgU2V0KCksIHBvaW50czogMCwgaW52aXRlQ291bnQ6IDAgfSwKICAgICAgICAgICAgICAgIG1lbWJlcnM6IHt9LAogICAgICAgICAgICAgICAgY29uZmxpY3Q6IG51bGwsCiAgICAgICAgICAgICAgICB1c2VzOiB7IGpva2U6IDIsIGJyZWFrOiAxLCBjZW86IDEgfSwKICAgICAgICAgICAgICAgIGNlb1VzZWQ6IDAsCiAgICAgICAgICAgICAgICBjb29sZG93bnM6IHt9LAogICAgICAgICAgICAgICAgbGFzdFNwZWFrZXI6IG51bGwsCiAgICAgICAgICAgICAgICBjb25mbGljdENvdW50OiAwLAogICAgICAgICAgICAgICAgbGFzdENvbmZsaWN0VGltZTogMCwKICAgICAgICAgICAgICAgIGd1YXJhbnRlZWRDb25mbGljdHM6IFtdLAogICAgICAgICAgICAgICAgcnVzaFdhcm5lZDogZmFsc2UsCiAgICAgICAgICAgICAgICAvLyBTaW1tZXJpbmcgaXNzdWVzIC0gc2xvdy1idWlsZGluZyB0ZW5zaW9ucyB0aGF0IG5lZWQgcmVzb2x1dGlvbgogICAgICAgICAgICAgICAgc2ltbWVyaW5nSXNzdWVzOiB7CiAgICAgICAgICAgICAgICAgICAgYnVkZ2V0OiB7IGxldmVsOiAwLCBvd25lcjogJ2ZpbmFuY2UnLCBuYW1lOiAn8J+SuCBCdWRnZXQgQ29uY2VybnMnLCB3YXJuZWQ6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAgICAgdGVjaG5pY2FsOiB7IGxldmVsOiAwLCBvd25lcjogJ3RlY2gnLCBuYW1lOiAn8J+UpyBUZWNobmljYWwgRGVidCcsIHdhcm5lZDogZmFsc2UgfSwKICAgICAgICAgICAgICAgICAgICB0aW1lbGluZTogeyBsZXZlbDogMCwgb3duZXI6ICdvcHMnLCBuYW1lOiAn4o+wIFRpbWVsaW5lIFByZXNzdXJlJywgd2FybmVkOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgICAgIG1hcmtldDogeyBsZXZlbDogMCwgb3duZXI6ICdta3QnLCBuYW1lOiAn8J+TiiBNYXJrZXQgUHJlc3N1cmUnLCB3YXJuZWQ6IGZhbHNlIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvd2VyIHN0YXJ0aW5nIGZydXN0cmF0aW9uCiAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXSA9IHsKICAgICAgICAgICAgICAgICAgICBmcnVzdHJhdGlvbjogMTAgKyBNYXRoLnJhbmRvbSgpICogMTIsCiAgICAgICAgICAgICAgICAgICAgd2FudHNTcGVhazogTWF0aC5yYW5kb20oKSA8IChtLmFzc2VydGl2ZSB8fCAwLjUpICogMC42LCAvLyBNb3JlIGxpa2VseSB0byB3YW50IHRvIHNwZWFrCiAgICAgICAgICAgICAgICAgICAgbGFzdFNwb2tlOiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAzKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSaXZhbHMgYSBiaXQgbW9yZSBmcnVzdHJhdGVkIGJ1dCBub3QgdG9vIG11Y2gKICAgICAgICAgICAgRy5tZW1iZXJzLnRlY2guZnJ1c3RyYXRpb24gPSAyNTsKICAgICAgICAgICAgRy5tZW1iZXJzLmZpbmFuY2UuZnJ1c3RyYXRpb24gPSAyNDsKICAgICAgICAgICAgRy5tZW1iZXJzLm1rdC5mcnVzdHJhdGlvbiA9IDIwOwogICAgICAgICAgICBHLm1lbWJlcnMub3BzLmZydXN0cmF0aW9uID0gMjI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHVUFSQU5URUUgMiBjb25mbGljdHMgYXQgc3BlY2lmaWMgdGltZXMgLSBwbGVudHkgb2Ygd2FybmluZwogICAgICAgICAgICAvLyBGaXJzdCBjb25mbGljdDogYmV0d2VlbiAyMi0zMiBzZWNvbmRzICh3aXRoIDEwIHNlYyBidWlsZHVwIHN0YXJ0aW5nIGF0IDEyLTIyKQogICAgICAgICAgICBjb25zdCBjb25mbGljdDFUaW1lID0gMjIgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMCk7CiAgICAgICAgICAgIC8vIFNlY29uZCBjb25mbGljdDogYmV0d2VlbiA1MC02NSBzZWNvbmRzICAKICAgICAgICAgICAgY29uc3QgY29uZmxpY3QyVGltZSA9IDUwICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTUpOwogICAgICAgICAgICAKICAgICAgICAgICAgRy5ndWFyYW50ZWVkQ29uZmxpY3RzID0gWwogICAgICAgICAgICAgICAgeyB0aW1lOiBjb25mbGljdDFUaW1lLCBwYWlyOiBbJ3RlY2gnLCAnZmluYW5jZSddLCB0cmlnZ2VyZWQ6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICB7IHRpbWU6IGNvbmZsaWN0MlRpbWUsIHBhaXI6IFsnbWt0JywgJ29wcyddLCB0cmlnZ2VyZWQ6IGZhbHNlIH0KICAgICAgICAgICAgXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGJ1aWxkUm9vbSgpOwogICAgICAgICAgICBsb2FkUHJvamVjdCgwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aXRsZS1zY3JlZW4nKS5jbGFzc0xpc3QuYWRkKCdoaWRkZW4nKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3VsdC1zY3JlZW4nKS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtc2NyZWVuJykuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdldmVudC1sb2cnKS5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIFsnam9rZScsICdicmVhaycsICdjZW8nXS5mb3JFYWNoKGEgPT4gewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYHUtJHthfWApLnRleHRDb250ZW50ID0gRy51c2VzW2FdOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGxpbS0ke2F9YCkudGV4dENvbnRlbnQgPSBHLnVzZXNbYV07CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgYnRuLSR7YX1gKS5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZygn8J+TiyBNZWV0aW5nIGJlZ2lucy4gV2F0Y2ggZm9yIHJpdmFscmllcyEnLCAnd2FybicpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGltZXJJbnQgPSBzZXRJbnRlcnZhbChnYW1lVGljaywgMTAwMCk7CiAgICAgICAgICAgIHRpY2tJbnQgPSBzZXRJbnRlcnZhbChhY3Rpdml0eVRpY2ssIDEyMDApOyAvLyBTbGlnaHRseSBmYXN0ZXIKICAgICAgICAgICAgdGVuc2lvbkludCA9IHNldEludGVydmFsKHRlbnNpb25UaWNrLCA1MDApOwogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlVUkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZ2V0RmF0aWd1ZUZhY3RvcigpIHsKICAgICAgICAgICAgY29uc3QgZWxhcHNlZCA9IDc1IC0gRy50aW1lOwogICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IGVsYXBzZWQgLyA3NTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChwcm9ncmVzcyA8IDAuMykgcmV0dXJuIDA7CiAgICAgICAgICAgIGlmIChwcm9ncmVzcyA8IDAuNSkgcmV0dXJuIDAuMzsKICAgICAgICAgICAgaWYgKHByb2dyZXNzIDwgMC43KSByZXR1cm4gMC42OwogICAgICAgICAgICByZXR1cm4gMS4wOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiB0ZW5zaW9uVGljaygpIHsKICAgICAgICAgICAgaWYgKCFHLnJ1bm5pbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFZpc3VhbCB0ZW5zaW9uIGZlZWRiYWNrCiAgICAgICAgICAgIGNvbnN0IHJvb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVldGluZy1yb29tJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRy5jb25mbGljdCB8fCBHLnRlbnNpb24gPiA4MCkgewogICAgICAgICAgICAgICAgcm9vbS5zdHlsZS5iYWNrZ3JvdW5kID0gYGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNGRUUyRTIsICNGRUNBQ0EpYDsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLnRlbnNpb24gPiA2MCkgewogICAgICAgICAgICAgICAgcm9vbS5zdHlsZS5iYWNrZ3JvdW5kID0gYGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNGRUYzQzcsICNGREU2OEEpYDsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLnRlbnNpb24gPiA0NSkgewogICAgICAgICAgICAgICAgcm9vbS5zdHlsZS5iYWNrZ3JvdW5kID0gYGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNFMEYyRkUsICNCQUU2RkQpYDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJvb20uc3R5bGUuYmFja2dyb3VuZCA9IGBsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCAjRThGNEZELCAjRDFFOEZBKWA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vID09PSBTSU1NRVJJTkcgSVNTVUVTIC0gc2xvdyBidWlsZGluZyB0ZW5zaW9ucyA9PT0KICAgICAgICAgICAgY29uc3QgaXNzdWVLZXlzID0gT2JqZWN0LmtleXMoRy5zaW1tZXJpbmdJc3N1ZXMpOwogICAgICAgICAgICBjb25zdCBhY3RpdmVJc3N1ZUtleSA9IGlzc3VlS2V5c1tHLnByb2plY3QgJSBpc3N1ZUtleXMubGVuZ3RoXTsgLy8gUm90YXRlIHRocm91Z2ggaXNzdWVzCiAgICAgICAgICAgIGNvbnN0IGlzc3VlID0gRy5zaW1tZXJpbmdJc3N1ZXNbYWN0aXZlSXNzdWVLZXldOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSXNzdWVzIGJ1aWxkIHVwIG92ZXIgdGltZSBkdXJpbmcgZGlzY3Vzc2lvbgogICAgICAgICAgICBpZiAoRy5pdGVtVGltZSA+IDMgJiYgIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKGlzc3VlLm93bmVyKSkgewogICAgICAgICAgICAgICAgLy8gSXNzdWUgZ3Jvd3MgZmFzdGVyIGlmIHRoZSByZWxldmFudCBwZXJzb24gaGFzbid0IHNwb2tlbgogICAgICAgICAgICAgICAgaXNzdWUubGV2ZWwgPSBNYXRoLm1pbigxMDAsIGlzc3VlLmxldmVsICsgMC40KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gV2FybiB3aGVuIGlzc3VlIHJlYWNoZXMgdGhyZXNob2xkCiAgICAgICAgICAgICAgICBpZiAoaXNzdWUubGV2ZWwgPj0gNDAgJiYgIWlzc3VlLndhcm5lZCkgewogICAgICAgICAgICAgICAgICAgIGlzc3VlLndhcm5lZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3duZXIgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBpc3N1ZS5vd25lcik7CiAgICAgICAgICAgICAgICAgICAgbG9nKGDimqDvuI8gJHtpc3N1ZS5uYW1lfSBidWlsZGluZyAtICR7b3duZXIubmFtZX0gc2hvdWxkIHdlaWdoIGluIWAsICd3YXJuJyk7CiAgICAgICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn4pqg77iPJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEhpZ2ggaXNzdWVzIGFkZCB0ZW5zaW9uCiAgICAgICAgICAgICAgICBpZiAoaXNzdWUubGV2ZWwgPj0gNjApIHsKICAgICAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDAuMyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBHVUFSQU5URUVEIGNvbmZsaWN0cyAoaWYgbm90IHByZXZlbnRlZCkKICAgICAgICAgICAgY29uc3QgZWxhcHNlZCA9IDc1IC0gRy50aW1lOwogICAgICAgICAgICBHLmd1YXJhbnRlZWRDb25mbGljdHMuZm9yRWFjaChnYyA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWdjLnRyaWdnZXJlZCAmJiAhZ2MucHJldmVudGVkICYmIGVsYXBzZWQgPj0gZ2MudGltZSAmJiAhRy5jb25mbGljdCkgewogICAgICAgICAgICAgICAgICAgIGdjLnRyaWdnZXJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbTEgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBnYy5wYWlyWzBdKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtMiA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMV0pOwogICAgICAgICAgICAgICAgICAgIGlmIChtMSAmJiBtMikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBCdWlsZCB1cCB0ZW5zaW9uIGJlZm9yZSBjb25mbGljdAogICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbbTEuaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbTEuaWRdLmZydXN0cmF0aW9uICsgMTApOwogICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbbTIuaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbTIuaWRdLmZydXN0cmF0aW9uICsgMTApOwogICAgICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyQ29uZmxpY3QobTEsIG0yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkaXRpb25hbCByYW5kb20gZXZlbnRzIChsZXNzIGZyZXF1ZW50IHNpbmNlIHdlIGhhdmUgZ3VhcmFudGVlZCBjb25mbGljdHMpCiAgICAgICAgICAgIGNvbnN0IGZhdGlndWUgPSBnZXRGYXRpZ3VlRmFjdG9yKCk7CiAgICAgICAgICAgIGlmICghRy5jb25mbGljdCAmJiBNYXRoLnJhbmRvbSgpIDwgMC4wMDggKyBmYXRpZ3VlICogMC4wMTUpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJSYW5kb21FdmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIHRyaWdnZXJSYW5kb21FdmVudCgpIHsKICAgICAgICAgICAgY29uc3QgZmF0aWd1ZSA9IGdldEZhdGlndWVGYWN0b3IoKTsKICAgICAgICAgICAgY29uc3Qgcm9sbCA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocm9sbCA8IDAuMyAmJiBHLmNvbmZsaWN0Q291bnQgPCA0KSB7CiAgICAgICAgICAgICAgICAvLyBFeHRyYSBjb25mbGljdCAoYmV5b25kIHRoZSBndWFyYW50ZWVkIDIpCiAgICAgICAgICAgICAgICBjb25zdCBwYWlycyA9IFtbJ3RlY2gnLCAnZmluYW5jZSddLCBbJ21rdCcsICdvcHMnXV07CiAgICAgICAgICAgICAgICBjb25zdCBwYWlyID0gcGFpcnNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcGFpcnMubGVuZ3RoKV07CiAgICAgICAgICAgICAgICBjb25zdCBtMSA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IHBhaXJbMF0pOwogICAgICAgICAgICAgICAgY29uc3QgbTIgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBwYWlyWzFdKTsKICAgICAgICAgICAgICAgIGlmIChtMSAmJiBtMikgewogICAgICAgICAgICAgICAgICAgIHRyaWdnZXJDb25mbGljdChtMSwgbTIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJvbGwgPCAwLjYpIHsKICAgICAgICAgICAgICAgIC8vIEZydXN0cmF0ZWQgb3V0YnVyc3QKICAgICAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBNRU1CRVJTLmZpbHRlcihtID0+ICFtLmlzQ0VPICYmIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA+IDI1KTsKICAgICAgICAgICAgICAgIGlmIChjYW5kaWRhdGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBtID0gY2FuZGlkYXRlc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjYW5kaWRhdGVzLmxlbmd0aCldOwogICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiArPSAxMDsKICAgICAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDYgKyBmYXRpZ3VlICogNCk7CiAgICAgICAgICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUobS5pZCwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICAgICAgc2hvd1NwZWVjaChtLmlkLCBQSFJBU0VTLmFuZ3J5W01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIFBIUkFTRVMuYW5ncnkubGVuZ3RoKV0sICdhbmdyeScpOwogICAgICAgICAgICAgICAgICAgIGZsYXNoKCdiYWQnKTsKICAgICAgICAgICAgICAgICAgICBzaG93U3RhdHVzKCfwn5ikJyk7CiAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5ikICR7bS5uYW1lfSBsb3NlcyBwYXRpZW5jZSFgLCAnYmFkJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBjbGVhck1lbWJlclN0YXRlKG0uaWQpLCAxMjAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEdlbmVyYWwgcm9vbSB0ZW5zaW9uIHNwaWtlCiAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDUgKyBmYXRpZ3VlICogNSk7CiAgICAgICAgICAgICAgICBNRU1CRVJTLmZpbHRlcihtID0+ICFtLmlzQ0VPKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uICsgMyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ/CfmKwnKTsKICAgICAgICAgICAgICAgIGxvZyhg8J+YrCBQYXRpZW5jZSB3ZWFyaW5nIHRoaW4uLi5gLCAnd2FybicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZVVJKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGdldERyYWdQZW5hbHR5KCkgewogICAgICAgICAgICBpZiAoRy5pdGVtVGltZSA8IDEwKSByZXR1cm4gMDsKICAgICAgICAgICAgaWYgKEcuaXRlbVRpbWUgPCAxNSkgcmV0dXJuIDAuMTU7CiAgICAgICAgICAgIGlmIChHLml0ZW1UaW1lIDwgMjApIHJldHVybiAwLjM7CiAgICAgICAgICAgIHJldHVybiAwLjU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGJ1aWxkUm9vbSgpIHsKICAgICAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZW1iZXJzLWNvbnRhaW5lcicpOwogICAgICAgICAgICBjb25zdCBiID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J1YmJsZXMtY29udGFpbmVyJyk7CiAgICAgICAgICAgIGMuaW5uZXJIVE1MID0gJyc7IGIuaW5uZXJIVE1MID0gJyc7CiAgICAgICAgICAgIAogICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgZWwuY2xhc3NOYW1lID0gJ21lbWJlcic7IGVsLmlkID0gYG0tJHttLmlkfWA7CiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGVsLnN0eWxlLCBtLnBvcyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHJvbGUgPSBtLmlzQ0VPID8gJ0NoYWlyJyA6IAogICAgICAgICAgICAgICAgICAgIG0uaWQgPT09ICd0ZWNoJyA/ICdUZWNoJyA6IAogICAgICAgICAgICAgICAgICAgIG0uaWQgPT09ICdmaW5hbmNlJyA/ICdGaW5hbmNlJyA6IAogICAgICAgICAgICAgICAgICAgIG0uaWQgPT09ICdta3QnID8gJ01hcmtldGluZycgOiAnT3BlcmF0aW9ucyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBmYWNlLWJhc2VkIGF2YXRhcgogICAgICAgICAgICAgICAgY29uc3QgYXZhdGFyQ2xhc3MgPSBgYXZhdGFyLSR7bS5uYW1lLnRvTG93ZXJDYXNlKCl9YDsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc0dsYXNzZXMgPSBtLmlkID09PSAnbWt0JzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gYAogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1lbWJlci1zdGF0dXMiIGlkPSJzdC0ke20uaWR9Ij48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJtZW1iZXItYXZhdGFyICR7YXZhdGFyQ2xhc3N9Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYXZhdGFyLWZhY2UiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZmFjZS1iZyI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJoYWlyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICR7aGFzR2xhc3NlcyA/ICc8ZGl2IGNsYXNzPSJnbGFzc2VzIj48L2Rpdj4nIDogJyd9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJleWVicm93cyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXllYnJvdyI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXllYnJvdyI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImV5ZXMiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImV5ZSI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZXllIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW91dGgiPjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWVtYmVyLWVtb3Rpb24iIGlkPSJlbW8tJHttLmlkfSI+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWVtYmVyLW5hbWUiPiR7bS5uYW1lfTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1lbWJlci1yb2xlIj4ke3JvbGV9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWVtYmVyLWJhciI+PGRpdiBjbGFzcz0ibWVtYmVyLWJhci1maWxsIiBpZD0iYmFyLSR7bS5pZH0iIHN0eWxlPSJ3aWR0aDoyMCUiPjwvZGl2PjwvZGl2PgogICAgICAgICAgICAgICAgYDsKICAgICAgICAgICAgICAgIGMuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBidWIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgIGJ1Yi5jbGFzc05hbWUgPSAnc3BlZWNoLWJ1YmJsZSc7IGJ1Yi5pZCA9IGBidWItJHttLmlkfWA7CiAgICAgICAgICAgICAgICBiLmFwcGVuZENoaWxkKGJ1Yik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWRkIGN1cnJlbnQgc3BlYWtlciBkaXNwbGF5CiAgICAgICAgICAgIGNvbnN0IHNwZWFrZXJEaXNwbGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHNwZWFrZXJEaXNwbGF5LmNsYXNzTmFtZSA9ICdjdXJyZW50LXNwZWFrZXInOwogICAgICAgICAgICBzcGVha2VyRGlzcGxheS5pZCA9ICdjdXJyZW50LXNwZWFrZXInOwogICAgICAgICAgICBzcGVha2VyRGlzcGxheS5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9InNwZWFrZXItaWNvbiI+PC9zcGFuPjxzcGFuIGNsYXNzPSJzcGVha2VyLXRleHQiPjwvc3Bhbj4nOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVldGluZy1yb29tJykuYXBwZW5kQ2hpbGQoc3BlYWtlckRpc3BsYXkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBsb2FkUHJvamVjdChpZHgpIHsKICAgICAgICAgICAgY29uc3QgcCA9IFBST0pFQ1RTW2lkeF07CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9qZWN0LW51bScpLnRleHRDb250ZW50ID0gYCR7aWR4ICsgMX0vNWA7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9qZWN0LW5hbWUnKS50ZXh0Q29udGVudCA9IHAubmFtZTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2plY3QtZGVzYycpLnRleHRDb250ZW50ID0gcC5kZXNjOwogICAgICAgICAgICAKICAgICAgICAgICAgRy5kaXNjdXNzaW9uID0geyB2b2ljZXM6IG5ldyBTZXQoKSwgb3JnYW5pY1ZvaWNlczogbmV3IFNldCgpLCBpbnZpdGVkVm9pY2VzOiBuZXcgU2V0KCksIHBvaW50czogMCwgaW52aXRlQ291bnQ6IDAgfTsKICAgICAgICAgICAgRy5pdGVtVGltZSA9IDA7CiAgICAgICAgICAgIEcubGFzdFNwZWFrZXIgPSBudWxsOwogICAgICAgICAgICBHLnJ1c2hXYXJuZWQgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IHNpbW1lcmluZyBpc3N1ZSB3YXJuaW5ncyBmb3IgbmV3IHByb2plY3QKICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhHLnNpbW1lcmluZ0lzc3VlcykuZm9yRWFjaChpc3N1ZSA9PiB7CiAgICAgICAgICAgICAgICBpc3N1ZS53YXJuZWQgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFYWNoIHByb2plY3QgaGFzIGEgZG9taW5hbnQgaXNzdWUgdGhhdCBzdGFydHMgZWxldmF0ZWQKICAgICAgICAgICAgY29uc3QgcHJvamVjdElzc3VlcyA9IFsndGVjaG5pY2FsJywgJ3RpbWVsaW5lJywgJ2J1ZGdldCcsICdtYXJrZXQnLCAnYnVkZ2V0J107CiAgICAgICAgICAgIGNvbnN0IGRvbWluYW50SXNzdWUgPSBwcm9qZWN0SXNzdWVzW2lkeF07CiAgICAgICAgICAgIGlmIChHLnNpbW1lcmluZ0lzc3Vlc1tkb21pbmFudElzc3VlXSkgewogICAgICAgICAgICAgICAgRy5zaW1tZXJpbmdJc3N1ZXNbZG9taW5hbnRJc3N1ZV0ubGV2ZWwgPSBNYXRoLm1pbigxMDAsIEcuc2ltbWVyaW5nSXNzdWVzW2RvbWluYW50SXNzdWVdLmxldmVsICsgMjApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBhc3NlcnRpdmUgPSBtLmFzc2VydGl2ZSB8fCAwLjU7CiAgICAgICAgICAgICAgICBHLm1lbWJlcnNbbS5pZF0ud2FudHNTcGVhayA9IE1hdGgucmFuZG9tKCkgPCBhc3NlcnRpdmUgKiAwLjQ7CiAgICAgICAgICAgICAgICBHLm1lbWJlcnNbbS5pZF0ubGFzdFNwb2tlID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBnYW1lVGljaygpIHsKICAgICAgICAgICAgaWYgKCFHLnJ1bm5pbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIEcudGltZS0tOwogICAgICAgICAgICBHLml0ZW1UaW1lKys7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkcmFnID0gZ2V0RHJhZ1BlbmFsdHkoKTsKICAgICAgICAgICAgY29uc3QgZmF0aWd1ZSA9IGdldEZhdGlndWVGYWN0b3IoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuZXJneSBkcmFpbnMgYmFzZWQgb24gYWN0aXZpdHkgYW5kIHRpbWUKICAgICAgICAgICAgY29uc3QgZW5lcmd5RHJhaW4gPSAwLjMgKyBmYXRpZ3VlICogMC40OwogICAgICAgICAgICBHLmVuZXJneSA9IE1hdGgubWF4KDAsIEcuZW5lcmd5IC0gZW5lcmd5RHJhaW4pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVuc2lvbiByaXNlcyAtIGZhc3RlciB3aGVuIHRpcmVkCiAgICAgICAgICAgIGNvbnN0IHRpcmVkbmVzc011bHRpcGxpZXIgPSBHLmVuZXJneSA8IDQwID8gMS41IDogRy5lbmVyZ3kgPCA2MCA/IDEuMiA6IDE7CiAgICAgICAgICAgIGNvbnN0IHRlbnNpb25SaXNlID0gKDAuMTUgKyBmYXRpZ3VlICogMC4yICsgZHJhZyAqIDAuMikgKiB0aXJlZG5lc3NNdWx0aXBsaWVyOwogICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIHRlbnNpb25SaXNlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvdyBlbmVyZ3kgZWZmZWN0cwogICAgICAgICAgICBpZiAoRy5lbmVyZ3kgPCA0MCkgewogICAgICAgICAgICAgICAgLy8gVGlyZWQgcGVvcGxlIGdldCBjcmFua3kgLSBmcnVzdHJhdGlvbiBidWlsZHMgZmFzdGVyCiAgICAgICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFtLmlzQ0VPKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uICsgMC4xNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIE9jY2FzaW9uYWwgdGlyZWQgY29tbWVudHMKICAgICAgICAgICAgICAgIGlmIChHLmVuZXJneSA8IDI1ICYmIE1hdGgucmFuZG9tKCkgPCAwLjAzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGlyZWRNZW1iZXIgPSBNRU1CRVJTLmZpbHRlcihtID0+ICFtLmlzQ0VPKVtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA0KV07CiAgICAgICAgICAgICAgICAgICAgc2hvd1NwZWVjaCh0aXJlZE1lbWJlci5pZCwgUEhSQVNFUy50aXJlZFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLnRpcmVkLmxlbmd0aCldLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5irICR7dGlyZWRNZW1iZXIubmFtZX0gbG9va3MgZXhoYXVzdGVkYCwgJ3dhcm4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmVyeSBsb3cgZW5lcmd5IGlzIGRhbmdlcm91cwogICAgICAgICAgICBpZiAoRy5lbmVyZ3kgPCAyMCkgewogICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5taW4oMTAwLCBHLnRlbnNpb24gKyAwLjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBQ1RJVkUgQ09ORkxJQ1RTIGVzY2FsYXRlIC0gZmFzdGVyIHdoZW4gdGlyZWQKICAgICAgICAgICAgaWYgKEcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNvbmZsaWN0UmF0ZSA9IEcuZW5lcmd5IDwgNDAgPyAxLjIgOiAwLjg7CiAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIGNvbmZsaWN0UmF0ZSArIGZhdGlndWUgKiAwLjMpOwogICAgICAgICAgICAgICAgY29uc3QgW2lkMSwgaWQyXSA9IEcuY29uZmxpY3Q7CiAgICAgICAgICAgICAgICBHLm1lbWJlcnNbaWQxXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW2lkMV0uZnJ1c3RyYXRpb24gKyAwLjUpOwogICAgICAgICAgICAgICAgRy5tZW1iZXJzW2lkMl0uZnJ1c3RyYXRpb24gPSBNYXRoLm1pbigxMDAsIEcubWVtYmVyc1tpZDJdLmZydXN0cmF0aW9uICsgMC41KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gT2NjYXNpb25hbCBhbmdyeSBvdXRidXJzdHMgZHVyaW5nIGNvbmZsaWN0CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuMTIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGVha2VyID0gTWF0aC5yYW5kb20oKSA8IDAuNSA/IGlkMSA6IGlkMjsKICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKHNwZWFrZXIsIFBIUkFTRVMuY29uZmxpY3RbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogUEhSQVNFUy5jb25mbGljdC5sZW5ndGgpXSwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBwcmUtY29uZmxpY3Qgd2FybmluZyBzaWducyAocml2YWxzIGdldHRpbmcgaGVhdGVkKQogICAgICAgICAgICBHLmd1YXJhbnRlZWRDb25mbGljdHMuZm9yRWFjaChnYyA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWdjLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsYXBzZWQgPSA3NSAtIEcudGltZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lVW50aWwgPSBnYy50aW1lIC0gZWxhcHNlZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAxMCBzZWNvbmRzIGJlZm9yZTogZmlyc3Qgd2FybmluZyBzaWduCiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVVbnRpbCA8PSAxMCAmJiB0aW1lVW50aWwgPiA3ICYmICFnYy5lYXJseVdhcm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2MuZWFybHlXYXJuID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbTEgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBnYy5wYWlyWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbTIgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBnYy5wYWlyWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW2djLnBhaXJbMF1dLmZydXN0cmF0aW9uICs9IDU7CiAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1tnYy5wYWlyWzFdXS5mcnVzdHJhdGlvbiArPSA1OwogICAgICAgICAgICAgICAgICAgICAgICBsb2coYPCfkYAgJHttMS5uYW1lfSBhbmQgJHttMi5uYW1lfSBzZWVtIHRlbnNlLi4uYCwgJ3dhcm4nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gNyBzZWNvbmRzIGJlZm9yZTogdGVuc2lvbiByaXNpbmcsIHNob3cgdmlzdWFsCiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVVbnRpbCA8PSA3ICYmIHRpbWVVbnRpbCA+IDQgJiYgIWdjLndhcm5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBnYy53YXJuZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtMSA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtMiA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbZ2MucGFpclswXV0uZnJ1c3RyYXRpb24gKz0gNjsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW2djLnBhaXJbMV1dLmZydXN0cmF0aW9uICs9IDY7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldE1lbWJlclN0YXRlKGdjLnBhaXJbMF0sICd0ZW5zZScpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShnYy5wYWlyWzFdLCAndGVuc2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1NwZWVjaChnYy5wYWlyWzBdLCBQSFJBU0VTLmNvbmNlcm5bTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogUEhSQVNFUy5jb25jZXJuLmxlbmd0aCldLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+YrCAke20xLm5hbWV9IGFuZCAke20yLm5hbWV9IGV4Y2hhbmdpbmcgbG9va3MuLi5gLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAzIHNlY29uZHMgYmVmb3JlOiBmaW5hbCB3YXJuaW5nLCByZWNvbW1lbmQgYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVVbnRpbCA8PSAzICYmIHRpbWVVbnRpbCA+IDAgJiYgIWdjLmZpbmFsV2FybikgewogICAgICAgICAgICAgICAgICAgICAgICBnYy5maW5hbFdhcm4gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtMSA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtMiA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbZ2MucGFpclswXV0uZnJ1c3RyYXRpb24gKz0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW2djLnBhaXJbMV1dLmZydXN0cmF0aW9uICs9IDU7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dTcGVlY2goZ2MucGFpclsxXSwgIkkgZGlzYWdyZWUgd2l0aCB0aGF0IGFwcHJvYWNoLiIsICdhbmdyeScpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShnYy5wYWlyWzBdLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUoZ2MucGFpclsxXSwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoKCdiYWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGDimqDvuI8gJHttMS5uYW1lfSB2cyAke20yLm5hbWV9IGFib3V0IHRvIGNsYXNoISBVc2Ug8J+Viu+4jyBEZWZ1c2UgTk9XIWAsICdiYWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpZ2hsaWdodCBkZWZ1c2UgYnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tZGVmdXNlJykuY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgTUVNQkVSUy5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgaWYgKG0uaXNDRU8pIHJldHVybjsKICAgICAgICAgICAgICAgIGNvbnN0IG1zID0gRy5tZW1iZXJzW20uaWRdOwogICAgICAgICAgICAgICAgbXMubGFzdFNwb2tlKys7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEZydXN0cmF0aW9uIGJ1aWxkcyB3aGVuIG5vdCBoZWFyZAogICAgICAgICAgICAgICAgaWYgKCFHLmRpc2N1c3Npb24udm9pY2VzLmhhcyhtLmlkKSkgewogICAgICAgICAgICAgICAgICAgIG1zLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBtcy5mcnVzdHJhdGlvbiArIDAuMjUgKyBmYXRpZ3VlICogMC4xNSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQXNzZXJ0aXZlIHBlb3BsZSB3YW50IHRvIHNwZWFrIHNvb25lciwgcXVpZXQgcGVvcGxlIGxhdGVyCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNzZXJ0aXZlID0gbS5hc3NlcnRpdmUgfHwgMC41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWFrVGhyZXNob2xkID0gTWF0aC5mbG9vcig0ICsgKDEgLSBhc3NlcnRpdmUpICogNSk7IC8vIDQtOSBiYXNlZCBvbiBhc3NlcnRpdmVuZXNzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKG1zLmxhc3RTcG9rZSA+IHNwZWFrVGhyZXNob2xkICYmIE1hdGgucmFuZG9tKCkgPCBhc3NlcnRpdmUgKiAwLjQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXMud2FudHNTcGVhayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBIaWdoIGZydXN0cmF0aW9uIGJsZWVkcyBpbnRvIHRlbnNpb24gKHJlZHVjZWQpCiAgICAgICAgICAgICAgICBpZiAobXMuZnJ1c3RyYXRpb24gPiA2MCkgRy50ZW5zaW9uID0gTWF0aC5taW4oMTAwLCBHLnRlbnNpb24gKyAwLjAzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVVSSgpOwogICAgICAgICAgICBjaGVja0VuZCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBhY3Rpdml0eVRpY2soKSB7CiAgICAgICAgICAgIGlmICghRy5ydW5uaW5nKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBmYXRpZ3VlID0gZ2V0RmF0aWd1ZUZhY3RvcigpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRHVyaW5nIGNvbmZsaWN0LCBwYXJ0aWNpcGFudHMga2VlcCBhcmd1aW5nCiAgICAgICAgICAgIGlmIChHLmNvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IDAuMikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWFrZXIgPSBHLmNvbmZsaWN0W01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDIpXTsKICAgICAgICAgICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShzcGVha2VyLCAnYW5ncnknKTsKICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKHNwZWFrZXIsIFBIUkFTRVMuY29uZmxpY3RbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogUEhSQVNFUy5jb25mbGljdC5sZW5ndGgpXSwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47IC8vIE5vIG5vcm1hbCBzcGVha2luZyBkdXJpbmcgY29uZmxpY3QKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRnJ1c3RyYXRlZCBpbnRlcnJ1cHRpb25zIG1vcmUgbGlrZWx5IHdoZW4gdGlyZWQKICAgICAgICAgICAgY29uc3QgdmVyeUZydXN0cmF0ZWQgPSBNRU1CRVJTLmZpbHRlcihtID0+ICFtLmlzQ0VPICYmIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA+IDUwKTsKICAgICAgICAgICAgaWYgKHZlcnlGcnVzdHJhdGVkLmxlbmd0aCA+IDAgJiYgTWF0aC5yYW5kb20oKSA8IDAuMDYgKyBmYXRpZ3VlICogMC4wNikgewogICAgICAgICAgICAgICAgY29uc3QgbSA9IHZlcnlGcnVzdHJhdGVkW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHZlcnlGcnVzdHJhdGVkLmxlbmd0aCldOwogICAgICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUobS5pZCwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICBzaG93U3BlZWNoKG0uaWQsIFBIUkFTRVMuYW5ncnlbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogUEhSQVNFUy5hbmdyeS5sZW5ndGgpXSwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDQgKyBmYXRpZ3VlICogMyk7CiAgICAgICAgICAgICAgICBmbGFzaCgnYmFkJyk7CiAgICAgICAgICAgICAgICBsb2coYPCfmKQgJHttLm5hbWV9IHZlbnRzIGZydXN0cmF0aW9uIWAsICd3YXJuJyk7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGNsZWFyTWVtYmVyU3RhdGUobS5pZCksIDEwMDApOwogICAgICAgICAgICAgICAgdXBkYXRlVUkoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUGxheWVycyBuZWVkIHRvIHVzZSBJbnZpdGUgdG8gZ2V0IHF1aWV0ZXIgbWVtYmVycyB0YWxraW5nCiAgICAgICAgICAgIC8vIEFzc2VydGl2ZSBtZW1iZXJzIHNwZWFrIHVwIG1vcmUsIHF1aWV0IG9uZXMgbmVlZCBpbnZpdGluZwogICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gTUVNQkVSUy5maWx0ZXIobSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobS5pc0NFTykgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgY29uc3QgbXMgPSBHLm1lbWJlcnNbbS5pZF07CiAgICAgICAgICAgICAgICBjb25zdCBhc3NlcnRpdmUgPSBtLmFzc2VydGl2ZSB8fCAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZXkgd2FudCB0byBzcGVhayBiYXNlZCBvbiBwZXJzb25hbGl0eQogICAgICAgICAgICAgICAgaWYgKG1zLndhbnRzU3BlYWsgJiYgTWF0aC5yYW5kb20oKSA8IGFzc2VydGl2ZSArIDAuMikgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICBpZiAobXMubGFzdFNwb2tlID4gNykgcmV0dXJuIHRydWU7IC8vIFBlb3BsZSBldmVudHVhbGx5IHNwZWFrCiAgICAgICAgICAgICAgICBpZiAobXMuZnJ1c3RyYXRpb24gPiA1MCAmJiBNYXRoLnJhbmRvbSgpIDwgMC42KSByZXR1cm4gdHJ1ZTsgLy8gRnJ1c3RyYXRpb24gbWFrZXMgcGVvcGxlIHNwZWFrCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gNTAlIGNoYW5jZSBzb21lb25lIHNwZWFrcyBpZiB0aGV5IHdhbnQgdG8KICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZXMubGVuZ3RoID4gMCAmJiBNYXRoLnJhbmRvbSgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICAvLyBQcmlvcml0aXplIGZydXN0cmF0ZWQgcGVvcGxlICh0aGV5IGludGVycnVwdCkKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZXMuc29ydCgoYSwgYikgPT4gRy5tZW1iZXJzW2IuaWRdLmZydXN0cmF0aW9uIC0gRy5tZW1iZXJzW2EuaWRdLmZydXN0cmF0aW9uKTsKICAgICAgICAgICAgICAgIG1lbWJlclNwZWFrcyhjYW5kaWRhdGVzWzBdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBtZW1iZXJTcGVha3MobWVtYmVyLCB3YXNJbnZpdGVkID0gZmFsc2UpIHsKICAgICAgICAgICAgY29uc3QgbXMgPSBHLm1lbWJlcnNbbWVtYmVyLmlkXTsKICAgICAgICAgICAgY29uc3QgZmF0aWd1ZSA9IGdldEZhdGlndWVGYWN0b3IoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxldCBwaHJhc2VzLCBjbHMgPSAnJywgdGVuc2lvbkRlbHRhID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1vcmUgbGlrZWx5IHRvIGJlIGFuZ3J5IHdoZW4gZnJ1c3RyYXRlZCBPUiB3aGVuIHJvb20gaXMgdGlyZWQKICAgICAgICAgICAgY29uc3QgYW5nZXJDaGFuY2UgPSAobXMuZnJ1c3RyYXRpb24gPiA0NSA/IDAuNSA6IDApICsgZmF0aWd1ZSAqIDAuMyArIChHLnRlbnNpb24gPiA1NSA/IDAuMiA6IDApOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBhbmdlckNoYW5jZSkgewogICAgICAgICAgICAgICAgcGhyYXNlcyA9IFBIUkFTRVMuYW5ncnk7CiAgICAgICAgICAgICAgICBjbHMgPSAnYW5ncnknOwogICAgICAgICAgICAgICAgdGVuc2lvbkRlbHRhID0gMyArIE1hdGguZmxvb3IoZmF0aWd1ZSAqIDMpOwogICAgICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUobWVtYmVyLmlkLCAnYW5ncnknKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLmVuZXJneSA8IDM1ICYmIE1hdGgucmFuZG9tKCkgPCAwLjQpIHsKICAgICAgICAgICAgICAgIHBocmFzZXMgPSBQSFJBU0VTLnRpcmVkOwogICAgICAgICAgICAgICAgdGVuc2lvbkRlbHRhID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChNYXRoLnJhbmRvbSgpIDwgMC4zNSkgewogICAgICAgICAgICAgICAgcGhyYXNlcyA9IFBIUkFTRVMuY29uY2VybjsKICAgICAgICAgICAgICAgIHRlbnNpb25EZWx0YSA9IDI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwaHJhc2VzID0gUEhSQVNFUy5nb29kOwogICAgICAgICAgICAgICAgY2xzID0gJ2dvb2QnOwogICAgICAgICAgICAgICAgdGVuc2lvbkRlbHRhID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNob3dTcGVlY2gobWVtYmVyLmlkLCBwaHJhc2VzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHBocmFzZXMubGVuZ3RoKV0sIGNscyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIE1hdGgubWF4KDAsIEcudGVuc2lvbiArIHRlbnNpb25EZWx0YSkpOwogICAgICAgICAgICBHLmRpc2N1c3Npb24udm9pY2VzLmFkZChtZW1iZXIuaWQpOwogICAgICAgICAgICBHLmRpc2N1c3Npb24ucG9pbnRzKys7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUcmFjayBvcmdhbmljIHZzIGludml0ZWQgdm9pY2VzCiAgICAgICAgICAgIGlmICh3YXNJbnZpdGVkKSB7CiAgICAgICAgICAgICAgICBHLmRpc2N1c3Npb24uaW52aXRlZFZvaWNlcy5hZGQobWVtYmVyLmlkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIEcuZGlzY3Vzc2lvbi5vcmdhbmljVm9pY2VzLmFkZChtZW1iZXIuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBtcy53YW50c1NwZWFrID0gZmFsc2U7CiAgICAgICAgICAgIG1zLmxhc3RTcG9rZSA9IDA7CiAgICAgICAgICAgIG1zLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgbXMuZnJ1c3RyYXRpb24gLSA1KTsKICAgICAgICAgICAgRy5sYXN0U3BlYWtlciA9IG1lbWJlci5pZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgcGVyc29uJ3Mgdm9pY2UgYWRkcmVzc2VzIGEgc2ltbWVyaW5nIGlzc3VlCiAgICAgICAgICAgIE9iamVjdC5rZXlzKEcuc2ltbWVyaW5nSXNzdWVzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc3N1ZSA9IEcuc2ltbWVyaW5nSXNzdWVzW2tleV07CiAgICAgICAgICAgICAgICBpZiAoaXNzdWUub3duZXIgPT09IG1lbWJlci5pZCAmJiBpc3N1ZS5sZXZlbCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZWR1Y3Rpb24gPSB3YXNJbnZpdGVkID8gMjUgOiAzNTsgLy8gT3JnYW5pYyBpbnB1dCBtb3JlIGVmZmVjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlzc3VlLmxldmVsID0gTWF0aC5tYXgoMCwgaXNzdWUubGV2ZWwgLSByZWR1Y3Rpb24pOwogICAgICAgICAgICAgICAgICAgIGlmIChpc3N1ZS53YXJuZWQgJiYgaXNzdWUubGV2ZWwgPCAzMCkgewogICAgICAgICAgICAgICAgICAgICAgICBsb2coYOKckyAke2lzc3VlLm5hbWV9IGFkZHJlc3NlZGAsICdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChjbHMgIT09ICdhbmdyeScpIHNldE1lbWJlclN0YXRlKG1lbWJlci5pZCwgJ3NwZWFraW5nJyk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gY2xlYXJNZW1iZXJTdGF0ZShtZW1iZXIuaWQpLCA5MDApOwogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlVUkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gdHJpZ2dlckNvbmZsaWN0KG0xLCBtMikgewogICAgICAgICAgICBHLmNvbmZsaWN0ID0gW20xLmlkLCBtMi5pZF07CiAgICAgICAgICAgIEcuY29uZmxpY3RDb3VudCsrOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW9kZXJhdGUgdGVuc2lvbiBzcGlrZQogICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDEyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERyYW1hdGljIGV4Y2hhbmdlCiAgICAgICAgICAgIHNob3dTcGVlY2gobTEuaWQsIFBIUkFTRVMuY29uZmxpY3RbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogUEhSQVNFUy5jb25mbGljdC5sZW5ndGgpXSwgJ2FuZ3J5Jyk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgc2hvd1NwZWVjaChtMi5pZCwgUEhSQVNFUy5jb25mbGljdFtNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBQSFJBU0VTLmNvbmZsaWN0Lmxlbmd0aCldLCAnYW5ncnknKTsKICAgICAgICAgICAgfSwgMzAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHNldE1lbWJlclN0YXRlKG0xLmlkLCAnYW5ncnknKTsKICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUobTIuaWQsICdhbmdyeScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTW9kZXJhdGUgZnJ1c3RyYXRpb24gaW5jcmVhc2UKICAgICAgICAgICAgRy5tZW1iZXJzW20xLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW20xLmlkXS5mcnVzdHJhdGlvbiArIDE1KTsKICAgICAgICAgICAgRy5tZW1iZXJzW20yLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW20yLmlkXS5mcnVzdHJhdGlvbiArIDE1KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE90aGVycyBnZXQgYSBiaXQgdW5jb21mb3J0YWJsZQogICAgICAgICAgICBNRU1CRVJTLmZpbHRlcihtID0+ICFtLmlzQ0VPICYmIG0uaWQgIT09IG0xLmlkICYmIG0uaWQgIT09IG0yLmlkKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gKyAzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBmbGFzaCgnYmFkJyk7CiAgICAgICAgICAgIHNob3dTdGF0dXMoJ+KaoScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlzdWFsIGZlZWRiYWNrIC0gcm9vbSBnb2VzIHJlZAogICAgICAgICAgICBjb25zdCByb29tID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lZXRpbmctcm9vbScpOwogICAgICAgICAgICByb29tLmNsYXNzTGlzdC5hZGQoJ2NyaXRpY2FsJyk7CiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5nYW1lLWhlYWRlcicpLmNsYXNzTGlzdC5hZGQoJ2RhbmdlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgbG9nKGDimqEgQ09ORkxJQ1Q6ICR7bTEubmFtZX0gdnMgJHttMi5uYW1lfSFgLCAnYmFkJyk7CiAgICAgICAgICAgIHVwZGF0ZVVJKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIHNldE1lbWJlclN0YXRlKGlkLCBzdGF0ZSkgewogICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBtLSR7aWR9YCk7CiAgICAgICAgICAgIGNvbnN0IGVtbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBlbW8tJHtpZH1gKTsKICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZSgnc3BlYWtpbmcnLCAnYW5ncnknLCAnaGFwcHknLCAnY2VvLW1vZGUnLCAndGVuc2UnLCAndGlyZWQnKTsKICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChzdGF0ZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgZW1vdGlvbiBiYWRnZQogICAgICAgICAgICBpZiAoZW1vKSB7CiAgICAgICAgICAgICAgICBlbW8uY2xhc3NMaXN0LmFkZCgnc2hvdycpOwogICAgICAgICAgICAgICAgaWYgKHN0YXRlID09PSAnYW5ncnknKSB7CiAgICAgICAgICAgICAgICAgICAgZW1vLnRleHRDb250ZW50ID0gJ/CfmKAnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3RlbnNlJykgewogICAgICAgICAgICAgICAgICAgIGVtby50ZXh0Q29udGVudCA9ICfwn5isJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdoYXBweScpIHsKICAgICAgICAgICAgICAgICAgICBlbW8udGV4dENvbnRlbnQgPSAn8J+Yiic7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnc3BlYWtpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgZW1vLnRleHRDb250ZW50ID0gJ/CfkqwnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ2Nlby1tb2RlJykgewogICAgICAgICAgICAgICAgICAgIGVtby50ZXh0Q29udGVudCA9ICfwn5GUJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICd0aXJlZCcpIHsKICAgICAgICAgICAgICAgICAgICBlbW8udGV4dENvbnRlbnQgPSAn8J+YtCc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gY2xlYXJNZW1iZXJTdGF0ZShpZCkgewogICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBtLSR7aWR9YCk7CiAgICAgICAgICAgIGNvbnN0IGVtbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBlbW8tJHtpZH1gKTsKICAgICAgICAgICAgaWYgKGVsKSBlbC5jbGFzc0xpc3QucmVtb3ZlKCdzcGVha2luZycsICdhbmdyeScsICdoYXBweScsICdjZW8tbW9kZScsICd0ZW5zZScsICd0aXJlZCcpOwogICAgICAgICAgICBpZiAoZW1vKSB7CiAgICAgICAgICAgICAgICBlbW8uY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOwogICAgICAgICAgICAgICAgZW1vLnRleHRDb250ZW50ID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc2hvd1NwZWVjaChpZCwgdGV4dCwgY2xzID0gJycpIHsKICAgICAgICAgICAgY29uc3QgYnViID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGJ1Yi0ke2lkfWApOwogICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBtLSR7aWR9YCk7CiAgICAgICAgICAgIGlmICghYnViIHx8ICFlbCkgcmV0dXJuOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgcm9vbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWV0aW5nLXJvb20nKS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgY29uc3QgbWVtID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgbGVmdCA9IG1lbS5sZWZ0IC0gcm9vbS5sZWZ0ICsgMjA7CiAgICAgICAgICAgIGxldCB0b3AgPSBtZW0udG9wIC0gcm9vbS50b3AgLSA1MDsKICAgICAgICAgICAgbGVmdCA9IE1hdGgubWF4KDEwLCBNYXRoLm1pbihsZWZ0LCByb29tLndpZHRoIC0gMTcwKSk7CiAgICAgICAgICAgIHRvcCA9IE1hdGgubWF4KDEwLCB0b3ApOwogICAgICAgICAgICAKICAgICAgICAgICAgYnViLnN0eWxlLmxlZnQgPSBsZWZ0ICsgJ3B4JzsKICAgICAgICAgICAgYnViLnN0eWxlLnRvcCA9IHRvcCArICdweCc7CiAgICAgICAgICAgIGJ1Yi50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgICAgIGJ1Yi5jbGFzc05hbWUgPSAnc3BlZWNoLWJ1YmJsZSB2aXNpYmxlICcgKyBjbHM7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgY3VycmVudCBzcGVha2VyIGRpc3BsYXkKICAgICAgICAgICAgY29uc3Qgc3BlYWtlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdXJyZW50LXNwZWFrZXInKTsKICAgICAgICAgICAgaWYgKHNwZWFrZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG1lbWJlciA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGlkKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJvbGVJY29uID0gbWVtYmVyLmlzQ0VPID8gJ/CfkZQnIDogCiAgICAgICAgICAgICAgICAgICAgbWVtYmVyLmlkID09PSAndGVjaCcgPyAn8J+UrCcgOiAKICAgICAgICAgICAgICAgICAgICBtZW1iZXIuaWQgPT09ICdmaW5hbmNlJyA/ICfwn5KwJyA6IAogICAgICAgICAgICAgICAgICAgIG1lbWJlci5pZCA9PT0gJ21rdCcgPyAn8J+ToicgOiAn4pqZ77iPJzsKICAgICAgICAgICAgICAgIHNwZWFrZXIucXVlcnlTZWxlY3RvcignLnNwZWFrZXItaWNvbicpLnRleHRDb250ZW50ID0gcm9sZUljb247CiAgICAgICAgICAgICAgICBzcGVha2VyLnF1ZXJ5U2VsZWN0b3IoJy5zcGVha2VyLXRleHQnKS50ZXh0Q29udGVudCA9IGAke21lbWJlci5uYW1lfTogIiR7dGV4dH0iYDsKICAgICAgICAgICAgICAgIHNwZWFrZXIuY2xhc3NOYW1lID0gJ2N1cnJlbnQtc3BlYWtlciBzaG93ICcgKyBjbHM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChzcGVha2VyLmhpZGVUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHNwZWFrZXIuaGlkZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHNwZWFrZXIuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpLCAyNTAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBidWIuY2xhc3NMaXN0LnJlbW92ZSgndmlzaWJsZScpLCAyMDAwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc2hvd1N0YXR1cyhlbW9qaSkgewogICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyb29tLXN0YXR1cycpOwogICAgICAgICAgICBlbC50ZXh0Q29udGVudCA9IGVtb2ppOwogICAgICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZWwuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpLCA0MDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBzaG93RmxvYXQoZW1vamkpIHsKICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZWwuY2xhc3NOYW1lID0gJ2Zsb2F0LWVmZmVjdCc7CiAgICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gZW1vamk7CiAgICAgICAgICAgIGVsLnN0eWxlLmxlZnQgPSAnMjAwcHgnOwogICAgICAgICAgICBlbC5zdHlsZS50b3AgPSAnMjAwcHgnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVldGluZy1yb29tJykuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGVsLnJlbW92ZSgpLCA1MDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBmbGFzaCh0eXBlKSB7CiAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGZsYXNoLSR7dHlwZX1gKTsKICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZWwuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyksIDE2MCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGRvQWN0aW9uKGFjdGlvbikgewogICAgICAgICAgICBpZiAoIUcucnVubmluZyB8fCBHLmNvb2xkb3duc1thY3Rpb25dKSByZXR1cm47CiAgICAgICAgICAgIGlmIChbJ2pva2UnLCAnYnJlYWsnLCAnY2VvJ10uaW5jbHVkZXMoYWN0aW9uKSAmJiBHLnVzZXNbYWN0aW9uXSA8PSAwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgY2QgPSA0LCBzdWNjZXNzID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBlZmZlY3RpdmVuZXNzIGJhc2VkIG9uIGVuZXJneSAoNzAtMTAwJSBlZmZlY3RpdmVuZXNzKQogICAgICAgICAgICBjb25zdCBlZmZlY3RpdmVuZXNzID0gMC43ICsgKEcuZW5lcmd5IC8gMTAwKSAqIDAuMzsKICAgICAgICAgICAgY29uc3QgaXNMb3dFbmVyZ3kgPSBHLmVuZXJneSA8IDQwOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQWN0aW9ucyBjb3N0IGVuZXJneSAoZXhjZXB0IGJyZWFrIHdoaWNoIHJlc3RvcmVzIGl0KQogICAgICAgICAgICBjb25zdCBlbmVyZ3lDb3N0cyA9IHsgYWNrOiAyLCBpbnZpdGU6IDMsIGRlZnVzZTogNCwgam9rZTogMywgY2VvOiA1IH07CiAgICAgICAgICAgIAogICAgICAgICAgICBzd2l0Y2goYWN0aW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICdhY2snOgogICAgICAgICAgICAgICAgICAgIGlmICghRy5sYXN0U3BlYWtlciB8fCBHLm1lbWJlcnNbRy5sYXN0U3BlYWtlcl0ubGFzdFNwb2tlID4gMykgewogICAgICAgICAgICAgICAgICAgICAgICBsb2coYE5vIHJlY2VudCBzcGVha2VyYCwgJ3dhcm4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlYWtlciA9IEcubGFzdFNwZWFrZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWNrUG93ZXIgPSBNYXRoLnJvdW5kKDEyICogZWZmZWN0aXZlbmVzcyk7CiAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW3NwZWFrZXJdLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgRy5tZW1iZXJzW3NwZWFrZXJdLmZydXN0cmF0aW9uIC0gYWNrUG93ZXIpOwogICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWF4KDAsIEcudGVuc2lvbiAtIE1hdGgucm91bmQoNCAqIGVmZmVjdGl2ZW5lc3MpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKHNwZWFrZXIsICJUaGFua3MuIiwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICBzZXRNZW1iZXJTdGF0ZShzcGVha2VyLCAnaGFwcHknKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGNsZWFyTWVtYmVyU3RhdGUoc3BlYWtlciksIDgwMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2hvd0Zsb2F0KCfwn5GPJyk7CiAgICAgICAgICAgICAgICAgICAgZmxhc2goJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICBsb2coYPCfkY8gQWNrbm93bGVkZ2VkICR7TUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gc3BlYWtlcikubmFtZX0ke2lzTG93RW5lcmd5ID8gJyAodGlyZWQpJyA6ICcnfWAsICdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgY2QgPSAzOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY2FzZSAnaW52aXRlJzoKICAgICAgICAgICAgICAgICAgICAvLyBEaW1pbmlzaGluZyByZXR1cm5zIC0gY2hlY2sgaG93IG1hbnkgaW52aXRlcyB1c2VkIHRoaXMgZGlzY3Vzc2lvbgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGludml0ZUNvdW50ID0gRy5kaXNjdXNzaW9uLmludml0ZUNvdW50OwogICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAvLyBDb29sZG93biBzY2FsZXMgdXAgd2l0aCByZXBlYXRlZCBpbnZpdGVzIHRvIHByZXZlbnQgc3BhbW1pbmcKICAgICAgICAgICAgICAgICAgICBjZCA9IE1hdGgubWluKDE0LCA2ICsgMyAqIGludml0ZUNvdW50KTsKICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIHBlb3BsZSB3aG8gaGF2ZW4ndCBzcG9rZW4geWV0LCBwcmlvcml0aXppbmcgcXVpZXQgcGVyc29uYWxpdGllcwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdFNwb2tlbiA9IE1FTUJFUlMuZmlsdGVyKG0gPT4gIW0uaXNDRU8gJiYgIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3YWl0aW5nID0gTUVNQkVSUy5maWx0ZXIobSA9PiAhbS5pc0NFTyAmJiBHLm1lbWJlcnNbbS5pZF0ud2FudHNTcGVhayk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQ29tYmluZSBhbmQgcHJpb3JpdGl6ZTogcXVpZXQgcGVvcGxlIHdobyBoYXZlbid0IHNwb2tlbiA+IGFueW9uZSB3aG8gaGFzbid0IHNwb2tlbiA+IGFueW9uZSB3YWl0aW5nCiAgICAgICAgICAgICAgICAgICAgbGV0IHRhcmdldHMgPSBub3RTcG9rZW4ubGVuZ3RoID4gMCA/IG5vdFNwb2tlbiA6IHdhaXRpbmc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhgRXZlcnlvbmUgaGFzIHNwb2tlbiBhbHJlYWR5YCwgJ3dhcm4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gV2FybiBhYm91dCBkaW1pbmlzaGluZyByZXR1cm5zIGFmdGVyIDIgaW52aXRlcwogICAgICAgICAgICAgICAgICAgIGlmIChpbnZpdGVDb3VudCA+PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWluKDEwMCwgRy50ZW5zaW9uICsgNCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+YkiBSb29tIGZlZWxzIGZvcmNlZCAtIGludml0ZXMgbGVzcyBlZmZlY3RpdmVgLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgICAgICBmbGFzaCgnYmFkJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnZpdGVDb3VudCA+PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+SrSBBbm90aGVyIGludml0ZS4uLiBvcmdhbmljIHZvaWNlcyBiZXR0ZXJgLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBTb3J0IGJ5OiBsZWFzdCBhc3NlcnRpdmUgZmlyc3QgKHRoZXkgbmVlZCB0aGUgaW52aXRlIG1vc3QpCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0cy5zb3J0KChhLCBiKSA9PiAoYS5hc3NlcnRpdmUgfHwgMC41KSAtIChiLmFzc2VydGl2ZSB8fCAwLjUpKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSB0YXJnZXRzWzBdOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIFJlZHVjZWQgZWZmZWN0aXZlbmVzcyBmb3IgcmVwZWF0ZWQgaW52aXRlcyAoc3Ryb25nIGRpbWluaXNoaW5nIHJldHVybnMpCiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW52aXRlTXVsdGlwbGllciA9IGludml0ZUNvdW50ID09PSAwID8gMSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludml0ZUNvdW50ID09PSAxID8gMC42IDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52aXRlQ291bnQgPT09IDIgPyAwLjMgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLjE1OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGludml0ZUVmZmVjdGl2ZW5lc3MgPSBlZmZlY3RpdmVuZXNzICogaW52aXRlTXVsdGlwbGllcjsKY29uc3QgaW52aXRlUG93ZXIgPSBNYXRoLnJvdW5kKDEyICogaW52aXRlRWZmZWN0aXZlbmVzcyk7CiAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW3RhcmdldC5pZF0uZnJ1c3RyYXRpb24gPSBNYXRoLm1heCgwLCBHLm1lbWJlcnNbdGFyZ2V0LmlkXS5mcnVzdHJhdGlvbiAtIGludml0ZVBvd2VyKTsKICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbdGFyZ2V0LmlkXS53YW50c1NwZWFrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUcmFjayB0aGlzIGFzIGFuIGludml0ZWQgdm9pY2UKICAgICAgICAgICAgICAgICAgICBHLmRpc2N1c3Npb24uaW52aXRlQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICBHLmRpc2N1c3Npb24uaW52aXRlZFZvaWNlcy5hZGQodGFyZ2V0LmlkKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaGV5IHNwZWFrIGltbWVkaWF0ZWx5IHdoZW4gaW52aXRlZAogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gbWVtYmVyU3BlYWtzKHRhcmdldCwgdHJ1ZSksIDIwMCk7IC8vIHRydWUgPSBpbnZpdGVkCiAgICAgICAgICAgICAgICAgICAgc2hvd0Zsb2F0KCfwn5ej77iPJyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcXVpZXROb3RlID0gKHRhcmdldC5hc3NlcnRpdmUgfHwgMC41KSA8IDAuNSA/ICcgKHRoZXkgbmVlZGVkIHRoYXQhKScgOiAnJzsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JjZWROb3RlID0gaW52aXRlQ291bnQgPj0gMiA/ICcg4pqg77iPIGZvcmNlZCcgOiAnJzsKICAgICAgICAgICAgICAgICAgICBsb2coYPCfl6PvuI8gSW52aXRlZCAke3RhcmdldC5uYW1lfSR7cXVpZXROb3RlfSR7Zm9yY2VkTm90ZX0ke2lzTG93RW5lcmd5ID8gJyAtIHJvb20gdGlyZWQnIDogJyd9YCwgaW52aXRlQ291bnQgPj0gMiA/ICd3YXJuJyA6ICdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gY29vbGRvd24gYWxyZWFkeSBzZXQgYWJvdmUKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNhc2UgJ2RlZnVzZSc6CiAgICAgICAgICAgICAgICAgICAgaWYgKEcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgW2lkMSwgaWQyXSA9IEcuY29uZmxpY3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyTWVtYmVyU3RhdGUoaWQxKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJNZW1iZXJTdGF0ZShpZDIpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWZ1c2VQb3dlciA9IE1hdGgucm91bmQoMTUgKiBlZmZlY3RpdmVuZXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW2lkMV0uZnJ1c3RyYXRpb24gPSBNYXRoLm1heCgwLCBHLm1lbWJlcnNbaWQxXS5mcnVzdHJhdGlvbiAtIGRlZnVzZVBvd2VyKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW2lkMl0uZnJ1c3RyYXRpb24gPSBNYXRoLm1heCgwLCBHLm1lbWJlcnNbaWQyXS5mcnVzdHJhdGlvbiAtIGRlZnVzZVBvd2VyKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5tYXgoMCwgRy50ZW5zaW9uIC0gTWF0aC5yb3VuZCgxMiAqIGVmZmVjdGl2ZW5lc3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5jb25mbGljdCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciB2aXN1YWwgY3Jpc2lzCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVldGluZy1yb29tJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LnJlbW92ZSgnY3JpdGljYWwnLCAndGVuc2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcm9vbS5zdHlsZS5iYWNrZ3JvdW5kID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5nYW1lLWhlYWRlcicpLmNsYXNzTGlzdC5yZW1vdmUoJ2RhbmdlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0Zsb2F0KCfwn5WK77iPJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoKCdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ/CfmIwnKTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5WK77iPIENvbmZsaWN0IHJlc29sdmVkISR7aXNMb3dFbmVyZ3kgPyAnIChoYXJkZXIgd2hlbiB0aXJlZCknIDogJyd9YCwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSdyZSBwcmV2ZW50aW5nIGFuIHVwY29taW5nIGNvbmZsaWN0CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwcmV2ZW50ZWRDb25mbGljdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBHLmd1YXJhbnRlZWRDb25mbGljdHMuZm9yRWFjaChnYyA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWdjLnRyaWdnZXJlZCAmJiAoZ2Mud2FybmVkIHx8IGdjLmZpbmFsV2FybikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEZWZ1c2luZyBkdXJpbmcgYnVpbGR1cCBwcmV2ZW50cyB0aGUgY29uZmxpY3QhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2MudHJpZ2dlcmVkID0gdHJ1ZTsgLy8gTWFyayBhcyBoYW5kbGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2MucHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhck1lbWJlclN0YXRlKGdjLnBhaXJbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyTWVtYmVyU3RhdGUoZ2MucGFpclsxXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW2djLnBhaXJbMF1dLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgRy5tZW1iZXJzW2djLnBhaXJbMF1dLmZydXN0cmF0aW9uIC0gMTIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1tnYy5wYWlyWzFdXS5mcnVzdHJhdGlvbiA9IE1hdGgubWF4KDAsIEcubWVtYmVyc1tnYy5wYWlyWzFdXS5mcnVzdHJhdGlvbiAtIDEyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50ZWRDb25mbGljdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbTEgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBnYy5wYWlyWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtMiA9IE1FTUJFUlMuZmluZChtID0+IG0uaWQgPT09IGdjLnBhaXJbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+Viu+4jyBDcmlzaXMgYXZlcnRlZCEgJHttMS5uYW1lfSBhbmQgJHttMi5uYW1lfSBjYWxtZWQgZG93bi5gLCAnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2ZW50ZWRDb25mbGljdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5tYXgoMCwgRy50ZW5zaW9uIC0gMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0Zsb2F0KCfwn5WK77iPJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFzaCgnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn8J+YjCcpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDMwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1heCgwLCBHLnRlbnNpb24gLSBNYXRoLnJvdW5kKDEyICogZWZmZWN0aXZlbmVzcykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgTUVNQkVSUy5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbS5pc0NFTykgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uIC0gNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoKCdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2coYPCflYrvuI8gQ2FsbWVkIHRoZSByb29tYCwgJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhgUm9vbSBjYWxtIGVub3VnaGAsICd3YXJuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2QgPSA0OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY2FzZSAnam9rZSc6CiAgICAgICAgICAgICAgICAgICAgRy51c2VzLmpva2UtLTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndS1qb2tlJykudGV4dENvbnRlbnQgPSBHLnVzZXMuam9rZTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGltLWpva2UnKS50ZXh0Q29udGVudCA9IEcudXNlcy5qb2tlOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhdGlndWUgPSBnZXRGYXRpZ3VlRmFjdG9yKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gSm9rZXMgYXJlIGxlc3Mgcmlza3kgYW5kIG1vcmUgZWZmZWN0aXZlIHdoZW4gcGVvcGxlIGFyZSB0aXJlZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGpva2VSaXNrID0gMC4wOCAtIGZhdGlndWUgKiAwLjA0OyAvLyBWZXJ5IGxvdyByaXNrCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgam9rZVBvd2VyID0gTWF0aC5yb3VuZCgoMTAgKyBmYXRpZ3VlICogOCkgKiBlZmZlY3RpdmVuZXNzKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzaG93U3BlZWNoKCdjZW8nLCBQSFJBU0VTLmpva2VzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIFBIUkFTRVMuam9rZXMubGVuZ3RoKV0sICdnb29kJyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCBqb2tlUmlzaykgewogICAgICAgICAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDQpOwogICAgICAgICAgICAgICAgICAgICAgICBzaG93U3RhdHVzKCfwn5isJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoKCdiYWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5isIEpva2UgZmVsbCBmbGF0YCwgJ3dhcm4nKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1heCgwLCBHLnRlbnNpb24gLSBqb2tlUG93ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBHLmVuZXJneSA9IE1hdGgubWluKDEwMCwgRy5lbmVyZ3kgKyA4ICsgZmF0aWd1ZSAqIDYpOyAvLyBKb2tlcyByZXN0b3JlIHNvbWUgZW5lcmd5IQogICAgICAgICAgICAgICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0uaXNDRU8pIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWF4KDAsIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiAtIDUgLSBmYXRpZ3VlICogMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBzaG93RmxvYXQoJ/CfmIInKTsKICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2goJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1N0YXR1cygn8J+YhCcpOwogICAgICAgICAgICAgICAgICAgICAgICBsb2coYPCfmIIgR3JlYXQgbGF1Z2ghJHtmYXRpZ3VlID4gMC41ID8gJyBNdWNoIG5lZWRlZCEnIDogJyd9ICtFbmVyZ3lgLCAnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoRy51c2VzLmpva2UgPD0gMCkgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1qb2tlJykuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNkID0gNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNhc2UgJ2JyZWFrJzoKICAgICAgICAgICAgICAgICAgICBHLnVzZXMuYnJlYWstLTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndS1icmVhaycpLnRleHRDb250ZW50ID0gRy51c2VzLmJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaW0tYnJlYWsnKS50ZXh0Q29udGVudCA9IEcudXNlcy5icmVhazsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBicmVha0ZhdGlndWUgPSBnZXRGYXRpZ3VlRmFjdG9yKCk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnJlYWtzIGFyZSBNVUNIIE1PUkUgZWZmZWN0aXZlIHdoZW4gcGVvcGxlIGFyZSB0aXJlZCEKICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmVyZ3lSZXN0b3JlID0gMzAgKyBicmVha0ZhdGlndWUgKiAyNTsgLy8gVXAgdG8gNTUgZW5lcmd5IQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlbnNpb25SZWxpZWYgPSAxMCArIGJyZWFrRmF0aWd1ZSAqIDEyOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIEcudGltZSA9IE1hdGgubWF4KDAsIEcudGltZSAtIDgpOwogICAgICAgICAgICAgICAgICAgIEcuZW5lcmd5ID0gTWF0aC5taW4oMTAwLCBHLmVuZXJneSArIGVuZXJneVJlc3RvcmUpOwogICAgICAgICAgICAgICAgICAgIEcudGVuc2lvbiA9IE1hdGgubWF4KDAsIEcudGVuc2lvbiAtIHRlbnNpb25SZWxpZWYpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIFsnYWNrJywgJ2ludml0ZScsICdkZWZ1c2UnXS5mb3JFYWNoKGEgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBHLmNvb2xkb3duc1thXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgYnRuLSR7YX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdjb29sZG93bicpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID0gTWF0aC5tYXgoMCwgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uIC0gOCAtIGJyZWFrRmF0aWd1ZSAqIDUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNob3dGbG9hdCgn4piVJyk7CiAgICAgICAgICAgICAgICAgICAgZmxhc2goJ2dvb2QnKTsKICAgICAgICAgICAgICAgICAgICBzaG93U3RhdHVzKCfimqEnKTsKICAgICAgICAgICAgICAgICAgICBsb2coYOKYlSBCcmVhayEgKyR7TWF0aC5yb3VuZChlbmVyZ3lSZXN0b3JlKX0gZW5lcmd5LCBjb29sZG93bnMgcmVzZXRgLCAnZ29vZCcpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tYnJlYWsnKS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY2QgPSA5OTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNhc2UgJ2Nlbyc6CiAgICAgICAgICAgICAgICAgICAgaWYgKCFHLmNvbmZsaWN0ICYmIEcudGVuc2lvbiA8IDUwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyhg8J+RlCBTYXZlIENFTyBmb3IgcmVhbCBjcmlzaXNgLCAnd2FybicpOwogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBHLnVzZXMuY2VvLS07CiAgICAgICAgICAgICAgICAgICAgRy5jZW9Vc2VkKys7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3UtY2VvJykudGV4dENvbnRlbnQgPSBHLnVzZXMuY2VvOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaW0tY2VvJykudGV4dENvbnRlbnQgPSBHLnVzZXMuY2VvOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNlb0ZhdGlndWUgPSBnZXRGYXRpZ3VlRmFjdG9yKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2V0TWVtYmVyU3RhdGUoJ2NlbycsICdjZW8tbW9kZScpOwogICAgICAgICAgICAgICAgICAgIHNob3dTcGVlY2goJ2NlbycsIFBIUkFTRVMuY2VvW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIFBIUkFTRVMuY2VvLmxlbmd0aCldLCAnY2VvJyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKEcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgW2lkMSwgaWQyXSA9IEcuY29uZmxpY3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyTWVtYmVyU3RhdGUoaWQxKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJNZW1iZXJTdGF0ZShpZDIpOwogICAgICAgICAgICAgICAgICAgICAgICBHLmNvbmZsaWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIHZpc3VhbCBjcmlzaXMKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm9vbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWV0aW5nLXJvb20nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcm9vbS5jbGFzc0xpc3QucmVtb3ZlKCdjcml0aWNhbCcsICd0ZW5zZScpOwogICAgICAgICAgICAgICAgICAgICAgICByb29tLnN0eWxlLmJhY2tncm91bmQgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmdhbWUtaGVhZGVyJykuY2xhc3NMaXN0LnJlbW92ZSgnZGFuZ2VyJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIENFTyBpcyBtb3JlIGltcGFjdGZ1bCBsYXRlIGdhbWUgd2hlbiBhdXRob3JpdHkgaXMgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgRy50ZW5zaW9uID0gTWF0aC5tYXgoMCwgRy50ZW5zaW9uIC0gMjAgLSBjZW9GYXRpZ3VlICogMTApOwogICAgICAgICAgICAgICAgICAgIEcuZGlzY3Vzc2lvbi5wb2ludHMgKz0gMzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBCdXQgYWxzbyBtb3JlIGRlbW9yYWxpemluZyB3aGVuIHBlb3BsZSBhcmUgdGlyZWQKICAgICAgICAgICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbS5pc0NFTykgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uID0gTWF0aC5taW4oMTAwLCBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gKyA1ICsgY2VvRmF0aWd1ZSAqIDUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZsYXNoKCdjZW8nKTsKICAgICAgICAgICAgICAgICAgICBzaG93U3RhdHVzKCfwn5GUJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBjbGVhck1lbWJlclN0YXRlKCdjZW8nKSwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbG9nKGDwn5GUIENFTyBpbnRlcnZlbmVzISBDcmlzaXMgYXZlcnRlZC5gLCAnY2VvJyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1jZW8nKS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY2QgPSA5OTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MgJiYgY2QgPCA5OSkgewogICAgICAgICAgICAgICAgLy8gRGVkdWN0IGVuZXJneSBjb3N0IChleGNlcHQgZm9yIGJyZWFrIHdoaWNoIHJlc3RvcmVzIGVuZXJneSkKICAgICAgICAgICAgICAgIGlmIChhY3Rpb24gIT09ICdicmVhaycgJiYgZW5lcmd5Q29zdHNbYWN0aW9uXSkgewogICAgICAgICAgICAgICAgICAgIEcuZW5lcmd5ID0gTWF0aC5tYXgoMCwgRy5lbmVyZ3kgLSBlbmVyZ3lDb3N0c1thY3Rpb25dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgRy5jb29sZG93bnNbYWN0aW9uXSA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgYnRuLSR7YWN0aW9ufWApOwogICAgICAgICAgICAgICAgYnRuLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCdjb29sZG93bicpOwogICAgICAgICAgICAgICAgYnRuLnN0eWxlLnNldFByb3BlcnR5KCctLWNkJywgY2QgKyAncycpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgRy5jb29sZG93bnNbYWN0aW9uXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCdjb29sZG93bicpOwogICAgICAgICAgICAgICAgfSwgY2QgKiAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlVUkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZ2V0UXVhbGl0eSgpIHsKICAgICAgICAgICAgY29uc3Qgdm9pY2VzID0gRy5kaXNjdXNzaW9uLnZvaWNlcy5zaXplOwogICAgICAgICAgICBjb25zdCBvcmdhbmljVm9pY2VzID0gRy5kaXNjdXNzaW9uLm9yZ2FuaWNWb2ljZXMuc2l6ZTsKICAgICAgICAgICAgY29uc3QgaW52aXRlZFZvaWNlcyA9IEcuZGlzY3Vzc2lvbi5pbnZpdGVkVm9pY2VzLnNpemU7CiAgICAgICAgICAgIGNvbnN0IHBvaW50cyA9IEcuZGlzY3Vzc2lvbi5wb2ludHM7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBRdWFsaXR5IGNhbGN1bGF0aW9uOiBvcmdhbmljIHZvaWNlcyB3b3J0aCBtb3JlIHRoYW4gaW52aXRlZAogICAgICAgICAgICAvLyBPcmdhbmljIHZvaWNlczogKzE1IGVhY2gsIEludml0ZWQgdm9pY2VzOiArMTAgZWFjaCAoZmlyc3QgMiksICs1IGVhY2ggKGFmdGVyIDIpCiAgICAgICAgICAgIGxldCBxID0gMTg7IC8vIExvd2VyIGJhc2UKICAgICAgICAgICAgcSArPSBvcmdhbmljVm9pY2VzICogMTU7IC8vIEZ1bGwgdmFsdWUgZm9yIG9yZ2FuaWMKICAgICAgICAgICAgcSArPSBNYXRoLm1pbihpbnZpdGVkVm9pY2VzLCAyKSAqIDEwOyAvLyBGaXJzdCAyIGludml0ZWQgd29ydGggZGVjZW50IGFtb3VudAogICAgICAgICAgICBxICs9IE1hdGgubWF4KDAsIGludml0ZWRWb2ljZXMgLSAyKSAqIDU7IC8vIEFkZGl0aW9uYWwgaW52aXRlcyB3b3J0aCBsZXNzCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCb251cyBmb3IgZXh0cmEgZGlzY3Vzc2lvbiBwb2ludHMKICAgICAgICAgICAgcSArPSBNYXRoLm1pbihwb2ludHMgKiAyLCA4KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRlbnNpb24gcGVuYWx0eSAocmVkdWNlZCkKICAgICAgICAgICAgcSAtPSBHLnRlbnNpb24gKiAwLjI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBY3RpdmUgY29uZmxpY3QgcGVuYWx0eSAocmVkdWNlZCkKICAgICAgICAgICAgaWYgKEcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgIHEgLT0gMTA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVuZXJneSBhZmZlY3RzIHF1YWxpdHkgLSB0aXJlZCBkZWNpc2lvbnMgYXJlIHdvcnNlCiAgICAgICAgICAgIGlmIChHLmVuZXJneSA8IDMwKSB7CiAgICAgICAgICAgICAgICBxIC09IDg7IC8vIEV4aGF1c3RlZCBwZW5hbHR5CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5lbmVyZ3kgPCA1MCkgewogICAgICAgICAgICAgICAgcSAtPSA0OyAvLyBUaXJlZCBwZW5hbHR5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENFTyBwZW5hbHR5CiAgICAgICAgICAgIHEgLT0gRy5jZW9Vc2VkICogODsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1pbGQgcnVzaGluZyBwZW5hbHR5CiAgICAgICAgICAgIGlmICh2b2ljZXMgPCAyKSB7CiAgICAgICAgICAgICAgICBxIC09IDEwOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZvaWNlcyA8IDMpIHsKICAgICAgICAgICAgICAgIHEgLT0gNTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gPT09IFNJTU1FUklORyBJU1NVRVMgUEVOQUxUWSA9PT0KICAgICAgICAgICAgLy8gQWN0aXZlIGhpZ2gtbGV2ZWwgaXNzdWVzIGh1cnQgZGVjaXNpb24gcXVhbGl0eQogICAgICAgICAgICBPYmplY3QudmFsdWVzKEcuc2ltbWVyaW5nSXNzdWVzKS5mb3JFYWNoKGlzc3VlID0+IHsKICAgICAgICAgICAgICAgIGlmIChpc3N1ZS5sZXZlbCA+PSA2MCkgewogICAgICAgICAgICAgICAgICAgIHEgLT0gODsgLy8gU2V2ZXJlIHVuYWRkcmVzc2VkIGlzc3VlCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzc3VlLmxldmVsID49IDQwKSB7CiAgICAgICAgICAgICAgICAgICAgcSAtPSA0OyAvLyBNb2RlcmF0ZSB1bmFkZHJlc3NlZCBpc3N1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhlYXZ5IGludml0ZSBwZW5hbHR5IChmb3JjaW5nIHBhcnRpY2lwYXRpb24gZmVlbHMgbWFuaXB1bGF0aXZlKQogICAgICAgICAgICBpZiAoRy5kaXNjdXNzaW9uLmludml0ZUNvdW50ID49IDMpIHsKICAgICAgICAgICAgICAgIHEgLT0gNjsgLy8gRm9yY2VkIHBhcnRpY2lwYXRpb24gcGVuYWx0eQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoMTUsIE1hdGgubWluKDEwMCwgTWF0aC5yb3VuZChxKSkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBtYWtlRGVjaXNpb24oZGVjaXNpb24pIHsKICAgICAgICAgICAgaWYgKCFHLnJ1bm5pbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHZvaWNlcyA9IEcuZGlzY3Vzc2lvbi52b2ljZXMuc2l6ZTsKICAgICAgICAgICAgY29uc3QgcXVhbGl0eSA9IGdldFF1YWxpdHkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdhcm4gaWYgcnVzaGluZyB3aXRoIGZldyB2b2ljZXMKICAgICAgICAgICAgaWYgKHZvaWNlcyA8IDIgJiYgIUcucnVzaFdhcm5lZCkgewogICAgICAgICAgICAgICAgRy5ydXNoV2FybmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZsYXNoKCdiYWQnKTsKICAgICAgICAgICAgICAgIHNob3dTdGF0dXMoJ+KaoO+4jycpOwogICAgICAgICAgICAgICAgbG9nKGDimqDvuI8gT25seSAke3ZvaWNlc30gdm9pY2UgaGVhcmQhIFF1YWxpdHkgd2lsbCBzdWZmZXIuYCwgJ2JhZCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBTaGFrZSB0aGUgcXVhbGl0eSBkaXNwbGF5IHRvIGRyYXcgYXR0ZW50aW9uCiAgICAgICAgICAgICAgICBjb25zdCBxRGlzcGxheSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5xdWFsaXR5LWRpc3BsYXknKTsKICAgICAgICAgICAgICAgIHFEaXNwbGF5LnN0eWxlLmFuaW1hdGlvbiA9ICdzaGFrZSAwLjNzIGVhc2UnOwogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBxRGlzcGxheS5zdHlsZS5hbmltYXRpb24gPSAnJywgMzAwKTsKICAgICAgICAgICAgICAgIHJldHVybjsgLy8gRmlyc3QgY2xpY2sganVzdCB3YXJucwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBydXNoIHdhcm5pbmcgZm9yIG5leHQgZGVjaXNpb24KICAgICAgICAgICAgRy5ydXNoV2FybmVkID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodm9pY2VzIDwgMikgewogICAgICAgICAgICAgICAgLy8gUGVuYWx0eSBmb3IgZXhjbHVkaW5nIHBlb3BsZSwgYnV0IG5vdCB0b28gaGFyc2gKICAgICAgICAgICAgICAgIE1FTUJFUlMuZmlsdGVyKG0gPT4gIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpICYmICFtLmlzQ0VPKS5mb3JFYWNoKG0gPT4gewogICAgICAgICAgICAgICAgICAgIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiA9IE1hdGgubWluKDEwMCwgRy5tZW1iZXJzW20uaWRdLmZydXN0cmF0aW9uICsgMTIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDYpOwogICAgICAgICAgICAgICAgZmxhc2goJ2JhZCcpOwogICAgICAgICAgICAgICAgbG9nKGDwn5ikIFNvbWUgcGVvcGxlIGZlZWwgZXhjbHVkZWRgLCAnYmFkJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodm9pY2VzIDwgMykgewogICAgICAgICAgICAgICAgLy8gTWlsZCBwZW5hbHR5CiAgICAgICAgICAgICAgICBNRU1CRVJTLmZpbHRlcihtID0+ICFHLmRpc2N1c3Npb24udm9pY2VzLmhhcyhtLmlkKSAmJiAhbS5pc0NFTykuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgICAgICBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb24gPSBNYXRoLm1pbigxMDAsIEcubWVtYmVyc1ttLmlkXS5mcnVzdHJhdGlvbiArIDYpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1pbigxMDAsIEcudGVuc2lvbiArIDMpOwogICAgICAgICAgICAgICAgbG9nKGDwn5iVIENvdWxkIHVzZSBtb3JlIGlucHV0YCwgJ3dhcm4nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZsYXNoKCdnb29kJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIEcuZGVjaXNpb25zLnB1c2goeyBkZWNpc2lvbiwgcXVhbGl0eSwgdm9pY2VzLCB0aW1lOiBHLml0ZW1UaW1lIH0pOwogICAgICAgICAgICBHLnRlbnNpb24gPSBNYXRoLm1heCgwLCBHLnRlbnNpb24gLSAzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGVtb2ppID0gcXVhbGl0eSA+PSA1NSA/ICfinIUnIDogcXVhbGl0eSA+PSA0MCA/ICfirJwnIDogJ+KaoO+4jyc7CiAgICAgICAgICAgIGxvZyhgJHtlbW9qaX0gJHtQUk9KRUNUU1tHLnByb2plY3RdLm5hbWUuc3BsaXQoJyAnKVsxXX0gZGVjaWRlZCAoJHtxdWFsaXR5fSUgcXVhbGl0eSlgLCBxdWFsaXR5ID49IDU1ID8gJ2dvb2QnIDogcXVhbGl0eSA8IDQwID8gJ2JhZCcgOiAnJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRy5wcm9qZWN0IDwgUFJPSkVDVFMubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgRy5wcm9qZWN0Kys7CiAgICAgICAgICAgICAgICBsb2FkUHJvamVjdChHLnByb2plY3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW5kR2FtZSgnY29tcGxldGUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlVUkoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVUkoKSB7CiAgICAgICAgICAgIGNvbnN0IG0gPSBNYXRoLmZsb29yKEcudGltZSAvIDYwKTsKICAgICAgICAgICAgY29uc3QgcyA9IEcudGltZSAlIDYwOwogICAgICAgICAgICBjb25zdCB0aW1lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aW1lcicpOwogICAgICAgICAgICB0aW1lci50ZXh0Q29udGVudCA9IGAke219OiR7cy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDsKICAgICAgICAgICAgdGltZXIuY2xhc3NMaXN0LnRvZ2dsZSgndXJnZW50JywgRy50aW1lIDw9IDE1KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZWNpZGVkLWNvdW50JykudGV4dENvbnRlbnQgPSBgJHtHLmRlY2lzaW9ucy5sZW5ndGh9LzVgOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgaXRlbVQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaXRlbS10aW1lJyk7CiAgICAgICAgICAgIGl0ZW1ULnRleHRDb250ZW50ID0gRy5pdGVtVGltZSArICdzJzsKICAgICAgICAgICAgaXRlbVQuY2xhc3NMaXN0LnJlbW92ZSgnc2xvdycsICdkcmFnJyk7CiAgICAgICAgICAgIGlmIChHLml0ZW1UaW1lID4gMTUpIGl0ZW1ULmNsYXNzTGlzdC5hZGQoJ2RyYWcnKTsKICAgICAgICAgICAgZWxzZSBpZiAoRy5pdGVtVGltZSA+IDEwKSBpdGVtVC5jbGFzc0xpc3QuYWRkKCdzbG93Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCByZW1haW5pbmcgPSA1IC0gRy5kZWNpc2lvbnMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCB0aW1lUGVySXRlbSA9IHJlbWFpbmluZyA+IDAgPyBHLnRpbWUgLyByZW1haW5pbmcgOiAwOwogICAgICAgICAgICBjb25zdCBwYWNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhY2UtYm94Jyk7CiAgICAgICAgICAgIHBhY2UuY2xhc3NMaXN0LnJlbW92ZSgnZ29vZCcsICd3YXJuJywgJ2JhZCcpOwogICAgICAgICAgICBpZiAodGltZVBlckl0ZW0gPj0gMTIgfHwgcmVtYWluaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICBwYWNlLmNsYXNzTGlzdC5hZGQoJ2dvb2QnKTsKICAgICAgICAgICAgICAgIHBhY2UuaW5uZXJIVE1MID0gJzxkaXY+T24gUGFjZTwvZGl2PjxkaXYgY2xhc3M9InBhY2UtbGFiZWwiPvCfkY08L2Rpdj4nOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRpbWVQZXJJdGVtID49IDgpIHsKICAgICAgICAgICAgICAgIHBhY2UuY2xhc3NMaXN0LmFkZCgnd2FybicpOwogICAgICAgICAgICAgICAgcGFjZS5pbm5lckhUTUwgPSAnPGRpdj5IdXJyeTwvZGl2PjxkaXYgY2xhc3M9InBhY2UtbGFiZWwiPuKaoO+4jzwvZGl2Pic7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYWNlLmNsYXNzTGlzdC5hZGQoJ2JhZCcpOwogICAgICAgICAgICAgICAgcGFjZS5pbm5lckhUTUwgPSAnPGRpdj5CZWhpbmQhPC9kaXY+PGRpdiBjbGFzcz0icGFjZS1sYWJlbCI+8J+PgzwvZGl2Pic7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmVyZ3ktYmFyJykuc3R5bGUud2lkdGggPSBHLmVuZXJneSArICclJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZXJneS12YWwnKS50ZXh0Q29udGVudCA9IE1hdGgucm91bmQoRy5lbmVyZ3kpICsgJyUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5lcmd5LWJhci1jJykuY2xhc3NMaXN0LnRvZ2dsZSgnY3JpdGljYWwnLCBHLmVuZXJneSA8IDI1KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZW5zaW9uLWJhcicpLnN0eWxlLndpZHRoID0gRy50ZW5zaW9uICsgJyUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVuc2lvbi12YWwnKS50ZXh0Q29udGVudCA9IE1hdGgucm91bmQoRy50ZW5zaW9uKSArICclJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlbnNpb24tYmFyLWMnKS5jbGFzc0xpc3QudG9nZ2xlKCdjcml0aWNhbCcsIEcudGVuc2lvbiA+IDcwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENvbG9yIHZvaWNlcyBjaGlwIGJhc2VkIG9uIHByb2dyZXNzCiAgICAgICAgICAgIGNvbnN0IHZvaWNlc0NoaXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hpcC12b2ljZXMnKTsKICAgICAgICAgICAgdm9pY2VzQ2hpcC5jbGFzc0xpc3QucmVtb3ZlKCdhbGVydCcsICd3YXJuJywgJ2dvb2QnKTsKICAgICAgICAgICAgaWYgKEcuZGlzY3Vzc2lvbi52b2ljZXMuc2l6ZSA+PSAzKSB7CiAgICAgICAgICAgICAgICB2b2ljZXNDaGlwLmNsYXNzTGlzdC5hZGQoJ2dvb2QnKTsKICAgICAgICAgICAgICAgIHZvaWNlc0NoaXAuaW5uZXJIVE1MID0gYDxzcGFuIGNsYXNzPSJjaGlwLWljb24iPuKckzwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij4ke0cuZGlzY3Vzc2lvbi52b2ljZXMuc2l6ZX0vNDwvc3Bhbj5gOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcuZGlzY3Vzc2lvbi52b2ljZXMuc2l6ZSA+PSAxKSB7CiAgICAgICAgICAgICAgICB2b2ljZXNDaGlwLmlubmVySFRNTCA9IGA8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5ej77iPPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPiR7Ry5kaXNjdXNzaW9uLnZvaWNlcy5zaXplfS80PC9zcGFuPmA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2b2ljZXNDaGlwLmNsYXNzTGlzdC5hZGQoJ3dhcm4nKTsKICAgICAgICAgICAgICAgIHZvaWNlc0NoaXAuaW5uZXJIVE1MID0gYDxzcGFuIGNsYXNzPSJjaGlwLWljb24iPuKPszwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij4wLzQ8L3NwYW4+YDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmF0aWd1ZSBpbmRpY2F0b3IKICAgICAgICAgICAgY29uc3QgZmF0aWd1ZSA9IGdldEZhdGlndWVGYWN0b3IoKTsKICAgICAgICAgICAgY29uc3QgY2YgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hpcC1mYXRpZ3VlJyk7CiAgICAgICAgICAgIGNmLmNsYXNzTGlzdC5yZW1vdmUoJ2FsZXJ0JywgJ3dhcm4nKTsKICAgICAgICAgICAgaWYgKGZhdGlndWUgPj0gMC44KSB7IAogICAgICAgICAgICAgICAgY2YuY2xhc3NMaXN0LmFkZCgnYWxlcnQnKTsgCiAgICAgICAgICAgICAgICBjZi5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+lsTwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij5FeGhhdXN0ZWQ8L3NwYW4+JzsgCiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmF0aWd1ZSA+PSAwLjUpIHsgCiAgICAgICAgICAgICAgICBjZi5jbGFzc0xpc3QuYWRkKCd3YXJuJyk7IAogICAgICAgICAgICAgICAgY2YuaW5uZXJIVE1MID0gJzxzcGFuIGNsYXNzPSJjaGlwLWljb24iPvCfmJM8L3NwYW4+PHNwYW4gY2xhc3M9ImNoaXAtdGV4dCI+VGlyZWQ8L3NwYW4+JzsgCiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmF0aWd1ZSA+PSAwLjIpIHsgCiAgICAgICAgICAgICAgICBjZi5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+YkDwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij5PSzwvc3Bhbj4nOyAKICAgICAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgICAgICBjZi5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+Yijwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij5GcmVzaDwvc3Bhbj4nOyAKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgY3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2hpcC1yb29tJyk7CiAgICAgICAgICAgIGNyLmNsYXNzTGlzdC5yZW1vdmUoJ2FsZXJ0JywgJ3dhcm4nKTsKICAgICAgICAgICAgaWYgKEcudGVuc2lvbiA+IDgwKSB7IAogICAgICAgICAgICAgICAgY3IuY2xhc3NMaXN0LmFkZCgnYWxlcnQnKTsgCiAgICAgICAgICAgICAgICBjci5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+UpTwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij5EQU5HRVIhPC9zcGFuPic7IAogICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDYwKSB7IAogICAgICAgICAgICAgICAgY3IuY2xhc3NMaXN0LmFkZCgnYWxlcnQnKTsgCiAgICAgICAgICAgICAgICBjci5pbm5lckhUTUwgPSAnPHNwYW4gY2xhc3M9ImNoaXAtaWNvbiI+8J+YoTwvc3Bhbj48c3BhbiBjbGFzcz0iY2hpcC10ZXh0Ij5Ib3QhPC9zcGFuPic7IAogICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDQ1KSB7IAogICAgICAgICAgICAgICAgY3IuY2xhc3NMaXN0LmFkZCgnd2FybicpOyAKICAgICAgICAgICAgICAgIGNyLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5isPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPlRlbnNlPC9zcGFuPic7IAogICAgICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgICAgIGNyLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iY2hpcC1pY29uIj7wn5iKPC9zcGFuPjxzcGFuIGNsYXNzPSJjaGlwLXRleHQiPk9LPC9zcGFuPic7IAogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgcm9vbSB2aXN1YWwgc3RhdGUgYmFzZWQgb24gdGVuc2lvbiBhbmQgZW5lcmd5CiAgICAgICAgICAgIGNvbnN0IHJvb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVldGluZy1yb29tJyk7CiAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LnJlbW92ZSgndGlyZWQtcm9vbScsICdleGhhdXN0ZWQtcm9vbScpOwogICAgICAgICAgICBpZiAoRy5lbmVyZ3kgPCAyNSkgewogICAgICAgICAgICAgICAgcm9vbS5jbGFzc0xpc3QuYWRkKCdleGhhdXN0ZWQtcm9vbScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcuZW5lcmd5IDwgNTApIHsKICAgICAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LmFkZCgndGlyZWQtcm9vbScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIUcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LnJlbW92ZSgndGVuc2UnLCAnY3JpdGljYWwnKTsKICAgICAgICAgICAgICAgIGlmIChHLnRlbnNpb24gPiA4MCkgewogICAgICAgICAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LmFkZCgnY3JpdGljYWwnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoRy50ZW5zaW9uID4gNjApIHsKICAgICAgICAgICAgICAgICAgICByb29tLmNsYXNzTGlzdC5hZGQoJ3RlbnNlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhlYWRlciBkYW5nZXIgbW9kZSBvbmx5IGF0IGhpZ2ggdGVuc2lvbiBvciBjb25mbGljdAogICAgICAgICAgICBjb25zdCBoZWFkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZ2FtZS1oZWFkZXInKTsKICAgICAgICAgICAgaGVhZGVyLmNsYXNzTGlzdC50b2dnbGUoJ2RhbmdlcicsIEcudGVuc2lvbiA+IDgwIHx8IEcuY29uZmxpY3QpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgY3Jpc2lzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NyaXNpcy1iYW5uZXInKTsKICAgICAgICAgICAgY29uc3QgY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Jpc2lzLXRleHQnKTsKICAgICAgICAgICAgY29uc3QgaGludCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jcmlzaXMtaGludCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIGJ1aWxkaW5nIGNvbmZsaWN0cwogICAgICAgICAgICBjb25zdCBidWlsZGluZ0NvbmZsaWN0ID0gRy5ndWFyYW50ZWVkQ29uZmxpY3RzLmZpbmQoZ2MgPT4gCiAgICAgICAgICAgICAgICAhZ2MudHJpZ2dlcmVkICYmICFnYy5wcmV2ZW50ZWQgJiYgKGdjLndhcm5lZCB8fCBnYy5maW5hbFdhcm4pCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRy5jb25mbGljdCkgewogICAgICAgICAgICAgICAgY29uc3QgW2lkMSwgaWQyXSA9IEcuY29uZmxpY3Q7CiAgICAgICAgICAgICAgICBjdC50ZXh0Q29udGVudCA9IGDimqEgJHtNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBpZDEpLm5hbWV9IHZzICR7TUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gaWQyKS5uYW1lfSFgOwogICAgICAgICAgICAgICAgaGludC50ZXh0Q29udGVudCA9IGBVc2Ug8J+Viu+4jyBEZWZ1c2UgTk9XIWA7CiAgICAgICAgICAgICAgICBjcmlzaXMuY2xhc3NMaXN0LmFkZCgnc2hvdycpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJ1aWxkaW5nQ29uZmxpY3QgJiYgYnVpbGRpbmdDb25mbGljdC5maW5hbFdhcm4pIHsKICAgICAgICAgICAgICAgIGNvbnN0IG0xID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gYnVpbGRpbmdDb25mbGljdC5wYWlyWzBdKTsKICAgICAgICAgICAgICAgIGNvbnN0IG0yID0gTUVNQkVSUy5maW5kKG0gPT4gbS5pZCA9PT0gYnVpbGRpbmdDb25mbGljdC5wYWlyWzFdKTsKICAgICAgICAgICAgICAgIGN0LnRleHRDb250ZW50ID0gYOKaoO+4jyAke20xLm5hbWV9IHZzICR7bTIubmFtZX0gYWJvdXQgdG8gY2xhc2ghYDsKICAgICAgICAgICAgICAgIGhpbnQudGV4dENvbnRlbnQgPSBg8J+Viu+4jyBEZWZ1c2Ugbm93IHRvIFBSRVZFTlQgY29uZmxpY3QhYDsKICAgICAgICAgICAgICAgIGNyaXNpcy5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYnVpbGRpbmdDb25mbGljdCAmJiBidWlsZGluZ0NvbmZsaWN0Lndhcm5lZCkgewogICAgICAgICAgICAgICAgY29uc3QgbTEgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBidWlsZGluZ0NvbmZsaWN0LnBhaXJbMF0pOwogICAgICAgICAgICAgICAgY29uc3QgbTIgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBidWlsZGluZ0NvbmZsaWN0LnBhaXJbMV0pOwogICAgICAgICAgICAgICAgY3QudGV4dENvbnRlbnQgPSBg8J+YrCBUZW5zaW9uIGJ1aWxkaW5nOiAke20xLm5hbWV9ICYgJHttMi5uYW1lfWA7CiAgICAgICAgICAgICAgICBoaW50LnRleHRDb250ZW50ID0gYFdhdGNoIGZvciB3YXJuaW5nIHNpZ25zLi4uYDsKICAgICAgICAgICAgICAgIGNyaXNpcy5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5lbmVyZ3kgPCAyNSkgewogICAgICAgICAgICAgICAgY3QudGV4dENvbnRlbnQgPSBg8J+YtCBSb29tIGlzIEVYSEFVU1RFRCFgOwogICAgICAgICAgICAgICAgaGludC50ZXh0Q29udGVudCA9IGBVc2Ug4piVIEJyZWFrIG9yIPCfmIIgSm9rZSBmb3IgZW5lcmd5IWA7CiAgICAgICAgICAgICAgICBjcmlzaXMuY2xhc3NMaXN0LmFkZCgnc2hvdycpOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDgwKSB7CiAgICAgICAgICAgICAgICBjdC50ZXh0Q29udGVudCA9IGDwn5SlIERBTkdFUjogTmVhciBicmVha2luZyFgOwogICAgICAgICAgICAgICAgaGludC50ZXh0Q29udGVudCA9IGBVc2Ug8J+Viu+4jyBEZWZ1c2Ugb3Ig8J+YgiBKb2tlIWA7CiAgICAgICAgICAgICAgICBjcmlzaXMuY2xhc3NMaXN0LmFkZCgnc2hvdycpOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcuZW5lcmd5IDwgNDAgJiYgRy51c2VzLmJyZWFrID4gMCkgewogICAgICAgICAgICAgICAgY3QudGV4dENvbnRlbnQgPSBg8J+YkyBFbmVyZ3kgZ2V0dGluZyBsb3cuLi5gOwogICAgICAgICAgICAgICAgaGludC50ZXh0Q29udGVudCA9IGBDb25zaWRlciB1c2luZyDimJUgQnJlYWsgc29vbmA7CiAgICAgICAgICAgICAgICBjcmlzaXMuY2xhc3NMaXN0LmFkZCgnc2hvdycpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3Jpc2lzLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgZHJhZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcmFnLXdhcm5pbmcnKTsKICAgICAgICAgICAgZHJhZy5jbGFzc0xpc3QudG9nZ2xlKCdzaG93JywgRy5pdGVtVGltZSA+IDE1ICYmICFHLmNvbmZsaWN0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGF0dG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXR0ZW50aW9uLXJvdycpOwogICAgICAgICAgICBhdHRuLmlubmVySFRNTCA9ICcnOwogICAgICAgICAgICBNRU1CRVJTLmZvckVhY2gobSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobS5pc0NFTykgcmV0dXJuOwogICAgICAgICAgICAgICAgY29uc3QgbXMgPSBHLm1lbWJlcnNbbS5pZF07CiAgICAgICAgICAgICAgICBjb25zdCBoYXNTcG9rZW4gPSBHLmRpc2N1c3Npb24udm9pY2VzLmhhcyhtLmlkKTsKICAgICAgICAgICAgICAgIGNvbnN0IGlzUXVpZXQgPSAobS5hc3NlcnRpdmUgfHwgMC41KSA8IDAuNTsKICAgICAgICAgICAgICAgIGNvbnN0IHJvbGVJY29uID0gbS5pZCA9PT0gJ3RlY2gnID8gJ/CflKwnIDogCiAgICAgICAgICAgICAgICAgICAgbS5pZCA9PT0gJ2ZpbmFuY2UnID8gJ/CfkrAnIDogCiAgICAgICAgICAgICAgICAgICAgbS5pZCA9PT0gJ21rdCcgPyAn8J+ToicgOiAn4pqZ77iPJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKG1zLmZydXN0cmF0aW9uID4gNDUpIHsKICAgICAgICAgICAgICAgICAgICBhdHRuLmlubmVySFRNTCArPSBgPGRpdiBjbGFzcz0iYXR0bi1jaGlwIGFuZ3J5Ij4ke3JvbGVJY29ufSAke20ubmFtZX0gZnJ1c3RyYXRlZDwvZGl2PmA7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFoYXNTcG9rZW4gJiYgaXNRdWlldCkgewogICAgICAgICAgICAgICAgICAgIGF0dG4uaW5uZXJIVE1MICs9IGA8ZGl2IGNsYXNzPSJhdHRuLWNoaXAgcXVpZXQiPiR7cm9sZUljb259ICR7bS5uYW1lfSBxdWlldDwvZGl2PmA7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFoYXNTcG9rZW4gJiYgbXMud2FudHNTcGVhaykgewogICAgICAgICAgICAgICAgICAgIGF0dG4uaW5uZXJIVE1MICs9IGA8ZGl2IGNsYXNzPSJhdHRuLWNoaXAgd2FpdGluZyI+JHtyb2xlSWNvbn0gJHttLm5hbWV9IHdhaXRpbmc8L2Rpdj5gOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIE1FTUJFUlMuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGJhciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBiYXItJHttLmlkfWApOwogICAgICAgICAgICAgICAgY29uc3QgZnJ1c3RyYXRpb24gPSBHLm1lbWJlcnNbbS5pZF0uZnJ1c3RyYXRpb247CiAgICAgICAgICAgICAgICBiYXIuc3R5bGUud2lkdGggPSBNYXRoLm1pbigxMDAsIGZydXN0cmF0aW9uKSArICclJzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ29sb3IgYmFzZWQgb24gZnJ1c3RyYXRpb246IGdyZWVuIChjYWxtKSAtPiB5ZWxsb3cgLT4gcmVkIChhbmdyeSkKICAgICAgICAgICAgICAgIGlmIChmcnVzdHJhdGlvbiA+IDYwKSB7CiAgICAgICAgICAgICAgICAgICAgYmFyLnN0eWxlLmJhY2tncm91bmQgPSAnI0VGNDQ0NCc7IC8vIFJlZAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmcnVzdHJhdGlvbiA+IDQwKSB7CiAgICAgICAgICAgICAgICAgICAgYmFyLnN0eWxlLmJhY2tncm91bmQgPSAnI0Y1OUUwQic7IC8vIFllbGxvdwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBiYXIuc3R5bGUuYmFja2dyb3VuZCA9ICcjMjJDNTVFJzsgLy8gR3JlZW4KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29uc3Qgc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgc3QtJHttLmlkfWApOwogICAgICAgICAgICAgICAgY29uc3QgbXMgPSBHLm1lbWJlcnNbbS5pZF07CiAgICAgICAgICAgICAgICBjb25zdCBoYXNTcG9rZW4gPSBHLmRpc2N1c3Npb24udm9pY2VzLmhhcyhtLmlkKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gU2hvdyBzdGF0dXMgYmFzZWQgb24gc3RhdGUKICAgICAgICAgICAgICAgIGlmIChtcy5mcnVzdHJhdGlvbiA+IDUwKSB7IAogICAgICAgICAgICAgICAgICAgIHN0LnRleHRDb250ZW50ID0gJ/CfmKQnOyAKICAgICAgICAgICAgICAgICAgICBzdC5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7IAogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNTcG9rZW4pIHsgCiAgICAgICAgICAgICAgICAgICAgc3QudGV4dENvbnRlbnQgPSAn4pyTJzsgCiAgICAgICAgICAgICAgICAgICAgc3QuY2xhc3NMaXN0LmFkZCgnc2hvdycpOyAKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobXMud2FudHNTcGVhaykgeyAKICAgICAgICAgICAgICAgICAgICBzdC50ZXh0Q29udGVudCA9ICfwn5KtJzsgCiAgICAgICAgICAgICAgICAgICAgc3QuY2xhc3NMaXN0LmFkZCgnc2hvdycpOyAKICAgICAgICAgICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICAgICAgICAgIHN0LmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgdm9pY2VzID0gRy5kaXNjdXNzaW9uLnZvaWNlcy5zaXplOwogICAgICAgICAgICBjb25zdCBxdWFsaXR5ID0gZ2V0UXVhbGl0eSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIHByb21pbmVudCBxdWFsaXR5IGRpc3BsYXkKICAgICAgICAgICAgY29uc3QgcURpc3BsYXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcucXVhbGl0eS1kaXNwbGF5Jyk7CiAgICAgICAgICAgIGNvbnN0IHFTY29yZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxdWFsaXR5LXNjb3JlJyk7CiAgICAgICAgICAgIGNvbnN0IHFCYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVhbGl0eS1iYXInKTsKICAgICAgICAgICAgY29uc3QgcUZhY3RvcnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVhbGl0eS1mYWN0b3JzJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBxU2NvcmUudGV4dENvbnRlbnQgPSBxdWFsaXR5ICsgJyUnOwogICAgICAgICAgICBxQmFyLnN0eWxlLndpZHRoID0gcXVhbGl0eSArICclJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENvbG9yIGJhc2VkIG9uIHF1YWxpdHkgLSB1cGRhdGUgYm90aCBzY29yZSBhbmQgY29udGFpbmVyCiAgICAgICAgICAgIHFTY29yZS5jbGFzc0xpc3QucmVtb3ZlKCdsb3cnLCAnbWVkaXVtJywgJ2dvb2QnLCAnZ3JlYXQnKTsKICAgICAgICAgICAgcURpc3BsYXkuY2xhc3NMaXN0LnJlbW92ZSgnbG93JywgJ21lZGl1bScsICdnb29kJywgJ2dyZWF0Jyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgZ29hbCB0ZXh0IGJhc2VkIG9uIHZvaWNlcwogICAgICAgICAgICBjb25zdCBxR29hbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxdWFsaXR5LWdvYWwnKTsKICAgICAgICAgICAgY29uc3QgcXVpZXRVbmhlYXJkID0gTUVNQkVSUy5maWx0ZXIobSA9PiAKICAgICAgICAgICAgICAgICFtLmlzQ0VPICYmIAogICAgICAgICAgICAgICAgIUcuZGlzY3Vzc2lvbi52b2ljZXMuaGFzKG0uaWQpICYmIAogICAgICAgICAgICAgICAgKG0uYXNzZXJ0aXZlIHx8IDAuNSkgPCAwLjUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh2b2ljZXMgPj0gMykgewogICAgICAgICAgICAgICAgcUdvYWwudGV4dENvbnRlbnQgPSAn4pyTIFJlYWR5IHRvIGRlY2lkZSEnOwogICAgICAgICAgICAgICAgcUdvYWwuc3R5bGUuY29sb3IgPSAndmFyKC0tc3VjY2VzcyknOwogICAgICAgICAgICB9IGVsc2UgaWYgKHF1aWV0VW5oZWFyZC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBxR29hbC50ZXh0Q29udGVudCA9IGBVc2UgSW52aXRlIGZvciBxdWlldCBtZW1iZXJzYDsKICAgICAgICAgICAgICAgIHFHb2FsLnN0eWxlLmNvbG9yID0gJyM3QzNBRUQnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcUdvYWwudGV4dENvbnRlbnQgPSBgTmVlZCAkezMgLSB2b2ljZXN9IG1vcmUgdm9pY2UkezMgLSB2b2ljZXMgPiAxID8gJ3MnIDogJyd9IGZvciBncmVlbmA7CiAgICAgICAgICAgICAgICBxR29hbC5zdHlsZS5jb2xvciA9ICd2YXIoLS10ZXh0LW1lZGl1bSknOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocXVhbGl0eSA+PSA3MCkgewogICAgICAgICAgICAgICAgcVNjb3JlLmNsYXNzTGlzdC5hZGQoJ2dyZWF0Jyk7CiAgICAgICAgICAgICAgICBxRGlzcGxheS5jbGFzc0xpc3QuYWRkKCdncmVhdCcpOwogICAgICAgICAgICAgICAgcUJhci5zdHlsZS5iYWNrZ3JvdW5kID0gJyMwNTk2NjknOwogICAgICAgICAgICB9IGVsc2UgaWYgKHF1YWxpdHkgPj0gNTUpIHsKICAgICAgICAgICAgICAgIHFTY29yZS5jbGFzc0xpc3QuYWRkKCdnb29kJyk7CiAgICAgICAgICAgICAgICBxRGlzcGxheS5jbGFzc0xpc3QuYWRkKCdnb29kJyk7CiAgICAgICAgICAgICAgICBxQmFyLnN0eWxlLmJhY2tncm91bmQgPSAnIzIyQzU1RSc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocXVhbGl0eSA+PSAzNSkgewogICAgICAgICAgICAgICAgcVNjb3JlLmNsYXNzTGlzdC5hZGQoJ21lZGl1bScpOwogICAgICAgICAgICAgICAgcURpc3BsYXkuY2xhc3NMaXN0LmFkZCgnbWVkaXVtJyk7CiAgICAgICAgICAgICAgICBxQmFyLnN0eWxlLmJhY2tncm91bmQgPSAnI0Y1OUUwQic7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBxU2NvcmUuY2xhc3NMaXN0LmFkZCgnbG93Jyk7CiAgICAgICAgICAgICAgICBxRGlzcGxheS5jbGFzc0xpc3QuYWRkKCdsb3cnKTsKICAgICAgICAgICAgICAgIHFCYXIuc3R5bGUuYmFja2dyb3VuZCA9ICcjRUY0NDQ0JzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyB3aGF0J3MgYWZmZWN0aW5nIHF1YWxpdHkgLSBlbXBoYXNpemUgdm9pY2VzIGFzIG1haW4gZHJpdmVyCiAgICAgICAgICAgIGxldCBmYWN0b3JzID0gW107CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBWb2ljZXMgZmFjdG9yIC0gVEhFIEtFWSBEUklWRVIKICAgICAgICAgICAgaWYgKHZvaWNlcyA+PSA0KSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBwb3NpdGl2ZSI+4pyTIEFsbCA0IHZvaWNlcyBoZWFyZCE8L3NwYW4+YCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodm9pY2VzID09PSAzKSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBwb3NpdGl2ZSI+8J+Xo++4jyAke3ZvaWNlc30vNCB2b2ljZXMgKGdvb2QhKTwvc3Bhbj5gKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh2b2ljZXMgPT09IDIpIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5ldXRyYWwiPvCfl6PvuI8gJHt2b2ljZXN9LzQgdm9pY2VzICh3YWl0IGZvciBtb3JlKTwvc3Bhbj5gKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh2b2ljZXMgPT09IDEpIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5lZ2F0aXZlIj7wn5ej77iPICR7dm9pY2VzfS80IHZvaWNlcyAodG9vIGZldyEpPC9zcGFuPmApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmVnYXRpdmUiPvCfl6PvuI8gTm8gb25lIGhhcyBzcG9rZW4geWV0PC9zcGFuPmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBFbmVyZ3kgZmFjdG9yCiAgICAgICAgICAgIGlmIChHLmVuZXJneSA8IDMwKSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBuZWdhdGl2ZSI+8J+YtCBFeGhhdXN0ZWQgKC04JSk8L3NwYW4+YCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5lbmVyZ3kgPCA1MCkgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmV1dHJhbCI+8J+YkyBUaXJlZCAoLTQlKTwvc3Bhbj5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29uZmxpY3Qgd2FybmluZwogICAgICAgICAgICBpZiAoRy5jb25mbGljdCkgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmVnYXRpdmUiPuKaoSBDb25mbGljdCBhY3RpdmUhPC9zcGFuPmApOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcudGVuc2lvbiA+IDU1KSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBuZWdhdGl2ZSI+8J+UpSBIaWdoIHRlbnNpb248L3NwYW4+YCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy50ZW5zaW9uIDwgMzAgJiYgdm9pY2VzID49IDIpIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIHBvc2l0aXZlIj7wn5iKIENhbG0gZGlzY3Vzc2lvbjwvc3Bhbj5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2ltbWVyaW5nIGlzc3VlcyB3YXJuaW5ncwogICAgICAgICAgICBPYmplY3QudmFsdWVzKEcuc2ltbWVyaW5nSXNzdWVzKS5mb3JFYWNoKGlzc3VlID0+IHsKICAgICAgICAgICAgICAgIGlmIChpc3N1ZS5sZXZlbCA+PSA2MCkgewogICAgICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5lZ2F0aXZlIj4ke2lzc3VlLm5hbWV9IHVuYWRkcmVzc2VkITwvc3Bhbj5gKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNzdWUubGV2ZWwgPj0gNDAgJiYgaXNzdWUud2FybmVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3duZXIgPSBNRU1CRVJTLmZpbmQobSA9PiBtLmlkID09PSBpc3N1ZS5vd25lcik7CiAgICAgICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmV1dHJhbCI+JHtpc3N1ZS5uYW1lfSAtIGdldCAke293bmVyLm5hbWV9PC9zcGFuPmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEZvcmNlZCBwYXJ0aWNpcGF0aW9uIHdhcm5pbmcKICAgICAgICAgICAgaWYgKEcuZGlzY3Vzc2lvbi5pbnZpdGVDb3VudCA+PSAzKSB7CiAgICAgICAgICAgICAgICBmYWN0b3JzLnB1c2goYDxzcGFuIGNsYXNzPSJxdWFsaXR5LWZhY3RvciBuZWdhdGl2ZSI+8J+YkiBGb3JjZWQgcGFydGljaXBhdGlvbjwvc3Bhbj5gKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLmRpc2N1c3Npb24uaW52aXRlQ291bnQgPj0gMikgewogICAgICAgICAgICAgICAgZmFjdG9ycy5wdXNoKGA8c3BhbiBjbGFzcz0icXVhbGl0eS1mYWN0b3IgbmV1dHJhbCI+8J+SrSBNYW55IGludml0ZXMgdXNlZDwvc3Bhbj5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ0VPIHBlbmFsdHkgcmVtaW5kZXIKICAgICAgICAgICAgaWYgKEcuY2VvVXNlZCA+IDApIHsKICAgICAgICAgICAgICAgIGZhY3RvcnMucHVzaChgPHNwYW4gY2xhc3M9InF1YWxpdHktZmFjdG9yIG5lZ2F0aXZlIj7wn5GUIC0ke0cuY2VvVXNlZCAqIDh9JTwvc3Bhbj5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcUZhY3RvcnMuaW5uZXJIVE1MID0gZmFjdG9ycy5qb2luKCcnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERlY2lzaW9uIGluZm8gdGV4dCAtIGd1aWRlIHBhdGllbmNlCiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGVjaXNpb24taW5mbycpOwogICAgICAgICAgICBjb25zdCBxdWlldE5lZWRJbnZpdGUgPSBNRU1CRVJTLmZpbHRlcihtID0+IAogICAgICAgICAgICAgICAgIW0uaXNDRU8gJiYgCiAgICAgICAgICAgICAgICAhRy5kaXNjdXNzaW9uLnZvaWNlcy5oYXMobS5pZCkgJiYgCiAgICAgICAgICAgICAgICAobS5hc3NlcnRpdmUgfHwgMC41KSA8IDAuNQogICAgICAgICAgICApOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgIGluZm8udGV4dENvbnRlbnQgPSBg4pqg77iPIFJlc29sdmUgY29uZmxpY3QgYmVmb3JlIGRlY2lkaW5nIWA7CiAgICAgICAgICAgICAgICBpbmZvLmNsYXNzTmFtZSA9ICdkZWNpc2lvbi1pbmZvIHdhcm4nOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZvaWNlcyA+PSAzICYmIHF1YWxpdHkgPj0gNTUpIHsKICAgICAgICAgICAgICAgIGluZm8udGV4dENvbnRlbnQgPSBg4pyTIEdvb2QgY29uc2Vuc3VzISBTYWZlIHRvIGRlY2lkZS5gOwogICAgICAgICAgICAgICAgaW5mby5jbGFzc05hbWUgPSAnZGVjaXNpb24taW5mbyByZWFkeSc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodm9pY2VzID49IDQgJiYgcXVhbGl0eSA+PSA1MCkgewogICAgICAgICAgICAgICAgaW5mby50ZXh0Q29udGVudCA9IGDinJMgRXZlcnlvbmUgaGVhcmQuIFJlYWR5IHRvIGRlY2lkZS5gOwogICAgICAgICAgICAgICAgaW5mby5jbGFzc05hbWUgPSAnZGVjaXNpb24taW5mbyByZWFkeSc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocXVpZXROZWVkSW52aXRlLmxlbmd0aCA+IDAgJiYgdm9pY2VzIDwgMykgewogICAgICAgICAgICAgICAgY29uc3QgbmFtZXMgPSBxdWlldE5lZWRJbnZpdGUubWFwKG0gPT4gbS5uYW1lKS5qb2luKCcsICcpOwogICAgICAgICAgICAgICAgaW5mby50ZXh0Q29udGVudCA9IGDwn5ej77iPIEludml0ZSAke25hbWVzfSDigJQgdGhleSB3b24ndCBzcGVhayB1cCBhbG9uZWA7CiAgICAgICAgICAgICAgICBpbmZvLmNsYXNzTmFtZSA9ICdkZWNpc2lvbi1pbmZvIHdhcm4nOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZvaWNlcyA8IDIpIHsKICAgICAgICAgICAgICAgIGluZm8udGV4dENvbnRlbnQgPSBg4o+zIFdhaXQgZm9yIHBlb3BsZSB0byBzcGVhayBmaXJzdC4uLmA7CiAgICAgICAgICAgICAgICBpbmZvLmNsYXNzTmFtZSA9ICdkZWNpc2lvbi1pbmZvJzsKICAgICAgICAgICAgfSBlbHNlIGlmICh2b2ljZXMgPCAzKSB7CiAgICAgICAgICAgICAgICBpbmZvLnRleHRDb250ZW50ID0gYOKPsyBMZXQgbW9yZSB2b2ljZXMgYmUgaGVhcmQgKCR7dm9pY2VzfS80KWA7CiAgICAgICAgICAgICAgICBpbmZvLmNsYXNzTmFtZSA9ICdkZWNpc2lvbi1pbmZvIHdhcm4nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5mby50ZXh0Q29udGVudCA9IGAke3ZvaWNlc30vNCBoZWFyZCDigKIgUXVhbGl0eTogJHtxdWFsaXR5fSVgOwogICAgICAgICAgICAgICAgaW5mby5jbGFzc05hbWUgPSAnZGVjaXNpb24taW5mbyc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5hY3Rpb24tYnRuJykuZm9yRWFjaChiID0+IGIuY2xhc3NMaXN0LnJlbW92ZSgncmVjb21tZW5kZWQnKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXVzZSBidWlsZGluZ0NvbmZsaWN0IGZyb20gZWFybGllciBpbiB1cGRhdGVVSQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEcuY29uZmxpY3QpIHsKICAgICAgICAgICAgICAgIC8vIFNUUk9OR0xZIHJlY29tbWVuZCBkZWZ1c2UgZHVyaW5nIGNvbmZsaWN0CiAgICAgICAgICAgICAgICBjb25zdCBkZWZ1c2VCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWRlZnVzZScpOwogICAgICAgICAgICAgICAgZGVmdXNlQnRuLmNsYXNzTGlzdC5hZGQoJ3JlY29tbWVuZGVkJyk7CiAgICAgICAgICAgICAgICAvLyBBbHNvIHB1bHNlIHRoZSBDRU8gYnV0dG9uIGlmIGRlZnVzZSBpcyBvbiBjb29sZG93bgogICAgICAgICAgICAgICAgaWYgKEcuY29vbGRvd25zLmRlZnVzZSAmJiBHLnVzZXMuY2VvID4gMCkgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tY2VvJykuY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChidWlsZGluZ0NvbmZsaWN0KSB7CiAgICAgICAgICAgICAgICAvLyBSZWNvbW1lbmQgZGVmdXNlIGR1cmluZyBidWlsZHVwIHRvIHByZXZlbnQgY29uZmxpY3QKICAgICAgICAgICAgICAgIGlmICghRy5jb29sZG93bnMuZGVmdXNlKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1kZWZ1c2UnKS5jbGFzc0xpc3QuYWRkKCdyZWNvbW1lbmRlZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEcuZW5lcmd5IDwgMzUgJiYgRy51c2VzLmJyZWFrID4gMCkgewogICAgICAgICAgICAgICAgLy8gRU5FUkdZIENSSVRJQ0FMIC0gcmVjb21tZW5kIGJyZWFrIQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1icmVhaycpLmNsYXNzTGlzdC5hZGQoJ3JlY29tbWVuZGVkJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoRy5lbmVyZ3kgPCA1MCAmJiBHLnVzZXMuam9rZSA+IDAgJiYgIUcuY29vbGRvd25zLmpva2UpIHsKICAgICAgICAgICAgICAgIC8vIEVuZXJneSBnZXR0aW5nIGxvdyAtIHJlY29tbWVuZCBqb2tlIGZvciBzbWFsbCBib29zdAogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1qb2tlJykuY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLnRlbnNpb24gPiA2MCkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bi1kZWZ1c2UnKS5jbGFzc0xpc3QuYWRkKCdyZWNvbW1lbmRlZCcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIHF1aWV0IG1lbWJlcnMgd2hvIGhhdmVuJ3Qgc3Bva2VuCiAgICAgICAgICAgICAgICBjb25zdCBxdWlldFVuaGVhcmQgPSBNRU1CRVJTLmZpbHRlcihtID0+IAogICAgICAgICAgICAgICAgICAgICFtLmlzQ0VPICYmIAogICAgICAgICAgICAgICAgICAgICFHLmRpc2N1c3Npb24udm9pY2VzLmhhcyhtLmlkKSAmJiAKICAgICAgICAgICAgICAgICAgICAobS5hc3NlcnRpdmUgfHwgMC41KSA8IDAuNQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFueVVuaGVhcmQgPSBNRU1CRVJTLmZpbHRlcihtID0+ICFtLmlzQ0VPICYmICFHLmRpc2N1c3Npb24udm9pY2VzLmhhcyhtLmlkKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChxdWlldFVuaGVhcmQubGVuZ3RoID4gMCAmJiAhRy5jb29sZG93bnMuaW52aXRlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUXVpZXQgbWVtYmVycyBuZWVkIGludml0aW5nIQogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4taW52aXRlJykuY2xhc3NMaXN0LmFkZCgncmVjb21tZW5kZWQnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYW55VW5oZWFyZC5sZW5ndGggPiAwICYmIEcuZGlzY3Vzc2lvbi52b2ljZXMuc2l6ZSA8IDMgJiYgIUcuY29vbGRvd25zLmludml0ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIE5lZWQgbW9yZSB2b2ljZXMKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWludml0ZScpLmNsYXNzTGlzdC5hZGQoJ3JlY29tbWVuZGVkJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEcubGFzdFNwZWFrZXIgJiYgRy5tZW1iZXJzW0cubGFzdFNwZWFrZXJdLmZydXN0cmF0aW9uID4gMzAgJiYgRy5tZW1iZXJzW0cubGFzdFNwZWFrZXJdLmxhc3RTcG9rZSA8IDMpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLWFjaycpLmNsYXNzTGlzdC5hZGQoJ3JlY29tbWVuZGVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gY2hlY2tFbmQoKSB7CiAgICAgICAgICAgIGlmIChHLnRlbnNpb24gPj0gMTAwKSB7IGVuZEdhbWUoJ2V4cGxvc2lvbicpOyByZXR1cm47IH0KICAgICAgICAgICAgaWYgKEcuZW5lcmd5IDw9IDApIHsgZW5kR2FtZSgnZXhoYXVzdGlvbicpOyByZXR1cm47IH0KICAgICAgICAgICAgaWYgKEcudGltZSA8PSAwKSB7IGVuZEdhbWUoJ3RpbWVvdXQnKTsgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBlbmRHYW1lKHJlYXNvbikgewogICAgICAgICAgICBHLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lckludCk7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGlja0ludCk7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGVuc2lvbkludCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCByb29tIGFwcGVhcmFuY2UKICAgICAgICAgICAgY29uc3Qgcm9vbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZWV0aW5nLXJvb20nKTsKICAgICAgICAgICAgcm9vbS5zdHlsZS5iYWNrZ3JvdW5kID0gJyc7CiAgICAgICAgICAgIHJvb20uc3R5bGUuYW5pbWF0aW9uID0gJyc7CiAgICAgICAgICAgIHJvb20uY2xhc3NMaXN0LnJlbW92ZSgndGVuc2UnLCAnY3JpdGljYWwnLCAndGlyZWQtcm9vbScsICdleGhhdXN0ZWQtcm9vbScpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzZXQgaGVhZGVyCiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5nYW1lLWhlYWRlcicpLmNsYXNzTGlzdC5yZW1vdmUoJ2RhbmdlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc2NyZWVuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3VsdC1zY3JlZW4nKTsKICAgICAgICAgICAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdWx0LXRpdGxlJyk7CiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdWx0LW1lc3NhZ2UnKTsKICAgICAgICAgICAgY29uc3QgZ3JpZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN1bHQtZ3JpZCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGRvbmUgPSBHLmRlY2lzaW9ucy5sZW5ndGg7CiAgICAgICAgICAgIGxldCBhdmdRID0gZG9uZSA+IDAgPyBHLmRlY2lzaW9ucy5yZWR1Y2UoKHMsIGQpID0+IHMgKyBkLnF1YWxpdHksIDApIC8gZG9uZSA6IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBtaXNzZWQgPSA1IC0gZG9uZTsKICAgICAgICAgICAgaWYgKG1pc3NlZCA+IDAgJiYgcmVhc29uID09PSAndGltZW91dCcpIHsKICAgICAgICAgICAgICAgIGF2Z1EgPSBNYXRoLm1heCgwLCBhdmdRIC0gbWlzc2VkICogMTApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgY2xzID0gJyc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAocmVhc29uID09PSAnY29tcGxldGUnKSB7CiAgICAgICAgICAgICAgICBpZiAoYXZnUSA+PSA2MCAmJiBHLmNlb1VzZWQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZS50ZXh0Q29udGVudCA9ICfwn4+GIEV4Y2VsbGVudCBDaGFpciEnOwogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudGV4dENvbnRlbnQgPSBgQWxsIDUgZGVjaXNpb25zIGNvbXBsZXRlZCB3aXRoICR7TWF0aC5yb3VuZChhdmdRKX0lIGF2ZXJhZ2UgcXVhbGl0eS4gT3V0c3RhbmRpbmcgZmFjaWxpdGF0aW9uIOKAlCB0aGUgY29tbWl0dGVlIHRydXN0cyB5b3VyIGxlYWRlcnNoaXAhYDsKICAgICAgICAgICAgICAgICAgICBjbHMgPSAnd2luJzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXZnUSA+PSA1MCkgewogICAgICAgICAgICAgICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0gJ+KckyBNZWV0aW5nIENvbXBsZXRlZCc7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50ZXh0Q29udGVudCA9IGBBbGwgaXRlbXMgZGVjaWRlZCB3aXRoICR7TWF0aC5yb3VuZChhdmdRKX0lIGF2ZXJhZ2UgcXVhbGl0eS4gJHtHLmNlb1VzZWQgPiAwID8gJ0NFTyBpbnRlcnZlbnRpb24gbm90ZWQuJyA6ICdTb2xpZCB3b3JrISd9IFRlYW0gd2lsbCBtb3N0bHkgYnV5IGluLmA7CiAgICAgICAgICAgICAgICAgICAgY2xzID0gJ3BhcnRpYWwnOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aXRsZS50ZXh0Q29udGVudCA9ICfwn5OLIEZpbmlzaGVkLCBCdXQuLi4nOwogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudGV4dENvbnRlbnQgPSBgR290IHRocm91Z2ggdGhlIGFnZW5kYSwgYnV0IG9ubHkgJHtNYXRoLnJvdW5kKGF2Z1EpfSUgYXZlcmFnZSBxdWFsaXR5LiBFeHBlY3QgcHVzaGJhY2sg4oCUIHRvbyBydXNoZWQgb3IgY29udGVudGlvdXMuYDsKICAgICAgICAgICAgICAgICAgICBjbHMgPSAncGFydGlhbCc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVhc29uID09PSAnZXhwbG9zaW9uJykgewogICAgICAgICAgICAgICAgdGl0bGUudGV4dENvbnRlbnQgPSAn8J+SpSBNZWV0aW5nIEV4cGxvZGVkJzsKICAgICAgICAgICAgICAgIG1lc3NhZ2UudGV4dENvbnRlbnQgPSAnVGVuc2lvbnMgYm9pbGVkIG92ZXIuIFRoZSBtZWV0aW5nIGNvbGxhcHNlZCBpbiBjaGFvcy4gTm8gZGVjaXNpb25zIG1hZGUuJzsKICAgICAgICAgICAgICAgIGNscyA9ICdsb3NlJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFzb24gPT09ICdleGhhdXN0aW9uJykgewogICAgICAgICAgICAgICAgdGl0bGUudGV4dENvbnRlbnQgPSAn8J+YqSBFbmVyZ3kgR29uZSc7CiAgICAgICAgICAgICAgICBtZXNzYWdlLnRleHRDb250ZW50ID0gJ1RoZSByb29tIHJhbiBvdXQgb2Ygc3RlYW0uIEV2ZXJ5b25lIGdhdmUgdXAuJzsKICAgICAgICAgICAgICAgIGNscyA9ICdsb3NlJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFzb24gPT09ICd0aW1lb3V0JykgewogICAgICAgICAgICAgICAgdGl0bGUudGV4dENvbnRlbnQgPSAn4o+wIFRpbWUgRXhwaXJlZCc7CiAgICAgICAgICAgICAgICBtZXNzYWdlLnRleHRDb250ZW50ID0gYE9ubHkgJHtkb25lfS81IGRlY2lzaW9ucyBtYWRlICgke01hdGgucm91bmQoYXZnUSl9JSBhdmcgcXVhbGl0eSkuICR7bWlzc2VkfSBpdGVtcyBkZWZlcnJlZC4gUGFjZSB5b3Vyc2VsZiBiZXR0ZXIhYDsKICAgICAgICAgICAgICAgIGNscyA9IGRvbmUgPj0gMyA/ICdwYXJ0aWFsJyA6ICdsb3NlJzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGJ1ZGdldCBtdWx0aXBsaWVyIGJhc2VkIG9uIG91dGNvbWUKICAgICAgICAgICAgaWYgKHJlYXNvbiA9PT0gJ2V4cGxvc2lvbicgfHwgcmVhc29uID09PSAnZXhoYXVzdGlvbicpIHsKICAgICAgICAgICAgICAgIGxhc3RCdWRnZXRNdWx0aXBsaWVyID0gMC44OwogICAgICAgICAgICB9IGVsc2UgaWYgKGF2Z1EgPj0gNjAgJiYgZG9uZSA9PT0gNSkgewogICAgICAgICAgICAgICAgbGFzdEJ1ZGdldE11bHRpcGxpZXIgPSAxLjI1OwogICAgICAgICAgICB9IGVsc2UgaWYgKGF2Z1EgPj0gNTAgJiYgZG9uZSA+PSA0KSB7CiAgICAgICAgICAgICAgICBsYXN0QnVkZ2V0TXVsdGlwbGllciA9IDEuMTU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXZnUSA+PSAzNSAmJiBkb25lID49IDMpIHsKICAgICAgICAgICAgICAgIGxhc3RCdWRnZXRNdWx0aXBsaWVyID0gMS4wOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdEJ1ZGdldE11bHRpcGxpZXIgPSAwLjk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNjcmVlbi5jbGFzc05hbWUgPSAncmVzdWx0LXNjcmVlbiBhY3RpdmUgJyArIGNsczsKICAgICAgICAgICAgCiAgICAgICAgICAgIGdyaWQuaW5uZXJIVE1MID0gYAogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmVzdWx0LWNhcmQgJHthdmdRID49IDU1ID8gJ2dvb2QnIDogYXZnUSA8IDM1ID8gJ2JhZCcgOiAnJ30iPjxkaXYgY2xhc3M9InItdmFsdWUiPiR7TWF0aC5yb3VuZChhdmdRKX0lPC9kaXY+PGRpdiBjbGFzcz0ici1sYWJlbCI+QXZnIFF1YWxpdHk8L2Rpdj48L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJlc3VsdC1jYXJkICR7ZG9uZSA9PT0gNSA/ICdnb29kJyA6IGRvbmUgPCAzID8gJ2JhZCcgOiAnJ30iPjxkaXYgY2xhc3M9InItdmFsdWUiPiR7ZG9uZX0vNTwvZGl2PjxkaXYgY2xhc3M9InItbGFiZWwiPkRlY2lkZWQ8L2Rpdj48L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJlc3VsdC1jYXJkICR7Ry5jZW9Vc2VkID09PSAwID8gJ2dvb2QnIDogJ2JhZCd9Ij48ZGl2IGNsYXNzPSJyLXZhbHVlIj4ke0cuY2VvVXNlZH08L2Rpdj48ZGl2IGNsYXNzPSJyLWxhYmVsIj5DRU8gQ2FsbHM8L2Rpdj48L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJlc3VsdC1jYXJkIj48ZGl2IGNsYXNzPSJyLXZhbHVlIj4ke0cuY29uZmxpY3RDb3VudH08L2Rpdj48ZGl2IGNsYXNzPSJyLWxhYmVsIj5Db25mbGljdHM8L2Rpdj48L2Rpdj4KICAgICAgICAgICAgYDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLXNjcmVlbicpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgbGFzdEJ1ZGdldE11bHRpcGxpZXIgPSAxLjA7CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gcmVzZXRHYW1lKCkgeyAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3VsdC1zY3JlZW4nKS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsgCiAgICAgICAgICAgIHN0YXJ0R2FtZSgpOyAKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc2VuZFJlc3VsdFRvUGFyZW50KCkgewogICAgICAgICAgICAvLyBTZW5kIHJlc3VsdCB0byBwYXJlbnQgd2luZG93CiAgICAgICAgICAgIGlmICh3aW5kb3cucGFyZW50ICE9PSB3aW5kb3cpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjb21taXR0ZWVDaGFvc0RvbmUnLAogICAgICAgICAgICAgICAgICAgIGJ1ZGdldE11bHRpcGxpZXI6IGxhc3RCdWRnZXRNdWx0aXBsaWVyCiAgICAgICAgICAgICAgICB9LCAnKicpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGxvZyh0ZXh0LCB0eXBlID0gJycpIHsgCiAgICAgICAgICAgIGNvbnN0IGwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXZlbnQtbG9nJyk7CiAgICAgICAgICAgIGNvbnN0IGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgCiAgICAgICAgICAgIGkuY2xhc3NOYW1lID0gJ2V2ZW50LWl0ZW0gJyArIHR5cGU7IAogICAgICAgICAgICBpLnRleHRDb250ZW50ID0gdGV4dDsgCiAgICAgICAgICAgIGwuaW5zZXJ0QmVmb3JlKGksIGwuZmlyc3RDaGlsZCk7IAogICAgICAgICAgICB3aGlsZSAobC5jaGlsZHJlbi5sZW5ndGggPiAzKSBsLnJlbW92ZUNoaWxkKGwubGFzdENoaWxkKTsgCiAgICAgICAgfQogICAgPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPgo=";

    // ========== RESOURCE RUN MINI-GAME (EMBEDDED) ==========
    var RR_GAME_BASE64 = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCwgdXNlci1zY2FsYWJsZT1ubyI+CiAgICA8dGl0bGU+UmVzb3VyY2UgUnVuIC0gUiZEIE1pbmktR2FtZTwvdGl0bGU+CiAgICA8c3R5bGU+CiAgICAgICAgKiB7IG1hcmdpbjogMDsgcGFkZGluZzogMDsgYm94LXNpemluZzogYm9yZGVyLWJveDsgfQogICAgICAgIAogICAgICAgIGJvZHkgewogICAgICAgICAgICBmb250LWZhbWlseTogJ1NlZ29lIFVJJywgVGFob21hLCBHZW5ldmEsIFZlcmRhbmEsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICMxYTFhMmUgMCUsICMxNjIxM2UgMTAwJSk7CiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDEwMHZoOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgI2dhbWVDb250YWluZXIgewogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIHdpZHRoOiA5MDBweDsKICAgICAgICAgICAgaGVpZ2h0OiA2MDBweDsKICAgICAgICAgICAgbWF4LXdpZHRoOiAxMDB2dzsKICAgICAgICAgICAgbWF4LWhlaWdodDogMTAwdmg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgICNnYW1lQ2FudmFzIHsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDEwcHggNDBweCByZ2JhKDAsMCwwLDAuNCk7CiAgICAgICAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAjdG9wQmFyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDA7CiAgICAgICAgICAgIGxlZnQ6IDA7CiAgICAgICAgICAgIHJpZ2h0OiAwOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgICAgICAgICAgIHBhZGRpbmc6IDEwcHg7CiAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICB6LWluZGV4OiAxMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmNvcm5lci1wYW5lbCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC44NSk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDE1cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgI3NvcnRpZUJhbm5lciB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiA4cHg7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjMWEyNTJmIDAlLCAjMmMzZTUwIDEwMCUpOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCAjZjM5YzEyOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHggMzBweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIHotaW5kZXg6IDE1OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCAyMHB4IHJnYmEoMjQzLCAxNTYsIDE4LCAwLjQpOwogICAgICAgICAgICBtaW4td2lkdGg6IDM1MHB4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAjc29ydGllVGl0bGUgewogICAgICAgICAgICBmb250LXNpemU6IDIycHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA4MDA7CiAgICAgICAgICAgIGNvbG9yOiAjZjM5YzEyOwogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogM3B4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA2cHg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgICNzb3J0aWVUcmFuc2ZlciB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTVweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnRyYW5zZmVyLWZyb20geyBjb2xvcjogI2YzOWMxMjsgfQogICAgICAgIC50cmFuc2Zlci1hcnJvdyB7IGNvbG9yOiAjN2Y4YzhkOyBtYXJnaW46IDAgMTBweDsgfQogICAgICAgIC50cmFuc2Zlci10byB7IGNvbG9yOiAjMmVjYzcxOyB9CiAgICAgICAgCiAgICAgICAgI2hlYWx0aEJhciB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiA3NXB4OwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgd2lkdGg6IDIyMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDIwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC45KTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgYm9yZGVyOiAzcHggc29saWQgI2ZmZjsKICAgICAgICAgICAgei1pbmRleDogMjA7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwwLDAsMC41KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgI2hlYWx0aEZpbGwgewogICAgICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMyN2FlNjAsICMyZWNjNzEpOwogICAgICAgICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjJzOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAjaGVhbHRoTGFiZWwgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogNzVweDsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIHdpZHRoOiAyMjBweDsKICAgICAgICAgICAgaGVpZ2h0OiAyMHB4OwogICAgICAgICAgICBsaW5lLWhlaWdodDogMjBweDsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTBweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgei1pbmRleDogMjE7CiAgICAgICAgICAgIHRleHQtc2hhZG93OiAxcHggMXB4IDNweCBibGFjaywgMCAwIDVweCBibGFjazsKICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDFweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgI2Rpc3RhbmNlSW5kaWNhdG9yIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICBib3R0b206IDcwcHg7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuOCk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDIwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICAgICAgei1pbmRleDogMTA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgICN3YXJuaW5nSW5kaWNhdG9yIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDEwMHB4OwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyMzEsIDc2LCA2MCwgMC45KTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBwYWRkaW5nOiA2cHggMTZweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTVweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4OwogICAgICAgICAgICB6LWluZGV4OiAxNTsKICAgICAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgI21pbmltYXAgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMTBweDsKICAgICAgICAgICAgcmlnaHQ6IDEwcHg7CiAgICAgICAgICAgIHdpZHRoOiAyMDBweDsKICAgICAgICAgICAgaGVpZ2h0OiA1MHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuOCk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgIzQ0NDsKICAgICAgICAgICAgei1pbmRleDogMTA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgICNzb3VuZFRvZ2dsZSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm90dG9tOiAxMHB4OwogICAgICAgICAgICBsZWZ0OiAxMHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuNyk7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgIzU1NTsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDEycHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgZm9udC1zaXplOiAxNnB4OwogICAgICAgICAgICB6LWluZGV4OiAxMDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgI3NvdW5kVG9nZ2xlOmhvdmVyIHsgYm9yZGVyLWNvbG9yOiAjMzQ5OGRiOyB9CiAgICAgICAgCiAgICAgICAgI3N0YXJ0U2NyZWVuLCAjZW5kU2NyZWVuLCAjYnJpZWZpbmdTY3JlZW4sICNzb3J0aWVDb21wbGV0ZVNjcmVlbiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiAwOyBsZWZ0OiAwOyByaWdodDogMDsgYm90dG9tOiAwOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDAsMCwwLDAuOTUpOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIHotaW5kZXg6IDEwMDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAjZW5kU2NyZWVuLCAjYnJpZWZpbmdTY3JlZW4sICNzb3J0aWVDb21wbGV0ZVNjcmVlbiB7IGRpc3BsYXk6IG5vbmU7IH0KICAgICAgICAKICAgICAgICBoMSB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMi42ZW07CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICMzNDk4ZGIsICM5YjU5YjYpOwogICAgICAgICAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICBiYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGgyIHsgZm9udC1zaXplOiAxLjhlbTsgbWFyZ2luLWJvdHRvbTogMTVweDsgY29sb3I6ICMzNDk4ZGI7IH0KICAgICAgICAKICAgICAgICAuc3VidGl0bGUgeyBjb2xvcjogI2JkYzNjNzsgbWFyZ2luLWJvdHRvbTogMjVweDsgZm9udC1zaXplOiAxLjFlbTsgfQogICAgICAgIAogICAgICAgIC5pbnN0cnVjdGlvbnMgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LDAuMDgpOwogICAgICAgICAgICBwYWRkaW5nOiAyMHB4IDMwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDI1cHg7CiAgICAgICAgICAgIG1heC13aWR0aDogNDgwcHg7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OiAxLjY7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5pbnN0cnVjdGlvbnMgaDMgeyBjb2xvcjogIzM0OThkYjsgbWFyZ2luLWJvdHRvbTogOHB4OyBmb250LXNpemU6IDFlbTsgfQogICAgICAgIAogICAgICAgIC5jb250cm9sLWhpbnQgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDEwcHg7CiAgICAgICAgICAgIG1hcmdpbjogNXB4IDA7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMC45ZW07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5rZXkgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjMzQ5OGRiLCAjMjk4MGI5KTsKICAgICAgICAgICAgcGFkZGluZzogNHB4IDEwcHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICAgICAgIG1pbi13aWR0aDogNjBweDsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBmb250LXNpemU6IDAuODVlbTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnN0YXJ0LWJ0biB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICNmMzljMTIsICNlNjdlMjIpOwogICAgICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgcGFkZGluZzogMTZweCA1MHB4OwogICAgICAgICAgICBmb250LXNpemU6IDEuMmVtOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAzMHB4OwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjJzLCBib3gtc2hhZG93IDAuMnM7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiAycHg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5zdGFydC1idG46aG92ZXIgewogICAgICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDEuMDUpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDhweCAzMHB4IHJnYmEoMjQzLCAxNTYsIDE4LCAwLjUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAjYnJpZWZpbmdTY3JlZW4gewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCByZ2JhKDAsMCwwLDAuOTcpLCByZ2JhKDIwLDMwLDUwLDAuOTcpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLnNvcnRpZS1udW1iZXIgewogICAgICAgICAgICBmb250LXNpemU6IDNlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDgwMDsKICAgICAgICAgICAgY29sb3I6ICNmMzljMTI7CiAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiA1cHg7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMjQzLCAxNTYsIDE4LCAwLjUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWlzc2lvbi1kZXRhaWwgewogICAgICAgICAgICBmb250LXNpemU6IDEuM2VtOwogICAgICAgICAgICBtYXJnaW46IDIwcHggMDsKICAgICAgICAgICAgcGFkZGluZzogMTVweCAzMHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LDAuMSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICAgICAgICAgIGJvcmRlci1sZWZ0OiA0cHggc29saWQgI2YzOWMxMjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLm1pc3Npb24tcmVzb3VyY2UgewogICAgICAgICAgICBmb250LXNpemU6IDEuMWVtOwogICAgICAgICAgICBjb2xvcjogI2YzOWMxMjsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAubWlzc2lvbi1yb3V0ZSB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICBnYXA6IDE1cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMS4yZW07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5kaWZmaWN1bHR5LWluZm8gewogICAgICAgICAgICBtYXJnaW4tdG9wOiAyMHB4OwogICAgICAgICAgICBwYWRkaW5nOiAxMnB4IDIwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMjMxLCA3NiwgNjAsIDAuMik7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgyMzEsIDc2LCA2MCwgMC40KTsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjllbTsKICAgICAgICAgICAgY29sb3I6ICNlNzRjM2M7CiAgICAgICAgfQogICAgICAgIAogICAgICAgICNzb3J0aWVDb21wbGV0ZVNjcmVlbiB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoMzksIDE3NCwgOTYsIDAuOTUpLCByZ2JhKDQ2LCAyMDQsIDExMywgMC45KSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5jb21wbGV0ZS1jb250ZW50IHsKICAgICAgICAgICAgYW5pbWF0aW9uOiBwb3BJbiAwLjRzIGVhc2Utb3V0OwogICAgICAgIH0KICAgICAgICAKICAgICAgICBAa2V5ZnJhbWVzIHBvcEluIHsKICAgICAgICAgICAgZnJvbSB7IHRyYW5zZm9ybTogc2NhbGUoMC41KTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICB0byB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IG9wYWNpdHk6IDE7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmNvbXBsZXRlLWNoZWNrIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxMDBweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMTBweDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmNvbXBsZXRlLXRpdGxlIHsKICAgICAgICAgICAgZm9udC1zaXplOiAyLjVlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDgwMDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDJweCAycHggNHB4IHJnYmEoMCwwLDAsMC4zKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLmNvbXBsZXRlLXN0YXRzIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjJlbTsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgICNmaW5hbFNjb3JlIHsKICAgICAgICAgICAgZm9udC1zaXplOiAzZW07CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICMzNDk4ZGIsICMyZWNjNzEpOwogICAgICAgICAgICAtd2Via2l0LWJhY2tncm91bmQtY2xpcDogdGV4dDsKICAgICAgICAgICAgLXdlYmtpdC10ZXh0LWZpbGwtY29sb3I6IHRyYW5zcGFyZW50OwogICAgICAgICAgICBiYWNrZ3JvdW5kLWNsaXA6IHRleHQ7CiAgICAgICAgICAgIG1hcmdpbjogOHB4IDA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC5zdGF0cyB7IGRpc3BsYXk6IGZsZXg7IGdhcDogMjVweDsgbWFyZ2luLWJvdHRvbTogMjBweDsgfQogICAgICAgIC5zdGF0IHsgdGV4dC1hbGlnbjogY2VudGVyOyB9CiAgICAgICAgLnN0YXQtdmFsdWUgeyBmb250LXNpemU6IDEuNmVtOyBmb250LXdlaWdodDogNzAwOyBjb2xvcjogIzJlY2M3MTsgfQogICAgICAgIC5zdGF0LWxhYmVsIHsgY29sb3I6ICM5NWE1YTY7IGZvbnQtc2l6ZTogMC44ZW07IG1hcmdpbi10b3A6IDJweDsgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgaWQ9ImdhbWVDb250YWluZXIiPgogICAgICAgIDxjYW52YXMgaWQ9ImdhbWVDYW52YXMiIHdpZHRoPSI5MDAiIGhlaWdodD0iNjAwIj48L2NhbnZhcz4KICAgICAgICAKICAgICAgICA8ZGl2IGlkPSJ0b3BCYXIiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb3JuZXItcGFuZWwiPuKPse+4jyA8c3BhbiBpZD0idGltZXIiPjYwPC9zcGFuPnM8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29ybmVyLXBhbmVsIj7wn46vIDxzcGFuIGlkPSJzY29yZSI+MDwvc3Bhbj48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8ZGl2IGlkPSJzb3J0aWVCYW5uZXIiPgogICAgICAgICAgICA8ZGl2IGlkPSJzb3J0aWVUaXRsZSI+U09SVElFIDE8L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0ic29ydGllVHJhbnNmZXIiPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRyYW5zZmVyLWZyb20iPvCfkrAgQnVkZ2V0IEFwcHJvdmFsPC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRyYW5zZmVyLWFycm93Ij7inpw8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idHJhbnNmZXItdG8iPkFscGhhIFRlYW08L3NwYW4+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgaWQ9ImhlYWx0aEJhciI+PGRpdiBpZD0iaGVhbHRoRmlsbCI+PC9kaXY+PC9kaXY+CiAgICAgICAgPGRpdiBpZD0iaGVhbHRoTGFiZWwiPkhVTEwgSU5URUdSSVRZPC9kaXY+CiAgICAgICAgCiAgICAgICAgPGRpdiBpZD0iZGlzdGFuY2VJbmRpY2F0b3IiPvCfk40gPHNwYW4gaWQ9ImRpc3RhbmNlVGV4dCI+NTAwbSB0byB0YXJnZXQ8L3NwYW4+PC9kaXY+CiAgICAgICAgCiAgICAgICAgPGRpdiBpZD0id2FybmluZ0luZGljYXRvciI+4pqg77iPIDxzcGFuIGlkPSJ3YXJuaW5nVGV4dCI+Uml2YWwgYXBwcm9hY2hpbmchPC9zcGFuPjwvZGl2PgogICAgICAgIAogICAgICAgIDxjYW52YXMgaWQ9Im1pbmltYXAiIHdpZHRoPSIyMDAiIGhlaWdodD0iNTAiPjwvY2FudmFzPgogICAgICAgIAogICAgICAgIDxidXR0b24gaWQ9InNvdW5kVG9nZ2xlIiBvbmNsaWNrPSJ0b2dnbGVTb3VuZCgpIj7wn5SKPC9idXR0b24+CiAgICAgICAgCiAgICAgICAgPGRpdiBpZD0ic3RhcnRTY3JlZW4iPgogICAgICAgICAgICA8aDE+8J+agSBSZXNvdXJjZSBSdW48L2gxPgogICAgICAgICAgICA8cCBjbGFzcz0ic3VidGl0bGUiPlImRCBSZXNvdXJjZSBEZWxpdmVyeSBTZXJ2aWNlPC9wPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBjbGFzcz0iaW5zdHJ1Y3Rpb25zIj4KICAgICAgICAgICAgICAgIDxoMz7wn46vIE1pc3Npb246PC9oMz4KICAgICAgICAgICAgICAgIDxwPkNvbXBsZXRlIDUgZGVsaXZlcnkgc29ydGllcyEgQ29sbGVjdCByZXNvdXJjZXMgZnJvbSBkZXBhcnRtZW50IGJ1aWxkaW5ncywgZGVsaXZlciB0byBSJkQgdGVhbXMuPC9wPgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi10b3A6IDEycHg7Ij7wn46uIENvbnRyb2xzOjwvaDM+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9sLWhpbnQiPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJrZXkiPuKGkSBXIFNQQUNFPC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDxzcGFuPlRocnVzdCB1cDwvc3Bhbj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbC1oaW50Ij4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ia2V5Ij7ihpAg4oaSIEEgRDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8c3Bhbj5GbHkgbGVmdC9yaWdodDwvc3Bhbj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICA8aDMgc3R5bGU9Im1hcmdpbi10b3A6IDEycHg7Ij7imqDvuI8gV2F0Y2ggT3V0OjwvaDM+CiAgICAgICAgICAgICAgICA8cD5CdWlsZGluZ3MgZGFtYWdlIHlvdXIgaGVsaWNvcHRlciEgTGF0ZXIgc29ydGllcyBoYXZlIHdlYXRoZXIgYW5kIGEgcml2YWwhPC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InN0YXJ0LWJ0biIgb25jbGljaz0ic3RhcnRUdXRvcmlhbCgpIiBzdHlsZT0iYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzM0OThkYiwgIzI5ODBiOSk7IG1hcmdpbi1ib3R0b206IDEwcHg7Ij7wn5OWIFR1dG9yaWFsIChMZWFybiB0byBGbHkpPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InN0YXJ0LWJ0biIgb25jbGljaz0ic2hvd0JyaWVmaW5nKCkiPvCfmoEgU3RhcnQgR2FtZTwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgaWQ9ImJyaWVmaW5nU2NyZWVuIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0ic29ydGllLW51bWJlciI+U09SVElFIDxzcGFuIGlkPSJicmllZmluZ1NvcnRpZU51bSI+MTwvc3Bhbj48L2Rpdj4KICAgICAgICAgICAgPGgyPk1pc3Npb24gQnJpZWZpbmc8L2gyPgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWlzc2lvbi1kZXRhaWwiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibWlzc2lvbi1yZXNvdXJjZSIgaWQ9Im1pc3Npb25SZXNvdXJjZSI+8J+SsCBCdWRnZXQgQXBwcm92YWw8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1pc3Npb24tcm91dGUiPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJjb2xvcjojZjM5YzEyIj5IUSBSb29mdG9wPC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJjb2xvcjojNjY2Ij7inpw8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImNvbG9yOiMyZWNjNzEiIGlkPSJtaXNzaW9uVGFyZ2V0Ij5BbHBoYSBUZWFtPC9zcGFuPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBjbGFzcz0iZGlmZmljdWx0eS1pbmZvIiBpZD0iZGlmZmljdWx0eUluZm8iPgogICAgICAgICAgICAgICAgRGlzdGFuY2U6IDQwMG0g4oCiIE5vIGhhemFyZHMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8cCBzdHlsZT0ibWFyZ2luLXRvcDogMTVweDsgY29sb3I6ICMzNDk4ZGI7Ij7ij7HvuI8gVGltZSBMaW1pdDogPHNwYW4gaWQ9ImJyaWVmaW5nVGltZSI+NjA8L3NwYW4+czwvcD4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InN0YXJ0LWJ0biIgb25jbGljaz0ic3RhcnRTb3J0aWUoKSIgc3R5bGU9Im1hcmdpbi10b3A6IDIwcHg7Ij7wn5qBIExhdW5jaCBTb3J0aWUhPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPGRpdiBpZD0ic29ydGllQ29tcGxldGVTY3JlZW4iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb21wbGV0ZS1jb250ZW50Ij4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbXBsZXRlLWNoZWNrIj7inJM8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbXBsZXRlLXRpdGxlIj5TT1JUSUUgPHNwYW4gaWQ9ImNvbXBsZXRlZFNvcnRpZU51bSI+MTwvc3Bhbj4gQ09NUExFVEUhPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb21wbGV0ZS1zdGF0cyI+CiAgICAgICAgICAgICAgICAgICAgPGRpdj5UaW1lIEJvbnVzOiArPHNwYW4gaWQ9InNvcnRpZVRpbWVCb251cyI+MDwvc3Bhbj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2PlRvdGFsIFNjb3JlOiA8c3BhbiBpZD0ic29ydGllU2NvcmUiPjA8L3NwYW4+PC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPGRpdiBpZD0iZW5kU2NyZWVuIj4KICAgICAgICAgICAgPGgxIGlkPSJlbmRUaXRsZSI+8J+SpSBDcmFzaGVkITwvaDE+CiAgICAgICAgICAgIDxkaXYgaWQ9ImZpbmFsU2NvcmUiPjA8L2Rpdj4KICAgICAgICAgICAgPHAgY2xhc3M9InN1YnRpdGxlIj5Ub3RhbCBTY29yZTwvcD4KICAgICAgICAgICAgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXRzIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQtdmFsdWUiIGlkPSJzb3J0aWVzQ29tcGxldGVTdGF0Ij4wPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ic3RhdC1sYWJlbCI+U29ydGllczwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0Ij4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0LXZhbHVlIiBpZD0iZGlzdGFuY2VTdGF0Ij4wbTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQtbGFiZWwiPkRpc3RhbmNlIEZsb3duPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJzdGFydC1idG4iIG9uY2xpY2s9InJlc2V0R2FtZSgpIj7wn5SEIFRyeSBBZ2FpbjwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgaWQ9InR1dG9yaWFsSGludCIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiA1MCU7IGxlZnQ6IDUwJTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7IGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC44NSk7IHBhZGRpbmc6IDIwcHggMzBweDsgYm9yZGVyLXJhZGl1czogMTVweDsgYm9yZGVyOiAzcHggc29saWQgIzM0OThkYjsgdGV4dC1hbGlnbjogY2VudGVyOyB6LWluZGV4OiAxMDA7IG1heC13aWR0aDogMzUwcHg7Ij4KICAgICAgICAgICAgPGRpdiBpZD0idHV0b3JpYWxUZXh0IiBzdHlsZT0iY29sb3I6IHdoaXRlOyBmb250LXNpemU6IDE4cHg7IG1hcmdpbi1ib3R0b206IDEwcHg7Ij48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0idHV0b3JpYWxTdWJ0ZXh0IiBzdHlsZT0iY29sb3I6ICNiZGMzYzc7IGZvbnQtc2l6ZTogMTRweDsiPjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgaWQ9InR1dG9yaWFsQmFubmVyIiBzdHlsZT0iZGlzcGxheTogbm9uZTsgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDEwcHg7IGxlZnQ6IDUwJTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOyBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjMzQ5OGRiLCAjMjk4MGI5KTsgcGFkZGluZzogOHB4IDI1cHg7IGJvcmRlci1yYWRpdXM6IDIwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsgei1pbmRleDogNTA7IGJvcmRlcjogMnB4IHNvbGlkIHJnYmEoMjU1LDI1NSwyNTUsMC4zKTsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0iY29sb3I6IHdoaXRlOyBmb250LXNpemU6IDE2cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyI+8J+TliBUVVRPUklBTCBNT0RFPC9zcGFuPgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgaWQ9InR1dG9yaWFsQ29udHJvbHMiIHN0eWxlPSJkaXNwbGF5OiBub25lOyBwb3NpdGlvbjogYWJzb2x1dGU7IGJvdHRvbTogODBweDsgbGVmdDogNTAlOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7IGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC44KTsgcGFkZGluZzogMTVweCAyNXB4OyBib3JkZXItcmFkaXVzOiAxMHB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7IHotaW5kZXg6IDEwMDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjogIzM0OThkYjsgZm9udC1zaXplOiAxNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7Ij5DT05UUk9MUzwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjogd2hpdGU7IGZvbnQtc2l6ZTogMTZweDsiPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImJhY2tncm91bmQ6ICMyYzNlNTA7IHBhZGRpbmc6IDVweCAxMnB4OyBib3JkZXItcmFkaXVzOiA1cHg7IG1hcmdpbjogMCA1cHg7Ij7ihpEgVyBTUEFDRTwvc3Bhbj4gVGhydXN0CiAgICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWFyZ2luOiAwIDE1cHg7Ij58PC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9ImJhY2tncm91bmQ6ICMyYzNlNTA7IHBhZGRpbmc6IDVweCAxMnB4OyBib3JkZXItcmFkaXVzOiA1cHg7IG1hcmdpbjogMCA1cHg7Ij7ihpAg4oaSPC9zcGFuPiBNb3ZlCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxidXR0b24gaWQ9InNraXBUdXRvcmlhbCIgb25jbGljaz0ic2tpcFR1dG9yaWFsKCkiIHN0eWxlPSJkaXNwbGF5OiBub25lOyBwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogMTBweDsgcmlnaHQ6IDEwcHg7IGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC42KTsgY29sb3I6ICNiZGMzYzc7IGJvcmRlcjogMXB4IHNvbGlkICM3ZjhjOGQ7IHBhZGRpbmc6IDhweCAxNXB4OyBib3JkZXItcmFkaXVzOiA1cHg7IGN1cnNvcjogcG9pbnRlcjsgei1pbmRleDogMTAwOyBmb250LXNpemU6IDEycHg7Ij5Ta2lwIFR1dG9yaWFsIOKenDwvYnV0dG9uPgogICAgPC9kaXY+CiAgICAKICAgIDxzY3JpcHQ+CiAgICAgICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWVDYW52YXMnKTsKICAgICAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICBjb25zdCBtaW5pbWFwQ2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAnKTsKICAgICAgICBjb25zdCBtaW5pbWFwQ3R4ID0gbWluaW1hcENhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgIAogICAgICAgIC8vIEF1ZGlvIGNvbnRleHQKICAgICAgICBsZXQgYXVkaW9DdHggPSBudWxsOwogICAgICAgIGxldCBzb3VuZEVuYWJsZWQgPSB0cnVlOwogICAgICAgIGxldCByb3Rvck9zYyA9IG51bGw7CiAgICAgICAgbGV0IHJvdG9yR2FpbiA9IG51bGw7CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gaW5pdEF1ZGlvKCkgewogICAgICAgICAgICBpZiAoYXVkaW9DdHgpIHJldHVybjsKICAgICAgICAgICAgYXVkaW9DdHggPSBuZXcgKHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dCkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJvdG9yIHNvdW5kIC0gbG93IGZyZXF1ZW5jeSBvc2NpbGxhdGlvbgogICAgICAgICAgICByb3Rvck9zYyA9IGF1ZGlvQ3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTsKICAgICAgICAgICAgcm90b3JHYWluID0gYXVkaW9DdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCByb3RvckZpbHRlciA9IGF1ZGlvQ3R4LmNyZWF0ZUJpcXVhZEZpbHRlcigpOwogICAgICAgICAgICAKICAgICAgICAgICAgcm90b3JPc2MudHlwZSA9ICdzYXd0b290aCc7CiAgICAgICAgICAgIHJvdG9yT3NjLmZyZXF1ZW5jeS52YWx1ZSA9IDgwOwogICAgICAgICAgICByb3RvckZpbHRlci50eXBlID0gJ2xvd3Bhc3MnOwogICAgICAgICAgICByb3RvckZpbHRlci5mcmVxdWVuY3kudmFsdWUgPSAyMDA7CiAgICAgICAgICAgIHJvdG9yR2Fpbi5nYWluLnZhbHVlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJvdG9yT3NjLmNvbm5lY3Qocm90b3JGaWx0ZXIpOwogICAgICAgICAgICByb3RvckZpbHRlci5jb25uZWN0KHJvdG9yR2Fpbik7CiAgICAgICAgICAgIHJvdG9yR2Fpbi5jb25uZWN0KGF1ZGlvQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgcm90b3JPc2Muc3RhcnQoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc2V0Um90b3JTb3VuZChpbnRlbnNpdHkpIHsKICAgICAgICAgICAgaWYgKCFhdWRpb0N0eCB8fCAhc291bmRFbmFibGVkKSByZXR1cm47CiAgICAgICAgICAgIHJvdG9yR2Fpbi5nYWluLnNldFRhcmdldEF0VGltZShpbnRlbnNpdHkgKiAwLjE1LCBhdWRpb0N0eC5jdXJyZW50VGltZSwgMC4xKTsKICAgICAgICAgICAgcm90b3JPc2MuZnJlcXVlbmN5LnNldFRhcmdldEF0VGltZSg2MCArIGludGVuc2l0eSAqIDQwLCBhdWRpb0N0eC5jdXJyZW50VGltZSwgMC4xKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gcGxheVNvdW5kKHR5cGUpIHsKICAgICAgICAgICAgaWYgKCFhdWRpb0N0eCB8fCAhc291bmRFbmFibGVkKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBvc2MgPSBhdWRpb0N0eC5jcmVhdGVPc2NpbGxhdG9yKCk7CiAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBhdWRpb0N0eC5jcmVhdGVHYWluKCk7CiAgICAgICAgICAgIG9zYy5jb25uZWN0KGdhaW4pOwogICAgICAgICAgICBnYWluLmNvbm5lY3QoYXVkaW9DdHguZGVzdGluYXRpb24pOwogICAgICAgICAgICAKICAgICAgICAgICAgc3dpdGNoKHR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ2J1bXAnOgogICAgICAgICAgICAgICAgICAgIG9zYy50eXBlID0gJ3RyaWFuZ2xlJzsKICAgICAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LnZhbHVlID0gMTUwOwogICAgICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLjMsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgICBnYWluLmdhaW4uZXhwb25lbnRpYWxEZWNheVRvID0gMC4wMTsKICAgICAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKDAuMDEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lLCAwLjA1KTsKICAgICAgICAgICAgICAgICAgICBvc2Muc3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICBvc2Muc3RvcChhdWRpb0N0eC5jdXJyZW50VGltZSArIDAuMSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdjcmFzaCc6CiAgICAgICAgICAgICAgICAgICAgb3NjLnR5cGUgPSAnc2F3dG9vdGgnOwogICAgICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kudmFsdWUgPSAxMDA7CiAgICAgICAgICAgICAgICAgICAgZ2Fpbi5nYWluLnNldFZhbHVlQXRUaW1lKDAuNCwgYXVkaW9DdHguY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5zZXRUYXJnZXRBdFRpbWUoMC4wMSwgYXVkaW9DdHguY3VycmVudFRpbWUsIDAuMik7CiAgICAgICAgICAgICAgICAgICAgb3NjLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgb3NjLnN0b3AoYXVkaW9DdHguY3VycmVudFRpbWUgKyAwLjMpOwogICAgICAgICAgICAgICAgICAgIC8vIEFkZCBub2lzZSBidXJzdAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vaXNlID0gYXVkaW9DdHguY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9pc2VCdWZmZXIgPSBhdWRpb0N0eC5jcmVhdGVCdWZmZXIoMSwgYXVkaW9DdHguc2FtcGxlUmF0ZSAqIDAuMiwgYXVkaW9DdHguc2FtcGxlUmF0ZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IG5vaXNlQnVmZmVyLmdldENoYW5uZWxEYXRhKDApOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgZGF0YVtpXSA9IE1hdGgucmFuZG9tKCkgKiAyIC0gMTsKICAgICAgICAgICAgICAgICAgICBub2lzZS5idWZmZXIgPSBub2lzZUJ1ZmZlcjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBub2lzZUdhaW4gPSBhdWRpb0N0eC5jcmVhdGVHYWluKCk7CiAgICAgICAgICAgICAgICAgICAgbm9pc2VHYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUoMC4zLCBhdWRpb0N0eC5jdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgICAgICAgbm9pc2VHYWluLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKDAuMDEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lLCAwLjEpOwogICAgICAgICAgICAgICAgICAgIG5vaXNlLmNvbm5lY3Qobm9pc2VHYWluKTsKICAgICAgICAgICAgICAgICAgICBub2lzZUdhaW4uY29ubmVjdChhdWRpb0N0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgbm9pc2Uuc3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ3BpY2t1cCc6CiAgICAgICAgICAgICAgICAgICAgb3NjLnR5cGUgPSAnc2luZSc7CiAgICAgICAgICAgICAgICAgICAgb3NjLmZyZXF1ZW5jeS5zZXRWYWx1ZUF0VGltZSg0MDAsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LnNldFRhcmdldEF0VGltZSg2MDAsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lLCAwLjEpOwogICAgICAgICAgICAgICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLjIsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKDAuMDEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lLCAwLjE1KTsKICAgICAgICAgICAgICAgICAgICBvc2Muc3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICBvc2Muc3RvcChhdWRpb0N0eC5jdXJyZW50VGltZSArIDAuMik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdkZWxpdmVyJzoKICAgICAgICAgICAgICAgICAgICBvc2MudHlwZSA9ICdzaW5lJzsKICAgICAgICAgICAgICAgICAgICBvc2MuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKDUwMCwgYXVkaW9DdHguY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VGFyZ2V0QXRUaW1lKDgwMCwgYXVkaW9DdHguY3VycmVudFRpbWUsIDAuMSk7CiAgICAgICAgICAgICAgICAgICAgZ2Fpbi5nYWluLnNldFZhbHVlQXRUaW1lKDAuMjUsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgICBnYWluLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKDAuMDEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIG9zYy5zdGFydCgpOwogICAgICAgICAgICAgICAgICAgIG9zYy5zdG9wKGF1ZGlvQ3R4LmN1cnJlbnRUaW1lICsgMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgLy8gU2Vjb25kIHRvbmUKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhdWRpb0N0eCB8fCAhc291bmRFbmFibGVkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9zYzIgPSBhdWRpb0N0eC5jcmVhdGVPc2NpbGxhdG9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdhaW4yID0gYXVkaW9DdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICAgICAgICAgICAgICBvc2MyLmNvbm5lY3QoZ2FpbjIpOwogICAgICAgICAgICAgICAgICAgICAgICBnYWluMi5jb25uZWN0KGF1ZGlvQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgb3NjMi50eXBlID0gJ3NpbmUnOwogICAgICAgICAgICAgICAgICAgICAgICBvc2MyLmZyZXF1ZW5jeS52YWx1ZSA9IDEwMDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhaW4yLmdhaW4uc2V0VmFsdWVBdFRpbWUoMC4yLCBhdWRpb0N0eC5jdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhaW4yLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKDAuMDEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lLCAwLjE1KTsKICAgICAgICAgICAgICAgICAgICAgICAgb3NjMi5zdGFydCgpOwogICAgICAgICAgICAgICAgICAgICAgICBvc2MyLnN0b3AoYXVkaW9DdHguY3VycmVudFRpbWUgKyAwLjIpOwogICAgICAgICAgICAgICAgICAgIH0sIDE1MCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICd3aW5kJzoKICAgICAgICAgICAgICAgICAgICAvLyBXaG9vc2hpbmcgd2luZCBzb3VuZAogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdpbmROb2lzZSA9IGF1ZGlvQ3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdpbmRCdWZmZXIgPSBhdWRpb0N0eC5jcmVhdGVCdWZmZXIoMSwgYXVkaW9DdHguc2FtcGxlUmF0ZSAqIDAuMywgYXVkaW9DdHguc2FtcGxlUmF0ZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2luZERhdGEgPSB3aW5kQnVmZmVyLmdldENoYW5uZWxEYXRhKDApOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2luZERhdGEubGVuZ3RoOyBpKyspIHdpbmREYXRhW2ldID0gKE1hdGgucmFuZG9tKCkgKiAyIC0gMSkgKiAwLjM7CiAgICAgICAgICAgICAgICAgICAgd2luZE5vaXNlLmJ1ZmZlciA9IHdpbmRCdWZmZXI7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2luZEZpbHRlciA9IGF1ZGlvQ3R4LmNyZWF0ZUJpcXVhZEZpbHRlcigpOwogICAgICAgICAgICAgICAgICAgIHdpbmRGaWx0ZXIudHlwZSA9ICdiYW5kcGFzcyc7CiAgICAgICAgICAgICAgICAgICAgd2luZEZpbHRlci5mcmVxdWVuY3kudmFsdWUgPSA0MDA7CiAgICAgICAgICAgICAgICAgICAgd2luZEZpbHRlci5RLnZhbHVlID0gMC41OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdpbmRHYWluID0gYXVkaW9DdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICAgICAgICAgIHdpbmRHYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUoMC4xNSwgYXVkaW9DdHguY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICAgIHdpbmRHYWluLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKDAuMDEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lLCAwLjIpOwogICAgICAgICAgICAgICAgICAgIHdpbmROb2lzZS5jb25uZWN0KHdpbmRGaWx0ZXIpOwogICAgICAgICAgICAgICAgICAgIHdpbmRGaWx0ZXIuY29ubmVjdCh3aW5kR2Fpbik7CiAgICAgICAgICAgICAgICAgICAgd2luZEdhaW4uY29ubmVjdChhdWRpb0N0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICAgICAgd2luZE5vaXNlLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlU291bmQoKSB7CiAgICAgICAgICAgIHNvdW5kRW5hYmxlZCA9ICFzb3VuZEVuYWJsZWQ7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3VuZFRvZ2dsZScpLnRleHRDb250ZW50ID0gc291bmRFbmFibGVkID8gJ/CflIonIDogJ/CflIcnOwogICAgICAgICAgICBpZiAoIXNvdW5kRW5hYmxlZCAmJiByb3RvckdhaW4pIHsKICAgICAgICAgICAgICAgIHJvdG9yR2Fpbi5nYWluLnNldFRhcmdldEF0VGltZSgwLCBhdWRpb0N0eC5jdXJyZW50VGltZSwgMC4xKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBQaHlzaWNzIC0gc2xpZ2h0bHkgZmFzdGVyIGZvciBsb25nZXIgZGlzdGFuY2VzCiAgICAgICAgY29uc3QgR1JBVklUWSA9IDAuMTA7CiAgICAgICAgY29uc3QgVEhSVVNUID0gLTAuMzI7CiAgICAgICAgY29uc3QgSE9SSVpPTlRBTF9BQ0NFTCA9IDAuMjQ7CiAgICAgICAgY29uc3QgTUFYX1NQRUVEX1ggPSA2OwogICAgICAgIGNvbnN0IE1BWF9TUEVFRF9ZID0gNS41OwogICAgICAgIGNvbnN0IEFJUl9SRVNJU1RBTkNFID0gMC45ODg7CiAgICAgICAgY29uc3QgVElMVF9TUEVFRCA9IDAuMTA7CiAgICAgICAgY29uc3QgQk9VTkNFX0ZBQ1RPUiA9IDAuMzA7CiAgICAgICAgCiAgICAgICAgY29uc3QgR1JPVU5EX1kgPSA1NDA7CiAgICAgICAgCiAgICAgICAgLy8gRGVwYXJ0bWVudHMgLSBlYWNoIGhhcyB0aGVpciBvd24gYnVpbGRpbmcKICAgICAgICBjb25zdCBERVBBUlRNRU5UUyA9IFsKICAgICAgICAgICAgeyBrZXk6ICdmaW5hbmNlJywgbmFtZTogJ0ZpbmFuY2UnLCBjb2xvcjogJyMyN2FlNjAnLCBpY29uOiAn8J+SsCcsIHJlc291cmNlOiAnQnVkZ2V0IEFwcHJvdmFsJyB9LAogICAgICAgICAgICB7IGtleTogJ21hcmtldGluZycsIG5hbWU6ICdNYXJrZXRpbmcnLCBjb2xvcjogJyNlNzRjM2MnLCBpY29uOiAn8J+TiicsIHJlc291cmNlOiAnTWFya2V0IEFuYWx5c2lzJyB9LAogICAgICAgICAgICB7IGtleTogJ2xlZ2FsJywgbmFtZTogJ0xlZ2FsJywgY29sb3I6ICcjOGU0NGFkJywgaWNvbjogJ/Cfk5wnLCByZXNvdXJjZTogJ0lQIENsZWFyYW5jZScgfSwKICAgICAgICAgICAgeyBrZXk6ICdlbmdpbmVlcmluZycsIG5hbWU6ICdFbmdpbmVlcmluZycsIGNvbG9yOiAnIzM0OThkYicsIGljb246ICfwn5SnJywgcmVzb3VyY2U6ICdUZWNoIFNwZWNzJyB9LAogICAgICAgICAgICB7IGtleTogJ2hyJywgbmFtZTogJ0hSJywgY29sb3I6ICcjMWFiYzljJywgaWNvbjogJ/CfkaUnLCByZXNvdXJjZTogJ1RlYW0gUm9zdGVyJyB9LAogICAgICAgICAgICB7IGtleTogJ29wcycsIG5hbWU6ICdPcGVyYXRpb25zJywgY29sb3I6ICcjZTY3ZTIyJywgaWNvbjogJ+KaoScsIHJlc291cmNlOiAnTG9naXN0aWNzIFBsYW4nIH0sCiAgICAgICAgICAgIHsga2V5OiAncmVzZWFyY2gnLCBuYW1lOiAnUiZEIExhYicsIGNvbG9yOiAnIzliNTliNicsIGljb246ICfwn5SsJywgcmVzb3VyY2U6ICdUZWNoIFJlcG9ydCcgfSwKICAgICAgICAgICAgeyBrZXk6ICdzdHJhdGVneScsIG5hbWU6ICdTdHJhdGVneScsIGNvbG9yOiAnIzM0NDk1ZScsIGljb246ICfwn5OIJywgcmVzb3VyY2U6ICdNYXJrZXQgSW50ZWwnIH0KICAgICAgICBdOwogICAgICAgIAogICAgICAgIC8vIFRlYW1zCiAgICAgICAgY29uc3QgVEVBTV9OQU1FUyA9IFsnQWxwaGEnLCAnQmV0YScsICdHYW1tYScsICdEZWx0YScsICdFY2hvJywgJ1pldGEnLCAnT21lZ2EnLCAnTm92YSddOwogICAgICAgIGNvbnN0IFRFQU1fQ09MT1JTID0gWycjZTc0YzNjJywgJyM5YjU5YjYnLCAnIzJlY2M3MScsICcjZjM5YzEyJywgJyMzNDk4ZGInLCAnIzFhYmM5YycsICcjZTkxZTYzJywgJyMwMGJjZDQnXTsKICAgICAgICAKICAgICAgICBsZXQgRyA9IHsKICAgICAgICAgICAgcnVubmluZzogZmFsc2UsCiAgICAgICAgICAgIHR1dG9yaWFsTW9kZTogZmFsc2UsCiAgICAgICAgICAgIHR1dG9yaWFsU3RlcDogMCwKICAgICAgICAgICAgc29ydGllTnVtOiAxLAogICAgICAgICAgICB0b3RhbFNjb3JlOiAwLAogICAgICAgICAgICB0b3RhbERpc3RhbmNlOiAwLAogICAgICAgICAgICB0aW1lOiA2MCwKICAgICAgICAgICAgd2VhdGhlcjogJ2NsZWFyJywKICAgICAgICAgICAgd29ybGRXaWR0aDogMTYwMCwKICAgICAgICAgICAgY2FtZXJhWDogMCwKICAgICAgICAgICAgaGVsaWNvcHRlcjogbnVsbCwKICAgICAgICAgICAgaG9tZUJhc2U6IHsgeDogMTIwLCB3aWR0aDogODAgfSwKICAgICAgICAgICAgZGVwYXJ0bWVudEJ1aWxkaW5nczogW10sCiAgICAgICAgICAgIHRlYW06IG51bGwsCiAgICAgICAgICAgIGN1cnJlbnREZXB0OiBudWxsLAogICAgICAgICAgICBvYnN0YWNsZXM6IFtdLAogICAgICAgICAgICBtZWV0aW5nczogW10sCiAgICAgICAgICAgIGVtYWlsU3Rvcm1zOiBbXSwKICAgICAgICAgICAgcml2YWw6IG51bGwsCiAgICAgICAgICAgIHJhaW5kcm9wczogW10sCiAgICAgICAgICAgIHBhcnRpY2xlczogW10sCiAgICAgICAgICAgIGNsb3VkczogW10sCiAgICAgICAgICAgIHBoYXNlOiAncGlja3VwJyAvLyAncGlja3VwJyBvciAnZGVsaXZlcicKICAgICAgICB9OwogICAgICAgIAogICAgICAgIGNvbnN0IGtleXMgPSB7IGxlZnQ6IGZhbHNlLCByaWdodDogZmFsc2UsIHVwOiBmYWxzZSB9OwogICAgICAgIAogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBlID0+IHsKICAgICAgICAgICAgaWYgKFsnQXJyb3dMZWZ0JywgJ0tleUEnXS5pbmNsdWRlcyhlLmNvZGUpKSBrZXlzLmxlZnQgPSB0cnVlOwogICAgICAgICAgICBpZiAoWydBcnJvd1JpZ2h0JywgJ0tleUQnXS5pbmNsdWRlcyhlLmNvZGUpKSBrZXlzLnJpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKFsnQXJyb3dVcCcsICdLZXlXJywgJ1NwYWNlJ10uaW5jbHVkZXMoZS5jb2RlKSkgeyBlLnByZXZlbnREZWZhdWx0KCk7IGtleXMudXAgPSB0cnVlOyB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBlID0+IHsKICAgICAgICAgICAgaWYgKFsnQXJyb3dMZWZ0JywgJ0tleUEnXS5pbmNsdWRlcyhlLmNvZGUpKSBrZXlzLmxlZnQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKFsnQXJyb3dSaWdodCcsICdLZXlEJ10uaW5jbHVkZXMoZS5jb2RlKSkga2V5cy5yaWdodCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoWydBcnJvd1VwJywgJ0tleVcnLCAnU3BhY2UnXS5pbmNsdWRlcyhlLmNvZGUpKSBrZXlzLnVwID0gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBlID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBpbml0QXVkaW8oKTsKICAgICAgICAgICAga2V5cy51cCA9IHRydWU7CiAgICAgICAgICAgIGNvbnN0IHJlY3QgPSBjYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICAgIGNvbnN0IHggPSBlLnRvdWNoZXNbMF0uY2xpZW50WCAtIHJlY3QubGVmdDsKICAgICAgICAgICAgaWYgKHggPCByZWN0LndpZHRoIC8gMykga2V5cy5sZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgZWxzZSBpZiAoeCA+IHJlY3Qud2lkdGggKiAyIC8gMykga2V5cy5yaWdodCA9IHRydWU7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKCkgPT4geyBrZXlzLnVwID0ga2V5cy5sZWZ0ID0ga2V5cy5yaWdodCA9IGZhbHNlOyB9KTsKICAgICAgICAKICAgICAgICBmdW5jdGlvbiBjcmVhdGVIZWxpY29wdGVyKHgsIHkpIHsKICAgICAgICAgICAgLy8gRmFjZSByaWdodCBpZiBzdGFydGluZyBvbiBsZWZ0IChuZWVkIHRvIGdvIHJpZ2h0KSwgZmFjZSBsZWZ0IGlmIHN0YXJ0aW5nIG9uIHJpZ2h0CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0RmFjaW5nID0geCA8IDUwMCA/IC0xIDogMTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHgsIHksIHZ4OiAwLCB2eTogMCwKICAgICAgICAgICAgICAgIHRpbHQ6IDAsIHRhcmdldFRpbHQ6IDAsCiAgICAgICAgICAgICAgICByb3RvckFuZ2xlOiAwLCByb3RvclNwZWVkOiAwLjMsCiAgICAgICAgICAgICAgICBjYXJyeWluZzogbnVsbCwKICAgICAgICAgICAgICAgIGhlYWx0aDogMTAwLAogICAgICAgICAgICAgICAgZGFtYWdlRmxhc2g6IDAsCiAgICAgICAgICAgICAgICBzbW9rZVRpbWVyOiAwLAogICAgICAgICAgICAgICAgZmFjaW5nOiBzdGFydEZhY2luZwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBnZW5lcmF0ZVNvcnRpZSgpIHsKICAgICAgICAgICAgY29uc3Qgc29ydGllID0gRy5zb3J0aWVOdW07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQcm9ncmVzc2l2ZSB3b3JsZCBzaXplIC0gZ2V0cyBtdWNoIGJpZ2dlcgogICAgICAgICAgICBjb25zdCBiYXNlRGlzdGFuY2UgPSA3MDAgKyBzb3J0aWUgKiAyODA7CiAgICAgICAgICAgIEcud29ybGRXaWR0aCA9IGJhc2VEaXN0YW5jZSArIDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdlYXRoZXIgc3lzdGVtIC0gc29ydGllcyAzIGFuZCA1IGhhdmUgYmFkIHdlYXRoZXIKICAgICAgICAgICAgRy53ZWF0aGVyID0gJ2NsZWFyJzsKICAgICAgICAgICAgaWYgKHNvcnRpZSA9PT0gMykgRy53ZWF0aGVyID0gJ3JhaW4nOwogICAgICAgICAgICBpZiAoc29ydGllID09PSA1KSBHLndlYXRoZXIgPSAnc3Rvcm0nOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gSG9tZSBiYXNlIHBvc2l0aW9uIHZhcmllcyAtIHNvbWV0aW1lcyBzdGFydCBmcm9tIHJpZ2h0IHNpZGUKICAgICAgICAgICAgY29uc3Qgc3RhcnRGcm9tUmlnaHQgPSAoc29ydGllID09PSAzIHx8IHNvcnRpZSA9PT0gNSk7CiAgICAgICAgICAgIEcuaG9tZUJhc2UgPSB7IAogICAgICAgICAgICAgICAgeDogc3RhcnRGcm9tUmlnaHQgPyBHLndvcmxkV2lkdGggLSAxMjAgOiAxMDAsIAogICAgICAgICAgICAgICAgd2lkdGg6IDcwIAogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gR2VuZXJhdGUgZGVwYXJ0bWVudCBidWlsZGluZ3Mgc3ByZWFkIGFjcm9zcyB0aGUgbWFwCiAgICAgICAgICAgIEcuZGVwYXJ0bWVudEJ1aWxkaW5ncyA9IFtdOwogICAgICAgICAgICBjb25zdCBudW1EZXB0cyA9IE1hdGgubWluKDIgKyBzb3J0aWUsIDYpOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1EZXB0czsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkZXB0ID0gREVQQVJUTUVOVFNbaSAlIERFUEFSVE1FTlRTLmxlbmd0aF07CiAgICAgICAgICAgICAgICBjb25zdCB6b25lV2lkdGggPSAoRy53b3JsZFdpZHRoIC0gNDAwKSAvIG51bURlcHRzOwogICAgICAgICAgICAgICAgY29uc3QgZGVwdFggPSAyMDAgKyB6b25lV2lkdGggKiBpICsgem9uZVdpZHRoICogMC41ICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogNjA7CiAgICAgICAgICAgICAgICBHLmRlcGFydG1lbnRCdWlsZGluZ3MucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgLi4uZGVwdCwKICAgICAgICAgICAgICAgICAgICB4OiBkZXB0WCwKICAgICAgICAgICAgICAgICAgICB3aWR0aDogODUgKyBNYXRoLnJhbmRvbSgpICogMjUsCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAxMTAgKyBNYXRoLnJhbmRvbSgpICogNTAgKyBzb3J0aWUgKiAxMgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBpY2sgZGVwYXJ0bWVudCAtIHZhcmllcyBwb3NpdGlvbiBlYWNoIHNvcnRpZQogICAgICAgICAgICBjb25zdCBkZXB0UGF0dGVybnMgPSBbMCwgTWF0aC5mbG9vcihudW1EZXB0cy8yKSwgbnVtRGVwdHMtMSwgMSwgTWF0aC5mbG9vcihudW1EZXB0cy8yKV07CiAgICAgICAgICAgIGNvbnN0IGRlcHRJbmRleCA9IE1hdGgubWluKGRlcHRQYXR0ZXJuc1tzb3J0aWUgLSAxXSB8fCAwLCBHLmRlcGFydG1lbnRCdWlsZGluZ3MubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgIEcuY3VycmVudERlcHQgPSBHLmRlcGFydG1lbnRCdWlsZGluZ3NbZGVwdEluZGV4XTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFRlYW0gcG9zaXRpb24gLSBvcHBvc2l0ZSBlbmQgZnJvbSBob21lLCB2YXJpZXMgZWFjaCBzb3J0aWUKICAgICAgICAgICAgbGV0IHRlYW1YOwogICAgICAgICAgICBpZiAoc3RhcnRGcm9tUmlnaHQpIHsKICAgICAgICAgICAgICAgIHRlYW1YID0gMTUwICsgTWF0aC5yYW5kb20oKSAqIDEwMDsgLy8gVGVhbSBvbiBsZWZ0IHdoZW4gc3RhcnRpbmcgcmlnaHQKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRlYW1YID0gRy53b3JsZFdpZHRoIC0gMTUwIC0gTWF0aC5yYW5kb20oKSAqIDEwMDsgLy8gVGVhbSBvbiByaWdodAogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBHLnRlYW0gPSB7CiAgICAgICAgICAgICAgICBuYW1lOiBURUFNX05BTUVTWyhzb3J0aWUgLSAxKSAlIFRFQU1fTkFNRVMubGVuZ3RoXSArICcgVGVhbScsCiAgICAgICAgICAgICAgICBjb2xvcjogVEVBTV9DT0xPUlNbKHNvcnRpZSAtIDEpICUgVEVBTV9DT0xPUlMubGVuZ3RoXSwKICAgICAgICAgICAgICAgIHg6IHRlYW1YCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbGVhciB6b25lcyBmb3IgbGFuZGluZwogICAgICAgICAgICBjb25zdCBjbGVhclpvbmVzID0gWwogICAgICAgICAgICAgICAgeyB4OiBHLmhvbWVCYXNlLngsIHJhZGl1czogODAgfSwKICAgICAgICAgICAgICAgIHsgeDogRy50ZWFtLngsIHJhZGl1czogOTAgfQogICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgRy5kZXBhcnRtZW50QnVpbGRpbmdzLmZvckVhY2goZGVwdCA9PiB7CiAgICAgICAgICAgICAgICBjbGVhclpvbmVzLnB1c2goeyB4OiBkZXB0LngsIHJhZGl1czogZGVwdC53aWR0aC8yICsgNTUgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT2JzdGFjbGUgYnVpbGRpbmdzIC0gTU9SRSBhbmQgVEFMTEVSIGVhY2ggc29ydGllCiAgICAgICAgICAgIEcub2JzdGFjbGVzID0gW107CiAgICAgICAgICAgIGNvbnN0IG51bU9ic3RhY2xlcyA9IE1hdGgubWluKDQgKyBzb3J0aWUgKiAzLCAxNik7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bU9ic3RhY2xlczsgaSsrKSB7CiAgICAgICAgICAgICAgICBsZXQgb3ggPSAxODAgKyAoRy53b3JsZFdpZHRoIC0gMzYwKSAvIG51bU9ic3RhY2xlcyAqIGkgKyBNYXRoLnJhbmRvbSgpICogODA7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxldCB0b29DbG9zZSA9IGNsZWFyWm9uZXMuc29tZSh6b25lID0+IE1hdGguYWJzKHpvbmUueCAtIG94KSA8IHpvbmUucmFkaXVzKTsKICAgICAgICAgICAgICAgIGxldCBhdHRlbXB0cyA9IDA7CiAgICAgICAgICAgICAgICB3aGlsZSAodG9vQ2xvc2UgJiYgYXR0ZW1wdHMgPCAyMCkgewogICAgICAgICAgICAgICAgICAgIG94ID0gMTgwICsgTWF0aC5yYW5kb20oKSAqIChHLndvcmxkV2lkdGggLSAzNjApOwogICAgICAgICAgICAgICAgICAgIHRvb0Nsb3NlID0gY2xlYXJab25lcy5zb21lKHpvbmUgPT4gTWF0aC5hYnMoem9uZS54IC0gb3gpIDwgem9uZS5yYWRpdXMpOwogICAgICAgICAgICAgICAgICAgIGF0dGVtcHRzKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghdG9vQ2xvc2UpIHsKICAgICAgICAgICAgICAgICAgICBHLm9ic3RhY2xlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgeDogb3gsCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiA0NSArIE1hdGgucmFuZG9tKCkgKiA1MCwKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA4MCArIE1hdGgucmFuZG9tKCkgKiAxMDAgKyBzb3J0aWUgKiAyMAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNZWV0aW5ncyB3aXRoIHZpc2libGUgaGVhZHdpbmQgLSBiYWxhbmNlZCBzdHJlbmd0aAogICAgICAgICAgICBHLm1lZXRpbmdzID0gW107CiAgICAgICAgICAgIGNvbnN0IG51bU1lZXRpbmdzID0gTWF0aC5taW4oMSArIHNvcnRpZSwgNik7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtTWVldGluZ3M7IGkrKykgewogICAgICAgICAgICAgICAgbGV0IG14ID0gMjUwICsgKEcud29ybGRXaWR0aCAtIDUwMCkgLyBudW1NZWV0aW5ncyAqIGkgKyBNYXRoLnJhbmRvbSgpICogMTAwOwogICAgICAgICAgICAgICAgbGV0IHRvb0Nsb3NlID0gY2xlYXJab25lcy5zb21lKHpvbmUgPT4gTWF0aC5hYnMoem9uZS54IC0gbXgpIDwgem9uZS5yYWRpdXMgKyA4MCk7CiAgICAgICAgICAgICAgICBpZiAoIXRvb0Nsb3NlKSB7CiAgICAgICAgICAgICAgICAgICAgRy5tZWV0aW5ncy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgeDogbXgsCiAgICAgICAgICAgICAgICAgICAgICAgIHk6IDEwMCArIE1hdGgucmFuZG9tKCkgKiAxNDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMjAgKyBzb3J0aWUgKiAxNSwKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA5MCArIHNvcnRpZSAqIDEyLAogICAgICAgICAgICAgICAgICAgICAgICBwaGFzZTogTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyLAogICAgICAgICAgICAgICAgICAgICAgICB3aW5kU3RyZW5ndGg6IDAuMDggKyBzb3J0aWUgKiAwLjAxNSAgLy8gR2VudGxlciB3aW5kCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVtYWlsIHN0b3JtcyAtIHN0YXJ0IGZyb20gc29ydGllIDIKICAgICAgICAgICAgRy5lbWFpbFN0b3JtcyA9IFtdOwogICAgICAgICAgICBpZiAoc29ydGllID49IDIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG51bVN0b3JtcyA9IE1hdGgubWluKHNvcnRpZSwgNCk7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IG51bVN0b3JtczsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHN4ID0gMzUwICsgcyAqIDM1MCArIE1hdGgucmFuZG9tKCkgKiAyMDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRvb0Nsb3NlID0gY2xlYXJab25lcy5zb21lKHpvbmUgPT4gTWF0aC5hYnMoem9uZS54IC0gc3gpIDwgem9uZS5yYWRpdXMgKyA5MCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0b29DbG9zZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHg6IHN4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeTogMTQwICsgTWF0aC5yYW5kb20oKSAqIDEwMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGl1czogNjUgKyBzb3J0aWUgKiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRBbmdsZTogTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGljbGVzOiBbXQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDE4OyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JtLnBhcnRpY2xlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmdsZTogTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3Q6IE1hdGgucmFuZG9tKCkgKiBzdG9ybS5yYWRpdXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlZWQ6IDAuMDM1ICsgTWF0aC5yYW5kb20oKSAqIDAuMDM1CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBHLmVtYWlsU3Rvcm1zLnB1c2goc3Rvcm0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUml2YWwgLSBhcHBlYXJzIGZyb20gc29ydGllIDIsIHNjYWxlcyB1cCBpbiBsYXRlciByb3VuZHMKICAgICAgICAgICAgRy5yaXZhbCA9IG51bGw7CiAgICAgICAgICAgIGlmIChHLnNvcnRpZU51bSA+PSAyKSB7CiAgICAgICAgICAgICAgICBHLnJpdmFsID0gewogICAgICAgICAgICAgICAgICAgIHg6IEcuY3VycmVudERlcHQueCArIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDIwMCwKICAgICAgICAgICAgICAgICAgICB5OiAxMjAgKyBNYXRoLnJhbmRvbSgpICogNjAsCiAgICAgICAgICAgICAgICAgICAgdng6IDAsIHZ5OiAwLAogICAgICAgICAgICAgICAgICAgIHRpbHQ6IDAsIHJvdG9yQW5nbGU6IDAsCiAgICAgICAgICAgICAgICAgICAgc3RhdGU6ICdwYXRyb2wnLAogICAgICAgICAgICAgICAgICAgIHBhdHJvbFRhcmdldDogRy5jdXJyZW50RGVwdC54LAogICAgICAgICAgICAgICAgICAgIGNhcnJ5aW5nOiBudWxsLAogICAgICAgICAgICAgICAgICAgIGFnZ3Jlc3Npb246IDAuMDQgKyBHLnNvcnRpZU51bSAqIDAuMDIsICAgLy8gU2NhbGVzIG1vcmU6IDAuMDggYXQgUzIsIDAuMTQgYXQgUzUKICAgICAgICAgICAgICAgICAgICBtYXhTcGVlZDogMi41ICsgRy5zb3J0aWVOdW0gKiAwLjUsICAgICAgIC8vIEZhc3RlciBzY2FsaW5nOiAzLjUgYXQgUzIsIDUuMCBhdCBTNQogICAgICAgICAgICAgICAgICAgIGludGVyY2VwdERpc3RhbmNlOiAxMDAgKyBHLnNvcnRpZU51bSAqIDMwIC8vIExvbmdlciByYW5nZSBsYXRlcjogMTYwIGF0IFMyLCAyNTAgYXQgUzUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdlYXRoZXIgZWZmZWN0cyAtIHJhaW4gcGFydGljbGVzCiAgICAgICAgICAgIEcucmFpbmRyb3BzID0gW107CiAgICAgICAgICAgIGlmIChHLndlYXRoZXIgIT09ICdjbGVhcicpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG51bURyb3BzID0gRy53ZWF0aGVyID09PSAnc3Rvcm0nID8gMjAwIDogMTAwOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1Ecm9wczsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgRy5yYWluZHJvcHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHg6IE1hdGgucmFuZG9tKCkgKiBHLndvcmxkV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIHk6IE1hdGgucmFuZG9tKCkgKiBHUk9VTkRfWSwKICAgICAgICAgICAgICAgICAgICAgICAgc3BlZWQ6IEcud2VhdGhlciA9PT0gJ3N0b3JtJyA/IDEyICsgTWF0aC5yYW5kb20oKSAqIDggOiA4ICsgTWF0aC5yYW5kb20oKSAqIDQsCiAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aDogRy53ZWF0aGVyID09PSAnc3Rvcm0nID8gMTggOiAxMgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDbG91ZHMgLSBtb3JlIGFuZCBkYXJrZXIgaW4gYmFkIHdlYXRoZXIKICAgICAgICAgICAgRy5jbG91ZHMgPSBbXTsKICAgICAgICAgICAgY29uc3QgbnVtQ2xvdWRzID0gRy53ZWF0aGVyID09PSAnY2xlYXInID8gTWF0aC5jZWlsKEcud29ybGRXaWR0aCAvIDEyMCkgOiBNYXRoLmNlaWwoRy53b3JsZFdpZHRoIC8gODApOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUNsb3VkczsgaSsrKSB7CiAgICAgICAgICAgICAgICBHLmNsb3Vkcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICB4OiBNYXRoLnJhbmRvbSgpICogRy53b3JsZFdpZHRoLAogICAgICAgICAgICAgICAgICAgIHk6IDE1ICsgTWF0aC5yYW5kb20oKSAqIDcwLAogICAgICAgICAgICAgICAgICAgIHNpemU6IDMwICsgTWF0aC5yYW5kb20oKSAqIDUwLAogICAgICAgICAgICAgICAgICAgIHNwZWVkOiBHLndlYXRoZXIgPT09ICdzdG9ybScgPyAwLjIgKyBNYXRoLnJhbmRvbSgpICogMC4xNSA6IDAuMDUgKyBNYXRoLnJhbmRvbSgpICogMC4wOCwKICAgICAgICAgICAgICAgICAgICBkYXJrOiBHLndlYXRoZXIgIT09ICdjbGVhcicKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSZXNldCBnYW1lIHN0YXRlCiAgICAgICAgICAgIEcucGhhc2UgPSAncGlja3VwJzsKICAgICAgICAgICAgRy50aW1lID0gTWF0aC5tYXgoNTAsIDgwIC0gc29ydGllICogNSk7ICAvLyBNb3JlIHRpbWUKICAgICAgICAgICAgRy5oZWxpY29wdGVyID0gY3JlYXRlSGVsaWNvcHRlcihHLmhvbWVCYXNlLngsIEdST1VORF9ZIC0gMjUpOwogICAgICAgICAgICBHLmNhbWVyYVggPSBNYXRoLm1heCgwLCBHLmhvbWVCYXNlLnggLSA0MDApOwogICAgICAgICAgICBHLnBhcnRpY2xlcyA9IFtdOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiB1cGRhdGVCYW5uZXIoKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3J0aWVUaXRsZScpLnRleHRDb250ZW50ID0gYFNPUlRJRSAke0cuc29ydGllTnVtfS81YDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkZCB3ZWF0aGVyIGluZGljYXRvciB0byBiYW5uZXIKICAgICAgICAgICAgbGV0IHdlYXRoZXJJY29uID0gJyc7CiAgICAgICAgICAgIGlmIChHLndlYXRoZXIgPT09ICdyYWluJykgd2VhdGhlckljb24gPSAnIPCfjKfvuI8nOwogICAgICAgICAgICBlbHNlIGlmIChHLndlYXRoZXIgPT09ICdzdG9ybScpIHdlYXRoZXJJY29uID0gJyDim4jvuI8nOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEcucGhhc2UgPT09ICdwaWNrdXAnKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc29ydGllVHJhbnNmZXInKS5pbm5lckhUTUwgPSAKICAgICAgICAgICAgICAgICAgICBgPHNwYW4gc3R5bGU9ImNvbG9yOiM5NWE1YTYiPkZseSB0bzo8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0cmFuc2Zlci1mcm9tIj4ke0cuY3VycmVudERlcHQuaWNvbn0gJHtHLmN1cnJlbnREZXB0Lm5hbWV9PC9zcGFuPiR7d2VhdGhlckljb259YDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3J0aWVUcmFuc2ZlcicpLmlubmVySFRNTCA9IAogICAgICAgICAgICAgICAgICAgIGA8c3BhbiBjbGFzcz0idHJhbnNmZXItZnJvbSI+JHtHLmN1cnJlbnREZXB0Lmljb259ICR7Ry5jdXJyZW50RGVwdC5yZXNvdXJjZX08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0cmFuc2Zlci1hcnJvdyI+4p6cPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idHJhbnNmZXItdG8iIHN0eWxlPSJjb2xvcjoke0cudGVhbS5jb2xvcn0iPiR7Ry50ZWFtLm5hbWV9PC9zcGFuPiR7d2VhdGhlckljb259YDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiB1cGRhdGVIZWFsdGhCYXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGZpbGwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGVhbHRoRmlsbCcpOwogICAgICAgICAgICBjb25zdCBoID0gRy5oZWxpY29wdGVyOwogICAgICAgICAgICBpZiAoIWgpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZpbGwuc3R5bGUud2lkdGggPSBoLmhlYWx0aCArICclJzsKICAgICAgICAgICAgaWYgKGguaGVhbHRoID4gNjApIGZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICMyN2FlNjAsICMyZWNjNzEpJzsKICAgICAgICAgICAgZWxzZSBpZiAoaC5oZWFsdGggPiAzMCkgZmlsbC5zdHlsZS5iYWNrZ3JvdW5kID0gJ2xpbmVhci1ncmFkaWVudCg5MGRlZywgI2YzOWMxMiwgI2U2N2UyMiknOwogICAgICAgICAgICBlbHNlIGZpbGwuc3R5bGUuYmFja2dyb3VuZCA9ICdsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNlNzRjM2MsICNjMDM5MmIpJzsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gPT09PT09PT09PSBUVVRPUklBTCBNT0RFID09PT09PT09PT0KICAgICAgICBmdW5jdGlvbiBzdGFydFR1dG9yaWFsKCkgewogICAgICAgICAgICBpbml0QXVkaW8oKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGFydFNjcmVlbicpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0dXRvcmlhbENvbnRyb2xzJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0dXRvcmlhbEJhbm5lcicpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2tpcFR1dG9yaWFsJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFsdGhCYXInKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlYWx0aExhYmVsJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtaW5pbWFwJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3VuZFRvZ2dsZScpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAKICAgICAgICAgICAgRy50dXRvcmlhbE1vZGUgPSB0cnVlOwogICAgICAgICAgICBHLnR1dG9yaWFsU3RlcCA9IDA7CiAgICAgICAgICAgIEcud2VhdGhlciA9ICdjbGVhcic7CiAgICAgICAgICAgIEcud29ybGRXaWR0aCA9IDgwMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNpbXBsZSB0dXRvcmlhbCBsYXlvdXQKICAgICAgICAgICAgRy5ob21lQmFzZSA9IHsgeDogMTAwLCB3aWR0aDogNzAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9uZSBlYXN5IGRlcGFydG1lbnQgYnVpbGRpbmcKICAgICAgICAgICAgRy5kZXBhcnRtZW50QnVpbGRpbmdzID0gW3sKICAgICAgICAgICAgICAgIGtleTogJ3RyYWluaW5nJywgbmFtZTogJ1RyYWluaW5nJywgY29sb3I6ICcjMzQ5OGRiJywgCiAgICAgICAgICAgICAgICBpY29uOiAn8J+TpicsIHJlc291cmNlOiAnUHJhY3RpY2UgQ2FyZ28nLAogICAgICAgICAgICAgICAgeDogNDAwLCB3aWR0aDogOTAsIGhlaWdodDogMTIwCiAgICAgICAgICAgIH1dOwogICAgICAgICAgICBHLmN1cnJlbnREZXB0ID0gRy5kZXBhcnRtZW50QnVpbGRpbmdzWzBdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTGFuZGluZyB6b25lCiAgICAgICAgICAgIEcudGVhbSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6ICdUcmFpbmluZyBab25lJywKICAgICAgICAgICAgICAgIGNvbG9yOiAnIzJlY2M3MScsCiAgICAgICAgICAgICAgICB4OiA2NTAKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE5vIGhhemFyZHMgaW4gdHV0b3JpYWwKICAgICAgICAgICAgRy5vYnN0YWNsZXMgPSBbXTsKICAgICAgICAgICAgRy5tZWV0aW5ncyA9IFtdOwogICAgICAgICAgICBHLmVtYWlsU3Rvcm1zID0gW107CiAgICAgICAgICAgIEcucml2YWwgPSBudWxsOwogICAgICAgICAgICBHLnJhaW5kcm9wcyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xvdWRzCiAgICAgICAgICAgIEcuY2xvdWRzID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7CiAgICAgICAgICAgICAgICBHLmNsb3Vkcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICB4OiBNYXRoLnJhbmRvbSgpICogRy53b3JsZFdpZHRoLAogICAgICAgICAgICAgICAgICAgIHk6IDIwICsgTWF0aC5yYW5kb20oKSAqIDUwLAogICAgICAgICAgICAgICAgICAgIHNpemU6IDMwICsgTWF0aC5yYW5kb20oKSAqIDMwLAogICAgICAgICAgICAgICAgICAgIHNwZWVkOiAwLjA1CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgRy5waGFzZSA9ICdwaWNrdXAnOwogICAgICAgICAgICBHLnRpbWUgPSA5OTk7IC8vIE5vIHRpbWUgbGltaXQgaW4gdHV0b3JpYWwKICAgICAgICAgICAgRy5oZWxpY29wdGVyID0gY3JlYXRlSGVsaWNvcHRlcihHLmhvbWVCYXNlLngsIEdST1VORF9ZIC0gMjUpOwogICAgICAgICAgICBHLmNhbWVyYVggPSAwOwogICAgICAgICAgICBHLnBhcnRpY2xlcyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgRy5ydW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdXBkYXRlSGVhbHRoQmFyKCk7CiAgICAgICAgICAgIHNob3dUdXRvcmlhbEhpbnQoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZ2FtZUxvb3ApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBzaG93VHV0b3JpYWxIaW50KHN0ZXApIHsKICAgICAgICAgICAgRy50dXRvcmlhbFN0ZXAgPSBzdGVwOwogICAgICAgICAgICBjb25zdCBoaW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R1dG9yaWFsSGludCcpOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R1dG9yaWFsVGV4dCcpOwogICAgICAgICAgICBjb25zdCBzdWJ0ZXh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R1dG9yaWFsU3VidGV4dCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgaGludC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIHN3aXRjaChzdGVwKSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgdGV4dC5pbm5lckhUTUwgPSAn8J+agSBXZWxjb21lLCBQaWxvdCEnOwogICAgICAgICAgICAgICAgICAgIHN1YnRleHQuaW5uZXJIVE1MID0gJ0hvbGQgPGI+4oaRIFc8L2I+IG9yIDxiPlNQQUNFPC9iPiB0byB0aHJ1c3QgdXB3YXJkLjxicj5MaWZ0IG9mZiBmcm9tIHRoZSBoZWxpcGFkISc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgdGV4dC5pbm5lckhUTUwgPSAn4pyI77iPIEdyZWF0ISBOb3cgZmx5IHJpZ2h0ISc7CiAgICAgICAgICAgICAgICAgICAgc3VidGV4dC5pbm5lckhUTUwgPSAnVXNlIDxiPuKGkiBEPC9iPiB0byBmbHkgdG93YXJkIHRoZSBibHVlIFRyYWluaW5nIGJ1aWxkaW5nLjxicj5MYW5kIG9uIHRoZSByb29mdG9wIGhlbGlwYWQgdG8gY29sbGVjdCBjYXJnby4nOwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyBoaW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IH0sIDMwMDApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIHRleHQuaW5uZXJIVE1MID0gJ/Cfk6YgQ2FyZ28gY29sbGVjdGVkISc7CiAgICAgICAgICAgICAgICAgICAgc3VidGV4dC5pbm5lckhUTUwgPSAnTm93IGRlbGl2ZXIgaXQgdG8gdGhlIDxiPlRyYWluaW5nIFpvbmU8L2I+IG9uIHRoZSByaWdodC48YnI+TGFuZCBnZW50bHkgb24gdGhlIGdyZWVuIGxhbmRpbmcgcGFkISc7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IGhpbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgfSwgMzAwMCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgdGV4dC5pbm5lckhUTUwgPSAn8J+OiSBQZXJmZWN0IExhbmRpbmchJzsKICAgICAgICAgICAgICAgICAgICBzdWJ0ZXh0LmlubmVySFRNTCA9ICdZb3VcJ3JlIHJlYWR5IGZvciB0aGUgcmVhbCBtaXNzaW9ucyEnOwogICAgICAgICAgICAgICAgICAgIGhpbnQuc3R5bGUuYm9yZGVyID0gJzNweCBzb2xpZCAjMmVjYzcxJzsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlVHV0b3JpYWwoKTsgCiAgICAgICAgICAgICAgICAgICAgfSwgMjUwMCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVUdXRvcmlhbCgpIHsKICAgICAgICAgICAgRy5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgIEcudHV0b3JpYWxNb2RlID0gZmFsc2U7CiAgICAgICAgICAgIHNldFJvdG9yU291bmQoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHV0b3JpYWxIaW50Jykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R1dG9yaWFsQ29udHJvbHMnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHV0b3JpYWxCYW5uZXInKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2tpcFR1dG9yaWFsJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlYWx0aEJhcicpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFsdGhMYWJlbCcpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtaW5pbWFwJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlc2V0IGZvciByZWFsIGdhbWUKICAgICAgICAgICAgRy5zb3J0aWVOdW0gPSAxOwogICAgICAgICAgICBHLnRvdGFsU2NvcmUgPSAwOwogICAgICAgICAgICBHLnRvdGFsRGlzdGFuY2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgc2hvd0JyaWVmaW5nKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIHNraXBUdXRvcmlhbCgpIHsKICAgICAgICAgICAgRy5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgIEcudHV0b3JpYWxNb2RlID0gZmFsc2U7CiAgICAgICAgICAgIHNldFJvdG9yU291bmQoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHV0b3JpYWxIaW50Jykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3R1dG9yaWFsQ29udHJvbHMnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHV0b3JpYWxCYW5uZXInKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2tpcFR1dG9yaWFsJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlYWx0aEJhcicpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFsdGhMYWJlbCcpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtaW5pbWFwJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIEcuc29ydGllTnVtID0gMTsKICAgICAgICAgICAgRy50b3RhbFNjb3JlID0gMDsKICAgICAgICAgICAgRy50b3RhbERpc3RhbmNlID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHNob3dCcmllZmluZygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiB1cGRhdGVUdXRvcmlhbFByb2dyZXNzKCkgewogICAgICAgICAgICBpZiAoIUcudHV0b3JpYWxNb2RlKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBoID0gRy5oZWxpY29wdGVyOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RlcCAwOiBMaWZ0IG9mZgogICAgICAgICAgICBpZiAoRy50dXRvcmlhbFN0ZXAgPT09IDAgJiYgaC55IDwgR1JPVU5EX1kgLSA2MCkgewogICAgICAgICAgICAgICAgc2hvd1R1dG9yaWFsSGludCgxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RlcCAxIC0+IDIgaXMgaGFuZGxlZCBieSBwaWNrdXAgaW4gbWFpbiB1cGRhdGUKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0ZXAgMiAtPiAzIGlzIGhhbmRsZWQgYnkgZGVsaXZlcnkgaW4gbWFpbiB1cGRhdGUKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc2hvd0JyaWVmaW5nKCkgewogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhcnRTY3JlZW4nKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kU2NyZWVuJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvcnRpZUNvbXBsZXRlU2NyZWVuJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JyaWVmaW5nU2NyZWVuJykuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIGdlbmVyYXRlU29ydGllKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnJpZWZpbmdTb3J0aWVOdW0nKS50ZXh0Q29udGVudCA9IEcuc29ydGllTnVtICsgJy81JzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pc3Npb25SZXNvdXJjZScpLnRleHRDb250ZW50ID0gYCR7Ry5jdXJyZW50RGVwdC5pY29ufSAke0cuY3VycmVudERlcHQucmVzb3VyY2V9YDsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pc3Npb25SZXNvdXJjZScpLnN0eWxlLmNvbG9yID0gRy5jdXJyZW50RGVwdC5jb2xvcjsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pc3Npb25UYXJnZXQnKS50ZXh0Q29udGVudCA9IEcudGVhbS5uYW1lOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWlzc2lvblRhcmdldCcpLnN0eWxlLmNvbG9yID0gRy50ZWFtLmNvbG9yOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHRvdGFsIGRpc3RhbmNlCiAgICAgICAgICAgIGNvbnN0IHRvRGVwdCA9IE1hdGgucm91bmQoTWF0aC5hYnMoRy5jdXJyZW50RGVwdC54IC0gRy5ob21lQmFzZS54KSk7CiAgICAgICAgICAgIGNvbnN0IHRvVGVhbSA9IE1hdGgucm91bmQoTWF0aC5hYnMoRy50ZWFtLnggLSBHLmN1cnJlbnREZXB0LngpKTsKICAgICAgICAgICAgY29uc3QgdG90YWxEaXN0ID0gdG9EZXB0ICsgdG9UZWFtOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IGhhemFyZHMgPSBbXTsKICAgICAgICAgICAgaGF6YXJkcy5wdXNoKGAke0cub2JzdGFjbGVzLmxlbmd0aH0gYnVpbGRpbmdzYCk7CiAgICAgICAgICAgIGlmIChHLm1lZXRpbmdzLmxlbmd0aCA+IDApIGhhemFyZHMucHVzaChgJHtHLm1lZXRpbmdzLmxlbmd0aH0gbWVldGluZ3MgKGhlYWR3aW5kISlgKTsKICAgICAgICAgICAgaWYgKEcuZW1haWxTdG9ybXMubGVuZ3RoID4gMCkgaGF6YXJkcy5wdXNoKGAke0cuZW1haWxTdG9ybXMubGVuZ3RofSBlbWFpbCBzdG9ybXNgKTsKICAgICAgICAgICAgaWYgKEcuc29ydGllTnVtID49IDIpIGhhemFyZHMucHVzaCgncml2YWwgbWFuYWdlcicpOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IHdlYXRoZXJXYXJuaW5nID0gJyc7CiAgICAgICAgICAgIGlmIChHLndlYXRoZXIgPT09ICdyYWluJykgewogICAgICAgICAgICAgICAgd2VhdGhlcldhcm5pbmcgPSAnPGRpdiBzdHlsZT0iY29sb3I6I2YzOWMxMjttYXJnaW4tdG9wOjhweCI+8J+Mp++4jyBSQUlOOiBSZWR1Y2VkIHRocnVzdCAmIGNvbnRyb2w8L2Rpdj4nOwogICAgICAgICAgICB9IGVsc2UgaWYgKEcud2VhdGhlciA9PT0gJ3N0b3JtJykgewogICAgICAgICAgICAgICAgd2VhdGhlcldhcm5pbmcgPSAnPGRpdiBzdHlsZT0iY29sb3I6I2U3NGMzYzttYXJnaW4tdG9wOjhweCI+4puI77iPIFNUT1JNOiBIZWF2eSB0dXJidWxlbmNlITwvZGl2Pic7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWZmaWN1bHR5SW5mbycpLmlubmVySFRNTCA9IAogICAgICAgICAgICAgICAgYDxkaXY+8J+TjSBUb3RhbCBEaXN0YW5jZTogJHt0b3RhbERpc3R9bTwvZGl2PgogICAgICAgICAgICAgICAgIDxkaXY+4pqg77iPIEhhemFyZHM6ICR7aGF6YXJkcy5qb2luKCcsICcpfTwvZGl2PgogICAgICAgICAgICAgICAgICR7d2VhdGhlcldhcm5pbmd9YDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdicmllZmluZ1RpbWUnKS50ZXh0Q29udGVudCA9IEcudGltZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc3RhcnRTb3J0aWUoKSB7CiAgICAgICAgICAgIGluaXRBdWRpbygpOwogICAgICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JyaWVmaW5nU2NyZWVuJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvcnRpZUJhbm5lcicpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGVhbHRoQmFyJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZWFsdGhMYWJlbCcpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlzdGFuY2VJbmRpY2F0b3InKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21pbmltYXAnKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvdW5kVG9nZ2xlJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIAogICAgICAgICAgICBHLnJ1bm5pbmcgPSB0cnVlOwogICAgICAgICAgICB1cGRhdGVCYW5uZXIoKTsKICAgICAgICAgICAgdXBkYXRlSGVhbHRoQmFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZ2FtZUxvb3ApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVNvcnRpZSgpIHsKICAgICAgICAgICAgRy5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHNldFJvdG9yU291bmQoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB0aW1lQm9udXMgPSBNYXRoLmZsb29yKEcudGltZSkgKiAxMDsKICAgICAgICAgICAgY29uc3QgZGlzdGFuY2VCb251cyA9IE1hdGgucm91bmQoKE1hdGguYWJzKEcudGVhbS54IC0gRy5ob21lQmFzZS54KSArIE1hdGguYWJzKEcuY3VycmVudERlcHQueCAtIEcuaG9tZUJhc2UueCkpIC8gOCk7CiAgICAgICAgICAgIGNvbnN0IHNvcnRpZUJvbnVzID0gRy5zb3J0aWVOdW0gKiAzMDsKICAgICAgICAgICAgY29uc3Qgd2VhdGhlckJvbnVzID0gRy53ZWF0aGVyID09PSAnc3Rvcm0nID8gMTAwIDogKEcud2VhdGhlciA9PT0gJ3JhaW4nID8gNTAgOiAwKTsKICAgICAgICAgICAgRy50b3RhbFNjb3JlICs9IHRpbWVCb251cyArIGRpc3RhbmNlQm9udXMgKyBzb3J0aWVCb251cyArIHdlYXRoZXJCb251czsKICAgICAgICAgICAgRy50b3RhbERpc3RhbmNlICs9IE1hdGgucm91bmQoTWF0aC5hYnMoRy50ZWFtLnggLSBHLmhvbWVCYXNlLngpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhpZGUgZ2FtZXBsYXkgVUkKICAgICAgICAgICAgWydzb3J0aWVCYW5uZXInLCAnaGVhbHRoQmFyJywgJ2hlYWx0aExhYmVsJywgJ2Rpc3RhbmNlSW5kaWNhdG9yJywgJ21pbmltYXAnLCAnd2FybmluZ0luZGljYXRvciddLmZvckVhY2goaWQgPT4gewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIHZpY3RvcnkgKDUgc29ydGllcyBjb21wbGV0ZWQpCiAgICAgICAgICAgIGlmIChHLnNvcnRpZU51bSA+PSA1KSB7CiAgICAgICAgICAgICAgICAvLyBWSUNUT1JZIQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZFNjcmVlbicpLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kVGl0bGUnKS50ZXh0Q29udGVudCA9ICfwn4+GIE1JU1NJT04gQ09NUExFVEUhJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmRUaXRsZScpLnN0eWxlLmNvbG9yID0gJyMyZWNjNzEnOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZpbmFsU2NvcmUnKS50ZXh0Q29udGVudCA9IEcudG90YWxTY29yZTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3J0aWVzQ29tcGxldGVTdGF0JykudGV4dENvbnRlbnQgPSAnNS81JzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXN0YW5jZVN0YXQnKS50ZXh0Q29udGVudCA9IEcudG90YWxEaXN0YW5jZSArICdtJzsKICAgICAgICAgICAgICAgIHBsYXlTb3VuZCgnZGVsaXZlcicpOwogICAgICAgICAgICAgICAgc2VuZFRvUGFyZW50KHsgdHlwZTogJ3Jlc291cmNlUnVuRG9uZScsIHJlc3VsdDogJ3ZpY3RvcnknLCBzY29yZTogRy50b3RhbFNjb3JlLCBkaXN0YW5jZTogRy50b3RhbERpc3RhbmNlLCBzb3J0aWVzOiA1IH0pOwoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hvdyBjb21wbGV0ZSBzY3JlZW4KICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbXBsZXRlZFNvcnRpZU51bScpLnRleHRDb250ZW50ID0gRy5zb3J0aWVOdW07CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3J0aWVUaW1lQm9udXMnKS50ZXh0Q29udGVudCA9IHRpbWVCb251cyArIGRpc3RhbmNlQm9udXMgKyBzb3J0aWVCb251cyArIHdlYXRoZXJCb251czsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvcnRpZVNjb3JlJykudGV4dENvbnRlbnQgPSBHLnRvdGFsU2NvcmU7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3J0aWVDb21wbGV0ZVNjcmVlbicpLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgIAogICAgICAgICAgICBwbGF5U291bmQoJ2RlbGl2ZXInKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIEcuc29ydGllTnVtKys7CiAgICAgICAgICAgIAogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3J0aWVDb21wbGV0ZVNjcmVlbicpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBzaG93QnJpZWZpbmcoKTsKICAgICAgICAgICAgfSwgMjUwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGVuZEdhbWUocmVhc29uKSB7CiAgICAgICAgICAgIEcucnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICBzZXRSb3RvclNvdW5kKDApOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHJlYXNvbiA9PT0gJ2NyYXNoJykgcGxheVNvdW5kKCdjcmFzaCcpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVHV0b3JpYWwgbW9kZSAtIHJlc3RhcnQgb24gY3Jhc2gKICAgICAgICAgICAgaWYgKEcudHV0b3JpYWxNb2RlKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHV0b3JpYWxIaW50Jykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHV0b3JpYWxIaW50Jykuc3R5bGUuYm9yZGVyID0gJzNweCBzb2xpZCAjZTc0YzNjJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0dXRvcmlhbFRleHQnKS5pbm5lckhUTUwgPSAn8J+SpSBPb3BzISBMZXRcJ3MgdHJ5IGFnYWluLic7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHV0b3JpYWxTdWJ0ZXh0JykuaW5uZXJIVE1MID0gJ1Rha2UgaXQgc2xvdyAtIGxhbmQgZ2VudGx5ISc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0dXRvcmlhbEhpbnQnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0dXRvcmlhbEhpbnQnKS5zdHlsZS5ib3JkZXIgPSAnM3B4IHNvbGlkICMzNDk4ZGInOwogICAgICAgICAgICAgICAgICAgIHN0YXJ0VHV0b3JpYWwoKTsKICAgICAgICAgICAgICAgIH0sIDIwMDApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBbJ3NvcnRpZUJhbm5lcicsICdoZWFsdGhCYXInLCAnaGVhbHRoTGFiZWwnLCAnZGlzdGFuY2VJbmRpY2F0b3InLCAnbWluaW1hcCcsICd3YXJuaW5nSW5kaWNhdG9yJywgJ3NvdW5kVG9nZ2xlJ10uZm9yRWFjaChpZCA9PiB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kU2NyZWVuJykuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZFRpdGxlJykudGV4dENvbnRlbnQgPSByZWFzb24gPT09ICdjcmFzaCcgPyAn8J+SpSBDcmFzaGVkIScgOiAn4o+wIFRpbWVcJ3MgVXAhJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZFRpdGxlJykuc3R5bGUuY29sb3IgPSAnI2U3NGMzYyc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaW5hbFNjb3JlJykudGV4dENvbnRlbnQgPSBHLnRvdGFsU2NvcmU7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb3J0aWVzQ29tcGxldGVTdGF0JykudGV4dENvbnRlbnQgPSBHLnNvcnRpZU51bSAtIDE7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXN0YW5jZVN0YXQnKS50ZXh0Q29udGVudCA9IEcudG90YWxEaXN0YW5jZSArICdtJzsKICAgICAgICAgICAgc2VuZFRvUGFyZW50KHsgdHlwZTogJ3Jlc291cmNlUnVuRG9uZScsIHJlc3VsdDogcmVhc29uLCBzY29yZTogRy50b3RhbFNjb3JlLCBkaXN0YW5jZTogRy50b3RhbERpc3RhbmNlLCBzb3J0aWVzOiAoRy5zb3J0aWVOdW0gLSAxKSB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gcmVzZXRHYW1lKCkgewogICAgICAgICAgICBHLnNvcnRpZU51bSA9IDE7CiAgICAgICAgICAgIEcudG90YWxTY29yZSA9IDA7CiAgICAgICAgICAgIEcudG90YWxEaXN0YW5jZSA9IDA7CiAgICAgICAgICAgIHNob3dCcmllZmluZygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBkYW1hZ2VIZWxpY29wdGVyKGFtb3VudCwgdHlwZSA9ICdidW1wJykgewogICAgICAgICAgICBjb25zdCBoID0gRy5oZWxpY29wdGVyOwogICAgICAgICAgICBpZiAoIWgpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJlYXNvbmFibGUgZGFtYWdlCiAgICAgICAgICAgIGNvbnN0IGFjdHVhbERhbWFnZSA9IE1hdGguY2VpbChhbW91bnQgKiAxLjIpOwogICAgICAgICAgICBoLmhlYWx0aCA9IE1hdGgubWF4KDAsIGguaGVhbHRoIC0gYWN0dWFsRGFtYWdlKTsKICAgICAgICAgICAgaC5kYW1hZ2VGbGFzaCA9IDE1OwogICAgICAgICAgICAKICAgICAgICAgICAgcGxheVNvdW5kKHR5cGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgICAgICAgIEcucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgIHg6IGgueCArIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDI1LAogICAgICAgICAgICAgICAgICAgIHk6IGgueSArIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDI1LAogICAgICAgICAgICAgICAgICAgIHZ4OiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA1LAogICAgICAgICAgICAgICAgICAgIHZ5OiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiA1LAogICAgICAgICAgICAgICAgICAgIGxpZmU6IDIwLCBjb2xvcjogJyNmMzljMTInLCBzaXplOiAzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlSGVhbHRoQmFyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaC5oZWFsdGggPD0gMCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYW5nbGUgPSAoaSAvIDI1KSAqIE1hdGguUEkgKiAyOwogICAgICAgICAgICAgICAgICAgIEcucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICB4OiBoLngsIHk6IGgueSwKICAgICAgICAgICAgICAgICAgICAgICAgdng6IE1hdGguY29zKGFuZ2xlKSAqICgyLjUgKyBNYXRoLnJhbmRvbSgpICogMyksCiAgICAgICAgICAgICAgICAgICAgICAgIHZ5OiBNYXRoLnNpbihhbmdsZSkgKiAoMi41ICsgTWF0aC5yYW5kb20oKSAqIDMpLAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiA0NSwgY29sb3I6IGkgJSAyID8gJyNlNzRjM2MnIDogJyNmMzljMTInLCBzaXplOiA1ICsgTWF0aC5yYW5kb20oKSAqIDQKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZW5kR2FtZSgnY3Jhc2gnKSwgNTAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBjaGVja0J1aWxkaW5nQ29sbGlzaW9uKHgsIHksIHJhZGl1cykgewogICAgICAgICAgICAvLyBDaGVjayBkZXBhcnRtZW50IGJ1aWxkaW5ncwogICAgICAgICAgICBmb3IgKGNvbnN0IGRlcHQgb2YgRy5kZXBhcnRtZW50QnVpbGRpbmdzKSB7CiAgICAgICAgICAgICAgICBjb25zdCByb29mWSA9IEdST1VORF9ZIC0gZGVwdC5oZWlnaHQ7CiAgICAgICAgICAgICAgICAvLyBTaWRlIGNvbGxpc2lvbiAobm90IHJvb2YpCiAgICAgICAgICAgICAgICBpZiAoeSA+IHJvb2ZZICsgMTUgJiYgeSA8IEdST1VORF9ZKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHggPiBkZXB0LnggLSBkZXB0LndpZHRoLzIgLSByYWRpdXMgJiYgeCA8IGRlcHQueCAtIGRlcHQud2lkdGgvMiArIDEyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IGhpdDogdHJ1ZSwgc2lkZTogJ2xlZnQnLCBidWlsZGluZzogZGVwdCB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoeCA8IGRlcHQueCArIGRlcHQud2lkdGgvMiArIHJhZGl1cyAmJiB4ID4gZGVwdC54ICsgZGVwdC53aWR0aC8yIC0gMTIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgaGl0OiB0cnVlLCBzaWRlOiAncmlnaHQnLCBidWlsZGluZzogZGVwdCB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgb2JzdGFjbGUgYnVpbGRpbmdzIC0gZnVsbCBjb2xsaXNpb24KICAgICAgICAgICAgZm9yIChjb25zdCBiIG9mIEcub2JzdGFjbGVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBiVG9wID0gR1JPVU5EX1kgLSBiLmhlaWdodDsKICAgICAgICAgICAgICAgIGlmICh5ID4gYlRvcCAtIHJhZGl1cyAmJiB5IDwgR1JPVU5EX1kgJiYKICAgICAgICAgICAgICAgICAgICB4ID4gYi54IC0gYi53aWR0aC8yIC0gcmFkaXVzICYmIHggPCBiLnggKyBiLndpZHRoLzIgKyByYWRpdXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBoaXQ6IHRydWUsIGJ1aWxkaW5nOiBiLCBpc09ic3RhY2xlOiB0cnVlIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB7IGhpdDogZmFsc2UgfTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlKGR0KSB7CiAgICAgICAgICAgIGlmICghRy5ydW5uaW5nIHx8ICFHLmhlbGljb3B0ZXIpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGggPSBHLmhlbGljb3B0ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUaW1lIGNvdW50ZG93biAoc2tpcCBpbiB0dXRvcmlhbCkKICAgICAgICAgICAgaWYgKCFHLnR1dG9yaWFsTW9kZSkgewogICAgICAgICAgICAgICAgRy50aW1lIC09IGR0IC8gMTAwMDsKICAgICAgICAgICAgICAgIGlmIChHLnRpbWUgPD0gMCkgeyBlbmRHYW1lKCd0aW1lJyk7IHJldHVybjsgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXZWF0aGVyIGVmZmVjdHMgb24gY29udHJvbHMgLSBub3QgdG9vIHB1bmlzaGluZwogICAgICAgICAgICBsZXQgdGhydXN0TW9kID0gMS4wOwogICAgICAgICAgICBsZXQgY29udHJvbE1vZCA9IDEuMDsKICAgICAgICAgICAgbGV0IHR1cmJ1bGVuY2UgPSAwOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEcud2VhdGhlciA9PT0gJ3JhaW4nKSB7CiAgICAgICAgICAgICAgICB0aHJ1c3RNb2QgPSAwLjk1OwogICAgICAgICAgICAgICAgY29udHJvbE1vZCA9IDAuOTsKICAgICAgICAgICAgICAgIHR1cmJ1bGVuY2UgPSAwLjAxNTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLndlYXRoZXIgPT09ICdzdG9ybScpIHsKICAgICAgICAgICAgICAgIHRocnVzdE1vZCA9IDAuODg7CiAgICAgICAgICAgICAgICBjb250cm9sTW9kID0gMC44OwogICAgICAgICAgICAgICAgdHVyYnVsZW5jZSA9IDAuMDM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJhbmRvbSB0dXJidWxlbmNlIGluIGJhZCB3ZWF0aGVyCiAgICAgICAgICAgIGlmICh0dXJidWxlbmNlID4gMCkgewogICAgICAgICAgICAgICAgaC52eCArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0dXJidWxlbmNlOwogICAgICAgICAgICAgICAgaC52eSArPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiB0dXJidWxlbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDb250cm9scyAtIGFmZmVjdGVkIGJ5IHdlYXRoZXIKICAgICAgICAgICAgaWYgKGtleXMudXApIHsKICAgICAgICAgICAgICAgIGgudnkgKz0gVEhSVVNUICogdGhydXN0TW9kOwogICAgICAgICAgICAgICAgaC5yb3RvclNwZWVkID0gTWF0aC5taW4oMC42NSwgaC5yb3RvclNwZWVkICsgMC4wMjUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaC5yb3RvclNwZWVkID0gTWF0aC5tYXgoMC4yNSwgaC5yb3RvclNwZWVkIC0gMC4wMDYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoa2V5cy5sZWZ0KSB7CiAgICAgICAgICAgICAgICBoLnRhcmdldFRpbHQgPSAtMC4zOwogICAgICAgICAgICAgICAgaC52eCAtPSBIT1JJWk9OVEFMX0FDQ0VMICogY29udHJvbE1vZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXlzLnJpZ2h0KSB7CiAgICAgICAgICAgICAgICBoLnRhcmdldFRpbHQgPSAwLjM7CiAgICAgICAgICAgICAgICBoLnZ4ICs9IEhPUklaT05UQUxfQUNDRUwgKiBjb250cm9sTW9kOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaC50YXJnZXRUaWx0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUm90b3Igc291bmQKICAgICAgICAgICAgc2V0Um90b3JTb3VuZChoLnJvdG9yU3BlZWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaC50aWx0ICs9IChoLnRhcmdldFRpbHQgLSBoLnRpbHQpICogVElMVF9TUEVFRDsKICAgICAgICAgICAgaC52eSArPSBHUkFWSVRZOwogICAgICAgICAgICBoLnZ4ICo9IEFJUl9SRVNJU1RBTkNFOwogICAgICAgICAgICBoLnZ5ICo9IEFJUl9SRVNJU1RBTkNFOwogICAgICAgICAgICAKICAgICAgICAgICAgaC52eCA9IE1hdGgubWF4KC1NQVhfU1BFRURfWCwgTWF0aC5taW4oTUFYX1NQRUVEX1gsIGgudngpKTsKICAgICAgICAgICAgaC52eSA9IE1hdGgubWF4KC1NQVhfU1BFRURfWSwgTWF0aC5taW4oTUFYX1NQRUVEX1ksIGgudnkpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1lZXRpbmdzIGhlYWR3aW5kIC0gU1RST05HIGVmZmVjdCBwdXNoaW5nIGFnYWluc3QgbW92ZW1lbnQKICAgICAgICAgICAgbGV0IGluTWVldGluZyA9IGZhbHNlOwogICAgICAgICAgICBHLm1lZXRpbmdzLmZvckVhY2goem9uZSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoaC54ID4gem9uZS54IC0gem9uZS53aWR0aC8yICYmIGgueCA8IHpvbmUueCArIHpvbmUud2lkdGgvMiAmJgogICAgICAgICAgICAgICAgICAgIGgueSA+IHpvbmUueSAtIHpvbmUuaGVpZ2h0LzIgJiYgaC55IDwgem9uZS55ICsgem9uZS5oZWlnaHQvMikgewogICAgICAgICAgICAgICAgICAgIGluTWVldGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2luZFN0ciA9IHpvbmUud2luZFN0cmVuZ3RoIHx8IDAuMjsKICAgICAgICAgICAgICAgICAgICAvLyBQdXNoIEFHQUlOU1QgY3VycmVudCB2ZWxvY2l0eSBkaXJlY3Rpb24KICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaC52eCkgPiAwLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaC52eCAtPSBNYXRoLnNpZ24oaC52eCkgKiB3aW5kU3RyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaC52eSkgPiAwLjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaC52eSAtPSBNYXRoLnNpZ24oaC52eSkgKiB3aW5kU3RyICogMC41OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBHZW5lcmFsIHNsb3dkb3duCiAgICAgICAgICAgICAgICAgICAgaC52eCAqPSAwLjk0OwogICAgICAgICAgICAgICAgICAgIGgudnkgKj0gMC45NjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQbGF5IHdpbmQgc291bmQgb2NjYXNpb25hbGx5IHdoZW4gaW4gbWVldGluZwogICAgICAgICAgICBpZiAoaW5NZWV0aW5nICYmIE1hdGgucmFuZG9tKCkgPCAwLjAyKSB7CiAgICAgICAgICAgICAgICBwbGF5U291bmQoJ3dpbmQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRW1haWwgc3Rvcm1zIC0gc3Ryb25nZXIgY2hhb3MKICAgICAgICAgICAgRy5lbWFpbFN0b3Jtcy5mb3JFYWNoKHN0b3JtID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gaC54IC0gc3Rvcm0ueCwgZHkgPSBoLnkgLSBzdG9ybS55OwogICAgICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR5KmR5KTsKICAgICAgICAgICAgICAgIGlmIChkaXN0IDwgc3Rvcm0ucmFkaXVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9yY2UgPSAoMSAtIGRpc3QgLyBzdG9ybS5yYWRpdXMpICogMC4xNTsKICAgICAgICAgICAgICAgICAgICBoLnZ4ICs9IE1hdGguY29zKHN0b3JtLndpbmRBbmdsZSkgKiBmb3JjZTsKICAgICAgICAgICAgICAgICAgICBoLnZ5ICs9IE1hdGguc2luKHN0b3JtLndpbmRBbmdsZSkgKiBmb3JjZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0b3JtLndpbmRBbmdsZSArPSAwLjAxNTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNb3ZlCiAgICAgICAgICAgIGNvbnN0IG5ld1ggPSBoLnggKyBoLnZ4OwogICAgICAgICAgICBjb25zdCBuZXdZID0gaC55ICsgaC52eTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEJ1aWxkaW5nIGNvbGxpc2lvbiAtIENBVVNFUyBIRUFWWSBEQU1BR0UKICAgICAgICAgICAgY29uc3QgY29sbGlzaW9uID0gY2hlY2tCdWlsZGluZ0NvbGxpc2lvbihuZXdYLCBuZXdZLCAxOCk7CiAgICAgICAgICAgIGlmIChjb2xsaXNpb24uaGl0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGVlZCA9IE1hdGguc3FydChoLnZ4ICogaC52eCArIGgudnkgKiBoLnZ5KTsKICAgICAgICAgICAgICAgIC8vIEFsd2F5cyBkYW1hZ2Ugb24gYnVpbGRpbmcgaGl0LCBtb3JlIGRhbWFnZSBhdCBoaWdoZXIgc3BlZWRzCiAgICAgICAgICAgICAgICBjb25zdCBiYXNlRGFtYWdlID0gY29sbGlzaW9uLmlzT2JzdGFjbGUgPyA4IDogNTsKICAgICAgICAgICAgICAgIGRhbWFnZUhlbGljb3B0ZXIoYmFzZURhbWFnZSArIHNwZWVkICogNCwgc3BlZWQgPiAyLjUgPyAnY3Jhc2gnIDogJ2J1bXAnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaC52eCAqPSAtMC4zNTsKICAgICAgICAgICAgICAgIGgudnkgKj0gLTAuMjU7CiAgICAgICAgICAgICAgICBpZiAoY29sbGlzaW9uLnNpZGUgPT09ICdsZWZ0JykgaC54IC09IDEwOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoY29sbGlzaW9uLnNpZGUgPT09ICdyaWdodCcpIGgueCArPSAxMDsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNvbGxpc2lvbi5idWlsZGluZykgewogICAgICAgICAgICAgICAgICAgIGgueCArPSBoLnggPCBjb2xsaXNpb24uYnVpbGRpbmcueCA/IC0xMCA6IDEwOwogICAgICAgICAgICAgICAgICAgIGgueSAtPSA4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaC54ID0gbmV3WDsKICAgICAgICAgICAgICAgIGgueSA9IG5ld1k7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdvcmxkIGJvdW5kcwogICAgICAgICAgICBoLnggPSBNYXRoLm1heCg0MCwgTWF0aC5taW4oRy53b3JsZFdpZHRoIC0gNDAsIGgueCkpOwogICAgICAgICAgICBoLnkgPSBNYXRoLm1heCg0MCwgTWF0aC5taW4oR1JPVU5EX1kgLSAxNSwgaC55KSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHcm91bmQgY29sbGlzaW9uIC0gbW9yZSBkYW1hZ2UKICAgICAgICAgICAgaWYgKGgueSA+PSBHUk9VTkRfWSAtIDE1KSB7CiAgICAgICAgICAgICAgICBoLnkgPSBHUk9VTkRfWSAtIDE1OwogICAgICAgICAgICAgICAgY29uc3QgaW1wYWN0U3BlZWQgPSBNYXRoLmFicyhoLnZ5KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGltcGFjdFNwZWVkID4gMS4yKSB7CiAgICAgICAgICAgICAgICAgICAgaC52eSA9IC1pbXBhY3RTcGVlZCAqIEJPVU5DRV9GQUNUT1I7CiAgICAgICAgICAgICAgICAgICAgaWYgKGltcGFjdFNwZWVkID4gMi41KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhbWFnZUhlbGljb3B0ZXIoKGltcGFjdFNwZWVkIC0gMikgKiA1LCAnYnVtcCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaC52eSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBoLnZ4ICo9IDAuODI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERlcGFydG1lbnQgYnVpbGRpbmcgcm9vZnRvcCBsYW5kaW5nCiAgICAgICAgICAgIGNvbnN0IGRlcHQgPSBHLmN1cnJlbnREZXB0OwogICAgICAgICAgICBjb25zdCBkZXB0Um9vZlkgPSBHUk9VTkRfWSAtIGRlcHQuaGVpZ2h0OwogICAgICAgICAgICBpZiAoaC55ID49IGRlcHRSb29mWSAtIDE4ICYmIGgueSA8IGRlcHRSb29mWSArIDggJiYKICAgICAgICAgICAgICAgIGgueCA+IGRlcHQueCAtIGRlcHQud2lkdGgvMiArIDE1ICYmIGgueCA8IGRlcHQueCArIGRlcHQud2lkdGgvMiAtIDE1KSB7CiAgICAgICAgICAgICAgICBpZiAoaC52eSA+IDApIHsKICAgICAgICAgICAgICAgICAgICBoLnkgPSBkZXB0Um9vZlkgLSAxODsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbXBhY3RTcGVlZCA9IE1hdGguYWJzKGgudnkpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbXBhY3RTcGVlZCA+IDEuNSkgewogICAgICAgICAgICAgICAgICAgICAgICBoLnZ5ID0gLWltcGFjdFNwZWVkICogQk9VTkNFX0ZBQ1RPUjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltcGFjdFNwZWVkID4gMykgZGFtYWdlSGVsaWNvcHRlcigoaW1wYWN0U3BlZWQgLSAyLjUpICogNCwgJ2J1bXAnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBoLnZ5ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaC52eCAqPSAwLjg4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBoLnJvdG9yQW5nbGUgKz0gaC5yb3RvclNwZWVkOwogICAgICAgICAgICBpZiAoaC5kYW1hZ2VGbGFzaCA+IDApIGguZGFtYWdlRmxhc2gtLTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNtb2tlIHdoZW4gZGFtYWdlZAogICAgICAgICAgICBpZiAoaC5oZWFsdGggPCA1MCkgewogICAgICAgICAgICAgICAgaC5zbW9rZVRpbWVyKys7CiAgICAgICAgICAgICAgICBpZiAoaC5zbW9rZVRpbWVyICUgNCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIEcucGFydGljbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICB4OiBoLnggKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxNSwKICAgICAgICAgICAgICAgICAgICAgICAgeTogaC55IC0gNSwKICAgICAgICAgICAgICAgICAgICAgICAgdng6IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgdnk6IC0wLjYgLSBNYXRoLnJhbmRvbSgpICogMC41LAogICAgICAgICAgICAgICAgICAgICAgICBsaWZlOiAzNSwgY29sb3I6ICcjNDQ0Jywgc2l6ZTogNCArIE1hdGgucmFuZG9tKCkgKiA0CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFJpdmFsIC0gbW9yZSBhZ2dyZXNzaXZlCiAgICAgICAgICAgIGlmIChHLnJpdmFsKSB1cGRhdGVSaXZhbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVXBkYXRlIHR1dG9yaWFsIHByb2dyZXNzCiAgICAgICAgICAgIGlmIChHLnR1dG9yaWFsTW9kZSkgdXBkYXRlVHV0b3JpYWxQcm9ncmVzcygpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUGlja3VwIGZyb20gZGVwYXJ0bWVudCBidWlsZGluZwogICAgICAgICAgICBpZiAoRy5waGFzZSA9PT0gJ3BpY2t1cCcpIHsKICAgICAgICAgICAgICAgIGlmIChoLnkgPD0gZGVwdFJvb2ZZIC0gMTIgJiYgaC55ID49IGRlcHRSb29mWSAtIDI4ICYmCiAgICAgICAgICAgICAgICAgICAgaC54ID4gZGVwdC54IC0gNDAgJiYgaC54IDwgZGVwdC54ICsgNDAgJiYKICAgICAgICAgICAgICAgICAgICBNYXRoLmFicyhoLnZ5KSA8IDEuMiAmJiBNYXRoLmFicyhoLnZ4KSA8IDEuMikgewogICAgICAgICAgICAgICAgICAgIGguY2FycnlpbmcgPSBHLmN1cnJlbnREZXB0OwogICAgICAgICAgICAgICAgICAgIEcucGhhc2UgPSAnZGVsaXZlcic7CiAgICAgICAgICAgICAgICAgICAgc3Bhd25QYXJ0aWNsZXMoaC54LCBkZXB0Um9vZlkgLSAxNSwgRy5jdXJyZW50RGVwdC5jb2xvciwgMTIpOwogICAgICAgICAgICAgICAgICAgIHBsYXlTb3VuZCgncGlja3VwJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKEcudHV0b3JpYWxNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dUdXRvcmlhbEhpbnQoMik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlQmFubmVyKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGVsaXZlciB0byB0ZWFtCiAgICAgICAgICAgICAgICBpZiAoaC55ID49IEdST1VORF9ZIC0gMjggJiYKICAgICAgICAgICAgICAgICAgICBoLnggPiBHLnRlYW0ueCAtIDQ1ICYmIGgueCA8IEcudGVhbS54ICsgNDUgJiYKICAgICAgICAgICAgICAgICAgICBNYXRoLmFicyhoLnZ5KSA8IDEuNSAmJiBNYXRoLmFicyhoLnZ4KSA8IDEuNSkgewogICAgICAgICAgICAgICAgICAgIHNwYXduUGFydGljbGVzKEcudGVhbS54LCBHUk9VTkRfWSAtIDIwLCBHLnRlYW0uY29sb3IsIDE4KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoRy50dXRvcmlhbE1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1R1dG9yaWFsSGludCgzKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYm9udXMgPSA1MCArIE1hdGguZmxvb3IoRy50aW1lKSAqIDEwICsgRy5zb3J0aWVOdW0gKiAyMDsKICAgICAgICAgICAgICAgICAgICAgICAgRy5wYXJ0aWNsZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4OiBHLnRlYW0ueCwgeTogR1JPVU5EX1kgLSA1NSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZ4OiAwLCB2eTogLTEuMywgbGlmZTogNTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnKycgKyBib251cywgY29sb3I6ICcjMmVjYzcxJwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChjb21wbGV0ZVNvcnRpZSwgMzAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgRy5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEaXN0YW5jZSBpbmRpY2F0b3IgKHNraXAgaW4gdHV0b3JpYWwpCiAgICAgICAgICAgIGlmICghRy50dXRvcmlhbE1vZGUpIHsKICAgICAgICAgICAgICAgIGlmIChHLnBoYXNlID09PSAncGlja3VwJykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3QgPSBNYXRoLnJvdW5kKEcuY3VycmVudERlcHQueCAtIGgueCk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rpc3RhbmNlVGV4dCcpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3QgPiAxMCA/IGAke2Rpc3R9bSB0byAke0cuY3VycmVudERlcHQubmFtZX1gIDogJ0xhbmQgb24gcm9vZiEnOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5yb3VuZChHLnRlYW0ueCAtIGgueCk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rpc3RhbmNlVGV4dCcpLnRleHRDb250ZW50ID0gCiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3QgPiAxMCA/IGAke2Rpc3R9bSB0byAke0cudGVhbS5uYW1lfWAgOiAnTGFuZCBub3chJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2FtZXJhCiAgICAgICAgICAgIEcuY2FtZXJhWCArPSAoaC54IC0gMzUwIC0gRy5jYW1lcmFYKSAqIDAuMDg7CiAgICAgICAgICAgIEcuY2FtZXJhWCA9IE1hdGgubWF4KDAsIE1hdGgubWluKEcud29ybGRXaWR0aCAtIDkwMCwgRy5jYW1lcmFYKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgd29ybGQKICAgICAgICAgICAgRy5jbG91ZHMuZm9yRWFjaChjID0+IHsKICAgICAgICAgICAgICAgIGMueCArPSBjLnNwZWVkOwogICAgICAgICAgICAgICAgaWYgKGMueCA+IEcud29ybGRXaWR0aCArIDYwKSBjLnggPSAtNjA7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgRy5lbWFpbFN0b3Jtcy5mb3JFYWNoKHMgPT4gcy5wYXJ0aWNsZXMuZm9yRWFjaChwID0+IHAuYW5nbGUgKz0gcC5zcGVlZCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgRy5wYXJ0aWNsZXMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgIHAueCArPSBwLnZ4OyBwLnkgKz0gcC52eTsKICAgICAgICAgICAgICAgIHAubGlmZS0tOwogICAgICAgICAgICAgICAgaWYgKCFwLnRleHQpIHsgcC52eSArPSAwLjA0OyBwLnZ4ICo9IDAuOTc7IH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEcucGFydGljbGVzID0gRy5wYXJ0aWNsZXMuZmlsdGVyKHAgPT4gcC5saWZlID4gMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBVcGRhdGUgVUkgKHNraXAgc29tZSBpbiB0dXRvcmlhbCkKICAgICAgICAgICAgaWYgKCFHLnR1dG9yaWFsTW9kZSkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpbWVyJykudGV4dENvbnRlbnQgPSBNYXRoLmNlaWwoRy50aW1lKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY29yZScpLnRleHRDb250ZW50ID0gRy50b3RhbFNjb3JlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJpdmFsKCkgewogICAgICAgICAgICBjb25zdCByID0gRy5yaXZhbCwgaCA9IEcuaGVsaWNvcHRlcjsKICAgICAgICAgICAgaWYgKCFyIHx8ICFoKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBkaXN0VG9QbGF5ZXIgPSBNYXRoLnNxcnQoKHIueCAtIGgueCkqKjIgKyAoci55IC0gaC55KSoqMik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdGF0ZSBtYWNoaW5lIC0gZ2V0cyBtb3JlIGFnZ3Jlc3NpdmUgaW4gbGF0ZXIgc29ydGllcwogICAgICAgICAgICBpZiAoaC5jYXJyeWluZyAmJiBkaXN0VG9QbGF5ZXIgPCAoci5pbnRlcmNlcHREaXN0YW5jZSB8fCAxNTApKSB7CiAgICAgICAgICAgICAgICByLnN0YXRlID0gJ2NoYXNlJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChyLmNhcnJ5aW5nKSB7CiAgICAgICAgICAgICAgICByLnN0YXRlID0gJ2ZsZWUnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGguY2FycnlpbmcgJiYgRy5zb3J0aWVOdW0gPj0gNCkgewogICAgICAgICAgICAgICAgLy8gSW4gbGF0ZXIgc29ydGllcywgd2lsbCBjaGFzZSBmcm9tIGFueXdoZXJlIGlmIHBsYXllciBoYXMgY2FyZ28KICAgICAgICAgICAgICAgIHIuc3RhdGUgPSAnY2hhc2UnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgci5zdGF0ZSA9ICdwYXRyb2wnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgdGFyZ2V0WCwgdGFyZ2V0WTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyLnN0YXRlID09PSAnY2hhc2UnKSB7CiAgICAgICAgICAgICAgICAvLyBDaGFzZSAtIHByZWRpY3Rpb24gc2NhbGVzIHdpdGggc29ydGllCiAgICAgICAgICAgICAgICBjb25zdCBwcmVkaWN0ID0gMyArIEcuc29ydGllTnVtICogMjsKICAgICAgICAgICAgICAgIHRhcmdldFggPSBoLnggKyBoLnZ4ICogcHJlZGljdDsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSBoLnkgKyBoLnZ5ICogKHByZWRpY3QgKiAwLjYpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dhcm5pbmdJbmRpY2F0b3InKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3YXJuaW5nVGV4dCcpLnRleHRDb250ZW50ID0gJ+KaoO+4jyBSaXZhbCBhcHByb2FjaGluZyEnOwogICAgICAgICAgICB9IGVsc2UgaWYgKHIuc3RhdGUgPT09ICdmbGVlJykgewogICAgICAgICAgICAgICAgdGFyZ2V0WCA9IHIueCA+IEcud29ybGRXaWR0aC8yID8gRy53b3JsZFdpZHRoIC0gNTAgOiA1MDsKICAgICAgICAgICAgICAgIHRhcmdldFkgPSA3MDsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3YXJuaW5nSW5kaWNhdG9yJykuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2FybmluZ1RleHQnKS50ZXh0Q29udGVudCA9ICfwn5qoIFJlc291cmNlIHN0b2xlbiEnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dhcm5pbmdJbmRpY2F0b3InKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgLy8gUGF0cm9sIG5lYXIgZGVwYXJ0bWVudAogICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHIueCAtIHIucGF0cm9sVGFyZ2V0KSA8IDgwKSB7CiAgICAgICAgICAgICAgICAgICAgci5wYXRyb2xUYXJnZXQgPSBHLmN1cnJlbnREZXB0LnggKyAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyNTA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRYID0gci5wYXRyb2xUYXJnZXQ7CiAgICAgICAgICAgICAgICB0YXJnZXRZID0gMTMwICsgTWF0aC5zaW4oRGF0ZS5ub3coKSAvIDgwMCkgKiAyNTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3BlZWQgc2NhbGVzIHdpdGggc29ydGllCiAgICAgICAgICAgIGNvbnN0IHNwZWVkID0gci5zdGF0ZSA9PT0gJ2NoYXNlJyA/IHIuYWdncmVzc2lvbiAqIDEuMyA6IHIuYWdncmVzc2lvbiAqIDAuNzsKICAgICAgICAgICAgY29uc3QgbWF4U3BkID0gci5tYXhTcGVlZCB8fCAzOwogICAgICAgICAgICAKICAgICAgICAgICAgci52eCArPSBNYXRoLnNpZ24odGFyZ2V0WCAtIHIueCkgKiBzcGVlZDsKICAgICAgICAgICAgci52eSArPSBNYXRoLnNpZ24odGFyZ2V0WSAtIHIueSkgKiBzcGVlZCAqIDAuNjsKICAgICAgICAgICAgci52eCAqPSAwLjk3OwogICAgICAgICAgICByLnZ5ICo9IDAuOTc7CiAgICAgICAgICAgIHIudnggPSBNYXRoLm1heCgtbWF4U3BkLCBNYXRoLm1pbihtYXhTcGQsIHIudngpKTsKICAgICAgICAgICAgci52eSA9IE1hdGgubWF4KC1tYXhTcGQgKiAwLjcsIE1hdGgubWluKG1heFNwZCAqIDAuNywgci52eSkpOwogICAgICAgICAgICAKICAgICAgICAgICAgci54ICs9IHIudng7CiAgICAgICAgICAgIHIueSArPSByLnZ5OwogICAgICAgICAgICByLnggPSBNYXRoLm1heCg1MCwgTWF0aC5taW4oRy53b3JsZFdpZHRoIC0gNTAsIHIueCkpOwogICAgICAgICAgICByLnkgPSBNYXRoLm1heCg2MCwgTWF0aC5taW4oR1JPVU5EX1kgLSA2MCwgci55KSk7CiAgICAgICAgICAgIAogICAgICAgICAgICByLnRpbHQgPSByLnZ4ICogMC4wNjsKICAgICAgICAgICAgci5yb3RvckFuZ2xlICs9IDAuNDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENvbGxpc2lvbiAtIHN0ZWFsIGNhcmdvCiAgICAgICAgICAgIGNvbnN0IGNvbGxEaXN0ID0gTWF0aC5zcXJ0KChyLnggLSBoLngpKioyICsgKHIueSAtIGgueSkqKjIpOwogICAgICAgICAgICBpZiAoY29sbERpc3QgPCAzOCAmJiBoLmNhcnJ5aW5nICYmICFyLmNhcnJ5aW5nKSB7CiAgICAgICAgICAgICAgICByLmNhcnJ5aW5nID0gaC5jYXJyeWluZzsKICAgICAgICAgICAgICAgIGguY2FycnlpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgaC52eCA9IChoLnggLSByLngpICogMC4xOwogICAgICAgICAgICAgICAgaC52eSA9IC0xLjU7CiAgICAgICAgICAgICAgICBkYW1hZ2VIZWxpY29wdGVyKDgsICdidW1wJyk7CiAgICAgICAgICAgICAgICBHLnBoYXNlID0gJ3BpY2t1cCc7CiAgICAgICAgICAgICAgICB1cGRhdGVCYW5uZXIoKTsKICAgICAgICAgICAgICAgIHNwYXduUGFydGljbGVzKChyLnggKyBoLngpLzIsIChyLnkgKyBoLnkpLzIsICcjZTc0YzNjJywgMTApOwogICAgICAgICAgICAgICAgcGxheVNvdW5kKCdidW1wJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyLmNhcnJ5aW5nICYmIHIuc3RhdGUgPT09ICdmbGVlJyAmJiAoci54IDwgNjAgfHwgci54ID4gRy53b3JsZFdpZHRoIC0gNjApKSB7CiAgICAgICAgICAgICAgICByLmNhcnJ5aW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHIuc3RhdGUgPSAncGF0cm9sJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBzcGF3blBhcnRpY2xlcyh4LCB5LCBjb2xvciwgY291bnQpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gY291bnQpICogTWF0aC5QSSAqIDI7CiAgICAgICAgICAgICAgICBHLnBhcnRpY2xlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICB4LCB5LAogICAgICAgICAgICAgICAgICAgIHZ4OiBNYXRoLmNvcyhhbmdsZSkgKiAoMS41ICsgTWF0aC5yYW5kb20oKSAqIDEuNSksCiAgICAgICAgICAgICAgICAgICAgdnk6IE1hdGguc2luKGFuZ2xlKSAqICgxLjUgKyBNYXRoLnJhbmRvbSgpICogMS41KSAtIDAuNSwKICAgICAgICAgICAgICAgICAgICBsaWZlOiAyOCwgY29sb3IsIHNpemU6IDIuNSArIE1hdGgucmFuZG9tKCkgKiAyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBkcmF3KCkgewogICAgICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIDkwMCwgNjAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNreSAtIGNoYW5nZXMgd2l0aCB3ZWF0aGVyCiAgICAgICAgICAgIGNvbnN0IHNreSA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCAwLCAwLCA2MDApOwogICAgICAgICAgICBpZiAoRy53ZWF0aGVyID09PSAnc3Rvcm0nKSB7CiAgICAgICAgICAgICAgICBza3kuYWRkQ29sb3JTdG9wKDAsICcjMmMzZTUwJyk7CiAgICAgICAgICAgICAgICBza3kuYWRkQ29sb3JTdG9wKDAuNSwgJyMzNDQ5NWUnKTsKICAgICAgICAgICAgICAgIHNreS5hZGRDb2xvclN0b3AoMSwgJyM1ZDZkN2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChHLndlYXRoZXIgPT09ICdyYWluJykgewogICAgICAgICAgICAgICAgc2t5LmFkZENvbG9yU3RvcCgwLCAnIzRhNmZhNScpOwogICAgICAgICAgICAgICAgc2t5LmFkZENvbG9yU3RvcCgwLjUsICcjNmI4Y2FlJyk7CiAgICAgICAgICAgICAgICBza3kuYWRkQ29sb3JTdG9wKDEsICcjOGZhNGJmJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBza3kuYWRkQ29sb3JTdG9wKDAsICcjNTQ5OWM3Jyk7CiAgICAgICAgICAgICAgICBza3kuYWRkQ29sb3JTdG9wKDAuNSwgJyM3ZmIzZDUnKTsKICAgICAgICAgICAgICAgIHNreS5hZGRDb2xvclN0b3AoMSwgJyNkNGU2ZjEnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gc2t5OwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgOTAwLCA2MDApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3VuIC0gaGlkZGVuIGluIGJhZCB3ZWF0aGVyCiAgICAgICAgICAgIGlmIChHLndlYXRoZXIgPT09ICdjbGVhcicpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHN1blggPSA4MjAsIHN1blkgPSA1NTsKICAgICAgICAgICAgICAgIGNvbnN0IHN1bkdyYWQgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoc3VuWCwgc3VuWSwgMCwgc3VuWCwgc3VuWSwgNDUpOwogICAgICAgICAgICAgICAgc3VuR3JhZC5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoMjU1LCAyNDAsIDE4MCwgMSknKTsKICAgICAgICAgICAgICAgIHN1bkdyYWQuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMjU1LCAyMDAsIDEwMCwgMC40KScpOwogICAgICAgICAgICAgICAgc3VuR3JhZC5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMjU1LCAyMDAsIDEwMCwgMCknKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBzdW5HcmFkOwogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LmFyYyhzdW5YLCBzdW5ZLCA0NSwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2xvdWRzIC0gZGFya2VyIGluIGJhZCB3ZWF0aGVyCiAgICAgICAgICAgIEcuY2xvdWRzLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBzeCA9IGMueCAtIEcuY2FtZXJhWDsKICAgICAgICAgICAgICAgIGlmIChzeCA+IC04MCAmJiBzeCA8IDk4MCkgewogICAgICAgICAgICAgICAgICAgIGlmIChHLndlYXRoZXIgPT09ICdzdG9ybScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDYwLCA2MCwgNzAsIDAuOSknOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoRy53ZWF0aGVyID09PSAncmFpbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDEyMCwgMTMwLCAxNDAsIDAuODUpJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMjU1LDI1NSwyNTUsMC44NSknOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhzeCwgYy55LCBjLnNpemUgKiAwLjUsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgICAgICAgICBjdHguYXJjKHN4ICsgYy5zaXplICogMC4zNSwgYy55IC0gYy5zaXplICogMC4xNSwgYy5zaXplICogMC40LCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhzeCArIGMuc2l6ZSAqIDAuNywgYy55LCBjLnNpemUgKiAwLjQ1LCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIYXphcmRzCiAgICAgICAgICAgIGRyYXdIYXphcmRzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBHcm91bmQKICAgICAgICAgICAgY29uc3QgZ3JvdW5kR3JhZCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCBHUk9VTkRfWSwgMCwgNjAwKTsKICAgICAgICAgICAgZ3JvdW5kR3JhZC5hZGRDb2xvclN0b3AoMCwgJyMyN2FlNjAnKTsKICAgICAgICAgICAgZ3JvdW5kR3JhZC5hZGRDb2xvclN0b3AoMSwgJyMxZTg0NDknKTsKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyb3VuZEdyYWQ7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCBHUk9VTkRfWSwgOTAwLCA2MCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMyZWNjNzEnOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDkwMDsgaSArPSAxMCkgewogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KGksIEdST1VORF9ZIC0gMiwgMiwgNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbWUgYmFzZSBoZWxpcGFkCiAgICAgICAgICAgIGNvbnN0IGhvbWVTWCA9IEcuaG9tZUJhc2UueCAtIEcuY2FtZXJhWDsKICAgICAgICAgICAgaWYgKGhvbWVTWCA+IC02MCAmJiBob21lU1ggPCA5NjApIHsKICAgICAgICAgICAgICAgIGRyYXdIb21lQmFzZShob21lU1gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBPYnN0YWNsZSBidWlsZGluZ3MKICAgICAgICAgICAgRy5vYnN0YWNsZXMuZm9yRWFjaChiID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHN4ID0gYi54IC0gRy5jYW1lcmFYOwogICAgICAgICAgICAgICAgaWYgKHN4ID4gLTgwICYmIHN4IDwgOTgwKSBkcmF3T2JzdGFjbGUoc3gsIGIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERlcGFydG1lbnQgYnVpbGRpbmdzCiAgICAgICAgICAgIEcuZGVwYXJ0bWVudEJ1aWxkaW5ncy5mb3JFYWNoKGRlcHQgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgc3ggPSBkZXB0LnggLSBHLmNhbWVyYVg7CiAgICAgICAgICAgICAgICBpZiAoc3ggPiAtMTAwICYmIHN4IDwgMTAwMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzVGFyZ2V0ID0gRy5waGFzZSA9PT0gJ3BpY2t1cCcgJiYgZGVwdCA9PT0gRy5jdXJyZW50RGVwdDsKICAgICAgICAgICAgICAgICAgICBkcmF3RGVwYXJ0bWVudEJ1aWxkaW5nKHN4LCBkZXB0LCBpc1RhcmdldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVhbQogICAgICAgICAgICBjb25zdCB0ZWFtU1ggPSBHLnRlYW0ueCAtIEcuY2FtZXJhWDsKICAgICAgICAgICAgaWYgKHRlYW1TWCA+IC04MCAmJiB0ZWFtU1ggPCA5ODApIHsKICAgICAgICAgICAgICAgIGRyYXdUZWFtKHRlYW1TWCwgRy5waGFzZSA9PT0gJ2RlbGl2ZXInKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUGFydGljbGVzCiAgICAgICAgICAgIEcucGFydGljbGVzLmZvckVhY2gocCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBzeCA9IHAueCAtIEcuY2FtZXJhWDsKICAgICAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IE1hdGgubWluKDEsIHAubGlmZSAvIDIwKTsKICAgICAgICAgICAgICAgIGlmIChwLnRleHQpIHsKICAgICAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDIwcHggU2Vnb2UgVUknOwogICAgICAgICAgICAgICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAncmdiYSgwLDAsMCwwLjYpJzsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gNDsKICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlVGV4dChwLnRleHQsIHN4LCBwLnkpOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBwLmNvbG9yOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dChwLnRleHQsIHN4LCBwLnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gcC5jb2xvcjsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmFyYyhzeCwgcC55LCBwLnNpemUgKiAocC5saWZlIC8gMjgpLCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IDE7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSaXZhbAogICAgICAgICAgICBpZiAoRy5yaXZhbCkgZHJhd1JpdmFsKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIZWxpY29wdGVyCiAgICAgICAgICAgIGlmIChHLmhlbGljb3B0ZXIgJiYgRy5oZWxpY29wdGVyLmhlYWx0aCA+IDApIGRyYXdIZWxpY29wdGVyKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSYWluIGVmZmVjdCAtIGRyYXduIG9uIHRvcAogICAgICAgICAgICBpZiAoRy53ZWF0aGVyICE9PSAnY2xlYXInICYmIEcucmFpbmRyb3BzKSB7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBHLndlYXRoZXIgPT09ICdzdG9ybScgPyAncmdiYSgyMDAsMjEwLDIyMCwwLjcpJyA6ICdyZ2JhKDE4MCwxOTAsMjAwLDAuNSknOwogICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IEcud2VhdGhlciA9PT0gJ3N0b3JtJyA/IDIgOiAxOwogICAgICAgICAgICAgICAgRy5yYWluZHJvcHMuZm9yRWFjaChkcm9wID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzeCA9IGRyb3AueCAtIEcuY2FtZXJhWDsKICAgICAgICAgICAgICAgICAgICBpZiAoc3ggPiAtMjAgJiYgc3ggPCA5MjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHN4LCBkcm9wLnkpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKHN4IC0gMiwgZHJvcC55ICsgZHJvcC5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIE1vdmUgcmFpbgogICAgICAgICAgICAgICAgICAgIGRyb3AueSArPSBkcm9wLnNwZWVkOwogICAgICAgICAgICAgICAgICAgIGRyb3AueCAtPSAxOyAgLy8gV2luZCBlZmZlY3QKICAgICAgICAgICAgICAgICAgICBpZiAoZHJvcC55ID4gR1JPVU5EX1kpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZHJvcC55ID0gLTIwOwogICAgICAgICAgICAgICAgICAgICAgICBkcm9wLnggPSBHLmNhbWVyYVggKyBNYXRoLnJhbmRvbSgpICogOTUwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBXZWF0aGVyIG92ZXJsYXkKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBHLndlYXRoZXIgPT09ICdzdG9ybScgPyAncmdiYSgwLDAsMCwwLjE1KScgOiAncmdiYSgwLDAsMCwwLjA4KSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgOTAwLCA2MDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXZWF0aGVyIGluZGljYXRvcgogICAgICAgICAgICBpZiAoRy53ZWF0aGVyICE9PSAnY2xlYXInKSB7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3JnYmEoMCwwLDAsMC43KSc7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMTAsIDEwMCwgOTAsIDI0KTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBHLndlYXRoZXIgPT09ICdzdG9ybScgPyAnI2U3NGMzYycgOiAnI2YzOWMxMic7CiAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDExcHggU2Vnb2UgVUknOwogICAgICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KEcud2VhdGhlciA9PT0gJ3N0b3JtJyA/ICfim4jvuI8gU1RPUk0nIDogJ/CfjKfvuI8gUkFJTicsIDU1LCAxMTYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUYXJnZXQgYXJyb3cKICAgICAgICAgICAgZHJhd1RhcmdldEFycm93KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBNaW5pbWFwCiAgICAgICAgICAgIGRyYXdNaW5pbWFwKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGRyYXdIb21lQmFzZShzeCkgewogICAgICAgICAgICAvLyBIZWxpcGFkIG9uIGdyb3VuZAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMyYzNlNTAnOwogICAgICAgICAgICBjdHguZmlsbFJlY3Qoc3ggLSA0MCwgR1JPVU5EX1kgLSA2LCA4MCwgOCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIIG1hcmtpbmcKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNmMzljMTInOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKHN4LCBHUk9VTkRfWSAtIDgsIDIwLCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2YzOWMxMic7CiAgICAgICAgICAgIGN0eC5mb250ID0gJ2JvbGQgMTZweCBBcmlhbCc7CiAgICAgICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCdIJywgc3gsIEdST1VORF9ZIC0gMyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMYWJlbAogICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDEwcHggU2Vnb2UgVUknOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMyYzNlNTAnOwogICAgICAgICAgICBjdHguZmlsbFRleHQoJ0hPTUUgQkFTRScsIHN4LCBHUk9VTkRfWSAtIDMyKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZHJhd09ic3RhY2xlKHN4LCBiKSB7CiAgICAgICAgICAgIGNvbnN0IHkgPSBHUk9VTkRfWSAtIGIuaGVpZ2h0OwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsMCwwLDAuMTIpJzsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHN4IC0gYi53aWR0aC8yICsgNCwgeSArIDQsIGIud2lkdGgsIGIuaGVpZ2h0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGdyYWQgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoc3ggLSBiLndpZHRoLzIsIDAsIHN4ICsgYi53aWR0aC8yLCAwKTsKICAgICAgICAgICAgZ3JhZC5hZGRDb2xvclN0b3AoMCwgJyM1ZDZkN2UnKTsKICAgICAgICAgICAgZ3JhZC5hZGRDb2xvclN0b3AoMC41LCAnIzg1OTI5ZScpOwogICAgICAgICAgICBncmFkLmFkZENvbG9yU3RvcCgxLCAnIzVkNmQ3ZScpOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZDsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHN4IC0gYi53aWR0aC8yLCB5LCBiLndpZHRoLCBiLmhlaWdodCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaW5kb3dzCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzRmYzNmNyc7CiAgICAgICAgICAgIGNvbnN0IHJvd3MgPSBNYXRoLmZsb29yKGIuaGVpZ2h0IC8gMjgpOwogICAgICAgICAgICBjb25zdCBjb2xzID0gTWF0aC5mbG9vcihiLndpZHRoIC8gMjApOwogICAgICAgICAgICBmb3IgKGxldCByID0gMDsgciA8IHJvd3M7IHIrKykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBjb2xzOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3Qoc3ggLSBiLndpZHRoLzIgKyA1ICsgYyAqIDIwLCB5ICsgMTAgKyByICogMjgsIDEyLCAxNik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzJjM2U1MCc7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdChzeCAtIGIud2lkdGgvMiAtIDIsIHkgLSA0LCBiLndpZHRoICsgNCwgNik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGRyYXdEZXBhcnRtZW50QnVpbGRpbmcoc3gsIGRlcHQsIGlzVGFyZ2V0KSB7CiAgICAgICAgICAgIGNvbnN0IHkgPSBHUk9VTkRfWSAtIGRlcHQuaGVpZ2h0OwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2hhZG93CiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgwLDAsMCwwLjE1KSc7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdChzeCAtIGRlcHQud2lkdGgvMiArIDYsIHkgKyA2LCBkZXB0LndpZHRoLCBkZXB0LmhlaWdodCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCdWlsZGluZyBib2R5IHdpdGggZGVwYXJ0bWVudCBjb2xvciB0aW50CiAgICAgICAgICAgIGNvbnN0IGJHcmFkID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KHN4IC0gZGVwdC53aWR0aC8yLCB5LCBzeCArIGRlcHQud2lkdGgvMiwgeSk7CiAgICAgICAgICAgIGJHcmFkLmFkZENvbG9yU3RvcCgwLCAnIzRhNTU2OCcpOwogICAgICAgICAgICBiR3JhZC5hZGRDb2xvclN0b3AoMC41LCAnIzcxODA5NicpOwogICAgICAgICAgICBiR3JhZC5hZGRDb2xvclN0b3AoMSwgJyM0YTU1NjgnKTsKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGJHcmFkOwogICAgICAgICAgICBjdHguZmlsbFJlY3Qoc3ggLSBkZXB0LndpZHRoLzIsIHksIGRlcHQud2lkdGgsIGRlcHQuaGVpZ2h0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdpbmRvd3MKICAgICAgICAgICAgY29uc3Qgcm93cyA9IE1hdGguZmxvb3IoZGVwdC5oZWlnaHQgLyAzMik7CiAgICAgICAgICAgIGNvbnN0IGNvbHMgPSBNYXRoLmZsb29yKGRlcHQud2lkdGggLyAyNCk7CiAgICAgICAgICAgIGZvciAobGV0IHIgPSAwOyByIDwgcm93czsgcisrKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IGNvbHM7IGMrKykgewogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzRmYzNmNyc7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHN4IC0gZGVwdC53aWR0aC8yICsgOCArIGMgKiAyNCwgeSArIDMwICsgciAqIDMyLCAxNiwgMjApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSb29mIHdpdGggaGVsaXBhZAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMyYzNlNTAnOwogICAgICAgICAgICBjdHguZmlsbFJlY3Qoc3ggLSBkZXB0LndpZHRoLzIgLSA0LCB5IC0gMTAsIGRlcHQud2lkdGggKyA4LCAxNCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEZXBhcnRtZW50IHNpZ24KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGRlcHQuY29sb3I7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdChzeCAtIDUwLCB5ICsgNiwgMTAwLCAyMik7CiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnd2hpdGUnOwogICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDExcHggU2Vnb2UgVUknOwogICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGN0eC5maWxsVGV4dChkZXB0Lm5hbWUudG9VcHBlckNhc2UoKSwgc3gsIHkgKyAyMSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIZWxpcGFkIG9uIHJvb2YKICAgICAgICAgICAgaWYgKGlzVGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAvLyBHbG93aW5nIHRhcmdldAogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKDQ2LCAyMDQsIDExMywgJHswLjQgKyBNYXRoLnNpbihEYXRlLm5vdygpLzE1MCkgKiAwLjJ9KWA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHN4LCB5IC0gNSwgNDUgKyBNYXRoLnNpbihEYXRlLm5vdygpLzEwMCkgKiA2LCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBBcnJvdwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMmVjYzcxJzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oc3gsIHkgLSA1MCk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHN4IC0gMTQsIHkgLSA2OCk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHN4ICsgMTQsIHkgLSA2OCk7CiAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDEycHggU2Vnb2UgVUknOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCfilrwgTEFORCBIRVJFJywgc3gsIHkgLSA3NSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGlzVGFyZ2V0ID8gJyMyZWNjNzEnIDogJyM3ZjhjOGQnOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gaXNUYXJnZXQgPyA0IDogMjsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguYXJjKHN4LCB5IC0gNSwgMjIsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGlzVGFyZ2V0ID8gJyMyZWNjNzEnIDogJyM3ZjhjOGQnOwogICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDE2cHggQXJpYWwnOwogICAgICAgICAgICBjdHguZmlsbFRleHQoJ0gnLCBzeCwgeSArIDEpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVzb3VyY2UgaWNvbiBmbG9hdGluZyBhYm92ZQogICAgICAgICAgICBjdHguZm9udCA9ICcyNHB4IEFyaWFsJzsKICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGRlcHQuaWNvbiwgc3gsIHkgLSAyOCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGRyYXdIYXphcmRzKCkgewogICAgICAgICAgICAvLyBNZWV0aW5ncyB3aXRoIFNUUk9ORyB2aXNpYmxlIHdpbmQKICAgICAgICAgICAgRy5tZWV0aW5ncy5mb3JFYWNoKHpvbmUgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgc3ggPSB6b25lLnggLSBHLmNhbWVyYVg7CiAgICAgICAgICAgICAgICBpZiAoc3ggPiAtMTAwICYmIHN4IDwgMTAwMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHB1bHNlID0gTWF0aC5zaW4oRGF0ZS5ub3coKSAvIDI1MCArIHpvbmUucGhhc2UpICogMC4yICsgMC44OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpIC8gMTUwOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIE91dGVyIGdsb3cKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gYHJnYmEoMTU1LCA4OSwgMTgyLCAkezAuMiAqIHB1bHNlfSlgOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguZWxsaXBzZShzeCwgem9uZS55LCB6b25lLndpZHRoLzIgKyAyMCwgem9uZS5oZWlnaHQvMiArIDE1LCAwLCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBNYWluIHpvbmUKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gYHJnYmEoMTQyLCA2OCwgMTczLCAkezAuNCAqIHB1bHNlfSlgOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICBjdHguZWxsaXBzZShzeCwgem9uZS55LCB6b25lLndpZHRoLzIsIHpvbmUuaGVpZ2h0LzIsIDAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEJvcmRlcgogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGByZ2JhKDE1NSwgODksIDE4MiwgJHswLjcgKiBwdWxzZX0pYDsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsKICAgICAgICAgICAgICAgICAgICBjdHguc2V0TGluZURhc2goWzgsIDRdKTsKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmVsbGlwc2Uoc3gsIHpvbmUueSwgem9uZS53aWR0aC8yLCB6b25lLmhlaWdodC8yLCAwLCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5zZXRMaW5lRGFzaChbXSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gQW5pbWF0ZWQgd2luZCBhcnJvd3MgLSBtb3JlIG9mIHRoZW0sIGJpZ2dlcgogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGByZ2JhKDI1NSwgMjU1LCAyNTUsICR7MC44ICogcHVsc2V9KWA7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDM7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgcm93ID0gLTE7IHJvdyA8PSAxOyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gKHRpbWUgKyBpICogMC41KSAlIDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3eCA9IHN4IC0gem9uZS53aWR0aC8yICsgMTUgKyBvZmZzZXQgKiAoem9uZS53aWR0aC8zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHd5ID0gem9uZS55ICsgcm93ICogMTggKyBNYXRoLnNpbih0aW1lICsgaSkgKiA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHd4ICsgMTgsIHd5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8od3gsIHd5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXJyb3cgaGVhZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh3eCwgd3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh3eCArIDcsIHd5IC0gNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHd4LCB3eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKHd4ICsgNywgd3kgKyA1KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBNZWV0aW5nIGljb25zCiAgICAgICAgICAgICAgICAgICAgY3R4LmZvbnQgPSAnMTZweCBBcmlhbCc7CiAgICAgICAgICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dCgn8J+Xo++4jycsIHN4IC0gMjUsIHpvbmUueSArIDUpOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dCgn8J+TiycsIHN4LCB6b25lLnkgKyA1KTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFRleHQoJ/Cfl6PvuI8nLCBzeCArIDI1LCB6b25lLnkgKyA1KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBMYWJlbHMKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3doaXRlJzsKICAgICAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDExcHggU2Vnb2UgVUknOwogICAgICAgICAgICAgICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICdyZ2JhKDAsMCwwLDAuOCknOwogICAgICAgICAgICAgICAgICAgIGN0eC5zaGFkb3dCbHVyID0gNDsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFRleHQoJ01FRVRJTkcgSU4gUFJPR1JFU1MnLCBzeCwgem9uZS55IC0gem9uZS5oZWlnaHQvMiArIDEyKTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmMzljMTInOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dCgn4pqg77iPIEhFQURXSU5EIOKaoO+4jycsIHN4LCB6b25lLnkgKyB6b25lLmhlaWdodC8yIC0gNSk7CiAgICAgICAgICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEVtYWlsIHN0b3JtcwogICAgICAgICAgICBHLmVtYWlsU3Rvcm1zLmZvckVhY2goc3Rvcm0gPT4gewogICAgICAgICAgICAgICAgY29uc3Qgc3ggPSBzdG9ybS54IC0gRy5jYW1lcmFYOwogICAgICAgICAgICAgICAgaWYgKHN4ID4gLTEwMCAmJiBzeCA8IDEwMDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBTd2lybGluZyBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JhZCA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChzeCwgc3Rvcm0ueSwgMCwgc3gsIHN0b3JtLnksIHN0b3JtLnJhZGl1cyk7CiAgICAgICAgICAgICAgICAgICAgZ3JhZC5hZGRDb2xvclN0b3AoMCwgJ3JnYmEoNTIsIDE1MiwgMjE5LCAwLjQpJyk7CiAgICAgICAgICAgICAgICAgICAgZ3JhZC5hZGRDb2xvclN0b3AoMC43LCAncmdiYSg1MiwgMTUyLCAyMTksIDAuMiknKTsKICAgICAgICAgICAgICAgICAgICBncmFkLmFkZENvbG9yU3RvcCgxLCAncmdiYSg1MiwgMTUyLCAyMTksIDApJyk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgIGN0eC5hcmMoc3gsIHN0b3JtLnksIHN0b3JtLnJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gUm90YXRpbmcgZW1haWxzCiAgICAgICAgICAgICAgICAgICAgY3R4LmZvbnQgPSAnMTRweCBBcmlhbCc7CiAgICAgICAgICAgICAgICAgICAgY3R4Lmdsb2JhbEFscGhhID0gMC44NTsKICAgICAgICAgICAgICAgICAgICBzdG9ybS5wYXJ0aWNsZXMuZm9yRWFjaChwID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXggPSBzeCArIE1hdGguY29zKHAuYW5nbGUpICogcC5kaXN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleSA9IHN0b3JtLnkgKyBNYXRoLnNpbihwLmFuZ2xlKSAqIHAuZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCfwn5OnJywgZXggLSA3LCBleSArIDUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IDE7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTGFiZWwKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMzNDk4ZGInOwogICAgICAgICAgICAgICAgICAgIGN0eC5mb250ID0gJ2JvbGQgMTBweCBTZWdvZSBVSSc7CiAgICAgICAgICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dCgnRU1BSUwgU1RPUk0nLCBzeCwgc3Rvcm0ueSArIHN0b3JtLnJhZGl1cyArIDEyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGRyYXdUZWFtKHN4LCBpc1RhcmdldCkgewogICAgICAgICAgICBjb25zdCB5ID0gR1JPVU5EX1k7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNUYXJnZXQpIHsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBgcmdiYSg0NiwgMjA0LCAxMTMsICR7MC4zNSArIE1hdGguc2luKERhdGUubm93KCkvMTUwKSAqIDAuMTV9KWA7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguYXJjKHN4LCB5IC0gMTAsIDUwICsgTWF0aC5zaW4oRGF0ZS5ub3coKS8xMDApICogNiwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMmVjYzcxJzsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oc3gsIHkgLSA2NSk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHN4IC0gMTIsIHkgLSA4Mik7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHN4ICsgMTIsIHkgLSA4Mik7CiAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDExcHggU2Vnb2UgVUknOwogICAgICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCfilrwgREVMSVZFUicsIHN4LCB5IC0gODgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gaXNUYXJnZXQgPyAnIzJlY2M3MScgOiBHLnRlYW0uY29sb3I7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdChzeCAtIDM1LCB5IC0gNCwgNzAsIDYpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVhbSBtZW1iZXJzCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBweCA9IHN4IC0gMTggKyBpICogMTg7CiAgICAgICAgICAgICAgICBjb25zdCBweSA9IHkgLSA2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNmZmVhYTcnOwogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LmFyYyhweCwgcHkgLSAyNiwgNSwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gRy50ZWFtLmNvbG9yOwogICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHB4LCBweSAtIDIxKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8ocHgsIHB5IC0gOCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHB4IC0gNywgcHkgLSAxNik7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHB4ICsgNywgcHkgLSAxNik7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHB4LCBweSAtIDgpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhweCAtIDUsIHB5KTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8ocHgsIHB5IC0gOCk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKHB4ICsgNSwgcHkpOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDExcHggU2Vnb2UgVUknOwogICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ2NlbnRlcic7CiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBHLnRlYW0uY29sb3I7CiAgICAgICAgICAgIGN0eC5maWxsVGV4dChHLnRlYW0ubmFtZSwgc3gsIHkgLSA0MCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZ1bmN0aW9uIGRyYXdIZWxpY29wdGVyKCkgewogICAgICAgICAgICBjb25zdCBoID0gRy5oZWxpY29wdGVyOwogICAgICAgICAgICBjb25zdCBzeCA9IGgueCAtIEcuY2FtZXJhWDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIERldGVybWluZSBmYWNpbmcgZGlyZWN0aW9uIGJhc2VkIG9uIHZlbG9jaXR5CiAgICAgICAgICAgIC8vIEhlbGljb3B0ZXIgaXMgZHJhd24gZmFjaW5nIExFRlQgYnkgZGVmYXVsdCwgc28gZmxpcCB3aGVuIGdvaW5nIFJJR0hUCiAgICAgICAgICAgIGlmIChoLmZhY2luZyA9PT0gdW5kZWZpbmVkKSBoLmZhY2luZyA9IC0xOwogICAgICAgICAgICBpZiAoaC52eCA+IDAuNSkgaC5mYWNpbmcgPSAtMTsgICAgICAvLyBGbHlpbmcgcmlnaHQsIGZsaXAgdG8gZmFjZSByaWdodAogICAgICAgICAgICBlbHNlIGlmIChoLnZ4IDwgLTAuNSkgaC5mYWNpbmcgPSAxOyAvLyBGbHlpbmcgbGVmdCwgbm8gZmxpcCAoZGVmYXVsdCBmYWNlcyBsZWZ0KQogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsMCwwLDAuMjUpJzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguZWxsaXBzZShzeCwgR1JPVU5EX1kgKyAyLCAxOCwgNSwgMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZShzeCwgaC55KTsKICAgICAgICAgICAgY3R4LnNjYWxlKGguZmFjaW5nLCAxKTsgIC8vIEZsaXAgaG9yaXpvbnRhbGx5IGJhc2VkIG9uIGRpcmVjdGlvbgogICAgICAgICAgICBjdHgucm90YXRlKGgudGlsdCAqIGguZmFjaW5nKTsgIC8vIFRpbHQgbWF0Y2hlcyBkaXJlY3Rpb24KICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICdyZ2JhKDAsMCwwLDAuNCknOwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDY7CiAgICAgICAgICAgIGN0eC5zaGFkb3dPZmZzZXRYID0gMiAqIGguZmFjaW5nOwogICAgICAgICAgICBjdHguc2hhZG93T2Zmc2V0WSA9IDI7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaC5kYW1hZ2VGbGFzaCA+IDAgJiYgaC5kYW1hZ2VGbGFzaCAlIDMgPCAyKSBjdHguZ2xvYmFsQWxwaGEgPSAwLjY7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUYWlsIC0gd2hpdGUKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZWNmMGYxJzsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNiZGMzYzcnOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMTsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKDEwLCAtMik7CiAgICAgICAgICAgIGN0eC5saW5lVG8oNDgsIC01KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyg1MCwgMCk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oNDgsIDUpOwogICAgICAgICAgICBjdHgubGluZVRvKDEwLCAyKTsKICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBUYWlsIGZpbiAtIHJlZAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlNzRjM2MnOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oNDQsIC01KTsKICAgICAgICAgICAgY3R4LmxpbmVUbyg1NCwgLTIyKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyg1NCwgLTMpOwogICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAndHJhbnNwYXJlbnQnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGFpbCByb3RvcgogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKDUwLCAtMTIpOwogICAgICAgICAgICBjdHgucm90YXRlKGgucm90b3JBbmdsZSAqIDMpOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMyYzNlNTAnOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoLTgsIC0yLCAxNiwgNCk7CiAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBCb2R5IC0gYnJpZ2h0IHdoaXRlCiAgICAgICAgICAgIGN0eC5zaGFkb3dDb2xvciA9ICdyZ2JhKDAsMCwwLDAuMyknOwogICAgICAgICAgICBjdHguc2hhZG93Qmx1ciA9IDU7CiAgICAgICAgICAgIGNvbnN0IGJvZHlHcmFkID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KC0zLCAtNSwgMCwgMCwgMCwgMjYpOwogICAgICAgICAgICBib2R5R3JhZC5hZGRDb2xvclN0b3AoMCwgJyNmZmZmZmYnKTsKICAgICAgICAgICAgYm9keUdyYWQuYWRkQ29sb3JTdG9wKDAuNywgJyNlY2YwZjEnKTsKICAgICAgICAgICAgYm9keUdyYWQuYWRkQ29sb3JTdG9wKDEsICcjYmRjM2M3Jyk7CiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBib2R5R3JhZDsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguZWxsaXBzZSgwLCAwLCAyNCwgMTUsIDAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyM5NWE1YTYnOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMS41OwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguc2hhZG93Q29sb3IgPSAndHJhbnNwYXJlbnQnOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUmVkIHN0cmlwZQogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNlNzRjM2MnOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoLTIwLCAtMiwgNDAsIDQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ29ja3BpdAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyM4NWMxZTknOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5lbGxpcHNlKC03LCAtMiwgMTMsIDEwLCAtMC4xLCBNYXRoLlBJICogMS4xLCBNYXRoLlBJICogMS45NSk7CiAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICcjNWRhZGUyJzsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgyNTUsMjU1LDI1NSwwLjQpJzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguZWxsaXBzZSgtMTAsIC02LCA1LCAzLCAtMC4zLCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTa2lkcwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAnIzJjM2U1MCc7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oLTE2LCAxMyk7IGN0eC5saW5lVG8oLTE2LCAxOSk7IGN0eC5saW5lVG8oMTQsIDE5KTsgY3R4LmxpbmVUbygxNCwgMTMpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygtOCwgMTUpOyBjdHgubGluZVRvKC04LCAxOSk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oNiwgMTUpOyBjdHgubGluZVRvKDYsIDE5KTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUm90b3IgbWFzdAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyM3ZjhjOGQnOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoLTMsIC0xOCwgNiwgNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBSb3RvciBibHVyCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgxNTAsMTUwLDE1MCwwLjI1KSc7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmVsbGlwc2UoMCwgLTIwLCA0MCwgNywgMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQmxhZGVzCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnIzJjM2U1MCc7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhbmcgPSBoLnJvdG9yQW5nbGUgKyBpICogTWF0aC5QSTsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5lbGxpcHNlKE1hdGguY29zKGFuZykgKiAzOCwgLTIwICsgTWF0aC5zaW4oYW5nKSAqIDUsIDYsIDIuNSwgYW5nLCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDYXJnbwogICAgICAgICAgICBpZiAoaC5jYXJyeWluZykgewogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGguY2FycnlpbmcuY29sb3I7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKC05LCAxNyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKC05LCAyOSk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKDksIDI5KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oOSwgMTcpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyg1LCAxNyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKDMsIDE5KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oLTMsIDE5KTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oLTUsIDE3KTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJ3doaXRlJzsKICAgICAgICAgICAgICAgIGN0eC5mb250ID0gJzhweCBBcmlhbCc7CiAgICAgICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ2NlbnRlcic7CiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LnNjYWxlKGguZmFjaW5nLCAxKTsgIC8vIEZsaXAgaWNvbiBiYWNrIHNvIGl0J3Mgbm90IG1pcnJvcmVkCiAgICAgICAgICAgICAgICBjdHguZmlsbFRleHQoaC5jYXJyeWluZy5pY29uLCAwLCAyNik7CiAgICAgICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguZ2xvYmFsQWxwaGEgPSAxOwogICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBkcmF3Uml2YWwoKSB7CiAgICAgICAgICAgIGNvbnN0IHIgPSBHLnJpdmFsOwogICAgICAgICAgICBjb25zdCBzeCA9IHIueCAtIEcuY2FtZXJhWDsKICAgICAgICAgICAgaWYgKHN4IDwgLTYwIHx8IHN4ID4gOTYwKSByZXR1cm47CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBEZXRlcm1pbmUgZmFjaW5nIGRpcmVjdGlvbiBiYXNlZCBvbiB2ZWxvY2l0eQogICAgICAgICAgICAvLyBIZWxpY29wdGVyIGRyYXduIGZhY2luZyBsZWZ0IGJ5IGRlZmF1bHQsIGZsaXAgd2hlbiBnb2luZyByaWdodAogICAgICAgICAgICBpZiAoci5mYWNpbmcgPT09IHVuZGVmaW5lZCkgci5mYWNpbmcgPSAxOwogICAgICAgICAgICBpZiAoci52eCA+IDAuMykgci5mYWNpbmcgPSAtMTsgICAgICAvLyBGbHlpbmcgcmlnaHQsIGZsaXAgdG8gZmFjZSByaWdodAogICAgICAgICAgICBlbHNlIGlmIChyLnZ4IDwgLTAuMykgci5mYWNpbmcgPSAxOyAvLyBGbHlpbmcgbGVmdCwgbm8gZmxpcAogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZShzeCwgci55KTsKICAgICAgICAgICAgY3R4LnNjYWxlKHIuZmFjaW5nLCAxKTsKICAgICAgICAgICAgY3R4LnJvdGF0ZShyLnRpbHQgKiByLmZhY2luZyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyNjMDM5MmInOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oOCwgLTEuNSk7IGN0eC5saW5lVG8oMzUsIC00KTsgY3R4LmxpbmVUbygzNSwgNCk7IGN0eC5saW5lVG8oOCwgMS41KTsKICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjOTIyYjIxJzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKDMyLCAtNCk7IGN0eC5saW5lVG8oNDAsIC0xNik7IGN0eC5saW5lVG8oNDAsIC0yKTsKICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZTc0YzNjJzsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguZWxsaXBzZSgwLCAwLCAxOCwgMTEsIDAsIDAsIE1hdGguUEkgKiAyKTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2Y1YjdiMSc7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmVsbGlwc2UoLTQsIC0xLCA5LCA2LCAtMC4xLCBNYXRoLlBJICogMS4yLCBNYXRoLlBJICogMS45KTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAncmdiYSgxMDAsMTAwLDEwMCwwLjI1KSc7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4LmVsbGlwc2UoMCwgLTEzLCAyOCwgNCwgMCwgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHIuY2FycnlpbmcpIHsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSByLmNhcnJ5aW5nLmNvbG9yOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KC02LCAxMiwgMTIsIDkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyM5MjJiMjEnOwogICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDhweCBTZWdvZSBVSSc7CiAgICAgICAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgICAgICAgY3R4LnNjYWxlKHIuZmFjaW5nLCAxKTsgIC8vIEZsaXAgdGV4dCBiYWNrIHNvIGl0J3MgcmVhZGFibGUKICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCdSSVZBTCcsIDAsIC0yMik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmdW5jdGlvbiBkcmF3VGFyZ2V0QXJyb3coKSB7CiAgICAgICAgICAgIGlmICghRy5oZWxpY29wdGVyKSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGggPSBHLmhlbGljb3B0ZXI7CiAgICAgICAgICAgIAogICAgICAgICAgICBsZXQgdGFyZ2V0WDsKICAgICAgICAgICAgbGV0IHRhcmdldENvbG9yOwogICAgICAgICAgICBsZXQgdGFyZ2V0TmFtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChHLnBoYXNlID09PSAncGlja3VwJykgewogICAgICAgICAgICAgICAgdGFyZ2V0WCA9IEcuY3VycmVudERlcHQueDsKICAgICAgICAgICAgICAgIHRhcmdldENvbG9yID0gRy5jdXJyZW50RGVwdC5jb2xvcjsKICAgICAgICAgICAgICAgIHRhcmdldE5hbWUgPSBHLmN1cnJlbnREZXB0Lm5hbWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXRYID0gRy50ZWFtLng7CiAgICAgICAgICAgICAgICB0YXJnZXRDb2xvciA9IEcudGVhbS5jb2xvcjsKICAgICAgICAgICAgICAgIHRhcmdldE5hbWUgPSBHLnRlYW0ubmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IHRhcmdldFggLSBHLmNhbWVyYVg7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoc2NyZWVuWCA8IDYwKSB7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gdGFyZ2V0Q29sb3I7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDE4LCAyODApOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyg0MCwgMjYyKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oNDAsIDI5OCk7CiAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDExcHggU2Vnb2UgVUknOwogICAgICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdsZWZ0JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnd2hpdGUnOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VUZXh0KHRhcmdldE5hbWUsIDQ1LCAyODQpOwogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KHRhcmdldE5hbWUsIDQ1LCAyODQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNjcmVlblggPiA4NDApIHsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0YXJnZXRDb2xvcjsKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oODgyLCAyODApOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyg4NjAsIDI2Mik7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKDg2MCwgMjk4KTsKICAgICAgICAgICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN0eC5mb250ID0gJ2JvbGQgMTFweCBTZWdvZSBVSSc7CiAgICAgICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ3JpZ2h0JzsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSAnd2hpdGUnOwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwwLDAsMC41KSc7CiAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VUZXh0KHRhcmdldE5hbWUsIDg1NSwgMjg0KTsKICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dCh0YXJnZXROYW1lLCA4NTUsIDI4NCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZHJhd01pbmltYXAoKSB7CiAgICAgICAgICAgIG1pbmltYXBDdHguY2xlYXJSZWN0KDAsIDAsIDIwMCwgNTApOwogICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGxTdHlsZSA9ICdyZ2JhKDAsMCwwLDAuOCknOwogICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGxSZWN0KDAsIDAsIDIwMCwgNTApOwogICAgICAgICAgICAKICAgICAgICAgICAgbWluaW1hcEN0eC5maWxsU3R5bGUgPSAnIzIyOTk1NCc7CiAgICAgICAgICAgIG1pbmltYXBDdHguZmlsbFJlY3QoMCwgNDQsIDIwMCwgNik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBzY2FsZSA9IDIwMCAvIEcud29ybGRXaWR0aDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhvbWUgYmFzZQogICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGxTdHlsZSA9ICcjZjM5YzEyJzsKICAgICAgICAgICAgbWluaW1hcEN0eC5maWxsUmVjdChHLmhvbWVCYXNlLnggKiBzY2FsZSAtIDQsIDQwLCA4LCA0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9ic3RhY2xlcwogICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGxTdHlsZSA9ICcjN2Y4YzhkJzsKICAgICAgICAgICAgRy5vYnN0YWNsZXMuZm9yRWFjaChiID0+IHsKICAgICAgICAgICAgICAgIG1pbmltYXBDdHguZmlsbFJlY3QoYi54ICogc2NhbGUgLSAyLCAzNiwgNCwgOCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRGVwYXJ0bWVudCBidWlsZGluZ3MKICAgICAgICAgICAgRy5kZXBhcnRtZW50QnVpbGRpbmdzLmZvckVhY2goZGVwdCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpc1RhcmdldCA9IEcucGhhc2UgPT09ICdwaWNrdXAnICYmIGRlcHQgPT09IEcuY3VycmVudERlcHQ7CiAgICAgICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGxTdHlsZSA9IGlzVGFyZ2V0ID8gJyMyZWNjNzEnIDogZGVwdC5jb2xvcjsKICAgICAgICAgICAgICAgIG1pbmltYXBDdHguZmlsbFJlY3QoZGVwdC54ICogc2NhbGUgLSA1LCAyOCwgMTAsIDE2KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGlzVGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgbWluaW1hcEN0eC5zdHJva2VTdHlsZSA9ICcjMmVjYzcxJzsKICAgICAgICAgICAgICAgICAgICBtaW5pbWFwQ3R4LmxpbmVXaWR0aCA9IDE7CiAgICAgICAgICAgICAgICAgICAgbWluaW1hcEN0eC5zdHJva2VSZWN0KGRlcHQueCAqIHNjYWxlIC0gNywgMjYsIDE0LCAyMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVGVhbQogICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGxTdHlsZSA9IEcucGhhc2UgPT09ICdkZWxpdmVyJyA/ICcjMmVjYzcxJyA6IEcudGVhbS5jb2xvcjsKICAgICAgICAgICAgbWluaW1hcEN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgbWluaW1hcEN0eC5hcmMoRy50ZWFtLnggKiBzY2FsZSwgNDIsIEcucGhhc2UgPT09ICdkZWxpdmVyJyA/IDUgOiAzLCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgIG1pbmltYXBDdHguZmlsbCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEcucGhhc2UgPT09ICdkZWxpdmVyJykgewogICAgICAgICAgICAgICAgbWluaW1hcEN0eC5zdHJva2VTdHlsZSA9ICcjMmVjYzcxJzsKICAgICAgICAgICAgICAgIG1pbmltYXBDdHgubGluZVdpZHRoID0gMTsKICAgICAgICAgICAgICAgIG1pbmltYXBDdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBtaW5pbWFwQ3R4LmFyYyhHLnRlYW0ueCAqIHNjYWxlLCA0MiwgNywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgbWluaW1hcEN0eC5zdHJva2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUml2YWwKICAgICAgICAgICAgaWYgKEcucml2YWwpIHsKICAgICAgICAgICAgICAgIG1pbmltYXBDdHguZmlsbFN0eWxlID0gJyNlNzRjM2MnOwogICAgICAgICAgICAgICAgbWluaW1hcEN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIG1pbmltYXBDdHguYXJjKEcucml2YWwueCAqIHNjYWxlLCAxOCwgMywgMCwgTWF0aC5QSSAqIDIpOwogICAgICAgICAgICAgICAgbWluaW1hcEN0eC5maWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFBsYXllcgogICAgICAgICAgICBpZiAoRy5oZWxpY29wdGVyKSB7CiAgICAgICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGxTdHlsZSA9ICcjZmZmJzsKICAgICAgICAgICAgICAgIG1pbmltYXBDdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBtaW5pbWFwQ3R4LmFyYyhHLmhlbGljb3B0ZXIueCAqIHNjYWxlLCAxMiArIChHLmhlbGljb3B0ZXIueSAvIEdST1VORF9ZKSAqIDMwLCA0LCAwLCBNYXRoLlBJICogMik7CiAgICAgICAgICAgICAgICBtaW5pbWFwQ3R4LmZpbGwoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gVmlld3BvcnQKICAgICAgICAgICAgbWluaW1hcEN0eC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwyNTUsMjU1LDAuNCknOwogICAgICAgICAgICBtaW5pbWFwQ3R4LmxpbmVXaWR0aCA9IDE7CiAgICAgICAgICAgIG1pbmltYXBDdHguc3Ryb2tlUmVjdChHLmNhbWVyYVggKiBzY2FsZSwgMCwgOTAwICogc2NhbGUsIDUwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gZ2FtZUxvb3AodGltZXN0YW1wKSB7CiAgICAgICAgICAgIGNvbnN0IGR0ID0gTWF0aC5taW4oMzIsIHRpbWVzdGFtcCAtIChHLmxhc3RUaW1lc3RhbXAgfHwgdGltZXN0YW1wKSk7CiAgICAgICAgICAgIEcubGFzdFRpbWVzdGFtcCA9IHRpbWVzdGFtcDsKICAgICAgICAgICAgdXBkYXRlKGR0KTsKICAgICAgICAgICAgZHJhdygpOwogICAgICAgICAgICBpZiAoRy5ydW5uaW5nKSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZ2FtZUxvb3ApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBIaWRlIFVJIGluaXRpYWxseQogICAgICAgIFsnc29ydGllQmFubmVyJywgJ2hlYWx0aEJhcicsICdoZWFsdGhMYWJlbCcsICdkaXN0YW5jZUluZGljYXRvcicsICdtaW5pbWFwJywgJ3dhcm5pbmdJbmRpY2F0b3InLCAnc291bmRUb2dnbGUnXS5mb3JFYWNoKGlkID0+IHsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfSk7CiAgICAKICAgICAgICAvLyAtLS0tIFBhcmVudCBpbnRlZ3JhdGlvbiAoZW1iZWRkZWQgdmlhIGJhc2U2NCkgLS0tLQogICAgICAgIGZ1bmN0aW9uIHNlbmRUb1BhcmVudChwYXlsb2FkKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LnBhcmVudCAmJiB3aW5kb3cucGFyZW50ICE9PSB3aW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHBheWxvYWQsICcqJyk7IC8vIGRhdGE6IGlmcmFtZXMgaGF2ZSBvcmlnaW4gIm51bGwiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+Cg==";

    function showBudgetMeeting() {
        showPhase('budget-meeting');
    }
    
    // Track which meeting is active
    var currentMeetingType = 'year1';
    
    function shouldSkipConferenceChaos(){
        try{
            var params = new URLSearchParams(window.location.search || '');
            if (params.get('skipCC') === '1' || params.get('skipMinigames') === '1') return true;
        }catch(e){}
        try{
            if (localStorage.getItem('skipConferenceChaos') === '1') return true;
        }catch(e){}
        return !!(gameState && gameState.skipConferenceChaos);
    }

    function skipCommitteeChaos(persist){
        if (persist){
            try{ localStorage.setItem('skipConferenceChaos','1'); }catch(e){}
            if (gameState) gameState.skipConferenceChaos = true;
        }
        try{ document.getElementById('cc-overlay').classList.remove('active'); }catch(e){}
        // Simulate a neutral outcome (multiplier = 1.0)
        window.postMessage({ type: 'committeeChaosDone', budgetMultiplier: 1.0, skipped: true }, '*');
    }

    function startCommitteeChaos() {
        currentMeetingType = 'year1';

        // Debug/QA shortcut: append ?skipCC=1 (or ?skipMinigames=1) to auto-skip
        if (shouldSkipConferenceChaos()) {
            skipCommitteeChaos(false);
            return;
        }

        var overlay = document.getElementById('cc-overlay');
        var iframe = document.getElementById('cc-iframe');

        // Set the iframe source to the base64-encoded mini-game
        iframe.src = 'data:text/html;base64,' + CC_GAME_BASE64;

        // Show the overlay
        overlay.classList.add('active');
    }

    // Allow ESC to skip Committee Chaos when it's open (debug convenience)
    window.addEventListener('keydown', function(ev){
        try{
            var overlay = document.getElementById('cc-overlay');
            if (!overlay || !overlay.classList.contains('active')) return;
            if (ev.key === 'Escape'){
                ev.preventDefault();
                skipCommitteeChaos(false);
            }
        }catch(e){}
    });


    // Track callback for Resource Run
    var rrAfterCallback = null;

    function startResourceRun(afterCallback) {
        rrAfterCallback = typeof afterCallback === 'function' ? afterCallback : null;

        var overlay = document.getElementById('rr-overlay');
        var iframe = document.getElementById('rr-iframe');

        // Load the base64-encoded mini-game
        iframe.src = 'data:text/html;base64,' + RR_GAME_BASE64;

        // Show overlay
        overlay.classList.add('active');
    }

    // ============================================
    // OPTIONAL RESOURCE RUN BEFORE YEAR 2 ALLOCATION
    // ============================================
    var rrY2NextCallback = null;

    function maybeStartResourceRunY2(nextFn) {
        // Default behavior: go to Year 2 portfolio builder
        var fallback = function() { proceedToYear2PortfolioBuilder(); };
        var fn = (typeof nextFn === 'function') ? nextFn : fallback;

        // Prevent repeat prompts if player navigates back and forth
        if (gameState && gameState.resourceRunY2ChoiceMade) {
            fn();
            return;
        }

        gameState.inYear2PlanningFlow = true;
        rrY2NextCallback = fn;
        var prompt = document.getElementById('rr-y2-prompt');
        if (prompt) prompt.classList.remove('hidden');
    }

    function playResourceRunY2() {
        if (gameState) gameState.resourceRunY2ChoiceMade = true;

        var prompt = document.getElementById('rr-y2-prompt');
        if (prompt) prompt.classList.add('hidden');

        // Launch the mini-game; it will call back via postMessage -> rrAfterCallback
        startResourceRun(function() {
            if (typeof rrY2NextCallback === 'function') {
                var cb = rrY2NextCallback;
                rrY2NextCallback = null;
                cb();
            }
        });
    }

    function skipResourceRunY2Prompt() {
        if (gameState) gameState.resourceRunY2ChoiceMade = true;

        var prompt = document.getElementById('rr-y2-prompt');
        if (prompt) prompt.classList.add('hidden');

        if (typeof rrY2NextCallback === 'function') {
            var cb = rrY2NextCallback;
            rrY2NextCallback = null;
            cb();
        }
    }

    
    // Year 2 meeting functions
    function showYear2BudgetMeeting() {
        // Skip the Year 2 Committee Chaos mini-game and go directly to Year 2 operations
        continueToYear2();
    }
    
    function startYear2CommitteeChaos() {
        // This function is no longer used - Year 2 Committee Chaos has been removed
        // Keeping for backward compatibility
        continueToYear2();
    }
    
    function continueToYear2() {
        // If there are no active projects at the start of Year 2, skip directly to results
        if (gameState.activeProjects.length === 0) {
            showResults();
            return;
        }
        
        // Continue to Q5 (Year 2) - cockpit will be shown after projects are updated
        renderQuarterlyReview();
    }
    
    // ============================================
    // YEAR 1 END PROJECT SELECTION (Mid-Year Refresh)
    // ============================================
    
    const year1EndProjectTemplates = [
        { 
            archetype: 'quick_win',
            names: ['SmartDoorbell Mini', 'Budget Motion Sensor', 'LED Status Light Kit'],
            descs: ['Entry-level doorbell camera targeting first-time buyers. Simplified features, aggressive price point. Can leverage existing manufacturing.', 
                    'Low-cost PIR sensor optimised for indoor use. Value engineering from existing sensor line. Quick time to market.',
                    'Retrofit kit adding smart LED indicators to existing sensors. Low development cost, high margin accessory.'],
            budgetRange: [1.5, 3.0], baseSuccess: 0.75, 
            scores: { technical: 2, marketsize: 4, strategic: 3, team: 4, capability: 5, ip: 2, platform: 2, sustainability: 2, newmarket: 2, geographic: 3, competitive: 4, devcost: 2, roi: 4, speed: 5, risk: 2 },
            quarterNarratives: { good: ['Quick progress.', 'On track for launch.'], bad: ['Minor delays.', 'Quality issues being addressed.'] },
            outcomeNarrative: { success: 'Fast execution delivered quick market entry.', failure: 'Rushed development led to quality issues.' }
        },
        { 
            archetype: 'market_response',
            names: ['Competitor Response Pack', 'Feature Parity Update', 'Value Line Extension'],
            descs: ['Rapid response to Xiaomi\'s latest launch. Feature matching with ShieldTech quality. Defensive market positioning.',
                    'Update to match competitor features announced at CES. Maintaining competitive relevance in premium segment.',
                    'Extended product line addressing mid-market gap identified by sales team. Quick win from existing platform.'],
            budgetRange: [2.5, 4.5], baseSuccess: 0.70,
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 4, capability: 4, ip: 2, platform: 3, sustainability: 2, newmarket: 2, geographic: 3, competitive: 5, devcost: 3, roi: 3, speed: 4, risk: 3 },
            quarterNarratives: { good: ['Competitive analysis complete.', 'Features on track.'], bad: ['Scope creeping.', 'Competitor moved again.'] },
            outcomeNarrative: { success: 'Maintained market position against competitive threat.', failure: 'Competitor outpaced our response.' }
        },
        { 
            archetype: 'capability_build',
            names: ['AI Training Pipeline', 'Edge Compute Framework', 'Cloud Analytics Platform'],
            descs: ['Internal tooling for model training and deployment. Accelerates all AI-enabled products. Foundation for future innovation.',
                    'Framework for running models on device. Reduces cloud costs, improves latency. Platform play for premium products.',
                    'Analytics backend enabling new subscription services. Monetisation path for existing customer base.'],
            budgetRange: [3.0, 5.5], baseSuccess: 0.65,
            scores: { technical: 5, marketsize: 3, strategic: 4, team: 4, capability: 3, ip: 4, platform: 5, sustainability: 3, newmarket: 2, geographic: 2, competitive: 3, devcost: 4, roi: 3, speed: 2, risk: 3 },
            quarterNarratives: { good: ['Architecture validated.', 'Team ramping up.'], bad: ['Technical challenges emerging.', 'Integration complexity.'] },
            outcomeNarrative: { success: 'Platform investment paying dividends across product line.', failure: 'Capability build took longer than expected.' }
        },
        { 
            archetype: 'partnership_opportunity',
            names: ['Builder Integration Module', 'Reliance Retail Bundle', 'Insurance Partnership Kit'],
            descs: ['Pre-integrated solution for housing developers. Reduces installation complexity. B2B revenue stream.',
                    'Co-branded bundle for Reliance Retail distribution. Volume opportunity with margin trade-off.',
                    'Sensor kit designed for insurance premium discounts. New channel, recurring revenue model.'],
            budgetRange: [2.0, 4.0], baseSuccess: 0.60,
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 3, capability: 4, ip: 2, platform: 3, sustainability: 2, newmarket: 4, geographic: 4, competitive: 3, devcost: 3, roi: 4, speed: 3, risk: 3 },
            quarterNarratives: { good: ['Partner aligned.', 'Integration progressing.'], bad: ['Partner priorities shifting.', 'Terms being renegotiated.'] },
            outcomeNarrative: { success: 'Partnership opened valuable new channel.', failure: 'Partnership terms didn\'t materialise as expected.' }
        },
        {
            archetype: 'tech_adjacency',
            names: ['Health Monitoring Add-on', 'Energy Management Module', 'Air Quality Sensor'],
            descs: ['Wellness features leveraging existing sensors. Detects sleep patterns, activity levels. Health-tech adjacency play.',
                    'Smart energy monitoring with solar integration. Growing segment in sustainable homes. New revenue stream.',
                    'Indoor air quality monitoring with smart ventilation control. Premium feature for health-conscious customers.'],
            budgetRange: [3.5, 6.0], baseSuccess: 0.55,
            scores: { technical: 4, marketsize: 3, strategic: 3, team: 3, capability: 3, ip: 3, platform: 3, sustainability: 4, newmarket: 5, geographic: 3, competitive: 3, devcost: 4, roi: 3, speed: 2, risk: 4 },
            quarterNarratives: { good: ['Technology validated.', 'User research positive.'], bad: ['Regulatory complexity.', 'Market adoption uncertain.'] },
            outcomeNarrative: { success: 'Adjacent market entry successful—new growth vector.', failure: 'Market wasn\'t ready for the adjacency play.' }
        }
    ];
    
    // State for Year 1 End selection
    let year1EndProjectPool = [];
    let year1EndSelectedProjects = [];
    let year1EndAvailableBudget = 0;
    
    function generateYear1EndProjectPool() {
        const pool = [];
        const usedNames = new Set();
        const effects = calculateCommitteeEffects();
        let projectId = 50; // Start from 50 to avoid collision with Year 1 and Year 2 projects
        
        // Shuffle templates and pick a subset
        const shuffled = shuffleArray([...year1EndProjectTemplates]);
        const templatesToUse = shuffled.slice(0, 4); // Use 4 templates to generate ~5-7 projects
        
        for (const template of templatesToUse) {
            const count = 1 + Math.floor(Math.random() * 2); // 1-2 projects per template
            const indices = shuffleArray([...Array(template.names.length).keys()]).slice(0, count);
            
            for (const i of indices) {
                const name = template.names[i];
                const desc = (template.descs && (template.descs[i] || template.descs[0])) ? (template.descs[i] || template.descs[0]) : '';
                if (usedNames.has(name)) continue;
                usedNames.add(name);
                
                const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                const budget = Math.round(budgetRaw * 10) / 10;
                let successProb = template.baseSuccess + (Math.random() * 0.1 - 0.05);
                
                // Map Year 1 End archetypes to existing archetype effects where applicable
                const archetypeMapping = {
                    'quick_win': 'conventionalWinner',
                    'market_response': 'competitive',
                    'capability_build': 'slowBurner',
                    'partnership_opportunity': 'pivotSuccess',
                    'tech_adjacency': 'hiddenGem'
                };
                const mappedKey = archetypeMapping[template.archetype];
                if (mappedKey && effects[mappedKey]) {
                    successProb *= effects[mappedKey];
                }
                
                // Use equivalent base archetypes for helper functions
                const baseArchetypeMapping = {
                    'quick_win': 'conventional_winner',
                    'market_response': 'competitive_casualty',
                    'capability_build': 'slow_burner',
                    'partnership_opportunity': 'pivot_success',
                    'tech_adjacency': 'hidden_gem'
                };
                const baseArchetype = baseArchetypeMapping[template.archetype] || 'conventional_winner';
                
                const project = {
                    id: 'y1end-' + projectId,
                    numId: projectId,
                    name: name,
                    desc: desc,
                    shortDesc: desc,
                    tagline: getYear1EndTagline(template.archetype),
                    fullDesc: generateYear1EndFullDesc(name, template.descs[i], template.archetype),
                    marketContext: getYear1EndMarketContext({ archetype: template.archetype }),
                    capabilityFit: getYear1EndCapabilityFit({ archetype: template.archetype }),
                    risks: getYear1EndRisks({ archetype: template.archetype }),
                    teamNote: getYear1EndTeamNote({ archetype: template.archetype }),
                    teamDetails: generateTeamDetails(name, baseArchetype, template.scores),
                    strategicBuckets: getStrategicBucketsForArchetype(template.archetype),
                    trl: getTRL(baseArchetype),
                    ipPosition: getIPPosition(baseArchetype, name),
                    ipAnalysis: generateYear1EndIPAnalysis(template.archetype),
                    competitors: getYear1EndCompetitors(template.archetype),
                    developmentCosts: getDevelopmentCosts(budget, baseArchetype),
                    milestones: getMilestones(baseArchetype, budget),
                    financials: generateFinancials(budget, baseArchetype),
                    synergies: generateYear1EndSynergies(name, template.archetype),
                    archetype: template.archetype,
                    riskClass: riskClass,
                    baseArchetype: baseArchetype,
                    budget: budget,
                    successProb: Math.max(0.05, Math.min(0.95, successProb)),
                    baseSuccessRate: Math.round(successProb * 100),
                    scores: { ...template.scores },
                    criteriaScores: template.scores,
                    quarterNarratives: template.quarterNarratives,
                    outcomeNarrative: template.outcomeNarrative,
                    timeline: 4 + Math.floor(Math.random() * 3), // 4-6 quarters for Year 1 End projects (run Q5-Q10)
                    status: 'proposed',
                    currentQuarter: 0,
                    spentBudget: 0,
                    quarterlyUpdates: [],
                    decision: null,
                    outcome: null,
                    playerScores: {},
                    committeeScores: {},
                    lead: assignProjectLead(baseArchetype, template.scores),
                    isYear1EndProject: true
                };
                
                pool.push(project);
                projectId++;
            }
        }
        
        return pool;
    }
    
    function generateYear1EndFullDesc(name, shortDesc, archetype) {
        const expansions = {
            'quick_win': `${shortDesc}\n\nThis opportunity emerged from Year 1 customer feedback and sales team input. The market window is 6-9 months before competitors are likely to respond. Development risk is low as it leverages proven technology and existing manufacturing relationships. Success depends on execution speed and maintaining quality standards.`,
            'market_response': `${shortDesc}\n\nCompetitive intelligence from Year 1 indicates this defensive move is necessary to protect market share. The project responds to specific competitor features that customers have been asking about. Timing is critical—delayed response could result in customer defection. The technical approach uses proven methods to minimise risk.`,
            'capability_build': `${shortDesc}\n\nThis strategic investment addresses capability gaps identified during Year 1. While not directly customer-facing, it will accelerate future product development and reduce technical debt. ROI is measured in development velocity and cost reduction across the portfolio rather than direct revenue.`,
            'partnership_opportunity': `${shortDesc}\n\nPartnership discussions initiated during Year 1 have matured to the point where product development can begin. The partner brings channel access and market knowledge while ShieldTech contributes technology and product expertise. Terms are largely agreed; execution is the primary risk.`,
            'tech_adjacency': `${shortDesc}\n\nCustomer requests during Year 1 revealed demand for adjacent capabilities. This project extends ShieldTech's technology into a new use case with strong synergies to the core business. Market validation is partial—further customer discovery is built into the development plan.`
        };
        return expansions[archetype] || shortDesc;
    }
    
    function generateYear1EndIPAnalysis(archetype) {
        const ipAnalyses = {
            'quick_win': {
                shieldtechIP: 'Leverages existing ShieldTech patents on sensor integration and cloud connectivity.',
                competitorIP: 'Clear field—no blocking patents identified in target feature set.',
                fto: 'Clear',
                ftoRisk: 'Low'
            },
            'market_response': {
                shieldtechIP: 'May file defensive patents on implementation approach.',
                competitorIP: 'Competitor has patents in adjacent areas. Design-around strategy in place.',
                fto: 'Requires review',
                ftoRisk: 'Medium'
            },
            'capability_build': {
                shieldtechIP: 'Platform architecture may generate valuable trade secrets and patents.',
                competitorIP: 'Open source components used where available. Some proprietary integrations.',
                fto: 'Clear for internal use',
                ftoRisk: 'Low'
            },
            'partnership_opportunity': {
                shieldtechIP: 'Joint IP arrangement with partner. ShieldTech retains core technology rights.',
                competitorIP: 'Partner provides IP indemnification in target channel.',
                fto: 'Partner-dependent',
                ftoRisk: 'Medium'
            },
            'tech_adjacency': {
                shieldtechIP: 'New application of existing IP. May generate adjacent patents.',
                competitorIP: 'New market—IP landscape less crowded than core security.',
                fto: 'Initial review positive',
                ftoRisk: 'Low-Medium'
            }
        };
        return ipAnalyses[archetype] || { shieldtechIP: 'Standard IP position', competitorIP: 'No significant concerns', fto: 'Review pending', ftoRisk: 'Unknown' };
    }
    
    function getYear1EndCompetitors(archetype) {
        const competitorSets = {
            'quick_win': [
                { name: 'Xiaomi', position: 'Price leader in entry segment', threat: 'Medium' },
                { name: 'Godrej', position: 'Established brand, slower innovation', threat: 'Low' }
            ],
            'market_response': [
                { name: 'Target Competitor', position: 'Feature originator, market leader', threat: 'High' },
                { name: 'Fast Followers', position: 'May also respond quickly', threat: 'Medium' }
            ],
            'capability_build': [
                { name: 'Internal Alternative', position: 'Continue with current approach', threat: 'Low' },
                { name: 'Build vs Buy', position: 'Third-party platform options exist', threat: 'Low' }
            ],
            'partnership_opportunity': [
                { name: 'Partner Alternatives', position: 'Partner could work with competitors', threat: 'Medium' },
                { name: 'Direct Approach', position: 'Could build channel directly (slower)', threat: 'Low' }
            ],
            'tech_adjacency': [
                { name: 'Segment Specialists', position: 'Focused players in adjacent market', threat: 'Medium' },
                { name: 'Tech Giants', position: 'May enter if market proves out', threat: 'Medium' }
            ]
        };
        return competitorSets[archetype] || [{ name: 'Various', position: 'Standard competitive landscape', threat: 'Medium' }];
    }
    
    function generateYear1EndSynergies(name, archetype) {
        const synergySets = {
            'quick_win': {
                technical: ['Shared manufacturing', 'Common firmware base', 'Existing QA processes'],
                commercial: ['Same channel partners', 'Cross-sell to existing customers', 'Unified support'],
                strategic: ['Strengthens entry-level lineup', 'Defends against price erosion']
            },
            'market_response': {
                technical: ['Leverages existing platform', 'OTA update infrastructure'],
                commercial: ['Retains at-risk customers', 'Sales team requesting'],
                strategic: ['Maintains competitive position', 'Signals market responsiveness']
            },
            'capability_build': {
                technical: ['Accelerates all product development', 'Reduces technical debt'],
                commercial: ['Enables faster feature delivery', 'Improves reliability'],
                strategic: ['Platform for future growth', 'Attracts engineering talent']
            },
            'partnership_opportunity': {
                technical: ['Integration with partner systems', 'Shared development where aligned'],
                commercial: ['New channel access', 'Partner marketing support'],
                strategic: ['Diversifies revenue', 'Reduces channel concentration risk']
            },
            'tech_adjacency': {
                technical: ['Core technology transfers', 'Shared cloud infrastructure'],
                commercial: ['Upsell to existing customers', 'New customer segment'],
                strategic: ['Growth beyond core market', 'Hedge against market saturation']
            }
        };
        return synergySets[archetype] || { technical: ['Standard synergies'], commercial: ['Cross-sell potential'], strategic: ['Portfolio diversification'] };
    }
    
    function getYear1EndTagline(archetype) {
        const taglines = {
            'quick_win': 'Fast time-to-market opportunity',
            'market_response': 'Competitive response initiative',
            'capability_build': 'Strategic capability investment',
            'partnership_opportunity': 'Channel expansion opportunity',
            'tech_adjacency': 'Adjacent market exploration'
        };
        return taglines[archetype] || 'Mid-year opportunity';
    }
    
    function showYear1EndProjectSelection() {
        // Show the phase first so the DOM element is accessible
        showPhase('year1-end-selection');
        
        // Always generate fresh project pool for Year 1 End
        year1EndProjectPool = generateYear1EndProjectPool();
        year1EndSelectedProjects = [];
        
        // Calculate ongoing project needs (remaining costs for active projects)
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        // Calculate what was spent on completed projects (this money is gone)
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Calculate what was spent on killed projects (partial spending before kill)
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Total committed = ongoing needs + already spent on completed + killed
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        
        // Available = annual budget - all committed spending
        year1EndAvailableBudget = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Ensure at least a small refresh budget for gameplay (10% of max, reduced from 15%)
        const minRefreshBudget = gameState.maxBudget * 0.10;
        if (year1EndAvailableBudget < minRefreshBudget) {
            year1EndAvailableBudget = minRefreshBudget;
        }
        
        // Render the Year 1 End project grid
        renderYear1EndProjectGrid();
        updateYear1EndBudgetDisplay();
    }
    
    let year1EndLastRenderTime = 0;
    function renderYear1EndProjectGrid() {
        // Debounce rapid re-renders
        const now = Date.now();
        if (now - year1EndLastRenderTime < 50) return;
        year1EndLastRenderTime = now;
        
        const grid = document.getElementById('year1end-project-grid');
        
        if (!grid) {
            console.error('Could not find year1end-project-grid element!');
            return;
        }
        
        if (year1EndProjectPool.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 20px;">No new projects available.</p>';
            return;
        }
        
        grid.innerHTML = year1EndProjectPool.map((project, index) => {
            const isSelected = year1EndSelectedProjects.includes(project.id);
            const canAfford = project.budget <= year1EndAvailableBudget || isSelected;
            const isLocked = !isSelected && !canAfford;
            
            const bucketsHtml = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}20; color: ${bucket.color}; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 500;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
            
            // Generate key metrics
            const successRate = project.baseSuccessRate || Math.round(project.successProb * 100);
            const riskLevel = project.scores?.risk <= 2 ? 'Low' : project.scores?.risk <= 3 ? 'Medium' : 'High';
            const riskColor = project.scores?.risk <= 2 ? 'var(--success)' : project.scores?.risk <= 3 ? 'var(--warning)' : 'var(--danger)';
            
            // Get lead info if available
            const leadHtml = project.lead ? `
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--gray-200);">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: ${project.lead.avatarColor}; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: 600;">${project.lead.initials}</div>
                    <div style="font-size: 0.8em;">
                        <div style="font-weight: 600; color: var(--gray-700);">${project.lead.name}</div>
                        <div style="color: var(--gray-500);">${project.lead.role}</div>
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="project-card ${isSelected ? 'selected' : ''} ${isLocked ? 'locked' : ''}" data-id="${project.id}">
                    <div class="project-header">
                        <span class="project-name">${project.name}</span>
                        <span class="project-budget">$${project.budget}M </span>
                    </div>
                    <div class="project-tagline">${project.tagline || ''}</div>
                    ${renderInnovationBadges(project, true)}
                    <div style="margin: 8px 0;">${bucketsHtml}</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; font-size: 0.85em; flex-wrap: wrap;">
                        <span style="background: var(--gray-100); padding: 4px 8px; border-radius: 4px;">
                            ⏱️ <strong>${project.timeline}Q</strong> timeline
                        </span>
                        <span style="background: var(--primary-lighter); padding: 4px 8px; border-radius: 4px;">
                            📊 <strong>${successRate}%</strong> success rate
                        </span>
                        <span style="background: ${riskColor}20; color: ${riskColor}; padding: 4px 8px; border-radius: 4px;">
                            ⚡ <strong>${riskLevel}</strong> risk
                        </span>
                    </div>
                    <div class="project-desc">${project.shortDesc || project.desc}</div>
                    ${leadHtml}
                    <div class="project-card-actions">
                        <button class="project-learn-more" onclick="event.stopPropagation(); openYear1EndProjectModal('${project.id}')">Learn More</button>
                        <button class="project-select-btn ${isSelected ? 'selected' : ''}" 
                                onclick="event.stopPropagation(); toggleYear1EndProject('${project.id}')" 
                                ${isLocked ? 'disabled' : ''}>
                            ${isSelected ? '✓ Selected' : isLocked ? 'Over Budget' : 'Select'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Helper function to assign strategic buckets based on archetype
    function getStrategicBucketsForArchetype(archetype) {
        const bucketMappings = {
            'quick_win': [
                { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' }
            ],
            'market_response': [
                { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' }
            ],
            'capability_build': [
                { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
            ],
            'partnership_opportunity': [
                { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' }
            ],
            'tech_adjacency': [
                { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
            ]
        };
        return bucketMappings[archetype] || [];
    }
    
    // Modal for Year 1 End projects
    function openYear1EndProjectModal(projectId) {
        const project = year1EndProjectPool.find(p => p.id === projectId);
        if (!project) return;
        
        // Store current context so the modal button knows which pool to use
        gameState.currentModalProject = projectId;
        gameState.currentModalContext = 'year1end';
        
        document.getElementById('project-modal-name').textContent = project.name;
        document.getElementById('project-modal-tagline').textContent = project.tagline || '';
        document.getElementById('project-modal-budget').textContent = `$${project.budget}M`;
        document.getElementById('project-modal-desc').textContent = project.fullDesc || project.desc;
        document.getElementById('project-modal-market').textContent = project.marketContext || getYear1EndMarketContext(project);
        document.getElementById('project-modal-capability').textContent = project.capabilityFit || getYear1EndCapabilityFit(project);
        document.getElementById('project-modal-team').textContent = project.teamNote || getYear1EndTeamNote(project);
        
        // Strategic buckets
        const bucketsEl = document.getElementById('project-modal-buckets');
        if (bucketsEl) {
            bucketsEl.innerHTML = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}20; color: ${bucket.color}; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500; margin-right: 8px;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
        }
        
        // Development costs - use generated data if available
        const devCosts = project.developmentCosts || {};
        document.getElementById('project-modal-dev-costs').innerHTML = `
            <div class="dev-costs-grid">
                <div class="dev-cost-item total">
                    <div class="dev-cost-amount">$${devCosts.total || project.budget}M </div>
                    <div class="dev-cost-label">Total Budget</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.personnel?.amount || (project.budget * 0.5).toFixed(1)}M </div>
                    <div class="dev-cost-label">Personnel</div>
                    <div class="dev-cost-pct">${devCosts.personnel?.pct || 50}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.hardware?.amount || (project.budget * 0.2).toFixed(1)}M </div>
                    <div class="dev-cost-label">Hardware/Components</div>
                    <div class="dev-cost-pct">${devCosts.hardware?.pct || 20}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.software?.amount || (project.budget * 0.15).toFixed(1)}M </div>
                    <div class="dev-cost-label">Software/Tools</div>
                    <div class="dev-cost-pct">${devCosts.software?.pct || 15}%</div>
                </div>
                <div class="dev-cost-item">
                    <div class="dev-cost-amount">$${devCosts.external?.amount || (project.budget * 0.15).toFixed(1)}M </div>
                    <div class="dev-cost-label">External/Other</div>
                    <div class="dev-cost-pct">${devCosts.external?.pct || 15}%</div>
                </div>
            </div>
        `;
        
        // Milestones - use generated data if available
        const milestones = project.milestones?.milestones || project.milestones?.phases || [];
        if (milestones.length > 0) {
            document.getElementById('project-modal-milestones').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    ${milestones.map((m, i) => `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px; border-left: 3px solid var(--primary);">
                            <span style="font-size: 1.2em;">${i === milestones.length - 1 ? '✅' : '🎯'}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${m.phase || m.name || 'Phase ' + (i+1)}</div>
                                <div style="font-size: 0.85em; color: var(--gray-600);">
                                    ${m.quarters ? m.quarters : ''} ${m.duration ? '• ' + m.duration : ''} ${m.costAmount ? '• $' + m.costAmount + 'M' : ''}
                                </div>
                                ${m.deliverables ? `<div style="margin-top: 5px; font-size: 0.8em; color: var(--gray-500);">${m.deliverables.join(', ')}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            document.getElementById('project-modal-milestones').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px; border-left: 3px solid var(--primary);">
                        <span style="font-size: 1.2em;">🎯</span>
                        <div>
                            <div style="font-weight: 600;">Q1-Q${Math.ceil(project.timeline/2)}: Development</div>
                            <div style="font-size: 0.85em; color: var(--gray-600);">Core development and validation</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px; border-left: 3px solid var(--success);">
                        <span style="font-size: 1.2em;">✅</span>
                        <div>
                            <div style="font-weight: 600;">Q${project.timeline}: Launch</div>
                            <div style="font-size: 0.85em; color: var(--gray-600);">Market launch and commercialisation</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // TRL - use generated data if available
        const trl = project.trl || { current: 5, target: 8 };
        const trlHtml = [1,2,3,4,5,6,7,8,9].map(level => `
            <div style="flex: 1; height: 30px; display: flex; align-items: center; justify-content: center; 
                        background: ${level <= trl.current ? 'var(--primary)' : level <= trl.target ? 'var(--primary-lighter)' : 'var(--gray-200)'}; 
                        color: ${level <= trl.current ? 'white' : level <= trl.target ? 'var(--primary)' : 'var(--gray-400)'};
                        border-radius: 4px; font-weight: 600; font-size: 0.8em;">
                ${level}
            </div>
        `).join('');
        document.getElementById('project-modal-trl').innerHTML = `
            <div style="display: flex; gap: 4px; margin-bottom: 8px;">${trlHtml}</div>
            <div style="display: flex; gap: 20px; font-size: 0.85em; color: var(--gray-600);">
                <span>● Current: TRL ${trl.current}</span>
                <span>○ Target: TRL ${trl.target}</span>
            </div>
            ${trl.note ? `<p style="margin-top: 10px; font-size: 0.85em;">${trl.note}</p>` : ''}
        `;
        
        // IP - use generated data if available
        const ip = project.ipAnalysis || project.ipPosition || {};
        document.getElementById('project-modal-ip').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">ShieldTech IP</div>
                    <p style="font-size: 0.8em; margin: 0;">${ip.shieldtechIP || ip.shieldtech || 'Standard IP position'}</p>
                </div>
                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">Competitor IP</div>
                    <p style="font-size: 0.8em; margin: 0;">${ip.competitorIP || ip.competitors || 'No significant concerns'}</p>
                </div>
            </div>
            <div style="padding: 8px 15px; border-radius: 8px; font-size: 0.85em; display: inline-block;
                        background: ${(ip.ftoRisk || '').toLowerCase().includes('high') ? 'var(--danger-light)' : (ip.ftoRisk || '').toLowerCase().includes('medium') ? 'var(--warning-light)' : 'var(--success-light)'};
                        color: ${(ip.ftoRisk || '').toLowerCase().includes('high') ? 'var(--danger)' : (ip.ftoRisk || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                <strong>FTO:</strong> ${ip.fto || 'Review pending'} · ${ip.ftoRisk || 'Low'} Risk
            </div>
        `;
        
        // Competitors - use generated data
        const competitors = project.competitors || [];
        document.getElementById('project-modal-competitors').innerHTML = competitors.length > 0 ? `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                ${competitors.map(c => `
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; 
                                border-left: 3px solid ${(c.threat || '').toLowerCase().includes('high') ? 'var(--danger)' : (c.threat || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                        <div style="font-weight: 600; font-size: 0.85em; margin-bottom: 4px;">${c.name}</div>
                        <div style="font-size: 0.8em; color: var(--gray-600);">${c.position}</div>
                        <div style="font-size: 0.75em; color: ${(c.threat || '').toLowerCase().includes('high') ? 'var(--danger)' : (c.threat || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'}; margin-top: 4px;">
                            Threat: ${c.threat || 'Medium'}
                        </div>
                    </div>
                `).join('')}
            </div>
        ` : '<p style="color: var(--gray-500);">Competitive analysis based on Year 1 market observations.</p>';
        
        // Synergies - use generated data
        const synergiesEl = document.getElementById('project-modal-synergies');
        if (synergiesEl) {
            const synergies = project.synergies || {};
            synergiesEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    ${synergies.technical ? `
                        <div style="background: var(--primary-lighter); padding: 10px; border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 0.8em; color: var(--primary); margin-bottom: 6px;">🔧 Technical</div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 0.8em; color: var(--gray-600);">
                                ${synergies.technical.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${synergies.commercial ? `
                        <div style="background: var(--success-light); padding: 10px; border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 0.8em; color: var(--success); margin-bottom: 6px;">💼 Commercial</div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 0.8em; color: var(--gray-600);">
                                ${synergies.commercial.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${synergies.strategic ? `
                        <div style="background: var(--warning-light); padding: 10px; border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 0.8em; color: var(--warning); margin-bottom: 6px;">🎯 Strategic</div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 0.8em; color: var(--gray-600);">
                                ${synergies.strategic.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Financials - use generated data
        const financialsEl = document.getElementById('project-modal-financials');
        if (financialsEl) {
            const fin = project.financials || {};
            financialsEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.3em; font-weight: 700; color: var(--primary);">$${fin.revenueY1 || (project.budget * 2.5).toFixed(1)}M </div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Est. Revenue (Y1)</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.3em; font-weight: 700; color: var(--success);">${fin.grossMargin || '40%'}</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Gross Margin</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.3em; font-weight: 700; color: var(--warning);">${fin.paybackPeriod || (project.timeline + 2) + 'Q'}</div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">Payback Period</div>
                    </div>
                </div>
            `;
        }
        
        // Team details - full rendering like original modal
        const teamDetailsEl = document.getElementById('project-modal-team-details');
        if (teamDetailsEl) {
            const teamDetails = project.teamDetails;
            
            // Simplified team display - Project Lead and team size only
            let teamHtml = '';
            
            // Project Lead - primary responsibility
            if (project.lead) {
                teamHtml += '<div style="margin-bottom: 20px;">';
                teamHtml += '<div style="margin-bottom: 10px;"><strong>🎯 Project Lead:</strong></div>';
                teamHtml += renderLeadCard(project.lead);
                teamHtml += '</div>';
            }
            
            // Team size - simplified to just total FTE
            if (teamDetails && teamDetails.headcount) {
                const hc = teamDetails.headcount;
                teamHtml += `<div style="background: var(--primary-lighter); padding: 15px; border-radius: 8px; text-align: center; max-width: 150px; margin-bottom: 15px;">
                    <div style="font-size: 1.5em; font-weight: 700; color: var(--primary);">${hc.total}</div>
                    <div style="font-size: 0.85em; color: var(--gray-500);">Team Size (FTE)</div>
                </div>`;
            }
            
            // Risk assessment at the end
            teamHtml += `<p style="font-size: 0.9em; color: var(--gray-600); margin-top: 15px;">
                <strong>Project Risk Assessment:</strong> ${project.risks || getYear1EndRisks(project)}
            </p>`;
            
            teamDetailsEl.innerHTML = teamHtml;
        }
        
        // Update select button in modal
        const isSelected = year1EndSelectedProjects.includes(projectId);
        const selectBtn = document.getElementById('project-modal-btn');
        if (selectBtn) {
            selectBtn.textContent = isSelected ? '✓ Selected - Remove' : 'Add to Portfolio';
            selectBtn.className = isSelected ? 'add-to-committee-btn remove' : 'add-to-committee-btn';
        }
        
        document.getElementById('project-modal').classList.remove('hidden');
    }
    
    function getYear1EndMarketContext(project) {
        const contexts = {
            'quick_win': 'Fast-moving market segment identified through Year 1 customer feedback. Strong demand signal from sales team. Competitive window of 6-9 months before likely response.',
            'market_response': 'Defensive play responding to competitor moves observed in Year 1. Market share at risk without response. Customer research confirms feature gap concerns.',
            'capability_build': 'Strategic capability investment informed by Year 1 learnings. Will accelerate future product development and reduce technical debt.',
            'partnership_opportunity': 'Partnership opportunity emerged from Year 1 business development. Strong strategic fit with potential for recurring revenue.',
            'tech_adjacency': 'Adjacent market exploration based on customer requests during Year 1. Leverage existing technology with adaptation for new use cases.'
        };
        return contexts[project.archetype] || 'Market opportunity identified through Year 1 operations.';
    }
    
    function getYear1EndCapabilityFit(project) {
        const fits = {
            'quick_win': 'Strong capability fit. Leverages existing team skills and infrastructure. Low execution risk.',
            'market_response': 'Good capability alignment. Engineering team familiar with required technologies. Some acceleration needed.',
            'capability_build': 'Builds new capabilities. Requires focused investment but creates long-term value across product line.',
            'partnership_opportunity': 'Mixed capability requirements. Core product work fits existing skills. Partnership management needs development.',
            'tech_adjacency': 'Partial capability fit. Core technology transfers well. New domain expertise required.'
        };
        return fits[project.archetype] || 'Capability assessment based on Year 1 team performance.';
    }
    
    function getYear1EndTeamNote(project) {
        const notes = {
            'quick_win': 'Can be staffed from existing team with minor reallocation. Low disruption to ongoing projects.',
            'market_response': 'Requires dedicated squad. May compete with existing projects for senior engineers.',
            'capability_build': 'Platform team ownership. Needs dedicated resources for full duration.',
            'partnership_opportunity': 'Cross-functional team needed. Business development lead essential.',
            'tech_adjacency': 'Needs domain specialist hire or consultant. Otherwise standard team composition.'
        };
        return notes[project.archetype] || 'Team allocation to be determined based on Year 2 capacity.';
    }
    
    function getYear1EndRisks(project) {
        const risks = {
            'quick_win': 'Execution speed is critical. Risk of quality shortcuts if timeline pressured. Competition may respond faster.',
            'market_response': 'Reactive positioning. May be outpaced by competitor\'s next move. Resource allocation tension with proactive initiatives.',
            'capability_build': 'Typical platform risk: may take longer than expected, benefits accrue slowly. Opportunity cost of not shipping customer-facing features.',
            'partnership_opportunity': 'Partner dependency. Terms may shift. Integration complexity often underestimated.',
            'tech_adjacency': 'Market validation risk. Adjacent segment may not convert as expected. Domain learning curve.'
        };
        return risks[project.archetype] || 'Standard project risks apply. Year 1 experience informs mitigation strategies.';
    }
    
    function toggleYear1EndProject(projectId) {
        const project = year1EndProjectPool.find(p => p.id === projectId);
        if (!project) return;
        
        const index = year1EndSelectedProjects.indexOf(projectId);
        
        if (index >= 0) {
            // Deselect
            year1EndSelectedProjects.splice(index, 1);
            year1EndAvailableBudget += project.budget;
        } else {
            // Select (if can afford)
            if (project.budget <= year1EndAvailableBudget) {
                year1EndSelectedProjects.push(projectId);
                year1EndAvailableBudget -= project.budget;
            } else {
                return; // Can't afford, don't re-render
            }
        }
        
        renderYear1EndProjectGrid();
        updateYear1EndBudgetDisplay();
    }
    
    function updateYear1EndBudgetDisplay() {
        document.getElementById('year1end-budget-remaining').textContent = '$' + Math.round(year1EndAvailableBudget * 10) / 10 + 'M';
        document.getElementById('year1end-budget-total').textContent = '/ $' + gameState.maxBudget + 'M annual budget';
        document.getElementById('year1end-projects-selected').textContent = year1EndSelectedProjects.length;
        
        // Enable/disable confirm button - allow skipping even with 0 selections
        document.getElementById('confirm-year1end-selection-btn').disabled = year1EndSelectedProjects.length === 0;
        
        // Update strategic balance display
        updateYear1EndStrategicBalance();
    }
    
    function updateYear1EndStrategicBalance() {
        const balanceDiv = document.getElementById('year1end-strategic-balance');
        if (!balanceDiv) return;
        
        // Count buckets from existing active projects
        const bucketCounts = {};
        Object.values(strategicBuckets).forEach(bucket => {
            bucketCounts[bucket.id] = 0;
        });
        
        // Add Year 1 End specific buckets - now using main strategic buckets
        const year1EndBuckets = {
            'defend-metro': { id: 'defend-metro', name: 'Defend Metro Leadership', icon: '🛡️', color: '#2563eb' },
            'tier23-rollout': { id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' },
            'recurring-revenue': { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' },
            'ai-first': { id: 'ai-first', name: 'AI-First Products', icon: '🤖', color: '#dc2626' }
        };
        
        Object.values(year1EndBuckets).forEach(bucket => {
            if (!bucketCounts[bucket.id]) bucketCounts[bucket.id] = 0;
        });
        
        // Count from active projects
        gameState.activeProjects.forEach(project => {
            (project.strategicBuckets || []).forEach(bucket => {
                if (bucketCounts[bucket.id] !== undefined) bucketCounts[bucket.id]++;
            });
        });
        
        // Count from selected Year 1 End projects
        year1EndSelectedProjects.forEach(projectId => {
            const project = year1EndProjectPool.find(p => p.id === projectId);
            if (project) {
                (project.strategicBuckets || []).forEach(bucket => {
                    if (bucketCounts[bucket.id] !== undefined) {
                        bucketCounts[bucket.id]++;
                    } else {
                        bucketCounts[bucket.id] = 1;
                    }
                });
            }
        });
        
        // Combine all buckets for display
        const allBuckets = { ...strategicBuckets, ...year1EndBuckets };
        
        // Filter to only show buckets that have projects or are relevant
        const relevantBuckets = Object.values(allBuckets).filter(bucket => 
            bucketCounts[bucket.id] > 0 || 
            year1EndProjectPool.some(p => (p.strategicBuckets || []).some(b => b.id === bucket.id))
        );
        
        balanceDiv.innerHTML = '<div style="width: 100%; margin-bottom: 8px; font-weight: 600; color: var(--gray-600);">Strategic Balance:</div>' +
            relevantBuckets.map(bucket => {
                const count = bucketCounts[bucket.id] || 0;
                const hasProjects = count > 0;
                return `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; 
                                background: ${hasProjects ? bucket.color + '20' : 'var(--gray-100)'}; 
                                color: ${hasProjects ? bucket.color : 'var(--gray-400)'}; 
                                border: 1px solid ${hasProjects ? bucket.color + '40' : 'var(--gray-200)'};">
                        <span>${bucket.icon}</span>
                        <span style="font-size: 0.85em;">${bucket.name}</span>
                        <span style="font-weight: 700; margin-left: 4px;">${count}</span>
                    </div>
                `;
            }).join('');
    }
    
    function skipYear1EndSelection() {
        // Show portfolio review before continuing to Year 2 Budget Meeting
        showYear1PortfolioReview();
    }
    
    function showYear1EndReview() {
        // Populate the review modal with portfolio information
        const modal = document.getElementById('year1end-review-modal');
        
        // Get selected projects
        const selectedProjects = year1EndSelectedProjects.map(id => 
            year1EndProjectPool.find(p => p.id === id)
        ).filter(p => p);
        
        // Update strategic balance in review modal
        const balanceDiv = document.getElementById('year1end-review-balance');
        if (balanceDiv) {
            // Count all buckets
            const bucketCounts = {};
            
            // Year 1 End specific buckets - now using main strategic buckets
            const allBuckets = {
                ...strategicBuckets
            };
            
            Object.values(allBuckets).forEach(b => bucketCounts[b.id] = 0);
            
            // Count from active projects
            gameState.activeProjects.forEach(project => {
                (project.strategicBuckets || []).forEach(bucket => {
                    if (bucketCounts[bucket.id] !== undefined) bucketCounts[bucket.id]++;
                });
            });
            
            // Count from selected new projects
            selectedProjects.forEach(project => {
                (project.strategicBuckets || []).forEach(bucket => {
                    bucketCounts[bucket.id] = (bucketCounts[bucket.id] || 0) + 1;
                });
            });
            
            // Filter to only show relevant buckets
            const relevantBuckets = Object.values(allBuckets).filter(b => bucketCounts[b.id] > 0);
            
            balanceDiv.innerHTML = relevantBuckets.map(bucket => {
                const count = bucketCounts[bucket.id] || 0;
                return `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 20px; 
                                background: ${bucket.color}20; color: ${bucket.color}; 
                                border: 1px solid ${bucket.color}40;">
                        <span>${bucket.icon}</span>
                        <span style="font-size: 0.9em;">${bucket.name}</span>
                        <span style="font-weight: 700; margin-left: 4px;">${count}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Update new projects list
        const projectsDiv = document.getElementById('year1end-review-projects');
        if (projectsDiv) {
            projectsDiv.innerHTML = selectedProjects.map(project => `
                <div style="display: flex; align-items: center; gap: 12px; background: var(--success-light); border: 1px solid var(--success); border-radius: 8px; padding: 12px;">
                    <div style="font-size: 1.3em;">🆕</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--gray-800);">${project.name}</div>
                        <div style="font-size: 0.85em; color: var(--gray-600);">${project.tagline || ''}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: var(--gold-dark);">$${project.budget}M </div>
                        <div style="font-size: 0.8em; color: var(--gray-500);">${project.timeline}Q timeline</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update existing projects list
        const existingDiv = document.getElementById('year1end-review-existing');
        if (existingDiv) {
            existingDiv.innerHTML = gameState.activeProjects.map(project => {
                const statusColor = project.status === 'active' ? 'var(--info)' : 'var(--warning)';
                return `
                    <div style="display: flex; align-items: center; gap: 10px; background: var(--gray-50); border-radius: 6px; padding: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--gray-700); font-size: 0.9em;">${project.name}</div>
                        </div>
                        <div style="font-size: 0.8em; color: ${statusColor};">Q${project.quartersActive || 0}/${project.timeline || '?'}</div>
                        <div style="font-size: 0.85em; font-weight: 600; color: var(--gold-dark);">$${project.budget}M </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update summary stats
        const totalProjects = gameState.activeProjects.length + selectedProjects.length;
        const newBudgetUsed = selectedProjects.reduce((sum, p) => sum + p.budget, 0);
        const existingBudgetUsed = gameState.activeProjects.reduce((sum, p) => sum + (p.budget || 0), 0);
        const totalBudgetUsed = newBudgetUsed + existingBudgetUsed;
        const budgetRemaining = gameState.maxBudget - totalBudgetUsed;
        
        document.getElementById('year1end-review-total-projects').textContent = totalProjects;
        document.getElementById('year1end-review-budget-used').textContent = '$' + totalBudgetUsed.toFixed(1) + 'M';
        document.getElementById('year1end-review-budget-remaining').textContent = '$' + Math.max(0, budgetRemaining).toFixed(1) + 'M';
        
        // Show modal
        modal.classList.remove('hidden');
    }
    
    function closeYear1EndReview() {
        document.getElementById('year1end-review-modal').classList.add('hidden');
    }
    
    // ============================================
    // YEAR 1 PORTFOLIO REVIEW (2x2 Matrix Modal)
    // ============================================
    
    let year1ReviewMatrix = 'risk-speed';
    
    function showYear1PortfolioReview() {
        gameState.year2TransitionPending = true;

        year1ReviewMatrix = 'risk-speed';
        
        // Update toggle buttons
        document.querySelectorAll('#year1-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === year1ReviewMatrix);
        });
        
        // Calculate stats
        const successes = gameState.completedProjects.filter(p => p.outcome === 'success').length;
        const failures = gameState.completedProjects.filter(p => p.outcome !== 'success').length;
        const killed = gameState.killedProjects.length;
        const active = gameState.activeProjects.length;
        
        document.getElementById('y1-review-success').textContent = successes;
        document.getElementById('y1-review-failed').textContent = failures;
        document.getElementById('y1-review-killed').textContent = killed;
        document.getElementById('y1-review-active').textContent = active;
        
        // Generate insights
        const insights = generateYear1ReviewInsights(successes, failures, killed, active);
        document.getElementById('y1-review-insights').innerHTML = insights;
        
        // Render the matrix
        renderYear1ReviewMatrix();
        
        // Show modal
        document.getElementById('year1-portfolio-review-modal').classList.remove('hidden');
    }
    
    function switchYear1Matrix(matrixType) {
        year1ReviewMatrix = matrixType;
        
        // Update toggle buttons
        document.querySelectorAll('#year1-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === matrixType);
        });
        
        renderYear1ReviewMatrix();
    }
    
    function renderYear1ReviewMatrix() {
        const config = matrixConfigs[year1ReviewMatrix];
        const container = document.getElementById('year1-matrix-container');
        
        // Collect all projects with their status
        const allProjects = [];
        
        // Completed projects (success)
        gameState.completedProjects.filter(p => p.outcome === 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'success' });
        });
        
        // Completed projects (failed)
        gameState.completedProjects.filter(p => p.outcome !== 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'failed' });
        });
        
        // Killed projects
        gameState.killedProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'killed' });
        });
        
        // Active projects
        gameState.activeProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'active' });
        });
        
        

        // Ensure matrix positions exist for this review set (completed/killed/active).
        // Without this, many projects can default to the center because their positions were never computed.
        const _savedPool = gameState.projectPool;
        const _savedRanked = gameState.rankedProjects;
        try {
            gameState.projectPool = allProjects;
            gameState.rankedProjects = null;
            computeProjectPositions();
        } finally {
            gameState.projectPool = _savedPool;
            gameState.rankedProjects = _savedRanked;
        }
// Build quadrant labels
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        // Build axes
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build project bubbles with outcome status
        const bubblesHtml = allProjects.map(project => {
            // Get positions from pre-computed positions or calculate
            const pos = projectMatrixPositions[project.id]?.[year1ReviewMatrix];
            const xPos = pos ? pos.x : 50;
            const yPos = pos ? 100 - pos.y : 50;
            
            // Size based on budget (40-75px for better mobile touch targets)
            const minBudget = 2, maxBudget = 15;
            const budgetNorm = ((project.budget || 5) - minBudget) / (maxBudget - minBudget);
            const size = 40 + budgetNorm * 35;
            
            // Status colors and labels
            let statusClass, statusColor, statusBorder, statusLabel;
            switch (project.reviewStatus) {
                case 'success':
                    statusColor = '#22c55e';
                    statusBorder = '#166534';
                    statusLabel = '✅ Success';
                    statusClass = 'review-success';
                    break;
                case 'failed':
                    statusColor = '#ef4444';
                    statusBorder = '#b91c1c';
                    statusLabel = '❌ Failed';
                    statusClass = 'review-failed';
                    break;
                case 'killed':
                    statusColor = '#6b7280';
                    statusBorder = '#374151';
                    statusLabel = '🔴 Killed';
                    statusClass = 'review-killed';
                    break;
                case 'active':
                    statusColor = '#3b82f6';
                    statusBorder = '#1d4ed8';
                    statusLabel = '🔵 Active';
                    statusClass = 'review-active';
                    break;
            }
            
            return `
                <div class="project-bubble ${statusClass}" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px; background: ${statusColor}; border: 3px solid ${statusBorder}; cursor: default;"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M </div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.9;">
                            ${statusLabel}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = quadrantsHtml + axesHtml + bubblesHtml;
    }
    
    function generateYear1ReviewInsights(successes, failures, killed, active) {
        const insights = [];
        const totalFunded = successes + failures + active;
        const hitRate = totalFunded > 0 ? Math.round((successes / (successes + failures)) * 100) : 0;
        
        // Overall performance insight
        if (successes > failures) {
            insights.push(`<div style="margin-bottom: 10px;">📈 <strong>Strong Year 1:</strong> ${successes} project(s) succeeded vs ${failures} failure(s). Your selection process is working well.</div>`);
        } else if (failures > successes) {
            insights.push(`<div style="margin-bottom: 10px;">📉 <strong>Challenging Year 1:</strong> ${failures} project(s) failed vs ${successes} success(es). Consider adjusting your criteria for Year 2.</div>`);
        } else {
            insights.push(`<div style="margin-bottom: 10px;">📊 <strong>Mixed Year 1:</strong> Equal successes and failures. Year 2 offers opportunity to improve hit rate.</div>`);
        }
        
        // Kill decisions insight
        if (killed > 0) {
            insights.push(`<div style="margin-bottom: 10px;">🛑 <strong>Portfolio Discipline:</strong> You killed ${killed} project(s). Smart pivots preserve resources for better opportunities.</div>`);
        }
        
        // Active projects insight
        if (active > 0) {
            insights.push(`<div style="margin-bottom: 10px;">🔄 <strong>Continuing Work:</strong> ${active} project(s) carry into Year 2. These represent committed capital and ongoing risk.</div>`);
        }
        
        // Process-based insight
        if (gameState.decisionModel === 'committee' && gameState.committee.length > 3) {
            if (successes > failures) {
                insights.push(`<div style="margin-bottom: 10px;">👥 <strong>Committee Value:</strong> Your ${gameState.committee.length}-person committee helped identify winners.</div>`);
            }
        }
        
        return insights.join('');
    }
    
    function closeYear1PortfolioReview() {
        document.getElementById('year1-portfolio-review-modal').classList.add('hidden');
    }
    
    function closeYear1PortfolioReviewAndContinue() {
        closeYear1PortfolioReview();

        // Enter Year 2 planning flow. In this version, we do NOT run a separate Year 2 scoring/triage stage.
        // Players see project details inside the portfolio builder itself.
        gameState.inYear2PlanningFlow = true;

        // Build the Year 2 candidate pool for selection (no extra assessment screens)
        year2ProjectTriage = {};
        year2SelectedProjects = [];
        year2RankedProjects = generateYear2ProjectPool() || [];
        year2ProjectPool = year2RankedProjects;

        // Ensure all projects carry complete info for landscapes / modals
        year2RankedProjects = year2RankedProjects.map(p => ensureProjectCompleteness(p));

        // Compute overallAvg for each project (synthetic score based on underlying properties)
        // This is used by the portfolio list display since players don't score Year 2 projects
        year2RankedProjects = year2RankedProjects.map(p => {
            // Calculate a synthetic score from successProb and roiMultiplier (scale 1-5)
            const successScore = (p.successProb || 0.5) * 5; // 0-5 based on success probability
            const roiScore = Math.min(5, ((p.roiMultiplier || 2.5) - 1) * 1.5); // 0-5 based on ROI multiplier
            const avgScore = (successScore + roiScore) / 2;
            return { ...p, overallAvg: avgScore };
        });

        // Light ordering for readability: highest expected value first (no player scoring)
        year2RankedProjects.sort((a, b) => {
            const ea = (a.successProb || 0) * (a.roiMultiplier || 2.5);
            const eb = (b.successProb || 0) * (b.roiMultiplier || 2.5);
            return eb - ea;
        });
        year2ProjectPool = year2RankedProjects;

        // Optional Resource Run happens immediately before the Year 2 portfolio builder (Play / Skip)
        maybeStartResourceRunY2(function() { proceedToYear2PortfolioBuilder(); });
    }
    
    // ============================================
    // YEAR 2 PORTFOLIO REVIEW (2x2 Matrix)
    // ============================================
    
    let year2ReviewMatrix = 'risk-speed';
    
    function showYear2PortfolioReview() {
        year2ReviewMatrix = 'risk-speed';
        
        // Update toggle buttons
        document.querySelectorAll('#year2-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === year2ReviewMatrix);
        });
        
        // Calculate stats
        const successes = gameState.completedProjects.filter(p => p.outcome === 'success').length;
        const failures = gameState.completedProjects.filter(p => p.outcome !== 'success').length;
        const killed = gameState.killedProjects.length;
        const active = gameState.activeProjects.length;
        
        document.getElementById('y2-review-success').textContent = successes;
        document.getElementById('y2-review-failed').textContent = failures;
        document.getElementById('y2-review-killed').textContent = killed;
        document.getElementById('y2-review-active').textContent = active;
        
        // Generate insights
        const insights = generateYear2ReviewInsights(successes, failures, killed, active);
        document.getElementById('y2-review-insights').innerHTML = insights;
        
        // Render the matrix
        renderYear2ReviewMatrix();
        
        // Show modal
        document.getElementById('year2-portfolio-review-modal').classList.remove('hidden');
    }
    
    function switchYear2Matrix(matrixType) {
        year2ReviewMatrix = matrixType;
        
        // Update toggle buttons
        document.querySelectorAll('#year2-portfolio-review-modal .matrix-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.matrix === matrixType);
        });
        
        renderYear2ReviewMatrix();
    }
    
    function renderYear2ReviewMatrix() {
        const config = matrixConfigs[year2ReviewMatrix];
        const container = document.getElementById('year2-matrix-container');
        
        // Collect all projects with their status
        const allProjects = [];
        
        // Completed projects (success)
        gameState.completedProjects.filter(p => p.outcome === 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'success' });
        });
        
        // Completed projects (failed)
        gameState.completedProjects.filter(p => p.outcome !== 'success').forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'failed' });
        });
        
        // Killed projects
        gameState.killedProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'killed' });
        });
        
        // Active projects
        gameState.activeProjects.forEach(p => {
            allProjects.push({ ...p, reviewStatus: 'active' });
        });
        
        // Build quadrant labels
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        // Build axes
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build project bubbles
        let bubblesHtml = '';
        allProjects.forEach(project => {
            const scores = project.scores || {};
            const xScore = scores[config.xAxis.key] || 3;
            const yScore = scores[config.yAxis.key] || 3;
            
            // Convert 1-5 score to percentage position (inverted for y)
            const xPos = ((xScore - 1) / 4) * 80 + 10;
            const yPos = 90 - ((yScore - 1) / 4) * 80;
            
            // Status-based colors
            let bgColor, borderColor;
            switch (project.reviewStatus) {
                case 'success':
                    bgColor = '#22c55e';
                    borderColor = '#166534';
                    break;
                case 'failed':
                    bgColor = '#ef4444';
                    borderColor = '#b91c1c';
                    break;
                case 'killed':
                    bgColor = '#6b7280';
                    borderColor = '#374151';
                    break;
                case 'active':
                default:
                    bgColor = '#3b82f6';
                    borderColor = '#1d4ed8';
                    break;
            }
            
            bubblesHtml += `
                <div class="project-bubble" 
                     style="left: ${xPos}%; top: ${yPos}%; background: ${bgColor}; border: 2px solid ${borderColor};"
                     title="${project.name} (${project.reviewStatus})">
                    <span class="bubble-label">${(project.name || '').substring(0, 3)}</span>
                </div>
            `;
        });
        
        container.innerHTML = quadrantsHtml + axesHtml + bubblesHtml;
    }
    
    function generateYear2ReviewInsights(successes, failures, killed, active) {
        const total = successes + failures + killed;
        const successRate = total > 0 ? Math.round((successes / total) * 100) : 0;
        
        let insights = [];
        
        if (successRate >= 70) {
            insights.push('🎯 <strong>Excellent track record!</strong> Your high success rate shows strong project selection and management.');
        } else if (successRate >= 50) {
            insights.push('📊 <strong>Solid performance.</strong> Your portfolio is performing at industry average.');
        } else if (total > 0) {
            insights.push('⚠️ <strong>Learning opportunity.</strong> Use Year 2 to apply lessons from earlier challenges.');
        }
        
        if (active > 6) {
            insights.push('📈 <strong>Large portfolio.</strong> With ' + active + ' active projects, ensure you have bandwidth to manage them all effectively.');
        } else if (active >= 4) {
            insights.push('✅ <strong>Healthy portfolio size.</strong> ' + active + ' active projects is a manageable load for Year 2.');
        } else if (active > 0) {
            insights.push('🎯 <strong>Focused portfolio.</strong> ' + active + ' projects allows for concentrated attention and resources.');
        }
        
        // Check strategic balance
        const bucketCounts = {};
        gameState.activeProjects.forEach(p => {
            (p.strategicBuckets || []).forEach(b => {
                bucketCounts[b.name] = (bucketCounts[b.name] || 0) + 1;
            });
        });
        
        const bucketNames = Object.keys(bucketCounts);
        if (bucketNames.length >= 3) {
            insights.push('🔀 <strong>Diversified strategy.</strong> Your portfolio spans multiple strategic buckets.');
        } else if (bucketNames.length === 1) {
            insights.push('🎯 <strong>Concentrated bet.</strong> All projects in one strategic area—high risk, high reward.');
        }
        
        return insights.length > 0 
            ? '<ul style="list-style: none; padding: 0; margin: 0;">' + insights.map(i => '<li style="margin-bottom: 8px;">' + i + '</li>').join('') + '</ul>'
            : '<p style="color: var(--gray-500); text-align: center;">Your Year 2 portfolio is set. Good luck!</p>';
    }
    
    function closeYear2PortfolioReview() {
        document.getElementById('year2-portfolio-review-modal').classList.add('hidden');
    }
    
    function closeYear2PortfolioReviewAndContinue() {
        closeYear2PortfolioReview();
        // After Year 2 project selection, go to budget meeting
        showYear2BudgetMeeting();
    }
    
    function finalConfirmYear1EndSelection() {
        // Add selected Year 1 End projects to active projects
        year1EndSelectedProjects.forEach(projectId => {
            const project = year1EndProjectPool.find(p => p.id === projectId);
            if (project) {
                // Prepare the project for the active portfolio
                const activeProject = {
                    ...project,
                    status: 'active',
                    progress: 0,
                    currentQuarter: 0,
                    quartersActive: 0,
                    spentBudget: 0,
                    startQuarter: gameState.currentQuarter,
                    isYear1EndProject: true,
                    decision: 'continue'
                };
                
                // Add quarter narratives if not present
                if (!activeProject.quarterNarratives) {
                    activeProject.quarterNarratives = {
                        good: ['Making good progress.', 'Team aligned and executing.'],
                        bad: ['Facing some challenges.', 'Timeline pressure building.']
                    };
                }
                
                ensureProjectCompleteness(activeProject);
                gameState.activeProjects.push(activeProject);
                gameState.budget -= project.budget;
            }
        });
        
        // Show portfolio review for fine-tuning before continuing to Year 2
        showYear1PortfolioReview();
    }
    
    // ============================================
    // YEAR 2 PROJECT TEMPLATES
    // ============================================
    
    const year2ProjectTemplates = [
        { 
            archetype: 'market_response', 
            names: ['RapidResponse Kit', 'MarketMatch Pro', 'CompetitorBlock'], 
            descs: [
                'Quick-deploy security bundle responding to competitor\'s new budget line. Pre-configured system with 1 hub, 3 sensors, 1 camera at $55. Fast-track development using existing components in new package. 3-month launch target.',
                'Smart pricing tool that automatically adjusts product recommendations based on competitor pricing from e-commerce sites. Real-time market intelligence dashboard for sales team.',
                'Feature update to match competitor\'s new smart home integration capabilities. Wireless update for existing ShieldOS devices enabling voice assistant compatibility.'
            ], 
            budgetRange: [3, 5], baseSuccess: 0.60, 
            scores: { technical: 4, marketsize: 4, strategic: 4, team: 4, capability: 5, ip: 2, platform: 3, sustainability: 2, newmarket: 2, geographic: 4, competitive: 4, devcost: 4, roi: 4, speed: 5, risk: 3 }, 
            quarterNarratives: { good: ['Market response on schedule.', 'Competitive positioning strengthening.'], bad: ['Competitor moving faster.', 'Feature scope creeping.'] }, 
            outcomeNarrative: { success: 'Maintained market position against competitive threat.', failure: 'Too little too late—competitor captured segment.' } 
        },
        { 
            archetype: 'partnership_opportunity', 
            names: ['TelcoSafe Bundle', 'InsuranceLink', 'BuilderConnect'], 
            descs: [
                'Co-branded security bundle with Jio/Airtel for broadband subscribers. Revenue-sharing model with telecom handling distribution. Custom software with telecom partner branding. Exclusive 18-month partnership terms negotiated.',
                'Insurance-integrated system where ShieldTech alerts reduce home insurance premiums. Software connection with ICICI Lombard and HDFC Ergo. Automated claim reporting. New recurring revenue stream from commission.',
                'Pre-wired security infrastructure for new residential developments. Partnership with Godrej Properties, Sobha, and Brigade. Bulk pricing model with installation during construction phase.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            scores: { technical: 3, marketsize: 5, strategic: 5, team: 3, capability: 4, ip: 2, platform: 4, sustainability: 3, newmarket: 4, geographic: 4, competitive: 4, devcost: 3, roi: 5, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Partner integration progressing well.', 'Deal terms finalized.'], bad: ['Partner internal delays.', 'Contract negotiations stalled.'] }, 
            outcomeNarrative: { success: 'Partnership opened major new distribution channel.', failure: 'Partnership fell through—pivoted to direct strategy.' } 
        },
        { 
            archetype: 'tech_refresh', 
            names: ['NextGen Sensor Array', 'CloudOS 2.0', 'BatteryMax Upgrade'], 
            descs: [
                'Complete sensor technology refresh using latest millimeter-wave radar chips. 50% better detection accuracy, 30% lower power consumption. Direct replacement for current sensor line with backward compatibility.',
                'Major platform update: new mobile app design, cloud migration to AWS, and modernized connections for faster third-party integrations. Enables subscription services revenue model.',
                'Battery optimization across product line. New power management chip design reducing standby power use by 40%. Solar charging compatibility. Extends field life from 18 to 30 months.'
            ], 
            budgetRange: [5, 7], baseSuccess: 0.70, 
            scores: { technical: 5, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 4, platform: 5, sustainability: 4, newmarket: 3, geographic: 3, competitive: 5, devcost: 3, roi: 4, speed: 3, risk: 3 }, 
            quarterNarratives: { good: ['Technical specs exceeding targets.', 'Platform foundation solid.'], bad: ['Migration complexity higher than expected.', 'Backward compatibility issues emerging.'] }, 
            outcomeNarrative: { success: 'Technology refresh positioned ShieldTech for next 3 years.', failure: 'Partial rollout—full refresh deferred to next cycle.' } 
        },
        { 
            archetype: 'emerging_segment', 
            names: ['SmallBiz Secure', 'TempleGuard', 'SchoolSafe System'], 
            descs: [
                'Tailored solution for small retail shops and offices (500-2000 sq ft). Cash drawer sensors, staff panic buttons, HD cameras connected to point-of-sale. Monthly subscription model at $12/month including monitoring.',
                'Specialized system for religious institutions: temples, churches, mosques. Donation box security, crowd monitoring during festivals, integration with management committee alerts. Culturally appropriate design.',
                'School security platform with student tracking (ID cards), perimeter alerts, classroom panic buttons, and parent notification system. School board compliance documentation. Pilot with 5 schools underway.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.55, 
            scores: { technical: 3, marketsize: 4, strategic: 4, team: 3, capability: 4, ip: 3, platform: 4, sustainability: 4, newmarket: 5, geographic: 4, competitive: 4, devcost: 4, roi: 3, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Segment validation positive.', 'Early adopters enthusiastic.'], bad: ['Segment needs are more specialized than expected.', 'Sales cycle longer in B2B.'] }, 
            outcomeNarrative: { success: 'New B2B segment opened with strong recurring revenue.', failure: 'Segment viable but requires dedicated sales team we don\'t have.' } 
        },
        { 
            archetype: 'acquisition_integration', 
            names: ['VideoAI Merger', 'LocalBrand Acquisition', 'Patent Portfolio Buy'], 
            descs: [
                'Integration of acquired Bangalore AI startup\'s computer vision technology. Their on-device smart detection models outperform ours for human detection. Team of 12 engineers needs integration into ShieldTech processes.',
                'Acquisition of regional brand strong in South India (40% market share in Kerala/TN). Integration of their dealer network, service centers, and local product variants. Brand transition planning.',
                'Acquisition of defensive patent portfolio from struggling competitor. 23 patents covering motion detection methods, encrypted communications, and smart lock mechanisms. Potential licensing revenue.'
            ], 
            budgetRange: [6, 9], baseSuccess: 0.50, 
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 3, capability: 3, ip: 5, platform: 4, sustainability: 3, newmarket: 4, geographic: 4, competitive: 5, devcost: 2, roi: 4, speed: 2, risk: 2 }, 
            quarterNarratives: { good: ['Integration proceeding smoothly.', 'Synergies materializing.'], bad: ['Cultural integration challenging.', 'Hidden technical debt discovered.'] }, 
            outcomeNarrative: { success: 'Acquisition accelerated capabilities by 2 years.', failure: 'Integration took longer than expected but core value captured.' } 
        },
        { 
            archetype: 'regulatory_opportunity', 
            names: ['BIS Certified Pro', 'FireSafe Combo', 'DataLocal System'], 
            descs: [
                'First-to-market certified smart lock meeting new 2024 mandatory Indian standards. Competitors need 6-12 months to comply. Window of opportunity for premium pricing and government contracts.',
                'Integrated fire + security system meeting National Building Code requirements for commercial spaces. Smoke detection, sprinkler integration, and evacuation alerts. Required for new commercial building permits.',
                'India data localization compliant system with all data processing and storage within Indian borders. Targets government and banking sector customers with strict data location requirements.'
            ], 
            budgetRange: [4, 6], baseSuccess: 0.65, 
            scores: { technical: 4, marketsize: 4, strategic: 5, team: 4, capability: 4, ip: 3, platform: 3, sustainability: 3, newmarket: 4, geographic: 5, competitive: 5, devcost: 3, roi: 4, speed: 4, risk: 3 }, 
            quarterNarratives: { good: ['Certification on track.', 'Government tender submitted.'], bad: ['Compliance requirements evolving.', 'Certification delays.'] }, 
            outcomeNarrative: { success: 'Regulatory first-mover advantage captured market share.', failure: 'Certification delayed—competitors caught up.' } 
        }
    ];
    
    // State for Year 2 selection
    let year2ProjectPool = [];
    let year2SelectedProjects = [];
    let year2AvailableBudget = 0;
    
    function generateYear2ProjectPool() {
        console.log('generateYear2ProjectPool called');
        console.log('year2ProjectTemplates:', year2ProjectTemplates);
        
        const pool = [];
        const usedNames = new Set();
        let projectId = 100; // Start from 100 to avoid collision with Year 1 projects
        
        // Shuffle templates and pick a subset
        const shuffled = shuffleArray([...year2ProjectTemplates]);
        console.log('Shuffled templates:', shuffled.length);
        const templatesToUse = shuffled.slice(0, 3); // Use 3 templates to generate 3-5 projects
        console.log('Templates to use:', templatesToUse.length);
        
        for (const template of templatesToUse) {
            const count = 1 + Math.floor(Math.random() * 2); // 1-2 projects per template
            const indices = shuffleArray([...Array(template.names.length).keys()]).slice(0, count);
            console.log('Template:', template.archetype, 'count:', count, 'indices:', indices);
            
            // Stop if we already have 5 projects
            if (pool.length >= 5) break;
            
            for (const i of indices) {
                // Stop if we already have 5 projects
                if (pool.length >= 5) break;
                
                const name = template.names[i];
                console.log('Processing name:', name, 'index:', i);
                if (usedNames.has(name)) {
                    console.log('Skipping duplicate name:', name);
                    continue;
                }
                usedNames.add(name);
                
                const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                const budget = Math.round(budgetRaw * 10) / 10;
                
                // Generate success probability and round it
                const successProbRaw = template.baseSuccess + (Math.random() * 0.1 - 0.05);
                const successProb = Math.round(successProbRaw * 100) / 100;
                
                const desc = (template.descs && (template.descs[i] || template.descs[0])) ? (template.descs[i] || template.descs[0]) : '';
                const riskClass = getProjectRiskClassForProject(name, template.archetype);

                const project = {
                    id: 'y2proj-' + projectId,
                    numId: projectId,
                    name: name,
                    desc: desc,
                    description: desc,
                    shortDesc: desc,
                    fullDesc: desc,
                    tagline: getYear2Tagline(template.archetype),
                    archetype: template.archetype,
                    riskClass: riskClass,
                    budget: budget,
                    successProb: Math.max(0.05, Math.min(0.95, successProb)),
                    scores: { ...template.scores },
                    quarterNarratives: template.quarterNarratives,
                    outcomeNarrative: template.outcomeNarrative,
                    timeline: 4 + Math.floor(Math.random() * 3), // 4-6 quarters for Year 2 projects (run Q5-Q10)
                    status: 'proposed',
                    isYear2Project: true,
                    // Add team info with lead object structure matching Year 1
                    team: generateRandomTeam(),
                    lead: generateYear2ProjectLead(),
                    // Add strategic buckets
                    strategicBuckets: generateStrategicBuckets(template.archetype),
                    // Add milestones
                    milestones: getMilestones(template.archetype, budget),
                    // Add Year 1-style data
                    marketContext: generateProjectMarketContext(name, desc, template.archetype, riskClass),
                    capabilityFit: generateYear2CapabilityFit(template.archetype),
                    trl: getYear2TRL(template.archetype),
                    ipPosition: getYear2IPPosition(template.archetype),
                    competitors: generateProjectCompetitors(name, template.archetype, riskClass),
                    developmentCosts: getDevelopmentCosts(budget, template.archetype),
                    financials: generateYear2Financials(budget, template.archetype),
                    // Add quarterly updates array
                    quarterlyUpdates: []
                };
                
                console.log('Created project:', project.name, project.id);
                pool.push(project);
                
                projectId++;
            }
        }
        
        // Ensure minimum of 3 projects - if we somehow got fewer, add from remaining templates
        if (pool.length < 3) {
            const remainingTemplates = shuffled.slice(3);
            for (const template of remainingTemplates) {
                if (pool.length >= 3) break;
                const name = template.names[0];
                if (!usedNames.has(name)) {
                    const budgetRaw = template.budgetRange[0] + Math.random() * (template.budgetRange[1] - template.budgetRange[0]);
                    const budget = Math.round(budgetRaw * 10) / 10;
                    const successProbRaw = template.baseSuccess + (Math.random() * 0.1 - 0.05);
                    const successProb = Math.round(successProbRaw * 100) / 100;
                    const riskClass = getProjectRiskClassForProject(name, template.archetype);
                    
                    pool.push({
                        id: 'y2proj-' + projectId,
                        numId: projectId,
                        name: name,
                        desc: template.descs[0],
                        description: template.descs[0],
                        shortDesc: template.descs[0],
                        fullDesc: template.descs[0],
                        tagline: getYear2Tagline(template.archetype),
                        archetype: template.archetype,
                        riskClass: riskClass,
                    
                        budget: budget,
                        successProb: Math.max(0.05, Math.min(0.95, successProb)),
                        scores: { ...template.scores },
                        quarterNarratives: template.quarterNarratives,
                        outcomeNarrative: template.outcomeNarrative,
                        timeline: 4 + Math.floor(Math.random() * 3),
                        status: 'proposed',
                        isYear2Project: true,
                        team: generateRandomTeam(),
                        lead: generateYear2ProjectLead(),
                        strategicBuckets: generateStrategicBuckets(template.archetype),
                        milestones: getMilestones(template.archetype, budget),
                        marketContext: generateProjectMarketContext(name, desc, template.archetype, riskClass),
                        capabilityFit: generateYear2CapabilityFit(template.archetype),
                        trl: getYear2TRL(template.archetype),
                        ipPosition: getYear2IPPosition(template.archetype),
                        competitors: generateProjectCompetitors(name, template.archetype, riskClass),
                        developmentCosts: getDevelopmentCosts(budget, template.archetype),
                        financials: generateYear2Financials(budget, template.archetype),
                        quarterlyUpdates: []
                    });
                    projectId++;
                }
            }
        }
        
        console.log('Final Year 2 pool size:', pool.length, '(target: 3-5)');
        balanceProjectPoolByRisk(pool, 'year2');
        pool.forEach(ensureProjectCompleteness);
        return pool;
    }
    
    // Year 2 specific helper functions
    function generateYear2ProjectLead() {
        const leads = [
            { name: 'Priya Sharma', role: 'Senior Product Manager', initials: 'PS', avatarColor: '#6366f1', trackRecord: { successes: 3, failures: 1, partial: 1 } },
            { name: 'Rahul Mehta', role: 'Engineering Lead', initials: 'RM', avatarColor: '#22c55e', trackRecord: { successes: 2, failures: 1, partial: 2 } },
            { name: 'Ananya Gupta', role: 'Technical Architect', initials: 'AG', avatarColor: '#f59e0b', trackRecord: { successes: 4, failures: 1, partial: 0 } },
            { name: 'Vikram Singh', role: 'Product Director', initials: 'VS', avatarColor: '#ef4444', trackRecord: { successes: 2, failures: 2, partial: 1 } },
            { name: 'Deepa Krishnan', role: 'Innovation Lead', initials: 'DK', avatarColor: '#8b5cf6', trackRecord: { successes: 1, failures: 0, partial: 2 } },
            { name: 'Arjun Patel', role: 'Platform Architect', initials: 'AP', avatarColor: '#06b6d4', trackRecord: { successes: 3, failures: 2, partial: 1 } },
            { name: 'Kavita Reddy', role: 'Senior Engineer', initials: 'KR', avatarColor: '#ec4899', trackRecord: { successes: 2, failures: 1, partial: 1 } },
            { name: 'Nikhil Verma', role: 'Product Manager', initials: 'NV', avatarColor: '#14b8a6', trackRecord: { successes: 1, failures: 1, partial: 1 } }
        ];
        return leads[Math.floor(Math.random() * leads.length)];
    }
    
    function generateYear2MarketContext(archetype) {
        const contexts = {
            'market_response': 'Competitors have launched aggressive new products targeting our core segments. Market share data shows 3-5% erosion in the past two quarters. Quick response needed to defend position.',
            'partnership_opportunity': 'Strategic partners are actively seeking security integration providers. Market research indicates bundled offerings see 40% higher adoption rates than standalone products.',
            'tech_refresh': 'Current platform technology is approaching end-of-life. Customer feedback consistently requests modern features available in competitor products. Platform refresh enables 3-year product roadmap.',
            'emerging_segment': 'New market segment showing 25% YoY growth with limited competition. Early mover advantage window estimated at 12-18 months before larger players enter.',
            'acquisition_integration': 'Acquisition target brings complementary capabilities and customer base. Integration synergies estimated at $2-4M annually once complete.',
            'regulatory_opportunity': 'New regulatory requirements create compliance demand. First-to-market certified solution can capture premium pricing and government contracts.'
        };
        return contexts[archetype] || 'New market opportunity identified with favorable competitive dynamics and growth potential.';
    }
    
    function generateYear2CapabilityFit(archetype) {
        const fits = {
            'market_response': 'Strong fit with existing hardware and manufacturing capabilities. Leverages current component inventory and production lines. Engineering team has relevant experience from similar rapid-response projects.',
            'partnership_opportunity': 'Moderate capability fit requiring new integration work. Partner APIs and systems will need custom connectors. Business development team has established relationships.',
            'tech_refresh': 'Core platform work within engineering team\'s expertise. Some new skills needed for cloud migration. Training plan included in project scope.',
            'emerging_segment': 'Product development capabilities well-suited. Sales and support for new segment will require hiring or reallocation. Marketing needs segment-specific expertise.',
            'acquisition_integration': 'Integration work requires dedicated team. Cultural alignment efforts needed. Technology stack differences manageable with proper planning.',
            'regulatory_opportunity': 'Compliance expertise available in-house. Certification process familiar from previous products. Documentation capabilities adequate.'
        };
        return fits[archetype] || 'Capability assessment indicates manageable development with existing team and resources.';
    }
    
    function getYear2TRL(archetype) {
        const trls = {
            'market_response': { current: 6, target: 9, note: 'Using proven components in new configuration' },
            'partnership_opportunity': { current: 5, target: 8, note: 'Integration requires partner system validation' },
            'tech_refresh': { current: 4, target: 8, note: 'Platform modernization with some new technology' },
            'emerging_segment': { current: 5, target: 8, note: 'Adapting existing tech for new market' },
            'acquisition_integration': { current: 6, target: 8, note: 'Acquired tech needs ShieldTech integration' },
            'regulatory_opportunity': { current: 5, target: 9, note: 'Compliance certification is key milestone' }
        };
        return trls[archetype] || { current: 5, target: 8, note: 'Standard development trajectory' };
    }
    
    function getYear2IPPosition(archetype) {
        const positions = {
            'market_response': { shieldtech: 'Defensive patents available', competitors: 'Some freedom-to-operate concerns', fto: 'Generally clear', risk: 'Low' },
            'partnership_opportunity': { shieldtech: 'Joint IP to be negotiated', competitors: 'Partner landscape complex', fto: 'Requires partner agreement', risk: 'Medium' },
            'tech_refresh': { shieldtech: 'Building on existing IP', competitors: 'Standard industry practices', fto: 'Clear path', risk: 'Low' },
            'emerging_segment': { shieldtech: 'Opportunity for new filings', competitors: 'Limited prior art', fto: 'Open field', risk: 'Low' },
            'acquisition_integration': { shieldtech: 'Acquired IP included', competitors: 'Due diligence complete', fto: 'Secured through acquisition', risk: 'Low' },
            'regulatory_opportunity': { shieldtech: 'Compliance methods patentable', competitors: 'Racing to file', fto: 'Timing critical', risk: 'Medium' }
        };
        return positions[archetype] || { shieldtech: 'Standard position', competitors: 'Normal competitive landscape', fto: 'Under review', risk: 'Medium' };
    }
    
    function getYear2Competitors(archetype) {
        const competitorSets = {
            'market_response': [
                { name: 'SecureHome Pro', position: 'Aggressive pricing in metros', threat: 'High' },
                { name: 'GuardianTech', position: 'Strong dealer network', threat: 'Medium' }
            ],
            'partnership_opportunity': [
                { name: 'ConnectSafe', position: 'Existing telco partnerships', threat: 'High' },
                { name: 'SmartSecure', position: 'Insurance integrations', threat: 'Medium' }
            ],
            'tech_refresh': [
                { name: 'NextGen Security', position: 'Modern cloud platform', threat: 'Medium' },
                { name: 'TechShield', position: 'AI-first approach', threat: 'Medium' }
            ],
            'emerging_segment': [
                { name: 'Local Niche Player', position: 'Segment expertise', threat: 'Medium' },
                { name: 'Regional Specialist', position: 'Geographic presence', threat: 'Low' }
            ],
            'acquisition_integration': [
                { name: 'Market Leader', position: 'Scale advantage', threat: 'High' },
                { name: 'Fast Follower', position: 'Watching our move', threat: 'Medium' }
            ],
            'regulatory_opportunity': [
                { name: 'Compliance First', position: 'Regulatory expertise', threat: 'High' },
                { name: 'Legacy Provider', position: 'Incumbent relationships', threat: 'Medium' }
            ]
        };
        return competitorSets[archetype] || [{ name: 'Generic Competitor', position: 'Market presence', threat: 'Medium' }];
    }
    
    function generateYear2Financials(budget, archetype) {
        const multipliers = {
            'market_response': { rev1: 10, rev2: 18, margin: 32, breakeven: 10 },
            'partnership_opportunity': { rev1: 8, rev2: 20, margin: 35, breakeven: 14 },
            'tech_refresh': { rev1: 4, rev2: 14, margin: 45, breakeven: 18 },
            'emerging_segment': { rev1: 5, rev2: 15, margin: 38, breakeven: 16 },
            'acquisition_integration': { rev1: 6, rev2: 18, margin: 40, breakeven: 20 },
            'regulatory_opportunity': { rev1: 8, rev2: 16, margin: 42, breakeven: 12 }
        };
        const m = multipliers[archetype] || { rev1: 6, rev2: 14, margin: 35, breakeven: 16 };
        return {
            devCost: '$' + budget.toFixed(1) + 'M',
            timeline: (3 + Math.floor(Math.random() * 2)) + ' quarters',
            projectedRevenue: '$' + Math.round(budget * m.rev1) + 'M (Y1), $' + Math.round(budget * m.rev2) + 'M (Y2)',
            grossMargin: m.margin + '%',
            breakeven: m.breakeven + ' months'
        };
    }
    
    function getYear2Tagline(archetype) {
        const taglines = {
            'market_response': 'Rapid response to competitive pressure',
            'partnership_opportunity': 'Strategic alliance with distribution potential',
            'tech_refresh': 'Platform modernization for future growth',
            'emerging_segment': 'New market segment with growth potential',
            'acquisition_integration': 'Inorganic growth opportunity',
            'regulatory_opportunity': 'First-mover advantage from compliance'
        };
        return taglines[archetype] || 'New strategic opportunity';
    }
    
    function generateRandomTeam() {
        const leads = [
            { name: 'Priya Sharma', title: 'Senior Product Manager' },
            { name: 'Rahul Mehta', title: 'Engineering Lead' },
            { name: 'Ananya Gupta', title: 'Technical Architect' },
            { name: 'Vikram Singh', title: 'Product Director' },
            { name: 'Deepa Krishnan', title: 'Innovation Lead' },
            { name: 'Arjun Patel', title: 'Platform Architect' },
            { name: 'Kavita Reddy', title: 'Senior Engineer' },
            { name: 'Nikhil Verma', title: 'Product Manager' }
        ];
        
        const lead = leads[Math.floor(Math.random() * leads.length)];
        return {
            lead: lead.name,
            leadTitle: lead.title,
            size: 4 + Math.floor(Math.random() * 8)
        };
    }
    
    function generateStrategicBuckets(archetype) {
        const bucketMap = {
            'quick_win': [{ id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' }],
            'market_response': [{ id: 'defend-metro', name: 'Defend Metro', icon: '🛡️', color: '#2563eb' }],
            'partnership_opportunity': [{ id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' }],
            'tech_refresh': [{ id: 'ai-first', name: 'AI-First', icon: '🤖', color: '#dc2626' }],
            'emerging_segment': [{ id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' }],
            'acquisition_integration': [{ id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' }],
            'regulatory_opportunity': [{ id: 'defend-metro', name: 'Defend Metro', icon: '🛡️', color: '#2563eb' }],
            // Year 1 archetypes
            'incremental': [{ id: 'defend-metro', name: 'Defend Metro', icon: '🛡️', color: '#2563eb' }],
            'platform': [{ id: 'ai-first', name: 'AI-First', icon: '🤖', color: '#dc2626' }],
            'adjacent': [{ id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' }],
            'breakthrough': [{ id: 'ai-first', name: 'AI-First', icon: '🤖', color: '#dc2626' }],
            'moonshot': [{ id: 'ai-first', name: 'AI-First', icon: '🤖', color: '#dc2626' }],
            'service': [{ id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' }],
            'geographic': [{ id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' }],
            'partnership': [{ id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' }],
            'defensive': [{ id: 'defend-metro', name: 'Defend Metro', icon: '🛡️', color: '#2563eb' }],
            'sustaining': [{ id: 'defend-metro', name: 'Defend Metro', icon: '🛡️', color: '#2563eb' }]
        };
        
        return bucketMap[archetype] || [{ id: 'ai-first', name: 'AI-First', icon: '🤖', color: '#dc2626' }];
    }
    
    // ============================================
    // YEAR 2 ASSESSMENT SYSTEM
    // ============================================
    
    let year2ScoringApproach = null;
    let year2TeamBlinding = null;
    let year2CurrentProjectIndex = 0;
    let year2RankedProjects = [];
    let year2ProjectTriage = {};
    let year2ApproachChoice = null; // 'same' or 'change'
    
    function startYear2Assessment() {
        // Defensive: entering Year 2 planning flow
        gameState.inYear2PlanningFlow = true;

        // Generate the Year 2 project pool first
        year2ProjectPool = generateYear2ProjectPool();
        year2SelectedProjects = [];
        year2CurrentProjectIndex = 0;
        year2RankedProjects = [];
        year2ProjectTriage = {};
        year2ApproachChoice = null;
        
        // Use same approach as Year 1 by default
        year2ScoringApproach = gameState.scoringApproach || 'careful';
        year2TeamBlinding = gameState.teamBlinding || 'visible';
        
        // Initialize triage for all projects
        year2ProjectPool.forEach(p => {
            year2ProjectTriage[p.id] = 'marginal';
        });
        
        // For solo or random modes, skip the assessment and go directly to selection
        if (gameState.decisionModel === 'solo' || gameState.decisionModel === 'random') {
            // Calculate committee scores
            calculateYear2CommitteeScores();
            
            // For random mode, auto-select projects
            if (gameState.decisionModel === 'random') {
                autoSelectYear2Projects();
            }
            
            // Go to selection
            maybeStartResourceRunY2(proceedToYear2PortfolioBuilder);
            return;
        }
        
        // For delegate mode, skip player scoring
        if (year2ScoringApproach === 'delegate') {
            calculateYear2CommitteeScores();
            showYear2CommitteeFeedback();
            return;
        }
        
        // Go directly to assessment - no approach modal
        renderYear2Assessment();
        showPhase('year2-assessment');
    }
    
    function autoSelectYear2Projects() {
        // Randomly select 1-3 projects within budget
        const shuffled = shuffleArray([...year2ProjectPool]);
        const numToSelect = 1 + Math.floor(Math.random() * 3);
        let budgetRemaining = year2AvailableBudget;
        
        for (let i = 0; i < Math.min(numToSelect, shuffled.length); i++) {
            if (shuffled[i].budget <= budgetRemaining) {
                year2SelectedProjects.push(shuffled[i].id);
                budgetRemaining -= shuffled[i].budget;
            }
        }
    }
    
    function selectYear2ApproachOption(value) {
        year2ApproachChoice = value;
        
        // Update visual selection
        document.querySelectorAll('.approach-option[data-choice="year2approach"]').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="year2approach"][data-value="${value}"]`).classList.add('selected');
        
        if (value === 'same') {
            // Use same approach as Year 1 (with fallback defaults)
            year2ScoringApproach = gameState.scoringApproach || 'careful';
            year2TeamBlinding = gameState.teamBlinding || 'visible';
            document.getElementById('year2-change-options').classList.add('hidden');
            updateYear2ApproachButton();
        } else {
            // Show change options
            year2ScoringApproach = null;
            year2TeamBlinding = null;
            document.getElementById('year2-change-options').classList.remove('hidden');
            document.querySelectorAll('#year2-change-options .approach-option').forEach(opt => opt.classList.remove('selected'));
            updateYear2ApproachButton();
        }
    }
    
    function selectYear2ScoringOption(value) {
        year2ScoringApproach = value;
        document.querySelectorAll('.approach-option[data-choice="y2scoring"]').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="y2scoring"][data-value="${value}"]`).classList.add('selected');
        updateYear2ApproachButton();
    }
    
    function selectYear2BlindingOption(value) {
        year2TeamBlinding = value;
        document.querySelectorAll('.approach-option[data-choice="y2blinding"]').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.approach-option[data-choice="y2blinding"][data-value="${value}"]`).classList.add('selected');
        updateYear2ApproachButton();
    }
    
    function updateYear2ApproachButton() {
        const btn = document.getElementById('year2-approach-confirm-btn');
        
        if (year2ScoringApproach && year2TeamBlinding) {
            btn.disabled = false;
            const scoringLabels = {
                'careful': 'Careful Evaluation',
                'rapid': 'Rapid Screening',
                'delegate': 'Committee Scoring'
            };
            btn.textContent = `Begin ${scoringLabels[year2ScoringApproach]} →`;
        } else {
            btn.disabled = true;
            btn.textContent = year2ApproachChoice === 'change' ? 'Select Both Options' : 'Select an Option to Continue';
        }
    }
    
    function confirmYear2Approach() {
        if (!year2ScoringApproach || !year2TeamBlinding) return;
        
        // Close modal
        document.getElementById('year2-approach-modal').classList.add('hidden');
        
        // Initialize triage for Year 2 projects
        year2ProjectPool.forEach(p => {
            year2ProjectTriage[p.id] = 'marginal';
        });
        
        if (year2ScoringApproach === 'delegate') {
            // Skip to committee feedback
            calculateYear2CommitteeScores();
            showYear2CommitteeFeedback();
        } else {
            // Start player assessment
            year2CurrentProjectIndex = 0;
            renderYear2Assessment();
            showPhase('year2-assessment');
        }
    }
    
    function renderYear2Assessment() {
        const project = year2ProjectPool[year2CurrentProjectIndex];
        
        // Update counter
        document.getElementById('year2-project-counter-current').textContent = year2CurrentProjectIndex + 1;
        document.getElementById('year2-project-counter-total').textContent = year2ProjectPool.length;
        
        // Update progress bar
        const progress = ((year2CurrentProjectIndex) / year2ProjectPool.length) * 100;
        document.getElementById('year2-assessment-progress').style.width = `${progress}%`;
        
        // Render project card
        renderYear2ProjectCard(project);
        
        // Render quick triage (Year 2 does not use criteria scoring)
        renderYear2TriageControls(project);
        
        // Update buttons
        document.getElementById('year2-prev-project-btn').disabled = year2CurrentProjectIndex === 0;
        document.getElementById('year2-next-project-btn').textContent = 
            year2CurrentProjectIndex === year2ProjectPool.length - 1 ? 'Complete Assessment →' : 'Next Project →';
    }
    
    function renderYear2ProjectCard(project) {
        const showTeam = year2TeamBlinding === 'visible';
        
        // Calculate lead track record
        const leadTrackPct = project.lead?.trackRecord ? 
            Math.round(((project.lead.trackRecord.successes + project.lead.trackRecord.partial * 0.5) / 
            (project.lead.trackRecord.successes + project.lead.trackRecord.failures + project.lead.trackRecord.partial)) * 100) : null;
        const leadTrackClass = leadTrackPct >= 70 ? 'success' : leadTrackPct >= 50 ? 'warning' : 'danger';
        
        let html = `
            <div class="project-header">
                <div class="project-badge year2">Year 2 Opportunity</div>
                <h2>${project.name}</h2>
                <p class="project-tagline">${project.tagline}</p>
                            ${renderInnovationBadges(project, true)}
</div>
            
            <div class="strategic-buckets">
                ${(project.strategicBuckets || []).map(bucket => `
                    <span class="strategic-bucket" style="background: ${bucket.color}20; color: ${bucket.color}; border: 1px solid ${bucket.color}40;">
                        ${bucket.icon} ${bucket.name}
                    </span>
                `).join('')}
            </div>
            
            <!-- KEY FACTS SUMMARY -->
            <div class="key-facts-grid">
                <div class="key-fact">
                    <div class="key-fact-value">$${project.budget.toFixed(1)}M</div>
                    <div class="key-fact-label">Budget</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">${project.timeline}Q</div>
                    <div class="key-fact-label">Timeline</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">TRL ${project.trl?.current || '?'} → ${project.trl?.target || '?'}</div>
                    <div class="key-fact-label">Tech Readiness</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">${project.financials?.grossMargin || 'TBD'}</div>
                    <div class="key-fact-label">Gross Margin</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value">${project.financials?.breakeven || 'TBD'}</div>
                    <div class="key-fact-label">Breakeven</div>
                </div>
                <div class="key-fact">
                    <div class="key-fact-value fto-${(project.ipPosition?.risk || 'unknown').toLowerCase().replace('-', '')}">${project.ipPosition?.risk || '?'}</div>
                    <div class="key-fact-label">IP Risk</div>
                </div>
            </div>
            
            <!-- PROJECT DESCRIPTION -->
            <div class="assessment-section">
                <h4>📋 Project Overview</h4>
                <p>${project.description || project.desc || 'No description available.'}</p>
            </div>
            
            <!-- MARKET & COMPETITION -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">🎯</span>
                    <span class="section-title">Market & Competition</span>
                    <span class="section-hint">${(project.competitors || []).length} competitors identified</span>
                </summary>
                <div class="section-content">
                    <div class="assessment-subsection">
                        <h5>Market Context</h5>
                        <p>${project.marketContext || 'Market analysis pending.'}</p>
                    </div>
                    <div class="assessment-subsection">
                        <h5>Key Competitors</h5>
                        <div class="competitors-grid">
                            ${(project.competitors || []).map(comp => `
                                <div class="competitor-card threat-${comp.threat?.toLowerCase().replace(' ', '-') || 'unknown'}">
                                    <div class="competitor-name">${comp.name}</div>
                                    <div class="competitor-position">${comp.position}</div>
                                    <div class="competitor-threat">Threat: <strong>${comp.threat}</strong></div>
                                </div>
                            `).join('') || '<p>Competitor analysis pending.</p>'}
                        </div>
                    </div>
                </div>
            </details>
            
            <!-- FINANCIAL PROJECTIONS -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">💰</span>
                    <span class="section-title">Financial Projections</span>
                    <span class="section-hint">${project.financials?.projectedRevenue?.split(',')[0] || 'TBD'}</span>
                </summary>
                <div class="section-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.devCost || '$' + project.budget.toFixed(1) + 'M'}</div>
                            <div class="financial-label">Development Cost</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.timeline || project.timeline + ' quarters'}</div>
                            <div class="financial-label">Timeline</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.projectedRevenue?.split(',')[0] || 'TBD'}</div>
                            <div class="financial-label">Year 1 Revenue</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.projectedRevenue?.split(',')[1]?.trim() || 'TBD'}</div>
                            <div class="financial-label">Year 2 Revenue</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.grossMargin || 'TBD'}</div>
                            <div class="financial-label">Gross Margin</div>
                        </div>
                        <div class="financial-box">
                            <div class="financial-value">${project.financials?.breakeven || 'TBD'}</div>
                            <div class="financial-label">Breakeven</div>
                        </div>
                    </div>
                    ${project.developmentCosts ? `
                    <div style="margin-top: 15px;">
                        <h5>Cost Breakdown</h5>
                        <div class="cost-breakdown-bar">
                            <div class="cost-segment" style="width: ${project.developmentCosts?.personnel?.pct || 0}%; background: #6366f1;" title="Personnel ${project.developmentCosts?.personnel?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.hardware?.pct || 0}%; background: #22c55e;" title="Hardware ${project.developmentCosts?.hardware?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.software?.pct || 0}%; background: #3b82f6;" title="Software ${project.developmentCosts?.software?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.external?.pct || 0}%; background: #f59e0b;" title="External ${project.developmentCosts?.external?.pct || 0}%"></div>
                            <div class="cost-segment" style="width: ${project.developmentCosts?.contingency?.pct || 0}%; background: #ef4444;" title="Contingency ${project.developmentCosts?.contingency?.pct || 0}%"></div>
                        </div>
                        <div class="cost-legend">
                            <span><span class="legend-dot" style="background: #6366f1;"></span>Personnel ${project.developmentCosts?.personnel?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #22c55e;"></span>Hardware ${project.developmentCosts?.hardware?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #3b82f6;"></span>Software ${project.developmentCosts?.software?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #f59e0b;"></span>External ${project.developmentCosts?.external?.pct || 0}%</span>
                            <span><span class="legend-dot" style="background: #ef4444;"></span>Contingency ${project.developmentCosts?.contingency?.pct || 0}%</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </details>
            
            <!-- DEVELOPMENT PLAN -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">📅</span>
                    <span class="section-title">Development Plan</span>
                    <span class="section-hint">${project.milestones?.milestones?.length || project.milestones?.phases?.length || 3} milestones</span>
                </summary>
                <div class="section-content">
                    <div class="milestones-timeline">
                        ${(project.milestones?.milestones || project.milestones?.phases || []).map((m, i) => `
                            <div class="milestone-item">
                                <div class="milestone-header">
                                    <div class="milestone-phase">${m.phase || m.name || 'Phase ' + (i+1)}</div>
                                    <div class="milestone-meta">
                                        ${m.quarters ? `<span>📆 ${m.quarters}</span>` : ''}
                                        ${m.duration ? `<span>⏱️ ${m.duration}</span>` : ''}
                                        ${m.costAmount ? `<span>💰 $${m.costAmount}M</span>` : ''}
                                    </div>
                                </div>
                                ${m.deliverables ? `
                                <div class="milestone-deliverables">
                                    ${(m.deliverables || []).map(d => `<span class="deliverable-tag">${d}</span>`).join('')}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </details>
            
            <!-- TEAM & CAPABILITIES -->
            ${showTeam ? `
            <details class="section-details" open>
                <summary class="section-summary">
                    <span class="section-icon">👥</span>
                    <span class="section-title">Team & Project Lead</span>
                    <span class="section-hint">${project.lead?.name || project.team?.lead || 'Lead TBD'}</span>
                </summary>
                <div class="section-content">
                    <div class="assessment-subsection">
                        <h5>🎯 Project Lead</h5>
                        ${project.lead ? `
                        <div class="lead-card" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--gray-50); border-radius: 10px; margin-bottom: 15px;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: ${project.lead.avatarColor || 'var(--primary)'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1em;">${project.lead.initials || '?'}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--gray-800);">${project.lead.name}</div>
                                <div style="font-size: 0.85em; color: var(--gray-500);">${project.lead.role || project.team?.leadTitle || 'Project Lead'}</div>
                            </div>
                            ${leadTrackPct !== null ? `
                            <div style="padding: 6px 12px; border-radius: 15px; font-weight: 600; font-size: 0.85em; background: var(--${leadTrackClass}-light); color: var(--${leadTrackClass});">
                                ${leadTrackPct}% track record
                            </div>
                            ` : ''}
                        </div>
                        ` : '<p style="color: var(--gray-500);">Project lead to be assigned.</p>'}
                    </div>
                    <div class="assessment-subsection" style="margin-top: 15px;">
                        <h5>📋 Capability Fit</h5>
                        <p>${project.capabilityFit || 'Capability assessment pending.'}</p>
                    </div>
                    <div class="assessment-subsection" style="margin-top: 15px;">
                        <h5>👨‍💻 Team Size</h5>
                        <p>${project.team?.size || 6} team members assigned</p>
                    </div>
                </div>
            </details>
            ` : `
            <div class="blinded-section">
                <div class="blinded-icon">🎭</div>
                <div class="blinded-text">
                    <strong>Team Information Hidden</strong>
                    <span>You've chosen Blind Review — team details are not visible to reduce bias.</span>
                </div>
            </div>
            `}
            
            <!-- TECHNICAL & IP -->
            <details class="section-details">
                <summary class="section-summary">
                    <span class="section-icon">🔬</span>
                    <span class="section-title">Technical & IP Position</span>
                    <span class="section-hint">TRL ${project.trl?.current || '?'} → ${project.trl?.target || '?'} • ${project.ipPosition?.risk || 'Unknown'} IP Risk</span>
                </summary>
                <div class="section-content">
                    <div class="assessment-subsection">
                        <h5>Technology Readiness Level</h5>
                        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                            ${[1,2,3,4,5,6,7,8,9].map(level => `
                                <div style="flex: 1; height: 30px; display: flex; align-items: center; justify-content: center; 
                                            background: ${level <= (project.trl?.current || 3) ? 'var(--primary)' : level <= (project.trl?.target || 7) ? 'var(--primary-lighter)' : 'var(--gray-200)'}; 
                                            color: ${level <= (project.trl?.current || 3) ? 'white' : level <= (project.trl?.target || 7) ? 'var(--primary)' : 'var(--gray-400)'};
                                            border-radius: 4px; font-weight: 600; font-size: 0.8em;">
                                    ${level}
                                </div>
                            `).join('')}
                        </div>
                        <p style="font-size: 0.85em; color: var(--gray-600);">● Current: TRL ${project.trl?.current || '?'} · ○ Target: TRL ${project.trl?.target || '?'}</p>
                        ${project.trl?.note ? `<p style="margin-top: 8px; font-size: 0.85em;">${project.trl.note}</p>` : ''}
                    </div>
                    <div class="assessment-subsection" style="margin-top: 15px;">
                        <h5>IP Position</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                                <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">ShieldTech IP</div>
                                <p style="font-size: 0.8em; margin: 0;">${project.ipPosition?.shieldtech || 'Assessment pending.'}</p>
                            </div>
                            <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                                <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">Competitor IP</div>
                                <p style="font-size: 0.8em; margin: 0;">${project.ipPosition?.competitors || 'Assessment pending.'}</p>
                            </div>
                        </div>
                        <div style="padding: 8px 15px; border-radius: 8px; font-size: 0.85em; display: inline-block;
                                    background: ${(project.ipPosition?.risk || '').toLowerCase().includes('high') ? 'var(--danger-light)' : (project.ipPosition?.risk || '').toLowerCase().includes('medium') ? 'var(--warning-light)' : 'var(--success-light)'};
                                    color: ${(project.ipPosition?.risk || '').toLowerCase().includes('high') ? 'var(--danger)' : (project.ipPosition?.risk || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                            <strong>Freedom to Operate:</strong> ${project.ipPosition?.fto || 'Review needed'} · ${project.ipPosition?.risk || 'Unknown'} Risk
                        </div>
                    </div>
                </div>
            </details>
        `;
        
        document.getElementById('year2-project-card').innerHTML = html;
    }

    // ===========================
    // YEAR 2: QUICK TRIAGE (no criteria scoring)
    // ===========================
    function renderYear2TriageControls(project) {
        if (!project) return;
        // Default triage if not set
        if (!year2ProjectTriage[project.id]) year2ProjectTriage[project.id] = 'marginal';

        const current = year2ProjectTriage[project.id];
        const btn = (level, label, icon, help) => `
            <button class="triage-btn ${current === level ? 'active' : ''}" onclick="setYear2TriageSelection('${project.id}','${level}')">
                <span class="triage-icon">${icon}</span>
                <span class="triage-label">${label}</span>
                <span class="triage-help">${help}</span>
            </button>
        `;

        const container = document.getElementById('year2-triage-controls');
        if (!container) return;
        container.innerHTML = `
            <div class="triage-controls">
                ${btn('keep','Prioritize','✅','Worth serious consideration')}
                ${btn('marginal','Maybe','🤔','Keep in the mix')}
                ${btn('stop','Pass','⛔','Not for this cycle')}
            </div>
            <div class="triage-status">Current: <strong>${current === 'keep' ? 'Prioritize' : current === 'stop' ? 'Pass' : 'Maybe'}</strong></div>
        `;
    }

    function setYear2TriageSelection(projectId, level) {
        year2ProjectTriage[projectId] = level;
        const project = year2ProjectPool.find(p => p.id === projectId);
        if (project) renderYear2TriageControls(project);
    }

    
    function renderYear2ScoringGrid(project) {
        const criteria = [
            { id: 'technical', label: 'Technical Feasibility', icon: '🔧' },
            { id: 'marketsize', label: 'Market Size', icon: '📊' },
            { id: 'strategic', label: 'Strategic Alignment', icon: '🎯' },
            { id: 'roi', label: 'ROI Potential', icon: '💰' },
            { id: 'risk', label: 'Risk Level (5=Low Risk)', icon: '⚠️' }
        ];
        
        // Initialize player scores if not exists
        if (!project.playerScores) {
            project.playerScores = {};
            criteria.forEach(c => project.playerScores[c.id] = 3);
        }
        
        const html = criteria.map(criterion => `
            <div class="scoring-row">
                <div class="scoring-label">
                    <span class="scoring-icon">${criterion.icon}</span>
                    <span>${criterion.label}</span>
                </div>
                <div class="scoring-slider-container">
                    <input type="range" min="1" max="5" value="${project.playerScores[criterion.id]}" 
                           class="scoring-slider" data-criterion="${criterion.id}"
                           oninput="updateYear2Score('${project.id}', '${criterion.id}', this.value)">
                    <div class="scoring-value">${project.playerScores[criterion.id]}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('year2-scoring-grid').innerHTML = html;
        updateYear2AverageScore(project);
    }
    
    function updateYear2Score(projectId, criterion, value) {
        const project = year2ProjectPool.find(p => p.id === projectId);
        if (project) {
            project.playerScores[criterion] = parseInt(value);
            
            // Update displayed value
            const slider = document.querySelector(`#year2-scoring-grid input[data-criterion="${criterion}"]`);
            if (slider) {
                slider.nextElementSibling.textContent = value;
            }
            
            updateYear2AverageScore(project);
        }
    }
    
    function updateYear2AverageScore(project) {
        if (!project.playerScores) return;
        
        const scores = Object.values(project.playerScores);
        const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
        project.playerAvg = avg;
        
        document.getElementById('year2-player-avg-score').textContent = avg.toFixed(1);
    }
    
    function year2NextProject() {
        if (year2CurrentProjectIndex < year2ProjectPool.length - 1) {
            year2CurrentProjectIndex++;
            renderYear2Assessment();
        } else {
            // Assessment complete - calculate committee scores and show feedback
            calculateYear2CommitteeScores();
            showYear2CommitteeFeedback();
        }
    }
    
    function year2PrevProject() {
        if (year2CurrentProjectIndex > 0) {
            year2CurrentProjectIndex--;
            renderYear2Assessment();
        }
    }
    
    function calculateYear2CommitteeScores() {
        // Get committee or create a default one for solo/random modes
        const committee = gameState.selectedCommittee || [
            { id: 'default1', name: 'Technical Lead', bias: { technical: 0.5 } },
            { id: 'default2', name: 'Product Manager', bias: { marketsize: 0.5 } },
            { id: 'default3', name: 'Strategy Director', bias: { strategic: 0.5 } }
        ];
        
        year2ProjectPool.forEach(project => {
            // Generate committee member scores based on project's actual scores with some noise
            const committeeScores = {};
            committee.forEach(member => {
                const memberScores = {};
                const criteria = ['technical', 'marketsize', 'strategic', 'roi', 'risk'];
                
                criteria.forEach(criterion => {
                    // Base score from project's true scores
                    const baseScore = project.scores[criterion] || 3;
                    // Add member bias based on their expertise/role
                    let bias = 0;
                    if (member.bias && member.bias[criterion]) {
                        bias = member.bias[criterion];
                    }
                    // Add randomness
                    const noise = (Math.random() - 0.5) * 1.5;
                    const score = Math.max(1, Math.min(5, Math.round(baseScore + bias + noise)));
                    memberScores[criterion] = score;
                });
                
                const avg = Object.values(memberScores).reduce((a, b) => a + b, 0) / Object.values(memberScores).length;
                committeeScores[member.id] = { scores: memberScores, avg };
            });
            
            project.committeeScores = committeeScores;
            
            // Calculate overall committee average
            const avgScores = Object.values(committeeScores).map(c => c.avg);
            project.committeeAvg = avgScores.length > 0 ? avgScores.reduce((a, b) => a + b, 0) / avgScores.length : 3;
            
            // Calculate overall average (player + committee)
            if (project.playerAvg) {
                project.overallAvg = (project.playerAvg + project.committeeAvg) / 2;
            } else {
                project.overallAvg = project.committeeAvg;
            }
        });
        
        // Rank projects by overall average
        year2RankedProjects = [...year2ProjectPool].sort((a, b) => b.overallAvg - a.overallAvg);
    }
    
    function showYear2CommitteeFeedback() {
        gameState.inYear2PlanningFlow = true;
        // Render the new projects rankings
        renderYear2NewRankings();
        
        // Render ongoing projects for comparison
        renderYear2OngoingRankings();
        
        // Render comparison view
        renderYear2ComparisonView();
        
        // Render triage grid
        renderYear2TriageGrid();
        
        // Render strategic balance summary
        renderYear2StrategicBalanceSummary();
        
        // Show first tab
        switchYear2FeedbackTab('new');
        
        showPhase('year2-committee-feedback');
    }
    
    function renderYear2StrategicBalanceSummary() {
        const container = document.getElementById('year2-strategic-balance-summary');
        if (!container) return;
        
        const allBuckets = [
            { id: 'defend-metro', name: 'Defend Metro', icon: '🛡️', color: '#2563eb' },
            { id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' },
            { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' },
            { id: 'ai-first', name: 'AI-First', icon: '🤖', color: '#dc2626' }
        ];
        
        // Count buckets from ongoing projects
        const ongoingCounts = {};
        allBuckets.forEach(b => ongoingCounts[b.id] = 0);
        
        gameState.activeProjects.forEach(project => {
            (project.strategicBuckets || []).forEach(bucket => {
                if (bucket.id && ongoingCounts.hasOwnProperty(bucket.id)) {
                    ongoingCounts[bucket.id]++;
                }
            });
        });
        
        // Count buckets from new Year 2 projects
        const newCounts = {};
        allBuckets.forEach(b => newCounts[b.id] = 0);
        
        year2RankedProjects.forEach(project => {
            (project.strategicBuckets || []).forEach(bucket => {
                if (bucket.id && newCounts.hasOwnProperty(bucket.id)) {
                    newCounts[bucket.id]++;
                }
            });
        });
        
        container.innerHTML = allBuckets.map(bucket => {
            const ongoing = ongoingCounts[bucket.id];
            const available = newCounts[bucket.id];
            const hasGap = ongoing === 0;
            const canFill = available > 0;
            
            let statusText = '';
            let statusColor = 'var(--gray-500)';
            if (hasGap && canFill) {
                statusText = '⚠️ Gap — New options available!';
                statusColor = 'var(--warning)';
            } else if (hasGap && !canFill) {
                statusText = '❌ Gap — No new options';
                statusColor = 'var(--danger)';
            } else if (ongoing >= 2) {
                statusText = '✅ Well covered';
                statusColor = 'var(--success)';
            } else {
                statusText = '✓ Covered';
                statusColor = 'var(--success)';
            }
            
            return `
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid ${bucket.color}30;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 1.3em;">${bucket.icon}</span>
                        <strong style="color: ${bucket.color};">${bucket.name}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 0.85em; color: var(--gray-600);">Ongoing:</span>
                        <span style="font-weight: 600; color: var(--primary);">${ongoing} project${ongoing !== 1 ? 's' : ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.85em; color: var(--gray-600);">New Y2 options:</span>
                        <span style="font-weight: 600; color: var(--success);">${available} available</span>
                    </div>
                    <div style="font-size: 0.8em; color: ${statusColor}; font-weight: 500;">${statusText}</div>
                </div>
            `;
        }).join('');
    }
    
    function switchYear2FeedbackTab(tab) {
        // Update tab buttons
        document.querySelectorAll('#phase-year2-committee-feedback .feedback-tab').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        
        // Show/hide content
        document.getElementById('year2-feedback-new').classList.toggle('hidden', tab !== 'new');
        document.getElementById('year2-feedback-ongoing').classList.toggle('hidden', tab !== 'ongoing');
        document.getElementById('year2-feedback-comparison').classList.toggle('hidden', tab !== 'comparison');
    }
    
    function renderYear2NewRankings() {
        const html = year2RankedProjects.map((project, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
            
            // Generate strategic bucket badges
            const bucketBadges = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}15; color: ${bucket.color}; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; border: 1px solid ${bucket.color}30;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
            
            return `
                <div class="ranking-item expanded" style="flex-direction: column; align-items: stretch; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="display: flex; gap: 15px; align-items: flex-start;">
                            <div class="ranking-rank" style="font-size: 1.5em;">${medal}</div>
                            <div>
                                <div class="ranking-name" style="font-size: 1.1em; font-weight: 600;">${project.name}</div>
                                <div class="ranking-tagline" style="color: var(--gray-600); font-style: italic;">${project.tagline}</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                    ${bucketBadges}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2em; font-weight: 700; color: var(--gold-dark);">$${project.budget}M </div>
                            <div style="font-size: 0.85em; color: var(--gray-500);">${project.timeline} quarters</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <p style="margin: 0; color: var(--gray-700); line-height: 1.5;">${project.desc || project.description || 'No description available.'}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div class="ranking-scores" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${project.playerAvg ? `<div class="score-pill you">You: ${project.playerAvg.toFixed(1)}</div>` : ''}
                            <div class="score-pill committee">Committee: ${project.committeeAvg.toFixed(1)}</div>
                            <div class="score-pill overall">Overall: ${project.overallAvg.toFixed(1)}</div>
                        </div>
                        <button class="btn btn-small" onclick="openProjectModal('${project.id}', 'year2')">View Full Details</button>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('year2-new-rankings').innerHTML = html;
    }
    
    function renderYear2OngoingRankings() {
        // Show ongoing active projects with their original Year 1 scores
        const ongoingProjects = [...gameState.activeProjects].sort((a, b) => (b.overallAvg || 0) - (a.overallAvg || 0));
        
        if (ongoingProjects.length === 0) {
            document.getElementById('year2-ongoing-rankings').innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--gray-500);">
                    <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                    <p>No ongoing projects. All Year 1 projects have completed or been terminated.</p>
                </div>
            `;
            return;
        }
        
        const html = ongoingProjects.map((project, index) => {
            const progress = project.latestUpdate?.progress || 0;
            const spent = Math.round(((project.spentBudget || 0) / project.budget) * 100);
            
            // Generate strategic bucket badges
            const bucketBadges = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}15; color: ${bucket.color}; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; border: 1px solid ${bucket.color}30;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
            
            return `
                <div class="ranking-item ongoing expanded" style="flex-direction: column; align-items: stretch; padding: 15px; background: var(--primary-lighter); border-left: 4px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="display: flex; gap: 15px; align-items: flex-start;">
                            <div class="ranking-rank" style="background: var(--primary); color: white;">${index + 1}</div>
                            <div>
                                <div class="ranking-name" style="font-size: 1.1em; font-weight: 600;">${project.name}</div>
                                <div class="ranking-tagline" style="color: var(--gray-600);">${progress}% complete · ${spent}% budget spent</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                    ${bucketBadges}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2em; font-weight: 700; color: var(--primary);">$${project.budget}M </div>
                            <div style="font-size: 0.85em; color: var(--gray-500);">Original Score: ${(project.overallAvg || 3).toFixed(1)}</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <p style="margin: 0; color: var(--gray-700); line-height: 1.5;">${project.desc || project.shortDesc || project.description || 'No description available.'}</p>
                ${renderInnovationBadges(project, true)}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 10px;">
                            <span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">📂 Ongoing</span>
                            <span style="background: var(--gray-200); padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">${project.timeline}Q timeline</span>
                        </div>
                        <button class="btn btn-small" onclick="openProjectModal('${project.id}', 'ongoing')">View Full Details</button>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('year2-ongoing-rankings').innerHTML = html;
    }
    
    function renderYear2ComparisonView() {
        // Create a merged view showing all projects ranked together
        const allProjects = [
            ...year2RankedProjects.map(p => ({ ...p, source: 'new' })),
            ...gameState.activeProjects.map(p => ({ ...p, source: 'ongoing' }))
        ].sort((a, b) => (b.overallAvg || 0) - (a.overallAvg || 0));
        
        const html = allProjects.map((project, index) => {
            const isNew = project.source === 'new';
            const badge = isNew ? '🆕' : '📂';
            const badgeClass = isNew ? 'new' : 'ongoing';
            
            return `
                <div class="comparison-item ${badgeClass}">
                    <div class="comparison-rank">#${index + 1}</div>
                    <div class="comparison-badge ${badgeClass}">${badge}</div>
                    <div class="comparison-info">
                        <div class="comparison-name">${project.name}</div>
                    </div>
                    <div class="comparison-score">${(project.overallAvg || 3).toFixed(1)}</div>
                    <div class="comparison-budget">$${project.budget}M </div>
                </div>
            `;
        }).join('');
        
        // Add insight
        const topNew = allProjects.findIndex(p => p.source === 'new');
        const topOngoing = allProjects.findIndex(p => p.source === 'ongoing');
        
        let insight = '';
        if (topNew < topOngoing && topNew >= 0 && topOngoing >= 0) {
            insight = `<div class="comparison-insight success">💡 Your top new opportunity (#${topNew + 1}) ranks higher than your top ongoing project (#${topOngoing + 1}). Consider prioritizing new investments.</div>`;
        } else if (topOngoing < topNew && topNew >= 0 && topOngoing >= 0) {
            insight = `<div class="comparison-insight info">💡 Your ongoing projects (#${topOngoing + 1}) rank higher than new opportunities (#${topNew + 1}). Your current portfolio may be well-positioned.</div>`;
        }
        
        document.getElementById('year2-comparison-view').innerHTML = insight + `<div class="comparison-list">${html}</div>`;
    }
    
    function renderYear2TriageGrid() {
        const html = year2RankedProjects.map(project => {
            const triage = year2ProjectTriage[project.id] || 'marginal';
            
            // Generate compact strategic bucket badges
            const bucketBadges = (project.strategicBuckets || []).map(bucket => `
                <span style="display: inline-block; background: ${bucket.color}15; color: ${bucket.color}; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; font-weight: 500;">
                    ${bucket.icon} ${bucket.name}
                </span>
            `).join('');
            
            return `
                <div class="triage-item" data-project-id="${project.id}">
                    <div class="triage-project-info">
                        <span class="triage-project-name">${project.name}</span>
                        <span class="triage-project-score">Score: ${project.overallAvg.toFixed(1)} · $${project.budget}M </span>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                            ${bucketBadges}
                        </div>
                    </div>
                    <div class="triage-buttons">
                        <button class="triage-btn fund ${triage === 'fund' ? 'selected' : ''}" 
                                onclick="setYear2Triage('${project.id}', 'fund')">
                            ✅ Fund
                        </button>
                        <button class="triage-btn marginal ${triage === 'marginal' ? 'selected' : ''}" 
                                onclick="setYear2Triage('${project.id}', 'marginal')">
                            ⚖️ Maybe
                        </button>
                        <button class="triage-btn stop ${triage === 'stop' ? 'selected' : ''}" 
                                onclick="setYear2Triage('${project.id}', 'stop')">
                            🚫 Skip
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('year2-triage-grid').innerHTML = html;
    }
    
    function setYear2Triage(projectId, decision) {
        year2ProjectTriage[projectId] = decision;
        
        // Update UI
        const item = document.querySelector(`.triage-item[data-project-id="${projectId}"]`);
        if (item) {
            item.querySelectorAll('.triage-btn').forEach(btn => btn.classList.remove('selected'));
            item.querySelector(`.triage-btn.${decision}`).classList.add('selected');
        }
    }
    
    // Year 2 Portfolio Builder state
    let year2PortfolioMatrix = 'risk-speed';
    let year2PortfolioView = 'matrix';
    let year2BaseAvailableBudget = 0; // Budget available before any new selections
    
    function proceedToYear2PortfolioBuilder() {
        gameState.inYear2PlanningFlow = true;
        
        // Calculate budget for Year 2 selection
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        year2BaseAvailableBudget = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Ensure minimum budget for gameplay
        if (year2BaseAvailableBudget < gameState.maxBudget * 0.05) {
            year2BaseAvailableBudget = gameState.maxBudget * 0.05;
        }
        
        year2AvailableBudget = year2BaseAvailableBudget;
        
        // Pre-select funded projects
        year2SelectedProjects = [];
        year2RankedProjects.forEach(project => {
            if (year2ProjectTriage[project.id] === 'fund' && project.budget <= year2AvailableBudget) {
                year2SelectedProjects.push(project.id);
                year2AvailableBudget -= project.budget;
            }
        });
        
        year2PortfolioMatrix = 'risk-speed';
        year2PortfolioView = 'matrix';
        
        renderYear2PortfolioBuilder();
        showPhase('year2-selection');
    }
    
    function renderYear2PortfolioBuilder() {
        renderYear2PortfolioMatrix();
        renderYear2PortfolioList();
        updateYear2PortfolioSidebar();
        
        // Update view tabs
        document.querySelectorAll('#phase-year2-selection .view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === year2PortfolioView);
        });
        document.getElementById('year2-portfolio-matrix-view').classList.toggle('hidden', year2PortfolioView !== 'matrix');
        document.getElementById('year2-portfolio-list-view').classList.toggle('hidden', year2PortfolioView !== 'list');
    }
    
    function switchYear2PortfolioView(view) {
        year2PortfolioView = view;
        document.querySelectorAll('#phase-year2-selection .view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === view);
        });
        document.getElementById('year2-portfolio-matrix-view').classList.toggle('hidden', view !== 'matrix');
        document.getElementById('year2-portfolio-list-view').classList.toggle('hidden', view !== 'list');
    }
    
    function switchYear2PortfolioMatrix(matrixType) {
        year2PortfolioMatrix = matrixType;
        document.querySelectorAll('#phase-year2-selection .matrix-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.matrix === matrixType);
        });
        renderYear2PortfolioMatrix();
    }
    
    function renderYear2PortfolioMatrix() {
        const config = matrixConfigs[year2PortfolioMatrix];
        const container = document.getElementById('year2-portfolio-matrix');
        if (!container || !config) return;
// Ensure matrix positions exist for BOTH ongoing + candidate Year 2 projects,
// so bubbles populate quadrants consistently across all 4 landscape views.
const _savedPool = gameState.projectPool;
const _savedRanked = gameState.rankedProjects;
try {
    const _all = [
        ...(gameState.activeProjects || []),
        ...(typeof year2ProjectPool !== 'undefined' ? year2ProjectPool : []),
        ...(typeof year2EndProjectPool !== 'undefined' ? year2EndProjectPool : [])
    ];
    gameState.projectPool = _all;
    gameState.rankedProjects = null;
    computeProjectPositions();
} finally {
    gameState.projectPool = _savedPool;
    gameState.rankedProjects = _savedRanked;
}

        
        const quadrantsHtml = `
            <div class="matrix-quadrant q1"><div class="quadrant-label">${config.quadrants.q1.label}</div></div>
            <div class="matrix-quadrant q2"><div class="quadrant-label">${config.quadrants.q2.label}</div></div>
            <div class="matrix-quadrant q3"><div class="quadrant-label">${config.quadrants.q3.label}</div></div>
            <div class="matrix-quadrant q4"><div class="quadrant-label">${config.quadrants.q4.label}</div></div>
        `;
        
        const axesHtml = `
            <div class="matrix-axis horizontal"></div>
            <div class="matrix-axis vertical"></div>
            <div class="axis-label x-min">${config.xAxis.min}</div>
            <div class="axis-label x-max">${config.xAxis.max}</div>
            <div class="axis-label y-min">${config.yAxis.min}</div>
            <div class="axis-label y-max">${config.yAxis.max}</div>
        `;
        
        // Build ongoing project bubbles (blue) - click to view details
        const ongoingHtml = gameState.activeProjects.map(project => {
            const pos = projectMatrixPositions[project.id]?.[year2PortfolioMatrix];
const xPos = pos ? pos.x : 50;
const yPos = pos ? (100 - pos.y) : 50;

            const size = 50;
            
            return `
                <div class="project-bubble funded" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px;"
                     onclick="openProjectModal('${project.id}', 'ongoing')"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M </div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.8;">📂 Ongoing - Click for details</div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Build new project bubbles - click to view details and add/remove
        const newHtml = year2RankedProjects.map(project => {
            const pos = projectMatrixPositions[project.id]?.[year2PortfolioMatrix];
const xPos = pos ? pos.x : 50;
const yPos = pos ? (100 - pos.y) : 50;

            const size = 50;
            
            const isSelected = year2SelectedProjects.includes(project.id);
            const isSkipped = year2ProjectTriage[project.id] === 'stop';
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            
            let statusClass, statusText;
            
            if (isSkipped) {
                statusClass = 'stopped';
                statusText = '🚫 Skipped';
            } else if (isSelected) {
                statusClass = 'marginal-in';
                statusText = '✅ Selected';
            } else if (canAfford) {
                statusClass = 'marginal-out';
                statusText = '🆕 Available';
            } else {
                statusClass = 'unaffordable';
                statusText = '💰 Over budget';
            }
            
            return `
                <div class="project-bubble ${statusClass}" 
                     style="left: calc(${xPos}% - ${size/2}px); top: calc(${yPos}% - ${size/2}px); width: ${size}px; height: ${size}px;"
                     onclick="openProjectModal('${project.id}', 'year2')"
                     data-project-id="${project.id}">
                    <div class="bubble-tooltip">
                        <div class="tooltip-name">${project.name}</div>
                        <div class="tooltip-budget">$${project.budget}M • Score: ${(project.overallAvg || 3).toFixed(1)}</div>
                        <div style="font-size: 0.85em; margin-top: 4px; opacity: 0.8;">${statusText} - Click for details</div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = quadrantsHtml + axesHtml + ongoingHtml + newHtml;
    }
    
    function year2Toggle(projectId) {
        const project = year2RankedProjects.find(p => p.id === projectId);
        if (!project) return;
        if (year2ProjectTriage[projectId] === 'stop') return;
        
        const index = year2SelectedProjects.indexOf(projectId);
        if (index >= 0) {
            year2SelectedProjects.splice(index, 1);
            year2AvailableBudget += project.budget;
        } else if (project.budget <= year2AvailableBudget) {
            year2SelectedProjects.push(projectId);
            year2AvailableBudget -= project.budget;
        }
        
        renderYear2PortfolioBuilder();
    }
    
    function renderYear2PortfolioList() {
        const container = document.getElementById('year2-portfolio-list');
        
        // Ongoing projects section
        let html = `
            <div class="portfolio-list-section">
                <h3 style="color: var(--primary); margin-bottom: 15px;">📂 Ongoing Projects (Year 1)</h3>
                <div class="portfolio-list-items">
        `;
        
        if (gameState.activeProjects.length === 0) {
            html += `<p style="color: var(--gray-500); padding: 10px;">No ongoing projects.</p>`;
        } else {
            gameState.activeProjects.forEach(project => {
                const progress = project.latestUpdate?.progress || 0;
                html += `
                    <div class="portfolio-list-item ongoing" style="background: var(--primary-lighter); border-left: 4px solid var(--primary); cursor: pointer;"
                         onclick="openProjectModal('${project.id}', 'ongoing')">
                        <div class="item-info" style="flex: 1;">
                            <span class="item-name">${project.name}</span>
                            <span class="item-detail">${(project.desc || project.shortDesc || '').substring(0, 80)}...</span>
                            <span class="item-detail" style="color: var(--primary);">${progress}% complete · $${project.budget}M</span>
                        </div>
                        <span class="item-status" style="color: var(--primary);">🔒 Continuing</span>
                    </div>
                `;
            });
        }
        
        html += `</div></div>`;
        
        // New projects section
        html += `
            <div class="portfolio-list-section">
                <h3 style="color: var(--success); margin-bottom: 15px;">🆕 New Projects (Year 2)</h3>
                <div class="portfolio-list-items">
        `;
        
        year2RankedProjects.forEach((project, index) => {
            const isSelected = year2SelectedProjects.includes(project.id);
            const triage = year2ProjectTriage[project.id];
            const isSkipped = triage === 'stop';
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            
            let statusHtml, bgStyle;
            if (isSkipped) {
                statusHtml = `<span class="item-status" style="color: var(--gray-400);">🚫 Skipped</span>`;
                bgStyle = 'background: var(--gray-100); opacity: 0.7;';
            } else if (isSelected) {
                statusHtml = `<button class="btn btn-small" style="background: var(--danger);" onclick="event.stopPropagation(); year2Toggle('${project.id}')">Remove</button>`;
                bgStyle = 'background: var(--success-light); border-left: 4px solid var(--success);';
            } else if (canAfford) {
                statusHtml = `<button class="btn btn-small" onclick="event.stopPropagation(); year2Toggle('${project.id}')">+ Add</button>`;
                bgStyle = 'background: white;';
            } else {
                statusHtml = `<span class="item-status" style="color: var(--warning);">💰 Over budget</span>`;
                bgStyle = 'background: var(--warning-light);';
            }
            
            html += `
                <div class="portfolio-list-item" style="${bgStyle} cursor: pointer;" 
                     onclick="openProjectModal('${project.id}', 'year2')">
                    <div class="item-info" style="flex: 1;">
                        <span class="item-name">#${index + 1} ${project.name}</span>
                        <span class="item-detail">${(project.desc || project.shortDesc || '').substring(0, 80)}...</span>
                        <span class="item-detail" style="color: var(--primary);">Score: ${(project.overallAvg || 3).toFixed(1)} · $${project.budget}M · ${project.timeline}Q</span>
                    </div>
                    ${statusHtml}
                </div>
            `;
        });
        
        html += `</div></div>`;
        
        container.innerHTML = html;
    }
    
    function updateYear2PortfolioSidebar() {
        // Calculate spending on new projects
        const newProjectSpending = year2SelectedProjects.reduce((sum, projectId) => {
            const project = year2RankedProjects.find(p => p.id === projectId);
            return sum + (project?.budget || 0);
        }, 0);
        
        // Update budget breakdown
        const breakdownEl = document.getElementById('year2-budget-breakdown');
        if (breakdownEl) {
            const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
                const remaining = (p.budget || 0) - (p.spentBudget || 0);
                return sum + Math.max(0, remaining);
            }, 0);
            
            breakdownEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Annual Budget:</span>
                    <strong>$${gameState.maxBudget.toFixed(1)}M </strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--primary);">
                    <span>Ongoing Projects:</span>
                    <strong>-$${ongoingProjectNeeds.toFixed(1)}M </strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid var(--gray-200); color: var(--success); font-weight: 600;">
                    <span>Available for New:</span>
                    <span>$${year2BaseAvailableBudget.toFixed(1)}M </span>
                </div>
            `;
        }
        
        // Update budget meter
        const percentageUsed = year2BaseAvailableBudget > 0 ? (newProjectSpending / year2BaseAvailableBudget) * 100 : 0;
        const fillEl = document.getElementById('year2-budget-fill');
        if (fillEl) {
            fillEl.style.width = `${Math.min(100, percentageUsed)}%`;
            if (newProjectSpending > year2BaseAvailableBudget) {
                fillEl.style.background = 'var(--danger)';
            } else if (percentageUsed > 80) {
                fillEl.style.background = 'var(--warning)';
            } else {
                fillEl.style.background = 'linear-gradient(90deg, var(--success) 0%, var(--success-light) 100%)';
            }
        }
        
        document.getElementById('year2-budget-remaining').textContent = `$${newProjectSpending.toFixed(1)}M spent`;
        document.getElementById('year2-budget-available').textContent = `of $${year2BaseAvailableBudget.toFixed(1)}M`;
        
        // Update portfolio summary
        const summaryEl = document.getElementById('year2-portfolio-summary');
        if (summaryEl) {
            summaryEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Ongoing Projects:</span>
                    <strong>${gameState.activeProjects.length}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--success);">
                    <span>New Projects:</span>
                    <strong>+${year2SelectedProjects.length}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--gray-200);">
                    <span>Total Active:</span>
                    <strong>${gameState.activeProjects.length + year2SelectedProjects.length}</strong>
                </div>
            `;
        }
        
        // Update strategic buckets display
        const bucketsEl = document.getElementById('year2-strategic-buckets');
        if (bucketsEl) {
            const allBuckets = [
                { id: 'defend-metro', name: 'Defend Metro', icon: '🛡️', color: '#2563eb' },
                { id: 'tier23-rollout', name: 'Tier 2/3 Rollout', icon: '🗺️', color: '#059669' },
                { id: 'recurring-revenue', name: 'Recurring Revenue', icon: '💳', color: '#7c3aed' },
                { id: 'ai-first', name: 'AI-First', icon: '🤖', color: '#dc2626' }
            ];
            
            // Count buckets from ongoing + selected Year 2 projects
            const bucketCounts = {};
            allBuckets.forEach(b => bucketCounts[b.id] = 0);
            
            // Count from ongoing projects
            gameState.activeProjects.forEach(project => {
                (project.strategicBuckets || []).forEach(bucket => {
                    if (bucket.id && bucketCounts.hasOwnProperty(bucket.id)) {
                        bucketCounts[bucket.id]++;
                    }
                });
            });
            
            // Count from selected Year 2 projects
            year2SelectedProjects.forEach(projectId => {
                const project = year2RankedProjects.find(p => p.id === projectId);
                if (project?.strategicBuckets) {
                    project.strategicBuckets.forEach(bucket => {
                        if (bucket.id && bucketCounts.hasOwnProperty(bucket.id)) {
                            bucketCounts[bucket.id]++;
                        }
                    });
                }
            });
            
            bucketsEl.innerHTML = allBuckets.map(bucket => `
                <div class="portfolio-bucket-item" style="display: flex; align-items: center; gap: 8px; padding: 6px 0; ${bucketCounts[bucket.id] > 0 ? '' : 'opacity: 0.5;'}">
                    <span style="font-size: 1.1em;">${bucket.icon}</span>
                    <span style="flex: 1; font-size: 0.85em;">${bucket.name}</span>
                    <span style="background: ${bucketCounts[bucket.id] > 0 ? bucket.color : 'var(--gray-300)'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; font-weight: 600;">${bucketCounts[bucket.id]}</span>
                </div>
            `).join('');
        }
        
        // Update new project list
        const listEl = document.getElementById('year2-new-project-list');
        if (listEl) {
            listEl.innerHTML = year2RankedProjects.map((project, index) => {
                const isSelected = year2SelectedProjects.includes(project.id);
                const isSkipped = year2ProjectTriage[project.id] === 'stop';
                
                let icon = '⚖️';
                if (isSelected) icon = '✅';
                else if (isSkipped) icon = '🚫';
                
                return `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--gray-100); ${isSkipped ? 'opacity: 0.5;' : ''}">
                        <span style="font-size: 0.85em;">${icon} #${index + 1} ${project.name}</span>
                        <span style="font-size: 0.85em; color: var(--gray-500);">$${project.budget}M</span>
                    </div>
                `;
            }).join('');
        }
        
        // Update confirm button
        const isOverBudget = newProjectSpending > year2BaseAvailableBudget;
        const confirmBtn = document.getElementById('confirm-year2-portfolio-btn');
        if (confirmBtn) {
            if (isOverBudget) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '⚠️ Over Budget';
            } else {
                confirmBtn.disabled = false;
                confirmBtn.textContent = `Confirm Year 2 Portfolio (${gameState.activeProjects.length + year2SelectedProjects.length} projects) →`;
            }
        }
    }
    
    function confirmYear2Portfolio() {
        // Add selected Year 2 projects to active projects
        year2SelectedProjects.forEach(projectId => {
            const project = year2RankedProjects.find(p => p.id === projectId);
            if (project) {
                const activeProject = {
                    ...project,
                    status: 'active',
                    progress: 0,
                    currentQuarter: 0,
                    quartersActive: 0,
                    spentBudget: 0,
                    startQuarter: gameState.currentQuarter,
                    isYear2Project: true,
                    decision: 'continue'
                };
                ensureProjectCompleteness(activeProject);
                gameState.activeProjects.push(activeProject);
            }
        });
        
        // Year 2 planning complete; resume operations
        gameState.year2PlanningComplete = true;
        gameState.inYear2PlanningFlow = false;
        gameState.year2TransitionPending = false;
        // Go to budget meeting / continue to operations
        showYear2BudgetMeeting();
    }
    
    // Keep old functions for backward compatibility but redirect
    function skipYear2Selection() {
        confirmYear2Portfolio();
    }
    
    function confirmYear2Selection() {
        confirmYear2Portfolio();
    }
    
    function showYear2ProjectSelection() {
        console.log('showYear2ProjectSelection called');
        
        // Generate new project pool for Year 2
        year2ProjectPool = generateYear2ProjectPool();
        console.log('Generated Year 2 pool:', year2ProjectPool.length, 'projects');
        console.log('Year 2 pool:', year2ProjectPool);
        
        year2SelectedProjects = [];
        
        // Calculate ongoing project needs (remaining costs for active projects)
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        // Calculate what was spent on completed projects (this money is gone)
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Calculate what was spent on killed projects (partial spending before kill)
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Total committed = ongoing needs + already spent on completed/killed
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        
        // Available = new allocation minus all committed spending
        year2AvailableBudget = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Ensure at least a small refresh budget for gameplay (5% of max, reduced from 10%)
        const minRefreshBudget = gameState.maxBudget * 0.05;
        if (year2AvailableBudget < minRefreshBudget) {
            year2AvailableBudget = minRefreshBudget;
        }
        
        console.log('MaxBudget:', gameState.maxBudget, 'Ongoing needs:', ongoingProjectNeeds, 
                    'Completed spending:', completedProjectSpending, 'Killed spending:', killedProjectSpending,
                    'Available:', year2AvailableBudget);
        
        // Render the Year 2 project grid
        renderYear2ProjectGrid();
        updateYear2BudgetDisplay();
        
        showPhase('year2-selection');
    }
    
    function renderYear2ProjectGrid() {
        console.log('renderYear2ProjectGrid called');
        const grid = document.getElementById('year2-project-grid');
        console.log('Grid element:', grid);
        console.log('year2ProjectPool length:', year2ProjectPool.length);
        
        if (!grid) {
            console.error('Could not find year2-project-grid element!');
            return;
        }
        
        grid.innerHTML = '';
        
        if (year2ProjectPool.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 20px;">No new projects available.</p>';
            return;
        }
        
        // Use ranked projects if available, otherwise use pool
        const projectsToShow = year2RankedProjects.length > 0 ? year2RankedProjects : year2ProjectPool;
        
        projectsToShow.forEach((project, index) => {
            const isSelected = year2SelectedProjects.includes(project.id);
            const canAfford = project.budget <= year2AvailableBudget || isSelected;
            const triage = year2ProjectTriage[project.id];
            const isFunded = triage === 'fund';
            const isStopped = triage === 'stop';
            
            const card = document.createElement('div');
            card.className = 'project-card' + (isSelected ? ' selected' : '') + (!canAfford ? ' unaffordable' : '');
            
            let borderColor = 'var(--gray-200)';
            let bgColor = 'white';
            if (isSelected) {
                borderColor = 'var(--success)';
                bgColor = 'var(--success-light)';
            } else if (isFunded) {
                borderColor = 'var(--success)';
            } else if (isStopped) {
                borderColor = 'var(--gray-300)';
                bgColor = 'var(--gray-100)';
            }
            
            card.style.cssText = `
                background: ${bgColor};
                border: 2px solid ${borderColor};
                border-radius: 12px;
                padding: 20px;
                cursor: ${canAfford && !isStopped ? 'pointer' : 'not-allowed'};
                opacity: ${canAfford && !isStopped ? '1' : '0.6'};
                transition: all 0.2s;
            `;
            
            if (canAfford && !isStopped) {
                card.onclick = () => toggleYear2Project(project.id);
            }
            
            // Show rank and score if available
            const rankBadge = year2RankedProjects.length > 0 
                ? `<span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">#${index + 1} · ${(project.overallAvg || 3).toFixed(1)}</span>`
                : '';
            
            const triageBadge = isFunded 
                ? '<span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; margin-left: 5px;">✓ Funded</span>'
                : isStopped 
                    ? '<span style="background: var(--gray-400); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; margin-left: 5px;">Skipped</span>'
                    : '';
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div>
                        <div style="margin-bottom: 6px;">${rankBadge}${triageBadge}</div>
                        <h3 style="margin: 0 0 4px; color: var(--primary); font-size: 1.1em;">${project.name}</h3>
                        <span style="font-size: 0.8em; color: var(--gray-500); font-style: italic;">${project.tagline}</span>
                                        ${renderInnovationBadges(project, true)}
</div>
                    <div style="background: var(--gold-light); color: var(--gold-dark); padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 0.9em;">
                        $${project.budget} M
                    </div>
                </div>
                <p style="margin: 0 0 12px; color: var(--gray-600); font-size: 0.9em; line-height: 1.5;">${(project.desc || project.description || '').substring(0, 150)}${(project.desc || project.description || '').length > 150 ? '...' : ''}</p>
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                    ${(project.strategicBuckets || []).map(bucket => `
                        <span style="display: inline-block; background: ${bucket.color}15; color: ${bucket.color}; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; border: 1px solid ${bucket.color}30;">
                            ${bucket.icon} ${bucket.name}
                        </span>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 15px; font-size: 0.85em; color: var(--gray-500);">
                    <span>⏱️ ${project.timeline}Q timeline</span>
                    <span>📊 ${Math.round(project.successProb * 100)}% base success</span>
                </div>
                ${isSelected ? '<div style="margin-top: 10px; text-align: center; color: var(--success); font-weight: 600;">✓ Selected</div>' : ''}
            `;
            
            grid.appendChild(card);
        });
    }
    
    function toggleYear2Project(projectId) {
        const project = year2ProjectPool.find(p => p.id === projectId);
        if (!project) return;
        
        // Don't allow toggling stopped projects
        if (year2ProjectTriage[projectId] === 'stop') return;
        
        const index = year2SelectedProjects.indexOf(projectId);
        
        if (index >= 0) {
            // Deselect
            year2SelectedProjects.splice(index, 1);
            year2AvailableBudget += project.budget;
        } else {
            // Select (if can afford)
            if (project.budget <= year2AvailableBudget) {
                year2SelectedProjects.push(projectId);
                year2AvailableBudget -= project.budget;
            }
        }
        
        renderYear2ProjectGrid();
        updateYear2BudgetDisplay();
    }
    
    function updateYear2BudgetDisplay() {
        // Calculate budget components for display
        const ongoingProjectNeeds = gameState.activeProjects.reduce((sum, p) => {
            const remaining = (p.budget || 0) - (p.spentBudget || 0);
            return sum + Math.max(0, remaining);
        }, 0);
        
        const completedProjectSpending = (gameState.completedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        const killedProjectSpending = (gameState.killedProjects || []).reduce((sum, p) => {
            return sum + (p.spentBudget || 0);
        }, 0);
        
        // Calculate spending on newly selected Year 2 projects
        const newProjectSpending = year2SelectedProjects.reduce((sum, projectId) => {
            const project = year2ProjectPool.find(p => p.id === projectId);
            return sum + (project?.budget || 0);
        }, 0);
        
        const totalCommitted = ongoingProjectNeeds + completedProjectSpending + killedProjectSpending;
        const baseAvailable = Math.max(0, gameState.maxBudget - totalCommitted);
        
        // Update breakdown display
        const breakdownEl = document.getElementById('year2-budget-breakdown');
        if (breakdownEl) {
            breakdownEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Year 2 Budget:</span>
                    <strong>$${gameState.maxBudget.toFixed(1)}M </strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--warning);">
                    <span>Active Projects (remaining):</span>
                    <strong>-$${ongoingProjectNeeds.toFixed(1)}M </strong>
                </div>
                ${completedProjectSpending > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--gray-500);">
                    <span>Spent on Completed:</span>
                    <strong>-$${completedProjectSpending.toFixed(1)}M </strong>
                </div>` : ''}
                ${killedProjectSpending > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--gray-500);">
                    <span>Spent before Kill:</span>
                    <strong>-$${killedProjectSpending.toFixed(1)}M </strong>
                </div>` : ''}
                <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid var(--gray-200); color: var(--primary); font-weight: 600;">
                    <span>Available for New:</span>
                    <span>$${baseAvailable.toFixed(1)}M </span>
                </div>
            `;
        }
        
        const remainingAfterSelection = year2AvailableBudget;
        document.getElementById('year2-budget-remaining').textContent = '$' + Math.round(remainingAfterSelection * 10) / 10 + ' M remaining';
        document.getElementById('year2-projects-selected').textContent = year2SelectedProjects.length;
        
        // Enable/disable confirm button - allow if projects selected and within budget
        const confirmBtn = document.getElementById('confirm-year2-selection-btn');
        const isOverBudget = newProjectSpending > baseAvailable;
        confirmBtn.disabled = year2SelectedProjects.length === 0 || isOverBudget;
        
        if (isOverBudget) {
            confirmBtn.textContent = '⚠️ Over Budget';
        } else {
            confirmBtn.textContent = 'Add Selected Projects & Continue →';
        }
    }
    
    // Listen for messages from the iframe
    window.addEventListener('message', function(event) {
        if (!event.data || !event.data.type) return;

        if (event.data.type === 'committeeChaosDone') {

            // Cap multiplier to reasonable range to prevent budget explosion
            // Raw multiplier from game, then clamped to 0.85 - 1.10
            var rawMultiplier = event.data.budgetMultiplier || 1.0;
            var multiplier = Math.max(0.85, Math.min(1.10, rawMultiplier));
            
            // Hide the overlay
            document.getElementById('cc-overlay').classList.remove('active');
            
            if (currentMeetingType === 'year1') {
                // Year 1: Set initial budget
                var finalBudget = Math.round(40 * multiplier);
                gameState.maxBudget = finalBudget;
                gameState.budget = finalBudget;
                
                // Show the budget results
                var resultTitle, resultMessage, changeText;
                
                // Thresholds adjusted for capped multiplier range (0.85-1.10)
                if (multiplier >= 1.08) {
                    resultTitle = '🏆 Excellent Facilitation!';
                    resultMessage = 'Outstanding meeting! The board is impressed with your facilitation skills.';
                    changeText = '<span style="color: var(--success);">+' + Math.round((multiplier - 1) * 100) + '% budget boost!</span>';
                } else if (multiplier >= 1.03) {
                    resultTitle = '✓ Good Meeting';
                    resultMessage = 'Solid facilitation. The committee approved a budget increase.';
                    changeText = '<span style="color: var(--success);">+' + Math.round((multiplier - 1) * 100) + '% budget boost</span>';
                } else if (multiplier >= 0.97) {
                    resultTitle = '📋 Acceptable Meeting';
                    resultMessage = 'Meeting concluded adequately. Standard budget approved.';
                    changeText = 'Standard budget';
                } else if (multiplier >= 0.90) {
                    resultTitle = '⚠️ Difficult Meeting';
                    resultMessage = 'The meeting had some issues. Budget slightly reduced.';
                    changeText = '<span style="color: var(--danger);">' + Math.round((multiplier - 1) * 100) + '% budget cut</span>';
                } else {
                    resultTitle = '💥 Challenging Meeting';
                    resultMessage = 'The meeting was difficult. Budget reduced.';
                    changeText = '<span style="color: var(--danger);">' + Math.round((multiplier - 1) * 100) + '% from standard</span>';
                }
                
                document.getElementById('budget-result-title').textContent = resultTitle;
                document.getElementById('budget-result-message').textContent = resultMessage;
                document.getElementById('budget-result-amount').textContent = '$' + finalBudget + 'M';
                document.getElementById('budget-result-change').innerHTML = changeText;
                
                showPhase('budget-results');
            } else {
                // Year 2: Adjust existing budget based on maxBudget, not remaining budget
                var oldBudget = gameState.maxBudget;
                var newBudget = Math.round(oldBudget * multiplier);
                
                // Ensure minimum budget floor of 20M (half of standard 40M)
                newBudget = Math.max(20, newBudget);
                
                // Calculate actual adjustment after floor
                var adjustment = newBudget - oldBudget;
                
                gameState.maxBudget = newBudget;
                // Also update current budget proportionally, but don't exceed new max
                var budgetRatio = gameState.budget / oldBudget;
                gameState.budget = Math.min(newBudget, Math.round(newBudget * budgetRatio));
                
                var resultTitle, resultMessage, changeText;
                
                // Thresholds adjusted for capped multiplier range (0.85-1.10)
                if (multiplier >= 1.08) {
                    resultTitle = '🏆 Outstanding Review!';
                    resultMessage = 'The committee is thrilled with progress. Funding increase approved!';
                    changeText = '<span style="color: var(--success);">+$' + Math.abs(adjustment) + ' M boost!</span>';
                } else if (multiplier >= 1.03) {
                    resultTitle = '✓ Positive Review';
                    resultMessage = 'Strong progress earned additional funding.';
                    changeText = '<span style="color: var(--success);">+$' + Math.abs(adjustment) + ' M increase</span>';
                } else if (multiplier >= 0.97) {
                    resultTitle = '📋 Satisfactory Review';
                    resultMessage = 'Progress is on track. Budget maintained.';
                    changeText = 'No change';
                } else if (multiplier >= 0.90) {
                    resultTitle = '⚠️ Concerns Raised';
                    resultMessage = 'Some concerns about progress. Minor budget adjustment.';
                    changeText = '<span style="color: var(--danger);">-$' + Math.abs(adjustment) + ' M cut</span>';
                } else {
                    resultTitle = '📉 Disappointing Review';
                    resultMessage = 'The committee is unhappy. Budget reduced.';
                    changeText = '<span style="color: var(--danger);">-$' + Math.abs(adjustment) + ' M reduction</span>';
                }
                
                document.getElementById('year2-budget-result-title').textContent = resultTitle;
                document.getElementById('year2-budget-result-message').textContent = resultMessage;
                document.getElementById('year2-budget-result-amount').textContent = '$' + newBudget + 'M';
                document.getElementById('year2-budget-result-change').innerHTML = changeText;
                
                showPhase('year2-budget-results');
            }
                } else if (event.data.type === 'resourceRunDone') {
            // Hide the overlay
            document.getElementById('rr-overlay').classList.remove('active');

            // Optional: award a small budget bump based on performance (kept modest)
            var score = Number(event.data.score || 0);
            var result = event.data.result || 'unknown';

            // Simple tiers: crash/timeout yields no bonus; victory yields bigger bonus
            var bonus = 0;
            if (result === 'victory') {
                bonus = 1.5; // +$1.5M
            } else if (score >= 4000) {
                bonus = 1.0; // +$1M
            } else if (score >= 2000) {
                bonus = 0.5; // +$0.5M
            }

            if (bonus > 0) {
                gameState.maxBudget = (gameState.maxBudget || 0) + bonus;
                gameState.budget = (gameState.budget || 0) + bonus;
            }

            // Continue the main game flow
            if (typeof rrAfterCallback === 'function') {
                var cb = rrAfterCallback;
                rrAfterCallback = null;
                cb({ result: result, score: score, bonus: bonus });
            }
        }
    });
    
    // ============================================
    // PROJECT COCKPIT FUNCTIONS
    // ============================================
    
    let cockpitSelectedProject = null;
    let cockpitSelectedAction = null;
    
    // Action implications data
    const cockpitActionImplications = {
        continue: {
            effects: [
                { type: 'neutral', text: 'No budget change' },
                { type: 'neutral', text: 'Timeline unchanged' },
                { type: 'positive', text: 'Team stability' }
            ]
        },
        accelerate: {
            effects: [
                { type: 'positive', text: '+50% budget boost' },
                { type: 'positive', text: '-1 quarter timeline' },
                { type: 'negative', text: 'Higher burn rate' }
            ]
        },
        reduce: {
            effects: [
                { type: 'positive', text: '-30% budget savings' },
                { type: 'negative', text: '+1 quarter timeline' },
                { type: 'neutral', text: 'Reduced scope' }
            ]
        },
        champion: {
            effects: [
                { type: 'positive', text: 'Executive visibility' },
                { type: 'positive', text: 'Priority resources' },
                { type: 'negative', text: 'Uses political capital' }
            ]
        },
        kill: {
            effects: [
                { type: 'positive', text: 'Free up budget & team' },
                { type: 'negative', text: 'Sunk costs lost' },
                { type: 'negative', text: 'Team morale impact' }
            ]
        }
    };
    
    function showCockpitView() {
        renderCockpitView();
        showPhase('cockpit');
    }
    
    function renderCockpitView() {
        const year = gameState.currentQuarter <= 4 ? 1 : 2;
        const quarterInYear = gameState.currentQuarter <= 4 ? gameState.currentQuarter : gameState.currentQuarter - 4;
        
        // Count RAG status
        let greenCount = 0, amberCount = 0, redCount = 0;
        gameState.activeProjects.forEach(p => {
            const status = p.latestUpdate?.status || 'green';
            if (status === 'green') greenCount++;
            else if (status === 'yellow') amberCount++;
            else redCount++;
        });
        
        // Calculate total budget and spent
        let totalBudget = 0, totalSpent = 0;
        gameState.activeProjects.forEach(p => {
            totalBudget += p.budget;
            totalSpent += p.spentBudget || 0;
        });
        
        const needsAction = amberCount + redCount;
        
        // Render header
        const spentPercent = totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0;
        document.getElementById('cockpit-header').innerHTML = `
            <div class="cockpit-title-section">
                <h2>🎛️ Project Cockpit</h2>
                <span class="cockpit-quarter-badge">Q${gameState.currentQuarter} · Year ${year}</span>
            </div>
            <div class="cockpit-stats">
                <div class="rag-summary">
                    <span class="rag-pill green">${greenCount} ✓</span>
                    <span class="rag-pill amber">${amberCount} !</span>
                    <span class="rag-pill red">${redCount} ✗</span>
                </div>
                <div class="cockpit-stat">
                    <span class="value">$${totalBudget.toFixed(1)}M</span>
                    <span class="label">Budget</span>
                </div>
                <div class="cockpit-stat">
                    <span class="value">${spentPercent}%</span>
                    <span class="label">Spent</span>
                </div>
                ${needsAction > 0 ? `
                <div class="cockpit-stat alert">
                    <span class="value">${needsAction}</span>
                    <span class="label">Action</span>
                </div>` : ''}
            </div>
        `;
        
        // Render project grid
        const gridHtml = gameState.activeProjects.map(project => {
            const update = project.latestUpdate || {};
            const status = update.status || 'green';
            const ragClass = status === 'yellow' ? 'amber' : status;
            const budgetPct = Math.round((project.spentBudget || 0) / project.budget * 100);
            const progress = update.progress || 0;
            const remaining = Math.max(0, project.timeline - (project.currentQuarter || 0));
            
            const decisionTag = project.decision && project.decision !== 'continue' ? 
                `<span class="decision-tag ${project.decision}">${project.decision}</span>` : '';
            
            // Determine what to show in the status area
            let statusText = '';
            if (decisionTag) {
                statusText = decisionTag;
            } else if (update.narrative) {
                statusText = update.narrative.substring(0, 60) + '...';
            } else if (project.tagline) {
                statusText = project.tagline.substring(0, 60) + (project.tagline.length > 60 ? '...' : '');
            } else {
                statusText = `$${project.budget.toFixed(1)}M · ${project.timeline}Q timeline`;
            }
            
            // Generate compact strategic bucket badges for cockpit tile
            const cockpitBuckets = (project.strategicBuckets || []).map(b => `
                <span style="display: inline-block; background: ${b.color || '#6366f1'}15; color: ${b.color || '#6366f1'}; padding: 2px 5px; border-radius: 6px; font-size: 0.65em; font-weight: 500;">
                    ${b.icon}
                </span>
            `).join('');
            
            return `
                <div class="cockpit-tile ${ragClass} ${cockpitSelectedProject?.id === project.id ? 'selected' : ''}" 
                     onclick="openCockpitPanel('${project.id}')">
                    <div class="cockpit-tile-header">
                        <span class="cockpit-tile-name">${project.name}</span>
                        <span class="cockpit-tile-quarter">Q${project.currentQuarter || 0}/${project.timeline}</span>
                    </div>
                    <div style="display: flex; gap: 4px; margin-bottom: 6px;">
                        ${cockpitBuckets || ''}
                    </div>
                    <div class="cockpit-tile-metrics">
                        <div class="cockpit-metric">
                            <div class="value">${progress}%</div>
                            <div class="label">Progress</div>
                        </div>
                        <div class="cockpit-metric">
                            <div class="value">${budgetPct}%</div>
                            <div class="label">Spent</div>
                        </div>
                        <div class="cockpit-metric">
                            <div class="value">${remaining}Q</div>
                            <div class="label">Left</div>
                        </div>
                    </div>
                    <div class="cockpit-tile-progress">
                        <div class="cockpit-tile-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="cockpit-tile-status">
                        ${statusText}
                    </div>
                    <button class="cockpit-tile-btn" onclick="event.stopPropagation(); openCockpitPanel('${project.id}')">
                        ⚙️ Manage
                    </button>
                </div>
            `;
        }).join('');
        
        // Handle empty state
        if (gameState.activeProjects.length === 0) {
            document.getElementById('cockpit-grid').innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray-500);">
                    <div style="font-size: 3em; margin-bottom: 15px;">📭</div>
                    <h3 style="margin: 0 0 10px; color: var(--gray-700);">No Active Projects</h3>
                    <p style="margin: 0;">All projects have completed or been terminated. Click below to view your final results.</p>
                </div>
            `;
        } else {
            document.getElementById('cockpit-grid').innerHTML = gridHtml;
        }
    }
    
    function openCockpitPanel(projectId) {
        cockpitSelectedProject = gameState.activeProjects.find(p => p.id === projectId);
        cockpitSelectedAction = null;
        
        if (!cockpitSelectedProject) return;
        
        const p = cockpitSelectedProject;
        const update = p.latestUpdate || {};
        const status = update.status || 'green';
        const ragClass = status === 'yellow' ? 'amber' : status;
        const ragLabel = status === 'green' ? 'On Track' : status === 'yellow' ? 'At Risk' : 'Critical';
        
        // Update header
        document.getElementById('cockpit-panel-name').textContent = p.name;
        document.getElementById('cockpit-panel-tagline').textContent = p.tagline || '';
        
        const badge = document.getElementById('cockpit-panel-badge');
        badge.className = `panel-rag-badge ${ragClass}`;
        badge.textContent = ragLabel;
        
        // Calculate metrics
        const budgetUsed = Math.round((p.spentBudget || 0) / p.budget * 100);
        const remaining = Math.max(0, p.timeline - p.currentQuarter);
        const progress = update.progress || 0;
        
        // Get strategic buckets with full styling
        const strategicBuckets = (p.strategicBuckets || []);
        const strategicHtml = strategicBuckets.length > 0 
            ? strategicBuckets.map(b => `
                <span style="display: inline-flex; align-items: center; gap: 5px; background: ${b.color || '#6366f1'}15; color: ${b.color || '#6366f1'}; padding: 6px 12px; border-radius: 16px; font-size: 0.9em; font-weight: 500; border: 1px solid ${b.color || '#6366f1'}30;">
                    ${b.icon || '🎯'} ${b.name || 'Strategy'}
                </span>
            `).join(' ')
            : '<span style="color: var(--gray-500); font-style: italic;">Not specified</span>';
        
        // Get milestone info
        const milestones = p.milestones?.milestones || p.milestones?.phases || [
            { name: 'Research' }, { name: 'Development' }, { name: 'Testing' }, { name: 'Launch' }
        ];
        const milestonesComplete = update.milestonesComplete || Math.floor((p.currentQuarter / p.timeline) * milestones.length);
        
        // Generate management advice based on committee and project status
        const advice = generateManagementAdvice(p, update);
        
        // Render panel body
        document.getElementById('cockpit-panel-body').innerHTML = `
            <!-- Project Link -->
            <button class="project-link-btn" onclick="openProjectTemplateModal('${p.id}')">
                📄 View Original Project Proposal & Goals
            </button>
            
            <!-- Key Metrics -->
            <div class="panel-section">
                <h4>📊 Key Metrics</h4>
                <div class="panel-metrics-grid">
                    <div class="panel-metric-box">
                        <div class="value">${progress}%</div>
                        <div class="label">Progress</div>
                    </div>
                    <div class="panel-metric-box">
                        <div class="value">$${(p.spentBudget || 0).toFixed(1)}M</div>
                        <div class="label">of $${p.budget}M</div>
                    </div>
                    <div class="panel-metric-box ${budgetUsed > 80 ? 'warning' : ''} ${budgetUsed > 100 ? 'danger' : ''}">
                        <div class="value">${budgetUsed}%</div>
                        <div class="label">Budget Used</div>
                    </div>
                    <div class="panel-metric-box">
                        <div class="value">${remaining}Q</div>
                        <div class="label">Remaining</div>
                    </div>
                </div>
            </div>
            
            <!-- Project Snapshot -->
            <div class="panel-section">
                <h4>🧭 Innovation Cues</h4>
                ${renderInnovationBadges(p, true)}
                <div style="margin-top: 8px; font-size: 0.9em; color: var(--gray-700); line-height: 1.35;">
                    <div><strong>Tech:</strong> ${getInnovationCues(p).tech.label}${getInnovationCues(p).tech.trl ? ` (TRL ${getInnovationCues(p).tech.trl}/9)` : ''}</div>
                    <div><strong>Market:</strong> ${getInnovationCues(p).market.label} — ${getInnovationCues(p).market.sector}</div>
                </div>
            </div>
            
            <!-- Strategic Focus - Prominent Display -->
            <div class="panel-section">
                <h4>🎯 Strategic Alignment</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    ${strategicHtml}
                </div>
            </div>

            <!-- Project Snapshot -->
            <div class="panel-section">
                <h4>📋 Project Snapshot</h4>
                <div class="snapshot-grid">
                    <div class="snapshot-item">
                        <div class="label">TRL Progress</div>
                        <div class="value">TRL ${p.trl?.current || '?'} → ${p.trl?.target || '?'}</div>
                    </div>
                    <div class="snapshot-item">
                        <div class="label">Timeline</div>
                        <div class="value">${p.timeline} quarters total</div>
                    </div>
                    <div class="snapshot-item">
                        <div class="label">Team Size</div>
                        <div class="value">${p.teamLeads?.length ? p.teamLeads.length + ' leads' : 'TBD'}</div>
                    </div>
                </div>
            </div>
            


            <!-- Market & Competition -->
            <div class="panel-section">
                <h4>🏪 Market & Competition</h4>
                <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap: 12px;">
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 10px; border: 1px solid var(--gray-200);">
                        <div style="font-weight: 700; margin-bottom: 6px;">Market story</div>
                        <div style="font-size: 0.9em; color: var(--gray-700); line-height: 1.35;">
                            ${p.marketContext || 'Market analysis pending.'}
                        </div>
                    </div>
                    <div style="background: var(--gray-50); padding: 12px; border-radius: 10px; border: 1px solid var(--gray-200);">
                        <div style="font-weight: 700; margin-bottom: 6px;">Competitors</div>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                            ${(Array.isArray(p.competitors) ? p.competitors : []).map(c => `
                                <div style="background: white; padding: 10px; border-radius: 10px; border-left: 3px solid ${
                                    (c.threat || '').toLowerCase().includes('high') ? 'var(--danger)' :
                                    (c.threat || '').toLowerCase().includes('medium') ? 'var(--warning)' :
                                    'var(--success)'
                                }; border: 1px solid var(--gray-200);">
                                    <div style="font-weight: 650; font-size: 0.9em; margin-bottom: 4px;">${c.name || 'Competitor'}</div>
                                    <div style="font-size: 0.85em; color: var(--gray-600);">${c.position || ''}</div>
                                </div>
                            `).join('') || `<div style="color: var(--gray-500); font-size: 0.9em;">No competitor data available.</div>`}
                        </div>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 0.8em; color: var(--gray-500);">
                    Tip: use <strong>“View Original Project Proposal & Goals”</strong> above for full detail.
                </div>
            </div>

            <!-- Milestone Progress -->
            <div class="panel-section">
                <h4>🎯 Milestone Progress</h4>
                <div class="milestone-track">
                    ${milestones.map((m, i) => {
                        let status = 'pending';
                        if (i < milestonesComplete) status = 'complete';
                        else if (i === milestonesComplete) status = 'current';
                        return `
                            <div class="milestone-step">
                                <div class="milestone-step-bar ${status}"></div>
                                <div class="milestone-step-label">${m.name || m.phase || 'M' + (i+1)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="milestone-narrative">${update.narrative || 'No update available this quarter.'}</div>
            </div>
            
            <!-- Intelligence Summary -->
            <div class="panel-section">
                <h4>🔍 Intelligence Summary</h4>
                <div class="intel-grid">
                    <div class="intel-card">
                        <h5>🏁 Competition</h5>
                        <p>${getCompetitorUpdate(p, status === 'green')}</p>
                    </div>
                    <div class="intel-card">
                        <h5>🛡️ IP Position</h5>
                        <p>${getIPUpdate(p, status === 'green')}</p>
                    </div>
                    <div class="intel-card">
                        <h5>👥 Team & Resources</h5>
                        <p>${getTeamUpdate(p, status === 'green')}</p>
                    </div>
                    <div class="intel-card">
                        <h5>⚠️ Key Risk</h5>
                        <p>${getRiskAssessment(p, update)}</p>
                    </div>
                </div>
            </div>
            
            <!-- Management Advice -->
            <div class="advice-section">
                <h4>💼 Leadership Perspectives</h4>
                <div class="advice-cards">
                    ${advice.map(a => `
                        <div class="advice-card">
                            <div class="advice-header">
                                <div class="advisor-avatar" style="background: ${a.color}">${a.initials}</div>
                                <div class="advisor-info">
                                    <div class="name">${a.name}</div>
                                    <div class="role">${a.role}</div>
                                </div>
                                <span class="advice-stance ${a.stance}">${a.stance.charAt(0).toUpperCase() + a.stance.slice(1)}</span>
                            </div>
                            <div class="advice-quote">"${a.quote}"</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // Reset action buttons
        document.querySelectorAll('.cockpit-action-btn').forEach(btn => btn.classList.remove('selected'));
        
        // Pre-select current decision if exists
        if (p.decision) {
            const currentBtn = document.querySelector(`.cockpit-action-btn.${p.decision}`);
            if (currentBtn) {
                currentBtn.classList.add('selected');
                cockpitSelectedAction = p.decision;
                updateCockpitImplications(p.decision);
                document.getElementById('cockpit-confirm-btn').disabled = false;
                document.getElementById('cockpit-confirm-btn').textContent = `Decision: ${p.decision.charAt(0).toUpperCase() + p.decision.slice(1)}`;
            }
        } else {
            document.getElementById('cockpit-confirm-btn').disabled = true;
            document.getElementById('cockpit-confirm-btn').textContent = 'Select an action to continue';
            document.getElementById('cockpit-implications-placeholder').style.display = 'block';
            document.getElementById('cockpit-implications-content').classList.remove('visible');
        }
        
        // Show panel
        document.getElementById('cockpit-overlay').classList.add('active');
        document.getElementById('cockpit-panel').classList.add('active');
        
        // Update grid to show selection
        renderCockpitView();
    }
    
    function closeCockpitPanel() {
        document.getElementById('cockpit-overlay').classList.remove('active');
        document.getElementById('cockpit-panel').classList.remove('active');
        cockpitSelectedProject = null;
        cockpitSelectedAction = null;
        renderCockpitView();
    }
    
    function selectCockpitAction(action) {
        cockpitSelectedAction = action;
        
        // Update button states
        document.querySelectorAll('.cockpit-action-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        document.querySelector(`.cockpit-action-btn.${action}`).classList.add('selected');
        
        // Show implications
        updateCockpitImplications(action);
        
        // Enable confirm button
        const confirmBtn = document.getElementById('cockpit-confirm-btn');
        confirmBtn.disabled = false;
        
        const actionLabels = {
            continue: 'Confirm: Continue',
            accelerate: 'Confirm: Accelerate',
            reduce: 'Confirm: Reduce Scope',
            champion: 'Confirm: Champion',
            kill: 'Confirm: Stop Project'
        };
        confirmBtn.textContent = actionLabels[action];
    }
    
    function updateCockpitImplications(action) {
        const placeholder = document.getElementById('cockpit-implications-placeholder');
        const content = document.getElementById('cockpit-implications-content');
        const implications = cockpitActionImplications[action];
        
        placeholder.style.display = 'none';
        content.classList.add('visible');
        content.innerHTML = implications.effects.map(e => `
            <span class="implication-item ${e.type}">
                ${e.type === 'positive' ? '✓' : e.type === 'negative' ? '✗' : '•'} ${e.text}
            </span>
        `).join('');
    }
    
    function confirmCockpitDecision() {
        if (!cockpitSelectedProject || !cockpitSelectedAction) return;
        
        // Map champion to continue (with flag for future enhancement)
        let gameAction = cockpitSelectedAction;
        if (cockpitSelectedAction === 'champion') {
            gameAction = 'continue';
            cockpitSelectedProject.championed = true;
        }
        
        // Set decision using existing game function
        setDecision(cockpitSelectedProject.id, gameAction);
        
        // Close panel and refresh
        closeCockpitPanel();
    }
    
    function generateManagementAdvice(project, update) {
        const status = update.status || 'green';
        const advice = [];
        
        // Get committee members for personalized advice
        const committee = gameState.committee || [];
        
        // CEO perspective (always included - Meera Venkataraman)
        const ceoAdvice = {
            name: 'Meera Venkataraman',
            initials: 'MV',
            role: 'CEO',
            color: '#003da5'
        };
        
        if (status === 'green') {
            ceoAdvice.stance = 'supportive';
            ceoAdvice.quote = 'Strong execution. This is the kind of progress that builds investor confidence. Keep the momentum.';
        } else if (status === 'yellow') {
            ceoAdvice.stance = 'cautious';
            ceoAdvice.quote = 'I see potential here, but we need to address those concerns. What resources would help get this back on track?';
        } else {
            ceoAdvice.stance = 'concerned';
            ceoAdvice.quote = 'We need an honest assessment of whether the original thesis still holds. I\'m open to options, but the status quo isn\'t working.';
        }
        advice.push(ceoAdvice);
        
        // Add COO for operational projects or budget concerns (Sanjay Hegde)
        const budgetUsed = (project.spentBudget || 0) / project.budget;
        if (budgetUsed > 0.7 || status === 'red') {
            const cooAdvice = {
                name: 'Sanjay Hegde',
                initials: 'SH',
                role: 'COO',
                color: '#059669'
            };
            
            if (budgetUsed > 0.9) {
                cooAdvice.stance = 'concerned';
                cooAdvice.quote = 'Budget utilization is concerning. We need a clear path to completion or we should consider descoping significantly.';
            } else if (status === 'red') {
                cooAdvice.stance = 'concerned';
                cooAdvice.quote = 'The operational metrics are worrying. I\'d recommend a thorough review before committing more resources.';
            } else {
                cooAdvice.stance = 'cautious';
                cooAdvice.quote = 'Keep an eye on the burn rate. If we extend timeline, we need clear milestones for the next gate.';
            }
            advice.push(cooAdvice);
        }
        
        // Add CTO for technical projects (Harpreet Singh)
        if (project.trl && project.trl.current < 6) {
            const ctoAdvice = {
                name: 'Harpreet Singh',
                initials: 'HS',
                role: 'CTO',
                color: '#2563eb'
            };
            
            if (status === 'green') {
                ctoAdvice.stance = 'supportive';
                ctoAdvice.quote = 'The technical foundation looks solid. This could become a platform differentiator if we execute well.';
            } else if (status === 'yellow') {
                ctoAdvice.stance = 'cautious';
                ctoAdvice.quote = 'Some technical debt building up. I\'d rather extend timeline than cut corners on architecture.';
            } else {
                ctoAdvice.stance = 'concerned';
                ctoAdvice.quote = 'The technical complexity was underestimated. Consider bringing in external expertise before committing more.';
            }
            advice.push(ctoAdvice);
        }
        
        // Add VP Marketing for market-facing projects (Anjali Deshmukh)
        const hasSalesFocus = (project.strategicBuckets || []).some(b => 
            b.id === 'defend-metro' || b.id === 'tier23-rollout'
        );
        if (hasSalesFocus && advice.length < 3) {
            const marketingAdvice = {
                name: 'Anjali Deshmukh',
                initials: 'AD',
                role: 'VP Marketing',
                color: '#ec4899'
            };
            
            if (status === 'green') {
                marketingAdvice.stance = 'supportive';
                marketingAdvice.quote = 'Channel partners are asking about this. If we can hit the launch window, distribution is ready.';
            } else {
                marketingAdvice.stance = 'neutral';
                marketingAdvice.quote = 'Market timing matters here. I\'d want to see the roadmap firmed up before committing marketing resources.';
            }
            advice.push(marketingAdvice);
        }
        
        return advice.slice(0, 3); // Max 3 advisors
    }
    
    function openProjectTemplateModal(projectId) {
        // Look in projectPool first (during assessment), then activeProjects (during execution)
        let project = null;
        if (gameState.projectPool) {
            project = gameState.projectPool.find(p => p.id === projectId || p.id === parseInt(projectId));
        }
        if (!project && gameState.activeProjects) {
            project = gameState.activeProjects.find(p => p.id === projectId || p.id === parseInt(projectId));
        }
        if (!project) return;
        
        const showTeam = shouldShowTeamInfo();
        
        // Build modal content from project data
        const modalHtml = `
            <div class="template-modal-overlay" onclick="closeProjectTemplateModal()">
                <div class="template-modal" onclick="event.stopPropagation()">
                    <div class="template-header">
                        <div>
                            <h3>${project.name}</h3>
                            <p class="tagline">${project.tagline || ''}</p>
                        </div>
                        <div class="template-budget-badge">
                            <div class="amount">$${project.budget}M </div>
                            <div class="label">Budget</div>
                        </div>
                    </div>
                    <div class="template-body">

                        <div class="template-section">
                            <h4>🧭 Innovation Signals</h4>
                            ${renderInnovationDetail(project)}
                        </div>
                        <div class="template-section">
                            <h4>📋 Project Overview</h4>
                            <p>${project.fullDesc || project.desc || 'No description available.'}</p>
                        </div>
                        
                        <div class="template-section">
                            <h4>📊 Market Context</h4>
                            <p>${project.marketContext || 'Market analysis pending.'}</p>
                        </div>
                        
                        <div class="template-section">
                            <h4>🏗️ Capability Fit</h4>
                            <p>${project.capabilityFit || 'Capability assessment pending.'}</p>
                        </div>
                        
                        <div class="template-section">
                            <h4>🎯 Development Milestones</h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${(project.milestones?.milestones || project.milestones?.phases || []).map((m, i) => `
                                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary);">
                                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">${m.phase || m.name || 'Phase ' + (i+1)}</div>
                                        <div style="font-size: 0.8em; color: var(--gray-500);">
                                            ${m.quarters ? '📆 ' + m.quarters + ' · ' : ''}
                                            ${m.duration ? '⏱️ ' + m.duration : ''}
                                            ${m.costAmount ? ' · 💰 $' + m.costAmount + 'M' : ''}
                                        </div>
                                        ${m.deliverables ? `
                                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
                                                ${(Array.isArray(m.deliverables) ? m.deliverables : []).map(d => `<span style="background: white; padding: 3px 8px; border-radius: 10px; font-size: 0.75em; color: var(--gray-600); border: 1px solid var(--gray-200);">${d}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="template-section">
                            <h4>🔬 Technology Readiness Level (TRL)</h4>
                            <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                                ${[1,2,3,4,5,6,7,8,9].map(level => `
                                    <div style="flex: 1; height: 30px; display: flex; align-items: center; justify-content: center; 
                                                background: ${level <= (project.trl?.current || 3) ? 'var(--primary)' : level <= (project.trl?.target || 7) ? 'var(--primary-lighter)' : 'var(--gray-200)'}; 
                                                color: ${level <= (project.trl?.current || 3) ? 'white' : level <= (project.trl?.target || 7) ? 'var(--primary)' : 'var(--gray-400)'};
                                                border-radius: 4px; font-weight: 600; font-size: 0.8em;">
                                        ${level}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="display: flex; gap: 20px; font-size: 0.8em; color: var(--gray-600);">
                                <span>● Current: TRL ${project.trl?.current || '?'}</span>
                                <span>○ Target: TRL ${project.trl?.target || '?'}</span>
                            </div>
                            <div style="margin-top: 12px; padding: 10px 12px; background: var(--gray-50); border-radius: 8px; font-size: 0.75em; color: var(--gray-600);">
                                <div style="font-weight: 600; margin-bottom: 6px; color: var(--gray-700);">TRL Scale Guide:</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                    <span><strong>1–3</strong> Research: concept &amp; lab testing</span>
                                    <span><strong>4–6</strong> Development: prototype &amp; validation</span>
                                    <span><strong>7–9</strong> Deployment: operational &amp; proven</span>
                                </div>
                            </div>
                            ${project.trl?.note ? `<p style="margin-top: 10px; font-size: 0.85em;">${project.trl.note}</p>` : ''}
                        </div>
                        
                        <div class="template-section">
                            <h4>🛡️ Intellectual Property (IP) Position</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">ShieldTech IP</div>
                                    <p style="font-size: 0.8em; margin: 0;">${project.ipAnalysis?.shieldtechIP || project.ipPosition?.shieldtech || 'Assessment pending.'}</p>
                                </div>
                                <div style="background: var(--gray-50); padding: 12px; border-radius: 8px;">
                                    <div style="font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--gray-700);">Competitor IP</div>
                                    <p style="font-size: 0.8em; margin: 0;">${project.ipAnalysis?.competitorIP || project.ipPosition?.competitors || 'Assessment pending.'}</p>
                                </div>
                            </div>
                            <div style="padding: 8px 15px; border-radius: 8px; font-size: 0.85em; display: inline-block;
                                        background: ${(project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('high') ? 'var(--danger-light)' : (project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('medium') ? 'var(--warning-light)' : 'var(--success-light)'};
                                        color: ${(project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('high') ? 'var(--danger)' : (project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                                <strong>Freedom to Operate:</strong> ${project.ipAnalysis?.fto || project.ipPosition?.fto || 'Review needed'} · ${project.ipAnalysis?.ftoRisk || project.ipPosition?.risk || 'Unknown'} Risk
                            </div>
                        </div>
                        
                        <div class="template-section">
                            <h4>⚔️ Key Competitors</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                                ${(project.competitors || []).map(c => `
                                    <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; 
                                                border-left: 3px solid ${(c.threat || '').toLowerCase().includes('high') ? 'var(--danger)' : (c.threat || '').toLowerCase().includes('medium') ? 'var(--warning)' : 'var(--success)'};">
                                        <div style="font-weight: 600; font-size: 0.85em; margin-bottom: 4px;">${c.name}</div>
                                        <div style="font-size: 0.8em; color: var(--gray-600);">${c.position}</div>
                                    </div>
                                `).join('') || '<p style="color: var(--gray-500);">No competitor data available.</p>'}
                            </div>
                        </div>
                        
                        ${showTeam ? `
                        <div class="template-section">
                            <h4>👥 Team</h4>
                            ${project.lead ? `
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                                    <div style="width: 45px; height: 45px; border-radius: 50%; background: ${project.lead.avatarColor || 'var(--primary)'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${project.lead.initials || '?'}</div>
                                    <div>
                                        <div style="font-weight: 600;">${project.lead.name}</div>
                                        <div style="font-size: 0.85em; color: var(--gray-600);">${project.lead.role || 'Project Lead'}</div>
                                    </div>
                                    <div style="margin-left: auto; padding: 4px 12px; border-radius: 15px; font-weight: 600; font-size: 0.85em;
                                                background: ${project.lead.trackRecord ? (((project.lead.trackRecord.successes + project.lead.trackRecord.partial * 0.5) / (project.lead.trackRecord.successes + project.lead.trackRecord.failures + project.lead.trackRecord.partial)) >= 0.7 ? 'var(--success-light)' : 'var(--warning-light)') : 'var(--gray-100)'};
                                                color: ${project.lead.trackRecord ? (((project.lead.trackRecord.successes + project.lead.trackRecord.partial * 0.5) / (project.lead.trackRecord.successes + project.lead.trackRecord.failures + project.lead.trackRecord.partial)) >= 0.7 ? 'var(--success)' : 'var(--warning)') : 'var(--gray-500)'};">
                                        ${project.lead.trackRecord ? Math.round(((project.lead.trackRecord.successes + project.lead.trackRecord.partial * 0.5) / (project.lead.trackRecord.successes + project.lead.trackRecord.failures + project.lead.trackRecord.partial)) * 100) + '% track record' : 'New lead'}
                                    </div>
                                </div>
                            ` : ''}
                            <p>${project.teamNote || 'Team assignment pending.'}</p>
                        </div>
                        ` : `
                        <div class="template-section">
                            <h4>👥 Team</h4>
                            <div class="blinded-section" style="margin: 0;">
                                <div class="blinded-icon">🎭</div>
                                <div class="blinded-text">
                                    <strong>Team Information Hidden</strong>
                                    <span>Blind Review mode — team details not visible.</span>
                                </div>
                            </div>
                        </div>
                        `}
                    </div>
                    <button class="template-close" onclick="closeProjectTemplateModal()">Close</button>
                </div>
            </div>
        `;
        
        const container = document.createElement('div');
        container.id = 'template-modal-container';
        container.innerHTML = modalHtml;
        document.body.appendChild(container);
    }
    
    function closeProjectTemplateModal() {
        const container = document.getElementById('template-modal-container');
        if (container) container.remove();
    }
    </script>
</body>
</html>
