<!DOCTYPE html>
<!--
  The Smart Scale Game
  A Business Simulation About Scaling Corporate Ventures
  =====================================
  © 2025 Ammon Salter
  
  Created By:
    Ammon Salter — Warwick Business School, The University of Warwick
  
  Contributors:
    Federico Bignone
    Orietta Marsili
  
  AI Assistance:
    Claude (Anthropic)
    GPT-5 (OpenAI)
    Gemini (Google)
  
  Licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 
  International License (CC BY-NC-SA 4.0).
  
  You are free to:
    - Share: copy and redistribute the material in any medium or format
    - Adapt: remix, transform, and build upon the material
  
  Under the following terms:
    - Attribution: You must give appropriate credit to the creator
    - NonCommercial: You may not use the material for commercial purposes
    - ShareAlike: If you remix or transform, you must distribute under the same license
  
  Full license: https://creativecommons.org/licenses/by-nc-sa/4.0/
  
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
  IMPLIED. This is an educational simulation. The scenarios, companies, and 
  characters depicted are fictional.
-->
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J7ZXGBNCF6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J7ZXGBNCF6');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#5046e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>The Smart Scale Game</title>
    <style>
        :root {
            --color-primary: #5046e5;
            --color-primary-dark: #3730a3;
            --color-primary-light: #818cf8;
            --text-dark: #1e293b;
            --text-medium: #475569;
            --text-light: #64748b;
            --bg-white: #ffffff;
            --bg-light: #f8fafc;
            --bg-subtle: #f1f5f9;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --color-emerald: #10b981;
            --color-emerald-dark: #059669;
            --color-red: #ef4444;
            --color-amber: #f59e0b;
            --color-purple: #8b5cf6;
            --color-sky: #0ea5e9;
            /* Legacy compatibility */
            --color-green: #10b981;
            --color-brand-blue: #5046e5;
            --color-dark-blue: #3730a3;
            --color-grey: #e2e8f0;
            --color-dark-grey: #475569;
            --color-white: #ffffff;
            --color-light-grey: #f1f5f9;
            --color-orange: #f59e0b;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html {
            /* Prevent overscroll bounce on iOS */
            overscroll-behavior: none;
            /* CSS custom property for iOS viewport height fix */
            --app-height: 100vh;
        }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            min-height: var(--app-height, 100vh);
            overflow-x: hidden;
            /* Prevent pull-to-refresh */
            overscroll-behavior-y: contain;
            /* Prevent text selection on buttons */
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection in specific areas */
        .email-view-body, .modal-content p, .reflection-message {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Prevent double-tap zoom on interactive elements */
        button, a, .email-item, .reply-option, .inbox-filter, .mobile-nav-item {
            touch-action: manipulation;
        }
        
        #game-container { 
            width: 100%; 
            min-height: 100vh;
            min-height: var(--app-height, 100vh);
            display: flex; 
            flex-direction: column;
        }

        /* ===== TOP BAR ===== */
        #top-bar { 
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .brand-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .brand-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(80, 70, 229, 0.3);
        }
        .brand-logo svg {
            width: 36px;
            height: 36px;
        }
        
        .brand-title {
            color: var(--text-dark);
            font-weight: 700;
            font-size: 1.2em;
            letter-spacing: -0.02em;
        }
        
        .venture-tag {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            border: 1px solid #c4b5fd;
            color: var(--color-primary-dark);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: none;
        }
        .venture-tag.visible { display: inline-block; }
        
        #venture-logo-small {
            display: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-left: 10px;
        }
        #venture-logo-small.visible { display: flex; align-items: center; justify-content: center; }
        #venture-logo-small svg { width: 28px; height: 28px; }
        
        .game-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .turn-display {
            background: var(--bg-subtle);
            padding: 8px 16px;
            border-radius: 20px;
            color: var(--text-medium);
            font-weight: 600;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-light);
        }
        .turn-display span { color: var(--text-dark); font-weight: 700; }
        
        #next-month-btn {
            background: linear-gradient(135deg, var(--color-emerald), var(--color-emerald-dark));
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 0.95em;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        #next-month-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        #next-month-btn:disabled { 
            background: linear-gradient(135deg, #94a3b8, #64748b); 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }

        /* ===== LEADERSHIP TEAM BAR ===== */
        #team-bar {
            background: linear-gradient(135deg, #0d7377, #14919b);
            padding: 14px 24px;
            display: none;
            box-shadow: 0 2px 8px rgba(13, 115, 119, 0.3);
        }
        #team-bar.visible { display: block; }
        
        .team-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .team-member {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 8px 14px 8px 8px;
            transition: all 0.2s;
        }
        .team-member:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .team-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.4);
            background: white;
            flex-shrink: 0;
        }
        .team-avatar svg { width: 100%; height: 100%; display: block; }
        
        .team-info {
            min-width: 80px;
        }
        .team-name {
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            line-height: 1.2;
        }
        .team-role {
            color: rgba(255,255,255,0.8);
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== MAIN CONTENT AREA ===== */
        #main-content { 
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            min-height: 0;
        }

        /* ===== EMAIL INBOX INTERFACE ===== */
        #email-inbox {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--bg-white);
        }
        
        .inbox-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .inbox-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }
        .inbox-title-icon { font-size: 1.3em; }
        .inbox-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }
        .inbox-count.has-mail {
            background: #e74c3c;
            animation: pulse-badge 2s infinite;
        }
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .inbox-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-subtle);
            font-size: 0.8em;
        }
        .inbox-filter {
            padding: 5px 12px;
            border-radius: 15px;
            background: white;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .inbox-filter:hover, .inbox-filter.active {
            background: var(--color-brand-blue);
            color: white;
            border-color: var(--color-brand-blue);
        }
        
        .email-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .email-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .email-item:hover {
            background: #f8f9ff;
        }
        .email-item.unread {
            background: #f0f4ff;
            border-left: 4px solid var(--color-brand-blue);
        }
        .email-item.unread .email-subject {
            font-weight: 700;
        }
        
        .email-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid var(--border-light);
            background: white;
        }
        .email-avatar svg { width: 100%; height: 100%; display: block; }
        
        .email-content {
            flex: 1;
            min-width: 0;
        }
        .email-top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .email-sender {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95em;
        }
        .email-time {
            font-size: 0.75em;
            color: var(--text-light);
        }
        .email-subject {
            font-size: 0.9em;
            color: var(--text-dark);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .email-preview {
            font-size: 0.8em;
            color: var(--text-medium);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .email-dept-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65em;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }
        .email-dept-tag.finance { background: #fff3e0; color: #ef6c00; }
        .email-dept-tag.hr { background: #f3e5f5; color: #9c27b0; }
        .email-dept-tag.ops { background: #e3f2fd; color: #1976d2; }
        .email-dept-tag.marketing { background: #e8f5e9; color: #388e3c; }
        .email-dept-tag.tech { background: #e0f7fa; color: #00838f; }
        .email-dept-tag.corporate { background: #fce4ec; color: #c2185b; }
        .email-dept-tag.scaling { background: #ede7f6; color: #5e35b1; }
        .email-dept-tag.competitors { background: #ffebee; color: #c62828; }
        
        .inbox-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
            padding: 40px;
            text-align: center;
        }
        .inbox-empty-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .inbox-empty h3 {
            margin-bottom: 10px;
            color: var(--text-medium);
        }
        
        /* Email View (replaces event modal) */
        #email-view-modal .modal-content {
            max-width: 750px;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .email-view-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            flex-shrink: 0;
        }
        .email-view-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .email-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s;
        }
        .email-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .email-view-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .email-view-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
            background: white;
        }
        .email-view-avatar svg { width: 100%; height: 100%; display: block; }
        
        .email-view-info { flex: 1; }
        .email-view-from {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 1px;
        }
        .email-view-address {
            font-size: 0.7em;
            opacity: 0.8;
            margin-bottom: 3px;
        }
        .email-view-subject {
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .email-view-dept-badge {
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            text-transform: uppercase;
        }
        .email-view-dept-badge.finance { background: #fff3e0; color: #ef6c00; }
        .email-view-dept-badge.hr { background: #f3e5f5; color: #9c27b0; }
        .email-view-dept-badge.ops { background: #e3f2fd; color: #1976d2; }
        .email-view-dept-badge.marketing { background: #e8f5e9; color: #388e3c; }
        .email-view-dept-badge.tech { background: #e0f7fa; color: #00838f; }
        .email-view-dept-badge.corporate { background: #fce4ec; color: #c2185b; }
        .email-view-dept-badge.scaling { background: #ede7f6; color: #5e35b1; }
        .email-view-dept-badge.competitors { background: #ffebee; color: #c62828; }
        
        .email-view-body {
            padding: 12px 15px;
            overflow-y: auto;
            flex: 1;
            background: white;
        }
        
        .email-greeting {
            color: var(--text-medium);
            font-size: 0.8em;
            margin-bottom: 8px;
        }
        
        .email-message {
            font-size: 0.85em;
            line-height: 1.5;
            color: var(--text-dark);
            margin-bottom: 10px;
            padding: 10px 12px;
            background: var(--bg-subtle);
            border-radius: 6px;
            border-left: 3px solid var(--color-brand-blue);
        }
        
        .email-signature {
            color: var(--text-medium);
            font-size: 0.75em;
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
        }
        .email-sig-name { font-weight: 600; color: var(--text-dark); }
        .email-sig-title { font-style: italic; }
        
        .email-reply-section {
            background: #f8f9ff;
            border-top: 2px solid var(--color-brand-blue);
            padding: 10px 12px;
        }
        .email-reply-title {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-medium);
            margin-bottom: 8px;
            font-weight: 600;
        }
        .email-reply-subtitle {
            font-size: 0.7em;
            color: var(--text-light);
            margin-bottom: 10px;
        }
        
        .reply-option {
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 0;
            margin-bottom: 6px;
            border: 2px solid var(--border-medium);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            overflow: hidden;
        }
        .reply-option:hover {
            border-color: var(--color-brand-blue);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        .reply-option:nth-child(1) { border-left: 3px solid #3498db; }
        .reply-option:nth-child(2) { border-left: 3px solid #9b59b6; }
        .reply-option:nth-child(3) { border-left: 3px solid #e67e22; }
        
        .reply-option-text {
            padding: 10px 12px;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-dark);
            line-height: 1.4;
        }
        
        .reply-advisor-box {
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid var(--border-light);
        }
        .reply-advisor-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        .reply-advisor-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #0d7377;
            background: white;
        }
        .reply-advisor-avatar svg { width: 100%; height: 100%; display: block; }
        .reply-advisor-name {
            font-weight: 600;
            font-size: 0.75em;
            color: var(--text-dark);
        }
        .reply-advisor-role {
            font-size: 0.6em;
            color: var(--text-medium);
        }
        .reply-advisor-badge {
            margin-left: auto;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.55em;
            background: #e3f2fd;
            color: #1565c0;
        }
        .reply-advisor-message {
            font-size: 0.7em;
            color: var(--text-medium);
            line-height: 1.3;
            font-style: italic;
        }

        /* ===== SIDEBAR DASHBOARD ===== */
        #dashboard {
            background: var(--bg-white);
            border-right: 1px solid var(--border-light);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .dash-section {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px;
        }
        
        .dash-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .dash-section-icon {
            font-size: 1em;
        }
        .dash-section-title {
            color: var(--text-dark);
            font-size: 0.8em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Finance Cards - Simplified */
        .finance-grid {
            display: flex;
            gap: 8px;
        }
        .finance-card {
            flex: 1;
            background: var(--bg-subtle);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border-left: 3px solid var(--border-light);
        }
        .finance-card.budget { border-left-color: var(--color-emerald); }
        .finance-card.pnl { border-left-color: var(--color-amber); }
        
        .finance-label {
            color: var(--text-light);
            font-size: 0.65em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .finance-value {
            color: var(--text-dark);
            font-size: 1.3em;
            font-weight: 700;
        }
        .finance-value.positive { color: var(--color-emerald); }
        .finance-value.negative { color: var(--color-red); }
        .finance-sub {
            color: var(--text-light);
            font-size: 0.65em;
            margin-top: 10px;
            text-align: center;
            padding: 6px;
            background: var(--bg-subtle);
            border-radius: 6px;
        }
        
        .finance-runway {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 8px 12px;
            background: var(--bg-subtle);
            border-radius: 6px;
            font-size: 0.8em;
        }
        .runway-label {
            color: var(--text-medium);
        }
        .runway-value {
            font-weight: 600;
            color: var(--color-emerald-dark);
        }
        .runway-value.warning {
            color: var(--color-orange);
        }
        .runway-value.critical {
            color: var(--color-red);
        }
        
        /* Metric Rows - Simplified */
        .metric-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--bg-subtle);
        }
        .metric-row:last-child { border-bottom: none; }
        
        .metric-row-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric-row-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }
        .metric-row-icon.purple { background: #ede9fe; }
        .metric-row-icon.amber { background: #fef3c7; }
        .metric-row-icon.sky { background: #e0f2fe; }
        .metric-row-icon.emerald { background: #d1fae5; }
        .metric-row-icon.rose { background: #ffe4e6; }
        
        .metric-row-label {
            color: var(--text-medium);
            font-size: 0.8em;
        }
        
        .metric-row-value {
            font-size: 0.85em;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--bg-subtle);
        }
        .metric-row-value.high { color: var(--color-emerald-dark); background: #d1fae5; }
        .metric-row-value.medium { color: var(--text-dark); background: var(--bg-subtle); }
        .metric-row-value.low { color: var(--color-red); background: #fee2e2; }
        
        /* Progress indicator */
        .metric-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .metric-progress-bar {
            width: 60px;
            height: 6px;
            background: var(--bg-subtle);
            border-radius: 3px;
            overflow: hidden;
        }
        .metric-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .metric-progress-fill.purple { background: var(--color-primary); }
        .metric-progress-fill.amber { background: var(--color-amber); }
        .metric-progress-fill.sky { background: var(--color-sky); }
        .metric-progress-fill.emerald { background: var(--color-emerald); }
        .metric-bar-fill.emerald { background: linear-gradient(90deg, #10b981, #34d399); }
        
        .metric-badge {
            background: var(--bg-subtle);
            color: var(--text-dark);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 600;
            min-width: 42px;
            text-align: center;
            border: 1px solid var(--border-light);
        }
        
        /* Template Stage Display */
        .template-card {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            border: 1px solid #c4b5fd;
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            margin-top: 8px;
        }
        .template-stage-label {
            color: var(--text-medium);
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .template-stage-value {
            color: var(--color-primary-dark);
            font-size: 1.2em;
            font-weight: 700;
            margin: 6px 0;
        }
        .template-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .template-progress .metric-bar { flex: 1; height: 8px; background: rgba(255,255,255,0.6); }
        .template-progress-text {
            color: var(--color-primary-dark);
            font-size: 0.85em;
            font-weight: 600;
            min-width: 40px;
        }
        
        /* Staff Module */
        .staff-bar-wrapper {
            margin-bottom: 12px;
        }
        .staff-bar {
            height: 12px;
            background: var(--bg-subtle);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            margin-bottom: 8px;
        }
        .staff-local { background: linear-gradient(90deg, #0ea5e9, #38bdf8); transition: width 0.4s; }
        .staff-global { background: linear-gradient(90deg, #8b5cf6, #a78bfa); transition: width 0.4s; }
        
        .staff-legend {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: var(--text-medium);
        }
        .staff-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .staff-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .staff-dot.local { background: #0ea5e9; }
        .staff-dot.global { background: #8b5cf6; }
        
        /* Morale Display */
        .morale-card {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: var(--bg-subtle);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }
        .morale-emoji { font-size: 2em; }
        .morale-label {
            color: var(--text-medium);
            font-size: 0.85em;
            font-weight: 500;
        }

        /* ===== EVENT AREA ===== */
        #event-area {
            background: var(--bg-light);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #hq-review {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .hq-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .hq-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        .hq-title-area h2 {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            margin: 0;
        }
        .hq-subtitle {
            color: rgba(255,255,255,0.85);
            font-size: 0.85em;
            margin-top: 2px;
        }
        
        .hq-body {
            padding: 24px;
        }
        
        #review-narrative {
            color: var(--text-dark);
            font-size: 1em;
            line-height: 1.7;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-subtle);
            border-left: 4px solid var(--color-primary);
            border-radius: 0 10px 10px 0;
        }
        
        #review-tracking {
            font-weight: 600;
            margin-bottom: 20px;
            padding: 12px 16px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.95em;
        }
        .tracking-ontrack { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .tracking-ahead { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .tracking-behind { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .tracking-warning { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        
        #review-changes-visual {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .metric-change-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .metric-change-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .metric-change-card .metric-name {
            color: var(--text-light);
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .metric-change-card .metric-change-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .metric-change-card .metric-change-indicator {
            font-size: 1.3em;
        }
        .change-pos { color: var(--color-emerald); }
        .change-neg { color: var(--color-red); }
        .change-neu { color: var(--text-light); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; overflow-y: auto; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-white); border: 1px solid var(--border-light); border-radius: 20px; padding: 0; width: 100%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; margin: auto; color: var(--text-dark); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { text-align: center; color: var(--text-dark); margin-bottom: 20px; }
        .modal-content p { font-size: 1em; line-height: 1.6; margin-bottom: 15px; color: var(--text-medium); }
        .modal-content button.modal-close-btn { display: block; margin: 15px auto 0 auto; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s; }
        .modal-content button.modal-close-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(80, 70, 229, 0.4); }

        /* ===== INTRO MODAL - ENHANCED ===== */
        #intro-modal .modal-content {
            max-width: 900px;
            max-height: 90vh;
            background: var(--bg-white);
            color: var(--text-dark);
            padding: 0;
            overflow-y: auto;
        }
        
        .intro-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d7377 100%);
            padding: 30px 30px 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .intro-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        
        .intro-logo {
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
            display: flex;
            justify-content: center;
        }
        
        .intro-logo svg {
            filter: drop-shadow(0 4px 15px rgba(0,0,0,0.3));
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .intro-header h1 {
            font-size: 1.8em;
            margin: 0;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 1px;
        }
        
        .intro-header .subtitle {
            font-size: 0.9em;
            color: rgba(255,255,255,0.9);
            margin-top: 4px;
            font-weight: 400;
        }
        
        .intro-narrative { max-width: 650px; }
        
        /* ===== TITLE SCREEN - Light Corporate Style ===== */
        #title-modal .modal-content {
            max-width: 850px;
            max-height: 90vh;
            background: var(--bg-white);
            color: var(--text-dark);
            padding: 0;
            overflow-y: auto;
            border: none;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15);
        }
        
        .title-screen {
            text-align: center;
        }
        
        .title-hero {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d7377 100%);
            padding: 50px 40px 40px;
            position: relative;
            overflow: hidden;
        }
        
        .title-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 60%);
            pointer-events: none;
        }
        
        .title-logo {
            margin-bottom: 20px;
        }
        
        .title-logo svg {
            filter: drop-shadow(0 8px 25px rgba(0,0,0,0.3));
        }
        
        .title-main h1 {
            font-size: 2.2em;
            font-weight: 800;
            letter-spacing: 2px;
            margin: 0;
            color: white;
        }
        
        .title-main .tagline {
            font-size: 0.95em;
            color: rgba(255,255,255,0.85);
            margin-top: 6px;
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        
        .title-body {
            padding: 35px 45px 40px;
            background: var(--bg-white);
        }
        
        .title-premise {
            font-size: 1.15em;
            color: var(--text-medium);
            max-width: 600px;
            margin: 0 auto 30px;
            line-height: 1.7;
        }
        
        .title-pillars {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 35px;
            flex-wrap: wrap;
        }
        
        .title-pillar {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 22px 20px;
            width: 170px;
            transition: all 0.3s ease;
        }
        
        .title-pillar:hover {
            border-color: var(--color-primary-light);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(80, 70, 229, 0.1);
        }
        
        .title-pillar-icon {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .title-pillar h3 {
            font-size: 0.85em;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0 0 6px 0;
            letter-spacing: 1px;
        }
        
        .title-pillar p {
            font-size: 0.8em;
            color: var(--text-light);
            margin: 0;
            line-height: 1.4;
        }
        
        .title-start-btn {
            background: linear-gradient(135deg, #0d7377, #14919b);
            color: white;
            border: none;
            padding: 16px 55px;
            font-size: 1.15em;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(13, 115, 119, 0.3);
            letter-spacing: 1px;
        }
        
        .title-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(13, 115, 119, 0.4);
        }
        
        .title-button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .title-tutorial-btn {
            background: white;
            color: var(--text-dark);
            border: 2px solid var(--border-medium);
            padding: 14px 30px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .title-tutorial-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
            transform: translateY(-2px);
        }
        
        .title-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            font-size: 0.85em;
            color: var(--text-light);
            text-align: center;
        }
        
        .title-tagline {
            margin-bottom: 12px;
            font-style: italic;
        }
        
        .title-credits {
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .title-credits .credits-divider {
            margin: 0 8px;
            opacity: 0.5;
        }
        
        .title-license {
            font-size: 0.85em;
            opacity: 0.8;
        }
        
        .title-license a {
            color: #0d7377;
            text-decoration: none;
        }
        
        .title-license a:hover {
            text-decoration: underline;
        }
        
        .intro-body {
            padding: 25px 30px;
            background: var(--bg-white);
            color: var(--text-dark);
        }
        
        .intro-body p {
            color: var(--text-medium);
        }
        
        /* Narrative Scene Styling */
        .narrative-scene {
            margin-bottom: 20px;
        }
        
        .narrative-scene p {
            font-size: 1.05em;
            line-height: 1.7;
            margin-bottom: 12px;
            color: var(--text-dark);
        }
        
        .narrative-scene .scene-opener {
            font-size: 1.15em;
            font-style: italic;
            color: #0d7377;
            border-left: 3px solid #0d7377;
            padding-left: 15px;
            margin-bottom: 18px;
        }
        
        .narrative-scene strong {
            color: #1e3a5f;
        }
        
        /* Memo Styling */
        .narrative-memo {
            background: linear-gradient(135deg, #fefce8, #fef9c3);
            border: 1px solid #fde047;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .memo-header {
            background: linear-gradient(135deg, #fde047, #facc15);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .memo-icon { font-size: 1.1em; }
        
        .memo-title {
            font-weight: 700;
            font-size: 0.9em;
            color: #713f12;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .memo-body {
            padding: 15px 18px;
        }
        
        .memo-body p {
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 10px;
            color: #78350f;
        }
        
        .memo-body p:last-child { margin-bottom: 0; }
        
        .memo-signoff {
            margin-top: 5px;
            text-align: right;
            color: #92400e !important;
        }
        
        /* Billion Dollar Goal Callout */
        .billion-goal-callout {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 18px;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        
        .billion-goal-callout .goal-icon {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .billion-goal-callout .goal-content {
            flex: 1;
        }
        
        .billion-goal-callout .goal-title {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .billion-goal-callout .goal-desc {
            font-size: 0.95em;
            color: rgba(255,255,255,0.9);
            line-height: 1.5;
        }
        
        /* Stakes Section */
        .narrative-stakes {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .stake-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-subtle);
            border-radius: 10px;
            border-left: 3px solid var(--color-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .stake-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stake-icon {
            font-size: 1.4em;
            flex-shrink: 0;
        }
        
        .stake-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .stake-text strong {
            font-size: 0.95em;
            color: var(--text-dark);
        }
        
        .stake-text span {
            font-size: 0.85em;
            color: var(--text-medium);
        }
        
        /* Start Button */
        .start-btn {
            width: 100%;
            padding: 16px 30px;
            font-size: 1.1em;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #0d7377, #14919b);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(13, 115, 119, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 115, 119, 0.5);
        }
        
        .start-btn:active {
            transform: translateY(0);
        }
        
        .btn-arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        
        .start-btn:hover .btn-arrow {
            transform: translateX(5px);
        }
        
        /* Tutorial Modal - Smart Scale Game Style */
        #tutorial-modal .modal-content {
            max-width: 850px;
            padding: 0;
            max-height: 90vh;
            overflow-y: auto;
            background: var(--bg-white);
        }
        .tutorial-hub-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d7377 100%);
            text-align: center;
            padding: 25px 30px;
        }
        .tutorial-hub-header h2 {
            font-size: 1.6em;
            font-weight: 700;
            color: white;
            margin: 0 0 6px 0;
        }
        .tutorial-hub-header p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.95em;
            margin: 0;
        }
        .tutorial-hub-body {
            padding: 25px 30px;
        }
        .tutorial-topic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        @media (max-width: 600px) {
            .tutorial-topic-grid { grid-template-columns: 1fr; }
        }
        .tutorial-topic-card {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        .tutorial-topic-card:hover {
            border-color: #0d7377;
            box-shadow: 0 4px 12px rgba(13, 115, 119, 0.15);
            transform: translateY(-2px);
        }
        .tutorial-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .tutorial-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
            background: linear-gradient(135deg, #0d7377, #14919b);
            color: white;
        }
        .tutorial-card-title {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--text-dark);
        }
        .tutorial-card-desc {
            font-size: 0.85em;
            color: var(--text-medium);
            line-height: 1.4;
        }
        .tutorial-start-btn {
            display: block;
            width: 100%;
            max-width: 280px;
            margin: 20px auto 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #0d7377, #14919b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(13, 115, 119, 0.25);
        }
        .tutorial-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 115, 119, 0.35);
        }
        .tutorial-footnote {
            text-align: center;
            font-size: 0.8em;
            color: var(--text-light);
        }
        
        /* Topic Detail Modal */
        #tutorial-topic-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #tutorial-topic-modal.visible {
            display: flex;
        }
        .topic-modal-content {
            background: var(--bg-white);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        .topic-modal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d7377 100%);
            padding: 24px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }
        .topic-modal-icon {
            font-size: 2.2em;
            margin-bottom: 8px;
        }
        .topic-modal-title {
            font-size: 1.3em;
            font-weight: 700;
            color: white;
            margin: 0;
        }
        .topic-modal-subtitle {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.85);
            margin-top: 4px;
        }
        .topic-modal-body {
            padding: 24px;
        }
        .topic-modal-body p {
            font-size: 0.95em;
            line-height: 1.6;
            color: var(--text-medium);
            margin: 0 0 12px 0;
        }
        .topic-modal-body p:last-child {
            margin-bottom: 0;
        }
        .topic-modal-body strong {
            color: var(--text-dark);
        }
        .topic-back-btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: var(--bg-subtle);
            color: var(--text-dark);
            border: none;
            border-top: 1px solid var(--border-light);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 0 0 16px 16px;
        }
        .topic-back-btn:hover {
            background: var(--border-light);
        }
        
        /* Old intro elements removed - using narrative styling now */

        /* Venture & Strategy Modals */
        .venture-modal-content { max-width: 700px !important; padding: 24px !important; }
        .venture-intro { text-align: center; color: var(--text-medium); margin-bottom: 20px; font-size: 0.95em; }
        #venture-choices { display: flex; flex-direction: column; gap: 12px; }
        
        /* Compact Venture Cards */
        .venture-card-compact { display: flex; align-items: center; gap: 15px; background: var(--bg-subtle); border: 2px solid var(--border-light); border-radius: 12px; padding: 15px; transition: all 0.2s ease; cursor: pointer; }
        .venture-card-compact:hover { border-color: var(--color-primary); box-shadow: var(--shadow-lg); background: var(--bg-white); }
        .venture-icon-small { flex-shrink: 0; }
        .venture-icon-small svg { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .venture-card-info { flex: 1; min-width: 0; }
        .venture-card-info h3 { color: var(--text-dark); font-size: 1.05em; margin: 0 0 4px 0; }
        .venture-tagline { font-size: 0.85em; color: var(--text-medium); font-style: italic; margin: 0 0 8px 0; }
        .venture-stats-mini { display: flex; gap: 12px; flex-wrap: wrap; }
        .venture-stats-mini span { font-size: 0.75em; background: var(--bg-white); padding: 3px 8px; border-radius: 12px; color: var(--text-dark); font-weight: 500; border: 1px solid var(--border-light); }
        .venture-card-actions { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .btn-info { background: var(--bg-white); border: 2px solid var(--color-primary); color: var(--color-primary); padding: 10px 16px; border-radius: 8px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; font-weight: 600; box-shadow: var(--shadow-sm); }
        .btn-info:hover { background: var(--color-primary); color: white; box-shadow: var(--shadow); }
        .btn-select { background: linear-gradient(135deg, var(--color-emerald), var(--color-emerald-dark)); border: none; color: white; padding: 10px 16px; border-radius: 8px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; font-weight: 600; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
        .btn-select:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        
        /* Venture Info Modal */
        .venture-info-content { max-width: 600px !important; padding: 24px !important; }
        #venture-info-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border-light); }
        #venture-info-icon svg { width: 70px; height: 70px; }
        #venture-info-header h2 { margin: 0; color: var(--text-dark); }
        #venture-info-header .venture-tagline { margin: 5px 0 0 0; }
        .info-section { margin-bottom: 15px; }
        .info-section h4 { color: var(--text-dark); font-size: 0.95em; margin: 0 0 6px 0; }
        .info-section p { font-size: 0.9em; line-height: 1.5; margin: 0; color: var(--text-medium); background: var(--bg-subtle); padding: 10px; border-radius: 6px; }
        .info-stats-full { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .stat-box { background: var(--bg-subtle); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-val { display: block; font-size: 1.3em; font-weight: 700; color: var(--color-primary); }
        .stat-val.level-high { color: #16a34a; }
        .stat-val.level-medium { color: #ca8a04; }
        .stat-val.level-low { color: #dc2626; }
        .stat-lbl { display: block; font-size: 0.75em; color: var(--text-light); text-transform: uppercase; margin-top: 2px; }
        #venture-info-risk { text-align: center; padding: 10px; border-radius: 8px; background: var(--bg-subtle); font-weight: 600; margin-bottom: 20px; }
        .venture-info-actions { display: flex; gap: 12px; justify-content: space-between; }
        .btn-back { background: var(--bg-white); border: 2px solid var(--border-medium); color: var(--text-dark); padding: 12px 20px; border-radius: 10px; font-size: 0.95em; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .btn-back:hover { background: var(--bg-subtle); border-color: var(--text-medium); }
        .btn-select-big { background: linear-gradient(135deg, var(--color-emerald), var(--color-emerald-dark)); border: none; color: white; padding: 14px 28px; border-radius: 10px; font-size: 1em; cursor: pointer; transition: all 0.2s; font-weight: 700; flex: 1; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-select-big:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }

        #strategy-choices { display: flex; flex-direction: row; gap: 20px; justify-content: center; }
        
        /* Strategy cards - vertical card layout */
        .strategy-card { 
            display: flex; 
            flex-direction: column;
            background: var(--bg-white); 
            border: 2px solid var(--border-light); 
            border-radius: 16px; 
            padding: 0;
            cursor: pointer; 
            transition: all 0.3s ease; 
            width: 260px;
            overflow: hidden;
        }
        .strategy-card:hover { 
            border-color: #0d7377; 
            transform: translateY(-5px); 
            box-shadow: 0 12px 30px rgba(0,0,0,0.12); 
        }
        
        .strategy-header {
            padding: 20px 20px 15px;
            text-align: center;
        }
        .strategy-card.risk-low-card .strategy-header { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
        .strategy-card.risk-balanced-card .strategy-header { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .strategy-card.risk-high-card .strategy-header { background: linear-gradient(135deg, #fee2e2, #fecaca); }
        
        .strategy-icon { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.8em; 
            margin: 0 auto 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .strategy-header h3 { 
            margin: 0 0 6px 0; 
            font-size: 1.15em; 
            color: var(--text-dark); 
        }
        
        .risk-badge { 
            font-size: 0.75em; 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-weight: 600; 
            display: inline-block;
        }
        .risk-badge.badge-low { background: rgba(22, 101, 52, 0.15); color: #166534; }
        .risk-badge.badge-balanced { background: rgba(146, 64, 14, 0.15); color: #92400e; }
        .risk-badge.badge-high { background: rgba(153, 27, 27, 0.15); color: #991b1b; }
        
        .strategy-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .strategy-description { 
            font-size: 0.9em; 
            color: var(--text-medium); 
            margin: 0 0 15px 0; 
            line-height: 1.5;
            flex: 1;
        }
        
        .strategy-stats { 
            display: flex; 
            flex-direction: column;
            gap: 8px; 
            font-size: 0.85em; 
            margin-bottom: 18px;
        }
        .strategy-stat { 
            display: flex;
            justify-content: space-between;
            padding: 8px 12px; 
            border-radius: 8px; 
            background: var(--bg-light);
            border: 1px solid var(--border-light);
        }
        .strategy-stat .stat-label { color: var(--text-medium); }
        .strategy-stat .stat-value { color: var(--text-dark); font-weight: 600; }
        
        .strategy-actions { margin-top: auto; }
        .strategy-actions .btn-select { 
            width: 100%;
            padding: 14px 24px; 
            background: linear-gradient(135deg, #0d7377, #14919b); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 0.95em; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 4px 12px rgba(13, 115, 119, 0.3); 
        }
        .strategy-actions .btn-select:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 18px rgba(13, 115, 119, 0.4); 
        }
        
        @media (max-width: 850px) { 
            #strategy-choices { flex-direction: column; align-items: center; }
            .strategy-card { width: 100%; max-width: 350px; }
        }
        
        .venture-card, .setup-option { background: var(--bg-subtle); border: 2px solid var(--border-light); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s ease; }
        .venture-card:hover, .setup-option:hover:not(.selected) { border-color: var(--color-primary); transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .setup-option.selected { border-color: var(--color-emerald); background-color: #d1fae5; cursor: default; }
        
        .setup-option h4 { color: var(--text-dark); margin-bottom: 8px; font-size: 1.05em; }
        .setup-option p { font-size: 0.85em; margin-bottom: 8px; line-height: 1.4; color: var(--text-medium); }

        /* Setup Modal */
        .setup-modal-content { max-width: 800px !important; padding: 24px !important; }
        .setup-intro { text-align: center; color: var(--text-medium); margin-bottom: 20px; }
        
        #setup-budget-tracker { background: var(--bg-subtle); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .investment-summary { display: flex; justify-content: space-around; gap: 20px; }
        .investment-total, .investment-burn { text-align: center; padding: 10px 20px; background: white; border-radius: 8px; flex: 1; }
        .inv-label { display: block; font-size: 0.75em; color: var(--text-medium); text-transform: uppercase; margin-bottom: 4px; }
        .inv-amount { display: block; font-size: 1.5em; font-weight: 700; color: var(--color-primary); }
        .inv-amount.burn-rate { color: var(--color-orange); }
        
        .investment-grid { display: flex; flex-direction: column; gap: 12px; }
        .investment-dept { background: white; border: 2px solid var(--border-light); border-radius: 12px; padding: 16px; transition: all 0.2s; }
        .investment-dept:hover { border-color: var(--color-primary-light); }
        .dept-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .dept-icon { font-size: 1.6em; }
        .dept-info h3 { margin: 0; font-size: 1em; color: var(--text-dark); }
        .dept-info p { margin: 2px 0 0 0; font-size: 0.8em; color: var(--text-medium); }
        
        .investment-tiers { display: flex; gap: 6px; flex-wrap: wrap; }
        .tier-btn { flex: 1; min-width: 70px; padding: 8px 4px; border: 2px solid var(--border-light); border-radius: 8px; background: var(--bg-subtle); cursor: pointer; transition: all 0.2s; text-align: center; }
        .tier-btn:hover { border-color: var(--color-primary-light); background: white; }
        .tier-btn.active { border-color: var(--color-primary); background: linear-gradient(135deg, #ede9fe, #ddd6fe); }
        .tier-name { display: block; font-size: 0.7em; font-weight: 700; color: var(--text-dark); text-transform: uppercase; margin-bottom: 2px; }
        .tier-signal { display: block; font-size: 1em; font-weight: 600; margin-bottom: 2px; }
        .tier-cost { display: block; font-size: 0.65em; font-weight: 500; color: var(--text-light); }
        
        /* Signal colors based on tier */
        .tier-btn[data-tier="lean"] .tier-signal { color: var(--color-red); }
        .tier-btn[data-tier="reduced"] .tier-signal { color: var(--color-orange); }
        .tier-btn[data-tier="standard"] .tier-signal { color: var(--text-medium); }
        .tier-btn[data-tier="enhanced"] .tier-signal { color: var(--color-emerald); }
        .tier-btn[data-tier="priority"] .tier-signal { color: var(--color-emerald-dark); }
        .tier-btn[data-tier="lean"] .tier-cost, .tier-btn[data-tier="reduced"] .tier-cost { color: var(--color-emerald); }
        .tier-btn[data-tier="enhanced"] .tier-cost, .tier-btn[data-tier="priority"] .tier-cost { color: var(--color-red); }
        
        .investment-tip { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #fcd34d; border-radius: 8px; padding: 12px 16px; margin-top: 20px; font-size: 0.85em; color: #92400e; }
        
        /* Reallocation Modal */
        .realloc-performance-snapshot { background: var(--bg-subtle); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        .realloc-performance-snapshot h4 { margin: 0 0 12px 0; font-size: 0.95em; color: var(--text-dark); }
        .realloc-metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
        @media (max-width: 700px) { .realloc-metrics-grid { grid-template-columns: repeat(2, 1fr); } }
        .realloc-metric { background: white; border-radius: 8px; padding: 10px; text-align: center; border-left: 3px solid var(--border-light); }
        .realloc-metric.status-good { border-left-color: var(--color-emerald); }
        .realloc-metric.status-warning { border-left-color: var(--color-orange); }
        .realloc-metric.status-critical { border-left-color: var(--color-red); }
        .realloc-metric-icon { font-size: 1.1em; margin-bottom: 2px; }
        .realloc-metric-value { font-size: 1.1em; font-weight: 700; color: var(--text-dark); }
        .realloc-metric-label { font-size: 0.7em; color: var(--text-medium); text-transform: uppercase; letter-spacing: 0.5px; }
        .realloc-implications { background: white; border-radius: 8px; padding: 12px; border: 1px solid var(--border-light); }
        .realloc-implications-title { font-weight: 600; font-size: 0.85em; color: var(--text-dark); margin-bottom: 8px; }
        .realloc-implication { display: flex; align-items: flex-start; gap: 8px; font-size: 0.85em; color: var(--text-medium); margin-bottom: 6px; line-height: 1.4; }
        .realloc-implication:last-child { margin-bottom: 0; }
        .realloc-implication-icon { flex-shrink: 0; }
        .reallocation-summary { margin-bottom: 20px; }
        .reallocation-summary .investment-summary { background: var(--bg-subtle); border-radius: 10px; padding: 15px; }
        .reallocation-current h4 { margin: 0 0 15px 0; color: var(--text-dark); font-size: 1em; }
        .reallocation-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .reallocation-dept { background: white; border: 2px solid var(--border-light); border-radius: 10px; padding: 12px; text-align: center; }
        .reallocation-dept-icon { font-size: 1.5em; margin-bottom: 6px; }
        .reallocation-dept-name { font-weight: 600; font-size: 0.85em; color: var(--text-dark); margin-bottom: 8px; }
        .reallocation-tier-select { display: flex; flex-direction: column; gap: 4px; }
        .realloc-tier-btn { padding: 4px 6px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 0.65em; cursor: pointer; transition: all 0.2s; background: var(--bg-subtle); }
        .realloc-tier-btn:hover { border-color: var(--color-primary-light); }
        .realloc-tier-btn.active { border-color: var(--color-primary); background: linear-gradient(135deg, #ede9fe, #ddd6fe); font-weight: 600; }
        .reallocation-actions { margin-top: 20px; text-align: center; }
        @media (max-width: 900px) { .reallocation-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .btn-confirm-setup { display: block; width: 100%; padding: 16px; margin-top: 20px; font-size: 1.1em; font-weight: 700; background: linear-gradient(135deg, var(--color-emerald), var(--color-emerald-dark)); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-confirm-setup:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }

        /* Investment indicator in dashboard */
        .investment-indicator { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--bg-subtle); border-radius: 6px; font-size: 0.75em; }
        .investment-indicator .inv-dot { width: 8px; height: 8px; border-radius: 50%; }
        .investment-indicator .inv-dot.minimal { background: var(--color-red); }
        .investment-indicator .inv-dot.basic { background: var(--color-orange); }
        .investment-indicator .inv-dot.standard { background: var(--text-medium); }
        .investment-indicator .inv-dot.enhanced { background: var(--color-emerald); }
        .investment-indicator .inv-dot.premium { background: var(--color-emerald-dark); }

        @media (max-width: 600px) {
            .investment-tiers { flex-direction: column; }
            .tier-btn { min-width: auto; }
            .investment-summary { flex-direction: column; }
        }

        /* Setup Modal Old - Remove */
        #setup-modal .modal-content { max-width: 800px; }

        /* Hiring Modal */
        #hiring-modal .modal-content { max-width: 950px; max-height: 90vh; overflow-y: auto; }
        #hiring-role-title { text-align: center; color: var(--text-dark); margin-bottom: 8px; font-size: 1.3em; }
        .hiring-intro { text-align: center; color: var(--text-medium); margin-bottom: 25px; font-size: 0.9em; }
        #candidate-options { display: flex; flex-direction: row; gap: 20px; justify-content: center; flex-wrap: wrap; }
        
        /* Candidate card - vertical card layout */
        .candidate-card { 
            display: flex; 
            flex-direction: column;
            background: var(--bg-white); 
            border: 2px solid var(--border-light); 
            border-radius: 16px; 
            padding: 0;
            cursor: pointer; 
            transition: all 0.3s ease; 
            width: 280px;
            overflow: hidden;
        }
        .candidate-card:hover { 
            border-color: #0d7377; 
            transform: translateY(-5px); 
            box-shadow: 0 12px 30px rgba(0,0,0,0.12); 
        }
        .candidate-card.candidate-internal { border-top: 4px solid var(--color-emerald); }
        .candidate-card.candidate-external { border-top: 4px solid #3b82f6; }
        
        .candidate-header {
            padding: 25px 20px 20px;
            text-align: center;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border-light);
        }
        
        .candidate-avatar { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            margin: 0 auto 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: white;
        }
        .candidate-avatar svg { width: 100%; height: 100%; display: block; }
        
        .candidate-header h3 { 
            margin: 0 0 4px 0; 
            font-size: 1.1em; 
            color: var(--text-dark); 
        }
        
        .candidate-title {
            font-size: 0.85em;
            color: var(--text-medium);
            margin: 0 0 10px 0;
        }
        
        .candidate-badge { 
            font-size: 0.75em; 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-weight: 600; 
            display: inline-block;
        }
        .badge-internal { background: #dcfce7; color: #166534; }
        .badge-external { background: #dbeafe; color: #1e40af; }
        
        .candidate-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .candidate-traits {
            margin-bottom: 15px;
        }
        
        .candidate-trait {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.85em;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .trait-icon {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }
        
        .trait-positive { color: #166534; }
        .trait-negative { color: #b45309; }
        
        .candidate-stats { 
            display: flex; 
            flex-direction: column;
            gap: 6px; 
            font-size: 0.8em; 
            margin-bottom: 18px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }
        .candidate-stat { 
            display: flex;
            justify-content: space-between;
            padding: 6px 10px; 
            border-radius: 6px; 
            background: var(--bg-light);
        }
        .candidate-stat .stat-label { color: var(--text-medium); }
        .candidate-stat .stat-value { font-weight: 600; }
        .stat-value.ready { color: #166534; }
        .stat-value.cost { color: #dc2626; }
        .stat-value.time { color: #b45309; }
        
        .candidate-actions { 
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .candidate-actions .btn-select { 
            width: 100%;
            padding: 12px 20px; 
            background: linear-gradient(135deg, #0d7377, #14919b); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 0.95em; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 4px 12px rgba(13, 115, 119, 0.3); 
        }
        .candidate-actions .btn-select:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 18px rgba(13, 115, 119, 0.4); 
        }
        .candidate-actions .btn-info { 
            width: 100%;
            padding: 10px 16px; 
            background: white; 
            border: 1px solid var(--border-medium); 
            border-radius: 8px; 
            font-size: 0.85em; 
            color: var(--text-medium); 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .candidate-actions .btn-info:hover { 
            border-color: #0d7377; 
            color: #0d7377;
            background: #f0fdfa;
        }
        
        @media (max-width: 900px) { 
            #candidate-options { flex-direction: column; align-items: center; }
            .candidate-card { width: 100%; max-width: 350px; }
        }
        
        /* Full CV Modal */
        .cv-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .cv-modal-overlay.visible { opacity: 1; visibility: visible; }
        .cv-modal { background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        
        .cv-modal-header { background: linear-gradient(135deg, #0d7377, #14919b); padding: 25px; display: flex; align-items: center; gap: 20px; position: sticky; top: 0; }
        .cv-modal-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden; flex-shrink: 0; background: white; }
        .cv-modal-avatar svg { width: 100%; height: 100%; display: block; }
        .cv-modal-name { color: white; }
        .cv-modal-name h2 { margin: 0 0 5px 0; font-size: 1.5em; }
        .cv-modal-name p { margin: 0; opacity: 0.9; font-size: 1em; }
        .cv-modal-badge { display: inline-block; margin-top: 8px; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; }
        .cv-modal-badge.internal { background: rgba(255,255,255,0.25); color: white; }
        .cv-modal-badge.external { background: rgba(255,255,255,0.25); color: white; }
        
        .cv-modal-body { padding: 25px; }
        
        .cv-summary { font-size: 1em; line-height: 1.6; color: var(--color-dark-grey); margin-bottom: 25px; padding: 15px; background: var(--color-light-grey); border-radius: 10px; border-left: 4px solid var(--color-brand-blue); }
        
        .cv-section { margin-bottom: 25px; }
        .cv-section-title { font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; color: var(--color-brand-blue); margin-bottom: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .cv-section-title::after { content: ''; flex: 1; height: 1px; background: var(--color-grey); }
        
        .cv-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .cv-info-item { background: var(--color-light-grey); padding: 12px; border-radius: 8px; }
        .cv-info-label { font-size: 0.75em; color: var(--color-dark-grey); text-transform: uppercase; margin-bottom: 4px; }
        .cv-info-value { font-weight: 600; color: var(--color-dark-blue); }
        
        .cv-history-item { padding: 15px; background: var(--color-light-grey); border-radius: 10px; margin-bottom: 10px; position: relative; }
        .cv-history-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--color-brand-blue); border-radius: 4px 0 0 4px; }
        .cv-history-role { font-weight: 600; color: var(--color-dark-blue); margin-bottom: 4px; }
        .cv-history-company { color: var(--color-brand-blue); font-size: 0.9em; }
        .cv-history-period { font-size: 0.8em; color: var(--color-dark-grey); margin-bottom: 8px; }
        .cv-history-details { font-size: 0.85em; color: var(--color-dark-grey); line-height: 1.5; }
        
        .cv-skills-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .cv-skill-tag { background: linear-gradient(135deg, #667eea22, #764ba222); border: 1px solid var(--color-brand-blue); padding: 6px 14px; border-radius: 20px; font-size: 0.85em; color: var(--color-dark-blue); }
        
        .cv-achievements { list-style: none; padding: 0; margin: 0; }
        .cv-achievements li { padding: 10px 10px 10px 35px; background: var(--color-light-grey); border-radius: 8px; margin-bottom: 8px; position: relative; font-size: 0.9em; }
        .cv-achievements li::before { content: '🏆'; position: absolute; left: 10px; }
        
        .cv-modal-effects { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .cv-effect-box { padding: 12px; border-radius: 8px; text-align: center; }
        .cv-effect-box.positive { background: #e8f5e9; border: 1px solid #a5d6a7; }
        .cv-effect-box.negative { background: #ffebee; border: 1px solid #ef9a9a; }
        .cv-effect-label { font-size: 0.75em; text-transform: uppercase; margin-bottom: 4px; }
        .cv-effect-box.positive .cv-effect-label { color: #2e7d32; }
        .cv-effect-box.negative .cv-effect-label { color: #c62828; }
        .cv-effect-value { font-weight: 700; font-size: 1.1em; }
        .cv-effect-box.positive .cv-effect-value { color: var(--color-green); }
        .cv-effect-box.negative .cv-effect-value { color: var(--color-red); }
        
        .cv-modal-actions { display: flex; gap: 10px; padding: 20px 25px; border-top: 1px solid var(--color-grey); background: #fafafa; }
        .cv-modal-actions button { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-cv-back { background: var(--bg-subtle); color: var(--text-dark); border: 2px solid var(--border-medium) !important; }
        .btn-cv-back:hover { background: var(--border-light); }
        .btn-cv-hire { background: linear-gradient(135deg, var(--color-emerald), var(--color-emerald-dark)); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-cv-hire:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        
        .btn-view-cv { background: var(--bg-white); border: 2px solid var(--color-primary); color: var(--color-primary); padding: 10px 14px; border-radius: 8px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; width: 100%; font-weight: 600; }
        .btn-view-cv:hover { background: var(--color-primary); color: white; }

        /* Event Card Modal - Enhanced */
        #event-modal .modal-content { 
            max-width: 650px; 
            width: 95%;
            text-align: left; 
            padding: 0; 
            overflow: hidden; 
            max-height: 85vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* Header - fixed at top, compact */
        #event-modal .email-view-header {
            flex: 0 0 auto;
            padding: 10px 15px;
        }
        
        /* Body - scrollable, takes available space */
        #event-modal .email-view-body {
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 100px;
            max-height: 35vh;
            padding: 12px 15px;
        }
        
        /* Reply section - fixed at bottom, limited height */
        #event-modal .email-reply-section {
            flex: 0 0 auto;
            max-height: 40vh;
            overflow-y: auto;
            padding: 10px 15px;
        }
        
        .event-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px 25px;
            color: white;
            flex-shrink: 0;
        }
        .event-announcer-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .event-announcer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            overflow: hidden;
            background: rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        .event-announcer-avatar svg { width: 100%; height: 100%; }
        .event-announcer-info { flex: 1; }
        .event-announcer-name { font-size: 1.1em; font-weight: 600; margin-bottom: 2px; }
        .event-announcer-title { font-size: 0.85em; opacity: 0.9; }
        .event-dept-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .event-badges {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }
        
        #event-title { font-size: 1.3em; margin: 0; display: flex; align-items: center; gap: 10px; }
        
        .event-body { padding: 20px 25px; overflow-y: auto; flex: 1; }
        #event-text { 
            font-size: 1em; 
            line-height: 1.6; 
            margin-bottom: 20px; 
            padding: 15px;
            background: var(--color-light-grey);
            border-radius: 10px;
            border-left: 4px solid var(--color-brand-blue);
        }
        
        /* Department Head Recommendation - Single Card */
        .dept-recommendation {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--color-brand-blue);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .dept-rec-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .dept-rec-avatar-large {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--color-brand-blue);
            flex-shrink: 0;
        }
        .dept-rec-avatar-large svg { width: 100%; height: 100%; }
        .dept-rec-info { flex: 1; }
        .dept-rec-name { font-weight: 600; color: var(--color-dark-blue); font-size: 0.95em; }
        .dept-rec-title { font-size: 0.8em; color: var(--color-dark-grey); }
        .dept-rec-stance-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
        }
        /* All stances now use neutral styling - no "correct answer" signals */
        .dept-rec-stance-badge.supports, .dept-rec-stance-badge.opposes, .dept-rec-stance-badge.neutral { 
            background: #e3f2fd; color: #1565c0; 
        }
        
        .dept-rec-message {
            background: var(--color-light-grey);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 0.9em;
            line-height: 1.5;
            color: var(--color-dark-blue);
            position: relative;
        }
        .dept-rec-message::before {
            content: '"';
            font-size: 2em;
            color: var(--color-brand-blue);
            opacity: 0.3;
            position: absolute;
            top: 5px;
            left: 10px;
        }
        .dept-rec-message p {
            margin: 0;
            padding-left: 20px;
        }
        
        /* Options Section */
        .options-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--color-dark-grey);
            margin-bottom: 8px;
            font-weight: 600;
        }
        .impact-legend {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.65em;
            color: #666;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        .legend-dot.dept-ops { background: #e3f2fd; border: 2px solid #3498db; }
        .legend-dot.dept-hr { background: #f3e5f5; border: 2px solid #9c27b0; }
        .legend-dot.dept-tech { background: #e0f7fa; border: 2px solid #00838f; }
        .legend-dot.dept-mkt { background: #e8f5e9; border: 2px solid #43a047; }
        .legend-dot.dept-fin { background: #fff3e0; border: 2px solid #ef6c00; }
        
        #event-options { display: flex; flex-direction: column; gap: 8px; }
        
        .event-option { 
            display: flex;
            flex-direction: column;
            width: 100%; 
            padding: 0;
            font-size: 0.95em; 
            font-weight: 500; 
            border: 2px solid var(--border-medium); 
            background: var(--bg-white); 
            color: var(--text-dark); 
            border-radius: 12px; 
            cursor: pointer; 
            text-align: left; 
            transition: all 0.2s ease;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .event-option:hover { border-color: var(--color-primary); box-shadow: var(--shadow); transform: translateY(-2px); }
        .event-option.delay { border-color: var(--color-amber); background: #fffbeb; }
        .event-option.delay:hover { background: #fef3c7; border-color: #d97706; }
        /* Options are equal - no visual "best choice" indication */
        .event-option:nth-child(1) { border-left: 4px solid #3498db; }
        .event-option:nth-child(2) { border-left: 4px solid #9b59b6; }
        .event-option:nth-child(3) { border-left: 4px solid #e67e22; }
        .event-option:disabled { background: var(--bg-subtle); border-color: var(--border-light); opacity: 0.5; cursor: not-allowed; transform: none; }
        .event-option:disabled:hover { box-shadow: none; transform: none; }
        
        .option-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-subtle);
        }
        /* Options have subtle color coding but no "correct" answer signal */
        .option-text { flex: 1; font-weight: 600; color: var(--text-dark); }
        .option-cost { 
            font-weight: 700; 
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .option-cost.cost-neg { background: #ffebee; color: var(--color-red); }
        .option-cost.cost-pos { background: #e8f5e9; color: var(--color-green); }
        
        /* Impact Indicators */
        /* Departmental Impact Grid - each metric uses its department color */
        .option-impact-grid {
            padding: 5px 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            border-top: 1px solid var(--color-light-grey);
            background: #fafafa;
        }
        .impact-box {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 0.65em;
            font-weight: 500;
            border-left: 2px solid var(--dept-color, #888);
            background: var(--dept-bg, #f5f5f5);
        }
        .impact-box-icon { font-size: 0.8em; }
        .impact-box-label { color: #444; }
        .impact-box-value { font-weight: 700; color: #333; }
        .impact-box-arrow { font-weight: 700; font-size: 0.8em; margin-left: 1px; color: #555; }
        
        /* Department-specific colors - same whether up or down */
        .impact-box.dept-ops { --dept-color: #3498db; --dept-bg: #e3f2fd; }
        .impact-box.dept-hr { --dept-color: #9c27b0; --dept-bg: #f3e5f5; }
        .impact-box.dept-tech { --dept-color: #00838f; --dept-bg: #e0f7fa; }
        .impact-box.dept-mkt { --dept-color: #43a047; --dept-bg: #e8f5e9; }
        .impact-box.dept-fin { --dept-color: #ef6c00; --dept-bg: #fff3e0; }
        .impact-box.dept-all { --dept-color: #5e35b1; --dept-bg: #ede7f6; }
        
        /* Cash costs - distinct styling */
        .impact-box.cash { --dept-color: #f44336; --dept-bg: #ffebee; }
        
        /* Reply option impact grid (email view) */
        .reply-option .option-impact-grid {
            padding: 4px 8px;
            background: #fafafa;
        }
        .impact-box.cash { 
            --dept-color: #6d4c41;
            --dept-bg: #efebe9;
        }
        .impact-box.cash .impact-box-value { color: #5d4037; font-weight: 700; }
        
        /* Risk indicator */
        .impact-box.risk { 
            --dept-color: #ffa000;
            --dept-bg: #fff8e1;
        }
        
        /* Neutral */
        .impact-box.neutral { 
            --dept-color: #78909c;
            --dept-bg: #eceff1;
        }
        
        /* Hasty Decision Warning Toast */
        .hasty-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(255, 152, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            text-align: center;
            max-width: 90%;
        }
        .hasty-toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .hasty-toast .toast-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }
        .hasty-toast .toast-sub {
            display: block;
            font-size: 0.8em;
            font-weight: 400;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        
        @media (max-width: 600px) {
            .event-announcer-row { flex-wrap: wrap; gap: 10px; }
            .event-dept-badge { order: -1; width: 100%; text-align: center; }
            .dept-rec-header { flex-wrap: wrap; }
            .option-impact-grid { gap: 4px; padding: 8px 12px; }
            .impact-box { padding: 4px 8px; font-size: 0.7em; }
            
            /* Email inbox mobile styles */
            .email-item { padding: 12px 15px; }
            .email-avatar { width: 40px; height: 40px; }
            .email-sender { font-size: 0.9em; }
            .email-subject { font-size: 0.85em; }
            .email-preview { font-size: 0.75em; }
            .email-view-header { padding: 10px 12px; }
            .email-view-meta { flex-wrap: wrap; gap: 8px; }
            .email-view-avatar { width: 32px; height: 32px; }
            .email-view-subject { font-size: 0.85em; }
            .email-view-body { padding: 10px 12px; font-size: 0.95em; line-height: 1.5; }
            .email-reply-section { padding: 8px 10px; }
            .reply-option { padding: 12px; margin-bottom: 8px; }
            .reply-option-text { font-size: 0.9em; padding: 8px 10px; line-height: 1.4; }
            .reply-advisor-box { padding: 8px; font-size: 0.85em; }
            
            /* Ensure modal is scrollable on mobile */
            #event-modal .modal-content {
                max-height: 95vh;
                margin: 10px;
                border-radius: 16px;
            }
            
            /* Make impact chips wrap better on mobile */
            .option-impact-grid {
                flex-wrap: wrap;
                justify-content: flex-start;
            }
        }

        /* Game Over Modal - Learning-Focused Design */
        #game-over-modal .modal-content { 
            max-width: 900px; 
            text-align: left; 
            padding: 0;
            max-height: 90vh;
            overflow-y: auto;
        }
        .game-over-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        /* === TIER STYLING === */
        /* Tier 5: Billion Dollar Legend */
        .game-over-header.tier-legend {
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706, #b45309);
            animation: legend-shimmer 3s ease-in-out infinite;
        }
        @keyframes legend-shimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.15); }
        }
        .game-over-header.tier-legend::before {
            content: '✨';
            position: absolute;
            font-size: 4em;
            opacity: 0.2;
            top: 10px;
            left: 20px;
            animation: sparkle 2s ease-in-out infinite;
        }
        .game-over-header.tier-legend::after {
            content: '💎';
            position: absolute;
            font-size: 4em;
            opacity: 0.2;
            top: 10px;
            right: 20px;
            animation: sparkle 2s ease-in-out infinite 0.5s;
        }
        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.2; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 0.4; }
        }
        
        /* Tier 4: Corporate Champion */
        .game-over-header.tier-champion {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9);
            animation: champion-pulse 4s ease-in-out infinite;
        }
        @keyframes champion-pulse {
            0%, 100% { box-shadow: inset 0 0 30px rgba(255,255,255,0.1); }
            50% { box-shadow: inset 0 0 50px rgba(255,255,255,0.2); }
        }
        .game-over-header.tier-champion::before {
            content: '🏆';
            position: absolute;
            font-size: 3em;
            opacity: 0.25;
            top: 15px;
            right: 25px;
        }
        
        /* Tier 3: Rising Star */
        .game-over-header.tier-star {
            background: linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8);
        }
        .game-over-header.tier-star::before {
            content: '⭐';
            position: absolute;
            font-size: 2.5em;
            opacity: 0.2;
            top: 15px;
            right: 25px;
        }
        
        /* Tier 2: Solid Performer */
        .game-over-header.tier-solid {
            background: linear-gradient(135deg, #10b981, #059669, #047857);
        }
        
        /* Tier 1: Learning Journey */
        .game-over-header.tier-learning {
            background: linear-gradient(135deg, #64748b, #475569, #334155);
        }
        
        /* Career Outcome Badge */
        .career-outcome {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 25px;
            padding: 8px 20px;
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }
        .career-outcome .outcome-icon {
            margin-right: 8px;
        }
        
        /* Next Tier Teaser */
        .next-tier-teaser {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 15px 20px;
            margin: 20px 0;
            text-align: center;
        }
        .next-tier-teaser h4 {
            color: #92400e;
            margin: 0 0 8px 0;
            font-size: 1em;
        }
        .next-tier-teaser p {
            color: #78350f;
            margin: 0;
            font-size: 0.9em;
        }
        .next-tier-teaser .tier-icon {
            font-size: 1.5em;
            margin-right: 8px;
        }
        
        /* Celebration Confetti */
        .confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(300px) rotate(720deg); opacity: 0; }
        }
        
        #game-over-title { 
            font-size: 1.8em; 
            color: white; 
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        #game-over-subtitle {
            font-size: 1em;
            opacity: 0.9;
        }
        #game-over-reason { 
            font-size: 1em; 
            font-weight: 500; 
            color: #fecaca; 
            margin-top: 10px;
        }
        .game-over-body {
            padding: 25px 30px;
        }
        
        /* Opening Message */
        .reflection-message {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-left: 4px solid var(--color-primary);
            padding: 20px;
            border-radius: 0 12px 12px 0;
            margin-bottom: 25px;
        }
        .reflection-message.tier-legend-message {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
        }
        .reflection-message p {
            font-size: 1em;
            line-height: 1.6;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .reflection-message p:last-child {
            margin-bottom: 0;
        }
        
        /* Two-column layout for strengths/growth */
        .feedback-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        .feedback-section {
            background: var(--bg-subtle);
            border-radius: 12px;
            padding: 20px;
        }
        .feedback-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.05em;
            color: var(--text-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-light);
        }
        .feedback-section.strengths { border-left: 4px solid var(--color-emerald); }
        .feedback-section.growth { border-left: 4px solid var(--color-amber); }
        .feedback-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .feedback-section li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.9em;
            line-height: 1.4;
            color: var(--text-medium);
        }
        .feedback-section li .feedback-icon {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }
        .feedback-section.strengths li .feedback-icon { color: var(--color-emerald); }
        .feedback-section.growth li .feedback-icon { color: var(--color-amber); }
        
        /* Key Learnings */
        .learnings-section {
            background: #fefce8;
            border: 1px solid #fef08a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .learnings-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.05em;
            color: var(--text-dark);
            margin-bottom: 15px;
        }
        .learning-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .learning-item:last-child { margin-bottom: 0; }
        .learning-item .learning-icon {
            font-size: 1.3em;
            flex-shrink: 0;
        }
        .learning-item .learning-text {
            font-size: 0.9em;
            line-height: 1.5;
            color: var(--text-medium);
        }
        .learning-item .learning-text strong {
            color: var(--text-dark);
        }
        
        /* Performance Summary (compact) */
        .performance-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        .perf-stat {
            background: var(--bg-subtle);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        .perf-stat .stat-icon { font-size: 1.3em; margin-bottom: 5px; }
        .perf-stat .stat-value { font-size: 1.1em; font-weight: 700; color: var(--text-dark); }
        .perf-stat .stat-label { font-size: 0.75em; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .perf-stat.positive .stat-value { color: var(--color-emerald); }
        .perf-stat.negative .stat-value { color: var(--color-red); }
        
        /* Try Again Section */
        .try-again-section {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        .try-again-section h3 {
            font-size: 1.2em;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .try-again-section p {
            font-size: 0.95em;
            color: var(--text-medium);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .strategy-suggestions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .strategy-tag {
            background: white;
            border: 1px solid var(--border-medium);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            color: var(--text-medium);
        }
        #exit-buttons { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
        }
        #exit-buttons button { 
            background: linear-gradient(135deg, var(--color-emerald), var(--color-emerald-dark)); 
            color: white; 
            border: none; 
            padding: 14px 32px; 
            font-size: 1.05em; 
            font-weight: 600; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); 
        } 
        #exit-buttons button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); 
        }
        
        @media (max-width: 768px) {
            .feedback-columns { grid-template-columns: 1fr; }
            .performance-summary { grid-template-columns: repeat(2, 1fr); }
        }
        
        .game-over-credits {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            font-size: 0.8em;
            color: var(--text-light);
            text-align: center;
            line-height: 1.8;
        }
        
        .game-over-credits a {
            color: #0d7377;
            text-decoration: none;
        }
        
        .game-over-credits a:hover {
            text-decoration: underline;
        }
        
        #global-shock-bar { position: fixed; top: 0; left: 0; width: 100%; background: var(--color-red); color: white; padding: 15px; text-align: center; font-weight: 700; font-size: 1.3em; z-index: 2000; transform: translateY(-100%); transition: transform 0.5s ease-in-out; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #global-shock-bar.visible { transform: translateY(0); }

        /* Transition Report Modal */
        #transition-report-modal .modal-content {
            max-width: 600px;
            padding: 0;
            max-height: 85vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .report-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            padding: 20px 24px;
            text-align: center;
            flex-shrink: 0;
        }
        .report-header h2 {
            margin: 0 0 4px 0;
            font-size: 1.3em;
            color: white;
        }
        .report-header .report-subtitle {
            opacity: 0.9;
            font-size: 0.9em;
        }
        .report-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }
        .report-changes-section {
            margin-bottom: 14px;
        }
        .report-changes-section h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .report-changes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        .report-change-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-subtle);
            border-radius: 6px;
            font-size: 0.85em;
        }
        .report-change-item .change-label {
            color: var(--text-medium);
        }
        .report-change-item .change-value {
            font-weight: 600;
        }
        .report-change-item .change-value.positive { color: var(--color-emerald); }
        .report-change-item .change-value.negative { color: var(--color-red); }
        .report-change-item .change-value.neutral { color: var(--text-light); }
        
        .report-financials {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }
        .report-financial-item {
            flex: 1;
            padding: 10px;
            background: var(--bg-subtle);
            border-radius: 8px;
            text-align: center;
        }
        .report-financial-item .fin-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 2px;
        }
        .report-financial-item .fin-value {
            font-size: 1.05em;
            font-weight: 700;
        }
        .report-financial-item .fin-value.positive { color: var(--color-emerald); }
        .report-financial-item .fin-value.negative { color: var(--color-red); }
        
        .report-progress-section {
            margin-bottom: 12px;
        }
        .report-progress-section h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 6px;
        }
        .report-progress-bar {
            height: 8px;
            background: var(--bg-subtle);
            border-radius: 4px;
            overflow: hidden;
        }
        .report-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-emerald));
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .report-progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        /* Quarterly Report Specific Styles */
        .quarterly-report .report-header {
            background: linear-gradient(135deg, #0d7377, #14919b);
        }
        .director-message {
            background: #f0f9fa;
            border-left: 4px solid #0d7377;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 0 8px 8px 0;
        }
        .director-message .director-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .director-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0d7377, #14919b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }
        .director-info .director-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9em;
        }
        .director-info .director-title {
            font-size: 0.75em;
            color: var(--text-light);
        }
        .director-message .message-text {
            font-size: 0.85em;
            line-height: 1.5;
            color: var(--text-medium);
            font-style: italic;
        }
        .director-message .message-text p {
            margin-bottom: 6px;
        }
        .director-message .message-text p:last-child {
            margin-bottom: 0;
        }
        
        .quarterly-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-subtle);
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .quarterly-rating .rating-label {
            font-size: 0.85em;
            color: var(--text-medium);
        }
        .quarterly-rating .rating-stars {
            font-size: 1.2em;
            letter-spacing: 2px;
        }
        .quarterly-rating .rating-text {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9em;
        }
        
        .report-continue-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        .report-continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(80, 70, 229, 0.4);
        }
        .quarterly-report .report-continue-btn {
            background: linear-gradient(135deg, #0d7377, #14919b);
        }
        .quarterly-report .report-continue-btn:hover {
            box-shadow: 0 6px 20px rgba(13, 115, 119, 0.4);
        }
        
        @media (max-width: 500px) {
            .report-changes-grid { grid-template-columns: 1fr; }
            .report-financials { flex-direction: column; }
        }

        @media (max-width: 1200px) { #game-over-summary { grid-template-columns: 1fr; } }
        @media (max-width: 1100px) { #candidate-options, #setup-options { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { 
            .venture-card-compact { flex-direction: column; text-align: center; }
            .venture-card-actions { flex-direction: row; width: 100%; }
            .venture-card-actions button { flex: 1; }
            .info-stats-full { grid-template-columns: repeat(2, 1fr); }
            .venture-info-actions { flex-direction: column; }
            .finance-grid { flex-direction: column; }
            .brand-section { flex-wrap: wrap; gap: 8px; }
            .venture-tag { font-size: 0.7em; }
            .team-row { justify-content: flex-start; overflow-x: auto; padding-bottom: 8px; }
            .team-member { flex-shrink: 0; }
        } 
        @media (max-width: 900px) {
            body { padding: 0; min-height: 100vh; }
            #game-container { min-height: 100vh; }
            #top-bar { padding: 10px 16px; flex-wrap: wrap; gap: 10px; }
            .brand-title { font-size: 1em; }
            #team-bar { padding: 12px 16px; }
            #main-content { grid-template-columns: 1fr; }
            #dashboard { 
                order: 2; 
                max-height: 400px;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 16px;
            }
            .dash-section { padding: 10px; }
            .dash-section-title { font-size: 0.7em; }
            .dash-section-header { margin-bottom: 8px; }
            #event-area { order: 1; min-height: 350px; padding: 16px; }
            .hq-header { flex-direction: column; text-align: center; gap: 12px; }
            #venture-choices, #strategy-choices { flex-direction: column; }
            .modal-content { padding: 0; max-height: 95vh; border-radius: 12px; } 
            #next-month-btn { padding: 10px 18px; font-size: 0.85em; } 
            .turn-display { font-size: 0.8em; padding: 6px 12px; }
            #exit-buttons { flex-direction: column; } 
            #global-shock-bar { font-size: 1em; padding: 10px; }
            .narrative-scene p { font-size: 0.95em; }
            .intro-header h1 { font-size: 1.8em; }
            .billion-goal-callout { padding: 15px 18px; gap: 12px; }
            .billion-goal-callout .goal-icon { font-size: 2em; }
            .billion-goal-callout .goal-title { font-size: 1.05em; }
            .billion-goal-callout .goal-desc { font-size: 0.85em; }
            .metric-row { padding: 6px 0; }
            .metric-row-label { font-size: 0.75em; }
            #review-changes-visual { grid-template-columns: repeat(2, 1fr); }
        }

        /* ===== MOBILE-SPECIFIC STYLES ===== */
        
        /* Mobile Bottom Navigation */
        #mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border-top: 1px solid var(--border-light);
            padding: 8px 16px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 200;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        }
        
        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 8px;
        }
        
        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 8px;
            border-radius: 12px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-medium);
            font-size: 0.75em;
            font-weight: 500;
            position: relative;
        }
        
        .mobile-nav-item.active {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: var(--color-primary-dark);
        }
        
        .mobile-nav-item .nav-icon {
            font-size: 1.6em;
        }
        
        .mobile-nav-item .nav-badge {
            position: absolute;
            top: 4px;
            right: 50%;
            transform: translateX(16px);
            background: #ef4444;
            color: white;
            font-size: 0.7em;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        /* Mobile view states */
        @media (max-width: 768px) {
            #mobile-nav { display: block; }
            
            body {
                padding-bottom: 80px; /* Space for bottom nav */
            }
            
            #main-content {
                grid-template-columns: 1fr !important;
                height: calc(100vh - 60px - 80px); /* Viewport - top bar - bottom nav */
                overflow: hidden;
            }
            
            #dashboard {
                display: none !important;
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 80px;
                background: var(--bg-white);
                z-index: 50;
                overflow-y: auto;
                padding: 16px;
                grid-template-columns: 1fr !important;
            }
            
            #dashboard.mobile-visible {
                display: block !important;
            }
            
            #email-inbox {
                display: flex;
                height: 100%;
            }
            
            #email-inbox.mobile-hidden {
                display: none !important;
            }
            
            /* Compact top bar for mobile */
            #top-bar {
                padding: 10px 12px;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
                height: 60px;
            }
            
            .brand-title { font-size: 0.95em; }
            .brand-logo { width: 32px; height: 32px; }
            .brand-logo svg { width: 32px; height: 32px; }
            
            .venture-tag { 
                font-size: 0.7em; 
                padding: 4px 10px;
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .turn-display {
                font-size: 0.8em;
                padding: 6px 10px;
            }
            
            #next-month-btn {
                padding: 8px 14px;
                font-size: 0.85em;
            }
            
            .game-controls { gap: 8px; }
            
            /* Hide team bar on mobile or make it collapsible */
            #team-bar {
                display: none !important;
            }
            
            /* Content area adjustment */
            #game-container {
                padding-top: 60px;
            }
            
            /* Email list improvements for touch */
            .email-item {
                padding: 16px;
                min-height: 72px;
            }
            
            .email-avatar {
                width: 48px;
                height: 48px;
            }
            
            .email-subject {
                font-size: 0.95em;
            }
            
            /* Inbox header compact */
            .inbox-header {
                padding: 12px 16px;
            }
            
            .inbox-toolbar {
                padding: 8px 16px;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .inbox-filter {
                padding: 8px 14px;
                font-size: 0.85em;
            }
            
            /* Modal full screen on mobile */
            .modal-overlay {
                align-items: flex-end;
            }
            
            .modal-content {
                max-width: 100% !important;
                width: 100% !important;
                max-height: 95vh !important;
                min-height: 50vh;
                border-radius: 20px 20px 0 0 !important;
                margin: 0;
            }
            
            /* Email view modal full screen */
            #email-view-modal .modal-content {
                max-height: 100vh !important;
                height: 100vh;
                border-radius: 0 !important;
            }
            
            .email-view-header {
                padding: 12px 16px;
                padding-top: max(12px, env(safe-area-inset-top));
            }
            
            .email-view-body {
                padding: 16px;
                padding-bottom: 100px; /* Extra space for scrolling */
            }
            
            .email-reply-section {
                padding: 16px;
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
            
            /* Larger touch targets for reply options */
            .reply-option {
                margin-bottom: 10px;
            }
            
            .reply-option-text {
                padding: 14px 16px;
                font-size: 1em;
            }
            
            .reply-effects {
                padding: 12px 16px;
            }
            
            /* Setup screens improvements */
            #setup-options, #candidate-options {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
            
            .venture-card-compact {
                padding: 16px;
            }
            
            .candidate-card {
                padding: 16px;
            }
            
            /* Title screen mobile adjustments */
            .title-screen {
                padding: 20px 16px;
            }
            
            .title-main h1 {
                font-size: 1.5em;
            }
            
            .title-pillars {
                flex-direction: column;
                gap: 12px;
            }
            
            .title-pillar {
                padding: 16px;
            }
            
            .title-button-group {
                flex-direction: column;
                gap: 12px;
            }
            
            .title-start-btn, .title-tutorial-btn {
                width: 100%;
                padding: 16px;
            }
            
            /* Report modals */
            .report-container {
                padding: 16px;
            }
            
            .report-header {
                padding: 16px;
            }
            
            #review-changes-visual {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px;
            }
            
            .review-change-card {
                padding: 10px;
            }
            
            /* Dashboard sections in mobile view */
            .dash-section {
                background: var(--bg-white);
                border: 1px solid var(--border-light);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
            }
            
            /* Finance panel adjustments */
            .finance-grid {
                flex-direction: column;
                gap: 12px;
            }
            
            .finance-item {
                flex: none;
                width: 100%;
            }
            
            /* Quarterly review mobile */
            .quarterly-container {
                padding: 16px;
            }
            
            .quarterly-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .quarterly-avatar {
                margin: 0 auto;
            }
            
            /* Tutorial modal mobile */
            .tutorial-topic-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Game over screen */
            #game-over-summary {
                grid-template-columns: 1fr !important;
            }
            
            .outcome-badge {
                font-size: 1em;
            }
            
            /* Hiring/candidate screens */
            .hiring-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Reallocation modal */
            .reallocation-grid {
                grid-template-columns: 1fr !important;
            }
            
            .realloc-metrics-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 380px) {
            .brand-title { display: none; }
            .venture-tag { max-width: 80px; }
            
            #next-month-btn {
                padding: 8px 10px;
                font-size: 0.8em;
            }
            
            .turn-display {
                padding: 4px 8px;
                font-size: 0.75em;
            }
            
            .mobile-nav-item {
                padding: 8px 4px;
                font-size: 0.7em;
            }
            
            .mobile-nav-item .nav-icon {
                font-size: 1.4em;
            }
        }
        
        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-content {
                max-height: 100vh !important;
                border-radius: 0 !important;
            }
            
            #mobile-nav {
                padding: 6px 16px;
            }
            
            .mobile-nav-item {
                flex-direction: row;
                gap: 8px;
                padding: 8px 12px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (pointer: coarse) {
            .inbox-filter,
            .email-btn,
            .reply-option,
            .mobile-nav-item,
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            .email-item {
                min-height: 72px;
            }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- Hasty Decision Toast -->
        <div class="hasty-toast" id="hasty-toast">
            <span class="toast-icon">⚡</span>
            <span class="hasty-toast-title">Hasty Decision!</span>
            <span class="hasty-toast-message toast-sub">Effects reduced — take time to read</span>
        </div>
        <!-- TOP BAR -->
        <div id="top-bar">
            <div class="brand-section">
                <div class="brand-logo">
                    <svg width="28" height="28" viewBox="0 0 100 100" fill="none">
                        <circle cx="50" cy="50" r="48" fill="url(#topBarLogoGrad)"/>
                        <path d="M50 15 L65 45 L57 45 L57 70 L43 70 L43 45 L35 45 Z" fill="white" opacity="0.95"/>
                        <rect x="25" y="75" width="10" height="12" rx="2" fill="#2ecc71"/>
                        <rect x="38" y="68" width="10" height="19" rx="2" fill="#3498db"/>
                        <rect x="51" y="60" width="10" height="27" rx="2" fill="#9b59b6"/>
                        <rect x="64" y="50" width="10" height="37" rx="2" fill="#f1c40f"/>
                        <defs>
                            <linearGradient id="topBarLogoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <span class="brand-title">Smart Scale</span>
                <div id="venture-logo-small"></div>
                <span class="venture-tag" id="venture-name-badge">Loading...</span>
            </div>
            <div class="game-controls">
                <div class="turn-display">Month <span id="turn-counter">0</span> of 12</div>
                <button id="next-month-btn" disabled>Get Started</button>
            </div>
        </div>
        
        <!-- LEADERSHIP TEAM BAR -->
        <div id="team-bar">
            <div class="team-row" id="leadership-team-row">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <div id="main-content">
            <div id="dashboard">
                <!-- Monthly Cash Flow -->
                <div class="dash-section">
                    <div class="dash-section-header">
                        <span class="dash-section-icon">💰</span>
                        <span class="dash-section-title">Monthly Cash Flow</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon emerald">📈</div>
                            <span class="metric-row-label">Revenue</span>
                        </div>
                        <span class="metric-row-value high" id="metric-revenue-value">£0K</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon rose">📉</div>
                            <span class="metric-row-label">Costs</span>
                        </div>
                        <span class="metric-row-value low" id="metric-costs-value">£0K</span>
                    </div>
                    <div class="metric-row" style="border-top: 2px solid var(--bg-subtle); padding-top: 10px;">
                        <div class="metric-row-left">
                            <div class="metric-row-icon purple">💵</div>
                            <span class="metric-row-label">Net / Month</span>
                        </div>
                        <span class="metric-row-value" id="metric-net-value">£0K</span>
                    </div>
                    <div class="finance-runway" id="metric-runway">
                        <span class="runway-label">Runway:</span>
                        <span class="runway-value" id="metric-runway-value">12+ months</span>
                    </div>
                </div>
                
                <!-- Market Progress -->
                <div class="dash-section">
                    <div class="dash-section-header">
                        <span class="dash-section-icon">📈</span>
                        <span class="dash-section-title">Markets</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon sky">🌍</div>
                            <span class="metric-row-label">Markets Entered</span>
                        </div>
                        <span class="metric-row-value" id="metric-reach-value">0</span>
                    </div>
                </div>
                
                <!-- Scaling Template -->
                <div class="dash-section">
                    <div class="dash-section-header">
                        <span class="dash-section-icon">⭐</span>
                        <span class="dash-section-title">Template</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon purple">📋</div>
                            <span class="metric-row-label">Stage</span>
                        </div>
                        <span class="metric-row-value" id="metric-template-stage-value">Prototype</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon purple">📊</div>
                            <span class="metric-row-label">Progress</span>
                        </div>
                        <div class="metric-progress">
                            <div class="metric-progress-bar">
                                <div class="metric-progress-fill purple" id="metric-template-progress-bar" style="width: 0%;"></div>
                            </div>
                            <span class="metric-row-value" id="metric-template-progress-value">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Venture Health -->
                <div class="dash-section">
                    <div class="dash-section-header">
                        <span class="dash-section-icon">📊</span>
                        <span class="dash-section-title">Venture Health</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon purple">🌍</div>
                            <span class="metric-row-label">Purpose</span>
                        </div>
                        <span class="metric-row-value" id="metric-purpose-value">→ Stable</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon amber">💡</div>
                            <span class="metric-row-label">Innovation</span>
                        </div>
                        <span class="metric-row-value" id="metric-innovation-value">→ Stable</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon emerald">🎓</div>
                            <span class="metric-row-label">Skill</span>
                        </div>
                        <span class="metric-row-value" id="metric-skill-value">→ Stable</span>
                    </div>
                    <div class="metric-row">
                        <div class="metric-row-left">
                            <div class="metric-row-icon rose">😊</div>
                            <span class="metric-row-label">Morale</span>
                        </div>
                        <span class="metric-row-value" id="metric-morale-value">→ Stable</span>
                    </div>
                </div>
            </div>
            
            <div id="email-inbox">
                <div class="inbox-header">
                    <div class="inbox-title">
                        <span class="inbox-title-icon">📧</span>
                        <span>Inbox</span>
                    </div>
                    <div class="inbox-count" id="inbox-count">0 messages</div>
                </div>
                <div class="inbox-toolbar">
                    <span class="inbox-filter active" data-filter="all">All</span>
                    <span class="inbox-filter" data-filter="unread">Unread</span>
                    <span class="inbox-filter" data-filter="urgent">⚡ Urgent</span>
                </div>
                <div class="email-list" id="email-list">
                    <div class="inbox-empty" id="inbox-empty">
                        <div class="inbox-empty-icon">📭</div>
                        <h3>No messages yet</h3>
                        <p>Click "Get Started" to begin receiving emails from your team.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav id="mobile-nav">
        <div class="mobile-nav-items">
            <button class="mobile-nav-item active" data-view="inbox" onclick="switchMobileView('inbox')">
                <span class="nav-icon">📧</span>
                <span>Inbox</span>
                <span class="nav-badge" id="mobile-inbox-badge" style="display: none;">0</span>
            </button>
            <button class="mobile-nav-item" data-view="dashboard" onclick="switchMobileView('dashboard')">
                <span class="nav-icon">📊</span>
                <span>Dashboard</span>
            </button>
            <button class="mobile-nav-item" data-view="team" onclick="switchMobileView('team')">
                <span class="nav-icon">👥</span>
                <span>Team</span>
            </button>
        </div>
    </nav>
    
    
    <!-- TITLE SCREEN - First thing players see -->
    <div class="modal-overlay visible" id="title-modal">
        <div class="modal-content">
            <div class="title-screen">
                <div class="title-hero">
                    <div class="title-logo">
                        <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="48" fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                            <path d="M50 15 L65 45 L57 45 L57 70 L43 70 L43 45 L35 45 Z" fill="white" opacity="0.95"/>
                            <rect x="25" y="75" width="10" height="12" rx="2" fill="#2ecc71"/>
                            <rect x="38" y="68" width="10" height="19" rx="2" fill="#3498db"/>
                            <rect x="51" y="60" width="10" height="27" rx="2" fill="#9b59b6"/>
                            <rect x="64" y="50" width="10" height="37" rx="2" fill="#f1c40f"/>
                            <ellipse cx="50" cy="42" rx="30" ry="10" stroke="rgba(255,255,255,0.5)" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
                        </svg>
                    </div>
                    
                    <div class="title-main">
                        <h1>THE SMART SCALE GAME</h1>
                        <div class="tagline">Purpose, People & Profit in Neptune's Next Billion-Dollar Brand</div>
                    </div>
                </div>
                
                <div class="title-body">
                    <p class="title-premise">
                        Take charge of an internal venture at Neptune Corporation. 
                        Your mission: build <strong>Neptune's next billion-dollar brand</strong> in just 12 months.
                        Balance <strong>purpose</strong>, <strong>people</strong>, and <strong>profit</strong> 
                        as you scale the business to new markets.
                    </p>
                    
                    <div class="title-pillars">
                        <div class="title-pillar">
                            <div class="title-pillar-icon">📈</div>
                            <h3>SCALE</h3>
                            <p>Expand into new markets and build momentum</p>
                        </div>
                        <div class="title-pillar">
                            <div class="title-pillar-icon">🎯</div>
                            <h3>PURPOSE</h3>
                            <p>Stay true to the mission while chasing growth</p>
                        </div>
                        <div class="title-pillar">
                            <div class="title-pillar-icon">👥</div>
                            <h3>LEAD</h3>
                            <p>Build your team and shape culture through decisions</p>
                        </div>
                    </div>
                    
                    <div class="title-button-group">
                        <button class="title-start-btn" id="title-start-btn">START GAME</button>
                        <button class="title-tutorial-btn" id="title-tutorial-btn">
                            <span>📖</span> Tutorial
                        </button>
                    </div>
                    
                    <div class="title-footer">
                        <div class="title-tagline">A business simulation about scaling corporate ventures</div>
                        <div class="title-credits">
                            <span>Created by Ammon Salter</span>
                            <span class="credits-divider">·</span>
                            <span>Warwick Business School</span>
                        </div>
                        <div class="title-license">
                            © 2025 · Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TUTORIAL MODAL - Smart Scale Game Style -->
    <div class="modal-overlay" id="tutorial-modal">
        <div class="modal-content">
            <div class="tutorial-hub-header">
                <h2>Tutorial</h2>
                <p>Click any topic to learn more about the game</p>
            </div>
            <div class="tutorial-hub-body">
                <div class="tutorial-topic-grid">
                    <!-- The Game -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('game')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">🎮</div>
                            <div class="tutorial-card-title">The Game</div>
                        </div>
                        <div class="tutorial-card-desc">You're running a corporate venture. Scale it in 12 months.</div>
                    </div>
                    <!-- Inbox -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('inbox')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">📧</div>
                            <div class="tutorial-card-title">Your Inbox</div>
                        </div>
                        <div class="tutorial-card-desc">Receive emails from your team. Make decisions that matter.</div>
                    </div>
                    <!-- Metrics -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('metrics')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">📊</div>
                            <div class="tutorial-card-title">Key Metrics</div>
                        </div>
                        <div class="tutorial-card-desc">Track markets, template, purpose, innovation, skill & morale.</div>
                    </div>
                    <!-- Finances -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('finances')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">💰</div>
                            <div class="tutorial-card-title">Finances</div>
                        </div>
                        <div class="tutorial-card-desc">Revenue vs. costs. Stay solvent or face early termination.</div>
                    </div>
                    <!-- Resources -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('resources')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">🎚️</div>
                            <div class="tutorial-card-title">Resources</div>
                        </div>
                        <div class="tutorial-card-desc">Allocate budget across departments to shape outcomes.</div>
                    </div>
                    <!-- Team -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('team')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">👥</div>
                            <div class="tutorial-card-title">Your Team</div>
                        </div>
                        <div class="tutorial-card-desc">Five department heads with different priorities and styles.</div>
                    </div>
                    <!-- Reviews -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('reviews')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">📅</div>
                            <div class="tutorial-card-title">Reviews</div>
                        </div>
                        <div class="tutorial-card-desc">Monthly reports and quarterly feedback from HQ.</div>
                    </div>
                    <!-- Networking -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('networking')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">🍸</div>
                            <div class="tutorial-card-title">Networking</div>
                        </div>
                        <div class="tutorial-card-desc">The Neptune Reception mini-game in Month 3.</div>
                    </div>
                    <!-- Winning -->
                    <div class="tutorial-topic-card" onclick="openTutorialTopic('winning')">
                        <div class="tutorial-card-header">
                            <div class="tutorial-card-icon">🎯</div>
                            <div class="tutorial-card-title">Winning</div>
                        </div>
                        <div class="tutorial-card-desc">Hit your market target while keeping everything in balance.</div>
                    </div>
                </div>
                <button class="tutorial-start-btn" onclick="closeTutorial()">Got It — Let's Play →</button>
                <p class="tutorial-footnote">You can revisit this from the title screen anytime</p>
            </div>
        </div>
    </div>
    
    <!-- Tutorial Topic Detail Modal -->
    <div id="tutorial-topic-modal">
        <div class="topic-modal-content">
            <div class="topic-modal-header" id="topic-header">
                <div class="topic-modal-icon" id="topic-icon">🎮</div>
                <h3 class="topic-modal-title" id="topic-title">Topic Title</h3>
                <div class="topic-modal-subtitle" id="topic-subtitle">Subtitle</div>
            </div>
            <div class="topic-modal-body" id="topic-body">
                <p>Content goes here</p>
            </div>
            <button class="topic-back-btn" onclick="closeTutorialTopic()">← Back to Tutorial</button>
        </div>
    </div>
    
    <!-- INTRO MODAL - NARRATIVE VERSION -->
    <div class="modal-overlay" id="intro-modal">
        <div class="modal-content intro-narrative">
            <div class="intro-header">
                <div class="intro-logo">
                    <svg width="80" height="80" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="48" fill="url(#logoGradient)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                        <path d="M50 15 L65 45 L57 45 L57 70 L43 70 L43 45 L35 45 Z" fill="white" opacity="0.95"/>
                        <rect x="25" y="75" width="10" height="12" rx="2" fill="#2ecc71"/>
                        <rect x="38" y="68" width="10" height="19" rx="2" fill="#3498db"/>
                        <rect x="51" y="60" width="10" height="27" rx="2" fill="#9b59b6"/>
                        <rect x="64" y="50" width="10" height="37" rx="2" fill="#f1c40f"/>
                        <ellipse cx="50" cy="42" rx="30" ry="10" stroke="rgba(255,255,255,0.4)" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
                        <defs>
                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h1>THE SMART SCALE GAME</h1>
                <div class="subtitle">Purpose, People & Profit in Neptune's Next Billion-Dollar Brand</div>
            </div>
            
            <div class="intro-body">
                <div class="narrative-scene">
                    <p class="scene-opener">The lift doors open onto the 23rd floor. Your floor now.</p>
                    
                    <p>After eight years building your reputation across Neptune Corporation — from operations to strategy to leading a regional product team — the call finally came. You've been appointed <strong>New Business Unit Director</strong> of one of the company's most ambitious internal ventures: a startup-within-a-corporation that could reshape how millions of people live.</p>
                    
                    <p>The previous director moved on. The board sees potential — and risk. You have <strong>12 months</strong> to prove this venture can become Neptune's next billion-dollar brand.</p>
                </div>
                
                <div class="billion-goal-callout">
                    <div class="goal-icon">💎</div>
                    <div class="goal-content">
                        <div class="goal-title">Your Mission: Build a Billion-Dollar Brand</div>
                        <div class="goal-desc">Scale this venture into Neptune's next major success story — balancing purpose, people, and profit along the way.</div>
                    </div>
                </div>
                
                <div class="narrative-memo">
                    <div class="memo-header">
                        <span class="memo-icon">📋</span>
                        <span class="memo-title">Your Brief from the Board</span>
                    </div>
                    <div class="memo-body">
                        <p><em>"Neptune has always believed that business should improve lives, not just extract profit. Your venture sits at the heart of that mission.</em></p>
                        <p><em>We need you to reach new markets, build a team that believes in what we're doing, and — critically — prove we can do good <strong>and</strong> make money. Get this right, and you'll have built Neptune's next billion-dollar brand.</em></p>
                        <p><em>The next year will test everything you know about leadership. Your department heads will bring you problems. Your decisions will shape the culture. And the numbers won't lie.</em></p>
                        <p class="memo-signoff"><em>Good luck. We're counting on you."</em></p>
                    </div>
                </div>
                
                <div class="narrative-stakes">
                    <div class="stake-item">
                        <span class="stake-icon">🎯</span>
                        <div class="stake-text">
                            <strong>Scale with Purpose</strong>
                            <span>Expand into new markets while staying true to your mission</span>
                        </div>
                    </div>
                    <div class="stake-item">
                        <span class="stake-icon">👥</span>
                        <div class="stake-text">
                            <strong>Build Your Team</strong>
                            <span>Hire leaders, manage morale, and create a culture that wins</span>
                        </div>
                    </div>
                    <div class="stake-item">
                        <span class="stake-icon">💰</span>
                        <div class="stake-text">
                            <strong>Stay Solvent</strong>
                            <span>Every decision costs money — run out and it's game over</span>
                        </div>
                    </div>
                </div>
                
                <div class="game-mode-selector" style="margin: 25px 0; text-align: center;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #94a3b8; font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px;">Game Length</label>
                    <div style="display: inline-flex; gap: 8px; background: rgba(15, 23, 42, 0.6); padding: 6px; border-radius: 10px;">
                        <button id="mode-short" onclick="setGameMode('short')" style="padding: 10px 28px; border-radius: 8px; border: none; background: transparent; color: #94a3b8; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s;">Short</button>
                        <button id="mode-normal" onclick="setGameMode('normal')" style="padding: 10px 28px; border-radius: 8px; border: none; background: linear-gradient(135deg, #0d7377, #14919b); color: white; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s;">Normal</button>
                    </div>
                </div>
                
                <button class="start-btn" id="start-game-btn">
                    <span class="btn-text">Step Into Your Office</span>
                    <span class="btn-arrow">→</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="venture-modal"> 
        <div class="modal-content venture-modal-content"> 
            <h2>Choose Your Internal Venture</h2>
            <p class="venture-intro">Select a venture to lead. Click "Learn More" to see full details before choosing.</p>
            
            <div id="venture-choices">
                <div class="venture-card-compact" data-venture="aqualux">
                    <div class="venture-icon-small">
                        <svg width="50" height="50" viewBox="0 0 100 100">
                            <!-- AquaLux: Water droplet with circular refill arrows -->
                            <circle cx="50" cy="50" r="45" fill="#0077b6" opacity="0.15"/>
                            <path d="M50 22 C35 22 28 38 28 50 C28 68 38 78 50 78 C62 78 72 68 72 50 C72 38 65 22 50 22Z" fill="url(#aqualuxGrad)"/>
                            <ellipse cx="50" cy="42" rx="10" ry="7" fill="white" opacity="0.5"/>
                            <!-- Circular arrows -->
                            <path d="M20 50 A30 30 0 0 1 50 20" stroke="#00b4d8" stroke-width="4" fill="none" stroke-linecap="round"/>
                            <path d="M80 50 A30 30 0 0 1 50 80" stroke="#00b4d8" stroke-width="4" fill="none" stroke-linecap="round"/>
                            <polygon points="50,14 56,24 44,24" fill="#00b4d8"/>
                            <polygon points="50,86 44,76 56,76" fill="#00b4d8"/>
                            <defs>
                                <linearGradient id="aqualuxGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#00b4d8"/>
                                    <stop offset="100%" style="stop-color:#0077b6"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="venture-card-info">
                        <h3>AquaLux Refill Stations</h3>
                        <p class="venture-tagline">Premium personal care refill hubs</p>
                        <div class="venture-stats-mini">
                            <span>📅 12 months</span><span>🌍 High Purpose</span><span>⚖️ Balanced</span>
                        </div>
                    </div>
                    <div class="venture-card-actions">
                        <button class="btn-info" onclick="event.stopPropagation(); showVentureInfo('aqualux')">Learn More</button>
                        <button class="btn-select" onclick="chooseVenture('aqualux')">Select</button>
                    </div>
                </div>

                <div class="venture-card-compact" data-venture="frostvale">
                    <div class="venture-icon-small">
                        <svg width="50" height="50" viewBox="0 0 100 100">
                            <!-- FrostVale: Leaf with frost crystal pattern -->
                            <circle cx="50" cy="50" r="45" fill="#7c3aed" opacity="0.12"/>
                            <!-- Main leaf shape -->
                            <path d="M50 15 C30 35 25 55 50 85 C75 55 70 35 50 15Z" fill="url(#frostGrad)"/>
                            <!-- Leaf vein/stem -->
                            <path d="M50 20 L50 75" stroke="#4c1d95" stroke-width="2" opacity="0.4"/>
                            <path d="M50 35 L38 45 M50 45 L62 55 M50 55 L40 62" stroke="#4c1d95" stroke-width="1.5" opacity="0.3" fill="none"/>
                            <!-- Frost crystals -->
                            <circle cx="35" cy="30" r="3" fill="#e0e7ff"/>
                            <circle cx="65" cy="35" r="2.5" fill="#e0e7ff"/>
                            <circle cx="30" cy="50" r="2" fill="#c7d2fe"/>
                            <circle cx="70" cy="55" r="2.5" fill="#c7d2fe"/>
                            <path d="M35 30 L32 27 M35 30 L38 27 M35 30 L35 25" stroke="#e0e7ff" stroke-width="1.5"/>
                            <defs>
                                <linearGradient id="frostGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#a78bfa"/>
                                    <stop offset="50%" style="stop-color:#7c3aed"/>
                                    <stop offset="100%" style="stop-color:#5b21b6"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="venture-card-info">
                        <h3>FrostVale Plant-Based</h3>
                        <p class="venture-tagline">Premium plant-based frozen desserts</p>
                        <div class="venture-stats-mini">
                            <span>📅 12 months</span><span>💡 Medium Innovation</span><span>🚀 High Risk</span>
                        </div>
                    </div>
                    <div class="venture-card-actions">
                        <button class="btn-info" onclick="event.stopPropagation(); showVentureInfo('frostvale')">Learn More</button>
                        <button class="btn-select" onclick="chooseVenture('frostvale')">Select</button>
                    </div>
                </div>

                <div class="venture-card-compact" data-venture="puriclean">
                    <div class="venture-icon-small">
                        <svg width="50" height="50" viewBox="0 0 100 100">
                            <!-- PuriClean: Shield with water droplet and hands -->
                            <circle cx="50" cy="50" r="45" fill="#059669" opacity="0.12"/>
                            <!-- Shield shape -->
                            <path d="M50 12 L80 25 L80 50 C80 72 65 85 50 90 C35 85 20 72 20 50 L20 25 Z" fill="url(#puriGrad)" stroke="#047857" stroke-width="2"/>
                            <!-- Water droplet inside -->
                            <path d="M50 30 C42 30 38 40 38 48 C38 58 43 63 50 63 C57 63 62 58 62 48 C62 40 58 30 50 30Z" fill="#67e8f9"/>
                            <ellipse cx="50" cy="44" rx="6" ry="4" fill="white" opacity="0.6"/>
                            <!-- Sparkle/clean indicator -->
                            <path d="M70 35 L73 38 L70 41 L67 38 Z" fill="#fcd34d"/>
                            <path d="M30 40 L32 42 L30 44 L28 42 Z" fill="#fcd34d"/>
                            <defs>
                                <linearGradient id="puriGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#34d399"/>
                                    <stop offset="100%" style="stop-color:#059669"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="venture-card-info">
                        <h3>PuriClean Sanitation</h3>
                        <p class="venture-tagline">Affordable hygiene for emerging markets</p>
                        <div class="venture-stats-mini">
                            <span>📅 12 months</span><span>🌍 High Purpose</span><span>🌍 Moderate</span>
                        </div>
                    </div>
                    <div class="venture-card-actions">
                        <button class="btn-info" onclick="event.stopPropagation(); showVentureInfo('puriclean')">Learn More</button>
                        <button class="btn-select" onclick="chooseVenture('puriclean')">Select</button>
                    </div>
                </div>

                <div class="venture-card-compact" data-venture="mindspring">
                    <div class="venture-icon-small">
                        <svg width="50" height="50" viewBox="0 0 100 100">
                            <!-- MindSpring: Brain with sprouting growth -->
                            <circle cx="50" cy="50" r="45" fill="#ec4899" opacity="0.12"/>
                            <!-- Stylized brain outline -->
                            <path d="M35 55 C25 55 22 45 25 38 C28 30 35 28 40 30 C42 25 48 22 55 25 C62 22 70 28 72 38 C78 42 78 55 68 58 C65 65 55 68 50 65 C45 68 35 65 35 55Z" fill="url(#mindGrad)"/>
                            <!-- Brain detail lines -->
                            <path d="M40 40 Q50 35 55 42 M38 50 Q48 48 58 52" stroke="#9d174d" stroke-width="1.5" fill="none" opacity="0.4"/>
                            <!-- Sprouting element from top -->
                            <path d="M50 25 L50 15" stroke="#10b981" stroke-width="2.5" stroke-linecap="round"/>
                            <ellipse cx="45" cy="14" rx="5" ry="4" fill="#34d399" transform="rotate(-30 45 14)"/>
                            <ellipse cx="55" cy="14" rx="5" ry="4" fill="#34d399" transform="rotate(30 55 14)"/>
                            <!-- Glow dots -->
                            <circle cx="30" cy="35" r="2" fill="#fbbf24"/>
                            <circle cx="72" cy="40" r="2" fill="#fbbf24"/>
                            <circle cx="50" cy="70" r="1.5" fill="#fbbf24"/>
                            <defs>
                                <linearGradient id="mindGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#f9a8d4"/>
                                    <stop offset="50%" style="stop-color:#ec4899"/>
                                    <stop offset="100%" style="stop-color:#db2777"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="venture-card-info">
                        <h3>MindSpring Wellbeing</h3>
                        <p class="venture-tagline">B2B digital wellness platform</p>
                        <div class="venture-stats-mini">
                            <span>📅 12 months</span><span>💡 High Innovation</span><span>🚦 High Risk</span>
                        </div>
                    </div>
                    <div class="venture-card-actions">
                        <button class="btn-info" onclick="event.stopPropagation(); showVentureInfo('mindspring')">Learn More</button>
                        <button class="btn-select" onclick="chooseVenture('mindspring')">Select</button>
                    </div>
                </div>
            </div>
        </div> 
    </div>
    
    <!-- Venture Info Modal -->
    <div class="modal-overlay" id="venture-info-modal">
        <div class="modal-content venture-info-content">
            <div id="venture-info-header">
                <div id="venture-info-icon"></div>
                <div>
                    <h2 id="venture-info-title">Venture Name</h2>
                    <p id="venture-info-tagline" class="venture-tagline">Tagline</p>
                </div>
            </div>
            <div id="venture-info-body">
                <div class="info-section">
                    <h4>📋 Overview</h4>
                    <p id="venture-info-description"></p>
                </div>
                <div class="info-section">
                    <h4>🎯 Target Markets</h4>
                    <p id="venture-info-markets"></p>
                </div>
                <div class="info-section">
                    <h4>👥 Target Consumers</h4>
                    <p id="venture-info-consumers"></p>
                </div>
                <div class="info-section">
                    <h4>⚡ Key Challenge</h4>
                    <p id="venture-info-challenge"></p>
                </div>
                <div class="info-stats-full">
                    <div class="stat-box"><span class="stat-val" id="info-stat-duration">12 months</span><span class="stat-lbl">Duration</span></div>
                    <div class="stat-box"><span class="stat-val" id="info-stat-template">Basic</span><span class="stat-lbl">Template</span></div>
                    <div class="stat-box"><span class="stat-val level-high" id="info-stat-purpose">High</span><span class="stat-lbl">Purpose</span></div>
                    <div class="stat-box"><span class="stat-val level-medium" id="info-stat-innovation">Medium</span><span class="stat-lbl">Innovation</span></div>
                </div>
                <div id="venture-info-risk" class="risk"></div>
            </div>
            <div class="venture-info-actions">
                <button class="btn-back" onclick="closeVentureInfo()">← Back to Selection</button>
                <button class="btn-select-big" id="venture-info-select-btn">Select This Venture</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="strategy-modal"> 
        <div class="modal-content" style="max-width: 900px;"> 
            <h2>Choose Your Scaling Ambition</h2> 
            <p style="text-align: center; color: var(--text-medium); margin-bottom: 25px;">How aggressively will you pursue growth? This sets your market targets, timeline, and resource requirements.</p> 
            <div id="strategy-choices">
                <div class="strategy-card risk-low-card" onclick="chooseStrategy('local')">
                    <div class="strategy-header">
                        <div class="strategy-icon">🌱</div>
                        <h3>Local Champion</h3>
                        <span class="risk-badge badge-low">Lower Risk</span>
                    </div>
                    <div class="strategy-body">
                        <p class="strategy-description">
                            Focus on winning a few key markets really well. Build deep customer relationships and perfect your operating model before expanding further. Less pressure, more control.
                        </p>
                        <div class="strategy-stats">
                            <div class="strategy-stat">
                                <span class="stat-label">Target Markets</span>
                                <span class="stat-value">5 markets</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="stat-label">Profit Expected</span>
                                <span class="stat-value">By Month 10</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="stat-label">Monthly Burn</span>
                                <span class="stat-value">£500K base</span>
                            </div>
                        </div>
                        <div class="strategy-actions">
                            <button class="btn-select" onclick="event.stopPropagation(); chooseStrategy('local')">Select Strategy</button>
                        </div>
                    </div>
                </div>
                <div class="strategy-card risk-balanced-card" onclick="chooseStrategy('regional')">
                    <div class="strategy-header">
                        <div class="strategy-icon">⚖️</div>
                        <h3>Regional Expansion</h3>
                        <span class="risk-badge badge-balanced">Balanced</span>
                    </div>
                    <div class="strategy-body">
                        <p class="strategy-description">
                            Expand across multiple regions while maintaining quality. Balance speed with careful execution. The board expects meaningful scale, but you have room to course-correct.
                        </p>
                        <div class="strategy-stats">
                            <div class="strategy-stat">
                                <span class="stat-label">Target Markets</span>
                                <span class="stat-value">15 markets</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="stat-label">Profit Expected</span>
                                <span class="stat-value">By Month 8</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="stat-label">Monthly Burn</span>
                                <span class="stat-value">£800K base</span>
                            </div>
                        </div>
                        <div class="strategy-actions">
                            <button class="btn-select" onclick="event.stopPropagation(); chooseStrategy('regional')">Select Strategy</button>
                        </div>
                    </div>
                </div>
                <div class="strategy-card risk-high-card" onclick="chooseStrategy('global')">
                    <div class="strategy-header">
                        <div class="strategy-icon">🚀</div>
                        <h3>Global Blitz</h3>
                        <span class="risk-badge badge-high">Higher Risk</span>
                    </div>
                    <div class="strategy-body">
                        <p class="strategy-description">
                            Move fast and capture territory before competitors can respond. High investment, aggressive timelines, significant pressure — but the upside is transformational if you succeed.
                        </p>
                        <div class="strategy-stats">
                            <div class="strategy-stat">
                                <span class="stat-label">Target Markets</span>
                                <span class="stat-value">25 markets</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="stat-label">Profit Expected</span>
                                <span class="stat-value">By Month 6</span>
                            </div>
                            <div class="strategy-stat">
                                <span class="stat-label">Monthly Burn</span>
                                <span class="stat-value">£1.2M base</span>
                            </div>
                        </div>
                        <div class="strategy-actions">
                            <button class="btn-select" onclick="event.stopPropagation(); chooseStrategy('global')">Select Strategy</button>
                        </div>
                    </div>
                </div>
            </div> 
        </div> 
    </div>
    
    <div class="modal-overlay" id="setup-modal"> 
        <div class="modal-content setup-modal-content"> 
            <h2>📊 Allocate Department Resources</h2>
            <p class="setup-intro">Choose how to allocate resources across departments. Standard funding is included in your baseline costs. You can shift resources to prioritise certain areas — increasing one means more impact there, reducing saves money but limits effectiveness.</p>
            
            <div id="setup-budget-tracker">
                <div class="investment-summary">
                    <div class="investment-total">
                        <span class="inv-label">Monthly Adjustment</span>
                        <span class="inv-amount" id="total-monthly-investment">£0K</span>
                    </div>
                    <div class="investment-burn">
                        <span class="inv-label">vs Standard Baseline</span>
                        <span class="inv-amount burn-rate" id="investment-burn-impact">No change</span>
                    </div>
                </div>
            </div>

            <div class="investment-grid">
                <div class="investment-dept" data-dept="finance">
                    <div class="dept-header">
                        <span class="dept-icon">💰</span>
                        <div class="dept-info">
                            <h3>Finance</h3>
                            <p>Financial controls, reporting, cash management</p>
                        </div>
                    </div>
                    <div class="investment-tiers" id="tiers-finance">
                        <button class="tier-btn" data-tier="lean" data-cost="-100">
                            <span class="tier-name">Lean</span>
                            <span class="tier-signal">↓↓</span>
                            <span class="tier-cost">-£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="reduced" data-cost="-50">
                            <span class="tier-name">Reduced</span>
                            <span class="tier-signal">↓</span>
                            <span class="tier-cost">-£50K</span>
                        </button>
                        <button class="tier-btn active" data-tier="standard" data-cost="0">
                            <span class="tier-name">Standard</span>
                            <span class="tier-signal">→</span>
                            <span class="tier-cost">Baseline</span>
                        </button>
                        <button class="tier-btn" data-tier="enhanced" data-cost="100">
                            <span class="tier-name">Enhanced</span>
                            <span class="tier-signal">↑</span>
                            <span class="tier-cost">+£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="priority" data-cost="200">
                            <span class="tier-name">Priority</span>
                            <span class="tier-signal">↑↑</span>
                            <span class="tier-cost">+£200K</span>
                        </button>
                    </div>
                </div>

                <div class="investment-dept" data-dept="hr">
                    <div class="dept-header">
                        <span class="dept-icon">👥</span>
                        <div class="dept-info">
                            <h3>Human Resources</h3>
                            <p>Talent development, culture, compensation</p>
                        </div>
                    </div>
                    <div class="investment-tiers" id="tiers-hr">
                        <button class="tier-btn" data-tier="lean" data-cost="-100">
                            <span class="tier-name">Lean</span>
                            <span class="tier-signal">↓↓</span>
                            <span class="tier-cost">-£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="reduced" data-cost="-50">
                            <span class="tier-name">Reduced</span>
                            <span class="tier-signal">↓</span>
                            <span class="tier-cost">-£50K</span>
                        </button>
                        <button class="tier-btn active" data-tier="standard" data-cost="0">
                            <span class="tier-name">Standard</span>
                            <span class="tier-signal">→</span>
                            <span class="tier-cost">Baseline</span>
                        </button>
                        <button class="tier-btn" data-tier="enhanced" data-cost="100">
                            <span class="tier-name">Enhanced</span>
                            <span class="tier-signal">↑</span>
                            <span class="tier-cost">+£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="priority" data-cost="200">
                            <span class="tier-name">Priority</span>
                            <span class="tier-signal">↑↑</span>
                            <span class="tier-cost">+£200K</span>
                        </button>
                    </div>
                </div>

                <div class="investment-dept" data-dept="ops">
                    <div class="dept-header">
                        <span class="dept-icon">🏭</span>
                        <div class="dept-info">
                            <h3>Operations</h3>
                            <p>Supply chain, facilities, logistics</p>
                        </div>
                    </div>
                    <div class="investment-tiers" id="tiers-ops">
                        <button class="tier-btn" data-tier="lean" data-cost="-100">
                            <span class="tier-name">Lean</span>
                            <span class="tier-signal">↓↓</span>
                            <span class="tier-cost">-£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="reduced" data-cost="-50">
                            <span class="tier-name">Reduced</span>
                            <span class="tier-signal">↓</span>
                            <span class="tier-cost">-£50K</span>
                        </button>
                        <button class="tier-btn active" data-tier="standard" data-cost="0">
                            <span class="tier-name">Standard</span>
                            <span class="tier-signal">→</span>
                            <span class="tier-cost">Baseline</span>
                        </button>
                        <button class="tier-btn" data-tier="enhanced" data-cost="100">
                            <span class="tier-name">Enhanced</span>
                            <span class="tier-signal">↑</span>
                            <span class="tier-cost">+£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="priority" data-cost="200">
                            <span class="tier-name">Priority</span>
                            <span class="tier-signal">↑↑</span>
                            <span class="tier-cost">+£200K</span>
                        </button>
                    </div>
                </div>

                <div class="investment-dept" data-dept="marketing">
                    <div class="dept-header">
                        <span class="dept-icon">📣</span>
                        <div class="dept-info">
                            <h3>Marketing</h3>
                            <p>Brand building, campaigns, market expansion</p>
                        </div>
                    </div>
                    <div class="investment-tiers" id="tiers-marketing">
                        <button class="tier-btn" data-tier="lean" data-cost="-100">
                            <span class="tier-name">Lean</span>
                            <span class="tier-signal">↓↓</span>
                            <span class="tier-cost">-£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="reduced" data-cost="-50">
                            <span class="tier-name">Reduced</span>
                            <span class="tier-signal">↓</span>
                            <span class="tier-cost">-£50K</span>
                        </button>
                        <button class="tier-btn active" data-tier="standard" data-cost="0">
                            <span class="tier-name">Standard</span>
                            <span class="tier-signal">→</span>
                            <span class="tier-cost">Baseline</span>
                        </button>
                        <button class="tier-btn" data-tier="enhanced" data-cost="100">
                            <span class="tier-name">Enhanced</span>
                            <span class="tier-signal">↑</span>
                            <span class="tier-cost">+£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="priority" data-cost="200">
                            <span class="tier-name">Priority</span>
                            <span class="tier-signal">↑↑</span>
                            <span class="tier-cost">+£200K</span>
                        </button>
                    </div>
                </div>

                <div class="investment-dept" data-dept="tech">
                    <div class="dept-header">
                        <span class="dept-icon">💻</span>
                        <div class="dept-info">
                            <h3>Technology</h3>
                            <p>R&D, systems, innovation, digital tools</p>
                        </div>
                    </div>
                    <div class="investment-tiers" id="tiers-tech">
                        <button class="tier-btn" data-tier="lean" data-cost="-100">
                            <span class="tier-name">Lean</span>
                            <span class="tier-signal">↓↓</span>
                            <span class="tier-cost">-£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="reduced" data-cost="-50">
                            <span class="tier-name">Reduced</span>
                            <span class="tier-signal">↓</span>
                            <span class="tier-cost">-£50K</span>
                        </button>
                        <button class="tier-btn active" data-tier="standard" data-cost="0">
                            <span class="tier-name">Standard</span>
                            <span class="tier-signal">→</span>
                            <span class="tier-cost">Baseline</span>
                        </button>
                        <button class="tier-btn" data-tier="enhanced" data-cost="100">
                            <span class="tier-name">Enhanced</span>
                            <span class="tier-signal">↑</span>
                            <span class="tier-cost">+£100K</span>
                        </button>
                        <button class="tier-btn" data-tier="priority" data-cost="200">
                            <span class="tier-name">Priority</span>
                            <span class="tier-signal">↑↑</span>
                            <span class="tier-cost">+£200K</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="investment-tip">
                💡 <strong>Tip:</strong> Prioritise departments that matter most to your venture. Increasing investment improves outcomes from decisions in that area; reducing it saves money but limits your effectiveness.
            </div>

            <button id="confirm-setup-btn" class="btn-confirm-setup">Confirm Resource Allocation</button>
        </div> 
    </div>

    <div class="modal-overlay" id="hiring-modal"> 
        <div class="modal-content"> 
            <h2 id="hiring-role-title">Recruit Your Team: Head of [Role]</h2>
            <p class="hiring-intro">Internal candidates are ready immediately. External hires bring fresh perspectives but have recruitment costs and onboarding time.</p>
            <div id="candidate-options"></div> 
        </div> 
    </div>
    
    <div class="cv-modal-overlay" id="cv-modal">
        <div class="cv-modal">
            <div class="cv-modal-header">
                <div class="cv-modal-avatar" id="cv-avatar"></div>
                <div class="cv-modal-name">
                    <h2 id="cv-name">Candidate Name</h2>
                    <p id="cv-title">Job Title</p>
                    <span class="cv-modal-badge" id="cv-badge">Internal</span>
                </div>
            </div>
            <div class="cv-modal-body">
                <div class="cv-summary" id="cv-summary">Summary text here...</div>
                
                <div class="cv-modal-effects">
                    <div class="cv-effect-box positive">
                        <div class="cv-effect-label">Strength</div>
                        <div class="cv-effect-value" id="cv-strength">+10% Something</div>
                    </div>
                    <div class="cv-effect-box negative">
                        <div class="cv-effect-label">Weakness</div>
                        <div class="cv-effect-value" id="cv-weakness">-5 Something</div>
                    </div>
                </div>
                
                <div class="cv-section">
                    <div class="cv-section-title">📋 Overview</div>
                    <div class="cv-info-grid">
                        <div class="cv-info-item"><div class="cv-info-label">Experience</div><div class="cv-info-value" id="cv-years">X years</div></div>
                        <div class="cv-info-item"><div class="cv-info-label">Education</div><div class="cv-info-value" id="cv-education">Degree</div></div>
                    </div>
                </div>
                
                <div class="cv-section">
                    <div class="cv-section-title">💼 Career History</div>
                    <div id="cv-history"></div>
                </div>
                
                <div class="cv-section">
                    <div class="cv-section-title">🛠️ Key Skills</div>
                    <div class="cv-skills-list" id="cv-skills"></div>
                </div>
                
                <div class="cv-section">
                    <div class="cv-section-title">🏆 Achievements</div>
                    <ul class="cv-achievements" id="cv-achievements"></ul>
                </div>
            </div>
            <div class="cv-modal-actions">
                <button class="btn-cv-back" onclick="closeFullCV()">← Back to Candidates</button>
                <button class="btn-cv-hire" id="cv-hire-btn" onclick="">Recruit This Candidate</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="event-modal"> 
        <div class="modal-content">
            <div class="email-view-header">
                <div class="email-view-toolbar">
                    <button class="email-btn" onclick="closeEventModal()">← Back to Inbox</button>
                    <button class="email-btn" id="email-archive-btn" style="margin-left: auto;">Archive</button>
                </div>
                <div class="email-view-meta">
                    <div class="email-view-avatar" id="email-view-avatar"></div>
                    <div class="email-view-info">
                        <div class="email-view-from" id="email-view-from">Sender Name</div>
                        <div class="email-view-address" id="email-view-address"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5023353e343522103e352024253e357d333f22207e333f3d">[email&#160;protected]</a></div>
                        <div class="email-view-subject" id="email-view-subject">Email Subject</div>
                    </div>
                    <div class="email-view-dept-badge" id="email-view-dept">Department</div>
                </div>
            </div>
            <div class="email-view-body">
                <div class="email-greeting" id="email-greeting">Hi there,</div>
                <div class="email-message" id="email-message">
                    Email content goes here...
                </div>
                <div class="email-signature">
                    <div class="email-sig-name" id="email-sig-name">Sender Name</div>
                    <div class="email-sig-title" id="email-sig-title">Job Title</div>
                    <div class="email-sig-dept" id="email-sig-dept">Department</div>
                </div>
            </div>
            
            <div class="email-reply-section">
                <div class="email-reply-title">📝 Choose Your Response</div>
                <div id="event-options"></div>
                
                <div class="reply-advisor-box" id="reply-advisor-box">
                    <div class="reply-advisor-header">
                        <div class="reply-advisor-avatar" id="reply-advisor-avatar"></div>
                        <div>
                            <div class="reply-advisor-name" id="reply-advisor-name">Advisor Name</div>
                            <div class="reply-advisor-role" id="reply-advisor-role">Department Head</div>
                        </div>
                        <div class="reply-advisor-badge" id="reply-advisor-badge">💭 Their view</div>
                    </div>
                    <div class="reply-advisor-message" id="reply-advisor-message">
                        Advisor perspective goes here...
                    </div>
                </div>
            </div>
        </div> 
    </div>
    
    <!-- Budget Reallocation Modal -->
    <div class="modal-overlay" id="reallocation-modal">
        <div class="modal-content setup-modal-content">
            <h2 id="reallocation-title">📊 Quarterly Resource Review</h2>
            <p class="setup-intro" id="reallocation-intro">Review your resource allocations based on what you've learned. Shifting resources to priority areas can improve outcomes.</p>
            
            <!-- Performance Snapshot -->
            <div class="realloc-performance-snapshot" id="realloc-performance">
                <h4>Current Performance</h4>
                <div class="realloc-metrics-grid" id="realloc-metrics-grid">
                    <!-- Populated by JS -->
                </div>
                <div class="realloc-implications" id="realloc-implications">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="reallocation-summary">
                <div class="investment-summary">
                    <div class="investment-total">
                        <span class="inv-label">Monthly Investment</span>
                        <span class="inv-amount" id="realloc-total-investment">£0K</span>
                    </div>
                    <div class="investment-burn">
                        <span class="inv-label">vs. Previous</span>
                        <span class="inv-amount" id="realloc-change-indicator">No change</span>
                    </div>
                </div>
            </div>
            
            <div class="reallocation-current">
                <h4>Department Allocations</h4>
                <div class="reallocation-grid" id="reallocation-grid">
                    <!-- Will be populated by JS -->
                </div>
            </div>
            
            <div class="investment-tip">
                💡 <strong>Note:</strong> Increasing resources improves effectiveness; reducing them saves money but limits impact. Changes take effect next month.
            </div>
            
            <div class="reallocation-actions">
                <button class="btn-confirm-setup" onclick="confirmReallocation()">Confirm & Continue →</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="game-over-modal"> 
        <div class="modal-content">
            <div class="game-over-header" id="game-over-header">
                <div class="confetti-container" id="confetti-container"></div>
                <h2 id="game-over-title">Your Leadership Journey</h2>
                <div id="game-over-subtitle">12 Months at the Helm</div>
                <div class="career-outcome" id="career-outcome" style="display: none;">
                    <span class="outcome-icon" id="outcome-icon">🎯</span>
                    <span id="outcome-text">Career Outcome</span>
                </div>
                <div id="game-over-reason"></div>
            </div>
            
            <div class="game-over-body">
                <!-- Opening Reflection Message -->
                <div class="reflection-message" id="reflection-message">
                    <p>Loading reflection...</p>
                </div>
                
                <!-- Performance Stats (compact) -->
                <div class="performance-summary" id="performance-summary">
                    <!-- Populated by JS -->
                </div>
                
                <!-- Two columns: Strengths and Growth -->
                <div class="feedback-columns">
                    <div class="feedback-section strengths">
                        <h3>💪 Your Strengths</h3>
                        <ul id="strengths-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    <div class="feedback-section growth">
                        <h3>🌱 Growth Opportunities</h3>
                        <ul id="growth-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
                
                <!-- Key Learnings -->
                <div class="learnings-section">
                    <h3>💡 Key Learnings</h3>
                    <div id="learnings-content">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Next Tier Teaser -->
                <div class="next-tier-teaser" id="next-tier-teaser" style="display: none;">
                    <h4><span class="tier-icon" id="next-tier-icon">🏆</span><span id="next-tier-title">Unlock: Corporate Champion</span></h4>
                    <p id="next-tier-hint">Hit your market target while staying profitable to unlock this ending!</p>
                </div>
                
                <!-- Try Again -->
                <div class="try-again-section">
                    <h3>Ready for Another Challenge?</h3>
                    <p id="try-again-message">Every playthrough teaches something new about leading corporate ventures.</p>
                    <div class="strategy-suggestions" id="strategy-suggestions">
                        <!-- Populated by JS -->
                    </div>
                    <div id="exit-buttons">
                        <button onclick="location.reload()">🔄 Play Again</button>
                        <button onclick="showReferencesModal()" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">📚 Learn More</button>
                    </div>
                </div>
            </div>
            
            <div class="game-over-credits">
                <span>Created by Ammon Salter</span> · 
                <span>Warwick Business School, The University of Warwick</span><br>
                <span>© 2025 · <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></span>
            </div>
        </div>
    </div>
    
    <!-- References Modal -->
    <div class="modal-overlay" id="references-modal">
        <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div style="padding: 30px;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="color: var(--color-brand-blue); margin-bottom: 10px;">📚 Learn More About Scaling Corporate Ventures</h2>
                    <p style="color: var(--text-medium);">The research and inspiration behind this simulation</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--color-brand-blue); border-bottom: 2px solid var(--color-brand-blue); padding-bottom: 8px; margin-bottom: 15px;">📖 Academic References</h3>
                    <div style="font-size: 0.9em; line-height: 1.7; color: var(--text-medium);">
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Burgelman, R.A. and Grove, A.S., 2007. Let chaos reign, then rein in chaos—repeatedly: Managing strategic dynamics for corporate longevity. <em>Strategic Management Journal</em>, 28(10), pp.965-979. <a href="https://doi.org/10.1002/smj.625" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">DeSantola, A. and Gulati, R., 2017. Scaling: Organizing and growth in entrepreneurial ventures. <em>Academy of Management Annals</em>, 11(2), pp.640-668. <a href="https://doi.org/10.5465/annals.2015.0125" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Haas, M.R. and Hansen, M.T., 2007. Different knowledge, different benefits: Toward a productivity perspective on knowledge sharing in organizations. <em>Strategic Management Journal</em>, 28(11), pp.1133-1153. <a href="https://doi.org/10.1002/smj.631" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Hansen, M.T., 1999. The search-transfer problem: The role of weak ties in sharing knowledge across organization subunits. <em>Administrative Science Quarterly</em>, 44(1), pp.82-111. <a href="https://doi.org/10.2307/2667032" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Sapsed, J. and Salter, A., 2004. Postcards from the edge: Local communities, global programs and boundary objects. <em>Organization Studies</em>, 25(9), pp.1515-1534. <a href="https://doi.org/10.1177/0170840604047998" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Szulanski, G., 1996. Exploring internal stickiness: Impediments to the transfer of best practice within the firm. <em>Strategic Management Journal</em>, 17(S2), pp.27-43. <a href="https://doi.org/10.1002/smj.4250171105" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Szulanski, G., Ringov, D. and Jensen, R.J., 2016. Overcoming stickiness: How the timing of knowledge transfer methods affects transfer difficulty. <em>Organization Science</em>, 27(2), pp.304-322. <a href="https://doi.org/10.1287/orsc.2016.1049" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Szulanski, G. and Winter, S., 2002. Getting it right the second time. <em>Harvard Business Review</em>, 80(1), pp.62-69.</p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Winter, S.G. and Szulanski, G., 2001. Replication as strategy. <em>Organization Science</em>, 12(6), pp.730-743. <a href="https://doi.org/10.1287/orsc.12.6.730.10084" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                        
                        <p style="margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">Winter, S.G., Szulanski, G., Ringov, D. and Jensen, R.J., 2012. Reproducing knowledge: Inaccurate replication and failure in franchise organizations. <em>Organization Science</em>, 23(3), pp.672-685. <a href="https://doi.org/10.1287/orsc.1110.0663" target="_blank" rel="noopener" style="color: var(--color-brand-blue);">DOI</a></p>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--color-brand-blue); border-bottom: 2px solid var(--color-brand-blue); padding-bottom: 8px; margin-bottom: 15px;">🎬 Movies & TV Shows</h3>
                    <div style="font-size: 0.9em; line-height: 1.7; color: var(--text-medium);">
                        <p style="margin-bottom: 15px;"><strong style="color: var(--text-dark);">WeCrashed</strong> (AppleTV) — Documents the experience of WeWork in a 10-part series, with excellent acting and rich information about the dangers of hyper-scaling.</p>
                        
                        <p style="margin-bottom: 15px;"><strong style="color: var(--text-dark);">The Founder</strong> (Movie) — Documents the rise and growth of McDonald's as a franchise model by following the life of Ray Kroc. It also shows the tensions between the original template and its expansion into mass scaling.</p>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="hideReferencesModal()" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1em; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="transition-report-modal">
        <div class="modal-content">
            <div class="report-header" id="report-header">
                <h2 id="report-title">Month 1 Complete</h2>
                <div class="report-subtitle" id="report-subtitle">Monthly Performance Summary</div>
            </div>
            <div class="report-body">
                <!-- Director Message (Quarterly only) -->
                <div class="director-message" id="director-message-section" style="display: none;">
                    <div class="director-header">
                        <div class="director-avatar">👔</div>
                        <div class="director-info">
                            <div class="director-name">Victoria Palmer</div>
                            <div class="director-title">Strategy Director, Neptune Corp</div>
                        </div>
                    </div>
                    <div class="message-text" id="director-message-text"></div>
                </div>
                
                <!-- Quarterly Rating (Quarterly only) -->
                <div class="quarterly-rating" id="quarterly-rating-section" style="display: none;">
                    <span class="rating-label">Board Assessment:</span>
                    <span class="rating-stars" id="rating-stars">⭐⭐⭐</span>
                    <span class="rating-text" id="rating-text">On Track</span>
                </div>
                
                <!-- Key Changes -->
                <div class="report-changes-section">
                    <h3>📊 This Month's Changes</h3>
                    <div class="report-changes-grid" id="report-changes-grid"></div>
                </div>
                
                <!-- Financials -->
                <div class="report-financials" id="report-financials">
                    <div class="report-financial-item">
                        <div class="fin-label">Revenue</div>
                        <div class="fin-value" id="report-revenue">£0K</div>
                    </div>
                    <div class="report-financial-item">
                        <div class="fin-label">Costs</div>
                        <div class="fin-value" id="report-costs">£0K</div>
                    </div>
                    <div class="report-financial-item">
                        <div class="fin-label">Net Flow</div>
                        <div class="fin-value" id="report-net">£0K</div>
                    </div>
                </div>
                
                <!-- Progress to Target -->
                <div class="report-progress-section">
                    <h3>📈 Progress to Market Target</h3>
                    <div class="report-progress-bar">
                        <div class="report-progress-fill" id="report-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="report-progress-labels">
                        <span id="report-progress-current">0 markets</span>
                        <span id="report-progress-target">Target: 15</span>
                    </div>
                </div>
                
                <button class="report-continue-btn" onclick="closeTransitionReport()">Continue to Month <span id="report-next-month">2</span> →</button>
            </div>
        </div>
    </div>
    
    <div id="global-shock-bar">⚡ GLOBAL SHOCK! ⚡</div>

    <!-- Neptune Reception Mini-Game Overlay -->
    <div id="neptune-iframe-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000;">
        <iframe id="neptune-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>

    <script>
        // ===== AUDIO SYSTEM =====
        let audioCtx = null;
        let masterVolume = 0.4;
        let musicVolume = 0.25;
        let sfxVolume = 0.5;
        let musicEnabled = true;
        let sfxEnabled = true;
        let currentMusic = null;
        let musicGainNode = null;
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        // Sound effect definitions using Web Audio API synthesis
        const soundDefs = {
            // Entrance - inspiring opening flourish (bright major chord with sparkle)
            entrance: { type: 'entrance', duration: 0.8, volume: 0.6 },
            // Energetic click - bright pop
            click: { type: 'sine', freqs: [1000, 1500], duration: 0.05, gap: 0.015, volume: 0.5 },
            // Uplifting swoosh - rising filtered noise with brightness
            whoosh: { type: 'risingWhoosh', duration: 0.18, filter: 3500, volume: 0.4 },
            // Success fanfare - major arpeggio going up
            success: { type: 'sine', freqs: [523, 659, 784, 1047], duration: 0.1, gap: 0.06 },
            // Reward - triumphant ascending 
            reward: { type: 'sine', freqs: [523, 659, 784, 1047, 1319], duration: 0.08, gap: 0.05 },
            // Warning - attention-getting but not harsh
            warning: { type: 'triangle', freq: 440, duration: 0.18, pulses: 2 },
            // Negative - descending tone
            negative: { type: 'triangle', freqs: [380, 300, 240], duration: 0.12, gap: 0.08 },
            // Positive - quick bright chime
            positive: { type: 'sine', freqs: [880, 1100, 1320], duration: 0.06, gap: 0.03 },
            // Page flip - crisp paper sound
            pageFlip: { type: 'crispFlip', duration: 0.1, filter: 4500, volume: 0.35 },
            // Hire celebration
            hire: { type: 'sine', freqs: [659, 784, 988, 1319], duration: 0.07, gap: 0.04 },
            // New email notification - bright double ding
            email: { type: 'sine', freqs: [1200, 1500], duration: 0.08, gap: 0.06 },
            // Decision made - satisfying confirmation
            decision: { type: 'sine', freqs: [660, 880], duration: 0.08, gap: 0.05 },
            // Mail sent swoosh - satisfying completion sound
            mailSent: { type: 'mailSwoosh', duration: 0.22, volume: 0.5 },
            // Setup transition - gentle forward motion
            transition: { type: 'sine', freqs: [440, 523, 659], duration: 0.08, gap: 0.05, volume: 0.5 },
            // Month end - warm completion chime (two-note resolution)
            monthEnd: { type: 'monthEnd', duration: 0.4, volume: 0.5 },
            // Quarter end - celebratory fanfare with shimmer
            quarterEnd: { type: 'quarterEnd', duration: 0.6, volume: 0.6 },
            // Game over - reflective descending (fallback)
            gameOver: { type: 'sine', freqs: [784, 659, 523, 392], duration: 0.15, gap: 0.1 },
            // Victory - triumphant celebration fanfare
            victory: { type: 'victory', duration: 1.2, volume: 0.6 },
            // Defeat - gentle, soothing resolution (not sad, just reflective)
            defeat: { type: 'defeat', duration: 0.8, volume: 0.5 },
            // Networking start - social buzz
            networkingStart: { type: 'sine', freqs: [440, 554, 659, 880], duration: 0.08, gap: 0.06 },
            // Rapport gain - warm ping
            rapport: { type: 'sine', freqs: [800, 1000], duration: 0.06, gap: 0.04 },
            // Resource acquired - treasure chime
            resourceGet: { type: 'sine', freqs: [784, 988, 1319], duration: 0.06, gap: 0.04 }
        };
        
        function playSound(soundName) {
            if (!sfxEnabled || !audioCtx) return;
            initAudio();
            
            const def = soundDefs[soundName];
            if (!def) return;
            
            const now = audioCtx.currentTime;
            const vol = sfxVolume * masterVolume * (def.volume || 1);
            
            if (def.type === 'noise') {
                // White noise for whoosh/page flip sounds
                const bufferSize = audioCtx.sampleRate * def.duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = def.filter || 2000;
                
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(vol * 0.3, now);
                gain.gain.exponentialDecayTo ? gain.gain.exponentialDecayTo(0.01, now + def.duration) : gain.gain.linearRampToValueAtTime(0.01, now + def.duration);
                
                source.connect(filter).connect(gain).connect(audioCtx.destination);
                source.start(now);
                source.stop(now + def.duration);
            } else if (def.type === 'entrance') {
                // Inspiring entrance flourish - bright major chord with sparkle
                // Play a warm major chord (C major with added 9th for brightness)
                const chordNotes = [262, 330, 392, 523, 587]; // C4, E4, G4, C5, D5
                chordNotes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    // Stagger entry slightly for richness
                    const startTime = now + i * 0.02;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.25, startTime + 0.08);
                    gain.gain.linearRampToValueAtTime(vol * 0.2, startTime + 0.3);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + def.duration);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + def.duration + 0.1);
                });
                
                // Add sparkle notes on top (higher octave arpeggio)
                const sparkleNotes = [784, 988, 1047, 1319]; // G5, B5, C6, E6
                sparkleNotes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.15 + i * 0.08;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.18, startTime + 0.03);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + 0.25);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.3);
                });
                
                // Subtle shimmer texture
                const shimmer = audioCtx.createOscillator();
                const shimmerGain = audioCtx.createGain();
                shimmer.type = 'sine';
                shimmer.frequency.setValueAtTime(2093, now + 0.2); // C7
                shimmer.frequency.linearRampToValueAtTime(2637, now + 0.5); // E7
                shimmerGain.gain.setValueAtTime(0, now + 0.2);
                shimmerGain.gain.linearRampToValueAtTime(vol * 0.08, now + 0.3);
                shimmerGain.gain.linearRampToValueAtTime(0.01, now + 0.6);
                shimmer.connect(shimmerGain).connect(audioCtx.destination);
                shimmer.start(now + 0.2);
                shimmer.stop(now + 0.65);
            } else if (def.type === 'risingWhoosh') {
                // Rising whoosh - energetic upward sweep with noise
                const bufferSize = audioCtx.sampleRate * def.duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(800, now);
                filter.frequency.linearRampToValueAtTime(def.filter || 4000, now + def.duration * 0.7);
                filter.Q.value = 2;
                
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(0.01, now);
                gain.gain.linearRampToValueAtTime(vol * 0.4, now + def.duration * 0.3);
                gain.gain.linearRampToValueAtTime(0.01, now + def.duration);
                
                source.connect(filter).connect(gain).connect(audioCtx.destination);
                source.start(now);
                source.stop(now + def.duration);
                
                // Add a bright tone sweep on top
                const osc = audioCtx.createOscillator();
                const oscGain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1200, now + def.duration * 0.8);
                oscGain.gain.setValueAtTime(0.01, now);
                oscGain.gain.linearRampToValueAtTime(vol * 0.15, now + def.duration * 0.4);
                oscGain.gain.linearRampToValueAtTime(0.01, now + def.duration);
                osc.connect(oscGain).connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + def.duration);
            } else if (def.type === 'crispFlip') {
                // Crisp page flip - quick bright noise burst
                const bufferSize = audioCtx.sampleRate * def.duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 2000;
                
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(vol * 0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + def.duration);
                
                source.connect(filter).connect(gain).connect(audioCtx.destination);
                source.start(now);
                source.stop(now + def.duration);
            } else if (def.type === 'mailSwoosh') {
                // Mail sent swoosh - simple satisfying swoosh sound
                const bufferSize = audioCtx.sampleRate * def.duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(800, now);
                filter.frequency.linearRampToValueAtTime(2500, now + def.duration * 0.5);
                filter.frequency.linearRampToValueAtTime(400, now + def.duration);
                filter.Q.value = 2;
                
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(vol * 0.4, now);
                gain.gain.linearRampToValueAtTime(vol * 0.5, now + def.duration * 0.25);
                gain.gain.linearRampToValueAtTime(0.01, now + def.duration);
                
                source.connect(filter).connect(gain).connect(audioCtx.destination);
                source.start(now);
                source.stop(now + def.duration);
            } else if (def.type === 'monthEnd') {
                // Month end - warm completion sound (resolving two-note chime)
                // First note
                const osc1 = audioCtx.createOscillator();
                const gain1 = audioCtx.createGain();
                osc1.type = 'sine';
                osc1.frequency.value = 523; // C5
                gain1.gain.setValueAtTime(vol * 0.35, now);
                gain1.gain.linearRampToValueAtTime(vol * 0.2, now + 0.15);
                gain1.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc1.connect(gain1).connect(audioCtx.destination);
                osc1.start(now);
                osc1.stop(now + 0.35);
                
                // Second note (resolving higher)
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.type = 'sine';
                osc2.frequency.value = 659; // E5
                gain2.gain.setValueAtTime(0, now + 0.12);
                gain2.gain.linearRampToValueAtTime(vol * 0.3, now + 0.15);
                gain2.gain.linearRampToValueAtTime(0.01, now + def.duration);
                osc2.connect(gain2).connect(audioCtx.destination);
                osc2.start(now + 0.12);
                osc2.stop(now + def.duration + 0.05);
                
                // Soft bell overtone
                const bell = audioCtx.createOscillator();
                const bellGain = audioCtx.createGain();
                bell.type = 'sine';
                bell.frequency.value = 1318; // E6
                bellGain.gain.setValueAtTime(0, now + 0.12);
                bellGain.gain.linearRampToValueAtTime(vol * 0.1, now + 0.15);
                bellGain.gain.linearRampToValueAtTime(0.01, now + 0.35);
                bell.connect(bellGain).connect(audioCtx.destination);
                bell.start(now + 0.12);
                bell.stop(now + 0.4);
            } else if (def.type === 'quarterEnd') {
                // Quarter end - celebratory fanfare with shimmer
                // Opening chord (C major)
                const chordNotes = [262, 330, 392]; // C4, E4, G4
                chordNotes.forEach((freq) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(vol * 0.25, now);
                    gain.gain.linearRampToValueAtTime(vol * 0.15, now + 0.2);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 0.45);
                });
                
                // Rising fanfare notes
                const fanfareNotes = [523, 659, 784, 1047]; // C5, E5, G5, C6
                fanfareNotes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.1 + i * 0.08;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.3, startTime + 0.03);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + 0.2);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.25);
                });
                
                // Shimmer/sparkle at the end
                const shimmerNotes = [1568, 1976, 2093]; // G6, B6, C7
                shimmerNotes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.4 + i * 0.03;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.12, startTime + 0.02);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + 0.15);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.2);
                });
            } else if (def.type === 'victory') {
                // Victory - triumphant celebration fanfare!
                // Opening power chord
                const powerChord = [196, 294, 392]; // G3, D4, G4
                powerChord.forEach((freq) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(vol * 0.3, now);
                    gain.gain.linearRampToValueAtTime(vol * 0.2, now + 0.3);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.6);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 0.65);
                });
                
                // Triumphant ascending fanfare
                const fanfare = [392, 494, 587, 784, 988]; // G4, B4, D5, G5, B5
                fanfare.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.15 + i * 0.1;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.35, startTime + 0.04);
                    gain.gain.linearRampToValueAtTime(vol * 0.2, startTime + 0.15);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + 0.35);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.4);
                });
                
                // Final triumphant chord
                const finalChord = [392, 494, 587, 784]; // G major
                finalChord.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.7;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.3, startTime + 0.05);
                    gain.gain.linearRampToValueAtTime(vol * 0.25, startTime + 0.3);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + def.duration);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + def.duration + 0.1);
                });
                
                // Sparkle finish
                const sparkle = [1568, 1976, 2349]; // G6, B6, D7
                sparkle.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.85 + i * 0.04;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.15, startTime + 0.02);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + 0.2);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.25);
                });
            } else if (def.type === 'defeat') {
                // Defeat - gentle, soothing resolution (reflective, not sad)
                // Soft minor chord that resolves to major
                const minorChord = [220, 262, 330]; // A3, C4, E4 (A minor)
                minorChord.forEach((freq) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(vol * 0.25, now);
                    gain.gain.linearRampToValueAtTime(vol * 0.15, now + 0.3);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.5);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 0.55);
                });
                
                // Gentle descending notes
                const descent = [440, 392, 330]; // A4, G4, E4
                descent.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.2 + i * 0.12;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.2, startTime + 0.03);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + 0.2);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.25);
                });
                
                // Resolving to a warm major chord (hopeful ending)
                const resolve = [262, 330, 392]; // C4, E4, G4 (C major)
                resolve.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startTime = now + 0.55;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(vol * 0.2, startTime + 0.05);
                    gain.gain.linearRampToValueAtTime(vol * 0.15, startTime + 0.2);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + def.duration);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + def.duration + 0.1);
                });
            } else if (def.freqs) {
                // Arpeggio/chord
                def.freqs.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = def.type;
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(vol * 0.4, now + i * (def.gap || 0.1));
                    gain.gain.linearRampToValueAtTime(0.01, now + i * (def.gap || 0.1) + def.duration);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(now + i * (def.gap || 0.1));
                    osc.stop(now + i * (def.gap || 0.1) + def.duration + 0.05);
                });
            } else if (def.pulses) {
                // Pulsed warning sound
                for (let i = 0; i < def.pulses; i++) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = def.type;
                    osc.frequency.value = def.freq;
                    const startTime = now + i * 0.15;
                    gain.gain.setValueAtTime(vol * 0.3, startTime);
                    gain.gain.linearRampToValueAtTime(0.01, startTime + 0.1);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.12);
                }
            } else {
                // Simple tone
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = def.type;
                osc.frequency.value = def.freq;
                gain.gain.setValueAtTime(vol * 0.4, now);
                gain.gain.linearRampToValueAtTime(0.01, now + def.duration);
                osc.connect(gain).connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + def.duration + 0.05);
            }
        }
        
        // Background music using procedural generation
        function startBackgroundMusic(type) {
            if (!musicEnabled) return;
            initAudio();
            stopBackgroundMusic();
            
            if (type === 'main') {
                // Calm ambient corporate music
                playAmbientLoop();
            } else if (type === 'reception') {
                // Upbeat jazz/cocktail party music
                playReceptionMusic();
            }
        }
        
        let ambientInterval = null;
        function playAmbientLoop() {
            if (!musicEnabled || !audioCtx) return;
            
            const playChord = () => {
                if (!musicEnabled || !audioCtx) return;
                const vol = musicVolume * masterVolume * 0.15;
                const now = audioCtx.currentTime;
                
                // Gentle ambient chords
                const chords = [
                    [261, 329, 392],  // C major
                    [293, 369, 440],  // D major
                    [246, 311, 369],  // B minor
                    [220, 277, 329],  // A minor
                ];
                const chord = chords[Math.floor(Math.random() * chords.length)];
                
                chord.forEach(freq => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(vol, now + 0.5);
                    gain.gain.linearRampToValueAtTime(vol * 0.7, now + 2);
                    gain.gain.linearRampToValueAtTime(0, now + 4);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 4.5);
                });
            };
            
            playChord();
            ambientInterval = setInterval(playChord, 5000);
        }
        
        let receptionMusicInterval = null;
        let receptionBassInterval = null;
        function playReceptionMusic() {
            if (!musicEnabled || !audioCtx) return;
            
            const vol = musicVolume * masterVolume;
            
            // Upbeat swing/jazz pattern
            const playBeat = () => {
                if (!musicEnabled || !audioCtx) return;
                const now = audioCtx.currentTime;
                
                // Walking bass line
                const bassNotes = [130, 146, 164, 174, 196, 174, 164, 146];
                const bassNote = bassNotes[Math.floor(Math.random() * bassNotes.length)];
                
                const bass = audioCtx.createOscillator();
                const bassGain = audioCtx.createGain();
                bass.type = 'triangle';
                bass.frequency.value = bassNote;
                bassGain.gain.setValueAtTime(vol * 0.25, now);
                bassGain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                bass.connect(bassGain).connect(audioCtx.destination);
                bass.start(now);
                bass.stop(now + 0.35);
            };
            
            const playChord = () => {
                if (!musicEnabled || !audioCtx) return;
                const now = audioCtx.currentTime;
                
                // Jazz chords (7ths and 9ths)
                const chords = [
                    [261, 329, 392, 466],  // Cmaj7
                    [293, 369, 440, 523],  // Dmaj7
                    [349, 440, 523, 622],  // Fmaj7
                    [392, 494, 587, 698],  // Gmaj7
                ];
                const chord = chords[Math.floor(Math.random() * chords.length)];
                
                chord.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    const startVol = vol * 0.12 * (1 - i * 0.15);
                    gain.gain.setValueAtTime(startVol, now);
                    gain.gain.linearRampToValueAtTime(startVol * 0.5, now + 1.5);
                    gain.gain.linearRampToValueAtTime(0, now + 2);
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 2.2);
                });
            };
            
            playBeat();
            playChord();
            receptionBassInterval = setInterval(playBeat, 400);
            receptionMusicInterval = setInterval(playChord, 2500);
        }
        
        function stopBackgroundMusic() {
            if (ambientInterval) { clearInterval(ambientInterval); ambientInterval = null; }
            if (receptionMusicInterval) { clearInterval(receptionMusicInterval); receptionMusicInterval = null; }
            if (receptionBassInterval) { clearInterval(receptionBassInterval); receptionBassInterval = null; }
        }
        
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            if (!musicEnabled) {
                stopBackgroundMusic();
            }
            return musicEnabled;
        }
        
        function toggleSfx() {
            sfxEnabled = !sfxEnabled;
            return sfxEnabled;
        }
        
        // Initialize audio on first user interaction
        document.addEventListener('click', function initOnClick() {
            initAudio();
            document.removeEventListener('click', initOnClick);
        }, { once: true });
        
        // ===== NEPTUNE RECEPTION STATE =====
        let neptuneNetworkingCompleted = false;

        // ===== NEPTUNE RECEPTION MINI-GAME =====
        const NEPTUNE_GAME_B64 = "PCFET0NUWVBFIGh0bWw+CjwhLS0KICBUaGUgTmVwdHVuZSBSZWNlcHRpb24KICBBIENvcnBvcmF0ZSBOZXR3b3JraW5nIEdhbWUKICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgwqkgMjAyNSBBbW1vbiBTYWx0ZXIKICAKICBQYXJ0IG9mIFRoZSBTbWFydCBTY2FsZSBHYW1lIGVkdWNhdGlvbmFsIHN1aXRlCiAgTGljZW5zZWQgdW5kZXIgQ0MgQlktTkMtU0EgNC4wCiAgCiAgQ29udHJpYnV0b3JzOiBGZWRlcmljbyBCaWdub25lLCBPcmlldHRhIE1hcnNpbGksIFJvc3NlbGxhIFNhbGFuZHJhCiAgQUkgQXNzaXN0YW5jZTogQ2xhdWRlIChBbnRocm9waWMpLCBHZW1pbmkgKEdvb2dsZSksIEdQVC01IChPcGVuQUkpCi0tPgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgogICAgPG1ldGEgY2hhcnNldD0iVVRGLTgiPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiPgogICAgPHRpdGxlPlRoZSBOZXB0dW5lIFJlY2VwdGlvbjwvdGl0bGU+CiAgICA8c3R5bGU+CiAgICAgICAgKiB7IGJveC1zaXppbmc6IGJvcmRlci1ib3g7IG1hcmdpbjogMDsgcGFkZGluZzogMDsgfQogICAgICAgIAogICAgICAgIGJvZHkgewogICAgICAgICAgICBmb250LWZhbWlseTogJ1NlZ29lIFVJJywgVGFob21hLCBHZW5ldmEsIFZlcmRhbmEsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmNWYwZTg7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIGhlaWdodDogMTAwdmg7CiAgICAgICAgfQoKICAgICAgICAjZ2FtZS13cmFwcGVyIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICAgICAgaGVpZ2h0OiAxMDB2aDsKICAgICAgICB9CgogICAgICAgIC8qID09PT09IEhVRCA9PT09PSAqLwogICAgICAgICNodWQgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjMmM1MjgyIDAlLCAjMWEzNjVkIDEwMCUpOwogICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDIwcHg7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogM3B4IHNvbGlkICNmNmFkNTU7CiAgICAgICAgICAgIHotaW5kZXg6IDEwMDsKICAgICAgICAgICAgZmxleC13cmFwOiB3cmFwOwogICAgICAgICAgICBnYXA6IDEwcHg7CiAgICAgICAgfQoKICAgICAgICAuaHVkLWxlZnQgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDIwcHg7CiAgICAgICAgICAgIGZsZXgtd3JhcDogd3JhcDsKICAgICAgICB9CgogICAgICAgIC5odWQtdGl0bGUgewogICAgICAgICAgICBjb2xvcjogI2Y2YWQ1NTsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjFlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgZ2FwOiA4cHg7CiAgICAgICAgfQoKICAgICAgICAuaHVkLXN0YXQgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDZweDsKICAgICAgICAgICAgY29sb3I6ICNmZmY7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMC44NWVtOwogICAgICAgIH0KCiAgICAgICAgLnN0YXQtYmFyIHsKICAgICAgICAgICAgd2lkdGg6IDEyMHB4OwogICAgICAgICAgICBoZWlnaHQ6IDE0cHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsMC4yKTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogN3B4OwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwyNTUsMjU1LDAuMyk7CiAgICAgICAgfQoKICAgICAgICAuc3RhdC1maWxsIHsKICAgICAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzOwogICAgICAgIH0KCiAgICAgICAgLmVuZXJneS1maWxsIHsgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjNDhiYjc4LCAjMzhhMTY5KTsgfQogICAgICAgIC5zb2NpYWwtZmlsbCB7IGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2VkODkzNiwgI2RkNmIyMCk7IH0KCiAgICAgICAgLmh1ZC1yaWdodCB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogMTVweDsKICAgICAgICB9CgogICAgICAgIC5odWQtdGltZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjZTUzZTNlLCAjYzUzMDMwKTsKICAgICAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgICAgICBwYWRkaW5nOiA4cHggMThweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjJlbTsKICAgICAgICB9CgogICAgICAgIC5odWQtdGltZXIudXJnZW50IHsKICAgICAgICAgICAgYW5pbWF0aW9uOiB0aW1lclB1bHNlIDAuNXMgaW5maW5pdGU7CiAgICAgICAgfQoKICAgICAgICBAa2V5ZnJhbWVzIHRpbWVyUHVsc2UgewogICAgICAgICAgICAwJSwgMTAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0KICAgICAgICAgICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA4KTsgYmFja2dyb3VuZDogI2M1MzAzMDsgfQogICAgICAgIH0KCiAgICAgICAgLm11c2ljLWJ0biB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICM4MDVhZDUsICM2YjQ2YzEpOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZjZhZDU1OwogICAgICAgICAgICBjb2xvcjogI2ZmZjsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDE0cHg7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjllbTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnM7CiAgICAgICAgfQoKICAgICAgICAubXVzaWMtYnRuOmhvdmVyIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA1KTsgfQogICAgICAgIC5tdXNpYy1idG4ucGxheWluZyB7IGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICM0OGJiNzgsICMzOGExNjkpOyB9CgogICAgICAgIC8qID09PT09IFJFU09VUkNFUyBCQVIgPT09PT0gKi8KICAgICAgICAjcmVzb3VyY2VzLWJhciB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgI2U4ZTBkNSwgI2Y1ZjBlOCk7CiAgICAgICAgICAgIHBhZGRpbmc6IDEwcHggMjBweDsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZ2FwOiAxNXB4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkICNkNGE1NzQ7CiAgICAgICAgICAgIGZsZXgtd3JhcDogd3JhcDsKICAgICAgICB9CgogICAgICAgIC5yZXNvdXJjZS1iYWRnZSB7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogNnB4OwogICAgICAgICAgICBwYWRkaW5nOiA2cHggMTRweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweDsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjg1ZW07CiAgICAgICAgICAgIGNvbG9yOiAjNzE4MDk2OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjY2JkNWUwOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4zczsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwwLDAsMC4xKTsKICAgICAgICB9CgogICAgICAgIC5yZXNvdXJjZS1iYWRnZS5hY3F1aXJlZCB7CiAgICAgICAgICAgIGNvbG9yOiAjMjc2NzQ5OwogICAgICAgICAgICBib3JkZXItY29sb3I6ICM0OGJiNzg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNjNmY2ZDU7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoNzIsIDE4NywgMTIwLCAwLjQpOwogICAgICAgICAgICBhbmltYXRpb246IHJlc291cmNlUG9wIDAuNXMgZWFzZTsKICAgICAgICB9CgogICAgICAgIEBrZXlmcmFtZXMgcmVzb3VyY2VQb3AgewogICAgICAgICAgICAwJSB7IHRyYW5zZm9ybTogc2NhbGUoMSk7IH0KICAgICAgICAgICAgNTAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjI1KTsgfQogICAgICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgICAgIH0KCiAgICAgICAgLyogPT09PT0gR0FNRSBDQU5WQVMgQVJFQSA9PT09PSAqLwogICAgICAgICNnYW1lLWFyZWEgewogICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmNWYwZTg7CiAgICAgICAgfQoKICAgICAgICAjcm9vbS1jb250YWluZXIgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiAyMjAwcHg7CiAgICAgICAgICAgIGhlaWdodDogMTYwMHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAKICAgICAgICAgICAgICAgIHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IDUwJSAzMCUsIHJnYmEoMjU1LCAyMTUsIDE1MCwgMC40KSAwJSwgdHJhbnNwYXJlbnQgNTAlKSwKICAgICAgICAgICAgICAgIHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IDIwJSA3MCUsIHJnYmEoMjU1LCAyMDAsIDEyMCwgMC4zKSAwJSwgdHJhbnNwYXJlbnQgNDAlKSwKICAgICAgICAgICAgICAgIHJhZGlhbC1ncmFkaWVudChlbGxpcHNlIGF0IDgwJSA2MCUsIHJnYmEoMjU1LCAyMjAsIDE4MCwgMC4zKSAwJSwgdHJhbnNwYXJlbnQgNDAlKSwKICAgICAgICAgICAgICAgIGxpbmVhci1ncmFkaWVudCgxODBkZWcsICNmN2U4ZDUgMCUsICNlZmUwYzkgNTAlLCAjZThkNGI4IDEwMCUpOwogICAgICAgICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4wMnMgbGluZWFyOwogICAgICAgIH0KCiAgICAgICAgI3Jvb20tY29udGFpbmVyOjpiZWZvcmUgewogICAgICAgICAgICBjb250ZW50OiAnJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDA7IGxlZnQ6IDA7IHJpZ2h0OiAwOyBib3R0b206IDA7CiAgICAgICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IAogICAgICAgICAgICAgICAgcmVwZWF0aW5nLWxpbmVhci1ncmFkaWVudCg5MGRlZywgdHJhbnNwYXJlbnQgMHB4LCB0cmFuc3BhcmVudCA5OHB4LCByZ2JhKDE4MCwgMTQwLCAxMDAsIDAuMTUpIDEwMHB4KSwKICAgICAgICAgICAgICAgIHJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQoMGRlZywgdHJhbnNwYXJlbnQgMHB4LCB0cmFuc3BhcmVudCA5OHB4LCByZ2JhKDE4MCwgMTQwLCAxMDAsIDAuMTUpIDEwMHB4KTsKICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgfQoKICAgICAgICAubGlnaHQtcG9vbCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmFkaWFsLWdyYWRpZW50KGNpcmNsZSwgcmdiYSgyNTUsIDI0MCwgMjAwLCAwLjUpIDAlLCB0cmFuc3BhcmVudCA3MCUpOwogICAgICAgIH0KCiAgICAgICAgLmJhci1jb3VudGVyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogMjgwcHg7CiAgICAgICAgICAgIGhlaWdodDogNzVweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDE4MGRlZywgIzhiNWEyYiwgIzZiNDQyMyk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDE1cHg7CiAgICAgICAgICAgIGJvcmRlcjogNHB4IHNvbGlkICNkNGE1NzQ7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgOHB4IDMwcHggcmdiYSgwLDAsMCwwLjMpOwogICAgICAgIH0KCiAgICAgICAgLmJhci1jb3VudGVyOjpiZWZvcmUgewogICAgICAgICAgICBjb250ZW50OiAnJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDhweDsgbGVmdDogMTVweDsgcmlnaHQ6IDE1cHg7IGhlaWdodDogMTBweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDkwZGVnLCAjZjZhZDU1LCAjZWQ4OTM2LCAjZjZhZDU1KTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgICAgIH0KCiAgICAgICAgLmJhci1jb3VudGVyOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICfwn4248J+lgvCfjbfwn4258J+lg/Cfjb4nOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHRvcDogNTAlOyBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICBmb250LXNpemU6IDEuOGVtOwogICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogMTBweDsKICAgICAgICAgICAgbWFyZ2luLXRvcDogNXB4OwogICAgICAgIH0KCiAgICAgICAgLnRhYmxlLXJvdW5kIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogODBweDsKICAgICAgICAgICAgaGVpZ2h0OiA4MHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDMwJSAzMCUsICNmZmYgMCUsICNmN2YzZWQgNTAlLCAjZWJlNWRiIDEwMCUpOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICAgICAgICAgIGJvcmRlcjogNHB4IHNvbGlkICNkNGE1NzQ7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNnB4IDIwcHggcmdiYSgwLDAsMCwwLjIpOwogICAgICAgIH0KCiAgICAgICAgLnRhYmxlLXJvdW5kOjphZnRlciB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICfwn5Wv77iPJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDUwJTsgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjVlbTsKICAgICAgICB9CgogICAgICAgIC5wbGFudCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgZm9udC1zaXplOiAzLjVlbTsKICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDZweCAxMnB4IHJnYmEoMCwwLDAsMC4zKSk7CiAgICAgICAgfQoKICAgICAgICAuY2hhbmRlbGllciB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgZm9udC1zaXplOiAzLjVlbTsKICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMzBweCByZ2JhKDI1NSwgMjAwLCAxMDAsIDAuOCkpOwogICAgICAgIH0KCiAgICAgICAgLnN0YWdlIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogNDUwcHg7CiAgICAgICAgICAgIGhlaWdodDogMTMwcHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxODBkZWcsICMyYzUyODIsICMxYTM2NWQpOwogICAgICAgICAgICBib3JkZXI6IDRweCBzb2xpZCAjZjZhZDU1OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDhweCAzMHB4IHJnYmEoMCwwLDAsMC4zKTsKICAgICAgICB9CgogICAgICAgIC5zdGFnZTo6YmVmb3JlIHsKICAgICAgICAgICAgY29udGVudDogJ/Cfjrfwn4668J+OufCfjrjwn6WBJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IDIwcHg7IGxlZnQ6IDUwJTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgICAgICBmb250LXNpemU6IDIuMmVtOwogICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogMTJweDsKICAgICAgICAgICAgYW5pbWF0aW9uOiBiYW5kUGxheSAwLjhzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgICAgIH0KCiAgICAgICAgQGtleWZyYW1lcyBiYW5kUGxheSB7CiAgICAgICAgICAgIDAlLCAxMDAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpIHRyYW5zbGF0ZVkoMCk7IH0KICAgICAgICAgICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpIHRyYW5zbGF0ZVkoLTRweCk7IH0KICAgICAgICB9CgogICAgICAgIC5zdGFnZTo6YWZ0ZXIgewogICAgICAgICAgICBjb250ZW50OiAn8J+OtSBORVBUVU5FIFJFQ0VQVElPTiAyMDI1IPCfjrUnOwogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogMThweDsgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGNvbG9yOiAjZjZhZDU1OwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBmb250LXNpemU6IDEuMmVtOwogICAgICAgICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICAgIH0KCiAgICAgICAgLnBpbGxhciB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgd2lkdGg6IDU1cHg7CiAgICAgICAgICAgIGhlaWdodDogNTVweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgI2Y2ZTA1ZSAwJSwgI2Q2OWUyZSA1MCUsICNiNzc5MWYgMTAwJSk7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTVweCByZ2JhKDAsMCwwLDAuMik7CiAgICAgICAgfQoKICAgICAgICAuYmFubmVyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjZWQ4OTM2LCAjZGQ2YjIwKTsKICAgICAgICAgICAgY29sb3I6ICNmZmY7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHggMzVweDsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgZm9udC1zaXplOiAxZW07CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTVweCByZ2JhKDIzNywgMTM3LCA1NCwgMC40KTsKICAgICAgICB9CgogICAgICAgIC8qID09PT09IENST1dEIEdST1VQUyA9PT09PSAqLwogICAgICAgIC5jcm93ZC1ncm91cCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZ2FwOiA0cHg7CiAgICAgICAgICAgIHotaW5kZXg6IDU7CiAgICAgICAgfQoKICAgICAgICAuY3Jvd2QtcGVyc29uIHsKICAgICAgICAgICAgZm9udC1zaXplOiAyLjRlbTsKICAgICAgICAgICAgYW5pbWF0aW9uOiBjcm93ZENoYXQgMS4ycyBlYXNlLWluLW91dCBpbmZpbml0ZTsKICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDNweCA1cHggcmdiYSgwLDAsMCwwLjIpKTsKICAgICAgICB9CgogICAgICAgIC5jcm93ZC1wZXJzb246bnRoLWNoaWxkKG9kZCkgeyBhbmltYXRpb24tZGVsYXk6IDAuMTVzOyB9CgogICAgICAgIEBrZXlmcmFtZXMgY3Jvd2RDaGF0IHsKICAgICAgICAgICAgMCUsIDEwMCUgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgICAgICAgICAgNTAlIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0zcHgpOyB9CiAgICAgICAgfQoKICAgICAgICAuY3Jvd2QtYnViYmxlIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IC0zNXB4OyBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZjsKICAgICAgICAgICAgY29sb3I6ICM0YTU1Njg7CiAgICAgICAgICAgIHBhZGRpbmc6IDVweCAxMnB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxNXB4OwogICAgICAgICAgICBmb250LXNpemU6IDAuNzVlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAzcHggMTBweCByZ2JhKDAsMCwwLDAuMTUpOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZTJlOGYwOwogICAgICAgIH0KCiAgICAgICAgLyogPT09PT0gTlBDcyA9PT09PSAqLwogICAgICAgIC5ucGMgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIHdpZHRoOiA4MHB4OwogICAgICAgICAgICBoZWlnaHQ6IDgwcHg7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICAgICAgICB6LWluZGV4OiAxMDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMTVzOwogICAgICAgIH0KCiAgICAgICAgLm5wYy1hdmF0YXIgewogICAgICAgICAgICBmb250LXNpemU6IDMuMmVtOwogICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgNHB4IDhweCByZ2JhKDAsMCwwLDAuMykpOwogICAgICAgICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xNXMsIGZpbHRlciAwLjE1czsKICAgICAgICB9CgogICAgICAgIC8qIEJJR0dFUiBWSUJFIElORElDQVRPUiAqLwogICAgICAgIC5ucGMtdmliZSB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOiAtMTVweDsKICAgICAgICAgICAgcmlnaHQ6IC0xNXB4OwogICAgICAgICAgICBmb250LXNpemU6IDEuMmVtOwogICAgICAgICAgICBvcGFjaXR5OiAwLjc7CiAgICAgICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzOwogICAgICAgIH0KCiAgICAgICAgLm5wYy5uZWFyYnkgLm5wYy12aWJlIHsKICAgICAgICAgICAgZm9udC1zaXplOiAyLjJlbTsKICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICAgICAgdG9wOiAtMjVweDsKICAgICAgICAgICAgcmlnaHQ6IC0yNXB4OwogICAgICAgICAgICBhbmltYXRpb246IHZpYmVQdWxzZSAwLjZzIGVhc2UtaW4tb3V0IGluZmluaXRlOwogICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAxMHB4IHJnYmEoMjU1LDI1NSwyNTUsMC44KSk7CiAgICAgICAgfQoKICAgICAgICBAa2V5ZnJhbWVzIHZpYmVQdWxzZSB7CiAgICAgICAgICAgIDAlLCAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZSgxKTsgfQogICAgICAgICAgICA1MCUgeyB0cmFuc2Zvcm06IHNjYWxlKDEuMik7IH0KICAgICAgICB9CgogICAgICAgIC5ucGMtbmFtZS10YWcgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGJvdHRvbTogLTI4cHg7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmZmY7CiAgICAgICAgICAgIGNvbG9yOiAjMmQzNzQ4OwogICAgICAgICAgICBwYWRkaW5nOiA1cHggMTRweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTVweDsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjhlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjJzOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZjZhZDU1OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDJweCA4cHggcmdiYSgwLDAsMCwwLjE1KTsKICAgICAgICB9CgogICAgICAgIC5ucGMubmVhcmJ5IC5ucGMtbmFtZS10YWcgewogICAgICAgICAgICBvcGFjaXR5OiAxOwogICAgICAgIH0KCiAgICAgICAgLm5wYy5uZWFyYnkgLm5wYy1hdmF0YXIgewogICAgICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDEuMTUpOwogICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAyMHB4IHJnYmEoMjQ2LCAxNzMsIDg1LCAwLjgpKSBkcm9wLXNoYWRvdygwIDRweCA4cHggcmdiYSgwLDAsMCwwLjMpKTsKICAgICAgICB9CgogICAgICAgIC5ucGMuZG9uZSB7CiAgICAgICAgICAgIG9wYWNpdHk6IDAuMzsKICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgICAgfQoKICAgICAgICAubnBjLmRvbmUgLm5wYy1hdmF0YXIgewogICAgICAgICAgICBmaWx0ZXI6IGdyYXlzY2FsZSgwLjgpOwogICAgICAgIH0KCiAgICAgICAgLyogPT09PT0gUkFQUE9SVCBNRVRFUiA9PT09PSAqLwogICAgICAgIC5yYXBwb3J0LWNvbnRhaW5lciB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm90dG9tOiAtNTBweDsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgIGdhcDogM3B4OwogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuMnM7CiAgICAgICAgfQoKICAgICAgICAubnBjLm5lYXJieTpub3QoLmRvbmUpIC5yYXBwb3J0LWNvbnRhaW5lciB7CiAgICAgICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgfQoKICAgICAgICAucmFwcG9ydC1sYWJlbCB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMC42NWVtOwogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CgogICAgICAgIC5yYXBwb3J0LWJhciB7CiAgICAgICAgICAgIHdpZHRoOiA3MHB4OwogICAgICAgICAgICBoZWlnaHQ6IDhweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2UyZThmMDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjY2JkNWUwOwogICAgICAgIH0KCiAgICAgICAgLnJhcHBvcnQtZmlsbCB7CiAgICAgICAgICAgIGhlaWdodDogMTAwJTsKICAgICAgICAgICAgd2lkdGg6IDAlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoOTBkZWcsICNmNmFkNTUsICM0OGJiNzgpOwogICAgICAgICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjNzOwogICAgICAgIH0KCiAgICAgICAgLnJhcHBvcnQtZmlsbC5yZWFkeSB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCg5MGRlZywgIzQ4YmI3OCwgIzM4YTE2OSk7CiAgICAgICAgICAgIGFuaW1hdGlvbjogcmFwcG9ydFJlYWR5IDAuNXMgZWFzZS1pbi1vdXQgaW5maW5pdGU7CiAgICAgICAgfQoKICAgICAgICBAa2V5ZnJhbWVzIHJhcHBvcnRSZWFkeSB7CiAgICAgICAgICAgIDAlLCAxMDAlIHsgYm94LXNoYWRvdzogMCAwIDVweCAjNDhiYjc4OyB9CiAgICAgICAgICAgIDUwJSB7IGJveC1zaGFkb3c6IDAgMCAxNXB4ICM0OGJiNzg7IH0KICAgICAgICB9CgogICAgICAgIC8qID09PT09IFJBRElBTCBNRU5VID09PT09ICovCiAgICAgICAgLnJhZGlhbC1tZW51IHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogMzQwcHg7CiAgICAgICAgICAgIGhlaWdodDogMzQwcHg7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICAgICAgdG9wOiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjJzIGVhc2U7CiAgICAgICAgICAgIHotaW5kZXg6IDIwMDsKICAgICAgICB9CgogICAgICAgIC5ucGMubmVhcmJ5Om5vdCguZG9uZSkgLnJhZGlhbC1tZW51IHsKICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICAgICAgfQoKICAgICAgICAucmFkaWFsLWFjdGlvbiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgd2lkdGg6IDc1cHg7CiAgICAgICAgICAgIGhlaWdodDogNzVweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCAjZjZhZDU1OwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4xMnM7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCAxNXB4IHJnYmEoMCwwLDAsMC4yKTsKICAgICAgICB9CgogICAgICAgIC5yYWRpYWwtYWN0aW9uOmhvdmVyIHsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMS4yKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZmFmMDsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjZGQ2YjIwOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDZweCAyNXB4IHJnYmEoMjQ2LCAxNzMsIDg1LCAwLjUpOwogICAgICAgICAgICB6LWluZGV4OiAxMDsKICAgICAgICB9CgogICAgICAgIC5yYWRpYWwtYWN0aW9uIC5hY3Rpb24taWNvbiB7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMS42ZW07CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDFweDsKICAgICAgICB9CgogICAgICAgIC5yYWRpYWwtYWN0aW9uIC5hY3Rpb24tbGFiZWwgewogICAgICAgICAgICBmb250LXNpemU6IDAuNmVtOwogICAgICAgICAgICBjb2xvcjogIzRhNTU2ODsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICB9CgogICAgICAgIC5yYWRpYWwtYWN0aW9uIC5hY3Rpb24tY29zdCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgYm90dG9tOiAtMThweDsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjU1ZW07CiAgICAgICAgICAgIGNvbG9yOiAjZTUzZTNlOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICAgICAgICBwYWRkaW5nOiAycHggNXB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA2cHg7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMXB4IDRweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgICAgfQoKICAgICAgICAucmFkaWFsLWFjdGlvbi5leGl0LWFjdGlvbiB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNjNmY2ZDU7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogIzQ4YmI3ODsKICAgICAgICB9CgogICAgICAgIC5yYWRpYWwtYWN0aW9uLmV4aXQtYWN0aW9uOmhvdmVyIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzlhZTZiNDsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjMzhhMTY5OwogICAgICAgIH0KCiAgICAgICAgLnJhZGlhbC1jZW50ZXIgewogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsgdG9wOiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICAgICAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2UyZThmMDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAycHggMTBweCByZ2JhKDAsMCwwLDAuMSk7CiAgICAgICAgfQoKICAgICAgICAucmFkaWFsLWNlbnRlciAucmMtbmFtZSB7CiAgICAgICAgICAgIGNvbG9yOiAjMmQzNzQ4OwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBmb250LXNpemU6IDAuOGVtOwogICAgICAgIH0KCiAgICAgICAgLnJhZGlhbC1jZW50ZXIgLnJjLXJvbGUgewogICAgICAgICAgICBjb2xvcjogIzcxODA5NjsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjY1ZW07CiAgICAgICAgfQoKICAgICAgICAvKiA9PT09PSBQTEFZRVIgPT09PT0gKi8KICAgICAgICAjcGxheWVyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogNjBweDsKICAgICAgICAgICAgaGVpZ2h0OiA2MHB4OwogICAgICAgICAgICB6LWluZGV4OiA1MDsKICAgICAgICB9CgogICAgICAgIC5wbGF5ZXItYXZhdGFyIHsKICAgICAgICAgICAgZm9udC1zaXplOiAzZW07CiAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDE1cHggcmdiYSg3MiwgMTg3LCAxMjAsIDAuNykpOwogICAgICAgIH0KCiAgICAgICAgLnBsYXllci15b3UtdGFnIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB0b3A6IC0yMnB4OyBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKTsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgIzQ4YmI3OCwgIzM4YTE2OSk7CiAgICAgICAgICAgIGNvbG9yOiAjZmZmOwogICAgICAgICAgICBwYWRkaW5nOiA0cHggMTJweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjdlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAzcHggMTBweCByZ2JhKDcyLCAxODcsIDEyMCwgMC40KTsKICAgICAgICB9CgogICAgICAgIC8qID09PT09IE9VVENPTUUgVE9BU1QgPT09PT0gKi8KICAgICAgICAjb3V0Y29tZS10b2FzdCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICAgdG9wOiAxMjBweDsgbGVmdDogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoLTUwJSk7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmZmY7CiAgICAgICAgICAgIGJvcmRlcjogM3B4IHNvbGlkICNmNmFkNTU7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7CiAgICAgICAgICAgIHBhZGRpbmc6IDE4cHggMjhweDsKICAgICAgICAgICAgei1pbmRleDogNDAwOwogICAgICAgICAgICBkaXNwbGF5OiBub25lOwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIG1heC13aWR0aDogMzgwcHg7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMTVweCA1MHB4IHJnYmEoMCwwLDAsMC4yKTsKICAgICAgICB9CgogICAgICAgICNvdXRjb21lLXRvYXN0LmFjdGl2ZSB7CiAgICAgICAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgICAgICAgICBhbmltYXRpb246IHRvYXN0UG9wIDAuMjVzIGVhc2U7CiAgICAgICAgfQoKICAgICAgICBAa2V5ZnJhbWVzIHRvYXN0UG9wIHsKICAgICAgICAgICAgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKSB0cmFuc2xhdGVZKC0xNXB4KSBzY2FsZSgwLjk1KTsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNTAlKSB0cmFuc2xhdGVZKDApIHNjYWxlKDEpOyBvcGFjaXR5OiAxOyB9CiAgICAgICAgfQoKICAgICAgICAudG9hc3QtaWNvbiB7IGZvbnQtc2l6ZTogMi41ZW07IG1hcmdpbi1ib3R0b206IDhweDsgfQogICAgICAgIC50b2FzdC10aXRsZSB7IGNvbG9yOiAjMmQzNzQ4OyBmb250LXNpemU6IDEuMmVtOyBmb250LXdlaWdodDogNzAwOyBtYXJnaW4tYm90dG9tOiA2cHg7IH0KICAgICAgICAudG9hc3QtbWVzc2FnZSB7IGNvbG9yOiAjNzE4MDk2OyBmb250LXNpemU6IDAuOWVtOyBtYXJnaW4tYm90dG9tOiAxMHB4OyBmb250LXN0eWxlOiBpdGFsaWM7IH0KICAgICAgICAudG9hc3QtZWZmZWN0cyB7IGZvbnQtc2l6ZTogMC44NWVtOyB9CiAgICAgICAgLnRvYXN0LWVmZmVjdCB7IHBhZGRpbmc6IDNweCAwOyB9CiAgICAgICAgLnRvYXN0LWVmZmVjdC5wb3NpdGl2ZSB7IGNvbG9yOiAjMzhhMTY5OyB9CiAgICAgICAgLnRvYXN0LWVmZmVjdC5uZWdhdGl2ZSB7IGNvbG9yOiAjZTUzZTNlOyB9CiAgICAgICAgLnRvYXN0LWVmZmVjdC5uZXV0cmFsIHsgY29sb3I6ICNkZDZiMjA7IH0KCiAgICAgICAgLyogPT09PT0gU1RBUlQgU0NSRUVOID09PT09ICovCiAgICAgICAgI3N0YXJ0LXNjcmVlbiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICAgdG9wOiAwOyBsZWZ0OiAwOyByaWdodDogMDsgYm90dG9tOiAwOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjZjdlOGQ1IDAlLCAjZWZlMGM5IDUwJSwgI2U4ZDRiOCAxMDAlKTsKICAgICAgICAgICAgei1pbmRleDogNTAwOwogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogZmxleC1zdGFydDsKICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICAgICAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICAgICAgICAgIHBhZGRpbmc6IDE1cHg7CiAgICAgICAgfQoKICAgICAgICAuc3RhcnQtY29udGVudCB7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICAgICAgbWF4LXdpZHRoOiA2NTBweDsKICAgICAgICAgICAgcGFkZGluZzogMjJweDsKICAgICAgICAgICAgbWFyZ2luOiBhdXRvOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyNXB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDEwcHggNDBweCByZ2JhKDAsMCwwLDAuMTUpOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCAjZjZhZDU1OwogICAgICAgIH0KCiAgICAgICAgLnN0YXJ0LWNvbnRlbnQgaDEgewogICAgICAgICAgICBjb2xvcjogIzJjNTI4MjsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjllbTsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNXB4OwogICAgICAgIH0KCiAgICAgICAgLnN0YXJ0LWNvbnRlbnQgaDEgc3BhbiB7IGNvbG9yOiAjZWQ4OTM2OyB9CgogICAgICAgIC5zdGFydC1zdWJ0aXRsZSB7CiAgICAgICAgICAgIGNvbG9yOiAjODA1YWQ1OwogICAgICAgICAgICBmb250LXN0eWxlOiBpdGFsaWM7CiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMC45NWVtOwogICAgICAgIH0KCiAgICAgICAgLnN0YXJ0LXN0b3J5IHsKICAgICAgICAgICAgY29sb3I6ICM0YTU1Njg7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OiAxLjU1OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICAgICAgICBmb250LXNpemU6IDAuOWVtOwogICAgICAgIH0KCiAgICAgICAgLnN0YXJ0LXN0b3J5IHAgeyBtYXJnaW4tYm90dG9tOiA4cHg7IH0KCiAgICAgICAgLmNvbnRyb2xzLWJveCwgLmFjdGlvbnMtc2hvd2Nhc2UsIC5vYmplY3RpdmVzLWJveCwgLnRpcC1ib3ggewogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICAgICAgICBwYWRkaW5nOiAxMnB4OwogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAxMnB4OwogICAgICAgICAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgLmNvbnRyb2xzLWJveCB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNlYmY4ZmY7CiAgICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICM0Mjk5ZTE7CiAgICAgICAgfQoKICAgICAgICAuY29udHJvbHMtYm94IGgzIHsgY29sb3I6ICMyYjZjYjA7IG1hcmdpbi1ib3R0b206IDhweDsgZm9udC1zaXplOiAwLjllbTsgfQoKICAgICAgICAuY29udHJvbC1yb3cgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDhweDsKICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNnB4OwogICAgICAgICAgICBjb2xvcjogIzRhNTU2ODsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjg1ZW07CiAgICAgICAgfQoKICAgICAgICAua2V5LWJhZGdlIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzJjNTI4MjsKICAgICAgICAgICAgcGFkZGluZzogM3B4IDhweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgICAgICAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgICAgICAgICBjb2xvcjogI2ZmZjsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjhlbTsKICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICB9CgogICAgICAgIC5hY3Rpb25zLXNob3djYXNlIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZhZjVmZjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgIzgwNWFkNTsKICAgICAgICB9CgogICAgICAgIC5hY3Rpb25zLXNob3djYXNlIGgzIHsgY29sb3I6ICM1NTNjOWE7IG1hcmdpbi1ib3R0b206IDEwcHg7IGZvbnQtc2l6ZTogMC45ZW07IHRleHQtYWxpZ246IGNlbnRlcjsgfQoKICAgICAgICAuYWN0aW9ucy1ncmlkIHsKICAgICAgICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoYXV0by1maXQsIG1pbm1heCgxMzBweCwgMWZyKSk7CiAgICAgICAgICAgIGdhcDogOHB4OwogICAgICAgIH0KCiAgICAgICAgLmFjdGlvbi1jYXJkIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2ZmZjsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2U5ZDhmZDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBwYWRkaW5nOiA4cHg7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICB9CgogICAgICAgIC5hY3Rpb24tY2FyZCAuY2FyZC1pY29uIHsgZm9udC1zaXplOiAxLjVlbTsgbWFyZ2luLWJvdHRvbTogMnB4OyB9CiAgICAgICAgLmFjdGlvbi1jYXJkIC5jYXJkLW5hbWUgeyBmb250LXdlaWdodDogNzAwOyBjb2xvcjogIzU1M2M5YTsgZm9udC1zaXplOiAwLjhlbTsgbWFyZ2luLWJvdHRvbTogMnB4OyB9CiAgICAgICAgLmFjdGlvbi1jYXJkIC5jYXJkLWRlc2MgeyBmb250LXNpemU6IDAuNjhlbTsgY29sb3I6ICM3MTgwOTY7IGxpbmUtaGVpZ2h0OiAxLjI1OyB9CiAgICAgICAgLmFjdGlvbi1jYXJkIC5jYXJkLWNvc3QgeyBmb250LXNpemU6IDAuNjVlbTsgY29sb3I6ICNlNTNlM2U7IG1hcmdpbi10b3A6IDNweDsgZm9udC13ZWlnaHQ6IDYwMDsgfQoKICAgICAgICAuYWN0aW9uLWNhcmQuZXhpdC1jYXJkIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2YwZmZmNDsKICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjOWFlNmI0OwogICAgICAgIH0KICAgICAgICAuYWN0aW9uLWNhcmQuZXhpdC1jYXJkIC5jYXJkLW5hbWUgeyBjb2xvcjogIzI3Njc0OTsgfQoKICAgICAgICAub2JqZWN0aXZlcy1ib3ggewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjBmZmY0OwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjNDhiYjc4OwogICAgICAgIH0KCiAgICAgICAgLm9iamVjdGl2ZXMtYm94IGgzIHsgY29sb3I6ICMyNzY3NDk7IG1hcmdpbi1ib3R0b206IDhweDsgZm9udC1zaXplOiAwLjllbTsgfQogICAgICAgIC5vYmplY3RpdmVzLWJveCB1bCB7IGNvbG9yOiAjNGE1NTY4OyBtYXJnaW4tbGVmdDogMTZweDsgZm9udC1zaXplOiAwLjg1ZW07IH0KICAgICAgICAub2JqZWN0aXZlcy1ib3ggbGkgeyBtYXJnaW4tYm90dG9tOiA0cHg7IH0KCiAgICAgICAgLnRpcC1ib3ggewogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmYWYwOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZWQ4OTM2OwogICAgICAgICAgICBjb2xvcjogIzRhNTU2ODsKICAgICAgICAgICAgZm9udC1zaXplOiAwLjgyZW07CiAgICAgICAgfQoKICAgICAgICAudGlwLWJveCBzdHJvbmcgeyBjb2xvcjogI2MwNTYyMTsgfQoKICAgICAgICAudmliZXMtbGVnZW5kIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgZ2FwOiAxNXB4OwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgbWFyZ2luLXRvcDogOHB4OwogICAgICAgICAgICBmbGV4LXdyYXA6IHdyYXA7CiAgICAgICAgfQoKICAgICAgICAudmliZS1pdGVtIHsKICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgZ2FwOiA0cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMC44NWVtOwogICAgICAgIH0KCiAgICAgICAgLnZpYmUtaXRlbSBzcGFuOmZpcnN0LWNoaWxkIHsgZm9udC1zaXplOiAxLjNlbTsgfQoKICAgICAgICAuc3RhcnQtYnRuIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgI2VkODkzNiwgI2RkNmIyMCk7CiAgICAgICAgICAgIGNvbG9yOiAjZmZmOwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIHBhZGRpbmc6IDE0cHggNDBweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMzBweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjE1ZW07CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMnMsIGJveC1zaGFkb3cgMC4yczsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA4cHggMzBweCByZ2JhKDIzNywgMTM3LCA1NCwgMC40KTsKICAgICAgICB9CgogICAgICAgIC5zdGFydC1idG46aG92ZXIgewogICAgICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDEuMDUpOwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDEycHggNDBweCByZ2JhKDIzNywgMTM3LCA1NCwgMC42KTsKICAgICAgICB9CgogICAgICAgIC8qID09PT09IEVORCBTQ1JFRU4gPT09PT0gKi8KICAgICAgICAjZW5kLXNjcmVlbiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICAgdG9wOiAwOyBsZWZ0OiAwOyByaWdodDogMDsgYm90dG9tOiAwOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjZjdlOGQ1IDAlLCAjZWZlMGM5IDUwJSwgI2U4ZDRiOCAxMDAlKTsKICAgICAgICAgICAgei1pbmRleDogNTAwOwogICAgICAgICAgICBkaXNwbGF5OiBub25lOwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICAgICAgb3ZlcmZsb3cteTogYXV0bzsKICAgICAgICAgICAgcGFkZGluZzogMjBweDsKICAgICAgICB9CgogICAgICAgICNlbmQtc2NyZWVuLmFjdGl2ZSB7IGRpc3BsYXk6IGZsZXg7IH0KCiAgICAgICAgLmVuZC1jb250ZW50IHsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICBtYXgtd2lkdGg6IDUwMHB4OwogICAgICAgICAgICBwYWRkaW5nOiAyOHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyNXB4OwogICAgICAgICAgICBib3gtc2hhZG93OiAwIDEwcHggNDBweCByZ2JhKDAsMCwwLDAuMTUpOwogICAgICAgICAgICBib3JkZXI6IDNweCBzb2xpZCAjZjZhZDU1OwogICAgICAgIH0KCiAgICAgICAgLmVuZC1jb250ZW50IGgxIHsgZm9udC1zaXplOiAxLjhlbTsgbWFyZ2luLWJvdHRvbTogMTBweDsgfQogICAgICAgIC5lbmQtY29udGVudCBoMS5zdWNjZXNzIHsgY29sb3I6ICMzOGExNjk7IH0KICAgICAgICAuZW5kLWNvbnRlbnQgaDEucGFydGlhbCB7IGNvbG9yOiAjZGQ2YjIwOyB9CiAgICAgICAgLmVuZC1jb250ZW50IGgxLmZhaWx1cmUgeyBjb2xvcjogI2U1M2UzZTsgfQoKICAgICAgICAuZW5kLXNjb3JlIHsKICAgICAgICAgICAgZm9udC1zaXplOiAzLjhlbTsKICAgICAgICAgICAgY29sb3I6ICMyYzUyODI7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIG1hcmdpbjogMTJweCAwOwogICAgICAgIH0KCiAgICAgICAgLmVuZC1zdW1tYXJ5IHsKICAgICAgICAgICAgYmFja2dyb3VuZDogI2Y3ZmFmYzsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2UyZThmMDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgICAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICAgICAgbWFyZ2luOiAxNXB4IDA7CiAgICAgICAgICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICAgICAgICAgIGNvbG9yOiAjNGE1NTY4OwogICAgICAgICAgICBtYXgtaGVpZ2h0OiAxNjBweDsKICAgICAgICAgICAgb3ZlcmZsb3cteTogYXV0bzsKICAgICAgICB9CgogICAgICAgIC5lbmQtc3VtbWFyeSBoMyB7IGNvbG9yOiAjMmM1MjgyOyBtYXJnaW4tYm90dG9tOiA4cHg7IGZvbnQtc2l6ZTogMC45NWVtOyB9CgogICAgICAgIC5zdW1tYXJ5LWl0ZW0gewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBnYXA6IDhweDsKICAgICAgICAgICAgcGFkZGluZzogNXB4IDA7CiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjZTJlOGYwOwogICAgICAgICAgICBmb250LXNpemU6IDAuODVlbTsKICAgICAgICB9CgogICAgICAgIC5zdW1tYXJ5LWl0ZW06bGFzdC1jaGlsZCB7IGJvcmRlci1ib3R0b206IG5vbmU7IH0KCiAgICAgICAgLnJlc3RhcnQtYnRuIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgI2VkODkzNiwgI2RkNmIyMCk7CiAgICAgICAgICAgIGNvbG9yOiAjZmZmOwogICAgICAgICAgICBib3JkZXI6IG5vbmU7CiAgICAgICAgICAgIHBhZGRpbmc6IDEycHggMzVweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjVweDsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjA1ZW07CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICAgICAgbWFyZ2luLXRvcDogMTJweDsKICAgICAgICB9CgogICAgICAgIC5jb250aW51ZS1idG4gewogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNDhiYjc4LCAjMzhhMTY5KTsKICAgICAgICAgICAgY29sb3I6ICNmZmY7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgcGFkZGluZzogMTRweCA0MHB4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyNXB4OwogICAgICAgICAgICBmb250LXNpemU6IDEuMWVtOwogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIG1hcmdpbi10b3A6IDEwcHg7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNnB4IDIwcHggcmdiYSg3MiwgMTg3LCAxMjAsIDAuNCk7CiAgICAgICAgICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjJzLCBib3gtc2hhZG93IDAuMnM7CiAgICAgICAgfQoKICAgICAgICAuY29udGludWUtYnRuOmhvdmVyIHsKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjA1KTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCA4cHggMjVweCByZ2JhKDcyLCAxODcsIDEyMCwgMC42KTsKICAgICAgICB9CgogICAgICAgIC8qID09PT09IE1JTklNQVAgPT09PT0gKi8KICAgICAgICAjbWluaW1hcCB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICAgICAgYm90dG9tOiAxNXB4OyByaWdodDogMTVweDsKICAgICAgICAgICAgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDEwMHB4OwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LDAuOTUpOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjZjZhZDU1OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMHB4OwogICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICB6LWluZGV4OiAxMDA7CiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDE1cHggcmdiYSgwLDAsMCwwLjE1KTsKICAgICAgICB9CgogICAgICAgIC5taW5pbWFwLXJvb20geyB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBwb3NpdGlvbjogcmVsYXRpdmU7IGJhY2tncm91bmQ6ICNmYWY1ZjA7IH0KCiAgICAgICAgLm1pbmltYXAtcGxheWVyIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogOHB4OyBoZWlnaHQ6IDhweDsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzQ4YmI3ODsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDZweCAjNDhiYjc4OwogICAgICAgIH0KCiAgICAgICAgLm1pbmltYXAtbnBjIHsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICB3aWR0aDogNXB4OyBoZWlnaHQ6IDVweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICB9CgogICAgICAgIC5taW5pbWFwLW5wYy5hdmFpbGFibGUgeyBiYWNrZ3JvdW5kOiAjZjZhZDU1OyB9CiAgICAgICAgLm1pbmltYXAtbnBjLmRvbmUgeyBiYWNrZ3JvdW5kOiAjY2JkNWUwOyB9CiAgICAgICAgLm1pbmltYXAtY3Jvd2QgeyBiYWNrZ3JvdW5kOiAjYTBhZWMwOyBvcGFjaXR5OiAwLjQ7IHdpZHRoOiA4cHg7IGhlaWdodDogOHB4OyB9CgogICAgICAgIC8qID09PT09IE1PQklMRSBDT05UUk9MUyA9PT09PSAqLwogICAgICAgICNtb2JpbGUtY29udHJvbHMgewogICAgICAgICAgICBkaXNwbGF5OiBub25lOwogICAgICAgICAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICAgICAgICAgIGJvdHRvbTogMTVweDsgbGVmdDogMTVweDsKICAgICAgICAgICAgei1pbmRleDogMTAwOwogICAgICAgIH0KCiAgICAgICAgLmRwYWQgewogICAgICAgICAgICBkaXNwbGF5OiBncmlkOwogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCgzLCA1MHB4KTsKICAgICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1yb3dzOiByZXBlYXQoMywgNTBweCk7CiAgICAgICAgICAgIGdhcDogNHB4OwogICAgICAgIH0KCiAgICAgICAgLmRwYWQtYnRuIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgI2VkODkzNiwgI2RkNmIyMCk7CiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICAgICAgY29sb3I6ICNmZmY7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMS40ZW07CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgICB9CgogICAgICAgIC5kcGFkLWJ0bjphY3RpdmUgeyB0cmFuc2Zvcm06IHNjYWxlKDAuOTUpOyB9CgogICAgICAgIEBtZWRpYSAobWF4LXdpZHRoOiA3NjhweCkgewogICAgICAgICAgICAjbW9iaWxlLWNvbnRyb2xzIHsgZGlzcGxheTogYmxvY2s7IH0KICAgICAgICAgICAgI21pbmltYXAgeyBib3R0b206IDgwcHg7IH0KICAgICAgICB9CgogICAgICAgIC5oaWRkZW4geyBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7IH0KICAgIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CiAgICA8IS0tIFNUQVJUIFNDUkVFTiAtLT4KICAgIDxkaXYgaWQ9InN0YXJ0LXNjcmVlbiI+CiAgICAgICAgPGRpdiBjbGFzcz0ic3RhcnQtY29udGVudCI+CiAgICAgICAgICAgIDxoMT7wn46JIFRoZSA8c3Bhbj5OZXB0dW5lPC9zcGFuPiBSZWNlcHRpb248L2gxPgogICAgICAgICAgICA8cCBjbGFzcz0ic3RhcnQtc3VidGl0bGUiPk5ldHdvcmsgWW91ciBXYXkgdG8gU3VjY2VzcyE8L3A+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJzdGFydC1zdG9yeSI+CiAgICAgICAgICAgICAgICA8cD5UaGUgamF6eiBiYW5kIGlzIHBsYXlpbmcgYXQgPHN0cm9uZz5OZXB0dW5lIENvcnAncyBhbm51YWwgcmVjZXB0aW9uPC9zdHJvbmc+ISBZb3UgaGF2ZSA8c3Ryb25nPjkwIFNFQ09ORFM8L3N0cm9uZz4gdG8gd29yayB0aGlzIHJvb20gYmVmb3JlIGRpbm5lci48L3A+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBjbGFzcz0iaG93dG8tYm94IiBzdHlsZT0iYmFja2dyb3VuZDojZmZmM2UwO2JvcmRlcjoycHggc29saWQgI2ZmOTgwMDtib3JkZXItcmFkaXVzOjEycHg7cGFkZGluZzoxNHB4O21hcmdpbi1ib3R0b206MTJweDsiPgogICAgICAgICAgICAgICAgPGgzIHN0eWxlPSJjb2xvcjojZTY1MTAwO21hcmdpbi1ib3R0b206MTBweDtmb250LXNpemU6MWVtO3RleHQtYWxpZ246Y2VudGVyOyI+4q2QIEhvdyBDb252ZXJzYXRpb25zIFdvcmsg4q2QPC9oMz4KICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtnYXA6OHB4O2FsaWduLWl0ZW1zOmZsZXgtc3RhcnQ7bWFyZ2luLWJvdHRvbToxMHB4OyI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDojZTNmMmZkO2JvcmRlcjoycHggc29saWQgIzIxOTZmMztib3JkZXItcmFkaXVzOjhweDtwYWRkaW5nOjEwcHg7ZmxleDoxO3RleHQtYWxpZ246Y2VudGVyOyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxLjNlbTttYXJnaW4tYm90dG9tOjRweDsiPvCfmITwn4yf4p2TPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OjcwMDtjb2xvcjojMTU2NWMwO2ZvbnQtc2l6ZTowLjg1ZW07Ij4xLiBCcmVhayBJY2U8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVlbTtjb2xvcjojNjY2OyI+U3RhcnQgd2l0aCBKb2tlLCBDb21wbGltZW50LCBvciBBc2s8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MmVtO3BhZGRpbmctdG9wOjIwcHg7Ij7ihpI8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiNmZmYzZTA7Ym9yZGVyOjJweCBzb2xpZCAjZmY5ODAwO2JvcmRlci1yYWRpdXM6OHB4O3BhZGRpbmc6MTBweDtmbGV4OjE7dGV4dC1hbGlnbjpjZW50ZXI7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEuM2VtO21hcmdpbi1ib3R0b206NHB4OyI+8J+RgvCfk5bwn5K8PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OjcwMDtjb2xvcjojZTY1MTAwO2ZvbnQtc2l6ZTowLjg1ZW07Ij4yLiBHbyBEZWVwZXI8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVlbTtjb2xvcjojNjY2OyI+VGhlbiBMaXN0ZW4sIFN0b3J5LCBvciBCdXNpbmVzczwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZToyZW07cGFkZGluZy10b3A6MjBweDsiPuKGkjwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6I2M4ZTZjOTtib3JkZXI6MnB4IHNvbGlkICM0Y2FmNTA7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzoxMHB4O2ZsZXg6MTt0ZXh0LWFsaWduOmNlbnRlcjsiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MS4zZW07bWFyZ2luLWJvdHRvbTo0cHg7Ij7wn5GLPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OjcwMDtjb2xvcjojMmU3ZDMyO2ZvbnQtc2l6ZTowLjg1ZW07Ij4zLiBXcmFwIFVwITwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43NWVtO2NvbG9yOiM2NjY7Ij5GaW5pc2ggJiBnZXQgcmV3YXJkcyE8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDojZThmNWU5O2JvcmRlci1yYWRpdXM6OHB4O3BhZGRpbmc6OHB4O3RleHQtYWxpZ246Y2VudGVyO2ZvbnQtc2l6ZTowLjg1ZW07Ij4KICAgICAgICAgICAgICAgICAgICA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMmU3ZDMyOyI+8J+SoSBUaXA6PC9zdHJvbmc+IExpZ2h0IG9wZW5lcnMgZmlyc3QsIHRoZW4gZGVlcGVyIHRvcGljcyA9IEJJRyByYXBwb3J0IGJvbnVzIQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMtYm94Ij4KICAgICAgICAgICAgICAgIDxoMz7wn46uIENvbnRyb2xzPC9oMz4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2wtcm93Ij4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ia2V5LWJhZGdlIj5XQVNEPC9zcGFuPiBvciA8c3BhbiBjbGFzcz0ia2V5LWJhZGdlIj7ihpHihpPihpDihpI8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4+TW92ZSBhcm91bmQgdGhlIHJvb208L3NwYW4+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2wtcm93Ij4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ia2V5LWJhZGdlIj5DTElDSzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8c3Bhbj5DbGljayBhY3Rpb25zIG9uIHRoZSB3aGVlbCBhcm91bmQgZWFjaCBwZXJzb248L3NwYW4+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpb25zLXNob3djYXNlIj4KICAgICAgICAgICAgICAgIDxoMz7wn46tIFlvdXIgU29jaWFsIE1vdmVzPC9oMz4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbnMtZ3JpZCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aW9uLWNhcmQiIHN0eWxlPSJiYWNrZ3JvdW5kOiNlM2YyZmQ7Ym9yZGVyLWNvbG9yOiMyMTk2ZjM7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1pY29uIj7wn5iEPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtbmFtZSIgc3R5bGU9ImNvbG9yOiMxNTY1YzA7Ij5Kb2tlPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtZGVzYyI+SUNFIEJSRUFLRVI8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1jb3N0Ij4tNCDwn5KsPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aW9uLWNhcmQiIHN0eWxlPSJiYWNrZ3JvdW5kOiNlM2YyZmQ7Ym9yZGVyLWNvbG9yOiMyMTk2ZjM7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1pY29uIj7wn4yfPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtbmFtZSIgc3R5bGU9ImNvbG9yOiMxNTY1YzA7Ij5Db21wbGltZW50PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtZGVzYyI+SUNFIEJSRUFLRVI8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1jb3N0Ij4tNCDwn5KsPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYWN0aW9uLWNhcmQiIHN0eWxlPSJiYWNrZ3JvdW5kOiNlM2YyZmQ7Ym9yZGVyLWNvbG9yOiMyMTk2ZjM7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1pY29uIj7inZM8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1uYW1lIiBzdHlsZT0iY29sb3I6IzE1NjVjMDsiPkFzazwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLWRlc2MiPklDRSBCUkVBS0VSPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtY29zdCI+LTQg8J+SrDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFjdGlvbi1jYXJkIiBzdHlsZT0iYmFja2dyb3VuZDojZmZmM2UwO2JvcmRlci1jb2xvcjojZmY5ODAwOyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtaWNvbiI+8J+RgjwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLW5hbWUiIHN0eWxlPSJjb2xvcjojZTY1MTAwOyI+TGlzdGVuPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtZGVzYyI+QUZURVIgb3BlbmVyITwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLWNvc3QiPi02IPCfkqw8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpb24tY2FyZCIgc3R5bGU9ImJhY2tncm91bmQ6I2ZmZjNlMDtib3JkZXItY29sb3I6I2ZmOTgwMDsiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLWljb24iPvCfk5Y8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1uYW1lIiBzdHlsZT0iY29sb3I6I2U2NTEwMDsiPlN0b3J5PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtZGVzYyI+QUZURVIgb3BlbmVyITwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLWNvc3QiPi04IPCfkqw8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpb24tY2FyZCIgc3R5bGU9ImJhY2tncm91bmQ6I2ZmZjNlMDtib3JkZXItY29sb3I6I2ZmOTgwMDsiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLWljb24iPvCfkrw8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1uYW1lIiBzdHlsZT0iY29sb3I6I2U2NTEwMDsiPkJ1c2luZXNzPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtZGVzYyI+QUZURVIgb3BlbmVyITwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkLWNvc3QiPi04IPCfkqw8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJhY3Rpb24tY2FyZCBleGl0LWNhcmQiIHN0eWxlPSJib3JkZXItd2lkdGg6M3B4O2JveC1zaGFkb3c6MCAwIDEwcHggcmdiYSg3MiwxODcsMTIwLDAuNCk7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1pY29uIj7wn5GLPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtbmFtZSIgc3R5bGU9ImZvbnQtc2l6ZTowLjllbTsiPldSQVAgVVA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1kZXNjIj48c3Ryb25nPkZpbmlzaGVzIGNoYXQhPC9zdHJvbmc+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtY29zdCIgc3R5bGU9ImNvbG9yOiMyZTdkMzI7Ij5GUkVFIOKckzwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJvYmplY3RpdmVzLWJveCI+CiAgICAgICAgICAgICAgICA8aDM+8J+OryBSZXNvdXJjZXMgJiBUaGVpciBCZW5lZml0czwvaDM+CiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmdyaWQ7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOjFmciAxZnI7Z2FwOjhweDttYXJnaW4tdG9wOjhweDsiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6I2ZmZjtib3JkZXI6MnB4IHNvbGlkICM0OGJiNzg7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzo4cHg7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NzAwO2NvbG9yOiMyNzY3NDk7Ij7wn5KwIEJ1ZGdldDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43NWVtO2NvbG9yOiM2NjY7Ij4rMjAg4pqhIGVuZXJneSBib29zdDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43ZW07Y29sb3I6Izg4ODsiPkZyb206IE1hcmdhcmV0ICjwn5K8IEJ1c2luZXNzKTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6I2ZmZjtib3JkZXI6MnB4IHNvbGlkICM0OGJiNzg7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzo4cHg7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6NzAwO2NvbG9yOiMyNzY3NDk7Ij7irZAgQ2hhbXBpb248L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVlbTtjb2xvcjojNjY2OyI+KzI1IPCfkqwgc29jaWFsIGJvb3N0PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjdlbTtjb2xvcjojODg4OyI+RnJvbTogUmljaGFyZCAo8J+TliBTdG9yeSk8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiNmZmY7Ym9yZGVyOjJweCBzb2xpZCAjNDhiYjc4O2JvcmRlci1yYWRpdXM6OHB4O3BhZGRpbmc6OHB4OyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OjcwMDtjb2xvcjojMjc2NzQ5OyI+8J+UpyBUZWNoIEhlbHA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVlbTtjb2xvcjojNjY2OyI+KzE1IOKaoSArMTUg8J+SrCBib29zdDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MC43ZW07Y29sb3I6Izg4ODsiPkZyb206IEFpc2hhICjinZMgUXVlc3Rpb24pPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iYmFja2dyb3VuZDojZmZmO2JvcmRlcjoycHggc29saWQgIzQ4YmI3ODtib3JkZXItcmFkaXVzOjhweDtwYWRkaW5nOjhweDsiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDo3MDA7Y29sb3I6IzI3Njc0OTsiPvCfjq8gSW50ZWw8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjAuNzVlbTtjb2xvcjojNjY2OyI+KzIwIPCfkqwgc29jaWFsIGJvb3N0PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTowLjdlbTtjb2xvcjojODg4OyI+RnJvbTogSmFtZXMgKPCfkYIgTGlzdGVuKTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPGRpdiBjbGFzcz0idGlwLWJveCI+CiAgICAgICAgICAgICAgICA8c3Ryb25nPvCfkqEgRWFzeSB3aW5zOjwvc3Ryb25nPiBKdXN0IDIgYWN0aW9ucyB1c3VhbGx5IGZpbGxzIHRoZSByYXBwb3J0IGJhciEgV2hlbiBpdCB0dXJucyA8c3BhbiBzdHlsZT0iY29sb3I6IzM4YTE2OTtmb250LXdlaWdodDpib2xkOyI+Z3JlZW48L3NwYW4+LCBjbGljayA8c3Ryb25nIHN0eWxlPSJjb2xvcjojMmU3ZDMyOyI+8J+RiyBXcmFwIFVwPC9zdHJvbmc+IHRvIGdldCB5b3VyIHJld2FyZC4gRWFjaCByZXNvdXJjZSBnaXZlcyB5b3UgYm9udXMgZW5lcmd5ISBWaXNpdCBNYXJjdXMg8J+NuCBhbnl0aW1lIGZvciBhIGJpZyByZWNoYXJnZS4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InZpYmVzLWxlZ2VuZCI+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idmliZS1pdGVtIj48c3Bhbj7inKg8L3NwYW4+IEtleSBjb250YWN0PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idmliZS1pdGVtIj48c3Bhbj7wn5iQPC9zcGFuPiBGcmllbmRseSAoK2JvbnVzKTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InZpYmUtaXRlbSI+PHNwYW4+4pqg77iPPC9zcGFuPiBBdm9pZCBpZiBidXN5PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idmliZS1pdGVtIj48c3Bhbj7wn5KaPC9zcGFuPiBSZWNoYXJnZSBoZXJlITwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAKICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0ic3RhcnQtYnRuIiBvbmNsaWNrPSJzdGFydEdhbWUoKSI+8J+lgiBKb2luIHRoZSBSZWNlcHRpb24hPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KCiAgICA8IS0tIEdBTUUgV1JBUFBFUiAtLT4KICAgIDxkaXYgaWQ9ImdhbWUtd3JhcHBlciIgY2xhc3M9ImhpZGRlbiI+CiAgICAgICAgPGRpdiBpZD0iaHVkIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iaHVkLWxlZnQiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iaHVkLXRpdGxlIj7wn46JIE5lcHR1bmUgUmVjZXB0aW9uPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJodWQtc3RhdCI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4+4pqhPC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQtYmFyIj48ZGl2IGlkPSJlbmVyZ3ktYmFyIiBjbGFzcz0ic3RhdC1maWxsIGVuZXJneS1maWxsIiBzdHlsZT0id2lkdGg6MTAwJSI+PC9kaXY+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9ImVuZXJneS10ZXh0Ij4xMDA8L3NwYW4+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Imh1ZC1zdGF0Ij4KICAgICAgICAgICAgICAgICAgICA8c3Bhbj7wn5KsPC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InN0YXQtYmFyIj48ZGl2IGlkPSJzb2NpYWwtYmFyIiBjbGFzcz0ic3RhdC1maWxsIHNvY2lhbC1maWxsIiBzdHlsZT0id2lkdGg6MTAwJSI+PC9kaXY+PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9InNvY2lhbC10ZXh0Ij4zMDA8L3NwYW4+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9Imh1ZC1yaWdodCI+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGlkPSJtdXNpYy1idG4iIGNsYXNzPSJtdXNpYy1idG4iIG9uY2xpY2s9InRvZ2dsZU11c2ljKCkiPvCflIcgTXVzaWM8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9InRpbWVyIiBjbGFzcz0iaHVkLXRpbWVyIj7ij7HvuI8gMTozMDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KCiAgICAgICAgPGRpdiBpZD0icmVzb3VyY2VzLWJhciI+CiAgICAgICAgICAgIDxkaXYgaWQ9InJlcy1idWRnZXQiIGNsYXNzPSJyZXNvdXJjZS1iYWRnZSI+8J+SsCBCdWRnZXQ8L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0icmVzLWNoYW1waW9uIiBjbGFzcz0icmVzb3VyY2UtYmFkZ2UiPuKtkCBDaGFtcGlvbjwvZGl2PgogICAgICAgICAgICA8ZGl2IGlkPSJyZXMtdGVjaCIgY2xhc3M9InJlc291cmNlLWJhZGdlIj7wn5SnIFRlY2g8L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0icmVzLWludGVsIiBjbGFzcz0icmVzb3VyY2UtYmFkZ2UiPvCfjq8gSW50ZWw8L2Rpdj4KICAgICAgICA8L2Rpdj4KCiAgICAgICAgPGRpdiBpZD0iZ2FtZS1hcmVhIj4KICAgICAgICAgICAgPGRpdiBpZD0icm9vbS1jb250YWluZXIiPgogICAgICAgICAgICAgICAgPGRpdiBpZD0icGxheWVyIj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0icGxheWVyLWF2YXRhciI+8J+nkeKAjfCfkrw8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InBsYXllci15b3UtdGFnIj5ZT1U8L3NwYW4+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CgogICAgICAgIDxkaXYgaWQ9Im1pbmltYXAiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJtaW5pbWFwLXJvb20iIGlkPSJtaW5pbWFwLWNvbnRlbnQiPjwvZGl2PgogICAgICAgIDwvZGl2PgoKICAgICAgICA8ZGl2IGlkPSJtb2JpbGUtY29udHJvbHMiPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJkcGFkIj4KICAgICAgICAgICAgICAgIDxkaXY+PC9kaXY+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkcGFkLWJ0biIgZGF0YS1kaXI9InVwIj7ihpE8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDxkaXY+PC9kaXY+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJkcGFkLWJ0biIgZGF0YS1kaXI9ImxlZnQiPuKGkDwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGRpdj48L2Rpdj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRwYWQtYnRuIiBkYXRhLWRpcj0icmlnaHQiPuKGkjwvYnV0dG9uPgogICAgICAgICAgICAgICAgPGRpdj48L2Rpdj4KICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImRwYWQtYnRuIiBkYXRhLWRpcj0iZG93biI+4oaTPC9idXR0b24+CiAgICAgICAgICAgICAgICA8ZGl2PjwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDxkaXYgaWQ9Im91dGNvbWUtdG9hc3QiPgogICAgICAgIDxkaXYgaWQ9InRvYXN0LWljb24iIGNsYXNzPSJ0b2FzdC1pY29uIj7inKg8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJ0b2FzdC10aXRsZSIgY2xhc3M9InRvYXN0LXRpdGxlIj5TdWNjZXNzITwvZGl2PgogICAgICAgIDxkaXYgaWQ9InRvYXN0LW1lc3NhZ2UiIGNsYXNzPSJ0b2FzdC1tZXNzYWdlIj5NZXNzYWdlIGhlcmU8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJ0b2FzdC1lZmZlY3RzIiBjbGFzcz0idG9hc3QtZWZmZWN0cyI+PC9kaXY+CiAgICA8L2Rpdj4KCiAgICA8ZGl2IGlkPSJlbmQtc2NyZWVuIj4KICAgICAgICA8ZGl2IGNsYXNzPSJlbmQtY29udGVudCI+CiAgICAgICAgICAgIDxoMSBpZD0iZW5kLXRpdGxlIj7wn5SUIERpbm5lciBUaW1lITwvaDE+CiAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjojNzE4MDk2O21hcmdpbi1ib3R0b206MTBweDsiPlRoZSByZWNlcHRpb24gaXMgb3ZlciE8L3A+CiAgICAgICAgICAgIDxkaXYgaWQ9ImVuZC1zY29yZSIgY2xhc3M9ImVuZC1zY29yZSI+MC80PC9kaXY+CiAgICAgICAgICAgIDxwIHN0eWxlPSJjb2xvcjojNGE1NTY4OyI+UmVzb3VyY2VzIFNlY3VyZWQ8L3A+CiAgICAgICAgICAgIDxkaXYgaWQ9ImVuZC1zdW1tYXJ5IiBjbGFzcz0iZW5kLXN1bW1hcnkiPgogICAgICAgICAgICAgICAgPGgzPkNvbm5lY3Rpb25zIE1hZGU8L2gzPgogICAgICAgICAgICAgICAgPGRpdiBpZD0ic3VtbWFyeS1jb250ZW50Ij48L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgaWQ9ImVuZC1mZWVkYmFjayIgc3R5bGU9ImNvbG9yOiM0YTU1Njg7dGV4dC1hbGlnbjpsZWZ0O2xpbmUtaGVpZ2h0OjEuNDtmb250LXNpemU6MC44NWVtOyI+PC9kaXY+CiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InJlc3RhcnQtYnRuIiBvbmNsaWNrPSJyZXN0YXJ0R2FtZSgpIj7wn5SEIFRyeSBBZ2FpbjwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJjb250aW51ZS1idG4iIG9uY2xpY2s9InJldHVyblRvTWFpbkdhbWUoKSI+4pyFIENvbnRpbnVlIHRvIERpbm5lcjwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CgogICAgPHNjcmlwdD4KICAgICAgICAvLyA9PT09PSBDT05GSUcgPT09PT0KICAgICAgICBjb25zdCBST09NX1dJRFRIID0gMjIwMDsKICAgICAgICBjb25zdCBST09NX0hFSUdIVCA9IDE2MDA7CiAgICAgICAgY29uc3QgUExBWUVSX1NQRUVEID0gMTQ7CiAgICAgICAgY29uc3QgSU5URVJBQ1RJT05fRElTVEFOQ0UgPSAxMjA7CiAgICAgICAgY29uc3QgR0FNRV9EVVJBVElPTiA9IDkwOwogICAgICAgIGNvbnN0IENST1dEX1JBRElVUyA9IDU1OwogICAgICAgIGNvbnN0IFNUQVJUSU5HX1NPQ0lBTCA9IDMwMDsgLy8gTVVDSCBNT1JFIQogICAgICAgIGNvbnN0IFJBUFBPUlRfVEhSRVNIT0xEID0gNDA7IC8vIFZFUlkgRUFTWSB0aHJlc2hvbGQgLSBqdXN0IDIgYWN0aW9ucyEKCiAgICAgICAgLy8gPT09PT0gU1RBVEUgPT09PT0KICAgICAgICBsZXQgZ2FtZVN0YXRlID0gewogICAgICAgICAgICBwbGF5ZXJYOiAxMTAwLCBwbGF5ZXJZOiAxMzAwLAogICAgICAgICAgICBlbmVyZ3k6IDEwMCwgc29jaWFsRW5lcmd5OiBTVEFSVElOR19TT0NJQUwsCiAgICAgICAgICAgIHRpbWVSZW1haW5pbmc6IEdBTUVfRFVSQVRJT04sCiAgICAgICAgICAgIHJlc291cmNlczogeyBidWRnZXQ6IGZhbHNlLCBjaGFtcGlvbjogZmFsc2UsIHRlY2g6IGZhbHNlLCBpbnRlbDogZmFsc2UgfSwKICAgICAgICAgICAgbnBjUmFwcG9ydDoge30sCiAgICAgICAgICAgIG5wY0RvbmU6IG5ldyBTZXQoKSwKICAgICAgICAgICAgY29ubmVjdGlvbnM6IFtdLAogICAgICAgICAgICBnYW1lQWN0aXZlOiBmYWxzZSwKICAgICAgICAgICAga2V5c1ByZXNzZWQ6IHt9LAogICAgICAgICAgICBtdXNpY1BsYXlpbmc6IGZhbHNlCiAgICAgICAgfTsKCiAgICAgICAgLy8gPT09PT0gQVVESU8gLSBVUEJFQVQgUEFSVFkgTVVTSUMhID09PT09CiAgICAgICAgbGV0IGF1ZGlvQ3R4ID0gbnVsbDsKICAgICAgICBsZXQgbXVzaWNUaW1lb3V0ID0gbnVsbDsKCiAgICAgICAgLy8gRnVuIHVwYmVhdCBtZWxvZHkgLSB0aGluayBjb2NrdGFpbCBwYXJ0eSBzd2luZyEKICAgICAgICBjb25zdCBNRUxPRFkgPSBbCiAgICAgICAgICAgIC8vIFBocmFzZSAxIC0gYm91bmN5IGFuZCBicmlnaHQKICAgICAgICAgICAgeyBub3RlOiA2NTksIGR1cjogMTIwIH0sIHsgbm90ZTogNzg0LCBkdXI6IDEyMCB9LCB7IG5vdGU6IDg4MCwgZHVyOiAyNDAgfSwgeyBub3RlOiA3ODQsIGR1cjogMTIwIH0sCiAgICAgICAgICAgIHsgbm90ZTogNjU5LCBkdXI6IDEyMCB9LCB7IG5vdGU6IDc4NCwgZHVyOiAyNDAgfSwgeyBub3RlOiA4ODAsIGR1cjogMTIwIH0sIHsgbm90ZTogOTg4LCBkdXI6IDEyMCB9LAogICAgICAgICAgICB7IG5vdGU6IDg4MCwgZHVyOiAyNDAgfSwgeyBub3RlOiA3ODQsIGR1cjogMTIwIH0sIHsgbm90ZTogNjU5LCBkdXI6IDEyMCB9LCB7IG5vdGU6IDU4NywgZHVyOiAyNDAgfSwKICAgICAgICAgICAgLy8gUGhyYXNlIDIgLSByaXNpbmcgZW5lcmd5CiAgICAgICAgICAgIHsgbm90ZTogNTIzLCBkdXI6IDEyMCB9LCB7IG5vdGU6IDY1OSwgZHVyOiAxMjAgfSwgeyBub3RlOiA3ODQsIGR1cjogMTIwIH0sIHsgbm90ZTogODgwLCBkdXI6IDEyMCB9LAogICAgICAgICAgICB7IG5vdGU6IDk4OCwgZHVyOiAyNDAgfSwgeyBub3RlOiA4ODAsIGR1cjogMTIwIH0sIHsgbm90ZTogNzg0LCBkdXI6IDEyMCB9LCB7IG5vdGU6IDg4MCwgZHVyOiAzNjAgfSwKICAgICAgICAgICAgLy8gUGhyYXNlIDMgLSBwbGF5ZnVsCiAgICAgICAgICAgIHsgbm90ZTogMCwgZHVyOiA2MCB9LCB7IG5vdGU6IDk4OCwgZHVyOiAxMjAgfSwgeyBub3RlOiA4ODAsIGR1cjogMTIwIH0sIHsgbm90ZTogNzg0LCBkdXI6IDEyMCB9LAogICAgICAgICAgICB7IG5vdGU6IDY1OSwgZHVyOiAxODAgfSwgeyBub3RlOiA3ODQsIGR1cjogMTgwIH0sIHsgbm90ZTogODgwLCBkdXI6IDM2MCB9LAogICAgICAgICAgICAvLyBQaHJhc2UgNCAtIHJlc29sdXRpb24KICAgICAgICAgICAgeyBub3RlOiA3ODQsIGR1cjogMTIwIH0sIHsgbm90ZTogNjU5LCBkdXI6IDEyMCB9LCB7IG5vdGU6IDU4NywgZHVyOiAyNDAgfSwKICAgICAgICAgICAgeyBub3RlOiA2NTksIGR1cjogMTIwIH0sIHsgbm90ZTogNzg0LCBkdXI6IDEyMCB9LCB7IG5vdGU6IDY1OSwgZHVyOiA0ODAgfSwKICAgICAgICBdOwoKICAgICAgICAvLyBQdW5jaHkgd2Fsa2luZyBiYXNzCiAgICAgICAgY29uc3QgQkFTUyA9IFsKICAgICAgICAgICAgeyBub3RlOiAxMzEsIGR1cjogMTQwIH0sIHsgbm90ZTogMTY1LCBkdXI6IDE0MCB9LCB7IG5vdGU6IDE5NiwgZHVyOiAxNDAgfSwgeyBub3RlOiAyMjAsIGR1cjogMTQwIH0sCiAgICAgICAgICAgIHsgbm90ZTogMjQ3LCBkdXI6IDE0MCB9LCB7IG5vdGU6IDIyMCwgZHVyOiAxNDAgfSwgeyBub3RlOiAxOTYsIGR1cjogMTQwIH0sIHsgbm90ZTogMTY1LCBkdXI6IDE0MCB9LAogICAgICAgICAgICB7IG5vdGU6IDE0NywgZHVyOiAxNDAgfSwgeyBub3RlOiAxNzUsIGR1cjogMTQwIH0sIHsgbm90ZTogMTk2LCBkdXI6IDE0MCB9LCB7IG5vdGU6IDIyMCwgZHVyOiAxNDAgfSwKICAgICAgICAgICAgeyBub3RlOiAxOTYsIGR1cjogMTQwIH0sIHsgbm90ZTogMTc1LCBkdXI6IDE0MCB9LCB7IG5vdGU6IDE0NywgZHVyOiAxNDAgfSwgeyBub3RlOiAxMzEsIGR1cjogMTQwIH0sCiAgICAgICAgXTsKCiAgICAgICAgLy8gSmF6enkgY2hvcmQgdm9pY2luZ3MKICAgICAgICBjb25zdCBDSE9SRFMgPSBbCiAgICAgICAgICAgIFsyNjIsIDMzMCwgMzkyLCA0OTRdLCAgLy8gQ21hajcKICAgICAgICAgICAgWzI5NCwgMzcwLCA0NDAsIDU1NF0sICAvLyBEbWFqNyAgCiAgICAgICAgICAgIFszMzAsIDQxNSwgNDk0LCA2MjJdLCAgLy8gRW1hajcKICAgICAgICAgICAgWzM1MCwgNDQwLCA1MjMsIDY1OV0sICAvLyBGbWFqNwogICAgICAgICAgICBbMzkyLCA0OTQsIDU4NywgNzQwXSwgIC8vIEdtYWo3CiAgICAgICAgICAgIFs0NDAsIDU1NCwgNjU5LCA4MzFdLCAgLy8gQW1hajcKICAgICAgICBdOwoKICAgICAgICBmdW5jdGlvbiBpbml0QXVkaW8oKSB7CiAgICAgICAgICAgIGlmIChhdWRpb0N0eCkgcmV0dXJuOwogICAgICAgICAgICBhdWRpb0N0eCA9IG5ldyAod2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0KSgpOwogICAgICAgICAgICBpZiAoYXVkaW9DdHguc3RhdGUgPT09ICJzdXNwZW5kZWQiKSBhdWRpb0N0eC5yZXN1bWUoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBsYXlOb3RlKGZyZXEsIGR1cmF0aW9uLCB0eXBlID0gJ3RyaWFuZ2xlJywgdm9sdW1lID0gMC4xKSB7CiAgICAgICAgICAgIGlmICghYXVkaW9DdHggfHwgZnJlcSA9PT0gMCkgcmV0dXJuOwogICAgICAgICAgICBjb25zdCBvc2MgPSBhdWRpb0N0eC5jcmVhdGVPc2NpbGxhdG9yKCk7CiAgICAgICAgICAgIGNvbnN0IGdhaW4gPSBhdWRpb0N0eC5jcmVhdGVHYWluKCk7CiAgICAgICAgICAgIG9zYy50eXBlID0gdHlwZTsKICAgICAgICAgICAgb3NjLmZyZXF1ZW5jeS52YWx1ZSA9IGZyZXE7CiAgICAgICAgICAgIGdhaW4uZ2Fpbi52YWx1ZSA9IDA7CiAgICAgICAgICAgIGdhaW4uZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSh2b2x1bWUsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lICsgMC4wMTUpOwogICAgICAgICAgICBnYWluLmdhaW4ubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUodm9sdW1lICogMC40LCBhdWRpb0N0eC5jdXJyZW50VGltZSArIGR1cmF0aW9uLzEwMDAgKiAwLjUpOwogICAgICAgICAgICBnYWluLmdhaW4ubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoMCwgYXVkaW9DdHguY3VycmVudFRpbWUgKyBkdXJhdGlvbi8xMDAwKTsKICAgICAgICAgICAgb3NjLmNvbm5lY3QoZ2Fpbik7CiAgICAgICAgICAgIGdhaW4uY29ubmVjdChhdWRpb0N0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIG9zYy5zdGFydCgpOwogICAgICAgICAgICBvc2Muc3RvcChhdWRpb0N0eC5jdXJyZW50VGltZSArIGR1cmF0aW9uLzEwMDAgKyAwLjA1KTsKICAgICAgICB9CgogICAgICAgIC8vIFBlcmN1c3Npb24gaGl0IChoaS1oYXQgbGlrZSkKICAgICAgICBmdW5jdGlvbiBwbGF5SGlIYXQodm9sdW1lID0gMC4wNCkgewogICAgICAgICAgICBpZiAoIWF1ZGlvQ3R4KSByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IGJ1ZmZlclNpemUgPSBhdWRpb0N0eC5zYW1wbGVSYXRlICogMC4wNTsKICAgICAgICAgICAgY29uc3QgYnVmZmVyID0gYXVkaW9DdHguY3JlYXRlQnVmZmVyKDEsIGJ1ZmZlclNpemUsIGF1ZGlvQ3R4LnNhbXBsZVJhdGUpOwogICAgICAgICAgICBjb25zdCBkYXRhID0gYnVmZmVyLmdldENoYW5uZWxEYXRhKDApOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7IGkrKykgewogICAgICAgICAgICAgICAgZGF0YVtpXSA9IChNYXRoLnJhbmRvbSgpICogMiAtIDEpICogTWF0aC5leHAoLWkgLyAoYnVmZmVyU2l6ZSAqIDAuMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGF1ZGlvQ3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICBzb3VyY2UuYnVmZmVyID0gYnVmZmVyOwogICAgICAgICAgICBjb25zdCBmaWx0ZXIgPSBhdWRpb0N0eC5jcmVhdGVCaXF1YWRGaWx0ZXIoKTsKICAgICAgICAgICAgZmlsdGVyLnR5cGUgPSAnaGlnaHBhc3MnOwogICAgICAgICAgICBmaWx0ZXIuZnJlcXVlbmN5LnZhbHVlID0gNzAwMDsKICAgICAgICAgICAgY29uc3QgZ2FpbiA9IGF1ZGlvQ3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgZ2Fpbi5nYWluLnZhbHVlID0gdm9sdW1lOwogICAgICAgICAgICBzb3VyY2UuY29ubmVjdChmaWx0ZXIpLmNvbm5lY3QoZ2FpbikuY29ubmVjdChhdWRpb0N0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHNvdXJjZS5zdGFydCgpOwogICAgICAgIH0KCiAgICAgICAgbGV0IG1lbG9keUlkeCA9IDAsIGJhc3NJZHggPSAwLCBiZWF0ID0gMCwgY2hvcmRJZHggPSAwOwoKICAgICAgICBmdW5jdGlvbiBwbGF5TXVzaWNMb29wKCkgewogICAgICAgICAgICBpZiAoIWdhbWVTdGF0ZS5tdXNpY1BsYXlpbmcpIHJldHVybjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE1lbG9keSAtIGJyaWdodCBhbmQgY2xlYXIKICAgICAgICAgICAgY29uc3QgbSA9IE1FTE9EWVttZWxvZHlJZHggJSBNRUxPRFkubGVuZ3RoXTsKICAgICAgICAgICAgaWYgKG0ubm90ZSA+IDApIHsKICAgICAgICAgICAgICAgIHBsYXlOb3RlKG0ubm90ZSwgbS5kdXIsICd0cmlhbmdsZScsIDAuMTIpOwogICAgICAgICAgICAgICAgcGxheU5vdGUobS5ub3RlICogMC41LCBtLmR1ciwgJ3NpbmUnLCAwLjA0KTsgLy8gb2N0YXZlIGJlbG93IGZvciByaWNobmVzcwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXYWxraW5nIGJhc3MgLSBwdW5jaHkKICAgICAgICAgICAgcGxheU5vdGUoQkFTU1tiYXNzSWR4ICUgQkFTUy5sZW5ndGhdLm5vdGUsIDEzMCwgJ3RyaWFuZ2xlJywgMC4xNSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTd2luZyBoaS1oYXQgcGF0dGVybgogICAgICAgICAgICBpZiAoYmVhdCAlIDIgPT09IDApIHsKICAgICAgICAgICAgICAgIHBsYXlIaUhhdCgwLjA1KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZ2FtZVN0YXRlLm11c2ljUGxheWluZyAmJiBwbGF5SGlIYXQoMC4wMyksIDQwKTsgLy8gc3dpbmcgZmVlbAogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDaG9yZCBzdGFicyBvbiBiZWF0cyAxIGFuZCAzIG9mIGVhY2ggYmFyCiAgICAgICAgICAgIGlmIChiZWF0ICUgOCA9PT0gMCB8fCBiZWF0ICUgOCA9PT0gNCkgewogICAgICAgICAgICAgICAgY29uc3QgY2hvcmQgPSBDSE9SRFNbY2hvcmRJZHggJSBDSE9SRFMubGVuZ3RoXTsKICAgICAgICAgICAgICAgIGNob3JkLmZvckVhY2goKGZyZXEsIGkpID0+IHsKICAgICAgICAgICAgICAgICAgICBwbGF5Tm90ZShmcmVxLCAyMDAsICdzaW5lJywgMC4wNCAqICgxIC0gaSAqIDAuMSkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAoYmVhdCAlIDggPT09IDApIGNob3JkSWR4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIE9jY2FzaW9uYWwgcGlhbm8gZmxvdXJpc2gKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPCAwLjA4KSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWdhbWVTdGF0ZS5tdXNpY1BsYXlpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBbNjU5LCA3ODQsIDg4MCwgOTg4XS5mb3JFYWNoKChmLCBpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcGxheU5vdGUoZiwgODAsICd0cmlhbmdsZScsIDAuMDYpLCBpICogMzApOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwgTWF0aC5yYW5kb20oKSAqIDgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgbWVsb2R5SWR4Kys7IGJhc3NJZHgrKzsgYmVhdCsrOwogICAgICAgICAgICBtdXNpY1RpbWVvdXQgPSBzZXRUaW1lb3V0KHBsYXlNdXNpY0xvb3AsIDE1MCk7IC8vIEZhc3QgdGVtcG8hCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzdGFydE11c2ljKCkgewogICAgICAgICAgICBpbml0QXVkaW8oKTsKICAgICAgICAgICAgaWYgKGdhbWVTdGF0ZS5tdXNpY1BsYXlpbmcpIHJldHVybjsKICAgICAgICAgICAgZ2FtZVN0YXRlLm11c2ljUGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIG1lbG9keUlkeCA9IDA7IGJhc3NJZHggPSAwOyBiZWF0ID0gMDsgY2hvcmRJZHggPSAwOwogICAgICAgICAgICBwbGF5TXVzaWNMb29wKCk7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtdXNpYy1idG4nKS50ZXh0Q29udGVudCA9ICfwn5SKIE11c2ljJzsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ211c2ljLWJ0bicpLmNsYXNzTGlzdC5hZGQoJ3BsYXlpbmcnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHN0b3BNdXNpYygpIHsKICAgICAgICAgICAgZ2FtZVN0YXRlLm11c2ljUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICBpZiAobXVzaWNUaW1lb3V0KSBjbGVhclRpbWVvdXQobXVzaWNUaW1lb3V0KTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ211c2ljLWJ0bicpLnRleHRDb250ZW50ID0gJ/CflIcgTXVzaWMnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbXVzaWMtYnRuJykuY2xhc3NMaXN0LnJlbW92ZSgncGxheWluZycpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlTXVzaWMoKSB7CiAgICAgICAgICAgIGdhbWVTdGF0ZS5tdXNpY1BsYXlpbmcgPyBzdG9wTXVzaWMoKSA6IHN0YXJ0TXVzaWMoKTsKICAgICAgICB9CiAgICAgICAgLy8gPT09PT0gQUNUSU9OUyAtIENMRUFSIFBST0dSRVNTSU9OISA9PT09PQogICAgICAgIC8vIE9QRU5FUlM6IFVzZSB0aGVzZSBmaXJzdCB0byBicmVhayB0aGUgaWNlCiAgICAgICAgLy8gRU5HQUdFUlM6IFVzZSBhZnRlciBhbiBvcGVuZXIgZm9yIGJpZyByZXdhcmRzCiAgICAgICAgY29uc3QgQUNUSU9OUyA9IFsKICAgICAgICAgICAgLy8gT3BlbmVycyAtIGFsd2F5cyB3b3JrIHdlbGwsIGNoZWFwCiAgICAgICAgICAgIHsgaWQ6ICdqb2tlJywgaWNvbjogJ/CfmIQnLCBsYWJlbDogJ0pva2UnLCBzb2NpYWxDb3N0OiA0LCBlbmVyZ3lDb3N0OiAxLCB0eXBlOiAnb3BlbmVyJyB9LAogICAgICAgICAgICB7IGlkOiAnY29tcGxpbWVudCcsIGljb246ICfwn4yfJywgbGFiZWw6ICdDb21wbGltZW50Jywgc29jaWFsQ29zdDogNCwgZW5lcmd5Q29zdDogMSwgdHlwZTogJ29wZW5lcicgfSwKICAgICAgICAgICAgeyBpZDogJ3F1ZXN0aW9uJywgaWNvbjogJ+KdkycsIGxhYmVsOiAnQXNrJywgc29jaWFsQ29zdDogNCwgZW5lcmd5Q29zdDogMSwgdHlwZTogJ29wZW5lcicgfSwKICAgICAgICAgICAgLy8gRW5nYWdlcnMgLSB3b3JrIGdyZWF0IEFGVEVSIGFuIG9wZW5lcgogICAgICAgICAgICB7IGlkOiAnbGlzdGVuJywgaWNvbjogJ/CfkYInLCBsYWJlbDogJ0xpc3RlbicsIHNvY2lhbENvc3Q6IDYsIGVuZXJneUNvc3Q6IDIsIHR5cGU6ICdlbmdhZ2VyJyB9LAogICAgICAgICAgICB7IGlkOiAnc3RvcnknLCBpY29uOiAn8J+TlicsIGxhYmVsOiAnU3RvcnknLCBzb2NpYWxDb3N0OiA4LCBlbmVyZ3lDb3N0OiAyLCB0eXBlOiAnZW5nYWdlcicgfSwKICAgICAgICAgICAgeyBpZDogJ2J1c2luZXNzJywgaWNvbjogJ/CfkrwnLCBsYWJlbDogJ0J1c2luZXNzJywgc29jaWFsQ29zdDogOCwgZW5lcmd5Q29zdDogMiwgdHlwZTogJ2VuZ2FnZXInIH0sCiAgICAgICAgICAgIC8vIFdyYXAgdXAKICAgICAgICAgICAgeyBpZDogJ2V4aXQnLCBpY29uOiAn8J+RiycsIGxhYmVsOiAnV3JhcCBVcCcsIHNvY2lhbENvc3Q6IDAsIGVuZXJneUNvc3Q6IDAsIGlzRXhpdDogdHJ1ZSB9CiAgICAgICAgXTsKCiAgICAgICAgLy8gPT09PT0gTlBDcyAtIFNJTVBMRVIgUFJFRkVSRU5DRVMgPT09PT0KICAgICAgICBjb25zdCBucGNzID0gWwogICAgICAgICAgICAvLyBLZXkgY29udGFjdHMgKGhhdmUgcmVzb3VyY2VzKSAtIG5lZWQgb3BlbmVyIHRoZW4gZW5nYWdlcgogICAgICAgICAgICB7IGlkOiAnY2ZvJywgbmFtZTogJ01hcmdhcmV0IENoZW4nLCByb2xlOiAnRGVwdXR5IENGTycsIGF2YXRhcjogJ/CfkanigI3wn5K8JywgeDogNDUwLCB5OiA0MDAsIHZpYmU6ICfinKgnLCByZXNvdXJjZTogJ2J1ZGdldCcsIHRpcDogJ0xpa2VzOiBCdXNpbmVzcyB0YWxrJyB9LAogICAgICAgICAgICB7IGlkOiAnc3ZwJywgbmFtZTogJ1JpY2hhcmQgT2tvbmt3bycsIHJvbGU6ICdTVlAgU3RyYXRlZ3knLCBhdmF0YXI6ICfwn5Go4oCN8J+SvCcsIHg6IDE3MDAsIHk6IDM1MCwgdmliZTogJ+KcqCcsIHJlc291cmNlOiAnY2hhbXBpb24nLCB0aXA6ICdMaWtlczogR29vZCBzdG9yaWVzJyB9LAogICAgICAgICAgICB7IGlkOiAndGVjaGRpcicsIG5hbWU6ICdEci4gQWlzaGEgUGF0ZWwnLCByb2xlOiAnQUkgRGlyZWN0b3InLCBhdmF0YXI6ICfwn5Gp4oCN8J+UrCcsIHg6IDcwMCwgeTogOTAwLCB2aWJlOiAn4pyoJywgcmVzb3VyY2U6ICd0ZWNoJywgdGlwOiAnTGlrZXM6IFF1ZXN0aW9ucycgfSwKICAgICAgICAgICAgeyBpZDogJ3N0cmF0ZWd5JywgbmFtZTogJ0phbWVzIE1vcnJpc29uJywgcm9sZTogJ1N0cmF0ZWd5IEhlYWQnLCBhdmF0YXI6ICfwn6eUJywgeDogMTgwMCwgeTogMTAwMCwgdmliZTogJ+KcqCcsIHJlc291cmNlOiAnaW50ZWwnLCB0aXA6ICdMaWtlczogTGlzdGVuaW5nJyB9LAogICAgICAgICAgICAvLyBGcmllbmRseSBjb250YWN0cyAoZ2l2ZSBib251c2VzKQogICAgICAgICAgICB7IGlkOiAnbWFya2V0aW5nJywgbmFtZTogJ1NvcGhpZSBXaWxsaWFtcycsIHJvbGU6ICdNYXJrZXRpbmcnLCBhdmF0YXI6ICfwn5Gx4oCN4pmA77iPJywgeDogMTAwMCwgeTogNTUwLCB2aWJlOiAn8J+YiicsIHJlc291cmNlOiBudWxsLCBzb2NpYWxCb251czogMjAsIHRpcDogJ1ZlcnkgZnJpZW5kbHkhJyB9LAogICAgICAgICAgICB7IGlkOiAnaW50ZXJuJywgbmFtZTogJ0FsZXggUmVldmVzJywgcm9sZTogJ0ludGVybicsIGF2YXRhcjogJ/Cfp5HigI3wn46TJywgeDogMTM1MCwgeTogNzAwLCB2aWJlOiAn8J+YiicsIHJlc291cmNlOiBudWxsLCBzb2NpYWxCb251czogMjUsIHRpcDogJ0VhZ2VyIHRvIGNoYXQhJyB9LAogICAgICAgICAgICB7IGlkOiAnbGVnYWwnLCBuYW1lOiAnVGhvbWFzIEdyYW50Jywgcm9sZTogJ0xlZ2FsJywgYXZhdGFyOiAn8J+RqOKAjeKalu+4jycsIHg6IDM1MCwgeTogMTEwMCwgdmliZTogJ/CfmIonLCByZXNvdXJjZTogbnVsbCwgZW5lcmd5Qm9udXM6IDE1LCB0aXA6ICdHb29kIGxpc3RlbmVyJyB9LAogICAgICAgICAgICAvLyBEaWZmaWN1bHQgY29udGFjdHMgKGRyYWluIGVuZXJneSkgLSBtYXJrZWQgd2l0aCB3YXJuaW5nCiAgICAgICAgICAgIHsgaWQ6ICdjb21wbGFpbmVyJywgbmFtZTogJ0RlcmVrIEJvdHRvbWxleScsIHJvbGU6ICdTYWxlcycsIGF2YXRhcjogJ/CfmKQnLCB4OiAxNTUwLCB5OiA3NTAsIHZpYmU6ICfimqDvuI8nLCByZXNvdXJjZTogbnVsbCwgZW5lcmd5RHJhaW46IDgsIHNvY2lhbERyYWluOiA1LCB0aXA6ICdBdm9pZCBpZiBidXN5IScgfSwKICAgICAgICAgICAgeyBpZDogJ2Jsb2NrZXInLCBuYW1lOiAnUGF0cmljaWEgSGFyZ3JlYXZlcycsIHJvbGU6ICdWUCBPcHMnLCBhdmF0YXI6ICfwn5iSJywgeDogNTUwLCB5OiA2NTAsIHZpYmU6ICfimqDvuI8nLCByZXNvdXJjZTogbnVsbCwgZW5lcmd5RHJhaW46IDYsIHNvY2lhbERyYWluOiA0LCB0aXA6ICdUaW1lIHdhc3RlciEnIH0sCiAgICAgICAgICAgIHsgaWQ6ICdnb3NzaXAnLCBuYW1lOiAnQnJpYW4gV2hpdHRsZScsIHJvbGU6ICdFQSB0byBDRU8nLCBhdmF0YXI6ICfwn6SrJywgeDogMTEwMCwgeTogNDAwLCB2aWJlOiAn4pqg77iPJywgcmVzb3VyY2U6IG51bGwsIGVuZXJneURyYWluOiA1LCBzb2NpYWxEcmFpbjogMywgdGlwOiAnVGFsa3MgdG9vIG11Y2gnIH0sCiAgICAgICAgICAgIC8vIEJhcnRlbmRlciAtIGluc3RhbnQgcmVjaGFyZ2UKICAgICAgICAgICAgeyBpZDogJ2JhcnRlbmRlcicsIG5hbWU6ICdNYXJjdXMnLCByb2xlOiAnQmFydGVuZGVyJywgYXZhdGFyOiAn8J+NuCcsIHg6IDE5ODAsIHk6IDI4MCwgdmliZTogJ/CfkponLCByZXNvdXJjZTogbnVsbCwgZW5lcmd5Qm9udXM6IDQwLCBzb2NpYWxCb251czogNTAsIGluc3RhbnRDb21wbGV0ZTogdHJ1ZSwgdGlwOiAnUmVjaGFyZ2UgaGVyZSEnIH0KICAgICAgICBdOwogICAgICAgIC8vID09PT09IENST1dEUyA9PT09PQogICAgICAgIGNvbnN0IGNyb3dkR3JvdXBzID0gWwogICAgICAgICAgICB7IHg6IDMwMCwgeTogNTUwLCBwZW9wbGU6IFsn8J+RqOKAjfCfkrwnLCAn8J+RqeKAjfCfkrwnLCAn8J+nkeKAjfCfkrwnXSwgY2hhdDogJ1EzIHJlc3VsdHMhJyB9LAogICAgICAgICAgICB7IHg6IDg1MCwgeTogMzAwLCBwZW9wbGU6IFsn8J+RqeKAjfCfprAnLCAn8J+RqOKAjfCfprEnLCAn8J+RtCddLCBjaGF0OiAnR3JlYXQgZXZlbnQhJyB9LAogICAgICAgICAgICB7IHg6IDEyMDAsIHk6IDUwMCwgcGVvcGxlOiBbJ/CfkanigI3wn5SsJywgJ/CfkajigI3wn5K7J10sIGNoYXQ6ICdBUEkgbGl2ZSEnIH0sCiAgICAgICAgICAgIHsgeDogNjAwLCB5OiAxMDUwLCBwZW9wbGU6IFsn8J+nkycsICfwn5Go4oCN8J+msyddLCBjaGF0OiAnQmFjayB0aGVuLi4uJyB9LAogICAgICAgICAgICB7IHg6IDE0MDAsIHk6IDk1MCwgcGVvcGxlOiBbJ/CfkanigI3wn46kJywgJ/Cfp5HigI3wn46kJywgJ/CfkajigI3wn46kJ10sIGNoYXQ6ICdHcmVhdCBiYW5kIScgfSwKICAgICAgICAgICAgeyB4OiAxNjUwLCB5OiA2MDAsIHBlb3BsZTogWyfwn6eR4oCN8J+NsycsICfwn5Go4oCN8J+NsyddLCBjaGF0OiAnVGhlIHNhbG1vbiEnIH0sCiAgICAgICAgICAgIHsgeDogNDAwLCB5OiA4MDAsIHBlb3BsZTogWyfwn5GuJywgJ/CfkbcnXSwgY2hhdDogJ0FsbCBjbGVhciEnIH0sCiAgICAgICAgICAgIHsgeDogMTMwMCwgeTogMTE1MCwgcGVvcGxlOiBbJ/CfkanigI3wn46oJywgJ/CfkajigI3wn46oJ10sIGNoYXQ6ICdOZXcgbG9nbyEnIH0sCiAgICAgICAgICAgIHsgeDogNTAwLCB5OiAxMzAwLCBwZW9wbGU6IFsn8J+nkeKAjeKciO+4jycsICfwn5Gp4oCN4pyI77iPJ10sIGNoYXQ6ICdQYXJpcyB0cmlwIScgfSwKICAgICAgICAgICAgeyB4OiAxNzAwLCB5OiAxMjAwLCBwZW9wbGU6IFsn8J+RqOKAjfCfj6snLCAn8J+RqeKAjfCfj6snXSwgY2hhdDogJ1RyYWluaW5nIScgfSwKICAgICAgICAgICAgeyB4OiAxNTAwLCB5OiA0NTAsIHBlb3BsZTogWyfwn5Gp4oCN8J+SuycsICfwn5Go4oCN8J+SuyddLCBjaGF0OiAnU2hpcCBpdCEnIH0sCiAgICAgICAgICAgIHsgeDogNjUwLCB5OiAzNTAsIHBlb3BsZTogWyfwn5KDJywgJ/CflbonXSwgY2hhdDogJ0RhbmNpbmchJyB9LAogICAgICAgIF07CgogICAgICAgIC8vID09PT09IERFQ09SQVRJT05TID09PT09CiAgICAgICAgY29uc3QgZGVjb3JhdGlvbnMgPSBbCiAgICAgICAgICAgIHsgdHlwZTogJ2JhcicsIHg6IDE4NTAsIHk6IDIwMCB9LAogICAgICAgICAgICB7IHR5cGU6ICdzdGFnZScsIHg6IDg3NSwgeTogNzAgfSwKICAgICAgICAgICAgeyB0eXBlOiAndGFibGUnLCB4OiAyNTAsIHk6IDcwMCB9LCB7IHR5cGU6ICd0YWJsZScsIHg6IDE2MDAsIHk6IDUwMCB9LAogICAgICAgICAgICB7IHR5cGU6ICd0YWJsZScsIHg6IDU1MCwgeTogMzUwIH0sIHsgdHlwZTogJ3RhYmxlJywgeDogMTMwMCwgeTogNDAwIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ3RhYmxlJywgeDogMTAwMCwgeTogOTUwIH0sIHsgdHlwZTogJ3RhYmxlJywgeDogNDUwLCB5OiAxMjAwIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ3RhYmxlJywgeDogMTUwMCwgeTogMTEwMCB9LCB7IHR5cGU6ICd0YWJsZScsIHg6IDgwMCwgeTogNzAwIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ3RhYmxlJywgeDogMTIwMCwgeTogODAwIH0sIHsgdHlwZTogJ3RhYmxlJywgeDogMzUwLCB5OiA0NTAgfSwKICAgICAgICAgICAgeyB0eXBlOiAncGlsbGFyJywgeDogNTAwLCB5OiA1MDAgfSwgeyB0eXBlOiAncGlsbGFyJywgeDogMTUwMCwgeTogNTAwIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ3BpbGxhcicsIHg6IDUwMCwgeTogMTEwMCB9LCB7IHR5cGU6ICdwaWxsYXInLCB4OiAxNTAwLCB5OiAxMTAwIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ3BsYW50JywgeDogNTAsIHk6IDgwLCBlbW9qaTogJ/CfjL8nIH0sIHsgdHlwZTogJ3BsYW50JywgeDogMjE1MCwgeTogODAsIGVtb2ppOiAn8J+MvycgfSwKICAgICAgICAgICAgeyB0eXBlOiAncGxhbnQnLCB4OiA1MCwgeTogMTUwMCwgZW1vamk6ICfwn4y0JyB9LCB7IHR5cGU6ICdwbGFudCcsIHg6IDIxNTAsIHk6IDE1MDAsIGVtb2ppOiAn8J+MtCcgfSwKICAgICAgICAgICAgeyB0eXBlOiAnY2hhbmRlbGllcicsIHg6IDU1MCwgeTogNjAwLCBlbW9qaTogJ/CfkqsnIH0sIHsgdHlwZTogJ2NoYW5kZWxpZXInLCB4OiAxNjUwLCB5OiA2MDAsIGVtb2ppOiAn8J+SqycgfSwKICAgICAgICAgICAgeyB0eXBlOiAnY2hhbmRlbGllcicsIHg6IDExMDAsIHk6IDQwMCwgZW1vamk6ICfinKgnIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ2Jhbm5lcicsIHg6IDE1MCwgeTogMTUwLCB0ZXh0OiAn8J+OiiBXRUxDT01FIScgfSwKICAgICAgICAgICAgeyB0eXBlOiAnYmFubmVyJywgeDogMTk1MCwgeTogNTAwLCB0ZXh0OiAn8J+NviBDSEVFUlMhJyB9LAogICAgICAgICAgICB7IHR5cGU6ICdsaWdodCcsIHg6IDQwMCwgeTogNDAwLCBzaXplOiAzNTAgfSwgeyB0eXBlOiAnbGlnaHQnLCB4OiAxMTAwLCB5OiA1NTAsIHNpemU6IDQ1MCB9LAogICAgICAgICAgICB7IHR5cGU6ICdsaWdodCcsIHg6IDE3MDAsIHk6IDQwMCwgc2l6ZTogMzUwIH0sIHsgdHlwZTogJ2xpZ2h0JywgeDogNjAwLCB5OiA5NTAsIHNpemU6IDQwMCB9LAogICAgICAgIF07CgogICAgICAgIC8vID09PT09IElOSVQgPT09PT0KICAgICAgICBmdW5jdGlvbiBzdGFydEdhbWUoKSB7CiAgICAgICAgICAgIGdhbWVTdGF0ZSA9IHsKICAgICAgICAgICAgICAgIHBsYXllclg6IDExMDAsIHBsYXllclk6IDEzMDAsCiAgICAgICAgICAgICAgICBlbmVyZ3k6IDEwMCwgc29jaWFsRW5lcmd5OiBTVEFSVElOR19TT0NJQUwsCiAgICAgICAgICAgICAgICB0aW1lUmVtYWluaW5nOiBHQU1FX0RVUkFUSU9OLAogICAgICAgICAgICAgICAgcmVzb3VyY2VzOiB7IGJ1ZGdldDogZmFsc2UsIGNoYW1waW9uOiBmYWxzZSwgdGVjaDogZmFsc2UsIGludGVsOiBmYWxzZSB9LAogICAgICAgICAgICAgICAgbnBjUmFwcG9ydDoge30sCiAgICAgICAgICAgICAgICBucGNEb25lOiBuZXcgU2V0KCksCiAgICAgICAgICAgICAgICBjb25uZWN0aW9uczogW10sCiAgICAgICAgICAgICAgICBnYW1lQWN0aXZlOiB0cnVlLAogICAgICAgICAgICAgICAga2V5c1ByZXNzZWQ6IHt9LAogICAgICAgICAgICAgICAgbXVzaWNQbGF5aW5nOiBnYW1lU3RhdGUubXVzaWNQbGF5aW5nCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBucGNzLmZvckVhY2gobiA9PiBnYW1lU3RhdGUubnBjUmFwcG9ydFtuLmlkXSA9IDApOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXJ0LXNjcmVlbicpLmNsYXNzTGlzdC5hZGQoJ2hpZGRlbicpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjcmVlbicpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZS13cmFwcGVyJykuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZGVuJyk7CiAgICAgICAgICAgIFsnYnVkZ2V0JywgJ2NoYW1waW9uJywgJ3RlY2gnLCAnaW50ZWwnXS5mb3JFYWNoKHIgPT4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYHJlcy0ke3J9YCkuY2xhc3NMaXN0LnJlbW92ZSgnYWNxdWlyZWQnKSk7CgogICAgICAgICAgICBzZXR1cFJvb20oKTsKICAgICAgICAgICAgdXBkYXRlSFVEKCk7CiAgICAgICAgICAgIGdhbWVMb29wKCk7CiAgICAgICAgICAgIHN0YXJ0VGltZXIoKTsKICAgICAgICAgICAgaWYgKCFnYW1lU3RhdGUubXVzaWNQbGF5aW5nKSBzdGFydE11c2ljKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXR1cFJvb20oKSB7CiAgICAgICAgICAgIGNvbnN0IHJvb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncm9vbS1jb250YWluZXInKTsKICAgICAgICAgICAgcm9vbS5xdWVyeVNlbGVjdG9yQWxsKCcubnBjLCAuYmFyLWNvdW50ZXIsIC5zdGFnZSwgLnRhYmxlLXJvdW5kLCAucGxhbnQsIC5jaGFuZGVsaWVyLCAucGlsbGFyLCAuY3Jvd2QtZ3JvdXAsIC5iYW5uZXIsIC5saWdodC1wb29sJykuZm9yRWFjaChlbCA9PiBlbC5yZW1vdmUoKSk7CgogICAgICAgICAgICBkZWNvcmF0aW9ucy5maWx0ZXIoZCA9PiBkLnR5cGUgPT09ICdsaWdodCcpLmZvckVhY2goZCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgZWwuY2xhc3NOYW1lID0gJ2xpZ2h0LXBvb2wnOwogICAgICAgICAgICAgICAgZWwuc3R5bGUuY3NzVGV4dCA9IGBsZWZ0OiR7ZC54IC0gZC5zaXplLzJ9cHg7IHRvcDoke2QueSAtIGQuc2l6ZS8yfXB4OyB3aWR0aDoke2Quc2l6ZX1weDsgaGVpZ2h0OiR7ZC5zaXplfXB4O2A7CiAgICAgICAgICAgICAgICByb29tLmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBkZWNvcmF0aW9ucy5maWx0ZXIoZCA9PiBkLnR5cGUgIT09ICdsaWdodCcpLmZvckVhY2goZGVjID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSBkZWMudHlwZSA9PT0gJ2JhcicgPyAnYmFyLWNvdW50ZXInIDogZGVjLnR5cGUgPT09ICdzdGFnZScgPyAnc3RhZ2UnIDogZGVjLnR5cGUgPT09ICd0YWJsZScgPyAndGFibGUtcm91bmQnIDogZGVjLnR5cGUgPT09ICdwaWxsYXInID8gJ3BpbGxhcicgOiBkZWMudHlwZSA9PT0gJ2Jhbm5lcicgPyAnYmFubmVyJyA6IGRlYy50eXBlOwogICAgICAgICAgICAgICAgZWwuc3R5bGUubGVmdCA9IGRlYy54ICsgJ3B4JzsKICAgICAgICAgICAgICAgIGVsLnN0eWxlLnRvcCA9IGRlYy55ICsgJ3B4JzsKICAgICAgICAgICAgICAgIGlmIChkZWMuZW1vamkpIGVsLnRleHRDb250ZW50ID0gZGVjLmVtb2ppOwogICAgICAgICAgICAgICAgaWYgKGRlYy50ZXh0KSBlbC50ZXh0Q29udGVudCA9IGRlYy50ZXh0OwogICAgICAgICAgICAgICAgcm9vbS5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY3Jvd2RHcm91cHMuZm9yRWFjaCgoZ3JvdXApID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSAnY3Jvd2QtZ3JvdXAnOwogICAgICAgICAgICAgICAgZWwuc3R5bGUubGVmdCA9IGdyb3VwLnggKyAncHgnOwogICAgICAgICAgICAgICAgZWwuc3R5bGUudG9wID0gZ3JvdXAueSArICdweCc7CiAgICAgICAgICAgICAgICBlbC5pbm5lckhUTUwgPSBgPGRpdiBjbGFzcz0iY3Jvd2QtYnViYmxlIj4ke2dyb3VwLmNoYXR9PC9kaXY+JHtncm91cC5wZW9wbGUubWFwKHAgPT4gYDxzcGFuIGNsYXNzPSJjcm93ZC1wZXJzb24iPiR7cH08L3NwYW4+YCkuam9pbignJyl9YDsKICAgICAgICAgICAgICAgIHJvb20uYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIG5wY3MuZm9yRWFjaChucGMgPT4gewogICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTmFtZSA9ICducGMnOwogICAgICAgICAgICAgICAgZWwuaWQgPSBgbnBjLSR7bnBjLmlkfWA7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS5sZWZ0ID0gbnBjLnggKyAncHgnOwogICAgICAgICAgICAgICAgZWwuc3R5bGUudG9wID0gbnBjLnkgKyAncHgnOwoKICAgICAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IDEyNTsKICAgICAgICAgICAgICAgIGxldCBhY3Rpb25zSFRNTCA9ICcnOwogICAgICAgICAgICAgICAgQUNUSU9OUy5mb3JFYWNoKChhY3Rpb24sIGkpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbmdsZSA9IChpIC8gQUNUSU9OUy5sZW5ndGgpICogMiAqIE1hdGguUEkgLSBNYXRoLlBJIC8gMjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBheCA9IDE3MCArIE1hdGguY29zKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgICAgICBjb25zdCBheSA9IDE3MCArIE1hdGguc2luKGFuZ2xlKSAqIHJhZGl1czsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25zSFRNTCArPSBgCiAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9InJhZGlhbC1hY3Rpb24gJHthY3Rpb24uaXNFeGl0ID8gJ2V4aXQtYWN0aW9uJyA6ICcnfSIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU9ImxlZnQ6JHtheH1weDsgdG9wOiR7YXl9cHg7IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uY2xpY2s9InBlcmZvcm1BY3Rpb24oJyR7bnBjLmlkfScsICcke2FjdGlvbi5pZH0nKTsgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7Ij4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJhY3Rpb24taWNvbiI+JHthY3Rpb24uaWNvbn08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iYWN0aW9uLWxhYmVsIj4ke2FjdGlvbi5sYWJlbH08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAke2FjdGlvbi5zb2NpYWxDb3N0ID4gMCA/IGA8c3BhbiBjbGFzcz0iYWN0aW9uLWNvc3QiPi0ke2FjdGlvbi5zb2NpYWxDb3N0fTwvc3Bhbj5gIDogJyd9CiAgICAgICAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgIGA7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBlbC5pbm5lckhUTUwgPSBgCiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Im5wYy1hdmF0YXIiPiR7bnBjLmF2YXRhcn08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Im5wYy12aWJlIj4ke25wYy52aWJlfTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0ibnBjLW5hbWUtdGFnIj4ke25wYy5uYW1lfTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyYXBwb3J0LWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJhcHBvcnQtbGFiZWwiPlJhcHBvcnQ8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmFwcG9ydC1iYXIiPjxkaXYgY2xhc3M9InJhcHBvcnQtZmlsbCIgaWQ9InJhcHBvcnQtJHtucGMuaWR9Ij48L2Rpdj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJyYWRpYWwtbWVudSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJhZGlhbC1jZW50ZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icmMtbmFtZSI+JHtucGMubmFtZX08L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InJjLXJvbGUiPiR7bnBjLnJvbGV9PC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAke2FjdGlvbnNIVE1MfQogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgYDsKICAgICAgICAgICAgICAgIHJvb20uYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHVwZGF0ZVBsYXllclBvc2l0aW9uKCk7CiAgICAgICAgICAgIHVwZGF0ZU1pbmltYXAoKTsKICAgICAgICB9CgogICAgICAgIC8vID09PT09IEdBTUUgTE9PUCA9PT09PQogICAgICAgIGZ1bmN0aW9uIGdhbWVMb29wKCkgewogICAgICAgICAgICBpZiAoIWdhbWVTdGF0ZS5nYW1lQWN0aXZlKSByZXR1cm47CiAgICAgICAgICAgIGhhbmRsZU1vdmVtZW50KCk7CiAgICAgICAgICAgIGNoZWNrTmVhcmJ5TlBDcygpOwogICAgICAgICAgICB1cGRhdGVDYW1lcmEoKTsKICAgICAgICAgICAgdXBkYXRlTWluaW1hcCgpOwogICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZ2FtZUxvb3ApOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaGFuZGxlTW92ZW1lbnQoKSB7CiAgICAgICAgICAgIGxldCBkeCA9IDAsIGR5ID0gMDsKICAgICAgICAgICAgaWYgKGdhbWVTdGF0ZS5rZXlzUHJlc3NlZFsnS2V5VyddIHx8IGdhbWVTdGF0ZS5rZXlzUHJlc3NlZFsnQXJyb3dVcCddKSBkeSAtPSBQTEFZRVJfU1BFRUQ7CiAgICAgICAgICAgIGlmIChnYW1lU3RhdGUua2V5c1ByZXNzZWRbJ0tleVMnXSB8fCBnYW1lU3RhdGUua2V5c1ByZXNzZWRbJ0Fycm93RG93biddKSBkeSArPSBQTEFZRVJfU1BFRUQ7CiAgICAgICAgICAgIGlmIChnYW1lU3RhdGUua2V5c1ByZXNzZWRbJ0tleUEnXSB8fCBnYW1lU3RhdGUua2V5c1ByZXNzZWRbJ0Fycm93TGVmdCddKSBkeCAtPSBQTEFZRVJfU1BFRUQ7CiAgICAgICAgICAgIGlmIChnYW1lU3RhdGUua2V5c1ByZXNzZWRbJ0tleUQnXSB8fCBnYW1lU3RhdGUua2V5c1ByZXNzZWRbJ0Fycm93UmlnaHQnXSkgZHggKz0gUExBWUVSX1NQRUVEOwogICAgICAgICAgICBpZiAoZHggJiYgZHkpIHsgZHggKj0gMC43MDc7IGR5ICo9IDAuNzA3OyB9CgogICAgICAgICAgICBpZiAoZHggPT09IDAgJiYgZHkgPT09IDApIHJldHVybjsKCiAgICAgICAgICAgIGxldCBuZXdYID0gZ2FtZVN0YXRlLnBsYXllclggKyBkeCwgbmV3WSA9IGdhbWVTdGF0ZS5wbGF5ZXJZICsgZHk7CiAgICAgICAgICAgIGxldCBibG9ja2VkID0gZmFsc2U7CgogICAgICAgICAgICBjcm93ZEdyb3Vwcy5mb3JFYWNoKGcgPT4geyBpZiAoTWF0aC5oeXBvdChnLnggLSBuZXdYLCBnLnkgLSBuZXdZKSA8IENST1dEX1JBRElVUykgYmxvY2tlZCA9IHRydWU7IH0pOwogICAgICAgICAgICBkZWNvcmF0aW9ucy5mb3JFYWNoKGQgPT4gewogICAgICAgICAgICAgICAgaWYgKChkLnR5cGUgPT09ICd0YWJsZScgfHwgZC50eXBlID09PSAncGlsbGFyJykgJiYgTWF0aC5oeXBvdChkLnggLSBuZXdYLCBkLnkgLSBuZXdZKSA8IDUwKSBibG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIWJsb2NrZWQpIHsKICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wbGF5ZXJYID0gTWF0aC5tYXgoNDAsIE1hdGgubWluKFJPT01fV0lEVEggLSA0MCwgbmV3WCkpOwogICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnBsYXllclkgPSBNYXRoLm1heCg0MCwgTWF0aC5taW4oUk9PTV9IRUlHSFQgLSA0MCwgbmV3WSkpOwogICAgICAgICAgICAgICAgdXBkYXRlUGxheWVyUG9zaXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUGxheWVyUG9zaXRpb24oKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyJyk7CiAgICAgICAgICAgIHAuc3R5bGUubGVmdCA9IChnYW1lU3RhdGUucGxheWVyWCAtIDMwKSArICdweCc7CiAgICAgICAgICAgIHAuc3R5bGUudG9wID0gKGdhbWVTdGF0ZS5wbGF5ZXJZIC0gMzApICsgJ3B4JzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNhbWVyYSgpIHsKICAgICAgICAgICAgY29uc3QgYXJlYSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lLWFyZWEnKTsKICAgICAgICAgICAgY29uc3Qgcm9vbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyb29tLWNvbnRhaW5lcicpOwogICAgICAgICAgICBjb25zdCB2dyA9IGFyZWEuY2xpZW50V2lkdGgsIHZoID0gYXJlYS5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgIGxldCBjeCA9IE1hdGgubWF4KDAsIE1hdGgubWluKFJPT01fV0lEVEggLSB2dywgZ2FtZVN0YXRlLnBsYXllclggLSB2dyAvIDIpKTsKICAgICAgICAgICAgbGV0IGN5ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oUk9PTV9IRUlHSFQgLSB2aCwgZ2FtZVN0YXRlLnBsYXllclkgLSB2aCAvIDIpKTsKICAgICAgICAgICAgcm9vbS5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7LWN4fXB4LCAkey1jeX1weClgOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2hlY2tOZWFyYnlOUENzKCkgewogICAgICAgICAgICBucGNzLmZvckVhY2gobnBjID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYG5wYy0ke25wYy5pZH1gKTsKICAgICAgICAgICAgICAgIGlmIChnYW1lU3RhdGUubnBjRG9uZS5oYXMobnBjLmlkKSkgewogICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5hZGQoJ2RvbmUnKTsKICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKCduZWFyYnknKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5oeXBvdChucGMueCAtIGdhbWVTdGF0ZS5wbGF5ZXJYLCBucGMueSAtIGdhbWVTdGF0ZS5wbGF5ZXJZKTsKICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC50b2dnbGUoJ25lYXJieScsIGRpc3QgPCBJTlRFUkFDVElPTl9ESVNUQU5DRSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IHJhcHBvcnRGaWxsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYHJhcHBvcnQtJHtucGMuaWR9YCk7CiAgICAgICAgICAgICAgICBpZiAocmFwcG9ydEZpbGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXBwb3J0ID0gTWF0aC5taW4oMTAwLCBNYXRoLm1heCgwLCBnYW1lU3RhdGUubnBjUmFwcG9ydFtucGMuaWRdKSk7CiAgICAgICAgICAgICAgICAgICAgcmFwcG9ydEZpbGwuc3R5bGUud2lkdGggPSByYXBwb3J0ICsgJyUnOwogICAgICAgICAgICAgICAgICAgIHJhcHBvcnRGaWxsLmNsYXNzTGlzdC50b2dnbGUoJ3JlYWR5JywgcmFwcG9ydCA+PSBSQVBQT1JUX1RIUkVTSE9MRCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gPT09PT0gQUNUSU9OUyA9PT09PQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1BY3Rpb24obnBjSWQsIGFjdGlvbklkKSB7CiAgICAgICAgICAgIGNvbnN0IG5wYyA9IG5wY3MuZmluZChuID0+IG4uaWQgPT09IG5wY0lkKTsKICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gQUNUSU9OUy5maW5kKGEgPT4gYS5pZCA9PT0gYWN0aW9uSWQpOwogICAgICAgICAgICBpZiAoIW5wYyB8fCAhYWN0aW9uIHx8IGdhbWVTdGF0ZS5ucGNEb25lLmhhcyhucGNJZCkpIHJldHVybjsKCiAgICAgICAgICAgIGlmIChnYW1lU3RhdGUuc29jaWFsRW5lcmd5IDwgYWN0aW9uLnNvY2lhbENvc3QpIHsKICAgICAgICAgICAgICAgIHNob3dUb2FzdCh7IGljb246ICfwn5irJywgdGl0bGU6ICdOZWVkIGEgQnJlYWshJywgbWVzc2FnZTogJ1Zpc2l0IE1hcmN1cyB0aGUgYmFydGVuZGVyISDwn424JywgZWZmZWN0czogW3sgdHlwZTogJ25lZ2F0aXZlJywgdGV4dDogJ0xvdyBzb2NpYWwgZW5lcmd5JyB9XSB9KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZ2FtZVN0YXRlLnNvY2lhbEVuZXJneSA9IE1hdGgubWF4KDAsIGdhbWVTdGF0ZS5zb2NpYWxFbmVyZ3kgLSBhY3Rpb24uc29jaWFsQ29zdCk7CiAgICAgICAgICAgIGdhbWVTdGF0ZS5lbmVyZ3kgPSBNYXRoLm1heCgwLCBnYW1lU3RhdGUuZW5lcmd5IC0gYWN0aW9uLmVuZXJneUNvc3QpOwogICAgICAgICAgICBsZXQgZWZmZWN0cyA9IFtdOwogICAgICAgICAgICBpZiAoYWN0aW9uLnNvY2lhbENvc3QgPiAwKSBlZmZlY3RzLnB1c2goeyB0eXBlOiAnbmV1dHJhbCcsIHRleHQ6IGAtJHthY3Rpb24uc29jaWFsQ29zdH0g8J+SrGAgfSk7CgogICAgICAgICAgICBpZiAoYWN0aW9uLmlzRXhpdCkgewogICAgICAgICAgICAgICAgY29tcGxldGVDb252ZXJzYXRpb24obnBjSWQpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIGNvbnZlcnNhdGlvbiBzdGF0ZSBmb3IgdGhpcyBOUEMgaWYgbmVlZGVkCiAgICAgICAgICAgIGlmICghZ2FtZVN0YXRlLm5wY09wZW5lZCkgZ2FtZVN0YXRlLm5wY09wZW5lZCA9IHt9OwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IHJhcHBvcnRDaGFuZ2UgPSAwOwogICAgICAgICAgICBsZXQgZmVlZGJhY2sgPSAnJzsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENMRUFSIFBST0dSRVNTSU9OIExPR0lDCiAgICAgICAgICAgIGlmIChhY3Rpb24udHlwZSA9PT0gJ29wZW5lcicpIHsKICAgICAgICAgICAgICAgIC8vIE9wZW5lcnMgYWx3YXlzIHdvcmsgd2VsbCEKICAgICAgICAgICAgICAgIHJhcHBvcnRDaGFuZ2UgPSAzMDsKICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5ucGNPcGVuZWRbbnBjSWRdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZlZWRiYWNrID0gJ/Cfjq8gR3JlYXQgaWNlIGJyZWFrZXIhJzsKICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh7IHR5cGU6ICdwb3NpdGl2ZScsIHRleHQ6IGArJHtyYXBwb3J0Q2hhbmdlfSByYXBwb3J0YCB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24udHlwZSA9PT0gJ2VuZ2FnZXInKSB7CiAgICAgICAgICAgICAgICAvLyBFbmdhZ2VycyB3b3JrIEdSRUFUIGFmdGVyIG9wZW5lciwgcG9vcmx5IHdpdGhvdXQKICAgICAgICAgICAgICAgIGlmIChnYW1lU3RhdGUubnBjT3BlbmVkW25wY0lkXSkgewogICAgICAgICAgICAgICAgICAgIHJhcHBvcnRDaGFuZ2UgPSA0NTsKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjayA9ICfinKggUGVyZmVjdCBmb2xsb3ctdXAhJzsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goeyB0eXBlOiAncG9zaXRpdmUnLCB0ZXh0OiBgKyR7cmFwcG9ydENoYW5nZX0gcmFwcG9ydGAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJhcHBvcnRDaGFuZ2UgPSAxMDsKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjayA9ICfwn6SUIFRyeSBhIGxpZ2h0IG9wZW5lciBmaXJzdCEnOwogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh7IHR5cGU6ICduZXV0cmFsJywgdGV4dDogYCske3JhcHBvcnRDaGFuZ2V9ICh1c2Ug8J+YhPCfjJ/inZMgZmlyc3QhKWAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGdhbWVTdGF0ZS5ucGNSYXBwb3J0W25wY0lkXSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEwMCwgKGdhbWVTdGF0ZS5ucGNSYXBwb3J0W25wY0lkXSB8fCAwKSArIHJhcHBvcnRDaGFuZ2UpKTsKCiAgICAgICAgICAgIC8vIERpZmZpY3VsdCBOUENzIGRyYWluIGV4dHJhIGVuZXJneQogICAgICAgICAgICBpZiAobnBjLmVuZXJneURyYWluKSB7CiAgICAgICAgICAgICAgICBnYW1lU3RhdGUuZW5lcmd5ID0gTWF0aC5tYXgoMCwgZ2FtZVN0YXRlLmVuZXJneSAtIG5wYy5lbmVyZ3lEcmFpbik7CiAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goeyB0eXBlOiAnbmVnYXRpdmUnLCB0ZXh0OiBgLSR7bnBjLmVuZXJneURyYWlufSDimqEgZHJhaW5pbmchYCB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobnBjLnNvY2lhbERyYWluKSB7CiAgICAgICAgICAgICAgICBnYW1lU3RhdGUuc29jaWFsRW5lcmd5ID0gTWF0aC5tYXgoMCwgZ2FtZVN0YXRlLnNvY2lhbEVuZXJneSAtIG5wYy5zb2NpYWxEcmFpbik7CiAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goeyB0eXBlOiAnbmVnYXRpdmUnLCB0ZXh0OiBgLSR7bnBjLnNvY2lhbERyYWlufSDwn5KsYCB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQmFydGVuZGVyIGluc3RhbnQgY29tcGxldGUKICAgICAgICAgICAgaWYgKG5wYy5pbnN0YW50Q29tcGxldGUpIHsKICAgICAgICAgICAgICAgIGlmIChucGMuZW5lcmd5Qm9udXMpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUuZW5lcmd5ID0gTWF0aC5taW4oMTAwLCBnYW1lU3RhdGUuZW5lcmd5ICsgbnBjLmVuZXJneUJvbnVzKTsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goeyB0eXBlOiAncG9zaXRpdmUnLCB0ZXh0OiBgKyR7bnBjLmVuZXJneUJvbnVzfSDimqEgcmVmcmVzaGVkIWAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobnBjLnNvY2lhbEJvbnVzKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnNvY2lhbEVuZXJneSA9IE1hdGgubWluKFNUQVJUSU5HX1NPQ0lBTCwgZ2FtZVN0YXRlLnNvY2lhbEVuZXJneSArIG5wYy5zb2NpYWxCb251cyk7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cy5wdXNoKHsgdHlwZTogJ3Bvc2l0aXZlJywgdGV4dDogYCske25wYy5zb2NpYWxCb251c30g8J+SrCBncmVhdCBjaGF0IWAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBnYW1lU3RhdGUubnBjRG9uZS5hZGQobnBjSWQpOwogICAgICAgICAgICAgICAgZ2FtZVN0YXRlLmNvbm5lY3Rpb25zLnB1c2goeyBuYW1lOiBucGMubmFtZSwgYXZhdGFyOiBucGMuYXZhdGFyLCBzdWNjZXNzOiB0cnVlLCByZXNvdXJjZTogbnVsbCB9KTsKICAgICAgICAgICAgICAgIHNob3dUb2FzdCh7IGljb246ICfwn424JywgdGl0bGU6ICdDaGVlcnMhJywgbWVzc2FnZTogJyJHbyB0YWxrIHRvIHRoZSBrZXkgY29udGFjdHMgLSB0aGV5IGhhdmUgdGhlIHNwYXJrbGUg4pyoISInLCBlZmZlY3RzIH0pOwogICAgICAgICAgICAgICAgdXBkYXRlSFVEKCk7CiAgICAgICAgICAgICAgICBjaGVja0dhbWVFbmQoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgY3VycmVudFJhcHBvcnQgPSBnYW1lU3RhdGUubnBjUmFwcG9ydFtucGNJZF07CiAgICAgICAgICAgIGxldCBtZXNzYWdlID0gJyc7CiAgICAgICAgICAgIGlmIChjdXJyZW50UmFwcG9ydCA+PSBSQVBQT1JUX1RIUkVTSE9MRCkgewogICAgICAgICAgICAgICAgbWVzc2FnZSA9ICfinIUgUmVhZHkhIENsaWNrIPCfkYsgV3JhcCBVcCEnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGdhbWVTdGF0ZS5ucGNPcGVuZWRbbnBjSWRdKSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gJ05vdyB0cnkg8J+RgvCfk5bwn5K8IHRvIGNvbm5lY3QgZGVlcGVyISc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gJ1N0YXJ0IHdpdGgg8J+YhPCfjJ/inZMgdG8gYnJlYWsgdGhlIGljZSEnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzaG93VG9hc3QoeyBpY29uOiByYXBwb3J0Q2hhbmdlID49IDMwID8gJ/CfkqwnIDogJ/Cfkq0nLCB0aXRsZTogZmVlZGJhY2ssIG1lc3NhZ2UsIGVmZmVjdHMgfSk7CiAgICAgICAgICAgIHVwZGF0ZUhVRCgpOwogICAgICAgICAgICBjaGVja0dhbWVFbmQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVDb252ZXJzYXRpb24obnBjSWQpIHsKICAgICAgICAgICAgY29uc3QgbnBjID0gbnBjcy5maW5kKG4gPT4gbi5pZCA9PT0gbnBjSWQpOwogICAgICAgICAgICBjb25zdCByYXBwb3J0ID0gZ2FtZVN0YXRlLm5wY1JhcHBvcnRbbnBjSWRdIHx8IDA7CiAgICAgICAgICAgIAogICAgICAgICAgICBnYW1lU3RhdGUubnBjRG9uZS5hZGQobnBjSWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgbGV0IHN1Y2Nlc3MgPSByYXBwb3J0ID49IFJBUFBPUlRfVEhSRVNIT0xEOwogICAgICAgICAgICBsZXQgZWZmZWN0cyA9IFtdOwogICAgICAgICAgICBsZXQgdGl0bGUsIG1lc3NhZ2UsIGljb247CgogICAgICAgICAgICBpZiAoc3VjY2VzcyAmJiBucGMucmVzb3VyY2UgJiYgIWdhbWVTdGF0ZS5yZXNvdXJjZXNbbnBjLnJlc291cmNlXSkgewogICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnJlc291cmNlc1tucGMucmVzb3VyY2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGByZXMtJHtucGMucmVzb3VyY2V9YCkuY2xhc3NMaXN0LmFkZCgnYWNxdWlyZWQnKTsKICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh7IHR5cGU6ICdwb3NpdGl2ZScsIHRleHQ6IGDwn46vICske2dldFJlc291cmNlTmFtZShucGMucmVzb3VyY2UpfSFgIH0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBSRVNPVVJDRSBCT05VU0VTIQogICAgICAgICAgICAgICAgaWYgKG5wYy5yZXNvdXJjZSA9PT0gJ2J1ZGdldCcpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUuZW5lcmd5ID0gTWF0aC5taW4oMTAwLCBnYW1lU3RhdGUuZW5lcmd5ICsgMjApOwogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh7IHR5cGU6ICdwb3NpdGl2ZScsIHRleHQ6ICcrMjAg4pqhIGVuZXJneSEnIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChucGMucmVzb3VyY2UgPT09ICdjaGFtcGlvbicpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUuc29jaWFsRW5lcmd5ID0gTWF0aC5taW4oU1RBUlRJTkdfU09DSUFMLCBnYW1lU3RhdGUuc29jaWFsRW5lcmd5ICsgMjUpOwogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh7IHR5cGU6ICdwb3NpdGl2ZScsIHRleHQ6ICcrMjUg8J+SrCBzb2NpYWwhJyB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobnBjLnJlc291cmNlID09PSAndGVjaCcpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUuZW5lcmd5ID0gTWF0aC5taW4oMTAwLCBnYW1lU3RhdGUuZW5lcmd5ICsgMTUpOwogICAgICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5zb2NpYWxFbmVyZ3kgPSBNYXRoLm1pbihTVEFSVElOR19TT0NJQUwsIGdhbWVTdGF0ZS5zb2NpYWxFbmVyZ3kgKyAxNSk7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cy5wdXNoKHsgdHlwZTogJ3Bvc2l0aXZlJywgdGV4dDogJysxNSDimqEgKzE1IPCfkqwhJyB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobnBjLnJlc291cmNlID09PSAnaW50ZWwnKSB7CiAgICAgICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnNvY2lhbEVuZXJneSA9IE1hdGgubWluKFNUQVJUSU5HX1NPQ0lBTCwgZ2FtZVN0YXRlLnNvY2lhbEVuZXJneSArIDIwKTsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goeyB0eXBlOiAncG9zaXRpdmUnLCB0ZXh0OiAnKzIwIPCfkqwgc29jaWFsIScgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRpdGxlID0gJ/CfjokgUmVzb3VyY2UgU2VjdXJlZCEnOwogICAgICAgICAgICAgICAgbWVzc2FnZSA9IG5wYy5pZCA9PT0gJ2NmbycgPyAnIkxldFwncyBkaXNjdXNzIGZ1bmRpbmcgbmV4dCB3ZWVrISInIDoKICAgICAgICAgICAgICAgICAgICAgICAgICBucGMuaWQgPT09ICdzdnAnID8gJyJJXCdsbCBjaGFtcGlvbiB5b3UgYXQgdGhlIGJvYXJkISInIDoKICAgICAgICAgICAgICAgICAgICAgICAgICBucGMuaWQgPT09ICd0ZWNoZGlyJyA/ICciTXkgdGVhbSB3aWxsIGhlbHAhIicgOgogICAgICAgICAgICAgICAgICAgICAgICAgIG5wYy5pZCA9PT0gJ3N0cmF0ZWd5JyA/ICciSGVyZVwncyB3aGF0IHRoZSBib2FyZCBpcyB0aGlua2luZy4uLiInIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAnIkdyZWF0IGNvbm5lY3RpbmchIic7CiAgICAgICAgICAgICAgICBpY29uID0gJ/CfjoknOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIC8vIE5vbi1yZXNvdXJjZSBOUENzIGNhbiBzdGlsbCBnaXZlIHNtYWxsIGJvbnVzZXMKICAgICAgICAgICAgICAgIGlmIChucGMuc29jaWFsQm9udXMpIHsKICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUuc29jaWFsRW5lcmd5ID0gTWF0aC5taW4oU1RBUlRJTkdfU09DSUFMLCBnYW1lU3RhdGUuc29jaWFsRW5lcmd5ICsgbnBjLnNvY2lhbEJvbnVzKTsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goeyB0eXBlOiAncG9zaXRpdmUnLCB0ZXh0OiBgKyR7bnBjLnNvY2lhbEJvbnVzfSDwn5KsYCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChucGMuZW5lcmd5Qm9udXMgJiYgbnBjLmlkICE9PSAnYmFydGVuZGVyJykgewogICAgICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5lbmVyZ3kgPSBNYXRoLm1pbigxMDAsIGdhbWVTdGF0ZS5lbmVyZ3kgKyBucGMuZW5lcmd5Qm9udXMpOwogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh7IHR5cGU6ICdwb3NpdGl2ZScsIHRleHQ6IGArJHtucGMuZW5lcmd5Qm9udXN9IOKaoWAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aXRsZSA9ICdOaWNlIENvbm5lY3Rpb24hJzsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSAnIkxvdmVseSB0YWxraW5nIHRvIHlvdSEiJzsKICAgICAgICAgICAgICAgIGljb24gPSAn8J+RjSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aXRsZSA9ICdLZWVwIENoYXR0aW5nISc7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gJyJMZXRcJ3MgdGFsayBtb3JlISInOwogICAgICAgICAgICAgICAgaWNvbiA9ICfwn5GLJzsKICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh7IHR5cGU6ICduZXV0cmFsJywgdGV4dDogJ05lZWQgYSBiaXQgbW9yZSByYXBwb3J0JyB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZ2FtZVN0YXRlLmNvbm5lY3Rpb25zLnB1c2goeyBuYW1lOiBucGMubmFtZSwgYXZhdGFyOiBucGMuYXZhdGFyLCBzdWNjZXNzLCByZXNvdXJjZTogc3VjY2VzcyA/IG5wYy5yZXNvdXJjZSA6IG51bGwsIHJhcHBvcnQgfSk7CiAgICAgICAgICAgIHNob3dUb2FzdCh7IGljb24sIHRpdGxlLCBtZXNzYWdlLCBlZmZlY3RzIH0pOwogICAgICAgICAgICB1cGRhdGVIVUQoKTsKICAgICAgICAgICAgY2hlY2tHYW1lRW5kKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRSZXNvdXJjZU5hbWUoaykgewogICAgICAgICAgICByZXR1cm4geyBidWRnZXQ6ICdCdWRnZXQnLCBjaGFtcGlvbjogJ0NoYW1waW9uJywgdGVjaDogJ1RlY2ggSGVscCcsIGludGVsOiAnSW50ZWwnIH1ba10gfHwgazsKICAgICAgICB9CgogICAgICAgIGxldCB0b2FzdFRpbWVvdXQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHNob3dUb2FzdChkYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnb3V0Y29tZS10b2FzdCcpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3QtaWNvbicpLnRleHRDb250ZW50ID0gZGF0YS5pY29uOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3QtdGl0bGUnKS50ZXh0Q29udGVudCA9IGRhdGEudGl0bGU7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdC1tZXNzYWdlJykudGV4dENvbnRlbnQgPSBkYXRhLm1lc3NhZ2U7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdC1lZmZlY3RzJykuaW5uZXJIVE1MID0gZGF0YS5lZmZlY3RzLm1hcChlID0+IGA8ZGl2IGNsYXNzPSJ0b2FzdC1lZmZlY3QgJHtlLnR5cGV9Ij4ke2UudGV4dH08L2Rpdj5gKS5qb2luKCcnKTsKICAgICAgICAgICAgdC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgaWYgKHRvYXN0VGltZW91dCkgY2xlYXJUaW1lb3V0KHRvYXN0VGltZW91dCk7CiAgICAgICAgICAgIHRvYXN0VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gdC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSwgMTgwMCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1cGRhdGVIVUQoKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmVyZ3ktYmFyJykuc3R5bGUud2lkdGggPSBnYW1lU3RhdGUuZW5lcmd5ICsgJyUnOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5lcmd5LXRleHQnKS50ZXh0Q29udGVudCA9IE1hdGgucm91bmQoZ2FtZVN0YXRlLmVuZXJneSk7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb2NpYWwtYmFyJykuc3R5bGUud2lkdGggPSAoZ2FtZVN0YXRlLnNvY2lhbEVuZXJneSAvIFNUQVJUSU5HX1NPQ0lBTCAqIDEwMCkgKyAnJSc7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb2NpYWwtdGV4dCcpLnRleHRDb250ZW50ID0gTWF0aC5yb3VuZChnYW1lU3RhdGUuc29jaWFsRW5lcmd5KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VGltZXIoKSB7CiAgICAgICAgICAgIGNvbnN0IGludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFnYW1lU3RhdGUuZ2FtZUFjdGl2ZSkgeyBjbGVhckludGVydmFsKGludGVydmFsKTsgcmV0dXJuOyB9CiAgICAgICAgICAgICAgICBnYW1lU3RhdGUudGltZVJlbWFpbmluZy0tOwogICAgICAgICAgICAgICAgY29uc3QgbSA9IE1hdGguZmxvb3IoZ2FtZVN0YXRlLnRpbWVSZW1haW5pbmcgLyA2MCksIHMgPSBnYW1lU3RhdGUudGltZVJlbWFpbmluZyAlIDYwOwogICAgICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGltZXInKTsKICAgICAgICAgICAgICAgIGVsLmlubmVySFRNTCA9IGDij7HvuI8gJHttfToke3MudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7CiAgICAgICAgICAgICAgICBpZiAoZ2FtZVN0YXRlLnRpbWVSZW1haW5pbmcgPD0gMTUpIGVsLmNsYXNzTGlzdC5hZGQoJ3VyZ2VudCcpOwogICAgICAgICAgICAgICAgaWYgKGdhbWVTdGF0ZS50aW1lUmVtYWluaW5nIDw9IDApIHsgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7IGVuZEdhbWUoKTsgfQogICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1pbmltYXAoKSB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWluaW1hcC1jb250ZW50Jyk7CiAgICAgICAgICAgIGNvbnN0IHN4ID0gMTQwIC8gUk9PTV9XSURUSCwgc3kgPSAxMDAgLyBST09NX0hFSUdIVDsKICAgICAgICAgICAgbGV0IGggPSBgPGRpdiBjbGFzcz0ibWluaW1hcC1wbGF5ZXIiIHN0eWxlPSJsZWZ0OiR7Z2FtZVN0YXRlLnBsYXllclggKiBzeH1weDt0b3A6JHtnYW1lU3RhdGUucGxheWVyWSAqIHN5fXB4OyI+PC9kaXY+YDsKICAgICAgICAgICAgbnBjcy5mb3JFYWNoKG4gPT4gaCArPSBgPGRpdiBjbGFzcz0ibWluaW1hcC1ucGMgJHtnYW1lU3RhdGUubnBjRG9uZS5oYXMobi5pZCkgPyAnZG9uZScgOiAnYXZhaWxhYmxlJ30iIHN0eWxlPSJsZWZ0OiR7bi54ICogc3h9cHg7dG9wOiR7bi55ICogc3l9cHg7Ij48L2Rpdj5gKTsKICAgICAgICAgICAgY3Jvd2RHcm91cHMuZm9yRWFjaChnID0+IGggKz0gYDxkaXYgY2xhc3M9Im1pbmltYXAtbnBjIG1pbmltYXAtY3Jvd2QiIHN0eWxlPSJsZWZ0OiR7Zy54ICogc3h9cHg7dG9wOiR7Zy55ICogc3l9cHg7Ij48L2Rpdj5gKTsKICAgICAgICAgICAgYy5pbm5lckhUTUwgPSBoOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2hlY2tHYW1lRW5kKCkgewogICAgICAgICAgICBpZiAoT2JqZWN0LnZhbHVlcyhnYW1lU3RhdGUucmVzb3VyY2VzKS5ldmVyeSh2ID0+IHYpIHx8IGdhbWVTdGF0ZS5lbmVyZ3kgPD0gMCB8fCBnYW1lU3RhdGUuc29jaWFsRW5lcmd5IDw9IDApIGVuZEdhbWUoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGVuZEdhbWUoKSB7CiAgICAgICAgICAgIGdhbWVTdGF0ZS5nYW1lQWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIHN0b3BNdXNpYygpOwogICAgICAgICAgICBjb25zdCBjb3VudCA9IE9iamVjdC52YWx1ZXMoZ2FtZVN0YXRlLnJlc291cmNlcykuZmlsdGVyKHYgPT4gdikubGVuZ3RoOwogICAgICAgICAgICBjb25zdCB0aXRsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtdGl0bGUnKTsKICAgICAgICAgICAgaWYgKGNvdW50ID09PSA0KSB7IHRpdGxlLnRleHRDb250ZW50ID0gJ/Cfj4YgTmV0d29ya2luZyBMZWdlbmQhJzsgdGl0bGUuY2xhc3NOYW1lID0gJ3N1Y2Nlc3MnOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKGNvdW50ID49IDIpIHsgdGl0bGUudGV4dENvbnRlbnQgPSAn8J+RjSBHb29kIEh1c3RsZSEnOyB0aXRsZS5jbGFzc05hbWUgPSAncGFydGlhbCc7IH0KICAgICAgICAgICAgZWxzZSB7IHRpdGxlLnRleHRDb250ZW50ID0gJ/CfmIUgS2VlcCBQcmFjdGlzaW5nISc7IHRpdGxlLmNsYXNzTmFtZSA9ICdmYWlsdXJlJzsgfQogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjb3JlJykudGV4dENvbnRlbnQgPSBgJHtjb3VudH0vNGA7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdW1tYXJ5LWNvbnRlbnQnKS5pbm5lckhUTUwgPSBnYW1lU3RhdGUuY29ubmVjdGlvbnMubWFwKGMgPT4gCiAgICAgICAgICAgICAgICBgPGRpdiBjbGFzcz0ic3VtbWFyeS1pdGVtIj48c3Bhbj4ke2MuYXZhdGFyfTwvc3Bhbj48c3Bhbj4ke2MubmFtZX08L3NwYW4+PHNwYW4+JHtjLnN1Y2Nlc3MgPyAn4pyoJyA6ICfwn5GLJ30gJHtjLnJhcHBvcnQgIT09IHVuZGVmaW5lZCA/IGAoJHtjLnJhcHBvcnR9JSlgIDogJyd9ICR7Yy5yZXNvdXJjZSA/ICcrJyArIGdldFJlc291cmNlTmFtZShjLnJlc291cmNlKSA6ICcnfTwvc3Bhbj48L2Rpdj5gCiAgICAgICAgICAgICkuam9pbignJykgfHwgJzxwIHN0eWxlPSJjb2xvcjojYTBhZWMwOyI+Tm8gY29udmVyc2F0aW9ucyE8L3A+JzsKICAgICAgICAgICAgbGV0IGZiID0gJzxoNCBzdHlsZT0iY29sb3I6IzJjNTI4MjttYXJnaW4tYm90dG9tOjZweDsiPvCfkqEgVGlwczwvaDQ+PHVsIHN0eWxlPSJtYXJnaW4tbGVmdDoxNHB4OyI+JzsKICAgICAgICAgICAgaWYgKGNvdW50ID09PSA0KSBmYiArPSAnPGxpPlBlcmZlY3QhIFlvdVwncmUgYSBuYXR1cmFsIG5ldHdvcmtlciEg8J+MnzwvbGk+JzsKICAgICAgICAgICAgZWxzZSBmYiArPSAnPGxpPlVzZSAyLTMgYWN0aW9ucyBwZXIgcGVyc29uIHRvIGJ1aWxkIHJhcHBvcnQhPC9saT4nOwogICAgICAgICAgICBpZiAoZ2FtZVN0YXRlLmVuZXJneSA8PSAwIHx8IGdhbWVTdGF0ZS5zb2NpYWxFbmVyZ3kgPD0gMCkgZmIgKz0gJzxsaT5WaXNpdCBNYXJjdXMgdGhlIGJhcnRlbmRlciB0byByZWNoYXJnZSE8L2xpPic7CiAgICAgICAgICAgIGZiICs9ICc8L3VsPic7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbmQtZmVlZGJhY2snKS5pbm5lckhUTUwgPSBmYjsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtd3JhcHBlcicpLmNsYXNzTGlzdC5hZGQoJ2hpZGRlbicpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kLXNjcmVlbicpLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVzdGFydEdhbWUoKSB7IHN0YXJ0R2FtZSgpOyB9CgogICAgICAgIGZ1bmN0aW9uIHJldHVyblRvTWFpbkdhbWUoKSB7CiAgICAgICAgICAgIC8vIFNlbmQgcmVzdWx0cyBiYWNrIHRvIHBhcmVudCB3aW5kb3cKICAgICAgICAgICAgY29uc3QgcmVzb3VyY2VDb3VudCA9IE9iamVjdC52YWx1ZXMoZ2FtZVN0YXRlLnJlc291cmNlcykuZmlsdGVyKHYgPT4gdikubGVuZ3RoOwogICAgICAgICAgICB3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgICAgIHR5cGU6ICduZXB0dW5lQ29tcGxldGUnLAogICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBnYW1lU3RhdGUucmVzb3VyY2VzLAogICAgICAgICAgICAgICAgcmVzb3VyY2VDb3VudDogcmVzb3VyY2VDb3VudCwKICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25zOiBnYW1lU3RhdGUuY29ubmVjdGlvbnMKICAgICAgICAgICAgfSwgJyonKTsKICAgICAgICB9CgogICAgICAgIC8vID09PT09IElOUFVUID09PT09CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGUgPT4geyBnYW1lU3RhdGUua2V5c1ByZXNzZWRbZS5jb2RlXSA9IHRydWU7IH0pOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgZSA9PiB7IGdhbWVTdGF0ZS5rZXlzUHJlc3NlZFtlLmNvZGVdID0gZmFsc2U7IH0pOwoKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZHBhZC1idG4nKS5mb3JFYWNoKGJ0biA9PiB7CiAgICAgICAgICAgIGNvbnN0IGQgPSBidG4uZGF0YXNldC5kaXI7CiAgICAgICAgICAgIGNvbnN0IG1hcCA9IHsgdXA6ICdLZXlXJywgZG93bjogJ0tleVMnLCBsZWZ0OiAnS2V5QScsIHJpZ2h0OiAnS2V5RCcgfTsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSAoKSA9PiBnYW1lU3RhdGUua2V5c1ByZXNzZWRbbWFwW2RdXSA9IHRydWU7CiAgICAgICAgICAgIGNvbnN0IHN0b3AgPSAoKSA9PiBnYW1lU3RhdGUua2V5c1ByZXNzZWRbbWFwW2RdXSA9IGZhbHNlOwogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGUgPT4geyBlLnByZXZlbnREZWZhdWx0KCk7IHN0YXJ0KCk7IH0pOwogICAgICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBzdG9wKTsKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHN0YXJ0KTsKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBzdG9wKTsKICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBzdG9wKTsKICAgICAgICB9KTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpID0+IHsgaWYgKGdhbWVTdGF0ZS5nYW1lQWN0aXZlKSB1cGRhdGVDYW1lcmEoKTsgfSk7CiAgICA8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+Cg==";
        
        function showNeptuneIframe() {
            console.log('Opening Neptune Reception mini-game');
            playSound('networkingStart');
            // Neptune has its own music, so just stop main game music
            stopBackgroundMusic();
            
            const overlay = document.getElementById('neptune-iframe-overlay');
            const iframe = document.getElementById('neptune-iframe');
            
            // Decode base64 properly handling UTF-8
            const binaryString = atob(NEPTUNE_GAME_B64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: 'text/html; charset=utf-8' });
            const blobUrl = URL.createObjectURL(blob);
            
            iframe.src = blobUrl;
            overlay.style.display = 'block';
        }
        
        function closeNeptuneIframe(results) {
            console.log('Closing Neptune Reception with results:', results);
            
            const overlay = document.getElementById('neptune-iframe-overlay');
            const iframe = document.getElementById('neptune-iframe');
            
            // IMPORTANT: Clear iframe first to stop any audio playing inside
            iframe.src = 'about:blank';
            
            // Revoke blob URL to free memory
            if (iframe.src && iframe.src.startsWith('blob:')) {
                URL.revokeObjectURL(iframe.src);
            }
            
            overlay.style.display = 'none';
            
            // Apply rewards based on resources secured
            if (results && results.resources) {
                if (results.resources.budget) {
                    state.profitLoss += 100;
                    logChange('profitLoss', 100, state.profitLoss, '💰');
                }
                if (results.resources.champion) {
                    state.morale = Math.min(100, state.morale + 10);
                    state.purpose = Math.min(100, state.purpose + 5);
                    logChange('morale', 10, state.morale, '⭐');
                    logChange('purpose', 5, state.purpose, '⭐');
                }
                if (results.resources.tech) {
                    state.innovation = Math.min(100, state.innovation + 8);
                    state.templateProgress = Math.min(100, state.templateProgress + 10);
                    logChange('innovation', 8, state.innovation, '🔧');
                    logChange('templateProgress', 10, state.templateProgress, '🔧');
                }
                if (results.resources.intel) {
                    state.marketStrength = Math.min(50, (state.marketStrength || 0) + 5);
                    state.skill = Math.min(100, state.skill + 5);
                    logChange('marketStrength', 5, state.marketStrength, '🎯');
                    logChange('skill', 5, state.skill, '🎯');
                }
                
                const resourceCount = results.resourceCount || 0;
                logChange("🎉 Reception", "Secured " + resourceCount + "/4 resources at the Neptune Reception!", null, '🍸');
                
                playSound('reward');
            } else {
                logChange("🎉 Reception", "Attended the Neptune Reception", null, '🍸');
            }
            
            neptuneNetworkingCompleted = true;
            updateDashboard();
            
            // Continue to quarterly report
            showQuarterlyReportAfterNeptune();
        }
        
        // Listen for messages from the Neptune iframe
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'neptuneComplete') {
                console.log('Received Neptune completion message:', event.data);
                closeNeptuneIframe(event.data);
            }
        });


        // --- GAME STATE ---
        let state = {
            turn: 0, maxTurns: 12, venture: null, strategy: null,
            gameMode: 'normal', // 'short' or 'normal'
            profitLoss: 0, // Cumulative P&L over the game
            purpose: 50, innovation: 50, 
            templateStage: 'Prototype', templateProgress: 0,
            reach: 0, 
            targetReach: 15, baseMonthlyCost: 500, targetProfitMonth: 8, // baseMonthlyCost in £K
            costPressure: 0, // Additional costs from events (can be + or -)
            marketStrength: 0, // Revenue modifier from decisions (-50 to +50, affects revenue %)
            morale: 50, skill: 40,
            eventQueue: [], isModalOpen: true, globalShockFiredThisGame: false,
            monthlyChanges: {}, leadershipTeam: {}, 
            hiringPhase: { currentRoleIndex: 0, roles: ['finance', 'hr', 'ops', 'marketing', 'tech'] },
            passiveBonuses: {}, leaderModifiers: {}, performanceWarnings: 0,
            // Track initial values for scoring (set when game begins)
            initialValues: { purpose: 50, innovation: 50, skill: 40, morale: 50, templateProgress: 0 },
            // Track previous month values for transition reports
            previousValues: { purpose: 50, innovation: 50, skill: 40, morale: 50, reach: 0, templateProgress: 0, profitLoss: 0, marketStrength: 0 },
            // Current report values (populated when showing report)
            reportValues: null,
            // Investment levels per department (determines event effect multipliers)
            investments: { 
                finance: 'standard', 
                hr: 'standard', 
                ops: 'standard', 
                marketing: 'standard', 
                tech: 'standard' 
            },
            investmentCosts: { 
                finance: 0, 
                hr: 0, 
                ops: 0, 
                marketing: 0, 
                tech: 0 
            },
            totalMonthlyInvestment: 0, // Sum of all department investment adjustments (£K/month)
            usedEventIds: new Set(), totalRevenue: 0, totalCosts: 0,
            // Hasty decision tracking
            emailOpenedAt: null, // Timestamp when current email was opened
            hastyDecisions: 0,   // Count of rushed decisions
            hastyThresholdMs: 5000, // Minimum milliseconds before decision is considered thoughtful
            // AUTOPILOT DETECTION - Track choice patterns
            optionPositions: [], // Track which position (0, 1, 2) was chosen
            autopilotPenaltyApplied: 0, // Cumulative autopilot penalties
            consecutiveSamePosition: 0, // Count consecutive same-position choices
            lastPosition: -1 // Last option position chosen
        };
        
        // Investment tier configuration - relative to standard baseline
        const investmentTiers = {
            lean:      { cost: -100, multiplier: 0.6, label: 'Lean', signal: '↓↓' },
            reduced:   { cost: -50,  multiplier: 0.8, label: 'Reduced', signal: '↓' },
            standard:  { cost: 0,    multiplier: 1.0, label: 'Standard', signal: '→' },
            enhanced:  { cost: 100,  multiplier: 1.25, label: 'Enhanced', signal: '↑' },
            priority:  { cost: 200,  multiplier: 1.5, label: 'Priority', signal: '↑↑' }
        };
        
        // Base monthly cost per department (£K)
        const baseDeptCost = 100;
        
        const templateStages = ['Prototype', 'Basic', 'Advanced', 'Optimized'];
        const templateModifiers = {
            'Prototype': { revenueMult: 0.25, failurePenaltyMult: 3.0 },
            'Basic': { revenueMult: 0.50, failurePenaltyMult: 2.0 },
            'Advanced': { revenueMult: 0.75, failurePenaltyMult: 1.0 },
            'Optimized': { revenueMult: 1.00, failurePenaltyMult: 0.7 } 
        };

        let announcers = { finance: [{ name: 'Interim Finance', title: '💼' }], hr: [{ name: 'Interim HR', title: '🧑‍🤝‍🧑' }], ops: [{ name: 'Interim Ops', title: '🚚' }], marketing: [{ name: 'Interim Marketing', title: '📣' }], tech: [{ name: 'Interim Tech', title: '🔬' }] };
        
        // Candidates now have MODIFIERS that affect decision outcomes, not direct stat bonuses
        // - deptBonus: Extra multiplier on their department's decision effects (stacks with investment)
        // - templateMult: Multiplier on template progress gains from decisions
        // - innovationMult: Multiplier on innovation gains from decisions
        // - moraleMult: Multiplier on morale gains from decisions
        // - riskMod: Adjustment to success chances (+0.1 = 10% better odds)
        // Internal candidates: No hire cost, immediate effectiveness
        // External candidates: Higher hire cost, onboarding period before full effectiveness
        const candidates = {
            finance: [ 
                // INTERNAL: Know Neptune systems, reliable but conventional
                { id: 'fin1', name: 'Anya Sharma', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Finance)', 
                  strength: 'Cost-focused decisions more effective', weakness: 'Less effective at driving innovation', 
                  quirk: 'Excel shortcuts.',
                  modifiers: { deptBonus: 0.15, templateMult: 1.1, innovationMult: 0.8, riskMod: 0.05 },
                  cv: { title: 'Senior Financial Controller', years: 8, education: 'MBA, London Business School', prev: 'Neptune Corp (Internal Transfer)', skills: ['Cost Control', 'Forecasting', 'SAP'], avatar: { bg: '#e8d4f0', hair: '#2c1810', skin: '#d4a574', gender: 'f' }, summary: 'Meticulous financial professional with deep knowledge of Neptune\'s systems. Her cost discipline makes financial decisions more impactful, though she tends to favour proven approaches over experimentation.', history: [
                    { role: 'Senior Financial Controller', company: 'Neptune Home Care Division', period: '2021-Present', details: 'Led cost reduction initiative saving £12M annually. Implemented new forecasting model reducing variance by 40%.' },
                    { role: 'Financial Analyst', company: 'Neptune Corporate Finance', period: '2018-2021', details: 'Supported M&A due diligence on 3 acquisitions. Built financial models for new product launches.' },
                    { role: 'Associate', company: 'Deloitte', period: '2016-2018', details: 'Audit and assurance for FMCG clients. Gained Big 4 rigour and process discipline.' }
                ], achievements: ['Neptune CFO Award for Excellence 2022', 'Reduced divisional OpEx by 15% in 18 months', 'Black belt in Six Sigma'] } },
                
                { id: 'fin2', name: 'Marcus Thompson', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Treasury)', 
                  strength: 'Reduces financial risk on decisions', weakness: 'Slower to build new capabilities', 
                  quirk: 'Cash is king.',
                  modifiers: { deptBonus: 0.1, templateMult: 0.85, riskMod: 0.15, moraleMult: 1.0 },
                  cv: { title: 'Treasury Manager', years: 12, education: 'ACA Qualified', prev: 'Neptune Corporate Treasury', skills: ['Cash Management', 'FX Hedging', 'Banking'], avatar: { bg: '#d4e8f0', hair: '#4a4a4a', skin: '#c4956a', gender: 'm' }, summary: 'Conservative finance leader who protects against downside. His caution improves success rates on risky decisions, but he can slow down capability building.', history: [
                    { role: 'Treasury Manager', company: 'Neptune Corporation', period: '2018-Present', details: 'Manages £2B cash pool. Saved £15M through FX hedging strategy.' },
                    { role: 'Assistant Treasurer', company: 'Neptune Corporation', period: '2014-2018', details: 'Built Neptune\'s cash forecasting system. Zero overdraft fees in tenure.' },
                    { role: 'Finance Associate', company: 'KPMG', period: '2012-2014', details: 'Treasury advisory practice. Worked with multinational corporates.' }
                ], achievements: ['20+ years combined Neptune experience', 'Perfect cash forecasting accuracy 2023', 'Trusted by Neptune board'] } },
                
                // EXTERNAL: Fresh thinking, higher variance, but costs and onboarding time
                { id: 'fin3', name: 'Chen Wei', type: 'external', hireCost: 0.04, onboardingMonths: 3,
                  background: 'External (FinTech)', 
                  strength: 'Drives innovation in financial decisions', weakness: 'Takes time to learn Neptune systems', 
                  quirk: 'Wants crypto payroll.',
                  modifiers: { deptBonus: 0.15, innovationMult: 1.4, templateMult: 0.75, riskMod: -0.05 },
                  cv: { title: 'CFO', years: 6, education: 'MSc Finance, MIT', prev: 'Stripe, Revolut', skills: ['FinTech', 'Growth Finance', 'Automation'], avatar: { bg: '#f0e8d4', hair: '#1a1a1a', skin: '#f5e0c5', gender: 'm' }, summary: 'Fast-moving finance innovator from the startup world. Amplifies innovation outcomes but needs time to understand Neptune\'s established processes.', history: [
                    { role: 'CFO', company: 'GreenPay (Series B Startup)', period: '2022-2024', details: 'Raised $40M Series B. Built finance function from scratch. Implemented real-time treasury.' },
                    { role: 'Head of Finance', company: 'Revolut', period: '2019-2022', details: 'Scaled finance team 5x during hyper-growth. Pioneered automated expense systems.' },
                    { role: 'Financial Planning Lead', company: 'Stripe', period: '2018-2019', details: 'Built FP&A models for European expansion. Worked directly with founders.' }
                ], achievements: ['Forbes 30 Under 30 (Finance)', '3x startup exits', 'MIT FinTech Innovation Prize'] } }
            ],
            hr: [ 
                { id: 'hr1', name: 'Fatima Rossi', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Beverages)', 
                  strength: 'Boosts morale impact of people decisions', weakness: 'Less focus on skills development', 
                  quirk: 'Mandatory mindfulness.',
                  modifiers: { deptBonus: 0.15, moraleMult: 1.3, skillMult: 0.85, riskMod: 0.05 },
                  cv: { title: 'HR Business Partner', years: 10, education: 'MSc Org Psychology, CIPD', prev: 'Neptune Beverages Division', skills: ['Employee Engagement', 'Wellbeing', 'L&D'], avatar: { bg: '#f0d4e8', hair: '#1a1a1a', skin: '#c4956a', gender: 'f' }, summary: 'Passionate people leader who genuinely cares about employee wellbeing. HR decisions under her leadership have stronger morale impact.', history: [
                    { role: 'HR Business Partner', company: 'Neptune Beverages', period: '2020-Present', details: 'Achieved 92% employee engagement score. Launched award-winning wellbeing programme.' },
                    { role: 'L&D Manager', company: 'Neptune Corporate', period: '2017-2020', details: 'Built Neptune Academy online learning platform. Trained 5,000+ employees.' },
                    { role: 'HR Coordinator', company: 'Nestlé', period: '2014-2017', details: 'Graduate scheme then fast-track promotion. Focus on talent acquisition.' }
                ], achievements: ['Neptune People Champion Award 2023', 'Reduced turnover by 30% in her division', 'Certified mindfulness instructor'] } },
                
                { id: 'hr2', name: 'Isabelle Dubois', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Beauty)', 
                  strength: 'Strong at building consistent processes', weakness: 'Relies on proven methods only', 
                  quirk: 'Friday cakes.',
                  modifiers: { deptBonus: 0.1, templateMult: 1.2, innovationMult: 0.8, riskMod: 0.1 },
                  cv: { title: 'Regional HR Director', years: 14, education: 'BA Human Resources', prev: 'Neptune Beauty Division', skills: ['Local Hiring', 'Culture', 'Compliance'], avatar: { bg: '#e8f0d4', hair: '#8b6914', skin: '#f5d0c5', gender: 'f' }, summary: 'Long-serving HR leader who knows everyone and everything about Neptune. Excellent at building repeatable processes, less comfortable with experimentation.', history: [
                    { role: 'Regional HR Director, Europe', company: 'Neptune Beauty', period: '2018-Present', details: 'Manages HR for 3,000 employees across 12 countries. 98% local hiring rate.' },
                    { role: 'HR Manager, France', company: 'Neptune Beauty', period: '2013-2018', details: 'Built French team from 50 to 400. Expert in French labour law compliance.' },
                    { role: 'HR Officer', company: 'L\'Oréal', period: '2010-2013', details: 'Started career in beauty industry. Recruitment and employee relations.' }
                ], achievements: ['15 years zero tribunal cases', 'Built teams in 8 new markets', 'Known as "the culture keeper" internally'] } },
                
                { id: 'hr3', name: 'David Kim', type: 'external', hireCost: 0.05, onboardingMonths: 3,
                  background: 'External (McKinsey)', 
                  strength: 'Accelerates skill building', weakness: 'Can disrupt existing team dynamics', 
                  quirk: 'Buzzword heavy.',
                  modifiers: { deptBonus: 0.15, skillMult: 1.4, moraleMult: 0.8, riskMod: -0.05 },
                  cv: { title: 'Principal Consultant', years: 9, education: 'MBA, INSEAD', prev: 'McKinsey & Company', skills: ['Org Design', 'Change Mgmt', 'Talent Strategy'], avatar: { bg: '#d4f0e8', hair: '#1a1a1a', skin: '#f5e0c5', gender: 'm' }, summary: 'Elite consultant who brings world-class frameworks. His approach accelerates capability building but can sometimes disrupt team harmony.', history: [
                    { role: 'Principal', company: 'McKinsey & Company', period: '2019-2024', details: 'Led 20+ org transformation projects. Specialist in operating model design for consumer goods.' },
                    { role: 'Engagement Manager', company: 'McKinsey & Company', period: '2016-2019', details: 'Built firm\'s people analytics capability. Developed proprietary talent assessment tools.' },
                    { role: 'HR Analyst', company: 'Goldman Sachs', period: '2015-2016', details: 'Compensation benchmarking and workforce planning for EMEA.' }
                ], achievements: ['McKinsey Partner-track (declined to join industry)', 'Designed org structures for 5 FTSE 100 companies', 'Published in HBR on future of work'] } }
            ],
            ops: [ 
                { id: 'ops1', name: 'Kenji Tanaka', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Supply Chain)', 
                  strength: 'Accelerates template & process building', weakness: 'Resistant to new approaches', 
                  quirk: '"Kaizen" solves all.',
                  modifiers: { deptBonus: 0.15, templateMult: 1.3, innovationMult: 0.75, riskMod: 0.1 },
                  cv: { title: 'Supply Chain Director', years: 15, education: 'BEng, Six Sigma Black Belt', prev: 'Neptune Asia Supply Chain', skills: ['Lean Ops', 'Logistics', 'Quality'], avatar: { bg: '#f0f0d4', hair: '#1a1a1a', skin: '#f5e0c5', gender: 'm' }, summary: 'Operations perfectionist who optimises relentlessly. His systematic approach accelerates process development, though he resists experimentation.', history: [
                    { role: 'Supply Chain Director, Asia', company: 'Neptune Corporation', period: '2017-Present', details: 'Manages $500M supply chain. Reduced logistics costs 20% through network optimisation.' },
                    { role: 'Plant Manager', company: 'Neptune Japan', period: '2012-2017', details: 'Ran Neptune\'s most efficient factory globally. 99.7% quality rate.' },
                    { role: 'Production Engineer', company: 'Toyota', period: '2009-2012', details: 'Trained in Toyota Production System. Brings world-class lean manufacturing expertise.' }
                ], achievements: ['Neptune Operations Excellence Award (3x winner)', 'Implemented TPS across 4 Neptune factories', 'Authored internal "Neptune Way" operations manual'] } },
                
                { id: 'ops2', name: 'Ahmed Khan', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Manufacturing)', 
                  strength: 'Builds team capability reliably', weakness: 'Slower pace of change', 
                  quirk: 'Knows everyone.',
                  modifiers: { deptBonus: 0.1, moraleMult: 1.2, skillMult: 1.1, templateMult: 0.9, riskMod: 0.15 },
                  cv: { title: 'Plant Manager', years: 18, education: 'BEng Manufacturing', prev: 'Neptune Leeds Factory', skills: ['Cost Reduction', 'Team Mgmt', 'Safety'], avatar: { bg: '#d4e0f0', hair: '#1a1a1a', skin: '#c4956a', gender: 'm' }, summary: 'Old-school factory leader who gets the most from his teams. Reliable and low-risk, but not the fastest to implement change.', history: [
                    { role: 'Plant Manager', company: 'Neptune Leeds', period: '2015-Present', details: 'Runs Neptune\'s largest UK factory. Lowest cost-per-unit in European network.' },
                    { role: 'Production Manager', company: 'Neptune Leeds', period: '2010-2015', details: 'Rose through the ranks. Implemented shift patterns that improved output 25%.' },
                    { role: 'Line Supervisor', company: 'Neptune Leeds', period: '2006-2010', details: 'Started on factory floor. Deep understanding of frontline operations.' }
                ], achievements: ['18 years, zero lost-time accidents', 'Lowest staff turnover in Neptune manufacturing', '"Everyone\'s favourite boss" - internal survey'] } },
                
                { id: 'ops3', name: 'Maria Garcia', type: 'external', hireCost: 0.04, onboardingMonths: 2,
                  background: 'External (Ex-Amazon)', 
                  strength: 'Accelerates market expansion', weakness: 'May overlook sustainability concerns', 
                  quirk: 'Wants drones.',
                  modifiers: { deptBonus: 0.15, reachMult: 1.35, purposeMult: 0.8, riskMod: -0.05 },
                  cv: { title: 'Senior Operations Manager', years: 7, education: 'MSc Operations Research', prev: 'Amazon Logistics', skills: ['Automation', 'Scale-ups', 'Last Mile'], avatar: { bg: '#f0d4d4', hair: '#3d2314', skin: '#d4a574', gender: 'f' }, summary: 'Amazon-trained operations leader obsessed with speed and scale. Her approach accelerates market reach but sometimes at the expense of purpose alignment.', history: [
                    { role: 'Senior Ops Manager, Last Mile', company: 'Amazon', period: '2020-2024', details: 'Led rollout of same-day delivery to 15 new cities. Managed 2,000+ delivery partners.' },
                    { role: 'Operations Manager', company: 'Amazon Fresh', period: '2018-2020', details: 'Launched grocery delivery in 5 markets. Built cold chain from scratch.' },
                    { role: 'Supply Chain Analyst', company: 'Ocado', period: '2017-2018', details: 'Worked on automated warehouse systems. Exposure to cutting-edge logistics tech.' }
                ], achievements: ['Amazon Bar Raiser (elite interviewer status)', 'Fastest market launch in Amazon Fresh history', 'Patent pending on delivery route optimisation'] } }
            ],
            marketing: [ 
                { id: 'mkt1', name: 'Chloé Moreau', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Premium)', 
                  strength: 'Amplifies market reach from decisions', weakness: 'Campaigns can be resource-heavy', 
                  quirk: '"Aspirational luxury".',
                  modifiers: { deptBonus: 0.15, reachMult: 1.25, templateMult: 0.9, riskMod: 0.05 },
                  cv: { title: 'Brand Director', years: 11, education: 'MA Marketing, HEC Paris', prev: 'Neptune Premium Brands', skills: ['Luxury Branding', 'Campaign Strategy', 'PR'], avatar: { bg: '#f0e0f0', hair: '#8b6914', skin: '#f5d0c5', gender: 'f' }, summary: 'Sophisticated brand builder who creates desire. Marketing decisions under her leadership have amplified market impact.', history: [
                    { role: 'Brand Director', company: 'Neptune Premium Brands', period: '2020-Present', details: 'Relaunched Neptune\'s luxury skincare line. Achieved 40% price premium vs competitors.' },
                    { role: 'Senior Brand Manager', company: 'Neptune Beauty', period: '2016-2020', details: 'Led brand strategy for 3 product lines. Won Cannes Lions for "Real Beauty" campaign.' },
                    { role: 'Brand Manager', company: 'LVMH (Dior)', period: '2013-2016', details: 'Trained in luxury marketing at the highest level. Global campaign coordination.' }
                ], achievements: ['Cannes Lions Gold (2019)', 'Grew premium segment 60% in 3 years', 'LinkedIn Top Voice in Marketing'] } },
                
                { id: 'mkt2', name: 'Mei Lin', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Asia-Pacific)', 
                  strength: 'Strengthens purpose messaging', weakness: 'Slower to scale campaigns', 
                  quirk: 'Hyper-local focus.',
                  modifiers: { deptBonus: 0.1, purposeMult: 1.3, reachMult: 0.9, riskMod: 0.1 },
                  cv: { title: 'Regional Marketing Head', years: 13, education: 'MBA, NUS Singapore', prev: 'Neptune Asia-Pacific', skills: ['Emerging Markets', 'Localisation', 'Purpose'], avatar: { bg: '#f0f0e0', hair: '#1a1a1a', skin: '#f5e0c5', gender: 'f' }, summary: 'Purpose-driven marketer who connects brands with communities. Her approach amplifies purpose outcomes but can be slower to achieve scale.', history: [
                    { role: 'Regional Marketing Head, APAC', company: 'Neptune Corporation', period: '2018-Present', details: 'Built Neptune\'s purpose marketing playbook. Led "Clean Water" campaign reaching 50M.' },
                    { role: 'Marketing Director, Southeast Asia', company: 'Neptune Corporation', period: '2014-2018', details: 'Launched Neptune in Vietnam, Philippines. Adapted global brands for local markets.' },
                    { role: 'Brand Manager', company: 'Johnson & Johnson', period: '2011-2014', details: 'Healthcare marketing across Asia. Focus on maternal and child health.' }
                ], achievements: ['Neptune Purpose Award 2022', 'UN Partnership for "Clean Water" initiative', 'Speaks 5 languages fluently'] } },
                
                { id: 'mkt3', name: 'Sam Jones', type: 'external', hireCost: 0.04, onboardingMonths: 2,
                  background: 'External (Ad Agency)', 
                  strength: 'Drives innovative campaigns', weakness: 'Style over substance risk', 
                  quirk: 'Viral is "easy".',
                  modifiers: { deptBonus: 0.15, innovationMult: 1.4, purposeMult: 0.8, riskMod: -0.1 },
                  cv: { title: 'Creative Director', years: 8, education: 'BA Advertising', prev: 'Ogilvy, Wieden+Kennedy', skills: ['Digital Marketing', 'Social Media', 'Content'], avatar: { bg: '#e0f0e0', hair: '#6b4423', skin: '#f5d0c5', gender: 'm' }, summary: 'Creative genius who makes brands famous. Brings innovative thinking to marketing but his bold approach carries more variance.', history: [
                    { role: 'Creative Director', company: 'Wieden+Kennedy', period: '2021-2024', details: 'Led creative for Nike, KFC accounts. Multiple viral campaigns with 100M+ views.' },
                    { role: 'Associate Creative Director', company: 'Ogilvy', period: '2018-2021', details: 'Built social-first creative team. Pioneered TikTok marketing for CPG brands.' },
                    { role: 'Copywriter', company: 'BBH London', period: '2016-2018', details: 'Award-winning copy for Audi, Tesco. Learned craft from industry legends.' }
                ], achievements: ['D&AD Pencil winner (2x)', '5 campaigns with 100M+ organic reach', 'Youngest Creative Director at W+K London'] } }
            ],
            tech: [ 
                { id: 'tech1', name: 'Eva Schmidt', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune R&D)', 
                  strength: 'Amplifies innovation outcomes', weakness: 'Can over-engineer solutions', 
                  quirk: 'Chemical formulas.',
                  modifiers: { deptBonus: 0.15, innovationMult: 1.3, templateMult: 0.85, riskMod: 0.05 },
                  cv: { title: 'Head of R&D (PhD)', years: 16, education: 'PhD Chemistry, ETH Zurich', prev: 'Neptune Innovation Lab', skills: ['Product Dev', 'Patents', 'Research'], avatar: { bg: '#e0e0f0', hair: '#8b8b8b', skin: '#f5d0c5', gender: 'f' }, summary: 'Brilliant scientist who invents breakthrough products. Tech decisions under her leadership have amplified innovation impact.', history: [
                    { role: 'Head of R&D', company: 'Neptune Innovation Lab', period: '2018-Present', details: 'Leads 50-person research team. 12 patents filed, 3 breakthrough product platforms launched.' },
                    { role: 'Principal Scientist', company: 'Neptune R&D', period: '2012-2018', details: 'Invented Neptune\'s plant-based surfactant technology. Reduced environmental impact 60%.' },
                    { role: 'Research Scientist', company: 'BASF', period: '2008-2012', details: 'Fundamental research in green chemistry. Published 15 peer-reviewed papers.' }
                ], achievements: ['12 patents to her name', 'Royal Society of Chemistry Award', 'Neptune Innovator of the Year (2x)'] } },
                
                { id: 'tech2', name: 'Olivia Green', type: 'internal', hireCost: 0, onboardingMonths: 0,
                  background: 'Internal (Neptune Sustainability)', 
                  strength: 'Strengthens purpose in tech decisions', weakness: 'Less aggressive on scaling', 
                  quirk: 'Email carbon footprint.',
                  modifiers: { deptBonus: 0.1, purposeMult: 1.25, reachMult: 0.9, riskMod: 0.1 },
                  cv: { title: 'Sustainability Tech Lead', years: 7, education: 'MEng, Cambridge', prev: 'Neptune Sustainability Division', skills: ['Green Tech', 'LCA', 'Impact Measurement'], avatar: { bg: '#d4f0d4', hair: '#6b4423', skin: '#f5d0c5', gender: 'f' }, summary: 'Mission-driven technologist who built Neptune\'s sustainability measurement systems. Ensures tech decisions align with purpose.', history: [
                    { role: 'Sustainability Tech Lead', company: 'Neptune Corporation', period: '2021-Present', details: 'Built Neptune\'s carbon tracking platform. Achieved B-Corp tech certification.' },
                    { role: 'Environmental Analyst', company: 'Neptune Sustainability', period: '2018-2021', details: 'Developed life-cycle assessment tools for all Neptune products.' },
                    { role: 'Software Engineer', company: 'ThoughtWorks', period: '2017-2018', details: 'Social impact practice. Built tech for NGOs and social enterprises.' }
                ], achievements: ['Neptune Sustainability Champion 2023', 'Built industry-leading LCA platform', 'TEDx speaker on sustainable technology'] } },
                
                { id: 'tech3', name: 'Raj Patel', type: 'external', hireCost: 0.05, onboardingMonths: 3,
                  background: 'External (Ex-Google)', 
                  strength: 'Builds skills and capabilities fast', weakness: 'Big Tech expectations', 
                  quirk: 'Wants Rust rewrite.',
                  modifiers: { deptBonus: 0.15, skillMult: 1.4, templateMult: 1.15, riskMod: -0.05 },
                  cv: { title: 'Engineering Director', years: 10, education: 'MS Computer Science, Stanford', prev: 'Google, Microsoft', skills: ['Software Dev', 'AI/ML', 'Platform'], avatar: { bg: '#f0e0d4', hair: '#1a1a1a', skin: '#c4956a', gender: 'm' }, summary: 'World-class technologist who builds scalable systems. His approach accelerates skill building, though his expectations can be demanding.', history: [
                    { role: 'Engineering Director', company: 'Google', period: '2020-2024', details: 'Led 80-person team on Google Shopping. Built ML systems processing 1B+ queries daily.' },
                    { role: 'Senior Software Engineer', company: 'Google', period: '2017-2020', details: 'Core contributor to TensorFlow. Expertise in recommendation systems.' },
                    { role: 'Software Engineer', company: 'Microsoft', period: '2014-2017', details: 'Azure platform team. Built distributed systems at massive scale.' }
                ], achievements: ['Google Founder\'s Award recipient', '3 patents in machine learning', 'Stanford CS lecturer (adjunct)'] } }
            ]
        };

        const ventures = { 
            aqualux: { name: "AquaLux Refill Stations", stats: { reach: 2, purpose: 38, innovation: 22, purposeLabel: 'High', innovationLabel: 'Medium', templateStage: 'Basic', templateProgress: 28 }, weights: { ops: 2, purpose: 1, marketing: 1 } },
            frostvale: { name: "FrostVale Plant-Based", stats: { reach: 2, purpose: 33, innovation: 33, purposeLabel: 'Medium', innovationLabel: 'Medium', templateStage: 'Basic', templateProgress: 0 }, weights: { marketing: 2, innovation: 1, finance: 1 } }, 
            puriclean: { name: "PuriClean Sanitation", stats: { reach: 2, purpose: 38, innovation: 11, purposeLabel: 'High', innovationLabel: 'Low', templateStage: 'Prototype', templateProgress: 0 }, weights: { finance: 2, ops: 2, purpose: 1 } },
            mindspring: { name: "MindSpring Wellbeing", stats: { reach: 2, purpose: 22, innovation: 38, purposeLabel: 'Medium', innovationLabel: 'High', templateStage: 'Basic', templateProgress: 0 }, weights: { tech: 2, marketing: 2, hr: 1 } }
        };

        const ventureDetails = {
            aqualux: {
                icon: `<svg width="70" height="70" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#0077b6" opacity="0.15"/>
                    <path d="M50 22 C35 22 28 38 28 50 C28 68 38 78 50 78 C62 78 72 68 72 50 C72 38 65 22 50 22Z" fill="url(#aqualuxGradLg)"/>
                    <ellipse cx="50" cy="42" rx="10" ry="7" fill="white" opacity="0.5"/>
                    <path d="M20 50 A30 30 0 0 1 50 20" stroke="#00b4d8" stroke-width="4" fill="none" stroke-linecap="round"/>
                    <path d="M80 50 A30 30 0 0 1 50 80" stroke="#00b4d8" stroke-width="4" fill="none" stroke-linecap="round"/>
                    <polygon points="50,14 56,24 44,24" fill="#00b4d8"/>
                    <polygon points="50,86 44,76 56,76" fill="#00b4d8"/>
                    <defs><linearGradient id="aqualuxGradLg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#00b4d8"/><stop offset="100%" style="stop-color:#0077b6"/></linearGradient></defs>
                </svg>`,
                miniIcon: `<svg width="28" height="28" viewBox="0 0 100 100">
                    <path d="M50 15 C30 15 22 38 22 52 C22 75 35 85 50 85 C65 85 78 75 78 52 C78 38 70 15 50 15Z" fill="url(#aqMini)"/>
                    <ellipse cx="50" cy="40" rx="12" ry="8" fill="white" opacity="0.5"/>
                    <path d="M15 52 A35 35 0 0 1 50 15" stroke="#00b4d8" stroke-width="5" fill="none" stroke-linecap="round"/>
                    <path d="M85 52 A35 35 0 0 1 50 85" stroke="#00b4d8" stroke-width="5" fill="none" stroke-linecap="round"/>
                    <defs><linearGradient id="aqMini" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#00b4d8"/><stop offset="100%" style="stop-color:#0077b6"/></linearGradient></defs>
                </svg>`,
                description: "Deploy smart refill kiosks in shopping centres and transit hubs, letting consumers refill shampoo, soap, and cleaning products. Each station reduces plastic waste by up to 80% per household while offering premium brands at competitive prices.",
                markets: "Western Europe (UK, France, Germany), North America (major metros), Australia & New Zealand",
                consumers: "Urban professionals aged 25-45, eco-conscious families, premium shoppers who value sustainability",
                challenge: "Changing ingrained consumer habits around product packaging; high upfront hardware and installation costs; securing prime retail locations",
                risk: "⚖️ Balanced Risk — Proven refill concept, but execution and location strategy are critical",
                riskClass: "risk-balanced"
            },
            frostvale: {
                icon: `<svg width="70" height="70" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#7c3aed" opacity="0.12"/>
                    <path d="M50 15 C30 35 25 55 50 85 C75 55 70 35 50 15Z" fill="url(#frostGradLg)"/>
                    <path d="M50 20 L50 75" stroke="#4c1d95" stroke-width="2" opacity="0.4"/>
                    <path d="M50 35 L38 45 M50 45 L62 55 M50 55 L40 62" stroke="#4c1d95" stroke-width="1.5" opacity="0.3" fill="none"/>
                    <circle cx="35" cy="30" r="3" fill="#e0e7ff"/>
                    <circle cx="65" cy="35" r="2.5" fill="#e0e7ff"/>
                    <circle cx="30" cy="50" r="2" fill="#c7d2fe"/>
                    <circle cx="70" cy="55" r="2.5" fill="#c7d2fe"/>
                    <path d="M35 30 L32 27 M35 30 L38 27 M35 30 L35 25" stroke="#e0e7ff" stroke-width="1.5"/>
                    <defs><linearGradient id="frostGradLg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#a78bfa"/><stop offset="50%" style="stop-color:#7c3aed"/><stop offset="100%" style="stop-color:#5b21b6"/></linearGradient></defs>
                </svg>`,
                miniIcon: `<svg width="28" height="28" viewBox="0 0 100 100">
                    <path d="M50 10 C25 35 20 60 50 90 C80 60 75 35 50 10Z" fill="url(#fvMini)"/>
                    <path d="M50 18 L50 78" stroke="#4c1d95" stroke-width="2" opacity="0.4"/>
                    <circle cx="30" cy="28" r="4" fill="#e0e7ff"/>
                    <circle cx="70" cy="35" r="3" fill="#e0e7ff"/>
                    <defs><linearGradient id="fvMini" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#a78bfa"/><stop offset="100%" style="stop-color:#7c3aed"/></linearGradient></defs>
                </svg>`,
                description: "Indulgent ice cream alternatives using oat, coconut, and innovative protein bases. FrostVale targets the booming flexitarian market—consumers who want guilt-free indulgence without compromising on taste or texture.",
                markets: "UK, Germany, Nordic countries, US East Coast, select Asian markets (Japan, South Korea)",
                consumers: "Flexitarians and 'reducetarians', vegans, lactose-intolerant consumers, health-conscious millennials and Gen Z",
                challenge: "Intense competition from established players and startups; maintaining premium pricing during cost-of-living pressures; cold chain logistics complexity",
                risk: "🚀 High Risk — Crowded market with strong incumbents, but massive growth potential if you break through",
                riskClass: "risk-high"
            },
            puriclean: {
                icon: `<svg width="70" height="70" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#059669" opacity="0.12"/>
                    <path d="M50 12 L80 25 L80 50 C80 72 65 85 50 90 C35 85 20 72 20 50 L20 25 Z" fill="url(#puriGradLg)" stroke="#047857" stroke-width="2"/>
                    <path d="M50 30 C42 30 38 40 38 48 C38 58 43 63 50 63 C57 63 62 58 62 48 C62 40 58 30 50 30Z" fill="#67e8f9"/>
                    <ellipse cx="50" cy="44" rx="6" ry="4" fill="white" opacity="0.6"/>
                    <path d="M70 35 L73 38 L70 41 L67 38 Z" fill="#fcd34d"/>
                    <path d="M30 40 L32 42 L30 44 L28 42 Z" fill="#fcd34d"/>
                    <defs><linearGradient id="puriGradLg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#34d399"/><stop offset="100%" style="stop-color:#059669"/></linearGradient></defs>
                </svg>`,
                miniIcon: `<svg width="28" height="28" viewBox="0 0 100 100">
                    <path d="M50 8 L85 23 L85 52 C85 76 68 90 50 95 C32 90 15 76 15 52 L15 23 Z" fill="url(#pcMini)" stroke="#047857" stroke-width="3"/>
                    <path d="M50 28 C40 28 35 40 35 50 C35 62 42 68 50 68 C58 68 65 62 65 50 C65 40 60 28 50 28Z" fill="#67e8f9"/>
                    <ellipse cx="50" cy="44" rx="7" ry="5" fill="white" opacity="0.6"/>
                    <defs><linearGradient id="pcMini" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#34d399"/><stop offset="100%" style="stop-color:#059669"/></linearGradient></defs>
                </svg>`,
                description: "Low-cost, durable toilet systems and hygiene products designed for communities without reliable sanitation infrastructure. Our partnership model with NGOs, governments, and social enterprises aims to reach 100 million people and dramatically improve public health outcomes.",
                markets: "India (rural and peri-urban), Southeast Asia (Indonesia, Philippines), Sub-Saharan Africa (Kenya, Nigeria, Ghana)",
                consumers: "Rural communities, urban informal settlements, schools and healthcare facilities, government sanitation programmes",
                challenge: "Complex last-mile logistics in difficult terrain; very low margins requiring massive scale; navigating government procurement and NGO partnerships",
                risk: "🌍 Moderate Risk — Extremely high purpose alignment, but operational complexity and thin margins demand excellence",
                riskClass: "risk-moderate"
            },
            mindspring: {
                icon: `<svg width="70" height="70" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#ec4899" opacity="0.12"/>
                    <path d="M35 55 C25 55 22 45 25 38 C28 30 35 28 40 30 C42 25 48 22 55 25 C62 22 70 28 72 38 C78 42 78 55 68 58 C65 65 55 68 50 65 C45 68 35 65 35 55Z" fill="url(#mindGradLg)"/>
                    <path d="M40 40 Q50 35 55 42 M38 50 Q48 48 58 52" stroke="#9d174d" stroke-width="1.5" fill="none" opacity="0.4"/>
                    <path d="M50 25 L50 15" stroke="#10b981" stroke-width="2.5" stroke-linecap="round"/>
                    <ellipse cx="45" cy="14" rx="5" ry="4" fill="#34d399" transform="rotate(-30 45 14)"/>
                    <ellipse cx="55" cy="14" rx="5" ry="4" fill="#34d399" transform="rotate(30 55 14)"/>
                    <circle cx="30" cy="35" r="2" fill="#fbbf24"/>
                    <circle cx="72" cy="40" r="2" fill="#fbbf24"/>
                    <circle cx="50" cy="70" r="1.5" fill="#fbbf24"/>
                    <defs><linearGradient id="mindGradLg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f9a8d4"/><stop offset="50%" style="stop-color:#ec4899"/><stop offset="100%" style="stop-color:#db2777"/></linearGradient></defs>
                </svg>`,
                miniIcon: `<svg width="28" height="28" viewBox="0 0 100 100">
                    <path d="M30 58 C18 58 15 45 18 36 C22 26 30 24 36 26 C38 20 46 16 54 20 C62 16 72 24 75 36 C82 42 82 58 70 62 C66 70 54 74 50 70 C46 74 34 70 30 58Z" fill="url(#msMini)"/>
                    <path d="M50 22 L50 10" stroke="#10b981" stroke-width="3" stroke-linecap="round"/>
                    <ellipse cx="44" cy="8" rx="6" ry="5" fill="#34d399" transform="rotate(-30 44 8)"/>
                    <ellipse cx="56" cy="8" rx="6" ry="5" fill="#34d399" transform="rotate(30 56 8)"/>
                    <defs><linearGradient id="msMini" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f9a8d4"/><stop offset="100%" style="stop-color:#ec4899"/></linearGradient></defs>
                </svg>`,
                description: "AI-powered mental health and productivity platform sold to enterprise HR departments. MindSpring combines guided meditation, 1:1 coaching, team analytics, and burnout prediction to help companies reduce turnover and improve employee wellbeing.",
                markets: "United States (Fortune 500), United Kingdom, Japan, Germany—focusing on enterprise hubs with high burnout rates",
                consumers: "HR directors and CHROs, C-suite executives concerned about retention, employees aged 25-45 in high-stress roles",
                challenge: "Long B2B enterprise sales cycles (6-12 months); proving measurable ROI to skeptical CFOs; competing with established HR tech platforms",
                risk: "🚦 High Risk — A bold tech pivot for an FMCG company, but highly scalable with recurring SaaS revenue if you crack enterprise sales",
                riskClass: "risk-high"
            }
        };

        function showVentureInfo(ventureKey) {
            const v = ventures[ventureKey];
            const d = ventureDetails[ventureKey];
            
            document.getElementById('venture-info-icon').innerHTML = d.icon;
            document.getElementById('venture-info-title').textContent = v.name;
            document.getElementById('venture-info-tagline').textContent = document.querySelector(`[data-venture="${ventureKey}"] .venture-tagline`).textContent;
            document.getElementById('venture-info-description').textContent = d.description;
            document.getElementById('venture-info-markets').textContent = d.markets;
            document.getElementById('venture-info-consumers').textContent = d.consumers;
            document.getElementById('venture-info-challenge').textContent = d.challenge;
            
            document.getElementById('info-stat-duration').textContent = '12 months';
            document.getElementById('info-stat-template').textContent = v.stats.templateStage;
            
            // Use qualitative labels for purpose and innovation
            const purposeEl = document.getElementById('info-stat-purpose');
            purposeEl.textContent = v.stats.purposeLabel;
            purposeEl.className = `stat-val level-${v.stats.purposeLabel.toLowerCase()}`;
            
            const innovationEl = document.getElementById('info-stat-innovation');
            innovationEl.textContent = v.stats.innovationLabel;
            innovationEl.className = `stat-val level-${v.stats.innovationLabel.toLowerCase()}`;
            
            const riskEl = document.getElementById('venture-info-risk');
            riskEl.textContent = d.risk;
            riskEl.className = `risk ${d.riskClass}`;
            
            document.getElementById('venture-info-select-btn').onclick = () => {
                closeVentureInfo();
                chooseVenture(ventureKey);
            };
            
            document.getElementById('venture-info-modal').classList.add('visible');
        }

        function closeVentureInfo() {
            document.getElementById('venture-info-modal').classList.remove('visible');
        }

        function showReferencesModal() {
            document.getElementById('references-modal').classList.add('visible');
        }

        function hideReferencesModal() {
            document.getElementById('references-modal').classList.remove('visible');
        }

        // DOM cache
        const dom = { dashboard: {}, modals: {}, eventCard: {}, gameOver: {}, inbox: {} };
        
        // Email inbox state
        const emailInbox = {
            emails: [],
            unreadCount: 0
        };
        
        // Email sender database - maps departments to sender pools
        const emailSenders = {
            finance: [
                { name: 'Sarah Mitchell', role: 'Financial Controller', email: 'sarah.mitchell@neptune-corp.com' },
                { name: 'James Porter', role: 'Budget Analyst', email: 'james.porter@neptune-corp.com' },
                { name: 'Elena Vasquez', role: 'Treasury Associate', email: 'elena.vasquez@neptune-corp.com' }
            ],
            hr: [
                { name: 'Rachel Thompson', role: 'HR Business Partner', email: 'rachel.thompson@neptune-corp.com' },
                { name: 'Michael Chen', role: 'Talent Manager', email: 'michael.chen@neptune-corp.com' },
                { name: 'Sophie Williams', role: 'People Operations', email: 'sophie.williams@neptune-corp.com' }
            ],
            operations: [
                { name: 'Tom Richardson', role: 'Operations Manager', email: 'tom.richardson@neptune-corp.com' },
                { name: 'Priya Sharma', role: 'Process Lead', email: 'priya.sharma@neptune-corp.com' },
                { name: 'Daniel Brooks', role: 'Quality Assurance', email: 'daniel.brooks@neptune-corp.com' }
            ],
            marketing: [
                { name: 'Laura Bennett', role: 'Brand Manager', email: 'laura.bennett@neptune-corp.com' },
                { name: 'Chris Taylor', role: 'Marketing Lead', email: 'chris.taylor@neptune-corp.com' },
                { name: 'Emma Davis', role: 'Growth Marketing', email: 'emma.davis@neptune-corp.com' }
            ],
            tech: [
                { name: 'Alex Kumar', role: 'Tech Lead', email: 'alex.kumar@neptune-corp.com' },
                { name: 'Jessica Lin', role: 'Product Manager', email: 'jessica.lin@neptune-corp.com' },
                { name: 'Ryan O\'Brien', role: 'Systems Architect', email: 'ryan.obrien@neptune-corp.com' }
            ],
            corporate: [
                { name: 'Victoria Palmer', role: 'Strategy Director', email: 'victoria.palmer@neptune-corp.com' },
                { name: 'William Hughes', role: 'Chief of Staff', email: 'william.hughes@neptune-corp.com' },
                { name: 'Catherine Moore', role: 'Board Secretary', email: 'catherine.moore@neptune-corp.com' }
            ],
            scaling: [
                { name: 'Marcus Johnson', role: 'Expansion Lead', email: 'marcus.johnson@neptune-corp.com' },
                { name: 'Natalie Foster', role: 'Market Development', email: 'natalie.foster@neptune-corp.com' },
                { name: 'Andrew Park', role: 'Growth Operations', email: 'andrew.park@neptune-corp.com' }
            ],
            competitors: [
                { name: 'Industry Alert', role: 'Competitive Intelligence', email: 'alerts@neptune-corp.com' },
                { name: 'Market Watch', role: 'Business Intelligence', email: 'market.intel@neptune-corp.com' }
            ],
            corporate_tensions: [
                { name: 'Margaret Chen', role: 'Corporate IT Director', email: 'margaret.chen@neptune-corp.com' },
                { name: 'Robert Ashworth', role: 'Group HR Business Partner', email: 'robert.ashworth@neptune-corp.com' },
                { name: 'Patricia Dunn', role: 'Corporate Finance', email: 'patricia.dunn@neptune-corp.com' },
                { name: 'Steven Walsh', role: 'Chief of Staff', email: 'steven.walsh@neptune-corp.com' },
                { name: 'Linda Morrison', role: 'Corporate Compliance', email: 'linda.morrison@neptune-corp.com' },
                { name: 'James Thornton', role: 'Group Procurement', email: 'james.thornton@neptune-corp.com' }
            ],
            external_relations: [
                { name: 'Diana Reyes', role: 'Supplier Relations', email: 'diana.reyes@neptune-corp.com' },
                { name: 'Michael Tang', role: 'Procurement Manager', email: 'michael.tang@neptune-corp.com' },
                { name: 'Sarah Mitchell', role: 'Key Account Manager', email: 'sarah.mitchell@neptune-corp.com' },
                { name: 'Thomas Grant', role: 'Customer Success Lead', email: 'thomas.grant@neptune-corp.com' },
                { name: 'Rachel Adams', role: 'Partner Relations', email: 'rachel.adams@neptune-corp.com' },
                { name: 'Kevin O\'Neill', role: 'Vendor Management', email: 'kevin.oneill@neptune-corp.com' }
            ]
        };
        
        // Email subject generators based on event type/theme
        function generateEmailSubject(event) {
            const title = event.title || 'Update Required';
            const dept = (event.dept || 'General').toLowerCase();
            
            // Subject line patterns based on content
            const subjectPatterns = {
                question: ['RE: Decision needed - ', 'FW: Your input required - ', 'Urgent: ', 'Question - '],
                update: ['Update: ', 'Status - ', 'Progress report: ', 'FYI: '],
                action: ['Action Required: ', 'DECISION: ', 'Please review - ', 'Approval needed: '],
                alert: ['⚠️ Alert: ', '🔔 Heads up - ', 'Important: ', 'Attention: ']
            };
            
            // Determine email type based on event content
            let emailType = 'action';
            const text = (event.text || '').toLowerCase();
            if (text.includes('competitor') || text.includes('threat') || text.includes('risk')) emailType = 'alert';
            else if (text.includes('how') || text.includes('should we') || text.includes('what')) emailType = 'question';
            else if (text.includes('update') || text.includes('progress') || text.includes('status')) emailType = 'update';
            
            const patterns = subjectPatterns[emailType];
            const prefix = patterns[Math.floor(Math.random() * patterns.length)];
            
            return { subject: prefix + title, type: emailType };
        }
        
        // Generate email greeting based on time of day and formality
        function generateEmailGreeting(senderName) {
            const greetings = [
                `Hi,`,
                `Hello,`,
                `Good morning,`,
                `Hi there,`,
                `Hey,`
            ];
            return greetings[Math.floor(Math.random() * greetings.length)];
        }
        
        // Get a random sender for a department
        function getEmailSender(dept) {
            const deptKey = dept.toLowerCase().replace(' ', '');
            const deptMap = {
                'finance': 'finance',
                'hr': 'hr', 
                'operations': 'operations',
                'ops': 'operations',
                'marketing': 'marketing',
                'mkt': 'marketing',
                'tech': 'tech',
                'technology': 'tech',
                'corporate': 'corporate',
                'corporate_tensions': 'corporate_tensions',
                'external_relations': 'external_relations',
                'scaling': 'scaling',
                'competitors': 'competitors'
            };
            
            const mappedDept = deptMap[deptKey] || 'corporate';
            const senders = emailSenders[mappedDept] || emailSenders.corporate;
            return senders[Math.floor(Math.random() * senders.length)];
        }
        
        // Get department tag class
        function getDeptTagClass(dept) {
            const deptKey = dept.toLowerCase();
            if (deptKey.includes('finance')) return 'finance';
            if (deptKey.includes('hr') || deptKey.includes('human')) return 'hr';
            if (deptKey.includes('ops') || deptKey.includes('operations')) return 'ops';
            if (deptKey.includes('market')) return 'marketing';
            if (deptKey.includes('tech')) return 'tech';
            if (deptKey.includes('corporate') || deptKey.includes('board')) return 'corporate';
            if (deptKey.includes('scal')) return 'scaling';
            if (deptKey.includes('compet')) return 'competitors';
            return 'corporate';
        }
        
        // Render the email inbox
        function renderInbox() {
            const emailList = document.getElementById('email-list');
            const inboxCount = document.getElementById('inbox-count');
            
            if (!emailList || !inboxCount) return;
            
            // Update count
            const unreadCount = emailInbox.emails.filter(e => !e.read).length;
            const totalCount = emailInbox.emails.length;
            
            if (totalCount === 0) {
                inboxCount.textContent = 'No messages';
                inboxCount.classList.remove('has-mail');
            } else if (unreadCount > 0) {
                inboxCount.textContent = `${unreadCount} unread`;
                inboxCount.classList.add('has-mail');
            } else {
                inboxCount.textContent = `${totalCount} message${totalCount !== 1 ? 's' : ''}`;
                inboxCount.classList.remove('has-mail');
            }
            
            // Clear the list
            emailList.innerHTML = '';
            
            if (emailInbox.emails.length === 0) {
                // Show empty state
                const emptyMsg = state.turn === 0 
                    ? `<div class="inbox-empty-icon">📭</div>
                       <h3>No messages yet</h3>
                       <p>Click "Get Started" to begin receiving emails from your team.</p>`
                    : `<div class="inbox-empty-icon">✅</div>
                       <h3>All caught up!</h3>
                       <p>You've responded to all emails. Click "Next Month" to continue.</p>`;
                
                emailList.innerHTML = `<div class="inbox-empty" style="display: flex;">${emptyMsg}</div>`;
                return;
            }
            
            // Build email list
            emailInbox.emails.forEach((email, index) => {
                const emailEl = document.createElement('div');
                emailEl.className = `email-item${email.read ? '' : ' unread'}`;
                emailEl.onclick = () => openEmail(index);
                
                // Get department head if this is a department email
                let avatarHtml;
                let senderName = email.sender.name;
                const deptKey = getDeptKey(email.dept);
                const hiredHeadId = state.leadershipTeam[deptKey];
                
                // Use department head for core departments
                if (hiredHeadId && candidates[deptKey]) {
                    const deptHead = candidates[deptKey].find(c => c.id === hiredHeadId);
                    if (deptHead) {
                        avatarHtml = generateAvatar(hiredHeadId, deptHead.name);
                        senderName = deptHead.name; // Use dept head name
                    } else {
                        avatarHtml = generateRandomAvatar(email.sender.name);
                    }
                } else {
                    avatarHtml = generateRandomAvatar(email.sender.name);
                }
                
                emailEl.innerHTML = `
                    <div class="email-avatar">${avatarHtml}</div>
                    <div class="email-content">
                        <div class="email-top-row">
                            <span class="email-sender">${senderName}</span>
                            <span class="email-time">${email.time}</span>
                        </div>
                        <div class="email-subject">
                            <span class="email-dept-tag ${email.deptClass}">${email.dept}</span>
                            ${email.subject}
                        </div>
                        <div class="email-preview">${email.preview}</div>
                    </div>
                `;
                
                emailList.appendChild(emailEl);
            });
            
            // Update mobile inbox badge
            if (typeof updateMobileInboxBadge === 'function') {
                updateMobileInboxBadge();
            }
        }
        
        // Map department names to leadershipTeam keys
        function getDeptKey(deptName) {
            const deptLower = deptName?.toLowerCase().split(' ')[0] || '';
            const keyMap = {
                'finance': 'finance',
                'hr': 'hr',
                'human': 'hr',
                'ops': 'ops',
                'operations': 'ops',
                'marketing': 'marketing',
                'mkt': 'marketing',
                'tech': 'tech',
                'technology': 'tech'
            };
            return keyMap[deptLower] || deptLower;
        }
        
        // Generate a simple avatar based on name
        function generateRandomAvatar(name) {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#43e97b', '#fa709a', '#fee140'];
            const bgColor = colors[name.charCodeAt(0) % colors.length];
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2);
            
            return `<svg viewBox="0 0 50 50">
                <rect width="50" height="50" fill="${bgColor}"/>
                <text x="25" y="32" text-anchor="middle" fill="white" font-size="18" font-weight="600">${initials}</text>
            </svg>`;
        }
        
        // Add an event to the inbox as an email
        function addEmailToInbox(event) {
            const deptKey = getDeptKey(event.dept);
            const hiredHeadId = state.leadershipTeam[deptKey];
            let sender;
            
            // Use department head as sender for core departments
            if (hiredHeadId && candidates[deptKey]) {
                const deptHead = candidates[deptKey].find(c => c.id === hiredHeadId);
                if (deptHead) {
                    const deptTitles = {
                        finance: 'Head of Finance',
                        hr: 'Head of Human Resources',
                        ops: 'Head of Operations',
                        marketing: 'Head of Marketing',
                        tech: 'Head of Technology'
                    };
                    sender = {
                        name: deptHead.name,
                        role: deptTitles[deptKey] || `Head of ${event.dept}`,
                        email: `${deptHead.name.toLowerCase().replace(' ', '.')}@neptune-corp.com`
                    };
                } else {
                    sender = getEmailSender(event.dept);
                }
            } else {
                sender = getEmailSender(event.dept);
            }
            
            const { subject, type } = generateEmailSubject(event);
            const deptClass = getDeptTagClass(event.dept);
            
            const email = {
                id: event.id,
                event: event,
                sender: sender,
                subject: subject,
                type: type,
                dept: event.dept,
                deptClass: deptClass,
                preview: event.text.substring(0, 80) + '...',
                time: `Month ${state.turn}`,
                read: false,
                greeting: 'Dear Director,'
            };
            
            emailInbox.emails.unshift(email); // Add to top
            renderInbox();
        }
        
        // Open an email and show the decision modal
        function openEmail(index) {
            playSound('email');
            const email = emailInbox.emails[index];
            if (!email) return;
            
            email.read = true;
            renderInbox();
            
            showEventModal(email.event, email);
        }
        
        // Close email modal
        function closeEventModal() {
            playSound('click');
            dom.modals.event.classList.remove('visible');
            state.isModalOpen = false;
        }
        
        // Add welcome email when game starts
        function addWelcomeEmail() {
            const ventureName = ventures[state.venture]?.name || 'your new venture';
            
            // Get strategy name from state
            const strategyNames = {
                'local': 'Local Champion',
                'regional': 'Regional Expansion', 
                'global': 'Global Blitz'
            };
            const strategyName = strategyNames[state.strategy] || 'your chosen';
            
            const welcomeEmail = {
                id: 'welcome-001',
                event: {
                    id: 'welcome-001',
                    dept: 'Corporate',
                    title: 'Welcome to Your New Role',
                    text: `Congratulations on your appointment as New Business Unit Director of ${ventureName}! Your leadership team is now assembled and ready to begin. As you pursue your ${strategyName} strategy, you'll receive emails from across the organisation requiring your decisions. The first months will be busy as your department heads bring challenges to your attention. Good luck!`,
                    options: [
                        { text: "I'm ready to lead this venture to success!", effects: { morale: 2 } },
                        { text: "Let's get to work.", effects: {} }
                    ]
                },
                sender: { 
                    name: 'Victoria Palmer', 
                    role: 'Chief Strategy Officer',
                    email: 'victoria.palmer@neptune-corp.com'
                },
                subject: '🎉 Welcome to ' + ventureName,
                type: 'update',
                dept: 'Corporate',
                deptClass: 'corporate',
                preview: 'Congratulations on your appointment as New Business Unit Director...',
                time: 'Just now',
                read: false,
                greeting: 'Dear Director,'
            };
            
            emailInbox.emails.push(welcomeEmail);
        }

        // Initialize DOM references and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // iOS viewport height fix - set CSS custom property
            const setAppHeight = () => {
                document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
            };
            setAppHeight();
            window.addEventListener('resize', setAppHeight);
            window.addEventListener('orientationchange', () => {
                setTimeout(setAppHeight, 100); // Delay for orientation change
            });
            
            // Cache all DOM elements
            dom.titleModal = document.getElementById('title-modal');
            dom.introModal = document.getElementById('intro-modal');
            dom.ventureModal = document.getElementById('venture-modal');
            dom.strategyModal = document.getElementById('strategy-modal');
            dom.setupModal = document.getElementById('setup-modal');
            dom.confirmSetupBtn = document.getElementById('confirm-setup-btn');
            dom.hiringModal = document.getElementById('hiring-modal');
            dom.hiringRoleTitle = document.getElementById('hiring-role-title');
            dom.candidateOptions = document.getElementById('candidate-options');
            dom.turnCounter = document.getElementById('turn-counter');
            dom.nextBtn = document.getElementById('next-month-btn');
            dom.dashboard.revenue = document.getElementById('metric-revenue-value');
            dom.dashboard.costs = document.getElementById('metric-costs-value');
            dom.dashboard.netFlow = document.getElementById('metric-net-value');
            dom.dashboard.runway = document.getElementById('metric-runway-value');
            dom.dashboard.reach = document.getElementById('metric-reach-value');
            dom.dashboard.purpose = document.getElementById('metric-purpose-value');
            dom.dashboard.innovation = document.getElementById('metric-innovation-value');
            dom.dashboard.templateStage = document.getElementById('metric-template-stage-value');
            dom.dashboard.templateProgress = document.getElementById('metric-template-progress-value');
            dom.dashboard.templateProgressBar = document.getElementById('metric-template-progress-bar');
            dom.dashboard.skill = document.getElementById('metric-skill-value');
            dom.dashboard.morale = document.getElementById('metric-morale-value');
            // Email inbox elements are rendered dynamically
            dom.modals.event = document.getElementById('event-modal');
            dom.modals.gameOver = document.getElementById('game-over-modal');
            dom.eventCard.options = document.getElementById('event-options');
            // Game over elements are now populated dynamically
            dom.shockBar = document.getElementById('global-shock-bar');
            
            dom.modals.title = dom.titleModal;
            dom.modals.intro = dom.introModal;
            dom.modals.venture = dom.ventureModal;
            dom.modals.strategy = dom.strategyModal;
            dom.modals.setup = dom.setupModal;
            dom.modals.hiring = dom.hiringModal;
            dom.modals.tutorial = document.getElementById('tutorial-modal');

            // Attach event listeners
            document.getElementById('title-start-btn').addEventListener('click', closeTitle);
            document.getElementById('title-tutorial-btn').addEventListener('click', openTutorial);
            document.getElementById('start-game-btn').addEventListener('click', closeIntro);
            dom.confirmSetupBtn.addEventListener('click', confirmSetup);
            dom.nextBtn.addEventListener('click', nextMonth);
        });
        
        function openTutorial() {
            dom.modals.tutorial.classList.add('visible');
        }
        
        function closeTutorial() {
            dom.modals.tutorial.classList.remove('visible');
            playSound('click');
        }

        function closeTitle() {
            // Initialize audio context first, then play entrance sound after small delay
            initAudio();
            setTimeout(() => {
                playSound('entrance');
            }, 50);
            dom.modals.title.classList.remove('visible');
            dom.modals.intro.classList.add('visible');
        }

        function setGameMode(mode) {
            state.gameMode = mode;
            playSound('click');
            const shortBtn = document.getElementById('mode-short');
            const normalBtn = document.getElementById('mode-normal');
            
            if (mode === 'short') {
                shortBtn.style.background = 'linear-gradient(135deg, #0d7377, #14919b)';
                shortBtn.style.color = 'white';
                normalBtn.style.background = 'transparent';
                normalBtn.style.color = '#94a3b8';
            } else {
                shortBtn.style.background = 'transparent';
                shortBtn.style.color = '#94a3b8';
                normalBtn.style.background = 'linear-gradient(135deg, #0d7377, #14919b)';
                normalBtn.style.color = 'white';
            }
        }

        function closeIntro() {
            playSound('transition');
            dom.modals.intro.classList.remove('visible');
            dom.modals.venture.classList.add('visible');
        }
        
        function chooseVenture(ventureKey) {
            playSound('success');
            state.venture = ventureKey;
            const v = ventures[ventureKey];
            state.profitLoss = 0;
            
            for (let key in v.stats) {
                state[key] = v.stats[key];
            }
            
            // Explicitly ensure reach is set
            state.reach = v.stats.reach || 2;
            
            dom.modals.venture.classList.remove('visible');
            dom.modals.strategy.classList.add('visible');
            updateDashboard();
        }
        
        function chooseStrategy(strategyKey) {
            playSound('success');
            // Store selected strategy
            state.strategy = strategyKey;
            
            // Set targets and base monthly costs (in £K)
            switch(strategyKey) { 
                case 'local': state.targetReach = 5; state.baseMonthlyCost = 500; state.targetProfitMonth = 10; break; 
                case 'regional': state.targetReach = 15; state.baseMonthlyCost = 800; state.targetProfitMonth = 8; break; 
                case 'global': state.targetReach = 25; state.baseMonthlyCost = 1200; state.targetProfitMonth = 6; break; 
            }
            dom.modals.strategy.classList.remove('visible');
            state.monthlyChanges = {};
            showSetupModal();
            updateDashboard();
        }

        function showSetupModal() {
            // Initialize investment tier buttons
            const depts = ['finance', 'hr', 'ops', 'marketing', 'tech'];
            depts.forEach(dept => {
                const tierContainer = document.getElementById(`tiers-${dept}`);
                if (!tierContainer) return;
                
                const buttons = tierContainer.querySelectorAll('.tier-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => selectInvestmentTier(dept, btn));
                });
            });
            
            updateInvestmentSummary();
            dom.modals.setup.classList.add('visible');
        }
        
        function selectInvestmentTier(dept, button) {
            const tierContainer = document.getElementById(`tiers-${dept}`);
            const buttons = tierContainer.querySelectorAll('.tier-btn');
            
            // Remove active from all, add to clicked
            buttons.forEach(b => b.classList.remove('active'));
            button.classList.add('active');
            
            // Update state
            const tier = button.dataset.tier;
            const cost = parseInt(button.dataset.cost);
            state.investments[dept] = tier;
            state.investmentCosts[dept] = cost;
            
            updateInvestmentSummary();
        }
        
        function updateInvestmentSummary() {
            // Calculate total adjustment from baseline (can be negative for savings)
            const totalAdjustment = Object.values(state.investmentCosts).reduce((sum, c) => sum + c, 0);
            state.totalMonthlyInvestment = totalAdjustment;
            
            // Update display
            const totalEl = document.getElementById('total-monthly-investment');
            const burnEl = document.getElementById('investment-burn-impact');
            
            if (totalAdjustment > 0) {
                totalEl.textContent = `+£${totalAdjustment}K`;
                totalEl.style.color = 'var(--color-red)';
                burnEl.textContent = `+£${totalAdjustment}K/mo extra`;
            } else if (totalAdjustment < 0) {
                totalEl.textContent = `-£${Math.abs(totalAdjustment)}K`;
                totalEl.style.color = 'var(--color-green)';
                burnEl.textContent = `£${Math.abs(totalAdjustment)}K/mo saved`;
            } else {
                totalEl.textContent = `£0K`;
                totalEl.style.color = 'var(--text-dark)';
                burnEl.textContent = `No change from baseline`;
            }
        }

        function confirmSetup() {
            playSound('reward');
            dom.modals.setup.classList.remove('visible');
            state.monthlyChanges = {};
            
            // Investment adjustments are already tracked in totalMonthlyInvestment
            // No need to modify baseMonthlyCost as investments are added separately
            
            state.profitLoss = 0;
            
            // Record initial values for scoring (what player starts with before decisions)
            state.initialValues = {
                purpose: state.purpose,
                innovation: state.innovation,
                skill: state.skill,
                morale: state.morale,
                templateProgress: state.templateProgress
            };
            
            // Initialize previous values for transition reports
            state.previousValues = {
                purpose: state.purpose,
                innovation: state.innovation,
                skill: state.skill,
                morale: state.morale,
                reach: state.reach,
                templateProgress: state.templateProgress,
                profitLoss: state.profitLoss,
                marketStrength: state.marketStrength
            };
            
            showHiringModal();
            updateDashboard();
        }
        
        // Get investment multiplier for a department
        function getInvestmentMultiplier(dept) {
            const tier = state.investments[dept] || 'minimal';
            return investmentTiers[tier]?.multiplier || 1.0;
        }
        
        function showReallocationModal() {
            // Store previous investment for comparison
            state.previousTotalInvestment = state.totalMonthlyInvestment;
            
            // Populate performance snapshot
            populatePerformanceSnapshot();
            
            const depts = [
                { key: 'finance', icon: '💰', name: 'Finance' },
                { key: 'hr', icon: '👥', name: 'HR' },
                { key: 'ops', icon: '🏭', name: 'Operations' },
                { key: 'marketing', icon: '📣', name: 'Marketing' },
                { key: 'tech', icon: '💻', name: 'Technology' }
            ];
            
            const grid = document.getElementById('reallocation-grid');
            grid.innerHTML = depts.map(dept => {
                const currentTier = state.investments[dept.key] || 'standard';
                const tierOptions = ['lean', 'reduced', 'standard', 'enhanced', 'priority'];
                
                return `
                    <div class="reallocation-dept" data-dept="${dept.key}">
                        <div class="reallocation-dept-icon">${dept.icon}</div>
                        <div class="reallocation-dept-name">${dept.name}</div>
                        <div class="reallocation-tier-select">
                            ${tierOptions.map(tier => `
                                <button class="realloc-tier-btn ${tier === currentTier ? 'active' : ''}" 
                                        data-tier="${tier}" 
                                        data-dept="${dept.key}"
                                        onclick="selectReallocationTier('${dept.key}', '${tier}', this)">
                                    ${investmentTiers[tier].signal} ${investmentTiers[tier].label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update totals display
            updateReallocationTotals();
            
            document.getElementById('reallocation-modal').classList.add('visible');
        }
        
        function populatePerformanceSnapshot() {
            const metricsGrid = document.getElementById('realloc-metrics-grid');
            const implicationsDiv = document.getElementById('realloc-implications');
            
            // Calculate market progress
            const marketPct = Math.round((state.reach / state.targetReach) * 100);
            const monthsRemaining = state.maxTurns - state.turn;
            const monthsElapsed = state.turn;
            const expectedPct = Math.round((monthsElapsed / state.maxTurns) * 100);
            
            // Determine status levels
            function getStatus(value, goodThreshold, warningThreshold) {
                if (value >= goodThreshold) return 'good';
                if (value >= warningThreshold) return 'warning';
                return 'critical';
            }
            
            const metrics = [
                { 
                    icon: '📈', 
                    label: 'Markets', 
                    value: marketPct >= 100 ? `${state.reach} 🎉` : `${state.reach}`,
                    status: marketPct >= expectedPct ? 'good' : (marketPct >= expectedPct - 20 ? 'warning' : 'critical')
                },
                { 
                    icon: '⭐', 
                    label: 'Template', 
                    value: state.templateStage,
                    status: state.templateProgress >= 50 ? 'good' : (state.templateProgress >= 25 ? 'warning' : 'critical')
                },
                { 
                    icon: '🙂', 
                    label: 'Morale', 
                    value: state.morale,
                    status: getStatus(state.morale, 60, 40)
                },
                { 
                    icon: '💰', 
                    label: 'P/L', 
                    value: `£${state.profitLoss}K`,
                    status: state.profitLoss >= 0 ? 'good' : (state.profitLoss >= -500 ? 'warning' : 'critical')
                },
                { 
                    icon: '🌍', 
                    label: 'Purpose', 
                    value: state.purpose,
                    status: getStatus(state.purpose, 60, 40)
                },
                { 
                    icon: '💡', 
                    label: 'Innovation', 
                    value: state.innovation,
                    status: getStatus(state.innovation, 60, 40)
                },
                { 
                    icon: '🎓', 
                    label: 'Skill', 
                    value: state.skill,
                    status: getStatus(state.skill, 60, 40)
                },
                { 
                    icon: '📅', 
                    label: 'Months Left', 
                    value: monthsRemaining,
                    status: monthsRemaining >= 6 ? 'good' : (monthsRemaining >= 3 ? 'warning' : 'critical')
                }
            ];
            
            metricsGrid.innerHTML = metrics.map(m => `
                <div class="realloc-metric status-${m.status}">
                    <div class="realloc-metric-icon">${m.icon}</div>
                    <div class="realloc-metric-value">${m.value}</div>
                    <div class="realloc-metric-label">${m.label}</div>
                </div>
            `).join('');
            
            // Generate implications
            const implications = generateReallocationImplications();
            implicationsDiv.innerHTML = `
                <div class="realloc-implications-title">💭 Strategic Considerations</div>
                ${implications.map(imp => `
                    <div class="realloc-implication">
                        <span class="realloc-implication-icon">${imp.icon}</span>
                        <span>${imp.text}</span>
                    </div>
                `).join('')}
            `;
        }
        
        function generateReallocationImplications() {
            const implications = [];
            const marketPct = (state.reach / state.targetReach) * 100;
            const monthsRemaining = state.maxTurns - state.turn;
            const expectedPct = (state.turn / state.maxTurns) * 100;
            
            // Market growth implications
            if (marketPct < expectedPct - 10) {
                implications.push({
                    icon: '📣',
                    text: `Market growth is behind schedule. Boosting <strong>Marketing</strong> could accelerate expansion.`
                });
            } else if (marketPct >= expectedPct + 20) {
                implications.push({
                    icon: '✅',
                    text: `Strong market progress. You may have room to invest elsewhere or reduce costs.`
                });
            }
            
            // Morale implications
            if (state.morale < 40) {
                implications.push({
                    icon: '😟',
                    text: `Low morale is hurting productivity. Prioritising <strong>HR</strong> could help rebuild team spirit.`
                });
            } else if (state.morale < 55) {
                implications.push({
                    icon: '😐',
                    text: `Morale is slipping. Consider maintaining or increasing <strong>HR</strong> investment.`
                });
            }
            
            // Template implications
            if (state.templateProgress < 30 && state.turn >= 3) {
                implications.push({
                    icon: '⭐',
                    text: `Template development is slow. <strong>Tech</strong> and <strong>Operations</strong> drive template improvements.`
                });
            }
            
            // Financial implications
            if (state.profitLoss < -300) {
                implications.push({
                    icon: '💸',
                    text: `Significant losses are accumulating. Consider reducing spending or boosting <strong>Finance</strong> for cost control.`
                });
            } else if (state.profitLoss > 500) {
                implications.push({
                    icon: '💰',
                    text: `Strong financial position. You have headroom to invest more aggressively if needed.`
                });
            }
            
            // Innovation implications
            if (state.innovation < 40) {
                implications.push({
                    icon: '💡',
                    text: `Innovation capacity is low. <strong>Tech</strong> investment fuels breakthrough ideas.`
                });
            }
            
            // Skill implications
            if (state.skill < 45) {
                implications.push({
                    icon: '🎓',
                    text: `Team skills are underdeveloped. <strong>HR</strong> can improve capabilities through training.`
                });
            }
            
            // Time pressure
            if (monthsRemaining <= 3 && marketPct < 80) {
                implications.push({
                    icon: '⏰',
                    text: `Time is running short. Focus resources on your most critical gaps.`
                });
            }
            
            // Ensure we always have at least one implication
            if (implications.length === 0) {
                implications.push({
                    icon: '👍',
                    text: `Performance is balanced. Fine-tune allocations based on your strategic priorities.`
                });
            }
            
            // Limit to 3 most relevant
            return implications.slice(0, 3);
        }
        
        function selectReallocationTier(dept, tier, btn) {
            // Update active button
            const container = btn.closest('.reallocation-dept');
            container.querySelectorAll('.realloc-tier-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update state
            state.investments[dept] = tier;
            state.investmentCosts[dept] = investmentTiers[tier].cost;
            
            // Recalculate total
            const totalCost = Object.values(state.investmentCosts).reduce((sum, c) => sum + c, 0);
            state.totalMonthlyInvestment = totalCost;
            
            // Update display
            updateReallocationTotals();
        }
        
        function updateReallocationTotals() {
            const totalEl = document.getElementById('realloc-total-investment');
            const changeEl = document.getElementById('realloc-change-indicator');
            
            if (totalEl) {
                totalEl.textContent = `£${state.totalMonthlyInvestment}K`;
            }
            
            if (changeEl && state.previousTotalInvestment !== undefined) {
                const diff = state.totalMonthlyInvestment - state.previousTotalInvestment;
                if (diff > 0) {
                    changeEl.textContent = `+£${diff}K`;
                    changeEl.style.color = 'var(--color-red)';
                } else if (diff < 0) {
                    changeEl.textContent = `-£${Math.abs(diff)}K`;
                    changeEl.style.color = 'var(--color-emerald)';
                } else {
                    changeEl.textContent = 'No change';
                    changeEl.style.color = 'var(--text-medium)';
                }
            }
        }
        
        function confirmReallocation() {
            // Clear report values
            state.reportValues = null;
            
            // Close modal and continue to next month
            document.getElementById('reallocation-modal').classList.remove('visible');
            continueToNextMonth();
        }

        function showHiringModal() {
            const currentRoleIndex = state.hiringPhase.currentRoleIndex;
            if (currentRoleIndex >= state.hiringPhase.roles.length) {
                dom.modals.hiring.classList.remove('visible');
                // Leaders affect decisions, not direct stats - just update display
                updateDashboard();
                
                // Initialize inbox with a welcome email
                emailInbox.emails = [];
                addWelcomeEmail();
                renderInbox();
                
                // Show email count on button
                const unreadCount = emailInbox.emails.filter(e => !e.read).length;
                if (unreadCount > 0) {
                    dom.nextBtn.disabled = true;
                    dom.nextBtn.textContent = `📧 ${unreadCount} email to review`;
                } else {
                    dom.nextBtn.disabled = false;
                    dom.nextBtn.textContent = "Get Started";
                }
                return;
            }
            const role = state.hiringPhase.roles[currentRoleIndex];
            const roleNames = { finance: 'Finance', hr: 'Human Resources', ops: 'Operations', marketing: 'Marketing', tech: 'Technology' };
            dom.hiringRoleTitle.textContent = `Recruit Your Team: Head of ${roleNames[role] || role}`;
            dom.candidateOptions.innerHTML = '';
            
            candidates[role].forEach(candidate => {
                const card = document.createElement('div');
                card.classList.add('candidate-card');
                const isInternal = candidate.type === 'internal';
                card.classList.add(isInternal ? 'candidate-internal' : 'candidate-external');
                
                const cv = candidate.cv || {};
                
                // Build hire info
                const hireCost = candidate.hireCost || 0;
                const onboardingMonths = candidate.onboardingMonths || 0;
                const hireCostK = Math.round(hireCost * 1000);
                
                // Build stats HTML for the vertical card
                let statsHtml = '';
                if (isInternal) {
                    statsHtml = `
                        <div class="candidate-stat">
                            <span class="stat-label">Availability</span>
                            <span class="stat-value ready">✓ Ready now</span>
                        </div>
                        <div class="candidate-stat">
                            <span class="stat-label">Hiring Cost</span>
                            <span class="stat-value ready">£0 (internal)</span>
                        </div>
                    `;
                } else {
                    statsHtml = `
                        <div class="candidate-stat">
                            <span class="stat-label">Hiring Cost</span>
                            <span class="stat-value cost">£${hireCostK}K</span>
                        </div>
                        <div class="candidate-stat">
                            <span class="stat-label">Onboarding</span>
                            <span class="stat-value time">${onboardingMonths} months</span>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="candidate-header">
                        <div class="candidate-avatar">
                            ${generateAvatar(candidate.id, candidate.name)}
                        </div>
                        <h3>${candidate.name}</h3>
                        <p class="candidate-title">${cv.title || 'Senior Manager'} · ${cv.years || '?'} yrs</p>
                        <span class="candidate-badge ${isInternal ? 'badge-internal' : 'badge-external'}">${isInternal ? '🏢 Internal' : '🌍 External'}</span>
                    </div>
                    <div class="candidate-body">
                        <div class="candidate-traits">
                            <div class="candidate-trait trait-positive">
                                <span class="trait-icon">✓</span>
                                <span>${candidate.strength}</span>
                            </div>
                            <div class="candidate-trait trait-negative">
                                <span class="trait-icon">⚠</span>
                                <span>${candidate.weakness}</span>
                            </div>
                        </div>
                        <div class="candidate-stats">${statsHtml}</div>
                        <div class="candidate-actions">
                            <button class="btn-select" onclick="hireCandidate('${role}', '${candidate.id}')">${isInternal ? 'Select' : 'Hire'}</button>
                            <button class="btn-info" onclick="event.stopPropagation(); showFullCV('${role}', '${candidate.id}')">View Full CV</button>
                        </div>
                    </div>
                `;
                dom.candidateOptions.appendChild(card);
            });
            dom.modals.hiring.classList.add('visible');
        }
        
        function showFullCV(role, candidateId) {
            const candidate = candidates[role].find(c => c.id === candidateId);
            if (!candidate) return;
            
            const cv = candidate.cv || {};
            const isInternal = candidate.background.toLowerCase().includes('internal');
            
            // Populate modal with new avatar
            document.getElementById('cv-avatar').innerHTML = generateAvatar(candidate.id, candidate.name);
            document.getElementById('cv-name').textContent = candidate.name;
            document.getElementById('cv-title').textContent = cv.title || 'Senior Manager';
            
            const badge = document.getElementById('cv-badge');
            badge.textContent = isInternal ? '🏢 Internal Transfer' : '🌍 External Recruit';
            badge.className = `cv-modal-badge ${isInternal ? 'internal' : 'external'}`;
            
            document.getElementById('cv-summary').textContent = cv.summary || 'Experienced professional ready to lead.';
            document.getElementById('cv-strength').textContent = candidate.strength;
            document.getElementById('cv-weakness').textContent = candidate.weakness;
            document.getElementById('cv-years').textContent = `${cv.years || '?'} years`;
            document.getElementById('cv-education').textContent = cv.education || 'MBA';
            
            // Career history
            const historyEl = document.getElementById('cv-history');
            historyEl.innerHTML = (cv.history || []).map(h => `
                <div class="cv-history-item">
                    <div class="cv-history-role">${h.role}</div>
                    <div class="cv-history-company">${h.company}</div>
                    <div class="cv-history-period">${h.period}</div>
                    <div class="cv-history-details">${h.details}</div>
                </div>
            `).join('');
            
            // Skills
            const skillsEl = document.getElementById('cv-skills');
            skillsEl.innerHTML = (cv.skills || []).map(s => `<span class="cv-skill-tag">${s}</span>`).join('');
            
            // Achievements
            const achievementsEl = document.getElementById('cv-achievements');
            achievementsEl.innerHTML = (cv.achievements || []).map(a => `<li>${a}</li>`).join('');
            
            // Setup recruit button
            const hireBtn = document.getElementById('cv-hire-btn');
            hireBtn.textContent = `Recruit ${candidate.name.split(' ')[0]}`;
            hireBtn.onclick = () => {
                closeFullCV();
                hireCandidate(role, candidateId);
            };
            
            // Show modal
            document.getElementById('cv-modal').classList.add('visible');
        }
        
        function closeFullCV() {
            document.getElementById('cv-modal').classList.remove('visible');
        }
        
        // Diverse avatar configurations for each candidate
        const avatarConfigs = {
            // FINANCE
            'fin1': { // Anya Sharma - South Asian woman
                bg: '#e8d4f0', skin: '#c68642', hair: '#1a0f0a', hairStyle: 'long-wavy', 
                eyes: '#3d2314', lipColor: '#b5565e', gender: 'f', accessories: 'earrings'
            },
            'fin2': { // Marcus Thompson - Black man
                bg: '#d4e8f0', skin: '#8d5524', hair: '#1a1a1a', hairStyle: 'short-fade',
                eyes: '#3d2314', gender: 'm', accessories: 'glasses'
            },
            'fin3': { // Chen Wei - East Asian man
                bg: '#f0e8d4', skin: '#f1c27d', hair: '#1a1a1a', hairStyle: 'short-neat',
                eyes: '#2d1b0e', gender: 'm', accessories: 'none'
            },
            // HR
            'hr1': { // Fatima Rossi - Middle Eastern/Italian woman
                bg: '#f0d4e8', skin: '#c68642', hair: '#1a0f0a', hairStyle: 'hijab',
                eyes: '#3d2314', lipColor: '#a04050', gender: 'f', accessories: 'none'
            },
            'hr2': { // Isabelle Dubois - White French woman
                bg: '#e8f0d4', skin: '#ffe0bd', hair: '#8b6914', hairStyle: 'bob',
                eyes: '#4a7c59', lipColor: '#c46070', gender: 'f', accessories: 'earrings'
            },
            'hr3': { // David Kowalski - White Polish man
                bg: '#d4f0e8', skin: '#f5d0c5', hair: '#6b4423', hairStyle: 'short-professional',
                eyes: '#4682b4', gender: 'm', accessories: 'beard-light'
            },
            // OPS
            'ops1': { // Kenji Tanaka - Japanese man
                bg: '#f0d4d4', skin: '#f1c27d', hair: '#1a1a1a', hairStyle: 'short-spiky',
                eyes: '#2d1b0e', gender: 'm', accessories: 'none'
            },
            'ops2': { // Ahmed Hassan - Middle Eastern man
                bg: '#d4f0f0', skin: '#c68642', hair: '#1a1a1a', hairStyle: 'short-curly',
                eyes: '#3d2314', gender: 'm', accessories: 'beard'
            },
            'ops3': { // Maria Santos - Latina woman
                bg: '#f0e4d4', skin: '#d4a574', hair: '#2c1810', hairStyle: 'long-straight',
                eyes: '#3d2314', lipColor: '#c04050', gender: 'f', accessories: 'none'
            },
            // MARKETING
            'mkt1': { // Chloé Martin - White French woman, creative
                bg: '#e4d4f0', skin: '#ffe0bd', hair: '#9932cc', hairStyle: 'short-creative',
                eyes: '#4a7c59', lipColor: '#d06080', gender: 'f', accessories: 'nose-ring'
            },
            'mkt2': { // Mei Lin - Chinese woman
                bg: '#d4e8f0', skin: '#f1c27d', hair: '#1a1a1a', hairStyle: 'long-straight',
                eyes: '#2d1b0e', lipColor: '#b04050', gender: 'f', accessories: 'earrings'
            },
            'mkt3': { // Sam Carter - Non-binary, mixed race
                bg: '#e8f0d4', skin: '#d4a574', hair: '#4a3728', hairStyle: 'curly-top',
                eyes: '#5d4e37', gender: 'nb', accessories: 'earring-single'
            },
            // TECH
            'tech1': { // Eva Schmidt - German woman, older
                bg: '#e0e0f0', skin: '#f5d0c5', hair: '#8b8b8b', hairStyle: 'short-professional-f',
                eyes: '#4682b4', lipColor: '#a05060', gender: 'f', accessories: 'glasses'
            },
            'tech2': { // Olivia Green - Black British woman
                bg: '#d4f0d4', skin: '#8d5524', hair: '#1a1a1a', hairStyle: 'natural-curly',
                eyes: '#3d2314', lipColor: '#8b4050', gender: 'f', accessories: 'none'
            },
            'tech3': { // Raj Patel - Indian man
                bg: '#f0e0d4', skin: '#c68642', hair: '#1a1a1a', hairStyle: 'short-neat',
                eyes: '#3d2314', gender: 'm', accessories: 'beard-trimmed'
            }
        };
        
        function generateAvatar(candidateId, name) {
            const config = avatarConfigs[candidateId];
            if (!config) {
                // Fallback to initials
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                return `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #64748b, #475569); display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-weight: 700;">${initials}</div>`;
            }
            
            const { bg, skin, hair, hairStyle, eyes, lipColor, gender, accessories } = config;
            
            let hairSvg = '';
            let accessorySvg = '';
            let facialHairSvg = '';
            
            // Hair styles
            switch(hairStyle) {
                case 'long-wavy':
                    hairSvg = `<ellipse cx="50" cy="85" rx="32" ry="28" fill="${hair}"/>
                               <ellipse cx="50" cy="28" rx="30" ry="20" fill="${hair}"/>
                               <ellipse cx="22" cy="50" rx="10" ry="20" fill="${hair}"/>
                               <ellipse cx="78" cy="50" rx="10" ry="20" fill="${hair}"/>
                               <path d="M25 45 Q20 60 25 75" stroke="${hair}" stroke-width="4" fill="none"/>
                               <path d="M75 45 Q80 60 75 75" stroke="${hair}" stroke-width="4" fill="none"/>`;
                    break;
                case 'short-fade':
                    hairSvg = `<ellipse cx="50" cy="30" rx="26" ry="14" fill="${hair}"/>
                               <rect x="26" y="28" width="6" height="12" fill="${hair}" opacity="0.6"/>
                               <rect x="68" y="28" width="6" height="12" fill="${hair}" opacity="0.6"/>`;
                    break;
                case 'short-neat':
                    hairSvg = `<ellipse cx="50" cy="28" rx="27" ry="15" fill="${hair}"/>
                               <rect x="24" y="28" width="8" height="14" fill="${hair}"/>
                               <rect x="68" y="28" width="8" height="14" fill="${hair}"/>`;
                    break;
                case 'hijab':
                    hairSvg = `<ellipse cx="50" cy="50" rx="38" ry="42" fill="#2d5a7b"/>
                               <ellipse cx="50" cy="48" rx="32" ry="28" fill="#3d6a8b"/>
                               <path d="M25 65 Q20 80 30 95" stroke="#2d5a7b" stroke-width="12" fill="none"/>
                               <path d="M75 65 Q80 80 70 95" stroke="#2d5a7b" stroke-width="12" fill="none"/>`;
                    break;
                case 'bob':
                    hairSvg = `<ellipse cx="50" cy="32" rx="32" ry="22" fill="${hair}"/>
                               <rect x="20" y="30" width="14" height="35" rx="4" fill="${hair}"/>
                               <rect x="66" y="30" width="14" height="35" rx="4" fill="${hair}"/>`;
                    break;
                case 'short-professional':
                    hairSvg = `<ellipse cx="50" cy="28" rx="28" ry="16" fill="${hair}"/>
                               <rect x="23" y="28" width="8" height="16" fill="${hair}"/>
                               <rect x="69" y="28" width="8" height="16" fill="${hair}"/>`;
                    break;
                case 'short-spiky':
                    hairSvg = `<ellipse cx="50" cy="30" rx="26" ry="14" fill="${hair}"/>
                               <polygon points="35,22 38,12 42,22" fill="${hair}"/>
                               <polygon points="47,20 50,8 53,20" fill="${hair}"/>
                               <polygon points="58,22 62,12 65,22" fill="${hair}"/>`;
                    break;
                case 'short-curly':
                    hairSvg = `<circle cx="35" cy="25" r="8" fill="${hair}"/>
                               <circle cx="50" cy="22" r="9" fill="${hair}"/>
                               <circle cx="65" cy="25" r="8" fill="${hair}"/>
                               <circle cx="28" cy="35" r="6" fill="${hair}"/>
                               <circle cx="72" cy="35" r="6" fill="${hair}"/>`;
                    break;
                case 'long-straight':
                    hairSvg = `<ellipse cx="50" cy="85" rx="30" ry="25" fill="${hair}"/>
                               <ellipse cx="50" cy="28" rx="32" ry="20" fill="${hair}"/>
                               <rect x="20" y="28" width="12" height="50" fill="${hair}"/>
                               <rect x="68" y="28" width="12" height="50" fill="${hair}"/>`;
                    break;
                case 'short-creative':
                    hairSvg = `<ellipse cx="50" cy="28" rx="28" ry="16" fill="${hair}"/>
                               <ellipse cx="30" cy="35" rx="10" ry="8" fill="${hair}"/>
                               <path d="M65 25 Q75 20 72 35" stroke="${hair}" stroke-width="8" fill="none"/>`;
                    break;
                case 'curly-top':
                    hairSvg = `<circle cx="35" cy="24" r="10" fill="${hair}"/>
                               <circle cx="50" cy="20" r="11" fill="${hair}"/>
                               <circle cx="65" cy="24" r="10" fill="${hair}"/>
                               <circle cx="42" cy="15" r="7" fill="${hair}"/>
                               <circle cx="58" cy="15" r="7" fill="${hair}"/>`;
                    break;
                case 'short-professional-f':
                    hairSvg = `<ellipse cx="50" cy="30" rx="30" ry="18" fill="${hair}"/>
                               <rect x="22" y="30" width="10" height="20" rx="3" fill="${hair}"/>
                               <rect x="68" y="30" width="10" height="20" rx="3" fill="${hair}"/>`;
                    break;
                case 'natural-curly':
                    hairSvg = `<circle cx="30" cy="30" r="12" fill="${hair}"/>
                               <circle cx="50" cy="24" r="14" fill="${hair}"/>
                               <circle cx="70" cy="30" r="12" fill="${hair}"/>
                               <circle cx="25" cy="45" r="10" fill="${hair}"/>
                               <circle cx="75" cy="45" r="10" fill="${hair}"/>
                               <circle cx="40" cy="18" r="9" fill="${hair}"/>
                               <circle cx="60" cy="18" r="9" fill="${hair}"/>`;
                    break;
            }
            
            // Accessories
            switch(accessories) {
                case 'glasses':
                    accessorySvg = `<circle cx="38" cy="48" r="10" stroke="#333" stroke-width="2" fill="none"/>
                                    <circle cx="62" cy="48" r="10" stroke="#333" stroke-width="2" fill="none"/>
                                    <line x1="48" y1="48" x2="52" y2="48" stroke="#333" stroke-width="2"/>
                                    <line x1="28" y1="48" x2="22" y2="44" stroke="#333" stroke-width="2"/>
                                    <line x1="72" y1="48" x2="78" y2="44" stroke="#333" stroke-width="2"/>`;
                    break;
                case 'earrings':
                    accessorySvg = `<circle cx="22" cy="55" r="3" fill="#ffd700"/>
                                    <circle cx="78" cy="55" r="3" fill="#ffd700"/>`;
                    break;
                case 'earring-single':
                    accessorySvg = `<circle cx="22" cy="55" r="3" fill="#c0c0c0"/>`;
                    break;
                case 'nose-ring':
                    accessorySvg = `<circle cx="53" cy="58" r="2" fill="#c0c0c0"/>`;
                    break;
                case 'beard':
                    facialHairSvg = `<ellipse cx="50" cy="72" rx="18" ry="12" fill="${hair}"/>
                                     <rect x="34" y="62" width="32" height="14" fill="${hair}"/>`;
                    break;
                case 'beard-light':
                    facialHairSvg = `<ellipse cx="50" cy="70" rx="14" ry="8" fill="${hair}" opacity="0.5"/>`;
                    break;
                case 'beard-trimmed':
                    facialHairSvg = `<ellipse cx="50" cy="70" rx="16" ry="10" fill="${hair}" opacity="0.8"/>
                                     <rect x="36" y="62" width="28" height="10" fill="${hair}" opacity="0.8"/>`;
                    break;
            }
            
            // Lip color for women/nb
            const lips = (gender === 'f' || gender === 'nb') && lipColor 
                ? `<path d="M43 65 Q50 70 57 65" stroke="${lipColor}" stroke-width="2.5" fill="none" stroke-linecap="round"/>`
                : `<path d="M44 65 Q50 68 56 65" stroke="#b57060" stroke-width="1.5" fill="none" stroke-linecap="round"/>`;
            
            // Eyebrows based on gender
            const eyebrows = gender === 'f' 
                ? `<path d="M32 42 Q38 40 44 43" stroke="${hair}" stroke-width="1.5" fill="none"/>
                   <path d="M56 43 Q62 40 68 42" stroke="${hair}" stroke-width="1.5" fill="none"/>`
                : `<path d="M32 41 Q38 39 44 42" stroke="${hair}" stroke-width="2.5" fill="none"/>
                   <path d="M56 42 Q62 39 68 41" stroke="${hair}" stroke-width="2.5" fill="none"/>`;
            
            return `<svg viewBox="0 0 100 100" style="width:100%;height:100%;">
                <rect width="100" height="100" fill="${bg}"/>
                ${hairSvg}
                <ellipse cx="50" cy="55" rx="28" ry="32" fill="${skin}"/>
                <circle cx="50" cy="52" r="26" fill="${skin}"/>
                ${facialHairSvg}
                ${eyebrows}
                <ellipse cx="38" cy="48" rx="4" ry="3" fill="white"/>
                <ellipse cx="62" cy="48" rx="4" ry="3" fill="white"/>
                <circle cx="39" cy="48" r="2.5" fill="${eyes}"/>
                <circle cx="63" cy="48" r="2.5" fill="${eyes}"/>
                <circle cx="40" cy="47" r="1" fill="white"/>
                <circle cx="64" cy="47" r="1" fill="white"/>
                <ellipse cx="50" cy="57" rx="4" ry="2.5" fill="${skin}" opacity="0.7"/>
                ${lips}
                ${accessorySvg}
            </svg>`;
        }

        function hireCandidate(role, candidateId) {
            playSound('hire');
            const candidate = candidates[role].find(c => c.id === candidateId);
            if (!candidate) return;
            
            // Deduct hire cost from P&L (external hires have recruitment fees)
            const hireCost = candidate.hireCost || 0;
            if (hireCost > 0) {
                state.profitLoss = parseFloat((state.profitLoss - hireCost).toFixed(2));
                logChange('profitLoss', -hireCost);
            }
            
            // Store candidate info
            state.leadershipTeam[role] = candidateId;
            
            // Store modifiers that will affect decision outcomes
            if (candidate.modifiers) { 
                state.leaderModifiers[role] = candidate.modifiers; 
            }
            
            announcers[role] = [{ name: candidate.name, title: `💼 Head of ${role.charAt(0).toUpperCase() + role.slice(1)}` }];
            
            // Store info for onboarding tracking
            if (!state.recruitmentInfo) state.recruitmentInfo = {};
            state.recruitmentInfo[role] = {
                name: candidate.name,
                type: candidate.type,
                hireCost: hireCost,
                onboardingMonths: candidate.onboardingMonths || 0,
                hiredAtMonth: state.turn // Track when hired (Month 0 = start)
            };
            
            state.hiringPhase.currentRoleIndex++;
            showHiringModal();
        }

        // Check if leader is still onboarding (reduced effectiveness)
        function isLeaderOnboarding(dept) {
            const info = state.recruitmentInfo?.[dept];
            if (!info || info.onboardingMonths === 0) return false;
            const monthsSinceHire = state.turn - info.hiredAtMonth;
            return monthsSinceHire < info.onboardingMonths;
        }
        
        // Get onboarding effectiveness (0.5 during onboarding, 1.0 after)
        function getOnboardingMultiplier(dept) {
            return isLeaderOnboarding(dept) ? 0.5 : 1.0;
        }

        // Helper function to get leader modifier for a specific stat type
        function getLeaderModifier(dept, modType) {
            const mods = state.leaderModifiers[dept];
            if (!mods) return 1.0;
            return mods[modType] || 1.0;
        }
        
        // Get combined modifier for a stat gain from a decision
        function getDecisionModifier(dept, statKey) {
            const mods = state.leaderModifiers[dept];
            if (!mods) return 1.0;
            
            // Check onboarding - reduced effectiveness during onboarding period
            const onboardingMult = getOnboardingMultiplier(dept);
            
            let modifier = 1.0;
            
            // Department bonus applies to all positive effects in their department
            if (mods.deptBonus) modifier += (mods.deptBonus * onboardingMult);
            
            // Specific stat multipliers (scaled by onboarding)
            if (statKey === 'templateProgress' && mods.templateMult) {
                const bonus = (mods.templateMult - 1) * onboardingMult;
                modifier *= (1 + bonus);
            }
            if (statKey === 'innovation' && mods.innovationMult) {
                const bonus = (mods.innovationMult - 1) * onboardingMult;
                modifier *= (1 + bonus);
            }
            if (statKey === 'morale' && mods.moraleMult) {
                const bonus = (mods.moraleMult - 1) * onboardingMult;
                modifier *= (1 + bonus);
            }
            if (statKey === 'skill' && mods.skillMult) {
                const bonus = (mods.skillMult - 1) * onboardingMult;
                modifier *= (1 + bonus);
            }
            if (statKey === 'purpose' && mods.purposeMult) {
                const bonus = (mods.purposeMult - 1) * onboardingMult;
                modifier *= (1 + bonus);
            }
            if (statKey === 'reach' && mods.reachMult) {
                const bonus = (mods.reachMult - 1) * onboardingMult;
                modifier *= (1 + bonus);
            }
            
            return modifier;
        }
        
        // Get risk modifier from leader (affects success chances)
        function getLeaderRiskMod(dept) {
            const mods = state.leaderModifiers[dept];
            if (!mods) return 0;
            // Risk modifier also scaled by onboarding
            const onboardingMult = getOnboardingMultiplier(dept);
            return (mods.riskMod || 0) * onboardingMult;
        }

        function nextMonth() {
            dom.nextBtn.disabled = true;
            
            console.log('nextMonth() called, state.turn =', state.turn);
            
            // If we've completed at least one month, show a progress report first
            if (state.turn >= 1) {
                // Capture values for the report (these are the END of the month we just completed)
                state.reportValues = {
                    purpose: state.purpose,
                    innovation: state.innovation,
                    skill: state.skill,
                    morale: state.morale,
                    reach: state.reach,
                    templateProgress: state.templateProgress,
                    profitLoss: state.profitLoss,
                    marketStrength: state.marketStrength,
                    completedMonth: state.turn
                };
                
                // Check if completed month was end of quarter
                const isQuarterEnd = [3, 6, 9, 12].includes(state.turn);
                console.log('isQuarterEnd =', isQuarterEnd, 'for turn', state.turn);
                
                if (isQuarterEnd) {
                    playSound('quarterEnd');
                    // At Q1 (month 3), show Neptune Reception first if not completed
                    console.log('Quarter end! Checking Neptune: turn =', state.turn, 'neptuneCompleted =', neptuneNetworkingCompleted);
                    if (state.turn === 3 && !neptuneNetworkingCompleted) {
                        console.log('Calling showNeptuneIframe()');
                        showNeptuneIframe();
                        // Neptune will call showQuarterlyReportAfterNeptune when done
                    } else {
                        showQuarterlyReport();
                    }
                } else {
                    playSound('monthEnd');
                    showTransitionReport();
                }
                // Report close handler will call continueToNextMonth()
                return;
            }
            
            // First time (turn 0 → 1), go straight to processing
            continueToNextMonth();
        }
        
        function continueToNextMonth() {
            // Capture current values before changes (for NEXT report)
            state.previousValues = {
                purpose: state.purpose,
                innovation: state.innovation,
                skill: state.skill,
                morale: state.morale,
                reach: state.reach,
                templateProgress: state.templateProgress,
                profitLoss: state.profitLoss,
                marketStrength: state.marketStrength
            };
            
            state.turn++;
            state.monthlyChanges = {};
            
            // Check for leaders completing onboarding this month
            if (state.recruitmentInfo) {
                Object.keys(state.recruitmentInfo).forEach(dept => {
                    const info = state.recruitmentInfo[dept];
                    if (info.onboardingMonths > 0) {
                        const monthsSinceHire = state.turn - info.hiredAtMonth;
                        if (monthsSinceHire === info.onboardingMonths) {
                            // Leader just completed onboarding
                            logChange(`${info.name}`, `Onboarding complete! Now fully effective.`, null, '🎓');
                        }
                    }
                });
            }

            // PASSIVE MONTHLY GROWTH: Better templates attract more markets organically
            // This rewards building a solid foundation before scaling
            const passiveGrowthRates = {
                'Prototype': 0.25,    // Minimal organic growth - still proving model
                'Basic': 0.5,         // Slow organic growth - word of mouth
                'Advanced': 1.0,      // Moderate growth - proven model attracts interest
                'Optimized': 1.5      // Good growth - brand power
            };
            const passiveGrowth = passiveGrowthRates[state.templateStage] || 0;
            if (passiveGrowth > 0) {
                state.reach += passiveGrowth;
                logChange('reach', passiveGrowth, state.reach, '📈');
            }
            
            // ====== ENTROPY & DECAY MECHANICS ======
            // Without active attention, things naturally deteriorate
            
            // MORALE DECAY: Teams lose motivation without regular wins/attention
            // More severe if already low (death spiral)
            const moraleDecayBase = state.morale > 60 ? 1 : (state.morale > 40 ? 2 : 3);
            if (state.turn > 1) {
                state.morale = Math.max(0, state.morale - moraleDecayBase);
                if (moraleDecayBase > 1) {
                    logChange('morale', -moraleDecayBase, state.morale, '😔');
                }
            }
            
            // SKILL DECAY: Without training/development, skills atrophy
            const skillDecay = state.skill > 50 ? 1 : 2;
            if (state.turn > 2) {
                state.skill = Math.max(0, state.skill - skillDecay);
            }
            
            // TEMPLATE DECAY: Early-stage templates need constant maintenance
            // Prototype and Basic templates degrade without attention
            const templateDecayRates = {
                'Prototype': 3,   // High decay - fragile, in people's heads
                'Basic': 2,       // Moderate decay - needs updating
                'Advanced': 1,    // Low decay - well documented
                'Optimized': 0    // No decay - self-sustaining
            };
            const templateDecay = templateDecayRates[state.templateStage] || 0;
            if (templateDecay > 0 && state.turn > 1) {
                state.templateProgress = Math.max(0, state.templateProgress - templateDecay);
                if (templateDecay >= 2) {
                    logChange('templateProgress', -templateDecay, state.templateProgress, '📉');
                }
            }
            
            // LOW MORALE CASCADE: Unhappy teams make more mistakes
            if (state.morale < 30) {
                // Critical morale - everything suffers
                state.marketStrength = Math.max(-50, state.marketStrength - 3);
                state.templateProgress = Math.max(0, state.templateProgress - 2);
                logChange("😰 Morale Crisis", "Team struggles affecting quality", null, '⚠️');
            } else if (state.morale < 45) {
                // Low morale - minor impact
                state.marketStrength = Math.max(-50, state.marketStrength - 1);
            }
            
            // ====== TEMPLATE-MARKET MISMATCH CHECK ======
            // If you have more markets than your template can support, problems accumulate
            const templateCapacity = {
                'Prototype': 4,    // Can barely handle 4 markets properly
                'Basic': 8,        // Can handle 8 markets
                'Advanced': 15,    // Can handle 15 markets
                'Optimized': 30    // Can scale significantly
            };
            const maxSupportedMarkets = templateCapacity[state.templateStage] || 4;
            const marketOverload = state.reach - maxSupportedMarkets;
            
            if (marketOverload > 0) {
                // Overloaded! Quality issues, customer complaints, operational chaos
                const severityMult = Math.min(2, 1 + (marketOverload / 10)); // Up to 2x penalty
                const qualityPenalty = Math.round(-2 * severityMult);
                const moralePenalty = Math.round(-1 * severityMult);
                const marketStrengthPenalty = Math.round(-3 * severityMult);
                
                state.marketStrength = Math.max(-50, state.marketStrength + marketStrengthPenalty);
                state.morale = Math.max(0, state.morale + moralePenalty);
                
                logChange("⚠️ Operational Strain", `Quality issues emerging across markets`, null, '⚠️');
                logChange('marketStrength', marketStrengthPenalty, state.marketStrength, '📉');
                logChange('morale', moralePenalty, state.morale, '😰');
            } else if (state.reach <= maxSupportedMarkets * 0.7) {
                // Well within capacity - template is working smoothly
                // Small market strength bonus for being operationally sound
                const capacityBonus = 1;
                state.marketStrength = Math.min(50, state.marketStrength + capacityBonus);
                logChange('marketStrength', capacityBonus, state.marketStrength, '✅');
            }

            // Revenue based on market reach, template stage, and market strength (in £K)
            const templateRevenueMod = templateModifiers[state.templateStage].revenueMult;
            // Market strength affects revenue: +10 strength = +10% revenue, -10 = -10%
            const marketStrengthMod = 1 + ((state.marketStrength || 0) / 100);
            // Scale bonus: moderate growth curve
            const scaleBonus = 1 + (state.reach * 0.03);
            // Maturity ramp-up: revenue starts low and grows as venture matures
            // Month 0: 0%, Month 1: 15%, Month 2: 30%... Month 7+: 100%
            const maturityRamp = state.turn <= 0 ? 0 : Math.min(1.0, state.turn * 0.15);
            // Base revenue per market: £300K (modified by all factors)
            const monthlyRevenue = Math.round(state.reach * 300 * scaleBonus * templateRevenueMod * marketStrengthMod * maturityRamp);
            
            // Monthly costs: base + per-market + revenue-based + investments
            // Revenue-based costs: 40% overhead for production, delivery, sales, support
            // This scales costs with the business - a £50M/month business has £20M in delivery costs
            const revenueBasedCosts = Math.round(monthlyRevenue * 0.40);
            
            // Per-market fixed costs decrease with template maturity (efficiency gains)
            const templateCostEfficiency = {
                'Prototype': 25,  // £25K per market - inefficient, figuring things out
                'Basic': 20,      // £20K per market - some standardisation
                'Advanced': 15,   // £15K per market - well-documented processes
                'Optimized': 10   // £10K per market - highly efficient operations
            };
            const perMarketCost = templateCostEfficiency[state.templateStage] || 25;
            const marketOperatingCosts = Math.round(state.reach * perMarketCost);
            
            // Apply cost multipliers from leaders
            let costMultiplier = 1.0;
            if (state.passiveBonuses.finance?.burnRateMult) costMultiplier *= state.passiveBonuses.finance.burnRateMult;
            if (state.passiveBonuses.hr?.costMult) costMultiplier *= state.passiveBonuses.hr.costMult;
            if (state.passiveBonuses.ops?.costMult) costMultiplier *= state.passiveBonuses.ops.costMult;
            
            // Apply cost pressure from events (can be positive or negative)
            const costPressure = state.costPressure || 0; // £K added/subtracted
            
            const baseCosts = Math.round((state.baseMonthlyCost || 500) * costMultiplier);
            const monthlyCosts = Math.round(baseCosts + marketOperatingCosts + revenueBasedCosts + state.totalMonthlyInvestment + costPressure);

            const monthlyNet = (monthlyRevenue - monthlyCosts) / 1000; // Convert to £M for state tracking
            applyEffects({ profitLoss: monthlyNet });
            state.totalRevenue += monthlyRevenue / 1000;
            state.totalCosts += monthlyCosts / 1000;

            logChange("Revenue", monthlyRevenue / 1000);
            logChange("Costs", -monthlyCosts / 1000);

            if (state.turn > state.maxTurns) { gameOver(true); return; }
            // Game over if cumulative losses exceed threshold based on strategy
            const lossThreshold = (state.baseMonthlyCost * 12 / 1000) * -1.5; // 1.5x annual costs as loss limit (in £M)
            if (state.profitLoss <= lossThreshold) { 
                gameOver(false, "Venture Unsustainable!", `Cumulative losses exceeded sustainable levels!`); 
                return; 
            }

            const modeLabel = state.gameMode === 'short' ? '⚡' : '';
            dom.turnCounter.textContent = `${modeLabel} Month ${state.turn} / ${state.maxTurns}`;

            let reviewTriggered = false;
            let performanceEndGame = false;
            if ([6, 12].includes(state.turn)) {
                state.eventQueue = []; // Clear queue before adding review month events
                performanceEndGame = checkPerformanceReview(); // May add warning event
                reviewTriggered = true;
                // Reallocation is handled by closeTransitionReport after quarterly reports
                // Add events alongside any review events (fewer in short mode)
                if (!performanceEndGame) {
                    const reviewEventCount = state.gameMode === 'short' 
                        ? 2 + Math.floor(Math.random() * 2)  // 2-3 events in short mode
                        : 3 + Math.floor(Math.random() * 3); // 3-5 events in normal mode
                    for (let i = 0; i < reviewEventCount; i++) {
                        const event = getRandomEvent();
                        if (event) state.eventQueue.push(event);
                    }
                }
            }
            if (performanceEndGame) return;

            let shockTriggeredThisMonth = false;
            if (!reviewTriggered && state.turn > 6 && !state.globalShockFiredThisGame && Math.random() < 0.015) {
                triggerGlobalShock();
                shockTriggeredThisMonth = true;
                state.globalShockFiredThisGame = true;
            }

            if (!shockTriggeredThisMonth && !reviewTriggered) {
                state.eventQueue = [];
                
                // Month 1 events vary by game mode
                if (state.turn === 1) {
                    if (state.gameMode === 'short') {
                        // Short mode: 3-4 events in month 1
                        const coreDepts = ['finance', 'hr', 'ops'];
                        coreDepts.forEach(dept => {
                            const event = getEventFromDepartment(dept);
                            if (event) state.eventQueue.push(event);
                        });
                        // Add 1 cheese event
                        const cheeseEvents = getShortcutEvents(1);
                        cheeseEvents.forEach(e => state.eventQueue.push(e));
                    } else {
                        // Normal mode: 5 events - four departments + 1 cheese
                        const coreDepts = ['finance', 'hr', 'ops', 'marketing'];
                        coreDepts.forEach(dept => {
                            const event = getEventFromDepartment(dept);
                            if (event) state.eventQueue.push(event);
                        });
                        // Add 1 tempting shortcut event
                        const cheeseEvents = getShortcutEvents(1);
                        cheeseEvents.forEach(e => state.eventQueue.push(e));
                    }
                    
                } else {
                    // Months 2+: Event count varies by game mode
                    let baseEvents, maxBonus;
                    if (state.gameMode === 'short') {
                        baseEvents = 2;  // 2-3 events per month in short mode
                        maxBonus = 2;    // 0, 1
                    } else {
                        baseEvents = 3;  // 3-5 events per month in normal mode
                        maxBonus = 3;    // 0, 1, or 2
                    }
                    const bonusEvents = Math.floor(Math.random() * maxBonus);
                    let eventCount = baseEvents + bonusEvents;
                    
                    // Months 2-3: Guarantee 1 cheese event
                    if (state.turn === 2 || state.turn === 3) {
                        const cheeseEvents = getShortcutEvents(1);
                        cheeseEvents.forEach(e => state.eventQueue.push(e));
                        eventCount--; // Cheese counts toward total
                    }
                    
                    for (let i = 0; i < eventCount; i++) {
                        const event = getRandomEvent();
                        if (event) state.eventQueue.push(event);
                    }
                }
            }
            // Note: reviewTriggered months (6, 12) already have events added above

            // Shuffle event queue so events appear in random order
            state.eventQueue = state.eventQueue.sort(() => Math.random() - 0.5);
            
            processEventQueue();
        }

        function checkPerformanceReview() {
            const expectedReach = Math.ceil(state.targetReach * (state.turn / state.maxTurns));
            const projectedLoss = state.startingProfitLoss * (1 - (state.turn / state.targetProfitMonth));

            let warning = false;
            let warningReason = "";
            let isExtremeFailure = false;
            const lossThreshold = state.baseMonthlyCost * 12 / 1000 * -1.5; // in £M

            // STRICTER PERFORMANCE REVIEWS
            if (state.reach < expectedReach * 0.55) {  // Was 0.45
                warning = true;
                warningReason = "Market Reach critically behind schedule.";
                if (state.turn >= 9 && state.reach < state.targetReach * 0.25) isExtremeFailure = true;  // Was 0.2
            } else if (state.profitLoss < projectedLoss * 1.5 && state.profitLoss < 0) {  // Was 1.75
                warning = true;
                warningReason = "P/L significantly below projection.";
                if (state.turn >= 9 && state.profitLoss < lossThreshold * 0.75) isExtremeFailure = true;  // Was 0.85
            } else if (state.morale < 25 && state.turn >= 6) {
                // NEW: Morale crisis warning
                warning = true;
                warningReason = "Team morale at critical levels. Board concerned about retention.";
                if (state.turn >= 9 && state.morale < 15) isExtremeFailure = true;
            } else if (state.hastyDecisions > 12 && state.turn >= 6) {
                // NEW: Hasty leadership warning
                warning = true;
                warningReason = "Concerns raised about rushed decision-making and insufficient analysis.";
            }

            if (isExtremeFailure) {
                gameOver(false, "Venture Closed Down!", "Critical underperformance led Board to shut down venture.");
                return true;
            }
            if (warning) {
                state.performanceWarnings++;
                logChange("Warning", 1, null, '⚠️');
                state.eventQueue.push({
                    dept: 'HQ', icon: '⚠️', title: `Performance Warning (#${state.performanceWarnings})`,
                    id: `WARN${state.performanceWarnings}`,
                    text: `Your ${state.turn}-month review is concerning. ${warningReason}\nBoard requires immediate corrective action.`,
                    options: [
                        { text: 'Acknowledge and commit to improve.', effects: { morale: -8 } },
                        { text: 'Challenge assessment (Skill 60+).', skillCheck: 60, passEffects: { morale: 2, skill: 1 }, failEffects: { morale: -11, profitLoss: -0.2 } }
                    ]
                });
                if (state.performanceWarnings >= 2) {
                    gameOver(false, "Leadership Change!", "Continued underperformance (2 warnings) means you've been replaced as GM.");
                    return true;
                }
            } else {
                state.performanceWarnings = Math.max(0, state.performanceWarnings - 1);
                logChange("Review", 0, null, '✅');
            }
            return false;
        }

        function processEventQueue() {
            // Add all events to inbox instead of showing directly
            while (state.eventQueue.length > 0) {
                const event = state.eventQueue.shift();
                addEmailToInbox(event);
            }
            
            // Update inbox display
            renderInbox();
            
            // Check if there are unread emails that need action
            const unreadEmails = emailInbox.emails.filter(e => !e.read);
            if (unreadEmails.length > 0) {
                // Keep next button disabled until emails are processed
                dom.nextBtn.disabled = true;
                dom.nextBtn.textContent = `📧 ${unreadEmails.length} email${unreadEmails.length > 1 ? 's' : ''} to review`;
            } else {
                // All emails processed - check for game over conditions
                const lossThreshold = state.baseMonthlyCost * 12 / 1000 * -1.5;
                if (state.profitLoss <= lossThreshold) { 
                    gameOver(false, "Venture Unsustainable!", `Cumulative losses exceeded sustainable levels!`); 
                    return; 
                }
                
                // Enable next month button (report will show when they click it)
                dom.nextBtn.disabled = false;
                if (state.turn < state.maxTurns) { 
                    dom.nextBtn.textContent = '▶ Next Month';
                } else {
                    // Month 12 complete - button will trigger final quarterly report
                    dom.nextBtn.textContent = '▶ Complete Year';
                }
            }
        }

        function showEventModal(event, email = null) {
            state.isModalOpen = true;
            state.emailOpenedAt = Date.now(); // Track when email was opened for hasty decision detection
            const deptKey = getDeptKey(event.dept);
            
            // Get the department head (hired candidate) for core departments
            let deptHead = null;
            let deptHeadId = null;
            const hiredHeadId = state.leadershipTeam[deptKey];
            
            if (hiredHeadId && candidates[deptKey]) {
                deptHead = candidates[deptKey].find(c => c.id === hiredHeadId);
                deptHeadId = hiredHeadId;
            }
            
            // Department title mapping
            const deptTitles = {
                finance: 'Head of Finance',
                hr: 'Head of Human Resources',
                ops: 'Head of Operations',
                marketing: 'Head of Marketing',
                tech: 'Head of Technology'
            };
            
            // Determine sender - ALWAYS use department head for core departments
            let sender;
            let subject;
            let greeting;
            let deptClass;
            let senderAvatarHtml;
            
            if (deptHead) {
                // Use department head as sender
                sender = {
                    name: deptHead.name,
                    role: deptTitles[deptKey] || `Head of ${event.dept}`,
                    email: `${deptHead.name.toLowerCase().replace(' ', '.')}@neptune-corp.com`
                };
                senderAvatarHtml = generateAvatar(deptHeadId, deptHead.name);
                greeting = `Dear Director,`;
            } else if (email) {
                // Use provided email info for non-department emails
                sender = email.sender;
                senderAvatarHtml = generateRandomAvatar(sender.name);
                greeting = email.greeting;
            } else {
                // Generate random sender
                sender = getEmailSender(event.dept);
                senderAvatarHtml = generateRandomAvatar(sender.name);
                greeting = generateEmailGreeting(sender.name);
            }
            
            // Get subject and dept class
            if (email) {
                subject = email.subject;
                deptClass = email.deptClass;
            } else {
                const subjectInfo = generateEmailSubject(event);
                subject = subjectInfo.subject;
                deptClass = getDeptTagClass(event.dept);
            }
            
            // Populate email header with appropriate avatar
            document.getElementById('email-view-avatar').innerHTML = senderAvatarHtml;
            document.getElementById('email-view-from').textContent = sender.name;
            document.getElementById('email-view-address').textContent = sender.email;
            document.getElementById('email-view-subject').textContent = subject;
            
            const deptBadge = document.getElementById('email-view-dept');
            deptBadge.textContent = event.dept;
            deptBadge.className = `email-view-dept-badge ${deptClass}`;
            
            // Populate email body
            document.getElementById('email-greeting').textContent = greeting;
            document.getElementById('email-message').textContent = event.text;
            
            // Email signature
            document.getElementById('email-sig-name').textContent = sender.name;
            document.getElementById('email-sig-title').textContent = sender.role;
            document.getElementById('email-sig-dept').textContent = event.dept + ' | Neptune Corporation';
            
            // Generate recommendation from department head
            const recommendation = generateSingleRecommendation(event, deptKey, deptHead);
            
            // Populate advisor box (same person as sender for department emails)
            const advisorAvatarEl = document.getElementById('reply-advisor-avatar');
            if (deptHead) {
                advisorAvatarEl.innerHTML = generateAvatar(deptHeadId, deptHead.name);
                document.getElementById('reply-advisor-name').textContent = deptHead.name;
                document.getElementById('reply-advisor-role').textContent = `Head of ${deptKey.charAt(0).toUpperCase() + deptKey.slice(1)}`;
            } else {
                advisorAvatarEl.innerHTML = generateRandomAvatar(event.dept + ' Team');
                document.getElementById('reply-advisor-name').textContent = event.dept + ' Team';
                document.getElementById('reply-advisor-role').textContent = 'Department';
            }
            document.getElementById('reply-advisor-badge').textContent = recommendation.stanceText;
            document.getElementById('reply-advisor-message').textContent = recommendation.message;
            
            // Build reply options - shuffle order every time so template-building options aren't always first
            dom.eventCard.options.innerHTML = '';
            
            // Create shuffled copy - MUST shuffle fresh each time this modal opens
            const shuffledOptions = [];
            for (let i = 0; i < event.options.length; i++) {
                shuffledOptions.push(event.options[i]);
            }
            
            // Standard Fisher-Yates shuffle - guaranteed to randomize
            for (let i = shuffledOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = shuffledOptions[i];
                shuffledOptions[i] = shuffledOptions[j];
                shuffledOptions[j] = temp;
            }
            
            shuffledOptions.forEach((option) => {
                const btn = document.createElement('button');
                btn.classList.add('reply-option');
                if (option.isDelay) btn.classList.add('delay');
                
                // Generate impact chips
                const tradeoffsHtml = generateImpactChips(option);
                
                btn.innerHTML = `
                    <div class="reply-option-text">"${option.text}"</div>
                    ${tradeoffsHtml}
                `;
                
                if (option.condition && typeof option.condition === 'function' && !option.condition()) { 
                    btn.disabled = true; 
                }
                btn.onclick = () => handleEventChoice(event, option);
                dom.eventCard.options.appendChild(btn);
            });
            
            dom.modals.event.classList.add('visible');
        }
        
        function generateImpactChips(option) {
            const effects = option.effects || {};
            
            // Department config - color comes from department, not direction
            const deptConfig = {
                templateProgress: { label: 'Template', icon: '📋', deptClass: 'dept-ops' },
                reach: { label: 'Markets', icon: '📈', deptClass: 'dept-mkt' },
                marketStrength: { label: 'Revenue', icon: '💰', deptClass: 'dept-fin' },
                skill: { label: 'Capability', icon: '🎓', deptClass: 'dept-hr' },
                morale: { label: 'Morale', icon: '👥', deptClass: 'dept-hr' },
                innovation: { label: 'Innovation', icon: '💡', deptClass: 'dept-tech' },
                purpose: { label: 'Purpose', icon: '🎯', deptClass: 'dept-all' },
                profitLoss: { label: 'P&L', icon: '📊', deptClass: 'dept-fin' },
                costPressure: { label: 'Costs', icon: '💸', deptClass: 'dept-fin' },
                staffLocal: { label: 'Local', icon: '🏠', deptClass: 'dept-hr' }
            };
            
            let html = '<div class="option-impact-grid">';
            
            // Show cash cost/investment first if present
            if (option.investment || option.cost) {
                const amount = option.investment || option.cost;
                const cashK = Math.round(amount * 100);
                const label = option.investment ? 'Invest' : 'Cost';
                html += `<div class="impact-box cash">
                    <span class="impact-box-icon">💷</span>
                    <span class="impact-box-label">${label}</span>
                    <span class="impact-box-value">£${cashK}K</span>
                </div>`;
            }
            
            // Show departmental impacts - color by department, arrow shows direction
            for (const [key, value] of Object.entries(effects)) {
                if (!deptConfig[key] || value === 0) continue;
                if (key === 'rollChance' || key === 'roll') continue;
                
                const config = deptConfig[key];
                const arrow = value > 0 ? '▲' : '▼';
                
                html += `<div class="impact-box ${config.deptClass}">
                    <span class="impact-box-icon">${config.icon}</span>
                    <span class="impact-box-label">${config.label}</span>
                    <span class="impact-box-arrow">${arrow}</span>
                </div>`;
            }
            
            // Show risk indicator if present
            if (option.rollChance !== undefined || option.roll) {
                const rollChance = option.rollChance || 0.5;
                const riskLabel = rollChance >= 0.6 ? 'Likely' : rollChance >= 0.4 ? 'Uncertain' : 'Risky';
                html += `<div class="impact-box risk">
                    <span class="impact-box-icon">🎲</span>
                    <span class="impact-box-label">${riskLabel}</span>
                    <span class="impact-box-arrow">?</span>
                </div>`;
            }
            
            // If no impacts, show balanced
            if (html === '<div class="option-impact-grid">') {
                html += `<div class="impact-box neutral">
                    <span class="impact-box-icon">⚖️</span>
                    <span class="impact-box-label">Balanced</span>
                    <span class="impact-box-arrow">—</span>
                </div>`;
            }
            
            html += '</div>';
            return html;
        }
        
        function generateSingleRecommendation(event, deptKey, candidate) {
            const options = event.options;
            
            // Default if no candidate
            if (!candidate) {
                return {
                    stance: 'neutral',
                    stanceText: '🤔 Thinking',
                    message: 'This is a judgment call that depends on your priorities.'
                };
            }
            
            // Get personality-driven perspective based on candidate's unique traits
            const perspective = getCandidatePerspective(candidate, event, options);
            
            return {
                stance: perspective.stance,
                stanceText: perspective.stanceText,
                message: perspective.message
            };
        }
        
        function getCandidatePerspective(candidate, event, options) {
            // Extract themes from the event
            const eventText = (event.title + ' ' + event.text).toLowerCase();
            const themes = detectEventThemes(eventText);
            
            // Get personality-specific response based on themes
            const response = getPersonalityResponse(candidate.id, themes, event, options);
            
            return response;
        }
        
        function detectEventThemes(text) {
            const themes = [];
            
            // Documentation & Process themes
            if (text.match(/document|write down|written|record|manual|procedure|checklist|sop/)) themes.push('documentation');
            if (text.match(/process|system|standard|consistent|quality|variation/)) themes.push('process');
            
            // Growth & Scale themes
            if (text.match(/grow|scale|expand|market|reach|rollout|launch/)) themes.push('growth');
            if (text.match(/fast|quick|speed|rapid|momentum|slow|delay|wait/)) themes.push('speed');
            if (text.match(/competitor|competition|market share|beaten/)) themes.push('competition');
            
            // People & Culture themes
            if (text.match(/team|staff|people|employee|morale|burnout|tired|overwhelm/)) themes.push('people');
            if (text.match(/train|learn|skill|capability|teach|mentor|develop/)) themes.push('training');
            if (text.match(/hire|recruit|talent|candidate|external/)) themes.push('hiring');
            if (text.match(/key person|knowledge|leave|quit|retention/)) themes.push('retention');
            
            // Financial themes
            if (text.match(/cost|spend|invest|budget|expensive|cheap|money|cash/)) themes.push('cost');
            if (text.match(/profit|revenue|margin|unit economics|pricing/)) themes.push('profit');
            if (text.match(/investor|board|funding|runway/)) themes.push('investors');
            
            // Strategy themes
            if (text.match(/template|model|approach|method|playbook|replicate/)) themes.push('template');
            if (text.match(/customer|client|user|segment|target|focus/)) themes.push('customer');
            if (text.match(/pilot|test|experiment|try|prove|evidence/)) themes.push('experiment');
            if (text.match(/risk|uncertain|gamble|bet|chance|might/)) themes.push('risk');
            
            // Purpose & Values themes
            if (text.match(/purpose|mission|values|meaning|impact|care|community/)) themes.push('purpose');
            if (text.match(/brand|message|voice|story|identity/)) themes.push('brand');
            
            // Technology themes
            if (text.match(/tech|system|automat|software|data|digital|tool/)) themes.push('technology');
            if (text.match(/innovate|new|creative|different|disrupt/)) themes.push('innovation');
            
            return themes.length > 0 ? themes : ['general'];
        }
        
        function getPersonalityResponse(candidateId, themes, event, options) {
            const primaryTheme = themes[0];
            const secondaryTheme = themes[1] || 'general';
            
            // Each personality has responses keyed by theme
            const responses = {
                // ===== FINANCE =====
                'fin1': { // Anya Sharma - Internal controller, cost-conscious
                    name: 'Anya',
                    background: 'Neptune controller',
                    responses: {
                        documentation: [
                            `"Documentation feels like overhead until you need it. I've seen Neptune projects fail audits because nobody wrote anything down. But I also know it slows things when cash is tight."`,
                            `"From a controls perspective, undocumented processes are risks I can't quantify. That said, perfect documentation of a failing model is still a failure."`
                        ],
                        cost: [
                            `"I've managed Neptune budgets long enough to know: it's not about spending less, it's about spending wisely. What's the return on this investment?"`,
                            `"The expensive option isn't always wrong, but I need to understand the payback period. Corporate will ask me to justify every pound."`
                        ],
                        growth: [
                            `"Growth is good, but unfunded growth is how divisions get shut down. Let's make sure we can afford to succeed before we commit to scaling."`,
                            `"I've watched Neptune ventures grow themselves into bankruptcy. Revenue isn't profit. What are the unit economics here?"`
                        ],
                        investors: [
                            `"The board wants progress, but they want sustainable progress more. I can build a narrative around either path - which one do you actually believe in?"`,
                            `"Investor pressure is real, but so is running out of cash. I'd rather under-promise and over-deliver than the reverse."`
                        ],
                        risk: [
                            `"Uncertain outcomes make forecasting impossible. If we're going to take risks, I need contingency budgets built in."`,
                            `"My job is to manage financial risk, not eliminate it. Tell me what failure looks like and I'll tell you if we can afford it."`
                        ],
                        general: [
                            `"From a pure numbers standpoint, I don't see a clear winner here. What matters is whether we can sustain this decision over 12 months."`,
                            `"The financial implications are manageable either way. Choose based on strategy, not cost."`
                        ]
                    }
                },
                'fin2': { // Marcus Thompson - Treasury, cash-focused
                    name: 'Marcus',
                    background: 'Neptune treasury',
                    responses: {
                        cost: [
                            `"Cash is oxygen. I've seen good ideas die because they ran out of runway before they proved themselves. How much buffer do we have if this takes longer than planned?"`,
                            `"That investment might pay off, but it also commits us. What doors does it close? I like keeping options open when we're still learning."`
                        ],
                        growth: [
                            `"Growth without margin improvement is just burning cash faster. Are we actually getting more efficient as we scale, or just bigger?"`,
                            `"I've seen Neptune divisions chase top-line growth that never turned profitable. Let's make sure we understand the economics first."`
                        ],
                        profit: [
                            `"Unit economics aren't glamorous, but they're what keeps us alive. Do we actually know our cost to serve?"`,
                            `"Revenue is vanity, profit is sanity, cash is reality. Which of these options improves our actual cash position?"`
                        ],
                        risk: [
                            `"My treasury training says: hope for the best, plan for the worst. What's our downside scenario here?"`,
                            `"I'm not against risk, but I want to understand the magnitude. A 30% chance of failure means different things depending on what we lose."`
                        ],
                        investors: [
                            `"The board meeting is temporary; the cash position is permanent. Let's make decisions we can live with, not just ones that look good in a presentation."`,
                            `"Investors want growth, but they also invested in our judgment. If we need more time, we should say so."`
                        ],
                        general: [
                            `"From a cash perspective, we can afford any of these. The question is which one builds the most value."`,
                            `"I don't see a financial red flag either way. Trust your operational judgment on this one."`
                        ]
                    }
                },
                'fin3': { // Chen Wei - External, startup CFO
                    name: 'Chen',
                    background: 'ex-Stripe/Revolut',
                    responses: {
                        speed: [
                            `"At Revolut, we moved fast because waiting was the real risk. Markets don't pause while you perfect your model. What's our cost of delay?"`,
                            `"My startup instinct says go faster, but I've learned Neptune has different rhythms. The question is whether that's wisdom or inertia."`
                        ],
                        growth: [
                            `"In fintech, we'd say 'growth solves most problems.' But that only works if the underlying model is sound. Are we ready to scale, or just eager?"`,
                            `"I've seen both sides - startups that scaled too early and crashed, and ones that waited too long and got beaten. Where are we in that spectrum?"`
                        ],
                        innovation: [
                            `"The safe option isn't always safest. At Stripe, our biggest regrets were things we didn't try, not things that failed."`,
                            `"Innovation requires permission to fail. Does Neptune's culture actually allow that, or do we just say it does?"`
                        ],
                        experiment: [
                            `"Frame this as an experiment: what's the hypothesis, how will we know if it works, and what will we do either way? That's how we built Stripe's culture."`,
                            `"The best learning comes from doing, not analysing. What's the minimum viable test we could run?"`
                        ],
                        documentation: [
                            `"At Revolut, we documented after we figured things out, not before. But we also had a lot of chaos to clean up later. Trade-offs."`,
                            `"Process can enable speed or kill it. The question is whether this documentation helps us move faster, or just makes us feel safer."`
                        ],
                        general: [
                            `"My startup brain says move faster. My Neptune experience says check twice. I genuinely don't know which is right here."`,
                            `"What do we need to believe for each option to be right? Let's test those beliefs, not debate them."`
                        ]
                    }
                },
                
                // ===== HR =====
                'hr1': { // Fatima Rossi - People/wellbeing focused
                    name: 'Fatima',
                    background: 'Neptune HR partner',
                    responses: {
                        people: [
                            `"I've been listening to the team. They're tired but motivated. Whatever we decide, let's be honest with them about what we're asking."`,
                            `"Change fatigue is real. We've asked a lot recently. Do we have the goodwill to ask for more, or should we let things settle first?"`
                        ],
                        training: [
                            `"Investing in people pays compound returns. Our best performers got that way because someone believed in them when they were uncertain."`,
                            `"Skills development isn't just about capability - it's about showing people they have a future here. That matters for retention."`
                        ],
                        retention: [
                            `"Key person risk keeps me up at night. Knowledge walking out the door is a crisis we can't recover from quickly."`,
                            `"People leave managers, not companies. How does this decision affect their relationship with leadership?"`
                        ],
                        hiring: [
                            `"External hires bring fresh perspectives but take time to understand our culture. Internal promotions are faster but might reinforce blind spots."`,
                            `"Every hire is a bet on culture fit. The most qualified candidate isn't always the best candidate."`
                        ],
                        documentation: [
                            `"I've seen documentation exercises crush morale when they feel like bureaucracy. But when framed as 'protecting our knowledge,' people engage differently."`,
                            `"The team will resist processes that feel imposed. Can we involve them in designing this, not just implementing it?"`
                        ],
                        purpose: [
                            `"People joined Neptune Care because it means something. That purpose is our secret weapon - let's not dilute it for efficiency."`,
                            `"In my 1:1s, people talk about wanting to make a difference. Which option lets them feel that?"`
                        ],
                        general: [
                            `"I'm watching body language in meetings. The team wants to believe we're building something that matters. Choose the path that earns their trust."`,
                            `"Whatever we decide, how we communicate it matters as much as the decision itself."`
                        ]
                    }
                },
                'hr2': { // Isabelle Dubois - Regional/local focused
                    name: 'Isabelle',
                    background: 'Neptune Europe HR',
                    responses: {
                        growth: [
                            `"What works in one market doesn't automatically work in another. I've seen Neptune rollouts fail because we assumed consistency."`,
                            `"Scaling isn't just about replicating - it's about adapting. Each community has its own rhythm."`
                        ],
                        process: [
                            `"Standardisation sounds efficient, but it can flatten the local nuances that make us effective. Can we build in flexibility?"`,
                            `"One size fits nobody perfectly. The best templates are frameworks, not straitjackets."`
                        ],
                        customer: [
                            `"Our local partners know their communities better than we do. Have we actually asked them what they think about this?"`,
                            `"Customer relationships are local, even when the brand is global. How does this decision land on the ground?"`
                        ],
                        purpose: [
                            `"Our community reputation took years to build. Some decisions can undo that in months. Are we being careful enough?"`,
                            `"Local trust is fragile. People remember when corporations let them down."`
                        ],
                        hiring: [
                            `"Local hiring isn't just about cost - it's about understanding. The best care comes from people who know the community."`,
                            `"External expertise is valuable, but so is local knowledge. How do we get both?"`
                        ],
                        template: [
                            `"Templates work when they capture principles, not prescriptions. What should be consistent versus what should be adapted?"`,
                            `"I'd want to pilot in one region before we commit everywhere. Let's learn from variation, not eliminate it prematurely."`
                        ],
                        general: [
                            `"The right answer probably depends on which market we're thinking about. What works for established teams might overwhelm newer sites."`,
                            `"I keep thinking about our partners on the ground. How would they react to each option?"`
                        ]
                    }
                },
                'hr3': { // David Kim - Ex-McKinsey consultant
                    name: 'David',
                    background: 'ex-McKinsey',
                    responses: {
                        process: [
                            `"In consulting, we'd call this an operating model question. Which option builds capability that outlasts any individual?"`,
                            `"Organisations that win are the ones that institutionalise what they learn. Individual heroics don't scale."`
                        ],
                        training: [
                            `"Capability building is the best investment you can make, but it requires patience. McKinsey taught me that the hard path is usually right."`,
                            `"Skills compound. The question isn't what's fastest now, but what creates the most value over time."`
                        ],
                        documentation: [
                            `"Documentation is institutionalised memory. Without it, you're always starting from scratch when people change."`,
                            `"Process isn't bureaucracy when it captures real knowledge. The trick is knowing what's worth writing down."`
                        ],
                        template: [
                            `"A good template is a competitive advantage. It lets you scale what works without reinventing everything each time."`,
                            `"But templates can also ossify. The best ones have built-in mechanisms for learning and updating."`
                        ],
                        growth: [
                            `"Scaling prematurely is a classic mistake. I've seen it in dozens of transformations. Do we actually know what we're scaling?"`,
                            `"Growth is easy to measure but hard to sustain. Capability is hard to measure but compounds over time."`
                        ],
                        risk: [
                            `"High-risk options often look attractive because they avoid the hard work of building systems. But organisational debt compounds."`,
                            `"Risk isn't bad, but unexamined risk is. What exactly are we betting on, and do we believe it?"`
                        ],
                        general: [
                            `"Let me reframe: which option builds organisational muscle versus which just solves today's problem?"`,
                            `"The best leaders take the harder path that creates lasting capability. Which is that here?"`
                        ]
                    }
                },
                
                // ===== OPERATIONS =====
                'ops1': { // Kenji Tanaka - Six Sigma, process expert
                    name: 'Kenji',
                    background: 'Neptune supply chain',
                    responses: {
                        documentation: [
                            `"In my 15 years at Neptune, I've learned: undocumented processes are just accidents waiting to happen. When things go wrong, how will we know what went wrong?"`,
                            `"Documentation isn't bureaucracy - it's how knowledge survives when people leave. Can we teach someone else to do this?"`
                        ],
                        process: [
                            `"The Six Sigma mindset: reduce variation, document everything, eliminate defects. Quality comes from consistency, not heroics."`,
                            `"When I achieved 99.7% quality in Japan, it was because every step was written down. Predictability is a feature."`
                        ],
                        quality: [
                            `"Quality varies wildly when processes aren't standardised. That's fine in experiments, dangerous in operations."`,
                            `"I've seen what happens when quality slips. People get hurt. That's not abstract to me."`
                        ],
                        speed: [
                            `"'Move fast' works in software, maybe. We're dealing with people's care. I'd rather be boringly reliable than excitingly inconsistent."`,
                            `"Speed without standards creates chaos. What exactly are we replicating when we grow?"`
                        ],
                        template: [
                            `"A template isn't a constraint - it's accumulated wisdom. The question is whether we've actually accumulated enough wisdom yet."`,
                            `"My question is always: can we teach someone else to do this? If no, we haven't really figured it out."`
                        ],
                        risk: [
                            `"Uncertainty in operations means unpredictable outcomes for vulnerable people. That's not a risk I take lightly."`,
                            `"I'm not against experimentation, but I want controlled experiments with clear boundaries, not chaos we call innovation."`
                        ],
                        general: [
                            `"My instinct is always to systematise before we scale. But I recognise that can feel slow when there's pressure to grow."`,
                            `"What would this look like if we had to teach 100 new people to do it? That's the test I apply."`
                        ]
                    }
                },
                'ops2': { // Ahmed Khan - Factory manager, practical
                    name: 'Ahmed',
                    background: 'Neptune factory',
                    responses: {
                        process: [
                            `"I've run this factory for years on tight margins. Fancy systems come and go, but what works is good people doing sensible things."`,
                            `"Don't overcomplicate it. Most problems have simple solutions if you listen to the people doing the work."`
                        ],
                        cost: [
                            `"Expensive consultants and systems sound good in meetings but rarely survive contact with reality. What's the simplest thing that could work?"`,
                            `"I've learned to start cheap and add complexity only when you need it. The opposite almost never works."`
                        ],
                        people: [
                            `"My best supervisors taught me: happy teams catch problems before they become crises. Processes can't replace caring."`,
                            `"People know when leadership respects them. That matters more than any system we implement."`
                        ],
                        training: [
                            `"Training works when people want to learn. The best development happens through doing, not sitting in classrooms."`,
                            `"Pair up new people with good people. That's training that actually sticks."`
                        ],
                        documentation: [
                            `"Some things need writing down. Most things just need good people talking to each other. Know the difference."`,
                            `"I've seen documentation become a substitute for thinking. 'It's in the manual' doesn't mean it's right."`
                        ],
                        speed: [
                            `"Fast decisions aren't always good decisions. But slow decisions aren't always wise either. Use judgment."`,
                            `"The shop floor already knows what we should do. The question is whether we're listening."`
                        ],
                        general: [
                            `"I'm not one for fancy theories. What I know is: keep it simple, respect your people, fix what's actually broken."`,
                            `"Which option feels like common sense? That's usually right."`
                        ]
                    }
                },
                'ops3': { // Maria Garcia - Ex-Amazon, speed-focused
                    name: 'Maria',
                    background: 'ex-Amazon',
                    responses: {
                        speed: [
                            `"At Amazon, we'd say: bias for action. You can iterate on a decision you've made; you can't iterate on one you haven't."`,
                            `"Waiting for perfect information is its own risk. What's the cost of delay here?"`
                        ],
                        growth: [
                            `"Amazon taught me that speed is a feature. The market doesn't wait while you perfect your playbook."`,
                            `"I've seen slow competitors become case studies. There's a time for caution and a time for momentum."`
                        ],
                        competition: [
                            `"Competitors are moving. Every week we spend perfecting is a week they spend gaining ground."`,
                            `"Being second to market isn't automatically fatal, but it's a disadvantage we don't need."`
                        ],
                        documentation: [
                            `"At Amazon, we documented after we figured things out, not before. Write down what works, not what you hope will work."`,
                            `"Perfect documentation of something you haven't proven is just organised speculation."`
                        ],
                        process: [
                            `"Process should enable speed, not prevent it. If it's slowing us down, we have the wrong process."`,
                            `"What's the minimum viable process? We can add rigour later once we know what actually matters."`
                        ],
                        template: [
                            `"Perfect templates don't help if competitors capture the market while we're documenting."`,
                            `"I'd rather have an 80% template in three months than a 100% template in twelve."`
                        ],
                        risk: [
                            `"'Move fast and be willing to be misunderstood.' Some risk is unavoidable when you're building something new."`,
                            `"The biggest risk is often inaction. What happens if we do nothing?"`
                        ],
                        general: [
                            `"My Amazon instinct says: ship it, learn, iterate. But I recognise care is different from e-commerce."`,
                            `"What's the minimum viable version of the thorough approach? There's usually a faster path to 'good enough.'"`
                        ]
                    }
                },
                
                // ===== MARKETING =====
                'mkt1': { // Chloé Moreau - Brand focused
                    name: 'Chloé',
                    background: 'Neptune brands',
                    responses: {
                        brand: [
                            `"Every touchpoint either builds or erodes trust. Which option tells the story we want customers to remember?"`,
                            `"After relaunching Neptune's luxury line, I learned brand equity is fragile. It's easier to damage than build."`
                        ],
                        customer: [
                            `"I think about this from the customer's perspective: would they care about this decision? Would they even notice?"`,
                            `"Customers chose us for a reason. Let's make sure whatever we do reinforces why they trust us."`
                        ],
                        growth: [
                            `"Chasing scale can dilute what makes us special. Growth without meaning is just noise."`,
                            `"I've seen brands grow themselves into irrelevance. Bigger isn't always better."`
                        ],
                        purpose: [
                            `"Brands that endure stand for something consistent. What do we want to be known for in five years?"`,
                            `"Purpose isn't marketing - it's strategy. It guides decisions when everything else is unclear."`
                        ],
                        innovation: [
                            `"Innovation for its own sake is a trap. 'Is this new?' matters less than 'Does this strengthen our position?'"`,
                            `"The best innovations feel inevitable in retrospect because they fit who we already are."`
                        ],
                        process: [
                            `"Internal process is invisible to customers until it isn't. Good operations enable good experiences."`,
                            `"I don't have strong feelings about how we do this, as long as it doesn't affect the customer experience."`
                        ],
                        general: [
                            `"What story does each option let us tell? I can build marketing around conviction, not around committee decisions."`,
                            `"If we wouldn't be proud to tell customers about this decision, maybe we shouldn't make it."`
                        ]
                    }
                },
                'mkt2': { // Mei Lin - Purpose/sustainability
                    name: 'Mei',
                    background: 'Neptune sustainability',
                    responses: {
                        purpose: [
                            `"We joined Neptune Care because it means something. Growth without purpose is just colonialism with better marketing."`,
                            `"In five years, which decision will we be glad we made? Usually it's the one that stayed true to why we exist."`
                        ],
                        growth: [
                            `"I've seen what happens when mission-driven organisations lose their way. The best people leave first."`,
                            `"Scale should amplify impact, not dilute it. Are we becoming more of what we are, or less?"`
                        ],
                        people: [
                            `"The team watches how we make decisions. It signals what we really value. Choose accordingly."`,
                            `"People don't burn out from hard work; they burn out from work that doesn't matter. Does this feel meaningful?"`
                        ],
                        customer: [
                            `"Our customers are vulnerable people who trusted us. Every decision should honour that trust."`,
                            `"I keep thinking about the families we serve. Which option would they want us to choose?"`
                        ],
                        speed: [
                            `"Moving fast often means cutting corners on what matters. I'd rather do something meaningful slowly."`,
                            `"Urgency can be real or manufactured. Are we actually in a hurry, or just uncomfortable with patience?"`
                        ],
                        profit: [
                            `"Profit should be a byproduct of doing good work, not the goal itself. We're not a charity, but we're not just a business either."`,
                            `"Unit economics matter, but so does how we make those units. The how is part of the what."`
                        ],
                        general: [
                            `"I keep asking: which option would make our team proud to work here? That's usually the right answer."`,
                            `"Mission creep is subtle. Each small compromise feels reasonable until you've drifted completely."`
                        ]
                    }
                },
                'mkt3': { // Sam Jones - Creative agency, innovation
                    name: 'Sam',
                    background: 'creative agency',
                    responses: {
                        innovation: [
                            `"Safe choices disappear into the noise. What would we do if we weren't afraid of being different?"`,
                            `"The best work I've done came from permission to fail. Does Neptune's culture actually allow that?"`
                        ],
                        brand: [
                            `"The best marketing doesn't feel like marketing - it feels like a point of view. What's ours?"`,
                            `"I can build a campaign around conviction. I can't build one around committee thinking."`
                        ],
                        speed: [
                            `"Perfection is the enemy of good creative. Ship something interesting and learn."`,
                            `"Overthinking kills creativity. Sometimes you need to trust your instincts and go."`
                        ],
                        documentation: [
                            `"Too much process kills creative energy. But too little creates chaos. Find the balance."`,
                            `"The best creative work comes from constraints, not from infinite freedom. What are our real constraints here?"`
                        ],
                        growth: [
                            `"Growth for its own sake isn't interesting. Growth that proves something? That's a story."`,
                            `"I worry we're optimising ourselves into irrelevance. Where's the boldness?"`
                        ],
                        risk: [
                            `"Everything interesting involves risk. The question is whether it's creative risk or careless risk."`,
                            `"Playing it safe is its own risk - the risk of being boring. Sometimes you have to bet."`
                        ],
                        general: [
                            `"Can I be candid? None of these options excite me creatively. Is there a bolder path we're not considering?"`,
                            `"Which option gives us something genuine to say? I need substance to work with."`
                        ]
                    }
                },
                
                // ===== TECHNOLOGY =====
                'tech1': { // Eva Schmidt - Neptune IT, systems
                    name: 'Eva',
                    background: 'Neptune IT',
                    responses: {
                        technology: [
                            `"I've maintained Neptune's systems long enough to know: shortcuts become permanent. Technical debt accumulates faster than people think."`,
                            `"What looks expensive now is cheaper than fixing it later. I've learned that lesson painfully."`
                        ],
                        process: [
                            `"From a systems perspective, consistency is everything. Variation in process creates variation in data creates bad decisions."`,
                            `"Good systems make good behaviour easy and bad behaviour hard. Does our setup do that?"`
                        ],
                        documentation: [
                            `"Systems only work when people understand them. Documentation isn't optional."`,
                            `"I've seen great software fail because nobody wrote down how to use it. Don't repeat that mistake."`
                        ],
                        risk: [
                            `"Before we take the uncertain path: what's our rollback plan? 'Figure it out later' means engineers working weekends."`,
                            `"I'm not against experimentation, but I want containment. If it fails, how do we limit the blast radius?"`
                        ],
                        growth: [
                            `"Our systems can scale if we build them right. But 'right' means making decisions now that future-us will thank us for."`,
                            `"Scaling broken systems just breaks them faster. Fix the foundation first."`
                        ],
                        speed: [
                            `"'Move fast and break things' is easy to say when you're not the one fixing the things."`,
                            `"Speed and quality aren't opposites, but they require planning. Rush jobs create permanent problems."`
                        ],
                        general: [
                            `"From a systems perspective, I care most about reliability. Which option creates the most stable foundation?"`,
                            `"We can build almost anything. We can't build everything at once. What's the priority?"`
                        ]
                    }
                },
                'tech2': { // Olivia Green - Reliability focused
                    name: 'Olivia',
                    background: 'Neptune tech lead',
                    responses: {
                        risk: [
                            `"I've cleaned up enough 'move fast' disasters to be cautious. Uncertainty sounds exciting until you're debugging at 2am."`,
                            `"My test: will this still work in six months when we've forgotten the context? Good systems are boringly predictable."`
                        ],
                        technology: [
                            `"The steady path gives us something solid to build on. Exciting technology that doesn't work isn't actually exciting."`,
                            `"I'd rather have boring technology that works than innovative technology that mostly works."`
                        ],
                        training: [
                            `"Training our team pays off in ways that are hard to measure - fewer bugs, better architecture, people who stick around."`,
                            `"The capability angle interests me. Skilled teams solve problems that process can't."`
                        ],
                        speed: [
                            `"Fast and sustainable aren't the same thing. Which do we actually need?"`,
                            `"Short-term speed often creates long-term slowness. Let's think about total cost, not just initial effort."`
                        ],
                        process: [
                            `"Good process makes the right thing easy. Bad process makes everything hard. Know the difference."`,
                            `"Process should prevent yesterday's mistakes, not yesterday's innovations. Update accordingly."`
                        ],
                        documentation: [
                            `"Documentation is institutional memory. Without it, every team change is a minor disaster."`,
                            `"The best documentation is the kind that helps future-us when we've forgotten current-us's context."`
                        ],
                        general: [
                            `"Reliability isn't glamorous but it's essential. Which option lets us sleep at night?"`,
                            `"I worry about what happens when something goes wrong. What's our recovery story?"`
                        ]
                    }
                },
                'tech3': { // Raj Patel - Ex-Google, startup CTO
                    name: 'Raj',
                    background: 'ex-Google CTO',
                    responses: {
                        innovation: [
                            `"At Google, we'd ship and iterate. But that was with infinite engineering resources. Our constraints are different."`,
                            `"Innovation requires permission to fail. The question is whether we can afford failure right now."`
                        ],
                        speed: [
                            `"My startup instinct says move faster. My Neptune experience says sustainable pace matters more than sprint speed."`,
                            `"At Google we said 'launch and iterate' - but we also had teams to fix things when iteration revealed problems."`
                        ],
                        technology: [
                            `"Sometimes boring technology is a competitive advantage. Not every problem needs a clever solution."`,
                            `"The right tool is the one your team can actually use, not the one that looks impressive in a pitch deck."`
                        ],
                        experiment: [
                            `"Frame it as an experiment: clear hypothesis, success metrics, and a decision either way. That's how good companies learn."`,
                            `"The best learning comes from shipped products, not planning documents. What can we test quickly?"`
                        ],
                        risk: [
                            `"Google could absorb failed experiments. We're more fragile. But zero risk means zero learning."`,
                            `"The risky path could work, but I'm thinking about our team's capacity to recover if it doesn't."`
                        ],
                        template: [
                            `"Building the right foundation actually accelerates innovation later. But 'right' takes longer than 'fast'."`,
                            `"A good template isn't a constraint - it's a platform. It should enable creativity, not prevent it."`
                        ],
                        general: [
                            `"What's our appetite for technical debt right now? That frames the decision."`,
                            `"Which option lets us learn quickly without burning out the team? That's usually the sweet spot."`
                        ]
                    }
                }
            };
            
            const personality = responses[candidateId];
            if (!personality) {
                return {
                    stance: 'neutral',
                    stanceText: '💭 Reflecting',
                    message: `"This is genuinely difficult. I can see merits in each approach - it depends on what we're optimising for."`
                };
            }
            
            // Try to find a response for the primary theme, then secondary, then general
            let responsePool = personality.responses[primaryTheme] || 
                              personality.responses[secondaryTheme] || 
                              personality.responses['general'];
            
            // Pick a random response from the pool
            const message = responsePool[Math.floor(Math.random() * responsePool.length)];
            
            // Vary the stance display
            const stanceOptions = [
                { text: '💭 ' + personality.name + "'s take" },
                { text: '🎯 ' + personality.background },
                { text: '💡 Their view' }
            ];
            const stance = stanceOptions[Math.floor(Math.random() * stanceOptions.length)];
            
            return {
                stance: 'neutral',
                stanceText: stance.text,
                message: message
            };
        }

        function handleEventChoice(event, option) {
            playSound('mailSent');
            dom.modals.event.classList.remove('visible');
            state.isModalOpen = false;
            
            // Check for hasty decision-making
            let isHastyDecision = false;
            if (state.emailOpenedAt) {
                const decisionTime = Date.now() - state.emailOpenedAt;
                if (decisionTime < state.hastyThresholdMs) {
                    isHastyDecision = true;
                    state.hastyDecisions++;
                    logChange("⚡ Hasty Decision", `Decided in ${(decisionTime/1000).toFixed(1)}s — effects reduced`, null, '⚠️');
                    
                    // Show toast notification
                    const toast = document.getElementById('hasty-toast');
                    if (toast) {
                        toast.classList.add('visible');
                        setTimeout(() => toast.classList.remove('visible'), 2500);
                    }
                }
                state.emailOpenedAt = null; // Reset for next email
            }
            
            // Remove this email from the inbox (it's been handled)
            const emailIndex = emailInbox.emails.findIndex(e => e.id === event.id);
            if (emailIndex !== -1) {
                emailInbox.emails.splice(emailIndex, 1);
            }
            
            // Handle billion-dollar brand pathway choice
            if (option.billionPath) {
                state.billionDollarPath = option.billionPath;
                state.billionDollarSuccess = true;
                
                const pathTitles = {
                    'promotion': '💎 Billion-Dollar Brand — Promoted to Group Executive',
                    'founder': '💎 Billion-Dollar Brand — New Chapter as Founder',
                    'spinout': '💎 Billion-Dollar Brand — CEO of Independent Venture'
                };
                
                gameOver(true, pathTitles[option.billionPath], "");
                return;
            }
            
            // Handle billion-dollar event decline - proceed to normal game over
            if (event.isBillionDollar && !option.billionPath) {
                gameOver(true);
                return;
            }
            
            let effects = { ...option.effects };
            
            // HASTY DECISION PENALTY: Reduce positive effects, amplify negative effects
            if (isHastyDecision) {
                for (let key in effects) {
                    if (key === 'profitLoss' || key.endsWith('Mult')) continue;
                    if (effects[key] > 0) {
                        // Reduce positive effects by 50% (was 40%)
                        effects[key] = Math.round(effects[key] * 0.5);
                    } else if (effects[key] < 0) {
                        // Amplify negative effects by 40% (was 25%)
                        effects[key] = Math.round(effects[key] * 1.4);
                    }
                }
                // Additional morale penalty - team notices rushed leadership
                effects.morale = (effects.morale || 0) - 3;
                // Skill penalty - can't learn when rushing
                effects.skill = (effects.skill || 0) - 1;
                // Template penalty - rushed work doesn't build good processes
                effects.templateProgress = (effects.templateProgress || 0) - 2;
            }
            
            // ====== PREMATURE SCALING PENALTY SYSTEM ======
            // Core lesson: Build template FIRST, then scale
            const templateIndex = templateStages.indexOf(state.templateStage);
            const templateReadiness = (templateIndex * 25) + (state.templateProgress * 0.25); // 0-100 scale
            
            // If trying to increase reach without a solid template, apply penalties
            if (effects.reach && effects.reach > 0) {
                const isEarlyGame = state.turn <= 4;
                const hasWeakTemplate = templateReadiness < 40; // Need at least Basic template + some progress
                
                if (hasWeakTemplate) {
                    // SCALING PENALTY: Reduce reach gains significantly
                    const scalingEfficiency = Math.max(0.2, templateReadiness / 50); // 20% to 80% efficiency
                    const originalReach = effects.reach;
                    effects.reach = Math.max(1, Math.round(effects.reach * scalingEfficiency));
                    
                    // Additional penalties for premature scaling
                    effects.marketStrength = (effects.marketStrength || 0) - Math.round(originalReach * 3);
                    effects.morale = (effects.morale || 0) - 2;
                    effects.skill = (effects.skill || 0) - 2;
                    
                    logChange("⚠️ Growing Pains", `Expansion efficiency: ${Math.round(scalingEfficiency * 100)}%`, null, '⚠️');
                    
                    // Show warning toast - but don't reveal the strategy!
                    const toast = document.getElementById('hasty-toast');
                    if (toast) {
                        toast.querySelector('.toast-icon').textContent = '📉';
                        toast.querySelector('.hasty-toast-title').textContent = 'Growing Pains!';
                        toast.querySelector('.hasty-toast-message').textContent = 'Expansion hit some friction...';
                        toast.classList.add('visible');
                        setTimeout(() => {
                            toast.classList.remove('visible');
                            // Reset to default
                            toast.querySelector('.toast-icon').textContent = '⚡';
                            toast.querySelector('.hasty-toast-title').textContent = 'Hasty Decision!';
                            toast.querySelector('.hasty-toast-message').textContent = 'Effects reduced — take time to read';
                        }, 3500);
                    }
                } else if (isEarlyGame && templateReadiness < 60) {
                    // Early game with moderate template - minor penalty
                    effects.reach = Math.max(1, Math.round(effects.reach * 0.7));
                    logChange("📋 Expansion", "Some friction in new markets", null, '📋');
                } else if (templateReadiness >= 70) {
                    // SCALING BONUS: Good template = scaling works better!
                    const scalingBonus = 1 + ((templateReadiness - 60) / 100); // Up to 40% bonus
                    effects.reach = Math.round(effects.reach * scalingBonus);
                    effects.marketStrength = (effects.marketStrength || 0) + 3;
                    logChange("✨ Smooth Expansion", `New markets integrating well`, null, '✨');
                }
            }
            
            // Get department for this event
            const dept = event.dept?.toLowerCase() || 'ops';
            const deptMap = { 'finance': 'finance', 'hr': 'hr', 'ops': 'ops', 'marketing': 'marketing', 'tech': 'tech' };
            const mappedDept = deptMap[dept] || 'ops';
            
            // Get investment multiplier for this department
            const investmentMult = getInvestmentMultiplier(mappedDept);
            
            // Apply modifiers to positive effects only
            for (let key in effects) {
                if (key === 'profitLoss' || key.endsWith('Mult')) continue;
                if (effects[key] > 0) {
                    // Apply investment multiplier
                    let modified = effects[key] * investmentMult;
                    // Apply leader modifier for this specific stat
                    modified *= getDecisionModifier(mappedDept, key);
                    effects[key] = Math.round(modified);
                }
            }
            
            // Handle skill/morale checks and risk rolls with leader risk modifier
            const leaderRiskMod = getLeaderRiskMod(mappedDept);
            
            // TEMPLATE AFFECTS RISK: Better template = better odds for risky decisions
            // Scaling without template is genuinely risky!
            const templateRiskMod = (templateReadiness - 50) / 200; // -0.25 to +0.25 based on template

            if (option.skillCheck) {
                if (state.skill >= option.skillCheck) { effects = { ...effects, ...option.passEffects }; logChange("Skill Check", "PASSED! 🎉"); }
                else { effects = { ...effects, ...option.failEffects }; logChange("Skill Check", "FAILED! 😰"); }
            } else if (option.moraleCheck) {
                if (state.morale >= option.moraleCheck) { effects = { ...effects, ...option.passEffects }; logChange("Morale Check", "PASSED! 🎉"); }
                else { effects = { ...effects, ...option.failEffects }; logChange("Morale Check", "FAILED! 😰"); }
            } else if (option.rollChance !== undefined) {
                const roll = Math.random();
                // Apply leader risk modifier AND template modifier to success chance
                // Weak template = riskier outcomes
                const adjustedChance = Math.min(0.90, Math.max(0.10, option.rollChance + leaderRiskMod + templateRiskMod));
                const passed = roll < adjustedChance;
                if (passed && option.roll?.pass) { effects = { ...effects, ...option.roll.pass }; logChange("Risk Roll", "SUCCESS! 🎲"); }
                else if (!passed && option.roll?.fail) { 
                    effects = { ...effects, ...option.roll.fail }; 
                    // Extra penalty for failing with weak template
                    if (templateReadiness < 40) {
                        effects.marketStrength = (effects.marketStrength || 0) - 5;
                        logChange("Risk Roll", "FAILED! 🎲 (Complications arose)"); 
                    } else {
                        logChange("Risk Roll", "FAILED! 🎲");
                    }
                }
            } else if (option.roll && !option.rollChance) {
                const roll = Math.random();
                // Apply leader risk modifier AND template modifier to 50/50 chance
                const adjustedChance = Math.min(0.90, Math.max(0.10, 0.5 + leaderRiskMod + templateRiskMod));
                const passed = roll < adjustedChance;
                if (passed && option.roll?.pass) { effects = { ...effects, ...option.roll.pass }; }
                else if (!passed && option.roll?.fail) { 
                    effects = { ...effects, ...option.roll.fail }; 
                    if (templateReadiness < 40) {
                        effects.marketStrength = (effects.marketStrength || 0) - 5;
                    }
                }
            }

            applyEffects(effects);
            checkTemplateUpgrade();
            updateDashboard();
            
            // Check if this option triggers reallocation
            if (option.triggerReallocation) {
                showReallocationModal();
                return; // Don't process queue yet - reallocation modal will do it
            }
            
            processEventQueue();
        }

        function applyEffects(effects) {
            if (!effects) return;
            for (let key in effects) {
                if (key.endsWith('Mult')) continue;
                const value = effects[key];
                if (state.hasOwnProperty(key)) {
                    state[key] = parseFloat((state[key] + value).toFixed(2));
                    if (['purpose', 'innovation', 'skill', 'morale'].includes(key)) { state[key] = Math.max(0, Math.min(100, state[key])); }
                    if (key === 'staffLocal') { state.staffLocal = Math.max(0, Math.min(100, state.staffLocal)); state.staffGlobal = 100 - state.staffLocal; }
                    if (key === 'reach') { state.reach = Math.max(1, state.reach); } // Minimum 1 market
                    if (key === 'marketStrength') { state.marketStrength = Math.max(-50, Math.min(50, state.marketStrength)); }
                    logChange(key, value, state[key]);
                }
            }
        }

        function checkTemplateUpgrade() {
            const currentIndex = templateStages.indexOf(state.templateStage);
            // Template upgrades at 75% instead of 100% - makes progression more achievable
            if (state.templateProgress >= 75 && currentIndex < templateStages.length - 1) {
                state.templateStage = templateStages[currentIndex + 1];
                state.templateProgress = state.templateProgress - 75; // Carry over excess progress
                logChange("Template", `Upgraded to ${state.templateStage}!`);
            } else if (state.templateProgress < 0) {
                state.templateProgress = Math.max(0, state.templateProgress);
            }
        }

        function logChange(key, value, newVal = null, visual = null) {
            const labels = { profitLoss: '📊 P/L', purpose: '🌍 Purpose', innovation: '💡 Innovation', reach: '📈 Markets', morale: '🙂 Morale', skill: '🎓 Skill', staffLocal: '🏠 Local Staff', templateProgress: '🛠️ Template Prog', Revenue: '💵 Revenue', Costs: '📉 Costs', costPressure: '💸 Operating Costs', marketStrength: '💰 Revenue Modifier' };
            if (typeof value === 'string') { state.monthlyChanges[key] = { label: key, text: value, visual: visual, isTextLog: true }; return; }
            const label = labels[key] || key;
            if (state.monthlyChanges[key]) { state.monthlyChanges[key].change += value; }
            else { state.monthlyChanges[key] = { label: label, change: value, visual: visual }; }
        }

        function formatMoney(value) { if (value === null || value === undefined) return '0'; return parseFloat(value).toFixed(1); }

        function updateDashboard() {
            // Calculate monthly financials
            let revenueMultiplier = 1.0;
            if (state.passiveBonuses.ops?.reachMult) revenueMultiplier *= state.passiveBonuses.ops.reachMult;
            if (state.passiveBonuses.marketing?.reachMult) revenueMultiplier *= state.passiveBonuses.marketing.reachMult;
            const templateRevenueMod = templateModifiers[state.templateStage]?.revenueMult || 0.25;
            // Market strength affects revenue: +10 strength = +10% revenue
            const marketStrengthMod = 1 + ((state.marketStrength || 0) / 100);
            // Scale bonus: moderate growth curve
            const scaleBonus = 1 + (state.reach * 0.03);
            // Maturity ramp-up: revenue grows as venture matures (caps at 100% after month 7)
            const maturityRamp = state.turn <= 0 ? 0 : Math.min(1.0, state.turn * 0.15);
            // Base £500K per market - premium B2B/enterprise value
            const monthlyRevenue = Math.round(state.reach * 300 * scaleBonus * templateRevenueMod * revenueMultiplier * marketStrengthMod * maturityRamp);
            
            // Revenue-based costs: 40% overhead for production, delivery, sales, support
            const revenueBasedCosts = Math.round(monthlyRevenue * 0.40);
            
            // Calculate monthly costs: base + per-market + revenue-based + investments + pressure
            const templateCostEfficiency = {
                'Prototype': 25,  // £25K per market
                'Basic': 20,      // £20K per market
                'Advanced': 15,   // £15K per market
                'Optimized': 10   // £10K per market
            };
            const perMarketCost = templateCostEfficiency[state.templateStage] || 25;
            const marketOperatingCosts = Math.round(state.reach * perMarketCost);
            
            let baseCost = state.baseMonthlyCost || 500; // £K per month
            let costMultiplier = 1.0;
            if (state.passiveBonuses.finance?.burnRateMult) costMultiplier *= state.passiveBonuses.finance.burnRateMult;
            if (state.passiveBonuses.hr?.costMult) costMultiplier *= state.passiveBonuses.hr.costMult;
            if (state.passiveBonuses.ops?.costMult) costMultiplier *= state.passiveBonuses.ops.costMult;
            if (state.passiveBonuses.marketing?.costMult) costMultiplier *= state.passiveBonuses.marketing.costMult;
            if (state.passiveBonuses.tech?.costMult) costMultiplier *= state.passiveBonuses.tech.costMult;
            
            const costPressure = state.costPressure || 0;
            const monthlyCosts = Math.round(baseCost * costMultiplier + marketOperatingCosts + revenueBasedCosts + state.totalMonthlyInvestment + costPressure);
            
            const netMonthly = monthlyRevenue - monthlyCosts;
            
            // Update display
            dom.dashboard.revenue.textContent = `£${monthlyRevenue}K`;
            dom.dashboard.costs.textContent = `£${monthlyCosts}K`;
            dom.dashboard.netFlow.textContent = `${netMonthly >= 0 ? '+' : ''}£${netMonthly}K`;
            dom.dashboard.netFlow.className = `metric-row-value ${netMonthly >= 0 ? 'high' : 'low'}`;
            
            // Show months remaining or profitability status
            const runwayEl = dom.dashboard.runway;
            const monthsRemaining = state.maxTurns - state.turn;
            if (netMonthly >= 0) {
                runwayEl.textContent = 'Profitable ✓';
                runwayEl.className = 'runway-value';
            } else if (monthsRemaining > 6) {
                runwayEl.textContent = `${monthsRemaining} months left`;
                runwayEl.className = 'runway-value';
            } else if (monthsRemaining > 3) {
                runwayEl.textContent = `${monthsRemaining} months left`;
                runwayEl.className = 'runway-value warning';
            } else {
                runwayEl.textContent = `${monthsRemaining} months left`;
                runwayEl.className = 'runway-value critical';
            }

            dom.dashboard.reach.textContent = `${Math.round(state.reach)}`;
            
            dom.dashboard.templateStage.textContent = state.templateStage;
            dom.dashboard.templateProgress.textContent = `${Math.round(state.templateProgress)}%`;
            dom.dashboard.templateProgressBar.style.width = `${state.templateProgress}%`;
            
            // Helper to get signal display based on value and change
            const getSignal = (value, initial) => {
                const change = value - (initial || 50);
                if (value >= 70) return { text: '↑↑ Strong', class: 'high' };
                if (value >= 55) return { text: '↑ Good', class: 'high' };
                if (value >= 45) return { text: '→ Stable', class: 'medium' };
                if (value >= 30) return { text: '↓ Weak', class: 'low' };
                return { text: '↓↓ Critical', class: 'low' };
            };
            
            // Update health metrics with signals
            const purposeSignal = getSignal(state.purpose, state.initialValues?.purpose);
            dom.dashboard.purpose.textContent = purposeSignal.text;
            dom.dashboard.purpose.className = `metric-row-value ${purposeSignal.class}`;
            
            const innovationSignal = getSignal(state.innovation, state.initialValues?.innovation);
            dom.dashboard.innovation.textContent = innovationSignal.text;
            dom.dashboard.innovation.className = `metric-row-value ${innovationSignal.class}`;
            
            const skillSignal = getSignal(state.skill, state.initialValues?.skill);
            dom.dashboard.skill.textContent = skillSignal.text;
            dom.dashboard.skill.className = `metric-row-value ${skillSignal.class}`;
            
            const moraleSignal = getSignal(state.morale, state.initialValues?.morale);
            dom.dashboard.morale.textContent = moraleSignal.text;
            dom.dashboard.morale.className = `metric-row-value ${moraleSignal.class}`;
            
            // Update venture badge and logo in header
            if (state.venture && ventures[state.venture]) {
                const badge = document.getElementById('venture-name-badge');
                if (badge) {
                    badge.textContent = ventures[state.venture].name;
                    badge.classList.add('visible');
                }
                const logoEl = document.getElementById('venture-logo-small');
                if (logoEl && ventureDetails[state.venture]) {
                    // Use miniIcon for top bar if available, otherwise fall back to icon
                    logoEl.innerHTML = ventureDetails[state.venture].miniIcon || ventureDetails[state.venture].icon;
                    logoEl.classList.add('visible');
                }
            }
            
            // Update turn counter
            document.getElementById('turn-counter').textContent = state.turn;
            
            // Update team bar
            updateTeamBar();
        }
        
        function updateTeamBar() {
            const teamBar = document.getElementById('team-bar');
            const teamRow = document.getElementById('leadership-team-row');
            if (!teamBar || !teamRow) return;
            
            if (Object.keys(state.leadershipTeam).length > 0) {
                teamBar.classList.add('visible');
                teamRow.innerHTML = '';
                
                const roleOrder = ['finance', 'hr', 'ops', 'marketing', 'tech'];
                const roleLabels = { finance: 'Finance', hr: 'HR', ops: 'Operations', marketing: 'Marketing', tech: 'Technology' };
                
                roleOrder.forEach(role => {
                    const candidateId = state.leadershipTeam[role];
                    if (candidateId && candidates[role]) {
                        const candidate = candidates[role].find(c => c.id === candidateId);
                        if (candidate) {
                            const cv = candidate.cv || {};
                            const member = document.createElement('div');
                            member.className = 'team-member';
                            member.innerHTML = `
                                <div class="team-avatar">
                                    ${generateAvatar(candidate.id, candidate.name)}
                                </div>
                                <div class="team-info">
                                    <div class="team-name">${candidate.name.split(' ')[0]}</div>
                                    <div class="team-role">${roleLabels[role]}</div>
                                </div>
                            `;
                            teamRow.appendChild(member);
                        }
                    }
                });
            }
        }

        function updateHQReview(title, narrative) {
            // Status updates now shown via inbox - no dedicated HQ review area
            console.log(`HQ Review: ${title} - ${narrative}`);
        }

        function showHQReview() {
            // This is now only called from processEventQueue for Month 12 final report
            // For normal flow, nextMonth() calls showTransitionReport/showQuarterlyReport directly
            const isQuarterly = [3, 6, 9, 12].includes(state.turn);
            if (isQuarterly) {
                showQuarterlyReport();
            } else {
                showTransitionReport();
            }
        }
        
        // Called after Neptune Reception mini-game completes
        function showQuarterlyReportAfterNeptune() {
            // Brief delay to let the Neptune overlay fade out
            setTimeout(() => {
                showQuarterlyReport();
            }, 300);
        }
        
        function showTransitionReport() {
            const modal = document.getElementById('transition-report-modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.classList.remove('quarterly-report');
            
            // Hide quarterly-specific elements
            document.getElementById('director-message-section').style.display = 'none';
            document.getElementById('quarterly-rating-section').style.display = 'none';
            
            // Use completed month from reportValues
            const completedMonth = state.reportValues?.completedMonth || state.turn;
            
            // Set header
            document.getElementById('report-title').textContent = `Month ${completedMonth} Report`;
            document.getElementById('report-subtitle').textContent = 'Monthly Performance Summary';
            document.getElementById('report-header').style.background = 'linear-gradient(135deg, var(--color-primary), var(--color-primary-dark))';
            
            // Populate changes
            populateReportChanges();
            
            // Populate financials
            populateReportFinancials();
            
            // Progress bar - allow exceeding target
            const currentReach = state.reportValues?.reach || state.reach;
            const progressPct = (currentReach / state.targetReach) * 100;
            document.getElementById('report-progress-fill').style.width = `${Math.min(100, progressPct)}%`;
            document.getElementById('report-progress-current').textContent = `${Math.round(currentReach)} markets`;
            if (progressPct >= 100) {
                document.getElementById('report-progress-target').textContent = `🎉 Target exceeded!`;
                document.getElementById('report-progress-fill').style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else {
                document.getElementById('report-progress-target').textContent = `Goal: ${state.targetReach} markets`;
                document.getElementById('report-progress-fill').style.background = '';
            }
            
            // Next month button
            const btn = modal.querySelector('.report-continue-btn');
            btn.innerHTML = `Continue to Month ${completedMonth + 1} →`;
            btn.style.background = 'linear-gradient(135deg, var(--color-primary), var(--color-primary-dark))';
            
            modal.classList.add('visible');
        }
        
        function showQuarterlyReport() {
            playSound('quarterEnd');
            const modal = document.getElementById('transition-report-modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.classList.add('quarterly-report');
            
            // Show quarterly-specific elements
            document.getElementById('director-message-section').style.display = 'block';
            document.getElementById('quarterly-rating-section').style.display = 'flex';
            
            // Use completed month from reportValues
            const completedMonth = state.reportValues?.completedMonth || state.turn;
            const quarter = Math.ceil(completedMonth / 3);
            
            // Set header
            document.getElementById('report-title').textContent = `Q${quarter} Review`;
            document.getElementById('report-subtitle').textContent = `Quarterly Performance Assessment — Month ${completedMonth}`;
            document.getElementById('report-header').style.background = 'linear-gradient(135deg, #0d7377, #14919b)';
            
            // Generate director message and rating
            const assessment = generateQuarterlyAssessment();
            document.getElementById('director-message-text').innerHTML = assessment.message;
            document.getElementById('rating-stars').textContent = assessment.stars;
            document.getElementById('rating-text').textContent = assessment.rating;
            
            // Populate changes
            populateReportChanges();
            
            // Populate financials
            populateReportFinancials();
            
            // Progress bar - allow exceeding target
            const currentReach = state.reportValues?.reach || state.reach;
            const progressPct = (currentReach / state.targetReach) * 100;
            document.getElementById('report-progress-fill').style.width = `${Math.min(100, progressPct)}%`;
            document.getElementById('report-progress-current').textContent = `${Math.round(currentReach)} markets`;
            if (progressPct >= 100) {
                document.getElementById('report-progress-target').textContent = `🎉 Target exceeded!`;
                document.getElementById('report-progress-fill').style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else {
                document.getElementById('report-progress-target').textContent = `Goal: ${state.targetReach} markets`;
                document.getElementById('report-progress-fill').style.background = '';
            }
            
            // Next month button
            const btn = modal.querySelector('.report-continue-btn');
            btn.style.background = 'linear-gradient(135deg, #0d7377, #14919b)';
            if (completedMonth >= state.maxTurns) {
                btn.innerHTML = 'View Final Results →';
            } else {
                btn.innerHTML = `Continue to Month ${completedMonth + 1} →`;
            }
            
            modal.classList.add('visible');
        }
        
        function populateReportChanges() {
            const grid = document.getElementById('report-changes-grid');
            grid.innerHTML = '';
            
            // Use reportValues (end of completed month) vs previousValues (start of that month)
            const current = state.reportValues || {
                reach: state.reach,
                templateProgress: state.templateProgress,
                purpose: state.purpose,
                innovation: state.innovation,
                morale: state.morale,
                skill: state.skill,
                marketStrength: state.marketStrength
            };
            
            const metrics = [
                { key: 'reach', label: '📈 Markets', current: current.reach, prev: state.previousValues.reach },
                { key: 'templateProgress', label: '🛠️ Template', current: current.templateProgress, prev: state.previousValues.templateProgress, suffix: '%' },
                { key: 'purpose', label: '🌍 Purpose', current: current.purpose, prev: state.previousValues.purpose },
                { key: 'innovation', label: '💡 Innovation', current: current.innovation, prev: state.previousValues.innovation },
                { key: 'morale', label: '🙂 Morale', current: current.morale, prev: state.previousValues.morale },
                { key: 'skill', label: '🎓 Skill', current: current.skill, prev: state.previousValues.skill }
            ];
            
            metrics.forEach(m => {
                const change = Math.round(m.current - m.prev);
                const suffix = m.suffix || '';
                let valueClass = 'neutral';
                let valueText = '—';
                
                if (change > 0) {
                    valueClass = 'positive';
                    valueText = `+${change}${suffix}`;
                } else if (change < 0) {
                    valueClass = 'negative';
                    valueText = `${change}${suffix}`;
                }
                
                const item = document.createElement('div');
                item.className = 'report-change-item';
                item.innerHTML = `
                    <span class="change-label">${m.label}</span>
                    <span class="change-value ${valueClass}">${valueText}</span>
                `;
                grid.appendChild(item);
            });
        }
        
        function populateReportFinancials() {
            // Calculate financials based on current state (which reflects completed month)
            const currentReach = state.reportValues?.reach || state.reach;
            
            let revenueMultiplier = 1.0;
            if (state.passiveBonuses.ops?.reachMult) revenueMultiplier *= state.passiveBonuses.ops.reachMult;
            if (state.passiveBonuses.marketing?.reachMult) revenueMultiplier *= state.passiveBonuses.marketing.reachMult;
            const templateRevenueMod = templateModifiers[state.templateStage]?.revenueMult || 0.25;
            // Market strength affects revenue
            const marketStrengthMod = 1 + ((state.marketStrength || 0) / 100);
            // Scale bonus: moderate growth curve
            const scaleBonus = 1 + (currentReach * 0.03);
            // Maturity ramp based on completed month
            const completedMonth = state.reportValues?.completedMonth || state.turn;
            const maturityRamp = completedMonth <= 0 ? 0 : Math.min(1.0, completedMonth * 0.15);
            const monthlyRevenue = Math.round(currentReach * 300 * scaleBonus * templateRevenueMod * revenueMultiplier * marketStrengthMod * maturityRamp);
            
            // Revenue-based costs: 40% overhead
            const revenueBasedCosts = Math.round(monthlyRevenue * 0.40);
            
            // Calculate costs using dynamic model
            const templateCostEfficiency = {
                'Prototype': 25, 'Basic': 20, 'Advanced': 15, 'Optimized': 10
            };
            const perMarketCost = templateCostEfficiency[state.templateStage] || 25;
            const marketOperatingCosts = Math.round(currentReach * perMarketCost);
            
            let costMultiplier = 1.0;
            if (state.passiveBonuses.finance?.burnRateMult) costMultiplier *= state.passiveBonuses.finance.burnRateMult;
            Object.keys(state.passiveBonuses).forEach(k => { 
                if (state.passiveBonuses[k]?.costMult) costMultiplier *= state.passiveBonuses[k].costMult; 
            });
            const baseCosts = Math.round((state.baseMonthlyCost || 500) * costMultiplier);
            const costPressure = state.costPressure || 0;
            const monthlyCosts = Math.round(baseCosts + marketOperatingCosts + revenueBasedCosts + state.totalMonthlyInvestment + costPressure);
            const netMonthly = monthlyRevenue - monthlyCosts;
            
            document.getElementById('report-revenue').textContent = `£${monthlyRevenue}K`;
            document.getElementById('report-revenue').className = 'fin-value positive';
            
            document.getElementById('report-costs').textContent = `£${monthlyCosts}K`;
            document.getElementById('report-costs').className = 'fin-value negative';
            
            document.getElementById('report-net').textContent = `${netMonthly >= 0 ? '+' : ''}£${netMonthly}K`;
            document.getElementById('report-net').className = `fin-value ${netMonthly >= 0 ? 'positive' : 'negative'}`;
        }
        
        function generateQuarterlyAssessment() {
            const completedMonth = state.reportValues?.completedMonth || state.turn;
            const quarter = Math.ceil(completedMonth / 3);
            const expectedReach = Math.ceil(state.targetReach * (completedMonth / state.maxTurns));
            const currentReach = state.reportValues?.reach || state.reach;
            const reachRatio = currentReach / expectedReach;
            const profitTrend = state.reportValues?.profitLoss || state.profitLoss;
            const currentMorale = state.reportValues?.morale || state.morale;
            const currentTemplateProgress = state.reportValues?.templateProgress || state.templateProgress;
            const currentMarketStrength = state.reportValues?.marketStrength || state.marketStrength || 0;
            
            // Calculate overall performance score
            let score = 0;
            if (reachRatio >= 1.0) score += 2;
            else if (reachRatio >= 0.7) score += 1;
            else if (reachRatio < 0.5) score -= 1;
            
            if (profitTrend > 0) score += 2;
            else if (profitTrend > -2) score += 1;
            else if (profitTrend < -5) score -= 1;
            
            if (currentMorale >= 60) score += 1;
            if (currentMorale < 30) score -= 1;
            if (currentTemplateProgress >= completedMonth * 6) score += 1;
            
            // Market strength scoring
            if (currentMarketStrength >= 15) score += 1;
            else if (currentMarketStrength <= -15) score -= 1;
            
            // Generate rating
            let stars, rating;
            if (score >= 5) {
                stars = '⭐⭐⭐⭐⭐';
                rating = 'Exceptional';
            } else if (score >= 3) {
                stars = '⭐⭐⭐⭐';
                rating = 'Strong Performance';
            } else if (score >= 1) {
                stars = '⭐⭐⭐';
                rating = 'On Track';
            } else if (score >= -1) {
                stars = '⭐⭐';
                rating = 'Needs Attention';
            } else {
                stars = '⭐';
                rating = 'Underperforming';
            }
            
            // Generate director message
            const ventureName = ventures[state.venture]?.name || 'your venture';
            let message = '';
            
            // Opening based on performance
            const openings = {
                exceptional: [
                    `<p>Outstanding work this quarter. ${ventureName} is exceeding our expectations, and the board has taken notice.</p>`,
                    `<p>I'm genuinely impressed with what you've accomplished. This is exactly the kind of leadership Neptune needs.</p>`
                ],
                strong: [
                    `<p>Solid progress this quarter. You're building something real here, and it shows in the numbers.</p>`,
                    `<p>The board is pleased with ${ventureName}'s trajectory. Keep this momentum going.</p>`
                ],
                onTrack: [
                    `<p>You're making steady progress. Not every quarter needs to be a breakthrough — consistency matters too.</p>`,
                    `<p>Things are moving in the right direction. Stay focused on execution.</p>`
                ],
                needsAttention: [
                    `<p>I'll be direct — this quarter's results have raised some concerns at the board level.</p>`,
                    `<p>We need to see improvement. The next quarter is critical for demonstrating you can turn this around.</p>`
                ],
                underperforming: [
                    `<p>This is a difficult conversation to have. The numbers this quarter are concerning, and we need to see a clear plan for recovery.</p>`,
                    `<p>I've had to defend ${ventureName} in several board discussions this quarter. I need you to give me something to work with.</p>`
                ]
            };
            
            let category;
            if (score >= 5) category = 'exceptional';
            else if (score >= 3) category = 'strong';
            else if (score >= 1) category = 'onTrack';
            else if (score >= -1) category = 'needsAttention';
            else category = 'underperforming';
            
            message = openings[category][Math.floor(Math.random() * openings[category].length)];
            
            // Add specific feedback
            if (reachRatio >= 1.0) {
                message += `<p>Market expansion is ahead of schedule — that's exactly what we need to see.</p>`;
            } else if (reachRatio < 0.5) {
                message += `<p>I'm concerned about the pace of market expansion. We set those targets for a reason.</p>`;
            }
            
            if (currentMorale < 40) {
                message += `<p>I'm hearing rumblings about team morale. Your people are your most important asset — don't lose sight of that.</p>`;
            } else if (currentMorale >= 70) {
                message += `<p>The team seems energised. That kind of culture is hard to build and easy to lose.</p>`;
            }
            
            // Market strength feedback
            if (currentMarketStrength >= 20) {
                message += `<p>Your market position is exceptionally strong. Customers trust you, and that's translating directly into revenue.</p>`;
            } else if (currentMarketStrength >= 10) {
                message += `<p>You're building real market momentum. Keep focusing on quality and consistency.</p>`;
            } else if (currentMarketStrength <= -20) {
                message += `<p>I'm concerned about your market position. Cutting corners is catching up with you — customers notice these things.</p>`;
            } else if (currentMarketStrength <= -10) {
                message += `<p>Your market standing has weakened. We need to see more focus on quality and customer experience.</p>`;
            }
            
            // Closing based on quarter
            if (quarter === 1) {
                message += `<p>Three months down, nine to go. Use this foundation wisely.</p>`;
            } else if (quarter === 2) {
                message += `<p>We're at the halfway point. The decisions you make now will define whether this venture succeeds or fails.</p>`;
            } else if (quarter === 3) {
                message += `<p>Final stretch. Everything you've built is leading to this. Make it count.</p>`;
            } else if (quarter === 4) {
                message += `<p>This is it. Your year of leadership concludes. I'll reserve final judgment for the board review.</p>`;
            }
            
            return { message, stars, rating };
        }
        
        function closeTransitionReport() {
            const modal = document.getElementById('transition-report-modal');
            modal.classList.remove('visible');
            
            // Check if this was the final report (Month 12)
            const completedMonth = state.reportValues?.completedMonth || state.turn;
            if (completedMonth >= state.maxTurns) {
                // Check for billion-dollar brand conditions before game over
                if (checkBillionDollarEligibility()) {
                    showBillionDollarEvent();
                    return;
                }
                gameOver(true);
                return;
            }
            
            // Check if this was a quarterly report (months 3, 6, 9) - show reallocation
            if (completedMonth === 3 || completedMonth === 6 || completedMonth === 9) {
                showQuarterlyReallocation(completedMonth);
                return;
            }
            
            // Clear report values and continue to next month
            state.reportValues = null;
            continueToNextMonth();
        }
        
        // Check if player qualifies for the rare "billion-dollar brand" event
        function checkBillionDollarEligibility() {
            const { reach, targetReach, profitLoss, morale, purpose, innovation, skill, templateStage } = state;
            
            // Strict conditions - should be met by ~12-15% of completing players
            const conditions = [
                templateStage === 'Optimized',           // Must have perfected the template
                reach >= targetReach,                     // Must have hit market target
                profitLoss >= 0,                          // Must be profitable
                morale >= 55,                             // Team must be reasonably happy
                purpose >= 55,                            // Must maintain purpose
                innovation >= 50                          // Must maintain innovation
            ];
            
            if (!conditions.every(c => c)) return false;
            
            // Even if conditions are met, only ~25% chance of the opportunity arising
            // Combined with ~12-15% meeting conditions = ~3% overall
            return Math.random() < 0.25;
        }
        
        // Show the special acquisition event for billion-dollar eligible players
        function showBillionDollarEvent() {
            state.billionDollarTriggered = true;
            
            const ventureName = ventures[state.venture]?.name || 'your venture';
            
            // Create special event
            const billionDollarEvent = {
                id: 'billion-dollar-moment',
                dept: 'Corporate',
                icon: '💎',
                title: 'A Career-Defining Moment',
                text: `Extraordinary news. ${ventureName} has attracted attention at the highest levels. External investors are valuing the business at over £1 billion — a testament to the scalable, repeatable model you've built.\n\nThe board is offering you three paths forward. Each represents a different future for both you and the venture.`,
                isBillionDollar: true,
                options: [
                    { 
                        text: 'Accept promotion to Neptune Group Executive — lead corporate ventures globally',
                        billionPath: 'promotion',
                        effects: {}
                    },
                    { 
                        text: 'Leave Neptune to start my own venture — take what I\'ve learned and build something new',
                        billionPath: 'founder',
                        effects: {}
                    },
                    {
                        text: 'Lead the spin-out — take the business independent with me as CEO',
                        billionPath: 'spinout',
                        effects: {}
                    }
                ]
            };
            
            // Show as special event modal
            addEmailToInbox(billionDollarEvent);
            
            // Mark that we need to handle this specially
            state.pendingBillionDollarDecision = true;
        }
        
        function showQuarterlyReallocation(completedMonth) {
            const quarter = Math.ceil(completedMonth / 3);
            const quarterNames = { 1: 'Q1', 2: 'Q2', 3: 'Q3' };
            
            // Update modal title
            document.getElementById('reallocation-title').textContent = `📊 ${quarterNames[quarter]} Resource Review`;
            document.getElementById('reallocation-intro').textContent = `You've completed ${quarterNames[quarter]}. Review your resource allocations for the months ahead. Adjust investments based on what you've learned about your venture's needs.`;
            
            // Show the reallocation modal
            showReallocationModal();
        }

        function showGlobalShock(title) {
            dom.shockBar.textContent = `⚡ GLOBAL SHOCK: ${title} ⚡`;
            dom.shockBar.classList.add('visible');
            setTimeout(() => { dom.shockBar.classList.remove('visible'); }, 5000);
        }

        function generateLeadershipReport() {
            const { reach, purpose, innovation, templateStage, morale, skill, profitLoss, targetReach } = state;
            const normalizedReach = reach / targetReach;
            const templateScore = templateStages.indexOf(templateStage);
            let revenueMultiplier = 1.0;
            if (state.passiveBonuses.ops?.reachMult) revenueMultiplier *= state.passiveBonuses.ops.reachMult;
            if (state.passiveBonuses.marketing?.reachMult) revenueMultiplier *= state.passiveBonuses.marketing.reachMult;
            const templateRevenueMod = templateModifiers[state.templateStage].revenueMult;
            const marketStrengthMod = 1 + ((state.marketStrength || 0) / 100);
            // Scale bonus: moderate growth curve
            const scaleBonus = 1 + (state.reach * 0.03);
            // At month 12, maturity is 100%
            const maturityRamp = 1.0;
            const finalRevenue = Math.round(state.reach * 300 * scaleBonus * templateRevenueMod * revenueMultiplier * marketStrengthMod * maturityRamp);
            
            // Full cost calculation including revenue-based costs
            const revenueBasedCosts = Math.round(finalRevenue * 0.40);
            const templateCostEfficiency = { 'Prototype': 25, 'Basic': 20, 'Advanced': 15, 'Optimized': 10 };
            const perMarketCost = templateCostEfficiency[state.templateStage] || 25;
            const marketOperatingCosts = Math.round(state.reach * perMarketCost);
            let costMultiplier = 1.0;
            if (state.passiveBonuses.finance?.burnRateMult) costMultiplier *= state.passiveBonuses.finance.burnRateMult;
            Object.keys(state.passiveBonuses).forEach(k => { if (state.passiveBonuses[k]?.costMult) costMultiplier *= state.passiveBonuses[k].costMult; });
            const baseCosts = Math.round((state.baseMonthlyCost || 500) * costMultiplier);
            const finalCosts = Math.round(baseCosts + marketOperatingCosts + revenueBasedCosts + state.totalMonthlyInvestment);
            const isProfitableMonthly = finalRevenue > finalCosts;

            if (purpose > 75 && morale > 65 && normalizedReach > 0.5) return { title: "Purpose-Driven Leader 🌍", desc: "Prioritized purpose & people while achieving respectable growth." };
            if (normalizedReach > 1.0 && isProfitableMonthly && profitLoss > 0) return { title: "Hard-Charging Capitalist 💰", desc: "Focused relentlessly on expansion and profit." };
            if (templateScore >= 2 && skill > 65 && normalizedReach > 0.6) return { title: "Architect Innovator ⭐", desc: "Built a robust template and skilled team." };
            if (innovation > 75 && normalizedReach > 0.7) return { title: "Pragmatic Visionary 💡", desc: "Balanced innovation with practical market growth." };
            if (morale > 80 && normalizedReach > 0.4) return { title: "Empathic Integrator 🧑‍🤝‍🧑", desc: "Built a happy, loyal team." };
            if (normalizedReach < 0.4 && profitLoss > -(state.baseMonthlyCost * 6 / 1000)) return { title: "Cautious Administrator 🛡️", desc: "Preserved capital above all." };
            if (isProfitableMonthly && normalizedReach > 0.8) return { title: "Effective Executor ✅", desc: "Delivered solid results across the board." };
            return { title: "Balanced Manager ⚖️", desc: "Navigated complexities steadily." };
        }

        
        function gameOver(completed, title = "Your Leadership Journey", reason = "") {
            const ventureName = ventures[state.venture]?.name || 'your venture';
            
            // Determine performance tier
            const tier = calculatePerformanceTier(completed);
            
            // Play appropriate sound based on tier
            if (tier.level >= 4) {
                playSound('victory');
                setTimeout(() => playSound('quarterEnd'), 800);
            } else if (tier.level >= 2) {
                playSound('victory');
            } else {
                playSound('defeat');
            }
            stopBackgroundMusic();
            
            // Set header styling based on tier
            const header = document.getElementById('game-over-header');
            header.className = 'game-over-header'; // Reset classes
            header.classList.add(tier.cssClass);
            
            // Set title based on tier
            document.getElementById('game-over-title').textContent = tier.title;
            document.getElementById('game-over-subtitle').textContent = `12 Months Leading ${ventureName}`;
            document.getElementById('game-over-reason').textContent = reason;
            document.getElementById('game-over-reason').style.display = reason ? 'block' : 'none';
            
            // Show career outcome badge
            const outcomeEl = document.getElementById('career-outcome');
            document.getElementById('outcome-icon').textContent = tier.outcomeIcon;
            document.getElementById('outcome-text').textContent = tier.outcomeText;
            outcomeEl.style.display = 'inline-block';
            
            // Show next tier teaser for non-legend tiers
            const teaserEl = document.getElementById('next-tier-teaser');
            if (tier.level < 5 && tier.nextTier) {
                document.getElementById('next-tier-icon').textContent = tier.nextTier.icon;
                document.getElementById('next-tier-title').textContent = `Unlock: ${tier.nextTier.name}`;
                document.getElementById('next-tier-hint').textContent = tier.nextTier.hint;
                teaserEl.style.display = 'block';
            } else {
                teaserEl.style.display = 'none';
            }
            
            // Trigger confetti for top tiers
            if (tier.level >= 4) {
                setTimeout(() => triggerConfetti(tier.level === 5), 300);
            }
            
            // Generate reflection message
            generateReflectionMessage(completed, tier);
            
            // Populate performance summary
            generatePerformanceSummary();
            
            // Generate strengths and growth areas
            generateStrengthsAndGrowth();
            
            // Generate key learnings
            generateKeyLearnings();
            
            // Generate try again suggestions
            generateTryAgainSuggestions();
            
            dom.modals.gameOver.classList.add('visible');
        }
        
        function calculatePerformanceTier(completed) {
            const { reach, targetReach, profitLoss, morale, purpose, innovation, skill, templateStage, hastyDecisions } = state;
            const reachPct = (reach / targetReach) * 100;
            const templateIndex = templateStages.indexOf(templateStage);
            
            // Penalize excessive hasty decisions
            const hastyPenalty = hastyDecisions > 15 ? 20 : (hastyDecisions > 10 ? 10 : (hastyDecisions > 5 ? 5 : 0));
            const effectiveReachPct = reachPct - hastyPenalty;
            
            // Tier 5: Billion Dollar Legend (already achieved via special event)
            if (state.billionDollarSuccess) {
                return {
                    level: 5,
                    cssClass: 'tier-legend',
                    title: '💎 Billion Dollar Legend',
                    outcomeIcon: '👑',
                    outcomeText: state.billionDollarPath === 'promotion' ? 'Promoted to Group Executive' :
                                 state.billionDollarPath === 'founder' ? 'Departed to Found Own Startup' :
                                 'CEO of Spun-Out Company',
                    nextTier: null
                };
            }
            
            // Tier 4: Corporate Champion - Exceeded all targets with excellence
            if (completed && effectiveReachPct >= 100 && profitLoss >= 0.2 && morale >= 55 && skill >= 45 && templateIndex >= 3) {
                return {
                    level: 4,
                    cssClass: 'tier-champion',
                    title: '🏆 Corporate Champion',
                    outcomeIcon: '📈',
                    outcomeText: 'Promoted to VP of Innovation',
                    nextTier: {
                        icon: '💎',
                        name: 'Billion Dollar Legend',
                        hint: 'Reach Optimized template with all metrics strong to trigger the billion-dollar opportunity!'
                    }
                };
            }
            
            // Tier 3: Rising Star - Hit targets with good performance
            if (completed && effectiveReachPct >= 100 && profitLoss >= -0.2 && morale >= 40) {
                return {
                    level: 3,
                    cssClass: 'tier-star',
                    title: '⭐ Rising Star',
                    outcomeIcon: '🎯',
                    outcomeText: 'Given Another Venture to Lead',
                    nextTier: {
                        icon: '🏆',
                        name: 'Corporate Champion',
                        hint: 'Hit targets with strong profits (£200K+), high morale (55+), good skill (45+), and Optimized template!'
                    }
                };
            }
            
            // Tier 2: Solid Performer - Completed with reasonable progress
            // Requires 65% reach, morale above crisis level, not excessive hasty decisions
            if (completed && effectiveReachPct >= 65 && morale >= 30 && hastyDecisions <= 20) {
                return {
                    level: 2,
                    cssClass: 'tier-solid',
                    title: '✓ Solid Performer',
                    outcomeIcon: '🤝',
                    outcomeText: 'Retained with Extended Runway',
                    nextTier: {
                        icon: '⭐',
                        name: 'Rising Star',
                        hint: 'Hit your full market target (100%) while keeping finances stable and team morale up!'
                    }
                };
            }
            
            // Tier 1: Learning Journey - Didn't complete or low performance
            return {
                level: 1,
                cssClass: 'tier-learning',
                title: completed ? '📚 Learning Journey' : '📚 Early Exit',
                outcomeIcon: '🔄',
                outcomeText: completed ? 'Reassigned to Corporate Role' : 'Venture Wound Down',
                nextTier: {
                    icon: '✓',
                    name: 'Solid Performer',
                    hint: 'Complete 12 months, reach 65% of target, keep morale above 30, and take time on decisions!'
                }
            };
        }
        
        function triggerConfetti(isLegend) {
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            
            const colors = isLegend 
                ? ['#fbbf24', '#f59e0b', '#fcd34d', '#fef3c7', '#ffffff', '#d97706']
                : ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ffffff', '#7c3aed'];
            
            const count = isLegend ? 60 : 40;
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                
                // Random shapes
                if (Math.random() > 0.5) {
                    confetti.style.borderRadius = '50%';
                } else {
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                }
                
                container.appendChild(confetti);
            }
            
            // Clean up after animation
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function generateReflectionMessage(completed, tier) {
            const { reach, targetReach, profitLoss, morale, purpose, innovation, skill, templateStage } = state;
            const reachPct = (reach / targetReach) * 100;
            const ventureName = ventures[state.venture]?.name || 'your venture';
            
            let message = '';
            const reflectionEl = document.getElementById('reflection-message');
            
            // Special billion-dollar brand messages based on chosen path
            if (state.billionDollarSuccess) {
                if (state.billionDollarPath === 'promotion') {
                    message = `<p><strong>💎 You've built a billion-dollar brand — and earned a seat at the top table.</strong></p>
                    <p>Neptune's board has appointed you Group Executive for Corporate Ventures, overseeing innovation across the entire organisation. Your success with ${ventureName} proved that disciplined, patient corporate entrepreneurship can produce extraordinary results.</p>
                    <p>You'll now apply those lessons at scale — identifying opportunities, building templates, and developing the next generation of venture leaders. The skills you've honed here will shape Neptune's future.</p>
                    <p><strong>From venture director to corporate executive. This is how careers are made.</strong></p>`;
                } else if (state.billionDollarPath === 'founder') {
                    message = `<p><strong>💎 You've built a billion-dollar brand — now you're ready to build your own.</strong></p>
                    <p>The lessons from ${ventureName} can't be taught in any business school: when to resist scaling, how to build a repeatable template, when to seize the moment. You've lived it.</p>
                    <p>Armed with this experience, a network of believers, and the confidence that comes from genuine success, you're stepping out to create something entirely your own. The next billion-dollar brand won't have Neptune's name on it — it'll have yours.</p>
                    <p><strong>From corporate venture to independent founder. The best founders know how to build things that scale.</strong></p>`;
                } else if (state.billionDollarPath === 'spinout') {
                    message = `<p><strong>💎 You've built a billion-dollar brand — and now it's truly yours to lead.</strong></p>
                    <p>${ventureName} is spinning out as an independent company, and you're taking the helm as CEO. The investors who valued this business at over £1 billion did so because of what you built: a mature, repeatable template that can scale globally.</p>
                    <p>You'll have the resources, the team, and the proven model. What you do next is limited only by your ambition. This is the opportunity most corporate entrepreneurs dream about but never achieve.</p>
                    <p><strong>From venture director to CEO. You've earned this.</strong></p>`;
                }
                reflectionEl.innerHTML = message;
                reflectionEl.classList.add('tier-legend-message');
                return;
            }
            
            // Remove special classes
            reflectionEl.className = 'reflection-message';
            
            // Tier-specific opening messages
            if (tier.level === 4) {
                // Corporate Champion
                message = `<p><strong>🏆 Exceptional leadership!</strong> You've joined an elite group — corporate venture leaders who hit every target while building something sustainable.</p>
                <p>Neptune's executive team has taken notice. ${ventureName} didn't just meet expectations — it exceeded them. Strong profits, a motivated team, and a mature operational template. This is textbook corporate entrepreneurship.</p>
                <p>Your promotion to VP of Innovation means you'll now oversee Neptune's entire venture portfolio. The skills you've demonstrated — patience, strategic resource allocation, stakeholder management — are exactly what's needed at the next level.</p>
                <p><strong>But there's still one summit left to climb...</strong> The billion-dollar brand remains the ultimate achievement. Can you do it again, even better?</p>`;
            } else if (tier.level === 3) {
                // Rising Star
                message = `<p><strong>⭐ Target achieved!</strong> You've done what most corporate venture leaders only dream about — you hit your market target and kept the venture viable.</p>
                <p>${ventureName} is now a proven success story within Neptune. The executive team sees you as someone who delivers results, and they want to see what you can do next.</p>
                <p>You've been given another venture to lead — a bigger challenge with higher stakes. The lessons you've learned here will serve you well.</p>
                <p><strong>Next time, aim higher.</strong> Strong profits and a systematic template could earn you the Corporate Champion title — and maybe even a shot at the billion-dollar prize.</p>`;
            } else if (tier.level === 2) {
                // Solid Performer
                message = `<p><strong>✓ You survived.</strong> In corporate ventures, that's no small achievement. Many ventures get shut down before they ever reach this point.</p>
                <p>${ventureName} showed promise, and Neptune is willing to give you more time. You've been granted an extended runway to prove the concept can scale further.</p>
                <p>You learned important lessons about balancing growth with sustainability, managing stakeholders, and building operational templates. These are skills that improve with practice.</p>
                <p><strong>The target is still there.</strong> Push harder for market reach next time, and you could become a Rising Star.</p>`;
            } else if (completed) {
                // Learning Journey (completed but low performance)
                message = `<p><strong>📚 A year of learning.</strong> Corporate entrepreneurship is genuinely difficult — you're building something new while navigating existing systems, competing priorities, and limited resources.</p>
                <p>Neptune has decided to reassign you to a corporate role, but that's not the end of your entrepreneurial journey. Many successful venture leaders had early setbacks before finding their stride.</p>
                <p>The insights you've gained about scaling, templates, and stakeholder management will serve you well wherever you go next.</p>
                <p><strong>Try again with a different approach.</strong> Focus on building reach early and keeping your executive sponsors happy.</p>`;
            } else {
                // Early Exit
                message = `<p><strong>📚 Every setback teaches something.</strong> The best entrepreneurs and corporate leaders have stories of ventures that didn't work out. What matters is what you take away.</p>
                <p>${ventureName} was wound down before completing its 12-month trial, but the experience wasn't wasted. You've seen firsthand how corporate ventures live or die by their metrics and stakeholder relationships.</p>
                <p><strong>The venture game rewards persistence.</strong> Try again — pay close attention to your executive support and cash position in the early months.</p>`;
            }
            
            // Add context about their specific journey for lower tiers
            if (tier.level <= 3) {
                if (morale >= 70) {
                    message += `<p>Your team stayed engaged and motivated throughout — that's a leadership skill that transfers to any context.</p>`;
                }
                if (templateStages.indexOf(templateStage) >= 2) {
                    message += `<p>You developed a sophisticated operational template — the kind of systematic approach that separates scalable ventures from one-off successes.</p>`;
                }
            }
            
            reflectionEl.innerHTML = message;
        }
        
        function generatePerformanceSummary() {
            const { reach, targetReach, profitLoss, morale, skill, templateStage } = state;
            const container = document.getElementById('performance-summary');
            const reachPct = reach / targetReach;
            
            const stats = [
                { 
                    icon: '📈', 
                    value: reachPct >= 1 ? `${Math.round(reach)} 🎉` : `${Math.round(reach)}`, 
                    label: 'Markets', 
                    positive: reach >= targetReach * 0.7 
                },
                { 
                    icon: '💰', 
                    value: `${profitLoss >= 0 ? '+' : ''}£${Math.round(profitLoss * 1000)}K`, 
                    label: 'Final P/L', 
                    positive: profitLoss >= 0 
                },
                { 
                    icon: '🙂', 
                    value: `${Math.round(morale)}%`, 
                    label: 'Team Morale', 
                    positive: morale >= 50 
                },
                { 
                    icon: '⭐', 
                    value: templateStage, 
                    label: 'Template', 
                    positive: templateStages.indexOf(templateStage) >= 1 
                },
                { 
                    icon: '⚡', 
                    value: state.hastyDecisions, 
                    label: 'Hasty Calls', 
                    positive: state.hastyDecisions <= 3 
                }
            ];
            
            container.innerHTML = stats.map(s => `
                <div class="perf-stat ${s.positive ? 'positive' : 'negative'}">
                    <div class="stat-icon">${s.icon}</div>
                    <div class="stat-value">${s.value}</div>
                    <div class="stat-label">${s.label}</div>
                </div>
            `).join('');
        }
        
        function generateStrengthsAndGrowth() {
            const { reach, targetReach, profitLoss, morale, purpose, innovation, skill, templateStage, templateProgress } = state;
            const initialValues = state.initialValues;
            
            const strengths = [];
            const growth = [];
            
            // Analyse each dimension
            const reachPct = reach / targetReach;
            if (reachPct >= 0.8) {
                strengths.push({ icon: '✓', text: '<strong>Market expansion</strong> — You pushed into new markets effectively, demonstrating commercial ambition.' });
            } else if (reachPct < 0.5) {
                growth.push({ icon: '→', text: '<strong>Market expansion</strong> — Consider prioritising reach-building decisions earlier. Markets drive revenue.' });
            }
            
            if (profitLoss >= 0) {
                strengths.push({ icon: '✓', text: '<strong>Financial management</strong> — You kept the venture solvent, balancing investment with returns.' });
            } else if (profitLoss < -3) {
                growth.push({ icon: '→', text: '<strong>Cost awareness</strong> — Every investment decision has a financial impact. Watch the burn rate.' });
            }
            
            const moraleChange = morale - initialValues.morale;
            if (morale >= 65) {
                strengths.push({ icon: '✓', text: '<strong>Team leadership</strong> — You kept your people motivated and engaged through challenges.' });
            } else if (morale < 40) {
                growth.push({ icon: '→', text: '<strong>People management</strong> — Teams need investment too. Morale affects everything else.' });
            }
            
            const purposeChange = purpose - initialValues.purpose;
            if (purposeChange >= 10) {
                strengths.push({ icon: '✓', text: '<strong>Mission clarity</strong> — You strengthened the venture\'s sense of purpose throughout.' });
            } else if (purposeChange < -10) {
                growth.push({ icon: '→', text: '<strong>Mission alignment</strong> — Purpose can drift under commercial pressure. Guard it carefully.' });
            }
            
            const innovChange = innovation - initialValues.innovation;
            if (innovChange >= 15) {
                strengths.push({ icon: '✓', text: '<strong>Innovation culture</strong> — You fostered creativity and new thinking in your team.' });
            } else if (innovChange < -10) {
                growth.push({ icon: '→', text: '<strong>Innovation balance</strong> — Corporate ventures need space to experiment, not just execute.' });
            }
            
            const templateScore = templateStages.indexOf(templateStage);
            if (templateScore >= 2) {
                strengths.push({ icon: '✓', text: '<strong>Operational excellence</strong> — Your template reached an advanced stage, ready for scale.' });
            } else if (templateScore === 0 && templateProgress < 30) {
                growth.push({ icon: '→', text: '<strong>Template development</strong> — Building scalable processes is essential for corporate ventures.' });
            }
            
            const skillChange = skill - initialValues.skill;
            if (skillChange >= 15) {
                strengths.push({ icon: '✓', text: '<strong>Capability building</strong> — You developed your team\'s skills significantly.' });
            } else if (skillChange < 0) {
                growth.push({ icon: '→', text: '<strong>Skill investment</strong> — Training and development pay dividends in venture performance.' });
            }
            
            // Check for hasty decision-making pattern
            if (state.hastyDecisions >= 10) {
                growth.unshift({ icon: '⚠️', text: '<strong>Decision pace</strong> — You made ' + state.hastyDecisions + ' hasty decisions. Taking time to read and reflect leads to better outcomes.' });
            } else if (state.hastyDecisions >= 5) {
                growth.push({ icon: '→', text: '<strong>Thoughtful leadership</strong> — Several decisions were made quickly. Slowing down helps you spot trade-offs.' });
            } else if (state.hastyDecisions === 0) {
                strengths.push({ icon: '✓', text: '<strong>Deliberate decision-making</strong> — You took time to consider each situation carefully.' });
            }
            
            // Ensure at least 2 items in each list
            if (strengths.length < 2) {
                if (state.turn >= 12) strengths.push({ icon: '✓', text: '<strong>Persistence</strong> — You completed the full 12-month journey, which takes real commitment.' });
                if (strengths.length < 2) strengths.push({ icon: '✓', text: '<strong>Decision-making</strong> — You faced difficult trade-offs and made calls under uncertainty.' });
            }
            
            if (growth.length < 2) {
                growth.push({ icon: '→', text: '<strong>Stakeholder management</strong> — Corporate ventures depend on maintaining support from above.' });
                if (growth.length < 2) growth.push({ icon: '→', text: '<strong>Timing decisions</strong> — When to invest vs. when to conserve resources is a key skill.' });
            }
            
            // Populate lists
            document.getElementById('strengths-list').innerHTML = strengths.slice(0, 4).map(s => 
                `<li><span class="feedback-icon">${s.icon}</span><span>${s.text}</span></li>`
            ).join('');
            
            document.getElementById('growth-list').innerHTML = growth.slice(0, 4).map(g => 
                `<li><span class="feedback-icon">${g.icon}</span><span>${g.text}</span></li>`
            ).join('');
        }
        
        function generateKeyLearnings() {
            const { reach, targetReach, profitLoss, morale, purpose, innovation, templateStage } = state;
            const container = document.getElementById('learnings-content');
            
            const learnings = [];
            
            // Pick 2-3 relevant learnings based on their experience
            const reachPct = reach / targetReach;
            
            if (reachPct < 0.6 && profitLoss < -2) {
                learnings.push({
                    icon: '⚖️',
                    text: '<strong>The Growth-Profit Tension:</strong> Corporate ventures face constant pressure to grow AND be profitable. The best leaders find creative ways to do both, often by sequencing investments carefully.'
                });
            }
            
            if (morale < 50 || (state.initialValues.morale - morale > 15)) {
                learnings.push({
                    icon: '👥',
                    text: '<strong>People Before Process:</strong> In corporate ventures, your team IS your competitive advantage. Technical excellence means nothing without motivated people to execute.'
                });
            }
            
            if (templateStages.indexOf(templateStage) <= 1) {
                learnings.push({
                    icon: '📋',
                    text: '<strong>Templates Enable Scale:</strong> The difference between a successful pilot and a scalable business is often a robust, documented template that others can follow.'
                });
            }
            
            if (purpose < state.initialValues.purpose) {
                learnings.push({
                    icon: '🧭',
                    text: '<strong>Purpose as Compass:</strong> When commercial pressures mount, purpose helps you make consistent decisions. Losing it can leave teams feeling directionless.'
                });
            }
            
            if (innovation > 70 && reachPct > 0.7) {
                learnings.push({
                    icon: '💡',
                    text: '<strong>Innovation Enables Growth:</strong> You demonstrated that investing in innovation isn\'t just R&D cost — it creates competitive advantages that drive market success.'
                });
            }
            
            // Hasty decision learning
            if (state.hastyDecisions >= 8) {
                learnings.unshift({
                    icon: '⏱️',
                    text: '<strong>Slow Down to Speed Up:</strong> Quick decisions feel efficient, but they often miss crucial details. Taking time to understand context leads to better outcomes and fewer mistakes to fix later.'
                });
            }
            
            // Default learnings if we don't have enough specific ones
            if (learnings.length < 2) {
                learnings.push({
                    icon: '🎯',
                    text: '<strong>Trade-offs Are Unavoidable:</strong> Every decision in a corporate venture involves trade-offs. The skill is in understanding which trade-offs align with your strategy.'
                });
            }
            
            if (learnings.length < 2) {
                learnings.push({
                    icon: '🔄',
                    text: '<strong>Adaptation is Essential:</strong> Corporate ventures operate in dynamic environments. The ability to adjust your approach based on new information is crucial.'
                });
            }
            
            container.innerHTML = learnings.slice(0, 3).map(l => `
                <div class="learning-item">
                    <span class="learning-icon">${l.icon}</span>
                    <span class="learning-text">${l.text}</span>
                </div>
            `).join('');
        }
        
        function generateTryAgainSuggestions() {
            const { reach, targetReach, profitLoss, morale, purpose, innovation, templateStage } = state;
            const container = document.getElementById('strategy-suggestions');
            const messageEl = document.getElementById('try-again-message');
            
            const suggestions = [];
            const reachPct = reach / targetReach;
            
            // Suggest strategies they didn't fully explore
            if (reachPct < 0.7) {
                suggestions.push('🚀 Try aggressive expansion');
            }
            if (profitLoss < 0) {
                suggestions.push('💰 Focus on profitability');
            }
            if (morale < 60) {
                suggestions.push('👥 Prioritise team morale');
            }
            if (templateStages.indexOf(templateStage) < 2) {
                suggestions.push('📋 Invest in template development');
            }
            if (innovation < 60) {
                suggestions.push('💡 Champion innovation');
            }
            if (purpose < 60) {
                suggestions.push('🌍 Lead with purpose');
            }
            
            // Pick 3-4 suggestions
            const selectedSuggestions = suggestions.slice(0, 4);
            
            if (selectedSuggestions.length === 0) {
                selectedSuggestions.push('🎯 Try a different venture', '⚡ Take more risks', '🛡️ Play it safe');
            }
            
            container.innerHTML = selectedSuggestions.map(s => 
                `<span class="strategy-tag">${s}</span>`
            ).join('');
            
            // Customise message
            if (reachPct >= 1.0 && profitLoss >= 0) {
                messageEl.textContent = 'You\'ve mastered this challenge! Try a different venture or a riskier strategy to test yourself further.';
            } else {
                messageEl.textContent = 'Every playthrough teaches something new about leading corporate ventures. Try a different approach next time.';
            }
        }

        // Get an event from a specific department (for month 1 intro events)
        function getEventFromDepartment(deptKey) {
            // Map short dept keys to eventBank keys
            const deptMap = {
                'finance': 'finance',
                'hr': 'hr',
                'ops': 'ops',
                'marketing': 'marketing',
                'tech': 'tech',
                'corporate_tensions': 'corporate_tensions',
                'external_relations': 'external_relations'
            };
            
            const bankKey = deptMap[deptKey] || deptKey; // Fallback to deptKey if not in map
            if (!eventBank[bankKey]) return null;
            
            // Get early-phase events from this department
            const deptEvents = eventBank[bankKey].filter(event => {
                if (state.usedEventIds.has(event.id)) return false;
                if (event.condition && typeof event.condition === 'function' && !event.condition()) return false;
                // Prefer early phase events for month 1
                if (event.phase === 'late') return false;
                return true;
            });
            
            if (deptEvents.length === 0) return null;
            
            const event = deptEvents[Math.floor(Math.random() * deptEvents.length)];
            state.usedEventIds.add(event.id);
            return event;
        }
        
        // Get a specified number of shortcut/cheese events for early game temptation
        function getShortcutEvents(count) {
            const shortcuts = eventBank.shortcuts || [];
            console.log('getShortcutEvents called, available shortcuts:', shortcuts.length);
            const available = shortcuts.filter(event => {
                if (state.usedEventIds.has(event.id)) return false;
                return true;
            });
            console.log('Available (unused) shortcuts:', available.length);
            
            // Shuffle available events
            const shuffled = available.sort(() => Math.random() - 0.5);
            
            // Take up to 'count' events
            const selected = shuffled.slice(0, count);
            console.log('Selected cheese events:', selected.map(e => e.title));
            
            // Mark as used
            selected.forEach(e => state.usedEventIds.add(e.id));
            
            return selected;
        }

        function getRandomEvent() {
            // Determine game phase: early (1-5) focuses on template building, late (6-12) on scaling
            // Month 6 is the transition point - mid-year review marks shift to scaling focus
            const isEarlyPhase = state.turn <= 5;
            
            // Core departments always available
            const departments = ['finance', 'hr', 'ops', 'marketing', 'tech', 'personality', 'corporate_tensions', 'external_relations'];
            
            // Add template_building events (heavily weighted in early phase)
            if (isEarlyPhase) {
                departments.push('template_building');
                // Add template_building multiple times to increase probability
                departments.push('template_building');
                departments.push('template_building');
                // Add marketing twice to ensure market-affecting events appear
                departments.push('marketing');
                departments.push('marketing');
                // Add ops twice for market-affecting quality/process events
                departments.push('ops');
                
                // Add shortcuts (cheese) events in months 4-5 only
                // Months 1-3 get dedicated cheese events via getShortcutEvents()
                if (state.turn >= 4) {
                    departments.push('shortcuts');
                }
            }
            
            // Add scaling/competitor/corporate events primarily in late game (month 6+)
            if (!isEarlyPhase) {
                departments.push('ops_scaling', 'scaling', 'competitors', 'corporate');
                // Double-add scaling events to increase their probability
                departments.push('scaling', 'competitors');
                
                // Keep shortcuts available as temptations
                departments.push('shortcuts');
                
                // Add template maturity rewards when template is Advanced or Optimized
                if (state.templateStage === 'Advanced' || state.templateStage === 'Optimized') {
                    departments.push('template_rewards');
                    departments.push('template_rewards'); // Double for higher probability
                }
            }
            
            // Add venture-specific events
            const ventureKey = 'venture_' + state.venture;
            if (eventBank[ventureKey]) {
                departments.push(ventureKey);
            }
            
            let availableEvents = [];
            departments.forEach(dept => {
                if (eventBank[dept]) {
                    eventBank[dept].forEach(event => {
                        if (state.usedEventIds.has(event.id)) return;
                        if (event.condition && typeof event.condition === 'function' && !event.condition()) return;
                        if (event.isScalingFailure && state.reach < 5) return;
                        if (dept === 'ops_scaling' && state.reach < 8) return;
                        
                        // Phase-based filtering
                        if (isEarlyPhase) {
                            // In early phase, strictly filter out late-phase events
                            if (event.phase === 'late') return;
                            if (dept === 'competitors') return; // No competitor events early
                            if (dept === 'corporate') return; // No corporate events early
                            // Boost early-phase and template events
                            if (event.phase === 'early' || dept === 'template_building') {
                                availableEvents.push(event); // Add twice to increase probability
                            }
                        } else {
                            // In late phase, allow early events but prioritize scaling
                            if (event.phase === 'early' && Math.random() > 0.25) return; // 25% chance of early events
                            // Boost scaling-related events and template rewards
                            if (dept === 'scaling' || dept === 'competitors' || dept === 'corporate' || dept === 'ops_scaling' || dept === 'template_rewards') {
                                availableEvents.push(event); // Add twice to increase probability
                            }
                        }
                        
                        availableEvents.push(event);
                    });
                }
            });
            
            if (availableEvents.length === 0) { 
                // No more unique events available - return null instead of repeating
                console.log('No more unique events available');
                return null; 
            }
            const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
            state.usedEventIds.add(event.id);
            return event;
        }

        function triggerGlobalShock() {
            const shocks = Object.values(eventBank.global_shocks);
            const shock = shocks[Math.floor(Math.random() * shocks.length)];
            showGlobalShock(shock.title);
            applyEffects(shock.immediateEffects);
            updateDashboard();
        }

        // Event Bank - Phase-Based: Build Template First, Then Scale
        // Early Phase (M1-5): Focus on documenting, learning, building repeatable approaches
        // Late Phase (M6-12): Focus on scaling, competition, growth decisions
        const eventBank = {
            // EARLY PHASE: Template Building Events
            finance: [
                { id: 'fin01', dept: 'Finance', icon: '📊', title: 'Investor Pressure to Grow Faster', phase: 'early',
                  text: 'The board is pushing to enter 5 new markets this year. Your team says the current approach still has problems that need fixing first.',
                  options: [
                    { text: 'Stick to the plan - fix problems before expanding', effects: { templateProgress: 8, morale: 3, marketStrength: 6 } },
                    { text: 'Compromise - enter 2 new markets while improving', effects: { reach: 2, templateProgress: 3, marketStrength: 2, rollChance: 0.5, roll: { pass: {}, fail: { profitLoss: -1, morale: -3, marketStrength: -5 } } } },
                    { text: 'Go for growth - worry about problems later', effects: { reach: 4, templateProgress: -6, marketStrength: -8, rollChance: 0.4, roll: { pass: { profitLoss: 0.5 }, fail: { profitLoss: -2, morale: -6, marketStrength: -10 } } } }
                  ] },
                { id: 'fin02', dept: 'Finance', icon: '💰', title: 'Spending on Systems vs Growth', phase: 'early',
                  text: 'You have resources for either: better tracking systems to understand what works, OR a big marketing push to reach more customers.',
                  options: [
                    { text: 'Invest in systems and data', investment: 1, effects: { templateProgress: 8, skill: 4, marketStrength: 4 } },
                    { text: 'Split resources 50/50', investment: 0.5, effects: { templateProgress: 4, reach: 2, skill: 2, marketStrength: 2 } },
                    { text: 'Go all-in on marketing', investment: 1, effects: { reach: 6, templateProgress: -3, innovation: 2, marketStrength: -3 } }
                  ] },
                { id: 'fin03', dept: 'Finance', icon: '⚠️', title: 'Pilot Market Losing Money', phase: 'early',
                  text: 'Your first market is still unprofitable after 6 months. Should you keep learning there, or try somewhere else?',
                  options: [
                    { text: 'Stay and figure out what\'s wrong', cost: 0.8, effects: { templateProgress: 7, skill: 4, reach: -1, marketStrength: 5 } },
                    { text: 'Try a different market instead', investment: 1.2, effects: { reach: 2, templateProgress: -4, marketStrength: -4, rollChance: 0.5, roll: { pass: { morale: 3 }, fail: { profitLoss: -1.5, marketStrength: -6 } } } },
                    { text: 'Cut losses and shrink operations', effects: { profitLoss: 0.5, morale: -4, reach: -3, marketStrength: -8 } }
                  ] },
                { id: 'fin04', dept: 'Finance', icon: '📈', title: 'Success in One Market', phase: 'early',
                  text: 'Great news - your pilot market is working! Competitors are noticing. Move fast to new markets, or perfect the approach first?',
                  options: [
                    { text: 'Document everything before expanding', effects: { templateProgress: 11, skill: 3, marketStrength: 8 } },
                    { text: 'Expand while the opportunity is hot', investment: 1.5, effects: { reach: 7, templateProgress: -3, marketStrength: 5, rollChance: 0.5, roll: { pass: { profitLoss: 1, marketStrength: 6 }, fail: { reach: -4, morale: -4, marketStrength: -10 } } } },
                    { text: 'Hire consultants to help scale properly', cost: 1, effects: { templateProgress: 7, reach: 3, skill: 2, marketStrength: 4 } }
                  ] },
                { id: 'fin05', dept: 'Finance', icon: '🎯', title: 'Too Many Ideas, Limited Resources', phase: 'early',
                  text: 'Team has 10 ideas for improvement. You can fund 2. Focus on making current approach better, or try new things?',
                  options: [
                    { text: 'Fund improvements to current approach', investment: 0.8, effects: { templateProgress: 8, skill: 3 } },
                    { text: 'Fund experimental new ideas', investment: 0.8, effects: { innovation: 7, templateProgress: -3, rollChance: 0.6, roll: { pass: { reach: 3 }, fail: { morale: -3 } } } },
                    { text: 'One of each', investment: 0.8, effects: { templateProgress: 4, innovation: 3 } }
                  ] },
                { id: 'fin06', dept: 'Finance', icon: '⚖️', title: 'Profitable But Not Purposeful', phase: 'late',
                  text: 'Your most profitable market segment doesn\'t align with your social mission. It\'s making money but diluting what you stand for.',
                  options: [
                    { text: 'Exit the segment, protect the mission', effects: { profitLoss: -1.5, purpose: 8, morale: 4, reach: -3 } },
                    { text: 'Keep it but ring-fence the profits for purpose', effects: { profitLoss: 0.3, purpose: 3, templateProgress: 3 } },
                    { text: 'Grow it - profit enables purpose later', effects: { profitLoss: 1, purpose: -7, reach: 4, morale: -3 } }
                  ] },
                { id: 'fin07', dept: 'Finance', icon: '🏦', title: 'Impact Investor vs Commercial Investor', phase: 'late',
                  text: 'Two investors interested: one offers more money but wants aggressive growth targets. The other offers less but shares your values.',
                  options: [
                    { text: 'Take the values-aligned investor', effects: { profitLoss: 1.5, purpose: 6, templateProgress: 6, morale: 4 } },
                    { text: 'Take the money, manage expectations', effects: { profitLoss: 3, purpose: -4, reach: 3, rollChance: 0.5, roll: { pass: {}, fail: { morale: -6, templateProgress: -6 } } } },
                    { text: 'Try to get both on board together', rollChance: 0.4, roll: { pass: {profitLoss: 3, purpose: 3, morale: 3 }, fail: {profitLoss: 1, morale: -3 } } }
                  ] },
                { id: 'fin08', dept: 'Finance', icon: '📋', title: 'New Compliance Requirements', phase: 'late',
                  text: 'New regulations mean additional reporting requirements and process changes. Compliance isn\'t optional, but how you implement it is.',
                  options: [
                    { text: 'Hire a dedicated compliance officer', effects: { costPressure: 60, skill: 4, purpose: 3 } },
                    { text: 'Train existing team to handle it', effects: { costPressure: 20, skill: -2, morale: -3, templateProgress: -4 } },
                    { text: 'Outsource to consultants', effects: { costPressure: 40, templateProgress: 2 } }
                  ] },
                { id: 'fin10', dept: 'Finance', icon: '🔧', title: 'Process Efficiency Review', phase: 'late',
                  text: 'Finance has identified potential cost savings through process improvements. Implementation requires upfront investment.',
                  options: [
                    { text: 'Full efficiency programme', investment: 1.5, effects: { costPressure: -80, templateProgress: 6, morale: -3 } },
                    { text: 'Quick wins only', investment: 0.5, effects: { costPressure: -30, templateProgress: 2 } },
                    { text: 'Focus on growth instead', effects: { reach: 2, morale: 2 } }
                  ] },
                { id: 'fin11', dept: 'Finance', icon: '💎', title: 'Customer Retention Analysis', phase: 'late',
                  text: 'Data shows customer churn is rising. Retention costs less than acquisition, but requires investment.',
                  options: [
                    { text: 'Major retention programme', investment: 1.2, effects: { marketStrength: 15, costPressure: 25, morale: 3 } },
                    { text: 'Targeted outreach to at-risk customers', cost: 0.5, effects: { marketStrength: 8, skill: 2 } },
                    { text: 'Focus on new customer acquisition instead', effects: { reach: 3, marketStrength: -8 } }
                  ] },
                { id: 'fin12', dept: 'Finance', icon: '📊', title: 'Pricing Strategy Review', phase: 'late',
                  text: 'Market research suggests you could increase prices by 10% without losing customers - or lower them to gain share.',
                  options: [
                    { text: 'Raise prices', effects: { profitLoss: 0.8, marketStrength: -5, reach: -1 } },
                    { text: 'Keep current pricing', effects: { marketStrength: 3, templateProgress: 2 } },
                    { text: 'Lower prices to gain share', effects: { profitLoss: -0.6, marketStrength: 10, reach: 3 } }
                  ] }
            ],
            hr: [
                { id: 'hr01', dept: 'HR', icon: '📚', title: 'Training New Staff', phase: 'early',
                  text: 'New hires are struggling because there\'s no proper training programme. Creating one takes time away from growth.',
                  options: [
                    { text: 'Stop and build proper training materials', cost: 0.5, effects: { templateProgress: 10, skill: 6, marketStrength: 6 } },
                    { text: 'Pair new staff with experienced people', effects: { skill: 3, morale: -3, templateProgress: 4, marketStrength: 2 } },
                    { text: 'Let them learn on the job', effects: { reach: 2, skill: -4, marketStrength: -6, rollChance: 0.4, roll: { pass: {}, fail: { morale: -6, templateProgress: -6, marketStrength: -8 } } } }
                  ] },
                { id: 'hr02', dept: 'HR', icon: '👥', title: 'Key Person Dependency', phase: 'early',
                  text: 'One brilliant employee knows how everything works, but nothing is written down. If they leave, you\'re in trouble.',
                  options: [
                    { text: 'Have them document everything', effects: { templateProgress: 11, skill: 3, morale: -2, marketStrength: 5 } },
                    { text: 'Promote them and hire support', cost: 0.8, effects: { morale: 4, skill: 2, templateProgress: 6, marketStrength: 3 } },
                    { text: 'Hope they don\'t leave', effects: { marketStrength: -3, rollChance: 0.3, roll: { pass: { morale: 2 }, fail: { skill: -8, templateProgress: -8, morale: -6, marketStrength: -12 } } } }
                  ] },
                { id: 'hr03', dept: 'HR', icon: '🏃', title: 'Staff Stretched Too Thin', phase: 'late',
                  text: 'Everyone is working overtime to keep up with growth. Quality is slipping and people are getting tired.',
                  options: [
                    { text: 'Slow down growth, let people recover', effects: { reach: -3, morale: 7, skill: 3, templateProgress: 4, marketStrength: 4 } },
                    { text: 'Hire more people quickly', cost: 1.2, effects: { morale: 3, skill: -3, reach: 2, marketStrength: -4 } },
                    { text: 'Push through the busy period', effects: { reach: 3, morale: -8, marketStrength: -8, rollChance: 0.3, roll: { pass: {}, fail: { skill: -6, templateProgress: -4, marketStrength: -10 } } } }
                  ] },
                { id: 'hr04', dept: 'HR', icon: '🌍', title: 'Local vs Central Control', phase: 'late',
                  text: 'New market teams want freedom to do things their way. But that means the approach won\'t be consistent.',
                  options: [
                    { text: 'Insist on following the standard approach', effects: { templateProgress: 8, morale: -4, staffLocal: -10, marketStrength: 5 } },
                    { text: 'Let them adapt with some guidelines', effects: { templateProgress: 3, morale: 3, innovation: 3, marketStrength: 2 } },
                    { text: 'Give them complete freedom', effects: { morale: 6, templateProgress: -7, innovation: 4, marketStrength: -6 } }
                  ] },
                { id: 'hr05', dept: 'HR', icon: '🎓', title: 'Experienced vs Affordable Hires', phase: 'early',
                  text: 'You can hire 3 cheap graduates or 1 expensive expert who\'s done this before. Which helps build a repeatable approach?',
                  options: [
                    { text: 'Hire the experienced expert', cost: 1.2, effects: { skill: 7, templateProgress: 8, morale: 2, marketStrength: 6 } },
                    { text: 'Hire the graduates and train them', cost: 0.5, effects: { skill: 2, morale: 3, staffLocal: 10, templateProgress: 3, marketStrength: -2 } },
                    { text: 'Hire 2 graduates and invest in training', cost: 0.8, effects: { skill: 4, templateProgress: 6, morale: 3, marketStrength: 3 } }
                  ] },
                { id: 'hr06', dept: 'HR', icon: '💚', title: 'Fair Wages vs Faster Growth', phase: 'late',
                  text: 'You could hire more staff at minimum wage, or fewer at a living wage. The team is watching how you treat people.',
                  options: [
                    { text: 'Living wage for all - it\'s who we are', cost: 1.2, effects: { purpose: 8, morale: 7, skill: 3 } },
                    { text: 'Above minimum but not living wage', cost: 0.8, effects: { purpose: 3, morale: 3, reach: 2 } },
                    { text: 'Minimum wage - grow first, improve later', cost: 0.5, effects: { reach: 4, purpose: -7, morale: -4, rollChance: 0.4, roll: { pass: {}, fail: { skill: -4 } } } }
                  ] },
                { id: 'hr07', dept: 'HR', icon: '🤝', title: 'Poaching From Competitors', phase: 'late',
                  text: 'A competitor is struggling. You could hire their best people - they know the industry. But it feels predatory.',
                  options: [
                    { text: 'Actively recruit their talent', cost: 1, effects: { skill: 7, reach: 3, purpose: -4, morale: -2 } },
                    { text: 'Be open if they approach you', effects: { skill: 3, purpose: 2, rollChance: 0.5, roll: { pass: { skill: 3 }, fail: {} } } },
                    { text: 'Focus on growing your own people', cost: 0.5, effects: { purpose: 4, morale: 4, skill: 2, templateProgress: 3 } }
                  ] },
                { id: 'hr08', dept: 'HR', icon: '📈', title: 'Market Rate Wage Review', phase: 'late',
                  text: 'Salaries in your sector have risen 12% this year. Your team is being approached by recruiters. Retention is at risk.',
                  options: [
                    { text: 'Match market rates across the board', effects: { costPressure: 80, morale: 6, skill: 3 } },
                    { text: 'Selective raises for key people', effects: { costPressure: 35, morale: -2, skill: 2, rollChance: 0.5, roll: { pass: {}, fail: { skill: -4, morale: -4 } } } },
                    { text: 'Focus on culture and purpose instead', effects: { purpose: 4, morale: -3, rollChance: 0.4, roll: { pass: { morale: 4 }, fail: { skill: -5, morale: -5 } } } }
                  ] }
            ],
            ops: [
                { id: 'ops01', dept: 'ops', icon: '📋', title: 'Writing Down How Things Work', phase: 'early',
                  text: 'Your approach is in people\'s heads, not on paper. New sites struggle to copy what the first one does well.',
                  options: [
                    { text: 'Pause expansion to document processes', effects: { templateProgress: 14, reach: -3, skill: 4, marketStrength: 5 } },
                    { text: 'Hire someone to document while growing', cost: 0.8, effects: { templateProgress: 8, skill: 3, reach: 0, marketStrength: 3 } },
                    { text: 'Keep growing - people will figure it out', effects: { reach: 3, templateProgress: -6, marketStrength: -5, rollChance: 0.3, roll: { pass: {}, fail: { morale: -6, skill: -4, marketStrength: -8 } } } }
                  ] },
                { id: 'ops02', dept: 'ops', icon: '🔧', title: 'Quality Problems Appearing', phase: 'early',
                  text: 'As you\'ve grown, quality has become inconsistent. Some locations are great, others are terrible.',
                  options: [
                    { text: 'Stop growth until quality is fixed', effects: { reach: -3, templateProgress: 11, purpose: 4, skill: 3, marketStrength: 8 } },
                    { text: 'Add quality checks without slowing down', cost: 0.8, effects: { templateProgress: 6, reach: 0, skill: 3, marketStrength: 4 } },
                    { text: 'Close the bad locations', effects: { reach: -4, profitLoss: -0.5, morale: -3, templateProgress: 3, marketStrength: -6 } }
                  ] },
                { id: 'ops03', dept: 'ops', icon: '🏭', title: 'Supplier Can\'t Keep Up', phase: 'late',
                  text: 'Your growth is outpacing your supplier. You need more capacity, but changing suppliers means re-learning everything.',
                  options: [
                    { text: 'Slow growth to match supplier capacity', effects: { reach: -3, templateProgress: 6, profitLoss: 0.3, marketStrength: 3 } },
                    { text: 'Add a second supplier', investment: 1.5, effects: { reach: 3, templateProgress: -4, skill: -3, marketStrength: -4 } },
                    { text: 'Help current supplier expand', investment: 2, effects: { templateProgress: 8, reach: 2, purpose: 3, marketStrength: 5 } }
                  ] },
                { id: 'ops04', dept: 'ops', icon: '📦', title: 'Copying to New Location', phase: 'early',
                  text: 'You\'re opening in a new city. How closely should it follow the original approach?',
                  options: [
                    { text: 'Exact copy - change nothing', effects: { templateProgress: 8, reach: 2, marketStrength: 6, rollChance: 0.6, roll: { pass: { skill: 3 }, fail: { reach: -3, morale: -3, marketStrength: -8 } } } },
                    { text: 'Follow the template but allow small changes', effects: { templateProgress: 6, reach: 3, innovation: 2, marketStrength: 4 } },
                    { text: 'Start fresh - this market is different', effects: { templateProgress: -6, reach: 2, innovation: 4, marketStrength: -3, rollChance: 0.4, roll: { pass: { reach: 3 }, fail: { profitLoss: -1 } } } }
                  ] },
                { id: 'ops05', dept: 'ops', icon: '⚡', title: 'Speed vs Getting It Right', phase: 'early',
                  text: 'Competitors are growing fast. Your team says you could expand quicker by skipping some preparation steps.',
                  options: [
                    { text: 'Keep the thorough approach', effects: { templateProgress: 8, reach: -2, skill: 3, marketStrength: 5 } },
                    { text: 'Skip some steps to move faster', effects: { reach: 4, templateProgress: -6, marketStrength: -6, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -6, morale: -4, marketStrength: -10 } } } },
                    { text: 'Find ways to do preparation faster', investment: 0.8, effects: { templateProgress: 6, reach: 2, innovation: 3, marketStrength: 4 } }
                  ] },
                { id: 'ops06', dept: 'ops', icon: '🔄', title: 'Learning from Mistakes', phase: 'early',
                  text: 'Your newest location had problems. Do you take time to understand why, or just try to fix it quickly?',
                  options: [
                    { text: 'Deep investigation - understand the root cause', effects: { templateProgress: 10, skill: 6, reach: -2, marketStrength: 6 } },
                    { text: 'Quick fix and move on', cost: 0.5, effects: { reach: 2, templateProgress: -3, marketStrength: -4, rollChance: 0.5, roll: { pass: {}, fail: { morale: -4, purpose: -3, marketStrength: -8 } } } },
                    { text: 'Close it and focus on what\'s working', effects: { reach: -3, profitLoss: -0.5, templateProgress: 3, marketStrength: -5 } }
                  ] },
                { id: 'ops07', dept: 'ops', icon: '🌱', title: 'Sustainable vs Cheap Suppliers', phase: 'late',
                  text: 'You can save 20% by switching to a cheaper supplier, but they have weaker environmental standards.',
                  options: [
                    { text: 'Stay with sustainable supplier', effects: { purpose: 7, profitLoss: -0.5, morale: 3, templateProgress: 3 } },
                    { text: 'Switch but audit their practices', cost: 0.3, effects: { profitLoss: 0.5, purpose: -3, rollChance: 0.5, roll: { pass: { templateProgress: 3 }, fail: { purpose: -6 } } } },
                    { text: 'Switch to save money', effects: { profitLoss: 1, purpose: -8, reach: 3, morale: -3 } }
                  ] },
                { id: 'ops08', dept: 'ops', icon: '🏢', title: 'Centralise or Stay Local', phase: 'late',
                  text: 'Central warehousing would cut costs but means shipping further. Local facilities cost more but serve communities better.',
                  options: [
                    { text: 'Centralise for efficiency', investment: 2, effects: { costPressure: -60, templateProgress: 8, purpose: -4, staffLocal: -15 } },
                    { text: 'Keep local facilities', effects: { purpose: 6, staffLocal: 10, morale: 3, costPressure: 40 } },
                    { text: 'Hub and spoke model', investment: 1.5, effects: { templateProgress: 6, purpose: 2, costPressure: -20 } }
                  ] },
                { id: 'ops09', dept: 'ops', icon: '🏠', title: 'Lease Renewal Coming Up', phase: 'late',
                  text: 'Your main facility lease is up for renewal. The landlord wants a 25% increase. Property in the area has appreciated significantly.',
                  options: [
                    { text: 'Negotiate and stay', rollChance: 0.5, roll: { pass: { costPressure: 20, morale: 3 }, fail: { costPressure: 50, morale: -2 } } },
                    { text: 'Relocate to cheaper area', effects: { costPressure: -30, morale: -4, templateProgress: -4, staffLocal: -10 } },
                    { text: 'Accept the increase', effects: { costPressure: 50, morale: 2, templateProgress: 2 } }
                  ] },
                { id: 'ops10', dept: 'ops', icon: '⚡', title: 'Energy Costs Spiking', phase: 'early',
                  text: 'Energy prices have jumped 40%. Your operations are energy-intensive. Time to adapt or absorb the cost?',
                  options: [
                    { text: 'Invest in energy efficiency', investment: 1.2, effects: { costPressure: -40, innovation: 4, purpose: 3 } },
                    { text: 'Absorb the costs for now', effects: { costPressure: 60, morale: -2 } },
                    { text: 'Reduce operating hours', effects: { costPressure: 20, reach: -2, morale: -3 } }
                  ] },
                { id: 'ops11', dept: 'ops', icon: '🚚', title: 'Distribution Partnership Opportunity', phase: 'late',
                  text: 'A major distributor wants to carry your products. This could significantly strengthen your market position.',
                  options: [
                    { text: 'Sign exclusive partnership', effects: { marketStrength: 18, reach: 4, templateProgress: -3, purpose: -3 } },
                    { text: 'Non-exclusive deal', effects: { marketStrength: 10, reach: 2, templateProgress: 2 } },
                    { text: 'Build own distribution', investment: 2, effects: { marketStrength: 6, templateProgress: 8, reach: -2 } }
                  ] },
                { id: 'ops12', dept: 'ops', icon: '⭐', title: 'Service Quality Recognition', phase: 'late',
                  text: 'Your operations have been nominated for an industry award. Winning could boost your market standing.',
                  options: [
                    { text: 'Invest in award submission', cost: 0.5, effects: { marketStrength: 12, purpose: 3, rollChance: 0.6, roll: { pass: { marketStrength: 10, morale: 5 }, fail: {} } } },
                    { text: 'Accept nomination, minimal effort', effects: { marketStrength: 4, rollChance: 0.3, roll: { pass: { marketStrength: 8 }, fail: {} } } },
                    { text: 'Focus on operations, not awards', effects: { templateProgress: 4, skill: 2 } }
                  ] },
                { id: 'ops13', dept: 'ops', icon: '😟', title: 'Product Quality Issue Discovered', phase: 'late',
                  text: 'Quality testing found a potential issue. No incidents yet, but if it becomes public, your reputation could suffer.',
                  options: [
                    { text: 'Proactive recall and fix', cost: 1.5, effects: { marketStrength: 5, purpose: 8, morale: 3, profitLoss: -1 } },
                    { text: 'Quietly fix going forward', effects: { marketStrength: -10, templateProgress: 4, rollChance: 0.4, roll: { pass: {}, fail: { marketStrength: -15, purpose: -10 } } } },
                    { text: 'Monitor but don\'t act yet', effects: { rollChance: 0.3, roll: { pass: { templateProgress: 2 }, fail: { marketStrength: -25, purpose: -12, morale: -8 } } } }
                  ] }
            ],
            ops_scaling: [
                { id: 'opss01', dept: 'ops', icon: '📋', title: 'New Team Can\'t Replicate Success', phase: 'late',
                  text: 'Your new market team followed the playbook but results are poor. They say the instructions weren\'t clear enough.',
                  isScalingFailure: true, 
                  options: [
                    { text: 'Send experts to understand what went wrong', cost: 0.8, effects: { templateProgress: 8, skill: 4 } },
                    { text: 'Rewrite the playbook with clearer steps', effects: { templateProgress: 11, morale: 2 } },
                    { text: 'Replace the team with experienced people', cost: 1.2, effects: { reach: 0, morale: -6, skill: 3 } }
                  ] },
                { id: 'opss02', dept: 'ops', icon: '🔥', title: 'Growth Broke Your Systems', phase: 'late',
                  text: 'Your ordering and tracking systems can\'t handle the volume. Orders are getting lost and customers are angry.',
                  isScalingFailure: true, 
                  options: [
                    { text: 'Stop growth until systems are fixed', effects: { reach: -4, templateProgress: 11, skill: 6 } },
                    { text: 'Hire more people to handle it manually', cost: 1.5, effects: { reach: -2, morale: -3, profitLoss: -0.5 } },
                    { text: 'Build better systems while managing chaos', investment: 2, effects: { templateProgress: 8, skill: 4, rollChance: 0.5, roll: { pass: { reach: 0 }, fail: { reach: -6, morale: -6 } } } }
                  ] },
                { id: 'opss03', dept: 'ops', icon: '📉', title: 'Template Not Working in New Market', phase: 'late',
                  text: 'You followed the template exactly in the new market, but results are half what you expected. Something doesn\'t translate.',
                  isScalingFailure: true,
                  options: [
                    { text: 'Pull back and study what\'s different', effects: { templateProgress: 8, skill: 6, morale: -2 } },
                    { text: 'Adapt the template for this market', investment: 0.8, effects: { templateProgress: -3, reach: 2, innovation: 4 } },
                    { text: 'Exit and focus on markets that work', effects: { reach: -4, profitLoss: -0.5, templateProgress: 4, morale: -3 } }
                  ] }
            ],
            marketing: [
                { id: 'mkt01', dept: 'Marketing', icon: '🎯', title: 'What Message Works?', phase: 'early',
                  text: 'Different markets respond to different messages. Should you find one message that works everywhere, or customise?',
                  options: [
                    { text: 'Test until you find one universal message', investment: 0.8, effects: { templateProgress: 8, reach: -2, skill: 4, marketStrength: 5 } },
                    { text: 'Create local variations', cost: 0.8, effects: { reach: 4, templateProgress: -4, morale: 2, marketStrength: -3 } },
                    { text: 'Let frontline staff adapt messaging organically', effects: { innovation: 4, morale: 3, rollChance: 0.5, roll: { pass: { reach: 3, skill: 2 }, fail: { marketStrength: -6, templateProgress: -3 } } } }
                  ] },
                { id: 'mkt02', dept: 'Marketing', icon: '📣', title: 'Viral Opportunity', phase: 'late',
                  text: 'A social media trend could give you huge visibility. But it doesn\'t match your careful brand building.',
                  options: [
                    { text: 'Jump on the trend', effects: { reach: 7, purpose: -4, templateProgress: -3, marketStrength: 10, rollChance: 0.5, roll: { pass: { morale: 3 }, fail: { purpose: -6, marketStrength: -8 } } } },
                    { text: 'Adapt the trend to fit your brand', cost: 0.3, effects: { reach: 3, innovation: 3, templateProgress: 2, marketStrength: 6 } },
                    { text: 'Stick to your planned approach', effects: { templateProgress: 4, purpose: 3, reach: -2 } }
                  ] },
                { id: 'mkt03', dept: 'Marketing', icon: '🤝', title: 'Big Retailer Interested', phase: 'late',
                  text: 'A major retailer wants to stock your product. Great reach, but they want changes to your approach.',
                  options: [
                    { text: 'Accept their terms for the exposure', effects: { reach: 8, templateProgress: -6, purpose: -4, marketStrength: 12 } },
                    { text: 'Negotiate to keep your approach', rollChance: 0.5, roll: { pass: { reach: 6, templateProgress: 3, marketStrength: 8 }, fail: { reach: 0, morale: -3 } } },
                    { text: 'Decline - protect your model', effects: { templateProgress: 6, purpose: 4, morale: 3 } }
                  ] },
                { id: 'mkt04', dept: 'Marketing', icon: '📍', title: 'Focus or Spread?', phase: 'early',
                  text: 'You can dominate one city or have a presence in five. Which builds a better foundation for future growth?',
                  options: [
                    { text: 'Dominate one city first', effects: { templateProgress: 10, skill: 4, purpose: 3, marketStrength: 8 } },
                    { text: 'Light presence in multiple cities', investment: 1, effects: { reach: 4, templateProgress: -3, marketStrength: -5, rollChance: 0.5, roll: { pass: { morale: 3 }, fail: { profitLoss: -1 } } } },
                    { text: 'Strong in two cities', investment: 0.5, effects: { reach: 3, templateProgress: 4, skill: 2, marketStrength: 3 } }
                  ] },
                { id: 'mkt05', dept: 'Marketing', icon: '⭐', title: 'Customer Success Stories', phase: 'early',
                  text: 'Happy customers want to share their stories. This takes time from growth, but proves your approach works.',
                  options: [
                    { text: 'Invest in collecting and sharing stories', cost: 0.5, effects: { templateProgress: 7, purpose: 6, reach: 2, marketStrength: 10 } },
                    { text: 'Quick testimonials only', effects: { reach: 3, templateProgress: 3, purpose: 2, marketStrength: 4 } },
                    { text: 'Focus on growth instead', effects: { reach: 4, templateProgress: -2, marketStrength: -3 } }
                  ] },
                { id: 'mkt06', dept: 'Marketing', icon: '💚', title: 'Purpose vs Performance Marketing', phase: 'late',
                  text: 'You can run ads highlighting your social impact (slower conversion) or pure product benefits (faster sales).',
                  options: [
                    { text: 'Lead with purpose and values', cost: 0.8, effects: { purpose: 8, reach: 2, templateProgress: 4, profitLoss: -0.3, marketStrength: 6 } },
                    { text: 'Lead with product benefits', cost: 0.8, effects: { reach: 6, purpose: -4, profitLoss: 0.5, marketStrength: 3 } },
                    { text: 'Test both and learn', cost: 1, effects: { reach: 3, purpose: 3, skill: 4, templateProgress: 3, marketStrength: 5 } }
                  ] },
                { id: 'mkt07', dept: 'Marketing', icon: '🏷️', title: 'Premium Pricing or Accessible?', phase: 'late',
                  text: 'Your product could be premium (higher margins, fewer customers) or accessible (lower margins, more impact).',
                  options: [
                    { text: 'Premium positioning', effects: { profitLoss: 1, reach: -3, purpose: -6, templateProgress: 4, marketStrength: -5 } },
                    { text: 'Accessible pricing', effects: { profitLoss: -0.5, reach: 6, purpose: 7, morale: 3, marketStrength: 8 } },
                    { text: 'Two tiers - premium and basic', investment: 0.8, effects: { reach: 3, templateProgress: -3, innovation: 3, profitLoss: 0.3, marketStrength: 4 } }
                  ] },
                { id: 'mkt08', dept: 'Marketing', icon: '📰', title: 'Press Coverage Opportunity', phase: 'early',
                  text: 'A journalist wants to write about your venture. Good coverage could boost your market position significantly.',
                  options: [
                    { text: 'Give full access and tell your story', effects: { marketStrength: 12, purpose: 3, reach: 2, rollChance: 0.7, roll: { pass: { marketStrength: 8 }, fail: { purpose: -5 } } } },
                    { text: 'Controlled interview only', effects: { marketStrength: 6, reach: 1, skill: 2 } },
                    { text: 'Decline - we\'re not ready for scrutiny yet', effects: { templateProgress: 4, morale: 2, rollChance: 0.3, roll: { pass: {}, fail: { marketStrength: -4 } } } }
                  ] },
                { id: 'mkt09', dept: 'Marketing', icon: '⚔️', title: 'Competitor Launches Price War', phase: 'early',
                  text: 'A competitor is undercutting your prices aggressively. Your market position is being challenged.',
                  options: [
                    { text: 'Match their prices', effects: { marketStrength: -5, profitLoss: -1.5, reach: 2 } },
                    { text: 'Emphasise quality and value', cost: 0.6, effects: { marketStrength: 8, purpose: 4, templateProgress: 3 } },
                    { text: 'Target different customer segment', effects: { marketStrength: 3, reach: -2, innovation: 4 } }
                  ] },
                { id: 'mkt10', dept: 'Marketing', icon: '🌟', title: 'Customer Loyalty Programme', phase: 'late',
                  text: 'Repeat customers drive most revenue. A loyalty programme could strengthen market position.',
                  options: [
                    { text: 'Launch comprehensive loyalty programme', investment: 1, effects: { marketStrength: 15, reach: 3, costPressure: 30 } },
                    { text: 'Simple referral rewards', cost: 0.3, effects: { marketStrength: 8, reach: 2 } },
                    { text: 'Focus on acquiring new customers', effects: { reach: 4, marketStrength: -3 } }
                  ] },
                { id: 'mkt11', dept: 'Marketing', icon: '📉', title: 'Customer Complaints Rising', phase: 'early',
                  text: 'Social media complaints are increasing. Your reputation is taking a hit.',
                  options: [
                    { text: 'Public apology and fix the issues', cost: 0.8, effects: { marketStrength: 5, purpose: 6, morale: -3, templateProgress: 4 } },
                    { text: 'Address privately, improve quietly', effects: { marketStrength: -8, templateProgress: 6, skill: 3 } },
                    { text: 'Push through - it will blow over', effects: { marketStrength: -15, reach: 2, rollChance: 0.3, roll: { pass: {}, fail: { purpose: -8, morale: -5 } } } }
                  ] }
            ],
            tech: [
                { id: 'tech01', dept: 'tech', icon: '📱', title: 'Build Proper Systems', phase: 'early',
                  text: 'You\'re using spreadsheets and manual processes. Real systems cost money but make scaling easier.',
                  options: [
                    { text: 'Build proper systems now', investment: 2, effects: { templateProgress: 14, skill: 6, marketStrength: 8 } },
                    { text: 'Buy off-the-shelf software', cost: 0.8, effects: { templateProgress: 7, skill: 3, reach: 0, marketStrength: 4 } },
                    { text: 'Keep using spreadsheets for now', effects: { reach: 3, marketStrength: -6, rollChance: 0.4, roll: { pass: {}, fail: { templateProgress: -8, morale: -6, marketStrength: -10 } } } }
                  ] },
                { id: 'tech02', dept: 'tech', icon: '📊', title: 'Tracking What Works', phase: 'early',
                  text: 'You don\'t have good data on what\'s working and what isn\'t. Flying blind as you grow.',
                  options: [
                    { text: 'Stop and set up proper measurement', investment: 1, effects: { templateProgress: 10, skill: 6, marketStrength: 7 } },
                    { text: 'Add basic tracking while growing', cost: 0.5, effects: { templateProgress: 6, skill: 3, reach: 0, marketStrength: 3 } },
                    { text: 'Trust your instincts for now', effects: { reach: 3, innovation: 2, marketStrength: -5, rollChance: 0.4, roll: { pass: {}, fail: { templateProgress: -6, profitLoss: -1, marketStrength: -8 } } } }
                  ] },
                { id: 'tech03', dept: 'tech', icon: '🔗', title: 'Connecting Everything', phase: 'early',
                  text: 'Each location has its own way of doing things. A central system would cost money but ensure consistency.',
                  options: [
                    { text: 'Build a central system', investment: 1.5, effects: { templateProgress: 11, skill: 4, morale: -3, marketStrength: 6 } },
                    { text: 'Create shared standards without central system', cost: 0.3, effects: { templateProgress: 6, morale: 2, skill: 2, marketStrength: 3 } },
                    { text: 'Let each location manage themselves', effects: { morale: 3, templateProgress: -6, innovation: 3, marketStrength: -5 } }
                  ] },
                { id: 'tech04', dept: 'tech', icon: '🤖', title: 'Automation Opportunity', phase: 'late',
                  text: 'New technology could automate repetitive tasks. Frees people up, but changes how things work.',
                  options: [
                    { text: 'Automate and update the template', investment: 1.5, effects: { templateProgress: 8, skill: 4, staffLocal: -10, profitLoss: 0.5 } },
                    { text: 'Small pilot to test it', investment: 0.5, effects: { templateProgress: 4, innovation: 4, skill: 2 } },
                    { text: 'Keep the human approach for now', effects: { morale: 3, purpose: 3, staffLocal: 5, templateProgress: 2 } }
                  ] },
                { id: 'tech05', dept: 'tech', icon: '💡', title: 'Innovation vs Stability', phase: 'late',
                  text: 'Team has exciting new ideas, but implementing them would mean rewriting your template.',
                  options: [
                    { text: 'Finish the current template first', effects: { templateProgress: 8, innovation: -3, morale: -2 } },
                    { text: 'Test innovations in one location', investment: 0.5, effects: { innovation: 6, templateProgress: 3, skill: 3 } },
                    { text: 'Embrace the new approach', investment: 1, effects: { innovation: 8, templateProgress: -8, rollChance: 0.5, roll: { pass: { reach: 4 }, fail: { morale: -6 } } } }
                  ] },
                { id: 'tech06', dept: 'tech', icon: '🔒', title: 'Data Privacy vs Personalisation', phase: 'late',
                  text: 'You could collect more customer data to improve service, but some customers worry about privacy.',
                  options: [
                    { text: 'Minimal data - respect privacy', effects: { purpose: 7, reach: -2, innovation: -3, morale: 3 } },
                    { text: 'Collect data with clear consent', cost: 0.5, effects: { purpose: 3, innovation: 4, templateProgress: 3, skill: 3 } },
                    { text: 'Collect everything that\'s legal', effects: { innovation: 7, reach: 3, purpose: -8, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -6, morale: -4 } } } }
                  ] },
                { id: 'tech07', dept: 'tech', icon: '♻️', title: 'Green Technology Investment', phase: 'late',
                  text: 'New green technology could reduce your environmental footprint, but it\'s expensive and unproven.',
                  options: [
                    { text: 'Be an early adopter', investment: 1.5, effects: { purpose: 8, innovation: 6, rollChance: 0.5, roll: { pass: { templateProgress: 6 }, fail: { profitLoss: -1 } } } },
                    { text: 'Wait for the technology to mature', effects: { profitLoss: 0.3, purpose: -3, templateProgress: 3 } },
                    { text: 'Invest in proven efficiency improvements', investment: 0.8, effects: { purpose: 4, profitLoss: 0.5, templateProgress: 4 } }
                  ] }
            ],
            // EARLY PHASE ONLY: Template Building Events - Core lesson of the game
            // These events teach players to build a strong, documented, repeatable approach before scaling
            // DESIGN PRINCIPLE: Each option should have legitimate appeal - no obvious "right" answers
            template_building: [
                { id: 'tb01', dept: 'ops', icon: '📝', title: 'Document or Grow?', phase: 'early',
                  text: 'Your pilot is showing promise but nothing is written down. New team members struggle to understand "how we do things here."',
                  options: [
                    { text: 'Stop everything and document the approach', effects: { templateProgress: 10, skill: 4, morale: -3, marketStrength: 6 }, description: 'Complete but team frustrated by the pause' },
                    { text: 'Document the basics while continuing', cost: 0.5, effects: { templateProgress: 7, skill: 3, morale: 2, marketStrength: 4 } },
                    { text: 'Keep moving - capture lessons as you go', effects: { reach: 3, innovation: 4, templateProgress: 2, marketStrength: -4, rollChance: 0.5, roll: { pass: { skill: 3 }, fail: { skill: -3, marketStrength: -5 } } } }
                  ] },
                { id: 'tb02', dept: 'ops', icon: '🧪', title: 'The Pilot Isn\'t Working Yet', phase: 'early',
                  text: 'Your first market hasn\'t proven the model yet. Investors want to see growth, but you\'re not sure what actually works.',
                  options: [
                    { text: 'Stay focused until the model works', effects: { templateProgress: 8, skill: 6, profitLoss: -0.5, marketStrength: 5 }, description: 'Burns cash while learning' },
                    { text: 'Try variations in parallel markets', investment: 1, effects: { reach: 3, templateProgress: 4, innovation: 6, morale: 3, marketStrength: 2 } },
                    { text: 'Follow customer demand wherever it leads', effects: { reach: 4, innovation: 3, templateProgress: -2, marketStrength: -3, rollChance: 0.5, roll: { pass: { purpose: 3 }, fail: { purpose: -4, marketStrength: -5 } } } }
                  ] },
                { id: 'tb03', dept: 'Finance', icon: '🎯', title: 'What Makes This Work?', phase: 'early',
                  text: 'Some customers love you, others don\'t. You don\'t yet understand WHY your approach works when it does.',
                  options: [
                    { text: 'Deep customer research to understand success', investment: 0.8, effects: { templateProgress: 8, skill: 4, morale: -2, marketStrength: 6 }, description: 'Team finds research tedious' },
                    { text: 'Talk to your happiest customers only', effects: { templateProgress: 6, purpose: 4, skill: 3, reach: 0, marketStrength: 4 } },
                    { text: 'Let patterns emerge from more data', effects: { reach: 4, innovation: 3, templateProgress: 3, marketStrength: -2, rollChance: 0.5, roll: { pass: { skill: 4 }, fail: { profitLoss: -0.5 } } } }
                  ] },
                { id: 'tb04', dept: 'HR', icon: '🎓', title: 'How Do We Teach This?', phase: 'early',
                  text: 'Your best people just "get it" but can\'t explain what they do. How will you train others to do what they do?',
                  options: [
                    { text: 'Shadow and document their methods', effects: { templateProgress: 8, skill: 6, morale: -3, reach: -2, marketStrength: 5 }, description: 'Star performers resent the scrutiny' },
                    { text: 'Create a mentoring programme', cost: 0.5, effects: { templateProgress: 7, skill: 4, morale: 4, reach: 0, marketStrength: 4 } },
                    { text: 'Hire people with relevant experience', cost: 0.8, effects: { skill: 7, innovation: 3, reach: 3, templateProgress: 2, marketStrength: 2 } }
                  ] },
                { id: 'tb05', dept: 'ops', icon: '📊', title: 'Measuring What Matters', phase: 'early',
                  text: 'You\'re tracking revenue and costs, but not the things that make your model work. What metrics define template success?',
                  options: [
                    { text: 'Build comprehensive template health metrics', investment: 0.8, effects: { templateProgress: 8, skill: 4, morale: -3, reach: -2, marketStrength: 5 }, description: 'Team drowns in data' },
                    { text: 'Track 3 key leading indicators', cost: 0.3, effects: { templateProgress: 7, skill: 3, morale: 2, reach: 0, marketStrength: 4 } },
                    { text: 'Focus on outcomes, not process metrics', effects: { reach: 3, purpose: 3, innovation: 3, templateProgress: 3, marketStrength: -2, rollChance: 0.5, roll: { pass: { morale: 3 }, fail: { skill: -3, marketStrength: -4 } } } }
                  ] },
                { id: 'tb06', dept: 'tech', icon: '🔧', title: 'Manual vs Automated', phase: 'early',
                  text: 'Everything runs on spreadsheets and manual processes. It works now but won\'t scale. When do you build real systems?',
                  options: [
                    { text: 'Build proper systems now while small', investment: 1.5, effects: { templateProgress: 10, skill: 4, reach: -4, morale: -2, marketStrength: 6 }, description: 'Painful transition period' },
                    { text: 'Document and optimise current processes first', cost: 0.3, effects: { templateProgress: 7, skill: 3, morale: 3, reach: 0, marketStrength: 4 } },
                    { text: 'Let systems evolve with actual needs', effects: { reach: 3, innovation: 4, morale: 3, templateProgress: 3, marketStrength: -3, rollChance: 0.5, roll: { pass: { skill: 3 }, fail: { skill: -4, marketStrength: -5 } } } }
                  ] },
                { id: 'tb07', dept: 'Marketing', icon: '💬', title: 'Finding Your Voice', phase: 'early',
                  text: 'Your messaging changes with every market. Customers are confused about what you actually stand for.',
                  options: [
                    { text: 'Define one core brand and message', investment: 0.5, effects: { templateProgress: 8, purpose: 4, reach: -3, innovation: -3, marketStrength: 8 }, description: 'Limits creative flexibility' },
                    { text: 'Test messages to find what resonates everywhere', cost: 0.5, effects: { templateProgress: 6, skill: 4, innovation: 3, reach: 0, marketStrength: 5 } },
                    { text: 'Let each market find its own voice', effects: { reach: 4, innovation: 6, morale: 3, templateProgress: -2, purpose: -2, marketStrength: -5 } }
                  ] },
                { id: 'tb08', dept: 'ops', icon: '🔄', title: 'Learning Loops', phase: 'early',
                  text: 'Things go wrong but you don\'t have a way to capture and share lessons. The same mistakes keep happening.',
                  options: [
                    { text: 'Create formal learning and feedback systems', investment: 0.8, effects: { templateProgress: 8, skill: 6, morale: -3, reach: -2, marketStrength: 6 }, description: 'Feels bureaucratic' },
                    { text: 'Weekly team retrospectives', effects: { templateProgress: 6, morale: 4, skill: 3, reach: 0, marketStrength: 4 } },
                    { text: 'Empower teams to fix issues as they arise', effects: { innovation: 4, morale: 4, reach: 2, templateProgress: 3, marketStrength: -2, rollChance: 0.5, roll: { pass: { skill: 3 }, fail: { purpose: -3, marketStrength: -5 } } } }
                  ] },
                { id: 'tb09', dept: 'Finance', icon: '💰', title: 'Unit Economics Mystery', phase: 'early',
                  text: 'You don\'t know the true cost of serving each customer. Some might be profitable, others definitely aren\'t.',
                  options: [
                    { text: 'Deep dive into unit economics', investment: 0.5, effects: { templateProgress: 8, skill: 4, morale: -3, reach: -2, marketStrength: 5 }, description: 'Analysis paralysis risk' },
                    { text: 'Focus on your most profitable segments', effects: { templateProgress: 6, profitLoss: 0.5, reach: -2, purpose: -3, marketStrength: 3 } },
                    { text: 'Grow first, optimise margins later', effects: { reach: 6, innovation: 3, morale: 3, templateProgress: 2, marketStrength: -4, rollChance: 0.5, roll: { pass: { profitLoss: 0.5 }, fail: { profitLoss: -1, marketStrength: -5 } } } }
                  ] },
                { id: 'tb10', dept: 'HR', icon: '👥', title: 'Key Person Risk', phase: 'early',
                  text: 'One person holds all the knowledge. If they leave, could anyone else run this the same way?',
                  options: [
                    { text: 'Systematic knowledge transfer', effects: { templateProgress: 10, skill: 4, morale: -4, reach: -2, marketStrength: 6 }, description: 'Star performer feels sidelined' },
                    { text: 'Build a team around them', cost: 0.8, effects: { templateProgress: 7, morale: 4, skill: 3, reach: 0, marketStrength: 4 } },
                    { text: 'Give them ownership and trust them', effects: { morale: 7, innovation: 4, reach: 3, templateProgress: 2, marketStrength: 2, rollChance: 0.4, roll: { pass: { skill: 4 }, fail: { skill: -7, templateProgress: -6, marketStrength: -8 } } } }
                  ] },
                { id: 'tb11', dept: 'ops', icon: '📋', title: 'Checklist Culture', phase: 'early',
                  text: 'Quality varies wildly depending on who\'s working. Should you standardise with checklists and procedures?',
                  options: [
                    { text: 'Comprehensive standard operating procedures', investment: 0.8, effects: { templateProgress: 10, skill: 4, morale: -4, innovation: -3, marketStrength: 8 }, description: 'Stifles creativity' },
                    { text: 'Key checklists for critical tasks only', cost: 0.3, effects: { templateProgress: 7, skill: 3, morale: 2, reach: 0, marketStrength: 5 } },
                    { text: 'Hire for judgment, not compliance', effects: { morale: 6, innovation: 6, skill: 3, templateProgress: 2, marketStrength: -3, rollChance: 0.5, roll: { pass: { reach: 3 }, fail: { purpose: -4, marketStrength: -6 } } } }
                  ] },
                { id: 'tb12', dept: 'Marketing', icon: '🎯', title: 'Who Is Our Customer?', phase: 'early',
                  text: 'You\'re serving everyone who\'ll pay. But your most successful cases have something in common. Should you focus?',
                  options: [
                    { text: 'Define ideal customer profile tightly', effects: { templateProgress: 8, purpose: 4, reach: -4, morale: -2, marketStrength: 7 }, description: 'Team resists turning away business' },
                    { text: 'Focus on 2-3 customer segments', effects: { templateProgress: 7, reach: 2, skill: 3, morale: 2, marketStrength: 5 } },
                    { text: 'Stay open to whoever finds value', effects: { reach: 6, innovation: 4, morale: 3, templateProgress: 2, marketStrength: -4, rollChance: 0.5, roll: { pass: { purpose: 3 }, fail: { purpose: -4, marketStrength: -5 } } } }
                  ] },
                { id: 'tb13', dept: 'tech', icon: '📊', title: 'Data Foundation', phase: 'early',
                  text: 'Your data is scattered across spreadsheets, emails, and people\'s heads. Building a template requires knowing what actually works.',
                  options: [
                    { text: 'Build proper data infrastructure', investment: 1.2, effects: { templateProgress: 8, skill: 6, morale: -3, marketStrength: 5 }, description: 'Expensive and disruptive' },
                    { text: 'Consolidate into simple dashboards', cost: 0.5, effects: { templateProgress: 7, skill: 3, morale: 2, reach: 0, marketStrength: 4 } },
                    { text: 'Keep data where decisions happen', effects: { reach: 3, innovation: 4, morale: 4, templateProgress: 3, marketStrength: -3, rollChance: 0.5, roll: { pass: { skill: 3 }, fail: { skill: -4, marketStrength: -5 } } } }
                  ] },
                { id: 'tb14', dept: 'Finance', icon: '⏰', title: 'Patience or Pivot?', phase: 'early',
                  text: 'Results are mixed after 6 months. Should you give the current approach more time, or try something different?',
                  options: [
                    { text: 'Stay the course - give it more time', effects: { templateProgress: 7, morale: -3, reach: -2, marketStrength: 3, rollChance: 0.5, roll: { pass: { skill: 6, templateProgress: 4, marketStrength: 5 }, fail: { profitLoss: -1, morale: -3, marketStrength: -5 } } } },
                    { text: 'Make targeted adjustments', effects: { templateProgress: 6, innovation: 3, skill: 3, reach: 0, marketStrength: 4 } },
                    { text: 'Try a different approach entirely', investment: 1, effects: { innovation: 8, morale: 4, reach: 3, templateProgress: -3, marketStrength: -4, rollChance: 0.5, roll: { pass: { templateProgress: 6, marketStrength: 6 }, fail: { profitLoss: -0.5, marketStrength: -6 } } } }
                  ] },
                { id: 'tb15', dept: 'ops', icon: '🏆', title: 'Proof Points', phase: 'early',
                  text: 'You need evidence that your approach works before scaling. How much proof is enough?',
                  options: [
                    { text: 'Wait for 3 successful replications', effects: { templateProgress: 10, skill: 6, reach: -6, profitLoss: -0.5, marketStrength: 8 }, description: 'Competitors move faster' },
                    { text: 'One strong success plus supporting data', effects: { templateProgress: 7, skill: 3, reach: 2, morale: 2, marketStrength: 5 } },
                    { text: 'Let momentum guide expansion speed', effects: { reach: 6, morale: 4, innovation: 3, templateProgress: 2, marketStrength: -3, rollChance: 0.5, roll: { pass: { profitLoss: 0.5 }, fail: { purpose: -4, skill: -3, marketStrength: -6 } } } }
                  ] }
            ],
            // Venture-specific events
            venture_aqualux: [
                { id: 'aq01', dept: 'ops', icon: '🚿', title: 'Refill Station Reliability', 
                  text: 'Some stations are breaking down frequently. Do you fix the design before adding more locations?',
                  options: [
                    { text: 'Stop rollout, fix the design', effects: { reach: -3, templateProgress: 11, skill: 6 } },
                    { text: 'Fix as you go', cost: 0.8, effects: { reach: 0, templateProgress: 4, morale: -3 } },
                    { text: 'Replace broken units and keep growing', cost: 1.5, effects: { reach: 3, templateProgress: -3, profitLoss: -0.5 } }
                  ] },
                { id: 'aq02', dept: 'Marketing', icon: '🛒', title: 'Shopping Centre vs Transport Hubs', 
                  text: 'Shopping centres want exclusivity deals. Transport hubs offer more footfall. Which should your template focus on?',
                  options: [
                    { text: 'Focus template on shopping centres', effects: { templateProgress: 8, reach: 3, profitLoss: 0.3 } },
                    { text: 'Focus template on transport hubs', effects: { templateProgress: 8, reach: 4, morale: 2 } },
                    { text: 'Two different templates for each', investment: 1, effects: { templateProgress: -3, reach: 4, skill: 3 } }
                  ] },
                { id: 'aq03', dept: 'ops', icon: '🧴', title: 'Brand Partners Wanting Changes', 
                  text: 'A premium brand wants to use your stations but needs customisation. This complicates your standard approach.',
                  options: [
                    { text: 'Decline - keep the template simple', effects: { templateProgress: 6, purpose: 3, reach: -2 } },
                    { text: 'Create a premium tier template', investment: 1, effects: { templateProgress: 3, reach: 4, profitLoss: 0.5 } },
                    { text: 'Customise for this partner only', effects: { reach: 3, templateProgress: -4, profitLoss: 0.3 } }
                  ] },
                { id: 'aq04', dept: 'HR', icon: '👨‍🔧', title: 'Maintenance Team Training', 
                  text: 'Stations need regular maintenance. Train your own team, or rely on local contractors in each area?',
                  options: [
                    { text: 'Build and train an internal team', investment: 1.5, effects: { templateProgress: 10, skill: 6, staffLocal: 10, reach: -2 } },
                    { text: 'Create contractor certification programme', cost: 0.8, effects: { templateProgress: 7, skill: 3, reach: 0 } },
                    { text: 'Use whatever contractors are available locally', effects: { reach: 3, templateProgress: -6, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -6, morale: -4 } } } }
                  ] },
                { id: 'aq05', dept: 'Finance', icon: '♻️', title: 'Plastic Reduction vs Profit Margins', 
                  text: 'You could offer cheaper conventional packaging alongside refills to grow faster, but it undermines your environmental mission.',
                  options: [
                    { text: 'Refills only - stay true to the mission', effects: { purpose: 8, reach: -3, morale: 6, templateProgress: 4 } },
                    { text: 'Offer both but promote refills', effects: { reach: 4, purpose: -3, profitLoss: 0.5, templateProgress: -3 } },
                    { text: 'Whatever customers want to buy', effects: { reach: 7, purpose: -8, profitLoss: 1, morale: -4 } }
                  ] },
                { id: 'aq06', dept: 'Marketing', icon: '🏢', title: 'Corporate vs Consumer Focus', 
                  text: 'Office buildings want bulk refill contracts - stable revenue but less visible impact. Consumers spread the message but are harder to reach.',
                  options: [
                    { text: 'Focus on corporate contracts', effects: { profitLoss: 1, reach: 3, purpose: -4, templateProgress: 6 } },
                    { text: 'Focus on individual consumers', cost: 0.8, effects: { reach: 4, purpose: 7, templateProgress: 3, profitLoss: -0.3 } },
                    { text: 'Develop both channels separately', investment: 1.2, effects: { reach: 4, templateProgress: -4, skill: 3 } }
                  ] },
                { id: 'aq07', dept: 'ops', icon: '🔧', title: 'Station Size Standardisation', 
                  text: 'Different locations want different sized stations. Standard size is easier to scale, but doesn\'t fit every space.',
                  options: [
                    { text: 'One standard size only', effects: { templateProgress: 10, morale: -2 } },
                    { text: 'Three size options with modular design', investment: 1, effects: { templateProgress: 4, reach: 4, innovation: 3 } },
                    { text: 'Custom sizes for each location', effects: { reach: 6, templateProgress: -7, profitLoss: -0.5 } }
                  ] },
                { id: 'aq08', dept: 'tech', icon: '📱', title: 'App Integration Decision', 
                  text: 'Should customers need an app to use stations? Apps give data but create friction. Simple tap-and-go is easier but you learn less.',
                  options: [
                    { text: 'App required - learn from every transaction', investment: 0.8, effects: { templateProgress: 8, skill: 6 } },
                    { text: 'App optional - both paths work', investment: 1.2, effects: { templateProgress: 4, reach: 3, innovation: 3 } },
                    { text: 'No app - maximum simplicity', effects: { reach: 6, templateProgress: -3, skill: -3 } }
                  ] },
                { id: 'aq09', dept: 'Finance', icon: '💰', title: 'Location Revenue Share Model', 
                  text: 'Landlords want higher revenue share as your stations prove successful. Pay more to keep good locations?',
                  options: [
                    { text: 'Accept higher rates for proven locations', effects: { reach: 3, profitLoss: -0.8, templateProgress: 3 } },
                    { text: 'Negotiate hard - our brand brings value', rollChance: 0.5, roll: { pass: { profitLoss: 0.3, morale: 3 }, fail: { reach: -3, morale: -3 } } },
                    { text: 'Move to less premium locations', effects: { reach: 0, profitLoss: 0.3, purpose: -3, templateProgress: -3 } }
                  ] },
                { id: 'aq10', dept: 'ops', icon: '🚚', title: 'Product Supply Logistics', 
                  text: 'How do you keep stations stocked? Centralised supply is cheaper but slower. Local suppliers cost more but are more reliable.',
                  options: [
                    { text: 'Centralised supply hub', investment: 1.5, effects: { templateProgress: 8, profitLoss: 0.5, reach: 2, staffLocal: -10 } },
                    { text: 'Network of local suppliers', cost: 0.8, effects: { staffLocal: 15, reach: 3, purpose: 3, profitLoss: -0.3 } },
                    { text: 'Hybrid model by region', investment: 1, effects: { templateProgress: 4, reach: 3, skill: 3 } }
                  ] },
                { id: 'aq11', dept: 'Marketing', icon: '🌍', title: 'International Expansion Approach', 
                  text: 'European retailers are interested. Enter through franchise partners (fast, less control) or company-owned (slow, full control)?',
                  options: [
                    { text: 'Franchise model for speed', effects: { reach: 7, templateProgress: -6, purpose: -3, profitLoss: 0.3 } },
                    { text: 'Company-owned expansion', investment: 2, effects: { reach: 3, templateProgress: 8, skill: 3 } },
                    { text: 'Test with one strong partner first', investment: 0.8, effects: { reach: 2, templateProgress: 6, skill: 4 } }
                  ] },
                { id: 'aq12', dept: 'HR', icon: '🤝', title: 'Station Attendant Decision', 
                  text: 'Should stations have staff to help customers, or be fully self-service? Staff help adoption but increase costs.',
                  options: [
                    { text: 'Staffed stations initially', cost: 1.2, effects: { reach: 4, purpose: 4, staffLocal: 15, templateProgress: 3 } },
                    { text: 'Self-service with remote support', investment: 0.8, effects: { templateProgress: 7, reach: 2, profitLoss: 0.3 } },
                    { text: 'Staff during launch, transition to self-service', cost: 0.8, effects: { reach: 3, templateProgress: 4, skill: 3 } }
                  ] }
            ],
            venture_frostvale: [
                { id: 'fv01', dept: 'ops', icon: '🧊', title: 'Cold Chain Consistency', 
                  text: 'Temperature control varies between distributors. Product quality is inconsistent in some stores.',
                  options: [
                    { text: 'Limit distribution to reliable partners only', effects: { templateProgress: 8, purpose: 4 } },
                    { text: 'Invest in monitoring technology', investment: 1.2, effects: { templateProgress: 10, skill: 4, reach: 0 } },
                    { text: 'Accept some quality variation', effects: { reach: 3, purpose: -6, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -4, morale: -3 } } } }
                  ] },
                { id: 'fv02', dept: 'Marketing', icon: '🍦', title: 'Recipe Standardisation', 
                  text: 'Local teams want to tweak recipes for local tastes. But that means each market is different.',
                  options: [
                    { text: 'One global recipe - build consistency', effects: { templateProgress: 10, morale: -3 } },
                    { text: 'Core recipe with allowed variations', effects: { templateProgress: 6, reach: 3, innovation: 3 } },
                    { text: 'Let each market develop local flavours', effects: { reach: 4, templateProgress: -7, innovation: 6 } }
                  ] },
                { id: 'fv03', dept: 'Finance', icon: '💰', title: 'Ingredient Costs Rising', 
                  text: 'Key plant-based ingredients have doubled in price. Change recipe, raise prices, or absorb the cost?',
                  options: [
                    { text: 'Reformulate with cheaper ingredients', effects: { profitLoss: 0.5, purpose: -4, templateProgress: -6, innovation: 3 } },
                    { text: 'Raise prices, protect quality', effects: { reach: -3, purpose: 4, profitLoss: 0.3, templateProgress: 3 } },
                    { text: 'Absorb costs while finding solutions', effects: { profitLoss: -1, templateProgress: 3, rollChance: 0.5, roll: { pass: { innovation: 4 }, fail: { profitLoss: -1 } } } }
                  ] },
                { id: 'fv04', dept: 'Marketing', icon: '🏪', title: 'Supermarket Listing Opportunity', 
                  text: 'Major supermarket wants to list you, but requires packaging changes and lower margins.',
                  options: [
                    { text: 'Accept their terms for the reach', effects: { reach: 8, templateProgress: -4, profitLoss: -0.5 } },
                    { text: 'Negotiate to keep your packaging', rollChance: 0.4, roll: { pass: { reach: 7, templateProgress: 3 }, fail: { reach: 0, morale: -3 } } },
                    { text: 'Focus on independent retailers', effects: { reach: 2, templateProgress: 7, purpose: 4 } }
                  ] },
                { id: 'fv05', dept: 'ops', icon: '🌱', title: 'Organic vs Conventional Ingredients', 
                  text: 'Switching to conventional plant ingredients would halve costs. But your brand is built on premium, sustainable sourcing.',
                  options: [
                    { text: 'Stay fully organic - it\'s who we are', effects: { purpose: 8, profitLoss: -0.5, morale: 4, reach: -2 } },
                    { text: 'Mix organic and conventional', effects: { profitLoss: 0.3, purpose: -4, reach: 3, templateProgress: -3 } },
                    { text: 'Go conventional to compete on price', effects: { profitLoss: 1, purpose: -10, reach: 6, morale: -6 } }
                  ] },
                { id: 'fv06', dept: 'HR', icon: '🏭', title: 'Factory Working Conditions', 
                  text: 'To meet demand, you could run 24/7 shifts. Workers are willing but it affects their wellbeing.',
                  options: [
                    { text: 'Limit shifts to protect workers', effects: { purpose: 7, morale: 6, reach: -3, profitLoss: -0.3 } },
                    { text: 'Offer premium pay for extra shifts', cost: 0.8, effects: { reach: 3, morale: 2, purpose: 2 } },
                    { text: 'Run 24/7 to meet demand', effects: { reach: 6, morale: -7, purpose: -6, rollChance: 0.4, roll: { pass: {}, fail: { skill: -4 } } } }
                  ] },
                { id: 'fv07', dept: 'ops', icon: '📦', title: 'Packaging Innovation', 
                  text: 'New compostable packaging is available but costs 40% more. Current packaging works but isn\'t as sustainable.',
                  options: [
                    { text: 'Switch to compostable packaging', cost: 0.8, effects: { purpose: 8, profitLoss: -0.5, reach: 2, innovation: 4 } },
                    { text: 'Phase in gradually as costs fall', effects: { purpose: 3, templateProgress: 3, innovation: 2 } },
                    { text: 'Keep current packaging for now', effects: { profitLoss: 0.3, purpose: -4, reach: 3 } }
                  ] },
                { id: 'fv08', dept: 'Marketing', icon: '🎯', title: 'Health Claims Dilemma', 
                  text: 'Marketing wants to make health claims that are technically accurate but could be seen as misleading. "No added sugar" when it\'s naturally sweet.',
                  options: [
                    { text: 'Avoid borderline claims - stay honest', effects: { purpose: 7, reach: -3, morale: 4 } },
                    { text: 'Use claims competitors use', effects: { reach: 4, purpose: -6, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -6, reach: -3 } } } },
                    { text: 'Invest in third-party certification', investment: 0.5, effects: { purpose: 4, reach: 3, templateProgress: 3 } }
                  ] },
                { id: 'fv09', dept: 'Finance', icon: '🏆', title: 'Premium vs Mass Market Pricing', 
                  text: 'You could lower prices to compete with mainstream ice cream, or stay premium and accept slower growth.',
                  options: [
                    { text: 'Stay premium - quality over volume', effects: { purpose: 6, profitLoss: 0.3, reach: -3, templateProgress: 4 } },
                    { text: 'Lower prices to compete', effects: { reach: 7, profitLoss: -0.5, purpose: -6, morale: -3 } },
                    { text: 'Create an affordable line under different brand', investment: 1.5, effects: { reach: 4, templateProgress: -6, innovation: 3 } }
                  ] },
                { id: 'fv10', dept: 'ops', icon: '🚛', title: 'Distribution Network Decision', 
                  text: 'Build your own cold chain distribution or use existing distributors? Own network gives control but costs much more.',
                  options: [
                    { text: 'Build owned distribution network', investment: 2.5, effects: { templateProgress: 11, reach: 3, skill: 6, profitLoss: -1 } },
                    { text: 'Use established distributors', cost: 0.5, effects: { reach: 6, templateProgress: -3, purpose: -3 } },
                    { text: 'Hybrid - own for key markets', investment: 1.5, effects: { templateProgress: 6, reach: 4, skill: 3 } }
                  ] },
                { id: 'fv11', dept: 'HR', icon: '👨‍🍳', title: 'Food Scientists vs Traditional Skills', 
                  text: 'Hire food scientists to optimise recipes at scale, or artisan ice cream makers who understand craft?',
                  options: [
                    { text: 'Food scientists for scalability', cost: 1, effects: { templateProgress: 8, innovation: 4, purpose: -3, skill: 4 } },
                    { text: 'Artisan makers for authenticity', cost: 0.8, effects: { purpose: 6, morale: 4, templateProgress: 3, reach: -2 } },
                    { text: 'Both - science informed by craft', cost: 1.5, effects: { innovation: 6, purpose: 3, skill: 6, templateProgress: 4 } }
                  ] },
                { id: 'fv12', dept: 'Marketing', icon: '🌍', title: 'Local Sourcing vs Global Efficiency', 
                  text: 'Sourcing ingredients locally in each market supports communities but is expensive. Global sourcing is cheaper.',
                  options: [
                    { text: 'Local sourcing where possible', cost: 0.8, effects: { purpose: 8, staffLocal: 15, profitLoss: -0.5, morale: 4 } },
                    { text: 'Global sourcing for efficiency', effects: { profitLoss: 0.5, templateProgress: 6, purpose: -7, staffLocal: -10 } },
                    { text: 'Local for hero ingredients, global for basics', effects: { purpose: 4, templateProgress: 3, profitLoss: 0, staffLocal: 5 } }
                  ] }
            ],
            venture_puriclean: [
                { id: 'pc01', dept: 'ops', icon: '🚚', title: 'Last Mile Delivery Challenge', 
                  text: 'Getting products to remote communities is expensive and unreliable. Build local assembly, or improve logistics?',
                  options: [
                    { text: 'Set up local assembly points', investment: 2, effects: { templateProgress: 11, staffLocal: 15, reach: 3 } },
                    { text: 'Partner with local NGOs for delivery', cost: 0.5, effects: { templateProgress: 6, purpose: 6, reach: 2 } },
                    { text: 'Focus on easier-to-reach areas first', effects: { reach: 4, purpose: -6, templateProgress: 4 } }
                  ] },
                { id: 'pc02', dept: 'HR', icon: '🎓', title: 'Community Health Worker Training', 
                  text: 'Local health workers could install and maintain units. Creating training takes time but builds local capacity.',
                  options: [
                    { text: 'Develop comprehensive training programme', investment: 1, effects: { templateProgress: 11, skill: 6, purpose: 7, reach: -2 } },
                    { text: 'Basic training only', cost: 0.3, effects: { templateProgress: 4, skill: 2, reach: 2 } },
                    { text: 'Use your own installation teams', cost: 1.5, effects: { reach: 4, templateProgress: 3, staffLocal: -10 } }
                  ] },
                { id: 'pc03', dept: 'Finance', icon: '🏛️', title: 'Government Contract Opportunity', 
                  text: 'Government wants 10,000 units but needs changes to your design. Meeting their specs means reworking your template.',
                  options: [
                    { text: 'Accept and adapt your template', effects: { reach: 8, templateProgress: -6, profitLoss: 0.5 } },
                    { text: 'Propose your standard design instead', rollChance: 0.4, roll: { pass: { reach: 7, templateProgress: 6 }, fail: { reach: 0, morale: -3 } } },
                    { text: 'Decline, focus on NGO partnerships', effects: { reach: 2, templateProgress: 7, purpose: 6 } }
                  ] },
                { id: 'pc04', dept: 'ops', icon: '🔧', title: 'Product Durability Issues', 
                  text: 'Units are failing faster than expected in harsh conditions. Fix the design or improve maintenance training?',
                  options: [
                    { text: 'Redesign for durability', investment: 1.5, effects: { templateProgress: 10, innovation: 4, reach: -3 } },
                    { text: 'Improve maintenance training', cost: 0.8, effects: { templateProgress: 7, skill: 4, purpose: 3 } },
                    { text: 'Replace failed units while learning', cost: 1.2, effects: { reach: 0, templateProgress: 3, purpose: -3 } }
                  ] },
                { id: 'pc05', dept: 'Marketing', icon: '💵', title: 'Subsidised vs Commercial Model', 
                  text: 'You could sell cheaply to those who need it most (low margins), or target commercial buildings (higher margins).',
                  options: [
                    { text: 'Focus on communities in need', effects: { purpose: 10, reach: 3, profitLoss: -1, morale: 6 } },
                    { text: 'Focus on commercial customers', effects: { profitLoss: 1.5, reach: 4, purpose: -8, templateProgress: 4 } },
                    { text: 'Use commercial profits to subsidise community work', investment: 1, effects: { purpose: 6, profitLoss: 0.5, reach: 4, templateProgress: -3 } }
                  ] },
                { id: 'pc06', dept: 'ops', icon: '🌍', title: 'Expand to Harder-to-Reach Areas', 
                  text: 'The communities with the greatest need are the hardest to serve. Expanding there would be expensive and slow.',
                  options: [
                    { text: 'Go where the need is greatest', investment: 2, effects: { purpose: 11, reach: 2, templateProgress: 3, profitLoss: -1.5 } },
                    { text: 'Build capacity in easier areas first', effects: { reach: 4, templateProgress: 8, purpose: -4, morale: -2 } },
                    { text: 'Partner with organisations already working there', cost: 0.8, effects: { purpose: 7, reach: 3, templateProgress: 4, skill: 3 } }
                  ] },
                { id: 'pc07', dept: 'tech', icon: '📱', title: 'Simple vs Smart Technology', 
                  text: 'Add sensors and connectivity to monitor unit health remotely? Helps maintenance but adds cost and complexity.',
                  options: [
                    { text: 'Keep it simple - reliability over features', effects: { templateProgress: 8, purpose: 4, reach: 2, innovation: -3 } },
                    { text: 'Add smart features for monitoring', investment: 1.2, effects: { innovation: 7, skill: 4, templateProgress: 3, reach: -2 } },
                    { text: 'Pilot smart tech in accessible areas only', investment: 0.5, effects: { innovation: 4, templateProgress: 4, skill: 3 } }
                  ] },
                { id: 'pc08', dept: 'Finance', icon: '🤝', title: 'Impact Investor Expectations', 
                  text: 'Impact investors want to see rapid scale to maximise social impact. Your team says rushing will hurt quality.',
                  options: [
                    { text: 'Push back - quality enables lasting impact', effects: { templateProgress: 7, purpose: 6, reach: -3, rollChance: 0.5, roll: { pass: { morale: 4 }, fail: {profitLoss: -0.5 } } } },
                    { text: 'Accelerate while maintaining standards', effects: { reach: 4, templateProgress: -3, morale: -3 } },
                    { text: 'Show impact through depth not just reach', effects: { purpose: 8, templateProgress: 6, reach: -2, skill: 3 } }
                  ] },
                { id: 'pc09', dept: 'HR', icon: '🏘️', title: 'Local Manufacturing Decision', 
                  text: 'Build manufacturing locally to create jobs and reduce costs, or import from established factories for consistency?',
                  options: [
                    { text: 'Local manufacturing - build community capacity', investment: 2.5, effects: { purpose: 10, staffLocal: 20, templateProgress: 6, profitLoss: -0.5 } },
                    { text: 'Import for quality and consistency', cost: 0.5, effects: { templateProgress: 7, reach: 3, purpose: -4, staffLocal: -10 } },
                    { text: 'Local assembly of imported components', investment: 1, effects: { purpose: 6, staffLocal: 10, templateProgress: 4, skill: 3 } }
                  ] },
                { id: 'pc10', dept: 'ops', icon: '💧', title: 'Water Source Challenges', 
                  text: 'Some areas have water quality issues that affect your units. Adapt the design or avoid those areas?',
                  options: [
                    { text: 'Redesign for challenging water conditions', investment: 1.5, effects: { purpose: 8, innovation: 6, templateProgress: 4, reach: 2 } },
                    { text: 'Avoid areas with water quality issues', effects: { reach: 3, purpose: -7, templateProgress: 4, morale: -3 } },
                    { text: 'Partner with water treatment organisations', cost: 0.8, effects: { purpose: 6, reach: 3, skill: 3, templateProgress: 3 } }
                  ] },
                { id: 'pc11', dept: 'Marketing', icon: '📊', title: 'Impact Measurement Approach', 
                  text: 'Funders want rigorous impact measurement. Thorough studies cost money and slow rollout.',
                  options: [
                    { text: 'Comprehensive impact studies', investment: 1, effects: { purpose: 7, skill: 6, templateProgress: 6, reach: -3 } },
                    { text: 'Simple metrics and case studies', cost: 0.3, effects: { reach: 3, purpose: 3, templateProgress: 3 } },
                    { text: 'Partner with universities for research', effects: { purpose: 4, skill: 4, innovation: 3, rollChance: 0.5, roll: { pass: { reach: 2 }, fail: { reach: -2 } } } }
                  ] },
                { id: 'pc12', dept: 'Finance', icon: '🎁', title: 'Donation vs Sales Model', 
                  text: 'Should units be donated (maximum reach to poorest) or sold at subsidised prices (sustainable but less accessible)?',
                  options: [
                    { text: 'Free distribution to those in need', effects: { purpose: 11, reach: 4, profitLoss: -2, templateProgress: -3 } },
                    { text: 'Subsidised sales for sustainability', effects: { purpose: 4, profitLoss: 0.3, reach: 3, templateProgress: 6 } },
                    { text: 'Tiered pricing based on ability to pay', investment: 0.5, effects: { purpose: 7, reach: 4, templateProgress: 3, skill: 3 } }
                  ] }
            ],
            venture_mindspring: [
                { id: 'ms01', dept: 'tech', icon: '🤖', title: 'AI Accuracy vs Speed', 
                  text: 'Your AI recommendations are good but slow. Faster responses mean less accuracy. Which matters more for scaling?',
                  options: [
                    { text: 'Prioritise accuracy - get it right', effects: { templateProgress: 8, skill: 6 } },
                    { text: 'Prioritise speed - users expect quick', effects: { reach: 4, templateProgress: -3, rollChance: 0.5, roll: { pass: { innovation: 3 }, fail: { purpose: -6 } } } },
                    { text: 'Invest in both', investment: 1.5, effects: { templateProgress: 6, innovation: 6, skill: 3 } }
                  ] },
                { id: 'ms02', dept: 'Marketing', icon: '💼', title: 'Enterprise Sales Approach', 
                  text: 'Each enterprise customer wants customisation. Building a standard approach is hard when everyone wants something different.',
                  options: [
                    { text: 'Create a fixed product, no customisation', effects: { templateProgress: 10, morale: -2 } },
                    { text: 'Modular approach with set options', investment: 1, effects: { templateProgress: 7, reach: 3, innovation: 3 } },
                    { text: 'Customise for each customer', effects: { reach: 4, templateProgress: -8, skill: -3, profitLoss: 0.3 } }
                  ] },
                { id: 'ms03', dept: 'HR', icon: '🧘', title: 'Coach Quality Control', 
                  text: 'Your human coaches vary in quality. Standardise their approach or let their individual styles shine?',
                  options: [
                    { text: 'Standard coaching methodology', investment: 0.8, effects: { templateProgress: 10, skill: 6, morale: -3 } },
                    { text: 'Guidelines with room for personal style', effects: { templateProgress: 6, morale: 3, innovation: 2 } },
                    { text: 'Rely more on AI, less on humans', investment: 1, effects: { templateProgress: 7, innovation: 6, purpose: -4, staffLocal: -10 } }
                  ] },
                { id: 'ms04', dept: 'ops', icon: '📊', title: 'Measuring Wellbeing Impact', 
                  text: 'Clients want proof your platform works. Building proper measurement takes time away from features.',
                  options: [
                    { text: 'Build comprehensive impact measurement', investment: 1, effects: { templateProgress: 11, purpose: 7, skill: 4 } },
                    { text: 'Use quick surveys and testimonials', effects: { templateProgress: 4, reach: 3, purpose: 2 } },
                    { text: 'Focus on features, let results speak', effects: { reach: 4, innovation: 3, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -6, reach: -3 } } } }
                  ] },
                { id: 'ms05', dept: 'Finance', icon: '📈', title: 'Engagement vs Wellbeing Metrics', 
                  text: 'Investors want to see daily active users. But getting people "hooked" on the app may not be healthy for them.',
                  options: [
                    { text: 'Optimise for genuine wellbeing outcomes', effects: { purpose: 10, reach: -3, morale: 6, profitLoss: -0.5 } },
                    { text: 'Balance engagement and wellbeing', effects: { purpose: 3, reach: 3, templateProgress: 3 } },
                    { text: 'Optimise for engagement metrics', effects: { reach: 7, profitLoss: 1, purpose: -8, morale: -4 } }
                  ] },
                { id: 'ms06', dept: 'Marketing', icon: '🏥', title: 'Clinical vs Consumer Positioning', 
                  text: 'You could position as a clinical tool (slower sales, higher trust) or consumer wellness app (faster growth, less impact).',
                  options: [
                    { text: 'Clinical positioning with evidence base', investment: 1.5, effects: { purpose: 8, templateProgress: 8, reach: -3, skill: 4 } },
                    { text: 'Consumer wellness positioning', effects: { reach: 7, purpose: -6, profitLoss: 0.5, templateProgress: -3 } },
                    { text: 'Different products for each market', investment: 2, effects: { reach: 4, innovation: 4, templateProgress: -6 } }
                  ] },
                { id: 'ms07', dept: 'tech', icon: '🔐', title: 'Data Privacy vs Personalisation', 
                  text: 'More user data means better recommendations, but mental health data is sensitive. How much should you collect?',
                  options: [
                    { text: 'Minimal data - maximum privacy', effects: { purpose: 8, reach: -3, innovation: -3, morale: 4 } },
                    { text: 'Balanced collection with strong consent', investment: 0.5, effects: { purpose: 4, innovation: 4, templateProgress: 4, skill: 3 } },
                    { text: 'Collect what competitors collect', effects: { reach: 4, innovation: 6, purpose: -7, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -6, morale: -4 } } } }
                  ] },
                { id: 'ms08', dept: 'HR', icon: '👩‍⚕️', title: 'Therapist Licensing Across Markets', 
                  text: 'Expanding internationally means navigating different licensing requirements for mental health professionals.',
                  options: [
                    { text: 'Only use locally licensed professionals', cost: 1.2, effects: { purpose: 7, templateProgress: 6, reach: -3, staffLocal: 15 } },
                    { text: 'Use a mix of licensed and unlicensed "coaches"', effects: { reach: 6, purpose: -8, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -8, reach: -4 } } } },
                    { text: 'Focus AI-only product in restricted markets', investment: 1, effects: { innovation: 7, reach: 3, templateProgress: -3, purpose: -3 } }
                  ] },
                { id: 'ms09', dept: 'ops', icon: '🌐', title: 'Localisation of Content', 
                  text: 'Mental health approaches vary by culture. How much should you adapt content for each market?',
                  options: [
                    { text: 'Deep cultural adaptation for each market', investment: 1.5, effects: { purpose: 8, reach: 3, templateProgress: -6, staffLocal: 10 } },
                    { text: 'Core content with surface localisation', cost: 0.5, effects: { templateProgress: 7, reach: 4, purpose: -3 } },
                    { text: 'Universal approach - mental health is universal', effects: { templateProgress: 8, reach: 6, purpose: -6, rollChance: 0.4, roll: { pass: {}, fail: { reach: -4, morale: -3 } } } }
                  ] },
                { id: 'ms10', dept: 'Finance', icon: '💰', title: 'Freemium vs Premium Model', 
                  text: 'Free tier drives adoption but premium conversion is low. Paywall more features, or keep helping people for free?',
                  options: [
                    { text: 'Generous free tier - access matters', effects: { purpose: 8, reach: 4, profitLoss: -1, morale: 4 } },
                    { text: 'Aggressive premium upselling', effects: { profitLoss: 1.5, reach: 3, purpose: -7, morale: -3 } },
                    { text: 'Employer-paid model only', effects: { profitLoss: 0.8, templateProgress: 8, purpose: 3 } }
                  ] },
                { id: 'ms11', dept: 'Marketing', icon: '🎯', title: 'Target Burnout or Broader Wellness?', 
                  text: 'Focus on corporate burnout prevention (clear ROI) or broader mental wellness (bigger market, harder to measure)?',
                  options: [
                    { text: 'Focus on burnout - clear corporate value', effects: { templateProgress: 8, reach: 3, profitLoss: 0.5, purpose: -3 } },
                    { text: 'Broad wellness platform', effects: { reach: 6, purpose: 4, templateProgress: -4, rollChance: 0.5, roll: { pass: { innovation: 3 }, fail: { profitLoss: -0.5 } } } },
                    { text: 'Start narrow, expand over time', effects: { templateProgress: 7, reach: 2, skill: 4, purpose: 2 } }
                  ] },
                { id: 'ms12', dept: 'ops', icon: '⏰', title: 'Always-On Support Expectation', 
                  text: 'Users in crisis need help at 3am. Offer 24/7 support (expensive) or set boundaries (some will fall through cracks)?',
                  options: [
                    { text: '24/7 human support', cost: 1.5, effects: { purpose: 10, morale: -4, staffLocal: 10, profitLoss: -1 } },
                    { text: 'AI support with human escalation', investment: 1, effects: { purpose: 6, innovation: 6, templateProgress: 4 } },
                    { text: 'Clear boundaries with crisis resources', effects: { purpose: 3, templateProgress: 7, profitLoss: 0.3, morale: 3 } }
                  ] }
            ],
            personality: [
                { id: 'per01', dept: 'Finance', icon: '💡', title: 'Chen Wei Wants to Experiment', 
                  text: 'Chen Wei proposes testing a completely new approach in one market. Could learn a lot, but delays the main template.',
                  condition: () => state.leadershipTeam.finance === 'fin3', 
                  options: [
                    { text: 'Allow the experiment', investment: 0.5, effects: { innovation: 6, templateProgress: -3, rollChance: 0.6, roll: { pass: { templateProgress: 6 }, fail: { morale: -3 } } } },
                    { text: 'Finish the main template first', effects: { templateProgress: 6, innovation: -3, morale: -2 } }
                  ] },
                { id: 'per02', dept: 'ops', icon: '🚀', title: 'Maria Wants to Move Faster', 
                  text: 'Maria argues you\'re being too careful. "Competitors aren\'t waiting for perfect templates."',
                  condition: () => state.leadershipTeam.ops === 'ops2', 
                  options: [
                    { text: 'Speed up, accept more risk', effects: { reach: 6, templateProgress: -4, rollChance: 0.5, roll: { pass: { morale: 3 }, fail: { purpose: -6, skill: -3 } } } },
                    { text: 'Stay methodical, explain why', effects: { templateProgress: 7, morale: -3, reach: -2 } }
                  ] },
                { id: 'per03', dept: 'tech', icon: '🔧', title: 'Raj\'s System Overhaul Plan', 
                  text: 'Raj presents a plan to rebuild all systems properly. It would create a much better template, but delays growth by 6 months.',
                  condition: () => state.leadershipTeam.tech === 'tech2', 
                  options: [
                    { text: 'Approve the rebuild', investment: 1.5, effects: { templateProgress: 14, skill: 7, reach: -4 } },
                    { text: 'Do it in phases alongside growth', investment: 0.8, effects: { templateProgress: 7, skill: 3, reach: 0 } },
                    { text: 'Keep current systems for now', effects: { reach: 3, skill: -3, morale: -4 } }
                  ] },
                { id: 'per04', dept: 'HR', icon: '📚', title: 'Fatima\'s Training Academy Proposal', 
                  text: 'Fatima wants to build a proper training academy. "Every new hire should learn the same way."',
                  condition: () => state.leadershipTeam.hr === 'hr1', 
                  options: [
                    { text: 'Build the training academy', investment: 1.2, effects: { templateProgress: 11, skill: 8, morale: 4, reach: -3 } },
                    { text: 'Start smaller with key programmes', cost: 0.5, effects: { templateProgress: 6, skill: 4, morale: 3 } },
                    { text: 'Learn on the job is fine', effects: { reach: 3, skill: -3, morale: -4, templateProgress: -3 } }
                  ] },
                { id: 'per05', dept: 'Marketing', icon: '📖', title: 'Mei\'s Brand Guidelines Project', 
                  text: 'Mei wants to create comprehensive brand guidelines. "Consistency builds trust at scale."',
                  condition: () => state.leadershipTeam.marketing === 'mkt3', 
                  options: [
                    { text: 'Full brand guidelines project', investment: 0.8, effects: { templateProgress: 8, purpose: 6, skill: 3 } },
                    { text: 'Basic guidelines only', cost: 0.2, effects: { templateProgress: 4, purpose: 3 } },
                    { text: 'Let creativity flow freely', effects: { innovation: 4, templateProgress: -4, purpose: -2 } }
                  ] }
            ],
            // Competitor events - assigned to relevant departments
            // LATE PHASE: Competition Events - primarily month 6 onwards
            competitors: [
                { id: 'comp01', dept: 'ops', icon: '⚔️', title: 'Competitor Copies Your Approach', phase: 'late',
                  text: 'A well-funded competitor has copied your template almost exactly. They\'re now scaling faster because they skipped your learning phase.',
                  options: [
                    { text: 'Accelerate to stay ahead', investment: 1.5, effects: { reach: 4, templateProgress: -6, rollChance: 0.5, roll: { pass: { morale: 3 }, fail: { morale: -6, skill: -3 } } } },
                    { text: 'Innovate - make your template better', investment: 1, effects: { innovation: 7, templateProgress: 6, reach: -2 } },
                    { text: 'Focus on execution quality they can\'t copy', effects: { templateProgress: 8, skill: 4, purpose: 3 } }
                  ] },
                { id: 'comp02', dept: 'HR', icon: '🎯', title: 'Competitor Poaching Your Staff', phase: 'late',
                  text: 'A competitor is offering 30% higher salaries to your trained staff. They want your template knowledge.',
                  options: [
                    { text: 'Match their offers for key people', cost: 1.2, effects: { skill: 3, morale: 3, profitLoss: -0.5 } },
                    { text: 'Let them go, document everything first', effects: { templateProgress: 7, skill: -4, morale: -3 } },
                    { text: 'Build loyalty through purpose and culture', effects: { purpose: 4, morale: 4, rollChance: 0.5, roll: { pass: { skill: 2 }, fail: { skill: -6 } } } }
                  ] },
                { id: 'comp04', dept: 'Marketing', icon: '🏃', title: 'First Mover Advantage Slipping', phase: 'late',
                  text: 'You were first to market, but competitors are catching up. Your template is good but they\'re iterating faster.',
                  options: [
                    { text: 'Double down on template perfection', investment: 1, effects: { templateProgress: 10, skill: 4 } },
                    { text: 'Speed up even if quality suffers', effects: { reach: 6, templateProgress: -4, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -6, morale: -4 } } } },
                    { text: 'Find a niche competitors aren\'t serving', effects: { reach: 2, purpose: 4, innovation: 6, templateProgress: 3 } }
                  ] },
                { id: 'comp05', dept: 'Finance', icon: '🤝', title: 'Competitor Wants to Partner', phase: 'late',
                  text: 'Your biggest competitor proposes merging operations in one market. Would share learnings but also share control.',
                  options: [
                    { text: 'Accept - learn from each other', effects: { skill: 6, reach: 4, templateProgress: -6, innovation: -3 } },
                    { text: 'Decline - protect your approach', effects: { templateProgress: 4, morale: 3, reach: -2 } },
                    { text: 'Counter-propose: share data only', rollChance: 0.5, roll: { pass: { skill: 4, templateProgress: 3 }, fail: { reach: -3, morale: -2 } } }
                  ] },
                { id: 'comp06', dept: 'Marketing', icon: '📰', title: 'Competitor\'s Public Failure', phase: 'late',
                  text: 'A competitor scaled too fast and had a public disaster. Media is questioning the whole industry.',
                  options: [
                    { text: 'Distance yourself publicly', effects: { purpose: 3, reach: -3, morale: 2 } },
                    { text: 'Use it to show your careful approach', cost: 0.3, effects: { purpose: 6, templateProgress: 4, reach: 2 } },
                    { text: 'Help them quietly - industry reputation matters', effects: { purpose: 7, morale: 4, reach: -2, skill: 2 } }
                  ] },
                { id: 'comp07', dept: 'HR', icon: '🔍', title: 'Competitor Intelligence Opportunity', phase: 'late',
                  text: 'A former competitor employee offers to share detailed information about their template and plans.',
                  options: [
                    { text: 'Accept the information', effects: { skill: 4, templateProgress: 3, purpose: -7, rollChance: 0.3, roll: { pass: {}, fail: { purpose: -6, morale: -4 } } } },
                    { text: 'Decline on ethical grounds', effects: { purpose: 6, morale: 4 } },
                    { text: 'Hire them but don\'t ask about competitor secrets', cost: 0.8, effects: { skill: 3, purpose: 2, morale: 2 } }
                  ] },
                { id: 'comp08', dept: 'Marketing', icon: '🌍', title: 'Competitor Enters Your Best Market', phase: 'late',
                  text: 'A major competitor just launched in the market where your template works best. Direct competition begins.',
                  options: [
                    { text: 'Defend aggressively - outspend them', investment: 2, effects: { reach: 3, profitLoss: -1, rollChance: 0.6, roll: { pass: { morale: 4 }, fail: { morale: -4, reach: -3 } } } },
                    { text: 'Focus on service quality they can\'t match', effects: { templateProgress: 6, purpose: 4, skill: 3 } },
                    { text: 'Expand to new markets instead', investment: 1.5, effects: { reach: 4, templateProgress: -3, morale: 2 } }
                  ] }
            ],
            // LATE PHASE: Corporate alignment events - primarily month 6 onwards
            corporate: [
                { id: 'corp01', dept: 'Finance', icon: '🏢', title: 'Parent Company Wants Faster Results', phase: 'late', 
                  text: 'Corporate headquarters is pushing for faster expansion. They don\'t understand why template building takes time.',
                  options: [
                    { text: 'Push back - explain the approach', effects: { templateProgress: 6, morale: 3, rollChance: 0.5, roll: { pass: { purpose: 3 }, fail: {profitLoss: -1, morale: -3 } } } },
                    { text: 'Compromise - accelerate slightly', effects: { reach: 3, templateProgress: -3, morale: -2 } },
                    { text: 'Follow orders - scale now', effects: { reach: 6, templateProgress: -8, rollChance: 0.4, roll: { pass: { profitLoss: 0.5 }, fail: { purpose: -6, morale: -6 } } } }
                  ] },
                { id: 'corp04', dept: 'Finance', icon: '👔', title: 'Corporate Leadership Changes', 
                  text: 'New leadership at corporate doesn\'t understand your venture. They\'re questioning why results aren\'t faster.',
                  options: [
                    { text: 'Invest time in educating new leadership', effects: { templateProgress: 3, rollChance: 0.6, roll: { pass: { morale: 4, profitLoss: 0.5 }, fail: { morale: -3 } } } },
                    { text: 'Show quick wins to build credibility', effects: { reach: 3, templateProgress: -4, morale: -2 } },
                    { text: 'Keep head down, focus on execution', effects: { templateProgress: 4, morale: -3, rollChance: 0.4, roll: { pass: {}, fail: {profitLoss: -1 } } } }
                  ] },
                { id: 'corp05', dept: 'ops', icon: '💼', title: 'Corporate Synergy Push', 
                  text: 'Corporate wants you to collaborate with another business unit. Could help scale, but their approach is very different.',
                  options: [
                    { text: 'Full collaboration', effects: { reach: 6, templateProgress: -7, innovation: -3, skill: 2 } },
                    { text: 'Limited pilot project', investment: 0.5, effects: { reach: 2, templateProgress: 2, skill: 3 } },
                    { text: 'Decline politely', effects: { templateProgress: 4, morale: 3, rollChance: 0.5, roll: { pass: {}, fail: {profitLoss: -0.5, morale: -3 } } } }
                  ] },
                { id: 'corp06', dept: 'Finance', icon: '📈', title: 'Corporate Cost Review', 
                  text: 'Annual cost review. Corporate is cutting spending. Your template investment looks expensive compared to other units.',
                  options: [
                    { text: 'Defend investment with data', effects: { rollChance: 0.5, roll: { pass: { morale: 4, templateProgress: 3 }, fail: {profitLoss: -1.5, morale: -4 } } } },
                    { text: 'Offer modest cuts proactively', effects: { profitLoss: -0.5, templateProgress: -3, morale: 2 } },
                    { text: 'Accept cuts, find efficiencies', effects: { profitLoss: -1, innovation: 3, skill: 2 } }
                  ] },
                { id: 'corp07', dept: 'Marketing', icon: '🎯', title: 'Corporate Strategy Shift', 
                  text: 'Parent company is pivoting strategy. Your venture doesn\'t fit the new direction as well as before.',
                  options: [
                    { text: 'Adapt to align with new strategy', effects: { templateProgress: -6, purpose: -4, reach: 3, morale: -3 } },
                    { text: 'Argue for staying the course', rollChance: 0.4, roll: { pass: { purpose: 6, morale: 6 }, fail: {profitLoss: -1, morale: -6 } } },
                    { text: 'Find ways to connect your mission to their goals', effects: { purpose: 3, templateProgress: 3, skill: 3 } }
                  ] },
                { id: 'corp08', dept: 'ops', icon: '🌐', title: 'Corporate Global Standards', 
                  text: 'Corporate is implementing global standards across all ventures. Some conflict with local adaptations in your template.',
                  options: [
                    { text: 'Adopt global standards fully', effects: { templateProgress: -4, staffLocal: -10, morale: -3 } },
                    { text: 'Request exemptions for key local practices', rollChance: 0.5, roll: { pass: { templateProgress: 3, staffLocal: 5 }, fail: { morale: -4, staffLocal: -5 } } },
                    { text: 'Implement standards with local workarounds', effects: { templateProgress: 2, innovation: 3, skill: 2 } }
                  ] }
            ],
            // CORPORATE TENSIONS: Ongoing friction between venture and parent organization
            corporate_tensions: [
                { id: 'ctens01', dept: 'tech', icon: '💻', title: 'Corporate IT Demands Standardisation',
                  text: 'Corporate IT insists you migrate to their approved software stack. Your team built the prototype on different tools they know well.',
                  options: [
                    { text: 'Migrate to corporate systems', investment: 1.2, effects: { templateProgress: -6, morale: -5, skill: -3 } },
                    { text: 'Request an exception with business case', rollChance: 0.5, roll: { pass: { morale: 4, templateProgress: 3 }, fail: { morale: -4, profitLoss: -0.5 } } },
                    { text: 'Run shadow IT quietly', effects: { innovation: 4, morale: 3, rollChance: 0.3, roll: { pass: {}, fail: { profitLoss: -1, morale: -6, skill: -4 } } } }
                  ] },
                { id: 'ctens02', dept: 'HR', icon: '👥', title: 'Corporate HR Blocks Your Hire',
                  text: 'You found the perfect candidate but Corporate HR says they don\'t meet the standard job grade requirements. They want you to hire from the approved candidate pool instead.',
                  options: [
                    { text: 'Accept HR\'s candidate', effects: { skill: -4, morale: -3, templateProgress: -2 } },
                    { text: 'Escalate to fight for your candidate', rollChance: 0.4, roll: { pass: { skill: 5, morale: 4, innovation: 3 }, fail: { morale: -5, profitLoss: -0.3 } } },
                    { text: 'Hire them as a contractor instead', cost: 0.6, effects: { skill: 3, innovation: 2, morale: 2 } }
                  ] },
                { id: 'ctens03', dept: 'Finance', icon: '✂️', title: 'Corporate Downsizing Hits Your Team',
                  text: 'Company-wide 10% headcount reduction. Corporate says your venture must participate. Losing people now would cripple your template development.',
                  options: [
                    { text: 'Accept cuts, lose key people', effects: { skill: -8, morale: -10, templateProgress: -6, profitLoss: 0.8 } },
                    { text: 'Fight for exemption based on growth potential', rollChance: 0.4, roll: { pass: { morale: 6, purpose: 4 }, fail: { morale: -8, skill: -6, profitLoss: 0.5 } } },
                    { text: 'Offer to cut costs elsewhere instead', effects: { profitLoss: -1, morale: -2, innovation: -3 } }
                  ] },
                { id: 'ctens04', dept: 'ops', icon: '🏢', title: 'Another Division Wants Your Resources',
                  text: 'A larger, more established division is lobbying to absorb your budget and team. They claim they can deliver results faster.',
                  options: [
                    { text: 'Defend your independence fiercely', rollChance: 0.5, roll: { pass: { morale: 8, purpose: 5, templateProgress: 4 }, fail: { profitLoss: -1.5, morale: -6 } } },
                    { text: 'Propose a partnership instead', effects: { reach: 2, templateProgress: -3, innovation: -2, morale: -2 } },
                    { text: 'Accept partial integration', effects: { reach: 4, purpose: -6, innovation: -5, templateProgress: -5 } }
                  ] },
                { id: 'ctens05', dept: 'HR', icon: '🎯', title: 'Corporate Poaching Your Best People',
                  text: 'The main business unit is recruiting your top performers. They can offer higher grades and clearer career paths.',
                  options: [
                    { text: 'Let them go gracefully', effects: { skill: -6, morale: -4, templateProgress: -4 } },
                    { text: 'Counter-offer with equity/mission pitch', effects: { purpose: 3, morale: 3, rollChance: 0.5, roll: { pass: { skill: 2 }, fail: { skill: -4, profitLoss: -0.5 } } } },
                    { text: 'Escalate to executive sponsor', rollChance: 0.4, roll: { pass: { morale: 5, skill: 3 }, fail: { morale: -6 } } }
                  ] },
                { id: 'ctens06', dept: 'Finance', icon: '📋', title: 'Buried in Corporate Reporting',
                  text: 'Corporate requires 15 different reports monthly. Your small team spends 2 days a week just on compliance paperwork.',
                  options: [
                    { text: 'Comply fully, absorb the overhead', effects: { templateProgress: -4, morale: -5, innovation: -3 } },
                    { text: 'Hire admin support and automate what you can', cost: 0.6, effects: { morale: 3, skill: 2, innovation: 2 } },
                    { text: 'Push back and negotiate reduced reporting', rollChance: 0.5, roll: { pass: { morale: 4, templateProgress: 3, innovation: 2 }, fail: { morale: -4 } } }
                  ] },
                { id: 'ctens07', dept: 'tech', icon: '🔒', title: 'Corporate Security Audit',
                  text: 'Corporate security found "unapproved tools" in your tech stack. They\'re threatening to shut down your systems until you comply.',
                  options: [
                    { text: 'Full compliance immediately', investment: 0.8, effects: { templateProgress: -5, morale: -4, innovation: -4 } },
                    { text: 'Negotiate transition timeline', effects: { templateProgress: -2, morale: -2, rollChance: 0.6, roll: { pass: { innovation: 2 }, fail: { profitLoss: -0.5 } } } },
                    { text: 'Get executive air cover', rollChance: 0.4, roll: { pass: { morale: 5, innovation: 3 }, fail: { profitLoss: -1, morale: -5 } } }
                  ] },
                { id: 'ctens08', dept: 'HR', icon: '📊', title: 'Forced to Use Corporate Performance System',
                  text: 'Corporate HR mandates their performance review system. It\'s designed for stable operations, not startup-like ventures where roles evolve weekly.',
                  options: [
                    { text: 'Adopt it fully', effects: { morale: -6, innovation: -4, skill: -2 } },
                    { text: 'Use it on paper, run your own system too', effects: { morale: -2, skill: 2, rollChance: 0.3, roll: { pass: {}, fail: { morale: -4 } } } },
                    { text: 'Propose venture-appropriate modifications', rollChance: 0.4, roll: { pass: { morale: 4, innovation: 3, skill: 3 }, fail: { morale: -3 } } }
                  ] },
                { id: 'ctens09', dept: 'Finance', icon: '💰', title: 'Budget Frozen Mid-Year',
                  text: 'Corporate has frozen all discretionary spending due to a bad quarter. Your planned template investments are now on hold.',
                  options: [
                    { text: 'Pause and wait it out', effects: { templateProgress: -5, morale: -4, reach: -2 } },
                    { text: 'Find creative workarounds', effects: { innovation: 4, skill: 3, rollChance: 0.5, roll: { pass: { templateProgress: 3 }, fail: { morale: -3 } } } },
                    { text: 'Use personal network to find angel funding', rollChance: 0.3, roll: { pass: { profitLoss: 2, morale: 5 }, fail: { purpose: -4, morale: -3 } } }
                  ] },
                { id: 'ctens10', dept: 'ops', icon: '🏭', title: 'Forced to Use Corporate Suppliers',
                  text: 'Procurement insists you use approved corporate suppliers. They\'re cheaper at scale but don\'t understand your venture\'s unique needs.',
                  options: [
                    { text: 'Switch to corporate suppliers', effects: { profitLoss: 0.3, templateProgress: -4, innovation: -3, marketStrength: -5 } },
                    { text: 'Keep current suppliers, pay the premium', cost: 0.5, effects: { templateProgress: 2, marketStrength: 3 } },
                    { text: 'Negotiate supplier exception', rollChance: 0.5, roll: { pass: { morale: 3, templateProgress: 2 }, fail: { profitLoss: -0.3, morale: -3 } } }
                  ] },
                { id: 'ctens11', dept: 'Marketing', icon: '🎨', title: 'Corporate Brand Guidelines Conflict',
                  text: 'Corporate marketing says your venture\'s brand doesn\'t align with company guidelines. They want to redesign everything to match the corporate look.',
                  options: [
                    { text: 'Accept corporate rebrand', investment: 0.6, effects: { purpose: -5, innovation: -4, morale: -3, marketStrength: -6 } },
                    { text: 'Fight to keep your brand identity', rollChance: 0.4, roll: { pass: { purpose: 5, morale: 6, marketStrength: 4 }, fail: { morale: -4 } } },
                    { text: 'Propose "endorsed by" sub-brand approach', effects: { purpose: 2, morale: 2, marketStrength: 2 } }
                  ] },
                { id: 'ctens12', dept: 'Finance', icon: '📈', title: 'Corporate Wants You to Hit Quarterly Targets',
                  text: 'End of quarter. Corporate is pressuring all units to pull revenue forward. Your venture could hit the number but it would mean cutting corners.',
                  options: [
                    { text: 'Hit the number, worry about quality later', effects: { profitLoss: 1, templateProgress: -6, marketStrength: -8, morale: -3 } },
                    { text: 'Miss the target, protect the template', effects: { templateProgress: 4, purpose: 3, rollChance: 0.4, roll: { pass: { morale: 3 }, fail: { profitLoss: -0.5, morale: -4 } } } },
                    { text: 'Negotiate a realistic target for next quarter', rollChance: 0.5, roll: { pass: { morale: 4, templateProgress: 2 }, fail: { morale: -3 } } }
                  ] },
                { id: 'ctens13', dept: 'HR', icon: '🚪', title: 'Corporate Reorganisation',
                  text: 'Major corporate restructure. Your venture might report to a new division that doesn\'t understand or value your mission.',
                  options: [
                    { text: 'Accept new reporting line', effects: { purpose: -4, morale: -5, innovation: -3 } },
                    { text: 'Lobby to stay with current sponsor', rollChance: 0.4, roll: { pass: { morale: 6, purpose: 4 }, fail: { morale: -6, purpose: -3 } } },
                    { text: 'Propose spinning out as separate entity', rollChance: 0.3, roll: { pass: { purpose: 8, innovation: 6, morale: 8 }, fail: { profitLoss: -1, morale: -5 } } }
                  ] },
                { id: 'ctens14', dept: 'tech', icon: '☁️', title: 'Corporate Cloud Migration Mandate',
                  text: 'Corporate IT is moving everything to their chosen cloud provider. Your systems would need significant rework to migrate.',
                  options: [
                    { text: 'Migrate now, take the hit', investment: 1.5, effects: { templateProgress: -8, skill: -4, morale: -5 } },
                    { text: 'Negotiate delayed timeline', effects: { templateProgress: -2, rollChance: 0.5, roll: { pass: { morale: 3 }, fail: { profitLoss: -0.5, morale: -3 } } } },
                    { text: 'Build migration into template roadmap', effects: { templateProgress: 3, skill: 4, innovation: 2 } }
                  ] },
                { id: 'ctens15', dept: 'ops', icon: '📞', title: 'Corporate Shared Services Push',
                  text: 'Corporate wants you to use shared services for HR, Finance, and IT. It\'s cheaper but means less control and slower response times.',
                  options: [
                    { text: 'Move to shared services fully', effects: { profitLoss: 0.5, morale: -6, skill: -4, innovation: -3 } },
                    { text: 'Keep critical functions in-house', cost: 0.4, effects: { morale: 2, skill: 2, innovation: 2 } },
                    { text: 'Hybrid approach - non-critical to shared', effects: { profitLoss: 0.2, morale: -2, skill: -1 } }
                  ] },
                { id: 'ctens16', dept: 'Finance', icon: '🎪', title: 'Corporate Strategy Day Presentation',
                  text: 'You\'ve been asked to present your venture at Corporate Strategy Day. Great visibility, but executives expect polished results, not work-in-progress.',
                  options: [
                    { text: 'Present honestly - show the template journey', effects: { purpose: 4, rollChance: 0.5, roll: { pass: { morale: 6, profitLoss: 1 }, fail: { morale: -5 } } } },
                    { text: 'Polish the story, emphasise wins', effects: { morale: 2, rollChance: 0.4, roll: { pass: { profitLoss: 0.5 }, fail: { purpose: -4, morale: -3 } } } },
                    { text: 'Decline the invitation', effects: { morale: -2, rollChance: 0.3, roll: { pass: { templateProgress: 3 }, fail: { profitLoss: -0.5 } } } }
                  ] },
                { id: 'ctens17', dept: 'HR', icon: '💼', title: 'Corporate Salary Bands Don\'t Fit',
                  text: 'Your star performer is underpaid vs market but already at the top of their corporate salary band. They\'re getting external offers.',
                  options: [
                    { text: 'Let them go, wish them well', effects: { skill: -7, morale: -5, templateProgress: -4 } },
                    { text: 'Create a special role to justify higher band', rollChance: 0.5, roll: { pass: { skill: 3, morale: 5 }, fail: { morale: -4, profitLoss: -0.3 } } },
                    { text: 'Offer equity/bonus outside normal structure', cost: 0.4, effects: { skill: 2, morale: 4, innovation: 2 } }
                  ] },
                { id: 'ctens18', dept: 'Marketing', icon: '📢', title: 'Corporate Comms Wants to Control Your Messaging',
                  text: 'Corporate Communications insists all external messaging goes through them. A 3-week approval process for every blog post and press release.',
                  options: [
                    { text: 'Follow the process', effects: { morale: -4, innovation: -3, marketStrength: -4 } },
                    { text: 'Push for expedited venture approval track', rollChance: 0.5, roll: { pass: { morale: 4, marketStrength: 3 }, fail: { morale: -3 } } },
                    { text: 'Stay under the radar, communicate less', effects: { marketStrength: -2, morale: 2 } }
                  ] },
                { id: 'ctens19', dept: 'ops', icon: '⚖️', title: 'Corporate Legal Slows Everything Down',
                  text: 'Legal review is required for all new partnerships. Your innovative supplier deal has been stuck in legal for 6 weeks.',
                  options: [
                    { text: 'Wait for legal approval', effects: { templateProgress: -4, morale: -3, reach: -2 } },
                    { text: 'Escalate urgency to General Counsel', rollChance: 0.4, roll: { pass: { morale: 4, templateProgress: 2 }, fail: { morale: -4 } } },
                    { text: 'Restructure deal to avoid legal triggers', effects: { innovation: 3, skill: 2, rollChance: 0.5, roll: { pass: { templateProgress: 3 }, fail: { profitLoss: -0.5 } } } }
                  ] },
                { id: 'ctens20', dept: 'Finance', icon: '🏛️', title: 'Corporate Overhead Allocation',
                  text: 'Corporate is allocating more overhead costs to your venture. Your P&L now includes charges for services you barely use.',
                  options: [
                    { text: 'Accept the allocation', effects: { profitLoss: -1.2, morale: -4 } },
                    { text: 'Challenge the methodology', rollChance: 0.4, roll: { pass: { profitLoss: 0.5, morale: 4 }, fail: { morale: -5 } } },
                    { text: 'Focus on revenue to offset', effects: { reach: 2, templateProgress: -2, morale: -2 } }
                  ] }
            ],
            // SUPPLIER & CUSTOMER TENSIONS: External relationship challenges
            external_relations: [
                // SUPPLIER TENSIONS
                { id: 'ext01', dept: 'ops', icon: '🤝', title: 'Supplier Demands Exclusivity',
                  text: 'Your key supplier wants a 3-year exclusive deal. They\'ll give you better pricing, but you\'d be locked in and couldn\'t work with their competitors.',
                  options: [
                    { text: 'Sign the exclusive deal', effects: { profitLoss: 0.8, innovation: -5, rollChance: 0.4, roll: { pass: { templateProgress: 4 }, fail: { reach: -3, morale: -4 } } } },
                    { text: 'Negotiate shorter exclusivity (1 year)', effects: { profitLoss: 0.3, innovation: -2, templateProgress: 2 } },
                    { text: 'Decline and diversify suppliers', investment: 0.6, effects: { innovation: 3, skill: 3, rollChance: 0.3, roll: { pass: {}, fail: { profitLoss: -0.5, marketStrength: -4 } } } }
                  ] },
                { id: 'ext02', dept: 'Finance', icon: '💸', title: 'Supplier Demands Price Increase',
                  text: 'Your main supplier is raising prices 20% citing increased costs. This will squeeze your margins significantly.',
                  options: [
                    { text: 'Accept the increase, maintain relationship', effects: { profitLoss: -1.2, morale: -3 } },
                    { text: 'Negotiate hard, risk the relationship', rollChance: 0.5, roll: { pass: { profitLoss: -0.4, skill: 3 }, fail: { profitLoss: -1.5, marketStrength: -6, reach: -2 } } },
                    { text: 'Start qualifying alternative suppliers', investment: 0.8, effects: { profitLoss: -0.8, skill: 4, innovation: 2 } }
                  ] },
                { id: 'ext03', dept: 'ops', icon: '⚠️', title: 'Supplier Quality Crisis',
                  text: 'A batch of supplier materials failed quality checks. Customers are complaining. The supplier is blaming your specifications.',
                  options: [
                    { text: 'Work with supplier to fix root cause', investment: 0.5, effects: { templateProgress: 4, skill: 3, marketStrength: -3 } },
                    { text: 'Demand compensation and threaten to leave', rollChance: 0.4, roll: { pass: { profitLoss: 0.5, morale: 3 }, fail: { marketStrength: -8, reach: -2 } } },
                    { text: 'Absorb costs, protect customer relationships', effects: { profitLoss: -0.8, marketStrength: 4, purpose: 3 } }
                  ] },
                { id: 'ext04', dept: 'tech', icon: '🔧', title: 'Supplier Can\'t Meet Your Specs',
                  text: 'Your template requires specific modifications that your supplier says are too expensive to produce. They want you to change your design.',
                  options: [
                    { text: 'Modify your template to fit their capabilities', effects: { templateProgress: -6, profitLoss: 0.3, innovation: -4 } },
                    { text: 'Pay premium for custom production', cost: 1.2, effects: { templateProgress: 4, marketStrength: 5 } },
                    { text: 'Find a specialist supplier', investment: 1, effects: { innovation: 5, skill: 4, rollChance: 0.5, roll: { pass: { templateProgress: 6 }, fail: { reach: -2, morale: -3 } } } }
                  ] },
                { id: 'ext05', dept: 'ops', icon: '🏭', title: 'Key Supplier Going Out of Business',
                  text: 'Your critical supplier just announced they\'re closing down in 90 days. You need to find alternatives fast.',
                  options: [
                    { text: 'Emergency supplier search', investment: 1, effects: { skill: 4, morale: -5, rollChance: 0.6, roll: { pass: { templateProgress: 2 }, fail: { reach: -4, marketStrength: -8 } } } },
                    { text: 'Buy their equipment/hire their staff', investment: 2, effects: { profitLoss: -1.5, skill: 6, innovation: 4, templateProgress: 5 } },
                    { text: 'Stockpile inventory while you can', cost: 1.5, effects: { reach: -1, rollChance: 0.5, roll: { pass: { morale: 2 }, fail: { profitLoss: -1, marketStrength: -5 } } } }
                  ] },
                { id: 'ext06', dept: 'Finance', icon: '🏢', title: 'Supplier Acquired by Competitor',
                  text: 'A competitor just acquired your key supplier. They\'re "reviewing all existing contracts." Your supply chain is at risk.',
                  options: [
                    { text: 'Negotiate continuation with new owners', rollChance: 0.4, roll: { pass: { morale: 4 }, fail: { profitLoss: -1, marketStrength: -6, reach: -3 } } },
                    { text: 'Accelerate supplier diversification', investment: 1.2, effects: { skill: 5, innovation: 3, morale: -3 } },
                    { text: 'Bring production in-house', investment: 2.5, effects: { profitLoss: -1, templateProgress: 6, skill: 6, innovation: 4 } }
                  ] },
                
                // CUSTOMER TENSIONS  
                { id: 'ext07', dept: 'Marketing', icon: '🛒', title: 'Major Customer Demands Discount',
                  text: 'Your largest customer wants a 30% volume discount or they\'ll switch to a competitor. They represent 25% of your revenue.',
                  options: [
                    { text: 'Give the discount to keep them', effects: { profitLoss: -1.5, reach: 2, purpose: -3 } },
                    { text: 'Offer 15% with value-added services', effects: { profitLoss: -0.5, skill: 3, rollChance: 0.6, roll: { pass: { marketStrength: 4 }, fail: { reach: -3, profitLoss: -1 } } } },
                    { text: 'Hold firm on pricing, risk losing them', rollChance: 0.4, roll: { pass: { purpose: 5, morale: 5, marketStrength: 6 }, fail: { reach: -4, profitLoss: -2, morale: -4 } } }
                  ] },
                { id: 'ext08', dept: 'ops', icon: '✏️', title: 'Customer Wants Major Customisation',
                  text: 'A big potential customer wants significant modifications to your offering. It would mean maintaining a separate version just for them.',
                  options: [
                    { text: 'Build custom version for them', investment: 1.5, effects: { reach: 3, templateProgress: -8, innovation: -4, skill: -3 } },
                    { text: 'Offer limited customisation within template', effects: { reach: 1, templateProgress: 2, skill: 3, rollChance: 0.5, roll: { pass: { marketStrength: 4 }, fail: { morale: -3 } } } },
                    { text: 'Decline - template integrity comes first', effects: { templateProgress: 5, purpose: 4, rollChance: 0.3, roll: { pass: { innovation: 3 }, fail: { reach: -2 } } } }
                  ] },
                { id: 'ext09', dept: 'Marketing', icon: '🔒', title: 'Customer Demands Exclusivity',
                  text: 'A major customer wants exclusive rights in their region. They\'ll pay a premium, but you couldn\'t sell to their competitors.',
                  options: [
                    { text: 'Grant exclusivity for the premium', effects: { profitLoss: 1.5, reach: -2, innovation: -3 } },
                    { text: 'Offer "preferred partner" status instead', effects: { profitLoss: 0.5, reach: 1, rollChance: 0.5, roll: { pass: { marketStrength: 4 }, fail: { morale: -3 } } } },
                    { text: 'Decline - need market flexibility', effects: { reach: 2, innovation: 3, rollChance: 0.3, roll: { pass: { templateProgress: 3 }, fail: { profitLoss: -0.5 } } } }
                  ] },
                { id: 'ext10', dept: 'Finance', icon: '📅', title: 'Customer Wants Extended Payment Terms',
                  text: 'A growing customer wants 90-day payment terms instead of 30. It would strain your cash flow but they\'re a promising account.',
                  options: [
                    { text: 'Accept 90-day terms', effects: { profitLoss: -0.8, reach: 2, morale: -2 } },
                    { text: 'Offer 60-day compromise', effects: { profitLoss: -0.3, reach: 1, skill: 2 } },
                    { text: 'Hold at 30 days', rollChance: 0.5, roll: { pass: { morale: 3, purpose: 2 }, fail: { reach: -1, marketStrength: -3 } } }
                  ] },
                { id: 'ext11', dept: 'Marketing', icon: '😤', title: 'Customer Publicly Criticises You',
                  text: 'An unhappy customer posted a scathing review online. It\'s going viral. Some of their complaints are valid, some aren\'t.',
                  options: [
                    { text: 'Public apology and full refund', effects: { profitLoss: -0.5, marketStrength: -2, purpose: 3, morale: -3 } },
                    { text: 'Private resolution, public "we\'re working on it"', effects: { skill: 3, rollChance: 0.5, roll: { pass: { marketStrength: 2, morale: 3 }, fail: { marketStrength: -6 } } } },
                    { text: 'Respond factually, defend your position', rollChance: 0.4, roll: { pass: { morale: 5, purpose: 4 }, fail: { marketStrength: -8, reach: -2 } } }
                  ] },
                { id: 'ext12', dept: 'tech', icon: '🆕', title: 'Customers Want Features You Can\'t Build',
                  text: 'Multiple customers are asking for features that would require significant R&D investment. Your competitors might get there first.',
                  options: [
                    { text: 'Major R&D investment in new features', investment: 2, effects: { innovation: 8, templateProgress: -4, skill: 4, morale: -3 } },
                    { text: 'Partner with a tech company', effects: { innovation: 4, skill: 2, rollChance: 0.5, roll: { pass: { reach: 3 }, fail: { purpose: -4, templateProgress: -3 } } } },
                    { text: 'Focus on current strengths', effects: { templateProgress: 5, purpose: 3, rollChance: 0.4, roll: { pass: { marketStrength: 3 }, fail: { reach: -2, innovation: -3 } } } }
                  ] },
                { id: 'ext13', dept: 'ops', icon: '⏰', title: 'Customer Demands Faster Delivery',
                  text: 'Key customers say your delivery times are too slow. Speeding up would require process changes that might affect quality.',
                  options: [
                    { text: 'Invest in faster fulfilment', investment: 1, effects: { reach: 3, templateProgress: -3, skill: 2 } },
                    { text: 'Prioritise speed over some quality checks', effects: { reach: 2, marketStrength: -5, rollChance: 0.4, roll: { pass: {}, fail: { purpose: -4, morale: -4 } } } },
                    { text: 'Explain value of quality, hold delivery times', effects: { templateProgress: 4, purpose: 4, rollChance: 0.4, roll: { pass: { marketStrength: 4 }, fail: { reach: -2 } } } }
                  ] },
                
                // CORPORATE CONFLICTS WITH EXTERNAL RELATIONSHIPS
                { id: 'ext14', dept: 'Finance', icon: '⚔️', title: 'Your Supplier Competes with Another Division',
                  text: 'Corporate just realised your key supplier competes with one of their other business units. They want you to switch to the internal supplier.',
                  options: [
                    { text: 'Switch to internal supplier', effects: { templateProgress: -5, marketStrength: -6, morale: -4, innovation: -3 } },
                    { text: 'Argue business case for external supplier', rollChance: 0.4, roll: { pass: { morale: 5, templateProgress: 3 }, fail: { morale: -5, profitLoss: -0.5 } } },
                    { text: 'Propose gradual transition with hybrid approach', effects: { templateProgress: -2, morale: -2, skill: 3 } }
                  ] },
                { id: 'ext15', dept: 'Marketing', icon: '🚫', title: 'Customer is Competitor of Sister Division',
                  text: 'You\'ve landed a great customer, but they directly compete with another Neptune division. Corporate is furious you\'re helping their competitor.',
                  options: [
                    { text: 'Drop the customer to keep corporate happy', effects: { reach: -3, profitLoss: -1, morale: -6, purpose: -4 } },
                    { text: 'Fight to keep them - they\'re our customer', rollChance: 0.4, roll: { pass: { morale: 6, purpose: 5, reach: 2 }, fail: { morale: -4, profitLoss: -0.5 } } },
                    { text: 'Negotiate restrictions on what you provide them', effects: { reach: -1, templateProgress: -3, skill: 3 } }
                  ] },
                { id: 'ext16', dept: 'ops', icon: '🤼', title: 'Forced to Use Sister Division as Supplier',
                  text: 'Corporate mandates you must source from a sister division. Their quality is lower and prices higher than your current supplier.',
                  options: [
                    { text: 'Comply and absorb the impact', effects: { profitLoss: -1, templateProgress: -4, marketStrength: -5, morale: -5 } },
                    { text: 'Document issues and escalate', rollChance: 0.5, roll: { pass: { morale: 4, templateProgress: 2 }, fail: { morale: -6, profitLoss: -0.5 } } },
                    { text: 'Work with sister division to improve their offering', investment: 0.8, effects: { skill: 4, morale: -2, rollChance: 0.5, roll: { pass: { templateProgress: 4, innovation: 3 }, fail: { templateProgress: -3 } } } }
                  ] },
                { id: 'ext17', dept: 'Marketing', icon: '🔄', title: 'Corporate Wants You to Share Customers',
                  text: 'Another division wants access to your customer relationships for cross-selling. Your customers trust you, not "Neptune Corporation."',
                  options: [
                    { text: 'Share customer data and relationships', effects: { reach: 2, marketStrength: -6, purpose: -4, morale: -4 } },
                    { text: 'Offer to make warm introductions selectively', effects: { reach: 1, marketStrength: -2, skill: 3 } },
                    { text: 'Protect customer relationships', rollChance: 0.4, roll: { pass: { purpose: 5, marketStrength: 4, morale: 4 }, fail: { morale: -4, profitLoss: -0.3 } } }
                  ] },
                { id: 'ext18', dept: 'Finance', icon: '💼', title: 'Partnership Blocked - Competitor Connection',
                  text: 'You found a perfect technology partner, but they also work with a competitor of another Neptune division. Corporate legal is blocking the deal.',
                  options: [
                    { text: 'Accept the block, find alternatives', effects: { innovation: -4, templateProgress: -3, morale: -4 } },
                    { text: 'Escalate to CEO level', rollChance: 0.3, roll: { pass: { innovation: 6, morale: 6, templateProgress: 4 }, fail: { morale: -6, profitLoss: -0.5 } } },
                    { text: 'Restructure deal to address concerns', investment: 0.5, effects: { skill: 4, rollChance: 0.5, roll: { pass: { innovation: 4, templateProgress: 3 }, fail: { morale: -3 } } } }
                  ] },
                { id: 'ext19', dept: 'ops', icon: '🌐', title: 'Supplier Wants to Work with Competitors',
                  text: 'Your supplier wants to sell a modified version of your jointly-developed product to your competitors. The contract is ambiguous.',
                  options: [
                    { text: 'Legal action to block them', cost: 0.8, effects: { innovation: -3, rollChance: 0.5, roll: { pass: { morale: 4, marketStrength: 4 }, fail: { profitLoss: -1, morale: -5 } } } },
                    { text: 'Negotiate revenue share if they proceed', effects: { profitLoss: 0.5, innovation: -2, marketStrength: -4 } },
                    { text: 'Accept it and accelerate your own innovation', effects: { innovation: 5, skill: 4, templateProgress: 3, morale: -2 } }
                  ] },
                { id: 'ext20', dept: 'Marketing', icon: '🎯', title: 'Customer Consolidating Suppliers',
                  text: 'Your biggest customer is consolidating to fewer suppliers. You\'re on the shortlist but so is a larger, cheaper competitor.',
                  options: [
                    { text: 'Match competitor pricing', effects: { profitLoss: -1.5, reach: 2, purpose: -3 } },
                    { text: 'Emphasise quality and relationship', rollChance: 0.5, roll: { pass: { reach: 3, marketStrength: 5, purpose: 4 }, fail: { reach: -4, profitLoss: -1.5 } } },
                    { text: 'Propose partnership/preferred status', effects: { reach: 1, skill: 3, rollChance: 0.4, roll: { pass: { marketStrength: 4 }, fail: { reach: -2 } } } }
                  ] }
            ],
            // LATE PHASE: Template scaling and rollout events - month 6 onwards
            scaling: [
                { id: 'scale01', dept: 'ops', icon: '📋', title: 'Template Documentation Debate', phase: 'late',
                  text: 'How detailed should your template documentation be? More detail helps consistency but takes longer to create and update.',
                  options: [
                    { text: 'Comprehensive documentation', investment: 1, effects: { templateProgress: 11, skill: 6, morale: -2 } },
                    { text: 'Key principles with flexibility', effects: { templateProgress: 6, innovation: 3, morale: 3 } },
                    { text: 'Minimal documentation, learn by doing', effects: { reach: 3, templateProgress: -3, rollChance: 0.4, roll: { pass: { innovation: 3 }, fail: { skill: -6, morale: -4 } } } }
                  ] },
                { id: 'scale02', dept: 'ops', icon: '🔬', title: 'Pilot Before Rollout', phase: 'late',
                  text: 'Before scaling to 10 new markets, should you run thorough pilots? Takes time but reduces risk of template failure.',
                  options: [
                    { text: 'Full pilots in 3 markets first', investment: 1, effects: { templateProgress: 10, skill: 6 } },
                    { text: 'Quick pilots in 1 market', effects: { templateProgress: 6, reach: 0, skill: 3 } },
                    { text: 'Skip pilots - template is ready', effects: { reach: 6, rollChance: 0.4, roll: { pass: { morale: 3 }, fail: { templateProgress: -8, reach: -4, morale: -6 } } } }
                  ] },
                { id: 'scale03', dept: 'HR', icon: '🌍', title: 'Local Adaptation Requests', phase: 'late',
                  text: 'Every new market wants changes to your template. How much local adaptation should you allow?',
                  options: [
                    { text: 'No adaptation - template is the template', effects: { templateProgress: 8, reach: 2, morale: -4, staffLocal: -10 } },
                    { text: 'Allow adaptation within clear boundaries', effects: { templateProgress: 4, reach: 3, morale: 2, staffLocal: 5 } },
                    { text: 'Each market can adapt freely', effects: { reach: 4, morale: 4, templateProgress: -7, staffLocal: 10 } }
                  ] },
                { id: 'scale04', dept: 'tech', icon: '📊', title: 'Template Metrics', phase: 'late',
                  text: 'How do you know if your template is working? Setting up proper measurement takes resources.',
                  options: [
                    { text: 'Comprehensive template health dashboard', investment: 1.2, effects: { templateProgress: 8, skill: 6, reach: -2 } },
                    { text: 'Track a few key indicators', cost: 0.3, effects: { templateProgress: 4, skill: 3 } },
                    { text: 'Trust the team\'s judgment', effects: { morale: 3, rollChance: 0.4, roll: { pass: { innovation: 3 }, fail: { templateProgress: -6, skill: -3 } } } }
                  ] },
                { id: 'scale05', dept: 'tech', icon: '🔄', title: 'Template Version Control', phase: 'late',
                  text: 'Different locations are running slightly different versions of your template. Should you force everyone to update?',
                  options: [
                    { text: 'Mandatory update to latest version', cost: 0.8, effects: { templateProgress: 8, morale: -4, staffLocal: -5 } },
                    { text: 'Gradual migration with support', cost: 0.5, effects: { templateProgress: 6, morale: 2, skill: 2 } },
                    { text: 'Let locations choose when to update', effects: { morale: 3, templateProgress: -3, innovation: 2 } }
                  ] },
                { id: 'scale06', dept: 'HR', icon: '🎓', title: 'Template Training Programme', phase: 'late',
                  text: 'New markets struggle to implement your template correctly. How much should you invest in training?',
                  options: [
                    { text: 'Intensive 4-week training programme', investment: 1.5, effects: { templateProgress: 10, skill: 8, reach: -3, morale: 3 } },
                    { text: '1-week bootcamp with ongoing support', cost: 0.8, effects: { templateProgress: 7, skill: 4, reach: 0 } },
                    { text: 'Send them the documents and check in monthly', effects: { reach: 3, rollChance: 0.3, roll: { pass: { morale: 2 }, fail: { templateProgress: -6, skill: -4, morale: -3 } } } }
                  ] },
                { id: 'scale07', dept: 'Finance', icon: '⚡', title: 'Scaling Speed vs Stability', phase: 'late',
                  text: 'Investors want you to double your footprint this year. Your team says the template isn\'t ready for that pace.',
                  options: [
                    { text: 'Slow down - template quality comes first', effects: { templateProgress: 8, reach: -3, morale: 4, rollChance: 0.5, roll: { pass: { purpose: 3 }, fail: {profitLoss: -0.5 } } } },
                    { text: 'Compromise - 50% growth target', effects: { templateProgress: 3, reach: 3, morale: 2 } },
                    { text: 'Go for it - figure it out as we scale', effects: { reach: 7, templateProgress: -6, rollChance: 0.4, roll: { pass: { profitLoss: 1 }, fail: { purpose: -6, morale: -6, skill: -3 } } } }
                  ] },
                { id: 'scale08', dept: 'tech', icon: '🏗️', title: 'Build vs Buy for Scaling', phase: 'late',
                  text: 'You could build your own scaling infrastructure or use a partner\'s platform. Building takes longer but gives more control.',
                  options: [
                    { text: 'Build custom infrastructure', investment: 2, effects: { templateProgress: 11, skill: 6, reach: -4, innovation: 3 } },
                    { text: 'Use partner platform', cost: 1, effects: { reach: 4, templateProgress: -3, skill: -2 } },
                    { text: 'Hybrid approach', investment: 1.2, effects: { templateProgress: 4, reach: 2, skill: 3 } }
                  ] },
                { id: 'scale09', dept: 'ops', icon: '🔍', title: 'Template Audit Findings', phase: 'late',
                  text: 'An audit reveals that 40% of your locations have drifted from the core template. How do you respond?',
                  options: [
                    { text: 'Strict compliance programme', cost: 0.8, effects: { templateProgress: 8, morale: -6, staffLocal: -8 } },
                    { text: 'Learn from the variations - update template', effects: { templateProgress: 4, innovation: 4, skill: 3, morale: 2 } },
                    { text: 'Focus on outcomes, not process compliance', effects: { morale: 4, innovation: 3, rollChance: 0.5, roll: { pass: { purpose: 3 }, fail: { templateProgress: -6 } } } }
                  ] },
                { id: 'scale10', dept: 'Finance', icon: '📈', title: 'Scaling Success - What Next?', phase: 'late', 
                  text: 'Your template is working well in 5 markets. Time to push for 20, or perfect the approach further?',
                  options: [
                    { text: 'Push for rapid expansion now', investment: 2, effects: { reach: 8, templateProgress: -4, rollChance: 0.5, roll: { pass: { morale: 4 }, fail: { morale: -6, purpose: -4 } } } },
                    { text: 'Consolidate and perfect first', effects: { templateProgress: 10, skill: 4 } },
                    { text: 'Controlled expansion - 3 more markets', investment: 1, effects: { reach: 3, templateProgress: 4, skill: 3 } }
                  ] }
            ],
            // REPLICATION EVENTS: Based on scaling/template research (Winter & Szulanski, Apple retail case)
            // These events explore template creation, replication challenges, and franchise vs company-owned
            replication: [
                { id: 'rep01', dept: 'ops', icon: '🏪', title: 'Store-Within-a-Store Opportunity', phase: 'early',
                  text: 'A major retailer offers to host your venture inside their existing stores. Low cost and instant footfall, but you won\'t control the customer experience.',
                  options: [
                    { text: 'Take the deal - learn from their traffic', effects: { reach: 5, profitLoss: 0.5, templateProgress: -4, marketStrength: -6, purpose: -3 } },
                    { text: 'Pilot in 2 stores to test the model', cost: 0.3, effects: { reach: 2, templateProgress: 3, skill: 4, marketStrength: 2 } },
                    { text: 'Decline - we need to own the experience', effects: { templateProgress: 6, purpose: 4, marketStrength: 6, reach: -2 } }
                  ] },
                { id: 'rep02', dept: 'ops', icon: '🏗️', title: 'Build a Prototype Flagship', phase: 'early',
                  text: 'Should you build one perfect "prototype" location to test and refine every aspect of your model before expanding? It means delaying growth.',
                  options: [
                    { text: 'Build the prototype - get it right first', investment: 1.5, effects: { templateProgress: 12, skill: 6, reach: -4, marketStrength: 8 } },
                    { text: 'Improve while expanding slowly', effects: { templateProgress: 6, reach: 3, skill: 3, marketStrength: 4 } },
                    { text: 'Learn by doing across multiple sites', investment: 1, effects: { reach: 6, innovation: 4, templateProgress: -3, marketStrength: -4, rollChance: 0.4, roll: { pass: { skill: 4 }, fail: { morale: -4, marketStrength: -8 } } } }
                  ] },
                { id: 'rep03', dept: 'Marketing', icon: '🎯', title: 'The Signature Service Element', phase: 'early',
                  text: 'You could create a distinctive service feature that differentiates you from competitors - like Apple\'s Genius Bar. It\'s expensive but memorable.',
                  options: [
                    { text: 'Create a signature experience element', investment: 1.2, effects: { templateProgress: 8, purpose: 6, marketStrength: 12, innovation: 4, morale: 3 } },
                    { text: 'Focus on executing basics brilliantly', effects: { templateProgress: 6, skill: 4, marketStrength: 4 } },
                    { text: 'Let signature elements emerge organically', effects: { innovation: 5, morale: 3, rollChance: 0.5, roll: { pass: { marketStrength: 8, purpose: 4 }, fail: { marketStrength: -4 } } } }
                  ] },
                { id: 'rep04', dept: 'ops', icon: '📋', title: 'The Operations Manual Question', phase: 'early',
                  text: 'Winter & Szulanski found that detailed templates enable faster replication. Creating a comprehensive operations manual takes months. Worth it?',
                  options: [
                    { text: 'Create comprehensive operations bible', investment: 1, effects: { templateProgress: 14, skill: 6, reach: -3, morale: -2, marketStrength: 8 } },
                    { text: 'Document core processes only', cost: 0.4, effects: { templateProgress: 8, skill: 3, reach: 0, marketStrength: 4 } },
                    { text: 'Rely on training and culture instead', effects: { morale: 5, innovation: 4, templateProgress: 2, skill: -2, marketStrength: -3, rollChance: 0.4, roll: { pass: { reach: 3 }, fail: { templateProgress: -4, marketStrength: -6 } } } }
                  ] },
                { id: 'rep05', dept: 'Finance', icon: '🤝', title: 'Franchise vs Company-Owned', phase: 'late',
                  text: 'An experienced operator wants to license your template in 5 new cities. Franchising means faster growth and shared risk, but less control over quality.',
                  options: [
                    { text: 'License the template - share the growth', effects: { reach: 8, profitLoss: 1.2, templateProgress: -6, purpose: -4, marketStrength: -8, rollChance: 0.4, roll: { pass: { skill: 3 }, fail: { purpose: -6, marketStrength: -10 } } } },
                    { text: 'Single pilot franchise with strict terms', effects: { reach: 2, profitLoss: 0.3, templateProgress: 3, skill: 4, marketStrength: 2 } },
                    { text: 'Stay company-owned for now', effects: { templateProgress: 6, purpose: 4, marketStrength: 6 } }
                  ] },
                { id: 'rep06', dept: 'HR', icon: '🚪', title: 'Knowledge Leakage Risk', phase: 'late',
                  text: 'A key employee who helped build your template has joined a competitor. They know all your processes. Templates can leak.',
                  options: [
                    { text: 'Accelerate innovation - stay ahead', investment: 1, effects: { innovation: 8, templateProgress: 4, skill: 3, morale: 2 } },
                    { text: 'Document and protect what makes us unique', cost: 0.5, effects: { templateProgress: 6, skill: 4, marketStrength: 4 } },
                    { text: 'Focus on execution - templates aren\'t everything', effects: { morale: 4, purpose: 3, rollChance: 0.5, roll: { pass: { marketStrength: 4 }, fail: { marketStrength: -8, reach: -3 } } } }
                  ] },
                { id: 'rep07', dept: 'Marketing', icon: '🪞', title: 'Competitor Copying Your Model', phase: 'late',
                  text: 'A well-funded competitor is openly replicating your approach. Like Microsoft copying Apple\'s stores, they have resources but lack understanding.',
                  options: [
                    { text: 'Accelerate and stay ahead of them', investment: 1.5, effects: { reach: 6, templateProgress: 4, morale: 4, profitLoss: -0.5, marketStrength: 6 } },
                    { text: 'Differentiate - deepen what they can\'t copy', effects: { templateProgress: 8, purpose: 6, innovation: 4, marketStrength: 10 } },
                    { text: 'Ignore them - focus on customers', effects: { purpose: 4, morale: 3, rollChance: 0.5, roll: { pass: { marketStrength: 6 }, fail: { reach: -4, marketStrength: -8 } } } }
                  ] },
                { id: 'rep08', dept: 'ops', icon: '📊', title: 'Licensed Reseller Quality Issues', phase: 'late',
                  text: 'Your distribution partners aren\'t representing your brand well. Customers are getting inconsistent experiences - just like Apple found with third-party resellers.',
                  options: [
                    { text: 'Terminate underperformers, tighten standards', effects: { reach: -4, templateProgress: 8, marketStrength: 10, purpose: 5, morale: -3 } },
                    { text: 'Invest in partner training and support', cost: 1, effects: { templateProgress: 4, skill: 4, marketStrength: 6, reach: 0 } },
                    { text: 'Build direct presence alongside partners', investment: 1.5, effects: { reach: 2, templateProgress: 6, marketStrength: 8, profitLoss: -0.5 } }
                  ] },
                { id: 'rep09', dept: 'Finance', icon: '🏪', title: 'Multi-Site Operator Interest', phase: 'late',
                  text: 'A franchise group wants to open 20 locations in their region - but they need your support infrastructure, training systems, and ongoing guidance.',
                  options: [
                    { text: 'Build franchise support infrastructure', investment: 2, effects: { templateProgress: 10, skill: 6, reach: -3, rollChance: 0.6, roll: { pass: { reach: 12, profitLoss: 2 }, fail: { profitLoss: -1 } } } },
                    { text: 'Partner with them on 5 locations first', investment: 1, effects: { reach: 5, templateProgress: 4, skill: 4, profitLoss: 0.5 } },
                    { text: 'Decline - we\'re not ready for franchising', effects: { templateProgress: 4, purpose: 3 } }
                  ] },
                { id: 'rep10', dept: 'ops', icon: '🔧', title: 'Template Fidelity vs Adaptation', phase: 'late',
                  text: 'New markets want to modify your template for local conditions. Strict replication ensures consistency; adaptation might improve fit.',
                  options: [
                    { text: 'Enforce strict template fidelity', effects: { templateProgress: 8, marketStrength: 8, staffLocal: -12, morale: -4, innovation: -3 } },
                    { text: 'Core elements fixed, peripherals flexible', effects: { templateProgress: 4, marketStrength: 4, staffLocal: 5, morale: 2, skill: 3 } },
                    { text: 'Let each market optimise for local fit', effects: { staffLocal: 12, morale: 5, innovation: 5, templateProgress: -8, marketStrength: -6, rollChance: 0.4, roll: { pass: { reach: 4 }, fail: { purpose: -4 } } } }
                  ] },
                { id: 'rep11', dept: 'tech', icon: '📱', title: 'Digital Template Enablement', phase: 'late',
                  text: 'You could build digital tools that guide new sites through your template step-by-step. Technology-enabled replication.',
                  options: [
                    { text: 'Build comprehensive digital playbook', investment: 1.5, effects: { templateProgress: 10, skill: 6, innovation: 4, reach: -2 } },
                    { text: 'Simple checklists and video guides', cost: 0.5, effects: { templateProgress: 6, skill: 3, reach: 0 } },
                    { text: 'In-person training remains superior', effects: { skill: 4, morale: 3, templateProgress: 2, reach: -1 } }
                  ] },
                { id: 'rep12', dept: 'HR', icon: '👥', title: 'Template Guardians', phase: 'late',
                  text: 'Should you create a dedicated team whose job is to protect and evolve the template? McDonald\'s and other franchises have entire departments for this.',
                  options: [
                    { text: 'Create template governance team', cost: 1, effects: { templateProgress: 10, skill: 6, marketStrength: 8, morale: -2, innovation: -2 } },
                    { text: 'Distribute template ownership across functions', effects: { templateProgress: 6, morale: 3, skill: 3, innovation: 2 } },
                    { text: 'Keep it informal - everyone owns quality', effects: { morale: 4, innovation: 4, rollChance: 0.4, roll: { pass: { templateProgress: 4 }, fail: { templateProgress: -6, marketStrength: -4 } } } }
                  ] },
                // NEW EVENTS: Limits to Scaling (inspired by corporate entrepreneurship research)
                { id: 'rep13', dept: 'ops', icon: '🌍', title: 'Regulatory Barriers in New Market', phase: 'late',
                  text: 'Your expansion into a new region faces unexpected regulatory hurdles. Local laws require significant modifications to your template - like Uber discovered in Germany or Tesla in Sweden.',
                  options: [
                    { text: 'Adapt template to comply fully', investment: 1.5, effects: { templateProgress: -6, reach: 3, skill: 4, purpose: 3 } },
                    { text: 'Lobby for regulatory change while operating in grey area', effects: { reach: 5, purpose: -6, rollChance: 0.3, roll: { pass: { marketStrength: 8 }, fail: { reach: -8, profitLoss: -2, purpose: -8 } } } },
                    { text: 'Skip this market, focus on friendlier jurisdictions', effects: { reach: -2, templateProgress: 4, purpose: 2 } }
                  ] },
                { id: 'rep14', dept: 'ops', icon: '🎛️', title: 'Loss of Control in Distant Market', phase: 'late',
                  text: 'Your operations in a distant market are drifting from your standards. Local management is making decisions without consulting you - quality is inconsistent and brand is being interpreted differently.',
                  options: [
                    { text: 'Install direct oversight and tighter controls', cost: 1, effects: { templateProgress: 8, marketStrength: 6, staffLocal: -15, morale: -6 } },
                    { text: 'Accept some drift as price of distance', effects: { staffLocal: 8, morale: 3, templateProgress: -4, marketStrength: -6, rollChance: 0.4, roll: { pass: { innovation: 4 }, fail: { purpose: -6 } } } },
                    { text: 'Exit market and consolidate closer to home', effects: { reach: -5, templateProgress: 6, purpose: 4, profitLoss: -0.5 } }
                  ] },
                { id: 'rep15', dept: 'Marketing', icon: '🍕', title: 'Cultural Misfit in New Market', phase: 'late',
                  text: 'Your offering isn\'t resonating in a new market - like Domino\'s struggling in Italy where locals have strong existing preferences. The template that works elsewhere falls flat here.',
                  options: [
                    { text: 'Significant local adaptation', investment: 1, effects: { templateProgress: -8, reach: 3, staffLocal: 10, innovation: 4 } },
                    { text: 'Double down on education and marketing', cost: 1.2, effects: { marketStrength: 6, reach: 0, rollChance: 0.35, roll: { pass: { reach: 4, purpose: 3 }, fail: { profitLoss: -1.5, morale: -4 } } } },
                    { text: 'Accept this market isn\'t for us', effects: { reach: -3, templateProgress: 4, purpose: 3, morale: 2 } }
                  ] },
                { id: 'rep16', dept: 'ops', icon: '📉', title: 'Quality Decline at Scale', phase: 'late',
                  text: 'As you\'ve grown, operational quality has slipped. Customer complaints are up 40%. Your original locations still shine, but newer ones are inconsistent - a common problem in franchise systems.',
                  options: [
                    { text: 'Pause expansion, fix quality issues', effects: { reach: -4, templateProgress: 10, skill: 6, marketStrength: 8, purpose: 4 } },
                    { text: 'Hire quality auditors and enforcement team', cost: 1.2, effects: { templateProgress: 6, marketStrength: 4, morale: -4, staffLocal: -5 } },
                    { text: 'Attribute to growing pains, push forward', effects: { reach: 4, marketStrength: -12, rollChance: 0.3, roll: { pass: { skill: 2 }, fail: { purpose: -8, morale: -6 } } } }
                  ] },
                { id: 'rep17', dept: 'HR', icon: '⚔️', title: 'Home vs New Site Tensions', phase: 'late',
                  text: 'Your original team resents the resources going to new locations. Meanwhile, new sites feel like second-class citizens who don\'t get enough support. Classic headquarters vs field tension.',
                  options: [
                    { text: 'Prioritise original team - they built this', effects: { morale: 4, staffLocal: -10, reach: -2, templateProgress: 2 } },
                    { text: 'Prioritise new sites - they need support', effects: { reach: 4, staffLocal: 8, morale: -5, templateProgress: -3 } },
                    { text: 'Create integrated team culture across all sites', investment: 0.8, effects: { morale: 2, staffLocal: 3, skill: 4, templateProgress: 4 } }
                  ] },
                { id: 'rep18', dept: 'Finance', icon: '💰', title: 'Master Franchisee Opportunity', phase: 'late',
                  text: 'A wealthy operator wants exclusive rights to your territory. Like the PAUL bakery model, they\'ll commit to 20+ locations if you provide site selection support, training programmes, and operational manuals.',
                  options: [
                    { text: 'Full master franchise deal', effects: { reach: 12, profitLoss: 2, templateProgress: -8, purpose: -4, rollChance: 0.35, roll: { pass: { skill: 4 }, fail: { reach: -6, marketStrength: -10, purpose: -8 } } } },
                    { text: 'Pilot with 5 locations, strict oversight', investment: 1, effects: { reach: 4, templateProgress: 4, skill: 4, profitLoss: 0.5 } },
                    { text: 'Decline - we\'re not franchise-ready', effects: { templateProgress: 6, purpose: 4, morale: 2 } }
                  ] },
                { id: 'rep19', dept: 'ops', icon: '🏭', title: 'Manufacturing Transfer Tensions', phase: 'late',
                  text: 'You\'re moving production to a new facility for cost savings. But the original team has tacit knowledge that\'s hard to transfer - like Sun Microsystems found when moving manufacturing.',
                  options: [
                    { text: 'Extended transition with knowledge transfer', investment: 1.2, effects: { templateProgress: 8, skill: 6, profitLoss: -0.3, morale: -2 } },
                    { text: 'Quick transition, learn as we go', effects: { profitLoss: 0.8, rollChance: 0.35, roll: { pass: { templateProgress: 4 }, fail: { templateProgress: -8, skill: -6, morale: -6, profitLoss: -1.5 } } } },
                    { text: 'Keep production at original site', effects: { morale: 4, skill: 3, profitLoss: -0.5, templateProgress: 2 } }
                  ] },
                { id: 'rep20', dept: 'Marketing', icon: '🎨', title: 'Local Adaptation vs Brand Consistency', phase: 'late',
                  text: 'Local teams want to modify your branding, messaging, and even product features for their markets. Each adaptation risks diluting what makes you distinctive.',
                  options: [
                    { text: 'Strict global brand standards', effects: { templateProgress: 8, marketStrength: 10, staffLocal: -12, morale: -4, innovation: -4 } },
                    { text: 'Core brand elements fixed, execution flexible', effects: { templateProgress: 4, staffLocal: 6, morale: 3, marketStrength: 4, innovation: 3 } },
                    { text: 'Full local autonomy on branding', effects: { staffLocal: 12, morale: 5, innovation: 5, templateProgress: -10, marketStrength: -8, purpose: -4 } }
                  ] },
                { id: 'rep21', dept: 'Finance', icon: '📋', title: 'Franchise Requirements Decision', phase: 'late',
                  text: 'You\'re designing your franchise programme. Should you require significant capital (like PAUL\'s £500K minimum) and multi-site commitments, or lower barriers for faster growth?',
                  options: [
                    { text: 'High requirements - serious partners only', effects: { reach: -2, templateProgress: 8, purpose: 4, marketStrength: 8, rollChance: 0.6, roll: { pass: { profitLoss: 1.5 }, fail: { reach: -3 } } } },
                    { text: 'Moderate requirements with support', effects: { reach: 3, templateProgress: 4, skill: 3, profitLoss: 0.5 } },
                    { text: 'Low barriers to attract many partners', effects: { reach: 8, templateProgress: -6, rollChance: 0.3, roll: { pass: { morale: 3 }, fail: { marketStrength: -10, purpose: -6 } } } }
                  ] }
            ],
            // CHEESE EVENTS: Tempting shortcuts that offer early scaling at significant hidden cost
            // These teach players that scaling before template maturity creates problems
            // DESIGN: Look like great opportunities but have nasty downsides
            shortcuts: [
                { id: 'cheese01', dept: 'Marketing', icon: '🌟', title: 'Influencer Wants to Partner', phase: 'early', isCheese: true,
                  text: 'A major influencer with 2M followers loves your product and wants to feature it. This could put you on the map overnight!',
                  options: [
                    { text: 'Go for it! This is huge exposure', effects: { reach: 8, templateProgress: -8, morale: 4, rollChance: 0.35, roll: { pass: { profitLoss: 2 }, fail: { reach: -5, morale: -8, purpose: -6, profitLoss: -2 } } } },
                    { text: 'Ask them to wait 3 months', effects: { templateProgress: 6, skill: 3, reach: 0, rollChance: 0.5, roll: { pass: { reach: 4, morale: 3 }, fail: { morale: -3 } } } },
                    { text: 'Decline politely', effects: { templateProgress: 4, purpose: 3, morale: -2 } }
                  ] },
                { id: 'cheese02', dept: 'Finance', icon: '🏢', title: 'Corporate Fast-Track Programme', phase: 'early', isCheese: true,
                  text: 'Neptune HQ is launching a "High Potential Ventures" programme with extra resources, visibility, and executive sponsorship. They want you to join!',
                  options: [
                    { text: 'Join the programme - this is our chance!', effects: { profitLoss: 1.5, reach: 4, templateProgress: -10, rollChance: 0.3, roll: { pass: { morale: 4, skill: 3 }, fail: { morale: -10, purpose: -8, skill: -6 } } } },
                    { text: 'Negotiate for modified targets', rollChance: 0.4, roll: { pass: { profitLoss: 0.8, templateProgress: 3, morale: 3 }, fail: { morale: -3 } } },
                    { text: 'Decline - we need to prove the model first', effects: { purpose: 5, templateProgress: 4, morale: 2 } }
                  ] },
                { id: 'cheese03', dept: 'ops', icon: '🏪', title: 'Franchise Enquiry', phase: 'early', isCheese: true,
                  text: 'An experienced franchise operator wants to license your concept in 5 new cities. They\'ll handle everything - you just provide the brand and collect royalties!',
                  options: [
                    { text: 'Sign the deal - easy expansion!', effects: { reach: 10, profitLoss: 1.5, templateProgress: -12, purpose: -6, rollChance: 0.25, roll: { pass: {}, fail: { reach: -8, purpose: -10, morale: -6 } } } },
                    { text: 'Pilot with 1 franchise first', effects: { reach: 2, profitLoss: 0.5, templateProgress: -3, rollChance: 0.5, roll: { pass: { skill: 3 }, fail: { purpose: -4 } } } },
                    { text: 'Decline until we have a proper model', effects: { templateProgress: 6, purpose: 4, skill: 3 } }
                  ] },
                { id: 'cheese04', dept: 'tech', icon: '🤖', title: 'AI Platform Promise', phase: 'early', isCheese: true,
                  text: 'A cutting-edge tech vendor says their AI can automate your entire expansion process - site selection, staffing predictions, and operational optimisation. They have impressive case studies.',
                  options: [
                    { text: 'Sign up - this could 10x our growth!', investment: 2, effects: { reach: 6, skill: -6, templateProgress: -8, rollChance: 0.3, roll: { pass: { innovation: 4 }, fail: { reach: -6, profitLoss: -3, morale: -6 } } } },
                    { text: 'Run a small pilot first', investment: 0.5, effects: { innovation: 3, skill: 2, rollChance: 0.6, roll: { pass: { templateProgress: 3, reach: 2 }, fail: { profitLoss: -0.5 } } } },
                    { text: 'Focus on understanding our own processes', effects: { templateProgress: 6, skill: 4, innovation: 2 } }
                  ] },
                { id: 'cheese05', dept: 'Marketing', icon: '🎪', title: 'Major Retailer Fast-Track', phase: 'early', isCheese: true,
                  text: 'A national retailer wants your product in 200 stores next month! This is the kind of distribution deal that transforms companies overnight.',
                  options: [
                    { text: 'Say yes - this is our big break!', effects: { reach: 12, templateProgress: -10, morale: -4, rollChance: 0.25, roll: { pass: { profitLoss: 3 }, fail: { reach: -10, profitLoss: -4, purpose: -8, morale: -10 } } } },
                    { text: 'Negotiate a phased rollout: 50 stores first', effects: { reach: 4, templateProgress: -3, rollChance: 0.5, roll: { pass: { skill: 4, profitLoss: 1 }, fail: { morale: -4 } } } },
                    { text: 'Ask to start next quarter', effects: { templateProgress: 5, skill: 3, rollChance: 0.4, roll: { pass: { reach: 5, morale: 3 }, fail: { morale: -2 } } } }
                  ] },
                { id: 'cheese06', dept: 'HR', icon: '🚀', title: 'Competitor\'s Team Available', phase: 'early', isCheese: true,
                  text: 'A competitor just collapsed. Their entire 30-person experienced team is available and eager to join. They know the industry inside out!',
                  options: [
                    { text: 'Hire everyone - instant expertise!', cost: 2.5, effects: { reach: 6, skill: -4, morale: -6, templateProgress: -8, purpose: -4, rollChance: 0.3, roll: { pass: { skill: 4 }, fail: { morale: -8, skill: -6 } } } },
                    { text: 'Cherry-pick 5 key people', cost: 1, effects: { skill: 4, reach: 2, morale: -2, rollChance: 0.6, roll: { pass: { templateProgress: 3 }, fail: { morale: -4 } } } },
                    { text: 'Pass - we need to grow organically', effects: { purpose: 4, morale: 3, templateProgress: 4 } }
                  ] },
                { id: 'cheese07', dept: 'Finance', icon: '📈', title: 'Government Scale-Up Grant', phase: 'early', isCheese: true,
                  text: 'A government grant offers £500K for "high-growth social enterprises." You tick all the boxes and the money would accelerate everything!',
                  options: [
                    { text: 'Apply and commit to growth targets', effects: { profitLoss: 2, reach: 4, templateProgress: -6, rollChance: 0.35, roll: { pass: { morale: 4 }, fail: { profitLoss: -2, morale: -8, purpose: -6 } } } },
                    { text: 'Apply for a smaller innovation grant', effects: { profitLoss: 0.5, templateProgress: 4, innovation: 4, skill: 2 } },
                    { text: 'Focus on building without external pressure', effects: { templateProgress: 5, morale: 3, purpose: 3 } }
                  ] },
                { id: 'cheese08', dept: 'ops', icon: '⚡', title: 'Licensing Deal Opportunity', phase: 'early', isCheese: true,
                  text: 'A company in another country wants to license your concept. They\'ll pay upfront and handle everything locally - passive income with no effort!',
                  options: [
                    { text: 'Sign the deal - easy money!', effects: { profitLoss: 2, reach: 6, templateProgress: -8, purpose: -4, skill: -3, rollChance: 0.3, roll: { pass: { morale: 3 }, fail: { purpose: -8, reach: -4 } } } },
                    { text: 'Delay until we can document properly', effects: { templateProgress: 7, skill: 3, rollChance: 0.5, roll: { pass: { reach: 3, profitLoss: 1 }, fail: { morale: -2 } } } },
                    { text: 'Decline - we\'re not ready to license', effects: { templateProgress: 4, purpose: 4, morale: 2 } }
                  ] },
                { id: 'cheese09', dept: 'Marketing', icon: '🎯', title: 'Viral Campaign Opportunity', phase: 'early', isCheese: true,
                  text: 'Your marketing team has a brilliant campaign idea - guaranteed 1M impressions, tons of buzz. This could put you on the map!',
                  options: [
                    { text: 'Launch it! Fortune favours the bold', investment: 0.5, effects: { reach: 7, purpose: -6, templateProgress: -6, rollChance: 0.4, roll: { pass: { morale: 6, profitLoss: 1 }, fail: { purpose: -8, morale: -6, profitLoss: -1 } } } },
                    { text: 'Adapt it to fit our brand values', investment: 0.8, effects: { reach: 3, purpose: 2, templateProgress: 2, skill: 2 } },
                    { text: 'Stick to our measured approach', effects: { purpose: 4, templateProgress: 4, reach: -2 } }
                  ] },
                { id: 'cheese10', dept: 'tech', icon: '🔗', title: 'Acquisition Approach', phase: 'early', isCheese: true,
                  text: 'A competitor with 8 established locations wants to sell. You could instantly have their customer base and market presence!',
                  options: [
                    { text: 'Acquire them - instant scale!', investment: 3, effects: { reach: 8, templateProgress: -10, morale: -4, skill: -4, rollChance: 0.25, roll: { pass: { profitLoss: 2 }, fail: { reach: -6, morale: -10, profitLoss: -4 } } } },
                    { text: 'Acquire just their best 2 locations', investment: 1, effects: { reach: 2, templateProgress: -3, rollChance: 0.5, roll: { pass: { skill: 3 }, fail: { morale: -4 } } } },
                    { text: 'Pass - organic growth is safer', effects: { templateProgress: 4, purpose: 3, morale: 3 } }
                  ] }
            ],
            // TEMPLATE MATURITY REWARDS: High-reward events that only appear when template is mature
            // These reward players who resisted early shortcuts and built a solid foundation
            // DESIGN: Great opportunities with high success rates - the payoff for patience
            template_rewards: [
                { id: 'reward01', dept: 'Marketing', icon: '🚀', title: 'Major Retailer Partnership', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Advanced' || state.templateStage === 'Optimized',
                  text: 'A national retailer has been watching your success. They\'re impressed by your consistent quality across locations and want to partner. Your proven template means you can actually deliver at scale.',
                  options: [
                    { text: 'Full partnership - 50 stores', effects: { reach: 10, profitLoss: 2, morale: 6, purpose: 3 } },
                    { text: 'Start with 20 stores, expand if it works', effects: { reach: 6, profitLoss: 1, morale: 4, templateProgress: 4 } },
                    { text: 'Decline - stay focused on current growth', effects: { templateProgress: 6, purpose: 4 } }
                  ] },
                { id: 'reward02', dept: 'Finance', icon: '💎', title: 'Neptune Showcase Venture', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Advanced' || state.templateStage === 'Optimized',
                  text: 'Corporate wants to feature your venture as a model for others. Your documented, repeatable approach is exactly what they want to replicate across Neptune. This brings resources and visibility.',
                  options: [
                    { text: 'Embrace the spotlight', effects: { profitLoss: 2, morale: 6, skill: 4, purpose: 4 } },
                    { text: 'Accept but protect your team from distraction', effects: { profitLoss: 1.5, morale: 4, templateProgress: 4 } },
                    { text: 'Politely decline - stay under the radar', effects: { morale: 2, templateProgress: 3 } }
                  ] },
                { id: 'reward03', dept: 'ops', icon: '🌍', title: 'International Expansion Offer', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Advanced' || state.templateStage === 'Optimized',
                  text: 'Neptune\'s European division wants to license your template. Your proven model travels well because it\'s properly documented. This could double your reach with minimal risk.',
                  options: [
                    { text: 'Full licensing deal', effects: { reach: 12, profitLoss: 2.5, skill: 3, innovation: 3 } },
                    { text: 'Pilot in 2 countries first', effects: { reach: 5, profitLoss: 1, templateProgress: 5, skill: 3 } },
                    { text: 'Focus on domestic growth for now', effects: { templateProgress: 6, reach: 2, morale: 3 } }
                  ] },
                { id: 'reward04', dept: 'HR', icon: '🏆', title: 'Top Talent Wants to Join', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Advanced' || state.templateStage === 'Optimized',
                  text: 'Your reputation for having a well-run operation is attracting top talent. A senior executive from a competitor wants to join, bringing their network and expertise.',
                  options: [
                    { text: 'Hire them in a senior role', cost: 1, effects: { skill: 8, reach: 4, morale: 4, innovation: 3 } },
                    { text: 'Hire them as an advisor', cost: 0.3, effects: { skill: 4, innovation: 4, morale: 2 } },
                    { text: 'Pass - grow talent internally', effects: { morale: 4, purpose: 3, skill: 2 } }
                  ] },
                { id: 'reward05', dept: 'tech', icon: '⚡', title: 'Efficient Scaling Unlocked', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Advanced' || state.templateStage === 'Optimized',
                  text: 'Your mature template means new locations reach profitability in half the time. The team proposes an accelerated but sustainable expansion plan.',
                  options: [
                    { text: 'Accelerate - open 8 new markets', investment: 1.5, effects: { reach: 8, profitLoss: 1, morale: 4, skill: 2 } },
                    { text: 'Steady pace - 4 new markets', investment: 0.8, effects: { reach: 4, profitLoss: 0.8, templateProgress: 4, morale: 3 } },
                    { text: 'Perfect the template further before expanding', effects: { templateProgress: 8, skill: 4, innovation: 3 } }
                  ] },
                { id: 'reward06', dept: 'Finance', icon: '📈', title: 'Profitability Milestone', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Advanced' || state.templateStage === 'Optimized',
                  text: 'Your unit economics are best-in-class thanks to your refined template. Corporate offers bonus funding to accelerate what\'s clearly working.',
                  options: [
                    { text: 'Take full funding, aggressive growth', effects: { profitLoss: 3, reach: 6, morale: 5 } },
                    { text: 'Take partial funding, balanced approach', effects: { profitLoss: 1.5, reach: 3, templateProgress: 4, morale: 4 } },
                    { text: 'Decline - prove we can grow profitably alone', effects: { purpose: 5, morale: 3, skill: 3 } }
                  ] },
                { id: 'reward07', dept: 'Marketing', icon: '🎯', title: 'Industry Recognition', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Advanced' || state.templateStage === 'Optimized',
                  text: 'Your venture has been nominated for an industry innovation award. The publicity would boost credibility and attract customers.',
                  options: [
                    { text: 'Invest in the award campaign', investment: 0.5, effects: { reach: 5, purpose: 5, morale: 6, rollChance: 0.8, roll: { pass: { profitLoss: 1, innovation: 3 }, fail: { morale: -2 } } } },
                    { text: 'Accept nomination but don\'t campaign', effects: { purpose: 3, morale: 3, rollChance: 0.5, roll: { pass: { reach: 3 }, fail: {} } } },
                    { text: 'Stay focused on execution', effects: { templateProgress: 4, skill: 3 } }
                  ] },
                { id: 'reward08', dept: 'ops', icon: '🔄', title: 'Replication Request', phase: 'late', isReward: true,
                  condition: () => state.templateStage === 'Optimized',
                  text: 'Another Neptune division wants to adopt your entire operating model. Your optimized template could become the corporate standard. This is the ultimate validation.',
                  options: [
                    { text: 'Help them implement it fully', effects: { profitLoss: 2, purpose: 8, skill: 5, morale: 6, innovation: 3 } },
                    { text: 'Share the template but stay hands-off', effects: { profitLoss: 1, purpose: 5, morale: 3 } },
                    { text: 'Keep it proprietary to our unit', effects: { templateProgress: 4, reach: 3 } }
                  ] }
            ],
            global_shocks: {
                pandemic: { id: 'GS01', dept: 'Global Shock', title: 'Global Health Crisis', icon: '🦠', text: 'A pandemic disrupts everything. Supply chains break, customers stay home, and your expansion plans are thrown into chaos.', isShock: true, immediateEffects: { reach: -8, morale: -6, profitLoss: -8, staffLocal: 10 } },
                supply_crisis: { id: 'GS02', dept: 'Global Shock', title: 'Supply Chain Breakdown', icon: '🚢', text: 'Global shipping crisis means materials take months to arrive. Your carefully built template depends on reliable supplies.', isShock: true, immediateEffects: { reach: -4, templateProgress: -6, profitLoss: -5 } },
                competitor: { id: 'GS03', dept: 'Global Shock', title: 'Well-Funded Competitor Enters', icon: '⚔️', text: 'A competitor with deep pockets launches in your market. They\'re copying your approach but moving faster.', isShock: true, immediateEffects: { reach: -3, morale: -6, innovation: 3 } },
                regulation: { id: 'GS04', dept: 'Global Shock', title: 'New Regulations', icon: '📜', text: 'New rules require changes to how you operate. Your template needs updating to stay compliant.', isShock: true, immediateEffects: { templateProgress: -8, profitLoss: -3, purpose: 3 } }
            }
        };

        // Make functions globally accessible
        window.chooseVenture = chooseVenture;
        window.chooseStrategy = chooseStrategy;
        window.showVentureInfo = showVentureInfo;
        window.closeVentureInfo = closeVentureInfo;
        window.showFullCV = showFullCV;
        window.closeFullCV = closeFullCV;
        window.selectReallocationTier = selectReallocationTier;
        window.confirmReallocation = confirmReallocation;
        
        // Mobile Navigation System
        let currentMobileView = 'inbox';
        
        window.switchMobileView = function(view) {
            currentMobileView = view;
            const dashboard = document.getElementById('dashboard');
            const emailInbox = document.getElementById('email-inbox');
            const navItems = document.querySelectorAll('.mobile-nav-item');
            
            // Update nav item active states
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === view) {
                    item.classList.add('active');
                }
            });
            
            // Handle view switching
            if (view === 'inbox') {
                dashboard.classList.remove('mobile-visible');
                emailInbox.classList.remove('mobile-hidden');
            } else if (view === 'dashboard') {
                dashboard.classList.add('mobile-visible');
                emailInbox.classList.add('mobile-hidden');
            } else if (view === 'team') {
                // Show team info in a modal or toggle team bar visibility
                showMobileTeamView();
            }
        };
        
        window.showMobileTeamView = function() {
            // Create and show a mobile team modal
            const teamBar = document.getElementById('team-bar');
            if (teamBar && teamBar.classList.contains('visible')) {
                // Extract team info and show in a modal
                const teamInfo = [];
                document.querySelectorAll('.team-member').forEach(member => {
                    const name = member.querySelector('.team-name')?.textContent || '';
                    const role = member.querySelector('.team-role')?.textContent || '';
                    teamInfo.push({ name, role });
                });
                
                if (teamInfo.length > 0) {
                    const modalHtml = `
                        <div class="mobile-team-modal" id="mobile-team-modal" style="
                            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                            background: rgba(0,0,0,0.5); z-index: 300;
                            display: flex; align-items: flex-end; justify-content: center;
                        " onclick="closeMobileTeamModal(event)">
                            <div style="
                                background: white; width: 100%; max-height: 70vh;
                                border-radius: 20px 20px 0 0; padding: 20px;
                                overflow-y: auto;
                            " onclick="event.stopPropagation()">
                                <h3 style="margin-bottom: 16px; text-align: center;">Your Leadership Team</h3>
                                ${teamInfo.map(t => `
                                    <div style="
                                        display: flex; align-items: center; gap: 12px;
                                        padding: 12px; background: #f8fafc; border-radius: 10px;
                                        margin-bottom: 8px;
                                    ">
                                        <div style="font-size: 1.5em;">👤</div>
                                        <div>
                                            <div style="font-weight: 600;">${t.name}</div>
                                            <div style="font-size: 0.85em; color: #64748b;">${t.role}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                <button onclick="closeMobileTeamModal()" style="
                                    width: 100%; padding: 14px; margin-top: 16px;
                                    background: #5046e5; color: white; border: none;
                                    border-radius: 10px; font-weight: 600; cursor: pointer;
                                ">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                } else {
                    alert('Your team will be assembled during game setup.');
                }
            } else {
                alert('Your team will be assembled during game setup.');
            }
            
            // Reset to inbox view in nav
            setTimeout(() => switchMobileView('inbox'), 100);
        };
        
        window.closeMobileTeamModal = function(event) {
            const modal = document.getElementById('mobile-team-modal');
            if (modal) modal.remove();
        };
        
        // Update mobile badge when inbox changes
        window.updateMobileInboxBadge = function() {
            const badge = document.getElementById('mobile-inbox-badge');
            if (!badge) return;
            
            const unreadCount = emailInbox.emails.filter(e => !e.read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        };
        
        // Tutorial tile toggle
        window.toggleTutorialTile = function(tile) {
            // If this tile is already expanded, collapse it
            if (tile.classList.contains('expanded')) {
                tile.classList.remove('expanded');
            } else {
                // Collapse any other expanded tiles
                document.querySelectorAll('.tutorial-tile.expanded').forEach(t => {
                    t.classList.remove('expanded');
                });
                // Expand this one
                tile.classList.add('expanded');
            }
        };
        
        // Tutorial topic content
        const tutorialTopics = {
            game: {
                icon: '🎮',
                title: 'The Game',
                subtitle: 'Your mission as a corporate venture leader',
                content: `
                    <p>You're the director of a <strong>corporate venture</strong> — a startup inside a large company. Neptune Corporation has given you <strong>12 months</strong> to scale the business and prove it can succeed.</p>
                    <p>Each month, you'll receive emails from your team presenting challenges and opportunities. Your decisions shape the venture's future — there are no right answers, only trade-offs.</p>
                    <p>Balance growth with sustainability, innovation with execution, and ambition with your team's wellbeing. This is corporate entrepreneurship.</p>
                `
            },
            inbox: {
                icon: '📧',
                title: 'Your Inbox',
                subtitle: 'Where decisions happen',
                content: `
                    <p>Emails arrive from your five department heads — <strong>Finance, HR, Operations, Marketing, and Tech</strong>. Each presents a situation requiring your decision.</p>
                    <p>Click an email to read it, then choose from the response options. Every choice involves trade-offs between different metrics and goals.</p>
                    <p><strong>Tip:</strong> Look for the <span style="color: #f59e0b;">⚡ Urgent</span> tag — some decisions can't wait and will disappear if ignored.</p>
                    <p>You'll typically receive 2-3 emails per month. Handle them all before advancing to the next month.</p>
                `
            },
            metrics: {
                icon: '📊',
                title: 'Key Metrics',
                subtitle: 'What you\'re managing',
                content: `
                    <p><strong>📈 Markets</strong> — How many markets you've reached. This is your primary growth target and drives revenue.</p>
                    <p><strong>⭐ Template</strong> — Your operational model's maturity. Evolves through stages as you develop your approach.</p>
                    <p><strong>🌍 Purpose</strong> — How strongly the venture embodies its mission. High purpose attracts talent and builds culture.</p>
                    <p><strong>💡 Innovation</strong> — Your team's creative capacity. Drives breakthrough ideas and competitive advantage.</p>
                    <p><strong>🎓 Skill</strong> — Your team's capabilities. Affects how well they execute on your decisions.</p>
                    <p><strong>😊 Morale</strong> — Team motivation and engagement. Low morale hurts everything else.</p>
                `
            },
            finances: {
                icon: '💰',
                title: 'Finances',
                subtitle: 'Revenue, costs, and survival',
                content: `
                    <p>The finance panel shows your monthly <strong>Revenue</strong> (generated from your markets) minus <strong>Costs</strong> (base operations + your investments).</p>
                    <p>Your cumulative <strong>Profit/Loss</strong> tracks performance over time. Staying in the black is important, but sometimes you need to invest for growth.</p>
                    <p>Revenue grows as you expand into more markets and improve your template. Costs depend on your resource allocation decisions.</p>
                    <p><strong>Warning:</strong> Severe, sustained losses can end your assignment early! Neptune won't fund a venture that bleeds money indefinitely.</p>
                `
            },
            resources: {
                icon: '🎚️',
                title: 'Resource Allocation',
                subtitle: 'Where to invest',
                content: `
                    <p>You can adjust monthly investments in each department using the allocation panel. More investment means stronger effects but higher costs.</p>
                    <p>Each department contributes differently:</p>
                    <p>• <strong>Marketing</strong> — Drives market reach and brand awareness</p>
                    <p>• <strong>Tech</strong> — Improves the template and innovation</p>
                    <p>• <strong>HR</strong> — Affects morale, skills, and culture</p>
                    <p>• <strong>Operations</strong> — Efficiency and process improvement</p>
                    <p>• <strong>Finance</strong> — Cost management and financial planning</p>
                    <p>Find the right balance for your strategy — you can't maximise everything.</p>
                `
            },
            team: {
                icon: '👥',
                title: 'Your Team',
                subtitle: 'The people behind the venture',
                content: `
                    <p>You'll work with five department heads, each with their own personality, priorities, and expertise:</p>
                    <p><strong>Finance</strong> — Watches the bottom line and manages risk. Often cautious about spending.</p>
                    <p><strong>HR</strong> — Focuses on people, culture, and talent. Champions team wellbeing.</p>
                    <p><strong>Operations</strong> — Handles processes, scaling, and efficiency. Wants things to run smoothly.</p>
                    <p><strong>Marketing</strong> — Drives growth, brand, and market expansion. Pushes for visibility.</p>
                    <p><strong>Tech</strong> — Leads product development and innovation. Excited about new possibilities.</p>
                    <p>Their emails reflect their perspectives — consider who's asking and why.</p>
                `
            },
            reviews: {
                icon: '📅',
                title: 'Reviews',
                subtitle: 'Feedback and checkpoints',
                content: `
                    <p>At the end of each month, you'll see a <strong>progress report</strong> showing how your metrics changed, your financial position, and progress toward your market target.</p>
                    <p>Every quarter (months 3, 6, 9, 12), you'll receive a <strong>quarterly review</strong> from Neptune Corp's Strategy Director, Victoria Palmer, with personalised feedback on your performance.</p>
                    <p>These reviews assess your progress across multiple dimensions and give you a star rating. Use these checkpoints to assess your strategy and adjust course if needed.</p>
                `
            },
            networking: {
                icon: '🍸',
                title: 'Networking Event',
                subtitle: 'The Neptune Reception mini-game',
                content: `
                    <p>In <strong>Month 3</strong>, you'll attend the Neptune Annual Reception — a networking mini-game where you can build valuable connections.</p>
                    <p><strong>How it works:</strong></p>
                    <p>• Guests appear with <strong>speech bubbles</strong> showing what they're talking about</p>
                    <p>• Click a guest to approach them and start a conversation</p>
                    <p>• Choose dialogue options to build <strong>rapport</strong> with each person</p>
                    <p>• Higher rapport unlocks better <strong>resources</strong> (funding, advice, contacts)</p>
                    <p><strong>Strategy tips:</strong></p>
                    <p>• Start with an <strong>opener</strong> that matches their interests — look at their speech bubble!</p>
                    <p>• Follow up with an <strong>engager</strong> to deepen the conversation</p>
                    <p>• Some guests are more valuable than others — prioritise wisely</p>
                    <p>• You have <strong>limited time</strong>, so choose your conversations carefully</p>
                    <p>The resources you collect will provide ongoing bonuses throughout the game!</p>
                `
            },
            winning: {
                icon: '🎯',
                title: 'Winning',
                subtitle: 'What success looks like',
                content: `
                    <p>Your primary goal is to reach your <strong>market target</strong> by the end of 12 months while keeping the venture financially sustainable.</p>
                    <p>But success isn't just about hitting numbers. At the end of the game, you'll receive feedback on:</p>
                    <p>• Your <strong>strengths</strong> as a leader</p>
                    <p>• <strong>Growth opportunities</strong> for next time</p>
                    <p>• <strong>Key learnings</strong> about corporate entrepreneurship</p>
                    <p>There are many paths to success — and failure. Discover what works through experience.</p>
                `
            }
        };
        
        window.openTutorialTopic = function(topicId) {
            const topic = tutorialTopics[topicId];
            if (!topic) return;
            
            // Set content
            document.getElementById('topic-icon').textContent = topic.icon;
            document.getElementById('topic-title').textContent = topic.title;
            document.getElementById('topic-subtitle').textContent = topic.subtitle;
            document.getElementById('topic-body').innerHTML = topic.content;
            
            // Show modal
            document.getElementById('tutorial-topic-modal').classList.add('visible');
        };
        
        window.closeTutorialTopic = function() {
            document.getElementById('tutorial-topic-modal').classList.remove('visible');
        };
        
        window.closeTutorial = closeTutorial;
    </script>
</body>
</html>
